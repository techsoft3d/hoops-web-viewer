var Communicator=function(rt){"use strict";var $d=typeof document<"u"?document.currentScript:null;function Kw(s,t){for(var e=0;e<t.length;e++){const i=t[e];if(typeof i!="string"&&!Array.isArray(i)){for(const n in i)if(n!=="default"&&!(n in s)){const r=Object.getOwnPropertyDescriptor(i,n);r&&Object.defineProperty(s,n,r.get?r:{enumerable:!0,get:()=>i[n]})}}}return Object.freeze(Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}))}const dp="¹",qd="²",Kd="³",Kh="⁻",fp="Ω";var li=(s=>(s[s.unitUnknown=0]="unitUnknown",s[s.unitLength=1]="unitLength",s[s.unitMass=2]="unitMass",s[s.unitTime=3]="unitTime",s[s.unitElectricCurrent=4]="unitElectricCurrent",s[s.unitThermoTemperature=5]="unitThermoTemperature",s[s.unitSubstanceAmount=6]="unitSubstanceAmount",s[s.unitLuminosityIntensity=7]="unitLuminosityIntensity",s[s.unitPlaneAngle=8]="unitPlaneAngle",s[s.unitSolidAngle=9]="unitSolidAngle",s[s.unitFrequency=10]="unitFrequency",s[s.unitForce=11]="unitForce",s[s.unitPressure=12]="unitPressure",s[s.unitEnergy=13]="unitEnergy",s[s.unitPower=14]="unitPower",s[s.unitElectricCharge=15]="unitElectricCharge",s[s.unitElectromotiveForce=16]="unitElectromotiveForce",s[s.unitCapacitance=17]="unitCapacitance",s[s.unitElectricResistance=18]="unitElectricResistance",s[s.unitElectricConductance=19]="unitElectricConductance",s[s.unitMagneticFlux=20]="unitMagneticFlux",s[s.unitMagneticFluxDensity=21]="unitMagneticFluxDensity",s[s.unitInductance=22]="unitInductance",s[s.unitLuminousFlux=23]="unitLuminousFlux",s[s.unitIlluminance=24]="unitIlluminance",s[s.unitActivityRadionuclide=25]="unitActivityRadionuclide",s[s.unitKerma=26]="unitKerma",s[s.unitDoseEquivalent=27]="unitDoseEquivalent",s[s.unitCatalyticActivity=28]="unitCatalyticActivity",s))(li||{});function Xd(s){return s!==null&&typeof s=="object"&&"x"in s&&typeof s.x=="number"&&"y"in s&&typeof s.y=="number"}function Jd(s){return s!==null&&typeof s=="object"&&"z"in s&&typeof s.z=="number"&&Xd(s)}function Xw(s){return s!==null&&typeof s=="object"&&"w"in s&&typeof s.w=="number"&&Jd(s)}class _{constructor(t,e,i){this.x=t,this.y=e,this.z=i}assign(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}toArray(t=[0,0,0]){return t[0]=this.x,t[1]=this.y,t[2]=this.z,t}fromArray(t){return this.x=t[0],this.y=t[1],this.z=t[2],this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}copy(){return new _(this.x,this.y,this.z)}static fromJson(t){if(Jd(t))return new _(t.x,t.y,t.z);throw new TypeError("Point3.fromJson: data does not satisfy type IPoint3 constraints")}toJson(){return{x:this.x,y:this.y,z:this.z}}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}equalsWithTolerance(t,e){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e}isAxis(){return Math.abs(this.x)===1&&this.y===0&&this.z===0||this.x===0&&Math.abs(this.y)===1&&this.z===0||this.x===0&&this.y===0&&Math.abs(this.z)===1}length(){return Math.sqrt(this.squaredLength())}squaredLength(){return this.x*this.x+this.y*this.y+this.z*this.z}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=this.length();return t===0?this:this.scale(1/t)}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}static zero(){return new _(0,0,0)}static add(t,e){return new _(t.x+e.x,t.y+e.y,t.z+e.z)}static subtract(t,e){return new _(t.x-e.x,t.y-e.y,t.z-e.z)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e){return new _(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)}static distance(t,e){return _.subtract(e,t).length()}static scale(t,e){return t.copy().scale(e)}static createFromArray(t){return new _(t[0],t[1],t[2])}}class rr{constructor(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n}scale(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}set(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n}assign(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w}static zero(){return new rr(0,0,0,0)}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}equalsWithTolerance(t,e){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e}}let _t=class Pr{constructor(){this.loadIdentity()}loadIdentity(){return this.m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this}isIdentity(){const t=this.m;return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1}equals(t){for(let e=0;e<16;++e){const i=this.m[e],n=t.m[e];if(i!==n)return!1}return!0}equalsWithTolerance(t,e){e=Math.abs(e);for(let i=0;i<16;++i)if(Math.abs(this.m[i]-t.m[i])>e)return!1;return!0}setScaleComponent(t,e,i){return this.m[0]=t,this.m[5]=e,this.m[10]=i,this}setTranslationComponent(t,e,i){return this.m[12]=t,this.m[13]=e,this.m[14]=i,this}copy(){const t=new Pr;return t.m=this.m.slice(),t}assign(t){for(let e=0;e<t.m.length;e++)this.m[e]=t.m[e];return this}multiplyByScalar(t){for(let e=0;e<16;e++)this.m[e]*=t;return this}transform(t,e){return e=e??_.zero(),e.set(t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+this.m[13],t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+this.m[14]),e}transform4(t,e){return e=e??rr.zero(),e.set(t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+this.m[12]*t.w,t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+this.m[13]*t.w,t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+this.m[14]*t.w,t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+this.m[15]*t.w),e}transformArray(t,e){for(let i=0;i<t.length;i++){const n=t[i],r=new _(n.x*this.m[0]+n.y*this.m[4]+n.z*this.m[8]+this.m[12],n.x*this.m[1]+n.y*this.m[5]+n.z*this.m[9]+this.m[13],n.x*this.m[2]+n.y*this.m[6]+n.z*this.m[10]+this.m[14]);e[i]=r}}transformBox(t){if(t.isDegenerate())return on.invalid();const e=t.getCorners();for(const n of e)this.transform(n,n);const i=new on(e[0],e[0]);for(let n=1;n<e.length;++n){const r=e[n];i.addPoint(r)}return i}transpose(){let t;return t=this.m[1],this.m[1]=this.m[4],this.m[4]=t,t=this.m[2],this.m[2]=this.m[8],this.m[8]=t,t=this.m[3],this.m[3]=this.m[12],this.m[12]=t,t=this.m[6],this.m[6]=this.m[9],this.m[9]=t,t=this.m[7],this.m[7]=this.m[13],this.m[13]=t,t=this.m[11],this.m[11]=this.m[14],this.m[14]=t,this}static createFromArray(t){const e=new Pr;return e.m=t.slice(),e}static createFromOffAxisRotation(t,e){const i=e*(Math.PI/180),n=Math.sin(i),r=Math.cos(i),o=new Pr,l=t.copy().normalize(),h=1-r,u=h*l.x*l.y,d=h*l.x*l.z,g=h*l.y*l.z;return o.m[0]=h*l.x*l.x+r,o.m[1]=n*l.z+u,o.m[2]=d-n*l.y,o.m[3]=0,o.m[4]=u-n*l.z,o.m[5]=h*l.y*l.y+r,o.m[6]=n*l.x+g,o.m[7]=0,o.m[8]=n*l.y+d,o.m[9]=g-n*l.x,o.m[10]=h*l.z*l.z+r,o.m[11]=0,o.m[12]=0,o.m[13]=0,o.m[14]=0,o.m[15]=1,o}static createFromBasis(t,e,i){const n=new Pr;return n.m[0]=t.x,n.m[1]=t.y,n.m[2]=t.z,n.m[4]=e.x,n.m[5]=e.y,n.m[6]=e.z,n.m[8]=i.x,n.m[9]=i.y,n.m[10]=i.z,n}static multiply(t,e){const i=new Pr;return i.m[0]=t.m[0]*e.m[0]+t.m[1]*e.m[4]+t.m[2]*e.m[8]+t.m[3]*e.m[12],i.m[1]=t.m[0]*e.m[1]+t.m[1]*e.m[5]+t.m[2]*e.m[9]+t.m[3]*e.m[13],i.m[2]=t.m[0]*e.m[2]+t.m[1]*e.m[6]+t.m[2]*e.m[10]+t.m[3]*e.m[14],i.m[3]=t.m[0]*e.m[3]+t.m[1]*e.m[7]+t.m[2]*e.m[11]+t.m[3]*e.m[15],i.m[4]=t.m[4]*e.m[0]+t.m[5]*e.m[4]+t.m[6]*e.m[8]+t.m[7]*e.m[12],i.m[5]=t.m[4]*e.m[1]+t.m[5]*e.m[5]+t.m[6]*e.m[9]+t.m[7]*e.m[13],i.m[6]=t.m[4]*e.m[2]+t.m[5]*e.m[6]+t.m[6]*e.m[10]+t.m[7]*e.m[14],i.m[7]=t.m[4]*e.m[3]+t.m[5]*e.m[7]+t.m[6]*e.m[11]+t.m[7]*e.m[15],i.m[8]=t.m[8]*e.m[0]+t.m[9]*e.m[4]+t.m[10]*e.m[8]+t.m[11]*e.m[12],i.m[9]=t.m[8]*e.m[1]+t.m[9]*e.m[5]+t.m[10]*e.m[9]+t.m[11]*e.m[13],i.m[10]=t.m[8]*e.m[2]+t.m[9]*e.m[6]+t.m[10]*e.m[10]+t.m[11]*e.m[14],i.m[11]=t.m[8]*e.m[3]+t.m[9]*e.m[7]+t.m[10]*e.m[11]+t.m[11]*e.m[15],i.m[12]=t.m[12]*e.m[0]+t.m[13]*e.m[4]+t.m[14]*e.m[8]+t.m[15]*e.m[12],i.m[13]=t.m[12]*e.m[1]+t.m[13]*e.m[5]+t.m[14]*e.m[9]+t.m[15]*e.m[13],i.m[14]=t.m[12]*e.m[2]+t.m[13]*e.m[6]+t.m[14]*e.m[10]+t.m[15]*e.m[14],i.m[15]=t.m[12]*e.m[3]+t.m[13]*e.m[7]+t.m[14]*e.m[11]+t.m[15]*e.m[15],i}inverseAndDeterminant(){const t=this.m[4]*this.m[9]-this.m[5]*this.m[8],e=this.m[4]*this.m[10]-this.m[6]*this.m[8],i=this.m[4]*this.m[11]-this.m[7]*this.m[8],n=this.m[4]*this.m[13]-this.m[5]*this.m[12],r=this.m[4]*this.m[14]-this.m[6]*this.m[12],o=this.m[4]*this.m[15]-this.m[7]*this.m[12],l=this.m[5]*this.m[10]-this.m[6]*this.m[9],h=this.m[5]*this.m[11]-this.m[7]*this.m[9],u=this.m[5]*this.m[14]-this.m[6]*this.m[13],d=this.m[5]*this.m[15]-this.m[7]*this.m[13],g=this.m[6]*this.m[11]-this.m[7]*this.m[10],y=this.m[6]*this.m[15]-this.m[7]*this.m[14],m=this.m[8]*this.m[13]-this.m[9]*this.m[12],I=this.m[8]*this.m[14]-this.m[10]*this.m[12],b=this.m[8]*this.m[15]-this.m[11]*this.m[12],x=this.m[9]*this.m[14]-this.m[10]*this.m[13],C=this.m[9]*this.m[15]-this.m[11]*this.m[13],P=this.m[10]*this.m[15]-this.m[11]*this.m[14],k=new Pr;k.m[0]=this.m[5]*P-this.m[6]*C+this.m[7]*x,k.m[1]=this.m[2]*C-this.m[3]*x-this.m[1]*P,k.m[2]=this.m[1]*y-this.m[2]*d+this.m[3]*u,k.m[3]=this.m[2]*h-this.m[3]*l-this.m[1]*g,k.m[4]=this.m[6]*b-this.m[7]*I-this.m[4]*P,k.m[5]=this.m[0]*P-this.m[2]*b+this.m[3]*I,k.m[6]=this.m[2]*o-this.m[3]*r-this.m[0]*y,k.m[7]=this.m[0]*g-this.m[2]*i+this.m[3]*e,k.m[8]=this.m[4]*C-this.m[5]*b+this.m[7]*m,k.m[9]=this.m[1]*b-this.m[3]*m-this.m[0]*C,k.m[10]=this.m[0]*d-this.m[1]*o+this.m[3]*n,k.m[11]=this.m[1]*i-this.m[3]*t-this.m[0]*h,k.m[12]=this.m[5]*I-this.m[6]*m-this.m[4]*x,k.m[13]=this.m[0]*x-this.m[1]*I+this.m[2]*m,k.m[14]=this.m[1]*r-this.m[2]*n-this.m[0]*u,k.m[15]=this.m[0]*l-this.m[1]*e+this.m[2]*t;const O=k.m[0],B=-k.m[4],j=k.m[8],V=-k.m[12],Y=this.m[0]*O-this.m[1]*B+this.m[2]*j-this.m[3]*V;if(Y===0)return[null,0];const q=1/Y;return k.multiplyByScalar(q),[k,Y]}static inverse(t){return t.inverseAndDeterminant()[0]}upperLeft3x3Determinant(){return this.m[0]*(this.m[5]*this.m[10]-this.m[9]*this.m[6])-this.m[4]*(this.m[1]*this.m[10]-this.m[9]*this.m[2])+this.m[8]*(this.m[1]*this.m[6]-this.m[5]*this.m[2])}normalMatrix(){const t=this.copy().setTranslationComponent(0,0,0).inverseAndDeterminant()[0];return t?t.transpose():null}toJson(){return this.m.slice()}static fromJson(t){return Pr.createFromArray(t)}static toMatrix12(t){return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10],t[12],t[13],t[14]]}static xAxisRotation(t){const e=new Pr,i=Zr(t),n=Math.cos(i),r=Math.sin(i);return e.m[5]=n,e.m[6]=-r,e.m[9]=r,e.m[10]=n,e}static yAxisRotation(t){const e=new Pr,i=Zr(t),n=Math.cos(i),r=Math.sin(i);return e.m[0]=n,e.m[2]=r,e.m[8]=-r,e.m[10]=n,e}static zAxisRotation(t){const e=new Pr,i=Zr(t),n=Math.cos(i),r=Math.sin(i);return e.m[0]=n,e.m[1]=-r,e.m[4]=r,e.m[5]=n,e}},Ki=class qh{constructor(){this.normal=_.zero(),this.d=0}setFromPointAndNormal(t,e){return this.normal.assign(e),this.d=-_.dot(e,t),this}setFromPoints(t,e,i){this.normal=_.cross(_.subtract(e,t),_.subtract(i,t)).normalize(),this.d=-_.dot(t,this.normal)}setFromCoefficients(t,e,i,n){this.normal.set(t,e,i),this.d=n}getCoefficients(){const t=this.normal;return[t.x,t.y,t.z,this.d]}distanceToPoint(t){return _.dot(this.normal,t)+this.d}rayIntersection(t){const e=_.zero();return this.intersectsRay(t,e)?e:null}intersectsRay(t,e){const i=this.distanceToPoint(t.origin);if(Math.abs(i)<=1e-6)return e&&e.assign(t.origin),!0;const n=_.dot(this.normal,t.direction);if(Math.abs(n)<=1e-6)return!1;const r=-i/n;if(r<0)return!1;if(e){const o=t.direction.copy().scale(r);e.set(t.origin.x+o.x,t.origin.y+o.y,t.origin.z+o.z)}return!0}determineSide(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d>0}copy(){const t=new qh;return t.normal.assign(this.normal),t.d=this.d,t}assign(t){this.normal.assign(t.normal),this.d=t.d}equals(t){return this.normal.equals(t.normal)&&this.d===t.d}static createFromPointAndNormal(t,e){return new qh().setFromPointAndNormal(t,e)}static createFromPoints(t,e,i){const n=new qh;return n.setFromPoints(t,e,i),n}static createFromCoefficients(t,e,i,n){const r=new qh;return r.setFromCoefficients(t,e,i,n),r}};class K{constructor(t,e){this.x=t,this.y=e}assign(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return this.x*=t,this.y*=t,this}equals(t){return this.x===t.x&&this.y===t.y}set(t,e){return this.x=t,this.y=e,this}copy(){return new K(this.x,this.y)}length(){return Math.sqrt(this.squaredLength())}squaredLength(){return this.x*this.x+this.y*this.y}toJson(){return{x:this.x,y:this.y}}static fromJson(t){if(Xd(t))return new K(t.x,t.y);throw new TypeError("Point2.fromJson: data does not satisfy type IPoint2 constraints")}static subtract(t,e){return new K(t.x-e.x,t.y-e.y)}static add(t,e){return new K(t.x+e.x,t.y+e.y)}static scale(t,e){return new K(t.x*e,t.y*e)}static distance(t,e){return K.subtract(e,t).length()}static zero(){return new K(0,0)}static fromPoint3(t){return new K(t.x,t.y)}}function Jw(s){const t=Math.abs(s.x),e=Math.abs(s.y),i=Math.abs(s.z);return t<=e&&t<=i?new _(1,0,0):e<=t&&e<=i?new _(0,1,0):new _(0,0,1)}function Yd(s,t){const e=Jw(s),i=_.cross(e,s);return t?(t.assign(i),t):i}function Zd(s,t,e,i){const n=e.normal.x*(t.x-s.x)+e.normal.y*(t.y-s.y)+e.normal.z*(t.z-s.z);if(Math.abs(n)<1e-5)return!1;const r=-(e.d+e.normal.x*s.x+e.normal.y*s.y+e.normal.z*s.z)/n;return i.x=s.x+r*(t.x-s.x),i.y=s.y+r*(t.y-s.y),i.z=s.z+r*(t.z-s.z),!(r<0||r>1)}function kr(s,t,e,i){const n=_.subtract(e,t),r=n.squaredLength();let o=0;r>0&&(o=((s.x-t.x)*(e.x-t.x)+(s.y-t.y)*(e.y-t.y)+(s.z-t.z)*(e.z-t.z))/r),n.set(n.x*o,n.y*o,n.z*o),i.set(t.x+n.x,t.y+n.y,t.z+n.z);let l=new _(0,0,0);return l=_.subtract(s,i),l.length()}function Yw(s){return Math.abs(s-.35277777777777775)<.01?"points":Math.abs(s-25.4)<.01?"inch":Math.abs(s-1)<.01?"mm":Math.abs(s-10)<.01?"cm":Math.abs(s-4.233333333333333)<.01?"picas":Math.abs(s-304.79999999999995)<.01?"ft":Math.abs(s-914.4)<.01?"yd":Math.abs(s-1e3)<.01?"m":Math.abs(s-1e6)<.01?"km":Math.abs(s-1609344)<.01?"mi":(console.log(`warning: unit multiplier doesn't map to known type: unit=${s}`),"")}function Ua(s,t){const e=Yw(t);let i="";for(let n=2;n<9&&(i=s.toFixed(n),parseFloat(i)===0);n++);return parseFloat(i)===0&&(i="0"),i+e}function Zr(s){return s*(Math.PI/180)}function Xh(s){return s*(180/Math.PI)}function ja(s,t,e){const i=s.copy().normalize(),n=Zr(t),r=Math.cos(n),o=Math.sin(n),l=1-r,h=l*i.x*i.y,u=l*i.x*i.z,d=l*i.y*i.z;return e===void 0&&(e=new _t),e.m[0]=l*i.x*i.x+r,e.m[1]=o*i.z+h,e.m[2]=u-o*i.y,e.m[3]=0,e.m[4]=h-o*i.z,e.m[5]=l*i.y*i.y+r,e.m[6]=o*i.x+d,e.m[7]=0,e.m[8]=o*i.y+u,e.m[9]=d-o*i.x,e.m[10]=l*i.z*i.z+r,e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e.m[15]=1,e}function gp(s,t,e,i,n,r){const o=_.cross(s.normal,e.normal),l=Math.abs(o.x),h=Math.abs(o.y),u=Math.abs(o.z);if(l+h+u<1e-7){const I=_.subtract(i,t);return _.dot(s.normal,I)===0?1:0}let d;l>h?l>u?d=1:d=3:h>u?d=2:d=3;const g=_.zero(),y=-_.dot(s.normal,t),m=-_.dot(e.normal,i);switch(d){case 1:g.x=0,g.y=(m*s.normal.z-y*e.normal.z)/o.x,g.z=(y*e.normal.y-m*s.normal.y)/o.x;break;case 2:g.x=(y*e.normal.z-m*s.normal.z)/o.y,g.y=0,g.z=(m*s.normal.x-y*e.normal.x)/o.y;break;case 3:g.x=(m*s.normal.y-y*e.normal.y)/o.z,g.y=(y*e.normal.x-m*s.normal.x)/o.z,g.z=0}return n.assign(g),r.set(g.x+o.x,g.y+o.y,g.z+o.z),2}function Zw(s,t,e){const i=new Ki;return i.normal.x=(t.y-s.y)*(e.z-s.z)-(t.z-s.z)*(e.y-s.y),i.normal.y=(t.z-s.z)*(e.x-s.x)-(t.x-s.x)*(e.z-s.z),i.normal.z=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x),i.normal.normalize(),i.d=-i.normal.x*s.x-i.normal.y*s.y-i.normal.z*s.z,i}function Qr(s,t,e,i,n,r){const o=Zw(e,i,n);return Zd(s,t,o,r)}function js(s,t){const e=s.copy().normalize(),i=t.copy().normalize(),r=_.cross(e,i).length(),o=_.dot(e,i),l=Math.atan2(r,o);return Xh(l)}function pp(s,t,e,i,n){const r=2*Math.PI/i;for(let d=0;d<i;d++){const y=e*Math.cos(r*d),m=e*Math.sin(r*d);s[d]=new _(0,y,m)}s[i]=s[0].copy();const o=Yd(n);o.normalize();const l=_.cross(o,n);l.normalize();const h=new _t,u=h.m;u[0]=n.x,u[1]=n.y,u[2]=n.z,u[3]=0,u[4]=o.x,u[5]=o.y,u[6]=o.z,u[7]=0,u[8]=l.x,u[9]=l.y,u[10]=l.z,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,h.transformArray(s,s);for(let d=0;d<=i;d++)s[d].set(s[d].x+t.x,s[d].y+t.y,s[d].z+t.z)}function mp(s,t,e,i,n,r){const o=s,l=t,h=e,u=i;let d=0,g=0;const y=_.subtract(l,o),m=_.subtract(u,h),I=_.dot(y,o),b=_.dot(y,m),x=_.dot(y,y),C=_.dot(y,h),P=_.dot(m,m),k=_.dot(m,h),O=_.dot(m,o),B=_.dot(y,u),j=_.dot(m,l),V=x*P-b*b;if(V===0){let st,ft,U,J;x!==0?(st=(C-I)/x,st<0?st=0:st>1&&(st=1),U=(B-I)/x,U<0?U=0:U>1&&(U=1)):(st=0,U=0),P!==0?(ft=(O-k)/P,ft<0?ft=0:ft>1&&(ft=1),J=(j-k)/P,J<0?J=0:J>1&&(J=1)):(ft=0,J=0),d=(st+U)/2,g=(ft+J)/2}else{const st=b*O-b*k-P*I+P*C,ft=x*O-x*k+b*C-b*I,U=st/V,J=ft/V,A=(C-I)/x,R=(O-k)/P,bt=(B-I)/x,z=(j-k)/P;0<=U&&U<=1&&0<=J&&J<=1?(d=U,g=J):U<0&&0<=J&&J<=1?(d=U,g=R):1<U&&0<=J&&J<=1?(d=U,g=z):0<=U&&U<=1&&J<0?(d=A,g=J):0<=U&&U<=1&&1<J?(d=bt,g=J):U<0&&J<0?(d=A,g=R):U<0&&1<J?(d=bt,g=R):1<U&&J<0?(d=A,g=z):1<U&&1<J&&(d=bt,g=z),d<0?d=0:d>1&&(d=1),g<0?g=0:g>1&&(g=1)}return n.x=d*y.x+o.x,n.y=d*y.y+o.y,n.z=d*y.z+o.z,r.x=g*m.x+h.x,r.y=g*m.y+h.y,r.z=g*m.z+h.z,_.subtract(r,n).length()}function Qd(s,t,e,i){const r=_.zero(),o=_.zero(),l=_.zero(),h=_.zero(),u=_.zero();if(l.x=s.x-e.x,l.y=s.y-e.y,l.z=s.z-e.z,h.x=i.x-e.x,h.y=i.y-e.y,h.z=i.z-e.z,Math.abs(h.x)<1e-12&&Math.abs(h.y)<1e-12&&Math.abs(h.z)<1e-12||(u.x=t.x-s.x,u.y=t.y-s.y,u.z=t.z-s.z,Math.abs(u.x)<1e-12&&Math.abs(u.y)<1e-12&&Math.abs(u.z)<1e-12))return null;const d=l.x*h.x+l.y*h.y+l.z*h.z,g=h.x*u.x+h.y*u.y+h.z*u.z,y=l.x*u.x+l.y*u.y+l.z*u.z,m=h.x*h.x+h.y*h.y+h.z*h.z,b=(u.x*u.x+u.y*u.y+u.z*u.z)*m-g*g;if(Math.abs(b)<1e-12)return null;const C=(d*g-y*m)/b,P=(d+g*C)/m;return r.x=s.x+C*u.x,r.y=s.y+C*u.y,r.z=s.z+C*u.z,o.x=e.x+P*h.x,o.y=e.y+P*h.y,o.z=e.z+P*h.z,r}function tf(s,t,e){const i=_.subtract(t,s),n=_.subtract(e,s),o=_.dot(n,i)/i.squaredLength();return Math.max(0,Math.min(1,o))}function _p(s,t,e){const i=tf(s,t,e),n=_.subtract(t,s).scale(i);return _.add(s,n)}function yp(s,t,e,i){const n=tf(s,t,e);if(n<0||n>1)return!1;const r=_.subtract(t,s).scale(n),o=_.add(s,r);return _.subtract(o,e).squaredLength()<=i*i}function Qw(s,t,e){const i=K.subtract(e,t),n=i.length();let r=(s.x-t.x)*(e.x-t.x)+(s.y-t.y)*(e.y-t.y);return r/=n*n,i.scale(r),K.add(t,i)}function Wa(s,t,e,i){const n=Qw(s,t,e);if(K.distance(s,n)<=i){const o=Math.min(t.x,e.x),l=Math.max(t.x,e.x),h=Math.min(t.y,e.y),u=Math.max(t.y,e.y);return!(n.x<o||n.x>l||n.y<h||n.y>u)}else return!1}function ef(s,t,e,i=0){return!(s.x+i<t.x||s.x>t.x+e.x+i||s.y+i<t.y||s.y>t.y+e.y+i)}function Jh(s,t,e,i,n){const r=[],o=_.zero(),l=new _t,h=t/n;for(let u=0,d=0;u<=n;++u,d+=h)ja(s,d,l),l.transform(i,o),r.push(_.add(e,o));return r}function wp(s){const t=s.sort((n,r)=>n.exponent<r.exponent?1:-1);let e="";const i=".";for(let n=0;n<t.length;n++){switch(t[n].basicUnit){case li.unitLength:e+=xi(t[n].factor,"m");break;case li.unitMass:e+=tv(t[n].factor,"g");break;case li.unitTime:e+=xi(t[n].factor,"s");break;case li.unitElectricCurrent:e+=xi(t[n].factor,"A");break;case li.unitThermoTemperature:e+=xi(t[n].factor,"K");break;case li.unitSubstanceAmount:e+=xi(t[n].factor,"mol");break;case li.unitLuminosityIntensity:e+=xi(t[n].factor,"cd");break;case li.unitPlaneAngle:e+=xi(t[n].factor,"rad");break;case li.unitSolidAngle:e+=xi(t[n].factor,"sr");break;case li.unitFrequency:e+=xi(t[n].factor,"Hz");break;case li.unitForce:e+=xi(t[n].factor,"N");break;case li.unitPressure:e+=xi(t[n].factor,"Pa");break;case li.unitEnergy:e+=xi(t[n].factor,"J");break;case li.unitPower:e+=xi(t[n].factor,"W");break;case li.unitElectricCharge:e+=xi(t[n].factor,"C");break;case li.unitElectromotiveForce:e+=xi(t[n].factor,"V");break;case li.unitCapacitance:e+=xi(t[n].factor,"F");break;case li.unitElectricResistance:e+=xi(t[n].factor,fp);break;case li.unitElectricConductance:e+=xi(t[n].factor,"S");break;case li.unitMagneticFlux:e+=xi(t[n].factor,"Wb");break;case li.unitMagneticFluxDensity:e+=xi(t[n].factor,"T");break;case li.unitInductance:e+=xi(t[n].factor,"H");break;case li.unitLuminousFlux:e+=xi(t[n].factor,"lm");break;case li.unitIlluminance:e+=xi(t[n].factor,"lx");break;case li.unitActivityRadionuclide:e+=xi(t[n].factor,"Bq");break;case li.unitKerma:e+=xi(t[n].factor,"Gy");break;case li.unitDoseEquivalent:e+=xi(t[n].factor,"Sv");break;case li.unitCatalyticActivity:e+=xi(t[n].factor,"kat");break}switch(t[n].exponent){case 2:e+=qd;break;case 3:e+=Kd;break;case-1:e+=Kh,e+=dp;break;case-2:e+=Kh,e+=qd;break;case-3:e+=Kh,e+=Kd;break}n+1<t.length&&(e+=i)}return e}function xi(s,t){let e="";switch(s){case .3048:e="ft";break;case .0254:e="inch";break;case .001:e=`m${t}`;break;case .01:e=`c${t}`;break;case .1:e=`d${t}`;break;case 1:e=t;break;case 10:e=`da${t}`;break;case 100:e=`h${t}`;break;case 1e3:e=`k${t}`;break;case 60:e="min";break;case 3600:e="h";break;case 86400:e="d";break;case 274.15:e="°C";break;case 255.927778:e="°F";break;case .555556:e="°R";break}return e}function tv(s,t){let e="";switch(s){case 1e-6:e=`m${t}`;break;case 1e-5:e=`d${t}`;break;case 1e-4:e=`c${t}`;break;case .001:e=t;break;case .01:e=`da${t}`;break;case .1:e=`h${t}`;break;case 1:e=`k${t}`;break;case 100:e="q";break;case 1e3:e="t";break}return e}const Zs=class Zs{constructor(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n}set(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n}assign(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w}copy(){return new Zs(this.x,this.y,this.z,this.w)}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsWithTolerance(t,e){return this.x-t.x<e&&this.x-t.x>-e&&this.y-t.y<e&&this.y-t.y>-e&&this.z-t.z<e&&this.z-t.z>-e&&this.w-t.w<e&&this.w-t.w>-e}fromArray(t){return this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3],this}toArray(t){return t[0]=this.x,t[1]=this.y,t[2]=this.z,t[3]=this.w,this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}magnitudeSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){const t=this.magnitude();return t===0?this:(this.x=this.x/t,this.y=this.y/t,this.z=this.z/t,this.w=this.w/t,this)}static add(t,e){return new Zs(t.x+e.x,t.y+e.y,t.z+e.z,t.w+e.w)}static subtract(t,e){return new Zs(t.x-e.x,t.y-e.y,t.z-e.z,t.w-e.w)}static identity(){return new Zs(0,0,0,1)}static toMatrix(t){let e=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;e=2/e;const i=t.x*e,n=t.y*e,r=t.z*e,o=t.w*i,l=t.w*n,h=t.w*r,u=t.x*i,d=t.x*n,g=t.x*r,y=t.y*n,m=t.y*r,I=t.z*r,b=new _t;return b.m[0]=1-(y+I),b.m[1]=d+h,b.m[2]=g-l,b.m[3]=0,b.m[4]=d-h,b.m[5]=1-(u+I),b.m[6]=m+o,b.m[7]=0,b.m[8]=g+l,b.m[9]=m-o,b.m[10]=1-(u+y),b.m[11]=0,b.m[12]=0,b.m[13]=0,b.m[14]=0,b.m[15]=1,b}static createFromMatrix(t){const o=[],l=t.m[0]+t.m[5]+t.m[10];if(l>0){let h=Math.sqrt(l+1);o[3]=.5*h,h=.5/h,o[0]=h*(t.m[6]-t.m[9]),o[1]=h*(t.m[8]-t.m[2]),o[2]=h*(t.m[1]-t.m[4])}else{let h=0;t.m[5]>t.m[0]&&(h=1),t.m[10]>t.m[4*h+h]&&(h=2);const u=[1,2,0],d=u[h],g=u[d];let y=Math.sqrt(t.m[4*h+h]-(t.m[4*d+d]+t.m[4*g+g])+1);o[h]=.5*y,y=.5/y,o[3]=y*(t.m[4*d+g]-t.m[4*g+d]),o[d]=y*(t.m[4*h+d]+t.m[4*d+h]),o[g]=y*(t.m[4*h+g]+t.m[4*g+h])}return Zs.identity().fromArray(o)}static interpolate(t,e,i){const h=[],u=[],d=[];t.toArray(h),e.toArray(u);let g,y;const m=h[0]*u[0]+h[1]*u[1]+h[2]*u[2]+h[3]*u[3];if(1+m>Zs._epsilon){if(1-m>Zs._epsilon){const I=Zs._arccos(m),x=1/Math.sin(I);g=x*Math.sin((1-i)*I),y=x*Math.sin(i*I)}else g=1-i,y=i;for(let I=0;I<4;++I)d[I]=g*h[I]+y*u[I]}else{d[0]=-h[1],d[1]=h[0],d[2]=-h[3],d[3]=h[2],g=Math.sin(.5*Math.PI*(1-i)),y=Math.sin(.5*Math.PI*i);for(let I=0;I<3;++I)d[I]=g*h[I]+y*d[I]}return Zs.identity().fromArray(d)}static _arccos(t){return t<-1?Math.PI:t>1?0:Math.acos(t)}};Zs._epsilon=1e-5;let Bn=Zs;class Ws{constructor(t,e){this.origin=_.zero(),this.direction=new _(0,0,1),t&&this.origin.assign(t),e&&this.direction.assign(e)}copy(){return new Ws(this.origin,this.direction)}assign(t){return this.origin.assign(t.origin),this.direction.assign(t.direction),this}negate(){return this.direction.negate(),this}}class on{constructor(t=_.zero(),e=_.zero()){this.min=t.copy(),this.max=e.copy()}copy(){return new on(this.min,this.max)}equals(t){return this.min.equals(t.min)&&this.max.equals(t.max)}center(){const t=_.add(this.min,this.max);return t.scale(.5),t}extents(){return _.subtract(this.max,this.min)}addBox(t){t.isDegenerate()||(this.addPoint(t.min),this.addPoint(t.max))}addPoint(t){t.x<this.min.x&&(this.min.x=t.x),t.y<this.min.y&&(this.min.y=t.y),t.z<this.min.z&&(this.min.z=t.z),t.x>this.max.x&&(this.max.x=t.x),t.y>this.max.y&&(this.max.y=t.y),t.z>this.max.z&&(this.max.z=t.z)}toJson(){return this._toJson()}_toJson(){return{min:this.min.toJson(),max:this.max.toJson()}}static fromJson(t){const e=t,i=_.fromJson(e.min),n=_.fromJson(e.max);return new on(i,n)}getCorners(){const t=[];return t[0]=this.min.copy(),t[1]=this.min.copy(),t[2]=this.min.copy(),t[1].x=this.max.x,t[2].y=this.max.y,t[3]=t[2].copy(),t[3].x=this.max.x,t[4]=t[0].copy(),t[5]=t[1].copy(),t[6]=t[2].copy(),t[7]=t[3].copy(),t[4].z=this.max.z,t[5].z=this.max.z,t[6].z=this.max.z,t[7].z=this.max.z,t}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}static invalid(){return new on(new _(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),new _(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY))}isDegenerate(){return this.min.x>this.max.x||this.min.y>this.max.y||this.min.z>this.max.z}}function vp(s){return s!==null&&typeof s=="object"&&"r"in s&&typeof s.r=="number"&&"g"in s&&typeof s.g=="number"&&"b"in s&&typeof s.b=="number"}class vt{constructor(t,e,i){this.r=t,this.g=e,this.b=i}assign(t){return this.set(t.r,t.g,t.b),this}copy(){return new vt(this.r,this.g,this.b)}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}set(t,e,i){this.r=t,this.g=e,this.b=i}setFromFloat(t,e,i){this.r=Math.round(255*t),this.g=Math.round(255*e),this.b=Math.round(255*i)}fromFloatArray(t){return this.setFromFloat(t[0],t[1],t[2])}getFloatArray(){return[this.r/255,this.g/255,this.b/255]}toFloatArray(t=[0,0,0]){return t[0]=this.r/255,t[1]=this.g/255,t[2]=this.b/255,t}static fromJson(t){if(vp(t))return new vt(t.r,t.g,t.b);throw new TypeError("Color.fromJson: data does not satisfy type IColor constraints")}toJson(){return{r:this.r,g:this.g,b:this.b}}static createFromFloat(t,e,i){const n=vt.black();return n.setFromFloat(t,e,i),n}static createFromFloatArray(t){const e=vt.black();return e.fromFloatArray(t),e}static red(){return new vt(255,0,0)}static green(){return new vt(0,255,0)}static blue(){return new vt(0,0,255)}static yellow(){return new vt(255,255,0)}static white(){return new vt(255,255,255)}static black(){return new vt(0,0,0)}}var Es=(s=>(s[s.Scalar=1]="Scalar",s[s.Vec3=3]="Vec3",s[s.Quat=4]="Quat",s))(Es||{});class Zl{constructor(t){this.keyType=t,this.times=[],this.values=[],this.tangents=[],this._hasTangents=null,this.keyOffset=t}_validateKey(t){if(this.keyType!==t)throw new Error(`Cannot add keyframe of type: ${Es[t]} to buffer of type: ${Es[this.keyType]}`)}_validateTangents(t){if(this._hasTangents===null)this._hasTangents=t;else if(this._hasTangents!==t)throw new Error(`Cannot add keyframe with${t?"":"out"} tangents to buffer with${t?"out":""} tangents`)}_findIndexFromTime(t){for(let e=0;e<this.times.length;e++)if(this.times[e]>=t)return e;return this.times.length}getKeyframeIndex(t){return this.times.indexOf(t)}deleteKeyframe(t){this.times.splice(t,1),this.tangents.splice(t*this.keyOffset*2,this.keyOffset*2),this.values.splice(t*this.keyOffset,this.keyOffset)}insertScalarKeyframe(t,e,i,n){this._validateKey(1);const r=this._findIndexFromTime(t);return this.times.splice(r,0,t),this.values.splice(r,0,e),i!==void 0&&n!==void 0?(this._validateTangents(!0),this.tangents.splice(r*2,0,i,n)):this._validateTangents(!1),r}updateScalarKeyframe(t,e,i,n,r){this.values[t]=i,this.times[t]=e,n!==void 0&&r!==void 0&&(this.tangents[t*2]=n,this.tangents[t*2+1]=r)}insertVec3Keyframe(t,e,i,n,r,o,l,h,u,d){this._validateKey(3);const g=this._findIndexFromTime(t);return this.times.splice(g,0,t),this.values.splice(g*this.keyOffset,0,e,i,n),r!==void 0&&o!==void 0&&l!==void 0&&h!==void 0&&u!==void 0&&d!==void 0?(this._validateTangents(!0),this.tangents.splice(g*this.keyOffset*2,0,r,o,l,h,u,d)):this._validateTangents(!1),g}updateVec3Keyframe(t,e,i,n,r,o,l,h,u,d,g){return this.times[t]=e,this.values[t*this.keyOffset]=i,this.values[t*this.keyOffset+1]=n,this.values[t*this.keyOffset+2]=r,o!==void 0&&l!==void 0&&h!==void 0&&u!==void 0&&d!==void 0&&g!==void 0?(this._validateTangents(!0),this.tangents.splice(t*this.keyOffset*2,0,o,l,h,u,d,g),this.tangents[t*this.keyOffset*2]=o,this.tangents[t*this.keyOffset*2+1]=l,this.tangents[t*this.keyOffset*2+2]=h,this.tangents[t*this.keyOffset*2+3]=u,this.tangents[t*this.keyOffset*2+4]=d,this.tangents[t*this.keyOffset*2+5]=g):this._validateTangents(!1),t}insertQuatKeyframe(t,e,i,n,r,o,l,h,u,d,g,y,m){this._validateKey(4);const I=this._findIndexFromTime(t);this.times.splice(I,0,t),this.values.splice(I*this.keyOffset,0,e,i,n,r),o!==void 0&&l!==void 0&&h!==void 0&&u!==void 0&&d!==void 0&&g!==void 0&&y!==void 0&&m!==void 0?(this._validateTangents(!0),this.tangents.splice(I*this.keyOffset*2,0,o,l,h,u,d,g,y,m)):this._validateTangents(!1)}updateQuatKeyframe(t,e,i,n,r,o,l,h,u,d,g,y,m,I){this.times[t]=e,this.values[t*this.keyOffset]=i,this.values[t*this.keyOffset+1]=n,this.values[t*this.keyOffset+2]=r,this.values[t*this.keyOffset+3]=o,l!==void 0&&h!==void 0&&u!==void 0&&d!==void 0&&g!==void 0&&y!==void 0&&m!==void 0&&I!==void 0?(this._validateTangents(!0),this.tangents.splice(t*this.keyOffset*2,0,l,h,u,g,y,m),this.tangents[t*this.keyOffset*2]=l,this.tangents[t*this.keyOffset*2+1]=h,this.tangents[t*this.keyOffset*2+2]=u,this.tangents[t*this.keyOffset*2+3]=I,this.tangents[t*this.keyOffset*2+4]=g,this.tangents[t*this.keyOffset*2+5]=y,this.tangents[t*this.keyOffset*2+6]=m,this.tangents[t*this.keyOffset*2+7]=I):this._validateTangents(!1)}_export(){const t={};return this.tangents.length!==0&&(t.tangents=this.tangents.slice()),{keyType:Es[this.keyType],times:this.times.slice(),values:this.values.slice(),...t}}static _import(t){const e=new Zl(Es[t.keyType]);return e.times=t.times.slice(),e.values=t.values.slice(),t.tangents!==void 0&&(e.tangents=t.tangents.slice()),e}}var En=(s=>(s[s.None=0]="None",s[s.Transform=1]="Transform",s[s.Opacity=2]="Opacity",s[s.Visibility=4]="Visibility",s[s.Color=8]="Color",s))(En||{});class bp{constructor(t){this.nodeId=t,this.translate=_.zero(),this.rotation=Bn.identity(),this.scale=new _(1,1,1),this.color=new _(1,1,1),this.pivotPoint=null,this.opacity=1,this.visibility=1,this.matrix=new _t,this.flags=0}updateMatrix(){this.pivotPoint?this._updateMatrixWithOrigin():this._updateMatrix()}_updateMatrixWithOrigin(){const t=this.rotation.x,e=this.rotation.y,i=this.rotation.z,n=this.rotation.w,r=t+t,o=e+e,l=i+i,h=t*r,u=t*o,d=t*l,g=e*o,y=e*l,m=i*l,I=n*r,b=n*o,x=n*l,C=this.scale.x,P=this.scale.y,k=this.scale.z,O=this.pivotPoint.x,B=this.pivotPoint.y,j=this.pivotPoint.z,V=(1-(g+m))*C,Y=(u+x)*C,q=(d-b)*C,st=(u-x)*P,ft=(1-(h+m))*P,U=(y+I)*P,J=(d+b)*k,A=(y-I)*k,R=(1-(h+g))*k;this.matrix.m[0]=V,this.matrix.m[1]=Y,this.matrix.m[2]=q,this.matrix.m[3]=0,this.matrix.m[4]=st,this.matrix.m[5]=ft,this.matrix.m[6]=U,this.matrix.m[7]=0,this.matrix.m[8]=J,this.matrix.m[9]=A,this.matrix.m[10]=R,this.matrix.m[11]=0,this.matrix.m[12]=this.translate.x+O-(V*O+st*B+J*j),this.matrix.m[13]=this.translate.y+B-(Y*O+ft*B+A*j),this.matrix.m[14]=this.translate.z+j-(q*O+U*B+R*j),this.matrix.m[15]=1}_updateMatrix(){const t=this.rotation.x,e=this.rotation.y,i=this.rotation.z,n=this.rotation.w,r=t+t,o=e+e,l=i+i,h=t*r,u=t*o,d=t*l,g=e*o,y=e*l,m=i*l,I=n*r,b=n*o,x=n*l,C=this.scale.x,P=this.scale.y,k=this.scale.z;this.matrix.m[0]=(1-(g+m))*C,this.matrix.m[1]=(u+x)*C,this.matrix.m[2]=(d-b)*C,this.matrix.m[3]=0,this.matrix.m[4]=(u-x)*P,this.matrix.m[5]=(1-(h+m))*P,this.matrix.m[6]=(y+I)*P,this.matrix.m[7]=0,this.matrix.m[8]=(d+b)*k,this.matrix.m[9]=(y-I)*k,this.matrix.m[10]=(1-(h+g))*k,this.matrix.m[11]=0,this.matrix.m[12]=this.translate.x,this.matrix.m[13]=this.translate.y,this.matrix.m[14]=this.translate.z,this.matrix.m[15]=1}}class Ip{constructor(){this.position=null,this.target=null,this.up=null,this.width=null,this.height=null}clear(){this.position=null,this.target=null,this.up=null,this.width=null,this.height=null}apply(t){let e=!1;return this.position!==null&&(t.setPosition(this.position),e=!0),this.target!==null&&(t.setTarget(this.target),e=!0),this.up!==null&&(t.setUp(this.up),e=!0),this.width!==null&&(t.setWidth(this.width),e=!0),this.height!==null&&(t.setHeight(this.height),e=!0),e}}class xp{constructor(){this.opacities=new Map,this.colors=new Map,this.matrixNodeIds=[],this.matrices=[],this.visibilityOn=[],this.visibilityOff=[]}clear(){this.opacities.clear(),this.colors.clear(),this.matrixNodeIds=[],this.matrices=[],this.visibilityOn=[],this.visibilityOff=[]}apply(t){const e=t.model;this.opacities.size>0&&e.setNodesOpacities(this.opacities),this.colors.size>0&&e.setNodesColors(this.colors),this.matrixNodeIds.length>0&&e._setNodesMatrices(this.matrixNodeIds,this.matrices),this.visibilityOn.length>0&&e.setNodesVisibility(this.visibilityOn,!0),this.visibilityOff.length>0&&e.setNodesVisibility(this.visibilityOff,!1)}}class Yh{constructor(){this.node=new xp,this.camera=new Ip}clear(){this.node.clear(),this.camera.clear()}apply(t){this.node.apply(t);const e=t.view,i=e.getCamera();this.camera.apply(i)&&e.setCamera(i)}}var Zh=(s=>(s[s.Translation=0]="Translation",s[s.Rotation=1]="Rotation",s[s.Scale=2]="Scale",s[s.Opacity=3]="Opacity",s[s.Visibility=4]="Visibility",s[s.Color=5]="Color",s[s.ColorMap=6]="ColorMap",s))(Zh||{});class Ql{constructor(t,e,i,n){switch(this.name=t,this.nodeId=e,this.property=i,this.sampler=n,this.property){case 0:case 2:case 5:if(n.buffer.keyType!==Es.Vec3)throw new Error("Key type mismatch. Expected Vec3");break;case 1:if(n.buffer.keyType!==Es.Quat)throw new Error("Key type mismatch. Expected Quat");break;case 3:case 4:case 6:if(n.buffer.keyType!==Es.Scalar)throw new Error("Key type mismatch. Expected Scalar");break}}_getValue(t,e){switch(this.property){case 0:this.sampler.interpolateVec3(t,e.translate),e.flags|=En.Transform;break;case 1:this.sampler.interpolateQuat(t,e.rotation),e.flags|=En.Transform;break;case 2:this.sampler.interpolateVec3(t,e.scale),e.flags|=En.Transform;break;case 3:e.opacity=this.sampler.interpolateScalar(t),e.flags|=En.Opacity;break;case 4:e.visibility=this.sampler.interpolateScalar(t),e.flags|=En.Visibility;break;case 5:this.sampler.interpolateVec3(t,e.color),e.flags|=En.Color;break;case 6:{const i=this.sampler.interpolateScalar(t),n=this._getColorFromMap(i);n!==null&&(e.color.set(n.r,n.g,n.b),e.flags|=En.Color)}break}}_getColorFromMap(t){const e=(n,r,o,l,h)=>{const u=(n-r)/(o-r);return new vt((1-u)*l.r+u*h.r,(1-u)*l.g+u*h.g,(1-u)*l.b+u*h.b)};if(this.colorMap===void 0)return null;t<0&&(t=0),t>1&&(t=1);let i=0;for(;i<this.colorMap.length-1;){const n=this.colorMap[i].position,r=this.colorMap[i].color,o=this.colorMap[i+1].position,l=this.colorMap[i+1].color;if(t<=n)return r;if(t<=o)return e(t,n,o,r,l);if(t>=o&&i===this.colorMap.length-2)return l;++i}return null}_gatherForExport(t){this.colorMap!==void 0&&t.colorMaps.add(this.colorMap),t.samplers.add(this.sampler),this.sampler._gatherForExport(t)}_export(t){const e={};return this.name!==""&&(e.name=this.name),this.colorMap!==void 0&&(e.colorMap=t.colorMaps.getIndex(this.colorMap)),{nodeId:this.nodeId,property:Zh[this.property],sampler:t.samplers.getIndex(this.sampler),...e}}static _import(t,e){const i=new Ql(e.name||"",e.nodeId,Zh[e.property],t.samplers[e.sampler]);return e.colorMap!==void 0&&(i.colorMap=t.colorMaps[e.colorMap]),i}}var or=(s=>(s[s.Position=0]="Position",s[s.Target=1]="Target",s[s.Up=2]="Up",s[s.Width=3]="Width",s[s.Height=4]="Height",s))(or||{});class tc{constructor(t,e,i){switch(this.name=t,this.property=e,this.sampler=i,this.property){case 0:case 1:case 2:if(i.buffer.keyType!==Es.Vec3)throw new Error("Key type mismatch. Expected Vec3");break;case 3:case 4:if(i.buffer.keyType!==Es.Scalar)throw new Error("Key type mismatch. Expected Scalar");break}}_getValue(t,e){switch(this.property){case 0:e.position===null&&(e.position=new _(0,0,0)),this.sampler.interpolateVec3(t,e.position);break;case 1:e.target===null&&(e.target=new _(0,0,-1)),this.sampler.interpolateVec3(t,e.target);break;case 2:e.up===null&&(e.up=new _(0,1,0)),this.sampler.interpolateVec3(t,e.up);break;case 3:e.width=this.sampler.interpolateScalar(t);break;case 4:e.height=this.sampler.interpolateScalar(t)}}_gatherForExport(t){t.samplers.add(this.sampler),this.sampler._gatherForExport(t)}_export(t){const e={};return this.name!==""&&(e.name=this.name),{property:or[this.property],sampler:t.samplers.getIndex(this.sampler),...e}}static _import(t,e){return new tc(e.name||"",or[e.property],t.samplers[e.sampler])}}class Qh{constructor(t){this.name=t,this.nodeChannels=[],this.cameraChannels=[],this.pivotPoints=new Map}createNodeChannel(t,e,i,n){const r=new Ql(t,e,i,n);return this._registerNodeChannel(r),r}_registerNodeChannel(t){this.nodeChannels.push(t)}createCameraChannel(t,e,i){const n=new tc(t,e,i);return this._registerCameraChannel(n),n}_registerCameraChannel(t){this.cameraChannels.push(t)}deleteChannel(t){for(let e=0;e<this.nodeChannels.length;e++)if(this.nodeChannels[e]===t){this.nodeChannels.splice(e,1);return}for(let e=0;e<this.cameraChannels.length;e++)if(this.cameraChannels[e]===t){this.cameraChannels.splice(e,1);return}}_gatherForExport(t){for(const e of this.nodeChannels)e._gatherForExport(t);for(const e of this.cameraChannels)e._gatherForExport(t)}_export(t){const e=[],i={};this.name!==""&&(i.name=this.name);const n={},r=o=>{if(this[o].length===0)return;const l=[];for(const h of this[o])l.push(h._export(t));n[o]=l};return this.pivotPoints.forEach((o,l)=>{e.push({node:l,point:o})}),e.length!==0&&(i.pivotPoints=e),r("nodeChannels"),r("cameraChannels"),{...i,...n}}static _import(t,e){const i=new Qh(e.name||"");if(e.nodeChannels!==void 0)for(const n of e.nodeChannels)i._registerNodeChannel(Ql._import(t,n));if(e.cameraChannels!==void 0)for(const n of e.cameraChannels)i._registerCameraChannel(tc._import(t,n));if(e.pivotPoints!==void 0)for(const n of e.pivotPoints){const r=_.fromJson(n.point);i.pivotPoints.set(n.node,r)}return i}}var tu=(s=>(s[s.Constant=0]="Constant",s[s.Linear=1]="Linear",s[s.CubicSpline=2]="CubicSpline",s))(tu||{});const Wt=class Wt{constructor(t,e){this.buffer=t,this.interpolationType=e}_getNextKeyframeIndex(t){for(let e=0;e<this.buffer.times.length;e+=1)if(this.buffer.times[e]>t)return e;return this.buffer.times.length}interpolateQuat(t,e){const i=this._getNextKeyframeIndex(t);if(i===0){this._setQuatFromKeyframeIndex(0,e);return}else if(i===this.buffer.times.length){this._setQuatFromKeyframeIndex(i-1,e);return}switch(this.interpolationType){case 0:this._setQuatFromKeyframeIndex(i-1,e);break;case 1:this.interpolateQuatSlerp(i-1,i,t,e);break;case 2:this.interpolateQuatCubicSpline(i-1,i,t,e);break}}interpolateVec3(t,e){const i=this._getNextKeyframeIndex(t);if(i===0){this._setVecFromKeyframeIndex(0,e);return}else if(i===this.buffer.times.length){this._setVecFromKeyframeIndex(i-1,e);return}switch(this.interpolationType){case 0:this._setVecFromKeyframeIndex(i-1,e);break;case 1:this.interpolateVec3Linear(i-1,i,t,e);break;case 2:this.interpolateVec3CubicSpline(i-1,i,t,e);break}}interpolateScalar(t){const e=this._getNextKeyframeIndex(t);if(e===0)return this.buffer.values[0];if(e===this.buffer.times.length)return this.buffer.values[e-1];switch(this.interpolationType){case 0:return this.buffer.values[e-1];case 1:return this.interpolateScalarLinear(e-1,e,t);case 2:return this.interpolateScalarCubicSpline(e-1,e,t)}}interpolateScalarLinear(t,e,i){const n=this.buffer.times[e]-this.buffer.times[t],r=(i-this.buffer.times[t])/n,o=this.buffer.values[t],l=this.buffer.values[e];return o+(l-o)*r}interpolateQuatSlerp(t,e,i,n){const r=this.buffer.times[e]-this.buffer.times[t],o=(i-this.buffer.times[t])/r;this._setQuatFromKeyframeIndex(t,Wt.q0),this._setQuatFromKeyframeIndex(e,Wt.q1),n.assign(Bn.interpolate(Wt.q0,Wt.q1,o))}static _interpVec3(t,e,i,n){e.subtract(t),e.scale(i),e.add(t),n.assign(e)}interpolateVec3Linear(t,e,i,n){const r=this.buffer.times[e]-this.buffer.times[t],o=(i-this.buffer.times[t])/r;this._setVecFromKeyframeIndex(t,Wt.v0),this._setVecFromKeyframeIndex(e,Wt.v1),Wt._interpVec3(Wt.v0,Wt.v1,o,n)}_interpCubicSpline(t,e,i,n,r){const o=t**2,l=t**3;return(2*l-3*o+1)*e+(l-2*o+t)*n+(-2*l+3*o)*i+(l-o)*r}interpolateScalarCubicSpline(t,e,i){const n=this.buffer.times[e]-this.buffer.times[t],r=(i-this.buffer.times[t])/n,o=this.buffer.values[t],l=this.buffer.values[e];let h=0,u=0;return this.buffer.tangents.length!==0&&(h=this.buffer.tangents[t]*n,u=this.buffer.tangents[e]*n),this._interpCubicSpline(r,o,l,h,u)}interpolateVec3CubicSpline(t,e,i,n){const r=this.buffer.times[e]-this.buffer.times[t],o=(i-this.buffer.times[t])/r;this._setVecFromKeyframeIndex(t,Wt.v0),this._setVecFromKeyframeIndex(e,Wt.v1),this._setVecTanFromKeyframeIndex(t,Wt.v2),this._setVecTanFromKeyframeIndex(e,Wt.v3),Wt.v2.scale(r),Wt.v3.scale(r),n.set(this._interpCubicSpline(o,Wt.v0.x,Wt.v1.x,Wt.v2.x,Wt.v3.x),this._interpCubicSpline(o,Wt.v0.y,Wt.v1.y,Wt.v2.y,Wt.v3.y),this._interpCubicSpline(o,Wt.v0.z,Wt.v1.z,Wt.v2.z,Wt.v3.z))}interpolateQuatCubicSpline(t,e,i,n){const r=this.buffer.times[e]-this.buffer.times[t],o=(i-this.buffer.times[t])/r;this._setQuatFromKeyframeIndex(t,Wt.q0),this._setQuatFromKeyframeIndex(e,Wt.q1),this._setQuatTanFromKeyframeIndex(t,Wt.q2),this._setQuatTanFromKeyframeIndex(e,Wt.q3),Wt.q4.set(Wt.q2.x*r,Wt.q2.y*r,Wt.q2.z*r,Wt.q2.w*r),Wt.q5.set(Wt.q3.x*r,Wt.q3.y*r,Wt.q3.z*r,Wt.q3.w*r),n.set(this._interpCubicSpline(o,Wt.q0.x,Wt.q1.x,Wt.q4.x,Wt.q5.x),this._interpCubicSpline(o,Wt.q0.y,Wt.q1.y,Wt.q4.y,Wt.q5.y),this._interpCubicSpline(o,Wt.q0.z,Wt.q1.z,Wt.q4.z,Wt.q5.z),this._interpCubicSpline(o,Wt.q0.w,Wt.q1.w,Wt.q4.w,Wt.q5.w)),n.normalize()}_setVecFromKeyframeIndex(t,e){const i=t*3;e.set(this.buffer.values[i],this.buffer.values[i+1],this.buffer.values[i+2])}_setVecTanFromKeyframeIndex(t,e){if(this.buffer.tangents.length===0)e.set(0,0,0);else{const i=t*3;e.set(this.buffer.tangents[i],this.buffer.tangents[i+1],this.buffer.tangents[i+2])}}_setQuatFromKeyframeIndex(t,e){const i=t*4;e.set(this.buffer.values[i],this.buffer.values[i+1],this.buffer.values[i+2],this.buffer.values[i+3])}_setQuatTanFromKeyframeIndex(t,e){if(this.buffer.tangents.length===0)e.set(0,0,0,1);else{const i=t*4;e.set(this.buffer.tangents[i],this.buffer.tangents[i+1],this.buffer.tangents[i+2],this.buffer.tangents[i+3])}}_gatherForExport(t){t.buffers.add(this.buffer)}_export(t){return{buffer:t.buffers.getIndex(this.buffer),interpolationType:tu[this.interpolationType]}}static _import(t,e){return new Wt(t.buffers[e.buffer],tu[e.interpolationType])}};Wt.q0=Bn.identity(),Wt.q1=Bn.identity(),Wt.q2=Bn.identity(),Wt.q3=Bn.identity(),Wt.q4=Bn.identity(),Wt.q5=Bn.identity(),Wt.v0=_.zero(),Wt.v1=_.zero(),Wt.v2=_.zero(),Wt.v3=_.zero();let ec=Wt;var Ga=(s=>(s[s.Unknown=0]="Unknown",s[s.Catia=2]="Catia",s[s.CatiaV5=3]="CatiaV5",s[s.Cadds=4]="Cadds",s[s.Unigraphics=5]="Unigraphics",s[s.Parasolid=6]="Parasolid",s[s.Euclid=7]="Euclid",s[s.Iges=9]="Iges",s[s.Unisurf=10]="Unisurf",s[s.Vda=11]="Vda",s[s.Stl=12]="Stl",s[s.Wrl=13]="Wrl",s[s.Dxf=14]="Dxf",s[s.Acis=15]="Acis",s[s.ProE=16]="ProE",s[s.Step=18]="Step",s[s.Ideas=19]="Ideas",s[s.Jt=20]="Jt",s[s.Slw=22]="Slw",s[s.Cgr=23]="Cgr",s[s.Prc=24]="Prc",s[s.Xvl=25]="Xvl",s[s.Hpgl=26]="Hpgl",s[s.TopSolid=27]="TopSolid",s[s.OneSpaceDesigner=28]="OneSpaceDesigner",s[s._3dxml=29]="_3dxml",s[s.Inventor=30]="Inventor",s[s.PostScript=31]="PostScript",s[s.Pdp=32]="Pdp",s[s.U3d=33]="U3d",s[s.Ifc=34]="Ifc",s[s.Dwg=35]="Dwg",s[s.Dwf=36]="Dwf",s[s.Se=37]="Se",s[s.Obj=38]="Obj",s[s.Kmz=39]="Kmz",s[s.Dae=40]="Dae",s[s._3ds=41]="_3ds",s[s.Rhino=43]="Rhino",s[s.Xml=44]="Xml",s[s._3mf=45]="_3mf",s[s.Scs=46]="Scs",s[s._3dHtml=47]="_3dHtml",s[s.Hsf=48]="Hsf",s[s.Gltf=49]="Gltf",s[s.Revit=50]="Revit",s[s.Fbx=51]="Fbx",s))(Ga||{}),fi=(s=>(s[s.IsLoaded=-2147483648]="IsLoaded",s[s.InitiallyShown=1073741824]="InitiallyShown",s[s.InitiallyRemoved=536870912]="InitiallyRemoved",s[s.OutOfHierarchy=268435456]="OutOfHierarchy",s[s.IsAnnotationView=134217728]="IsAnnotationView",s[s.IsCameraSet=67108864]="IsCameraSet",s[s.IsPmiFilteringSet=33554432]="IsPmiFilteringSet",s[s.IsGeomFilteringSet=16777216]="IsGeomFilteringSet",s[s.IsCrossSectionSet=8388608]="IsCrossSectionSet",s[s.IsExplosionSet=4194304]="IsExplosionSet",s[s.IsCombineState=2097152]="IsCombineState",s[s.IsPerspective=1048576]="IsPerspective",s[s.IsShownSpecified=524288]="IsShownSpecified",s[s.IsShown=262144]="IsShown",s[s.BranchVisibilityHidden=131072]="BranchVisibilityHidden",s[s.BranchVisibilityShown=65536]="BranchVisibilityShown",s[s.BranchVisibilityDirty=32768]="BranchVisibilityDirty",s[s.PreventFromResetting=16384]="PreventFromResetting",s[s.HasDynamicFrame=8192]="HasDynamicFrame",s[s.IsMissing=4096]="IsMissing",s[s.IsExternalModelRoot=2048]="IsExternalModelRoot",s[s.Requested=1024]="Requested",s[s.ImplicitBody=512]="ImplicitBody",s[s.IsDefaultView=256]="IsDefaultView",s[s.Unused2=128]="Unused2",s[s.Unused1=64]="Unused1",s[s.NodeTypeDrawingSheet=32]="NodeTypeDrawingSheet",s[s.IsADefaultNodeType=16]="IsADefaultNodeType",s[s.NodeTypeDrawingView=8]="NodeTypeDrawingView",s[s.NodeTypeGroup=4]="NodeTypeGroup",s[s.NodeTypeProduct=2]="NodeTypeProduct",s[s.IsAConfigurationNode=1]="IsAConfigurationNode",s))(fi||{}),Mr=(s=>(s[s.OutOfHierarchy=268435456]="OutOfHierarchy",s[s.PreventFromResetting=16384]="PreventFromResetting",s[s.Requested=1024]="Requested",s[s.ImplicitBody=512]="ImplicitBody",s))(Mr||{}),nf=(s=>(s[s.IgnoreParentScale=1]="IgnoreParentScale",s[s.IgnoreParentRotation=2]="IgnoreParentRotation",s))(nf||{}),jt=(s=>(s[s.None=0]="None",s[s.BodyInstance=1]="BodyInstance",s[s.PmiBody=2]="PmiBody",s[s.ViewFrame=4]="ViewFrame",s[s.All=7]="All",s))(jt||{}),In=(s=>(s[s.ProductOccurrence=0]="ProductOccurrence",s[s.AnyBody=1]="AnyBody",s[s.BodyInstance=2]="BodyInstance",s[s.CadView=3]="CadView",s))(In||{}),Vi=(s=>(s[s.InitiallyShown=fi.InitiallyShown]="InitiallyShown",s[s.InitiallyRemoved=fi.InitiallyRemoved]="InitiallyRemoved",s[s.IsShownSpecified=fi.IsShownSpecified]="IsShownSpecified",s[s.IsShown=fi.IsShown]="IsShown",s[s.IsLoaded=fi.IsLoaded]="IsLoaded",s))(Vi||{}),sf=(s=>(s[s.IsMissing=fi.IsMissing]="IsMissing",s))(sf||{}),Ci=(s=>(s[s.IsAnnotationView=fi.IsAnnotationView]="IsAnnotationView",s[s.IsCameraSet=fi.IsCameraSet]="IsCameraSet",s[s.IsPmiFilteringSet=fi.IsPmiFilteringSet]="IsPmiFilteringSet",s[s.IsGeomFilteringSet=fi.IsGeomFilteringSet]="IsGeomFilteringSet",s[s.IsCrossSectionSet=fi.IsCrossSectionSet]="IsCrossSectionSet",s[s.IsExplosionSet=fi.IsExplosionSet]="IsExplosionSet",s[s.IsCombineState=fi.IsCombineState]="IsCombineState",s[s.IsPerspective=fi.IsPerspective]="IsPerspective",s[s.HasDynamicFrame=fi.HasDynamicFrame]="HasDynamicFrame",s[s.IsDefaultView=fi.IsDefaultView]="IsDefaultView",s))(Ci||{}),xo=(s=>(s[s.Rgba32=0]="Rgba32",s[s.Rgb24=1]="Rgb24",s[s.Gray8=2]="Gray8",s[s.GrayAlpha16=3]="GrayAlpha16",s[s.Jpeg=4]="Jpeg",s[s.Png=5]="Png",s))(xo||{}),rf=(s=>(s[s.Invalid=4294967295]="Invalid",s))(rf||{}),Er=(s=>(s[s.Invalid=4294967295]="Invalid",s[s.Local=0]="Local",s))(Er||{}),$a=(s=>(s[s.Invalid=4294967295]="Invalid",s))($a||{}),eu=(s=>(s[s.Invalid=4294967295]="Invalid",s))(eu||{}),Cp=(s=>(s[s.Invalid=4294967295]="Invalid",s))(Cp||{}),Sp=(s=>(s[s.Invalid=4294967295]="Invalid",s))(Sp||{}),ki=(s=>(s[s.Invalid=4294967295]="Invalid",s[s.Local=0]="Local",s))(ki||{}),of=(s=>(s[s.Invalid=4294967295]="Invalid",s))(of||{}),Pp=(s=>(s[s.Invalid=4294967295]="Invalid",s))(Pp||{}),kp=(s=>(s[s.Invalid=4294967295]="Invalid",s))(kp||{}),ic=(s=>(s[s.Invalid=4294967295]="Invalid",s))(ic||{}),fs=(s=>(s[s.Invalid=4294967295]="Invalid",s[s.Empty=4294967294]="Empty",s[s.Local=0]="Local",s))(fs||{}),Mp=(s=>(s[s.World=0]="World",s[s.Camera=1]="Camera",s))(Mp||{}),iu=(s=>(s[s.Directional=0]="Directional",s[s.Point=1]="Point",s))(iu||{}),ta=(s=>(s[s.OfInitialEmptyModel=0]="OfInitialEmptyModel",s))(ta||{}),qa=(s=>(s[s.None=0]="None",s[s.SMAA=1]="SMAA",s))(qa||{}),nc=(s=>(s[s.Floor=0]="Floor",s[s.Wall=1]="Wall",s[s.Door=2]="Door",s))(nc||{}),sc=(s=>(s[s.Pixels=0]="Pixels",s[s.ProportionOfWidth=1]="ProportionOfWidth",s[s.ProportionOfHeight=2]="ProportionOfHeight",s))(sc||{}),Ep=(s=>(s[s.Object=0]="Object",s[s.World=1]="World",s))(Ep||{}),ar=(s=>(s[s.Default=0]="Default",s[s.Highlight=1]="Highlight",s[s.HiddenLine=2]="HiddenLine",s[s.XRay=3]="XRay",s[s.Gooch=4]="Gooch",s[s.Toon=5]="Toon",s))(ar||{}),Ap=(s=>(s[s.FixedFramerate=0]="FixedFramerate",s[s.OcclusionCulling=1]="OcclusionCulling",s))(Ap||{}),an=(s=>(s[s.Faces=0]="Faces",s[s.Lines=1]="Lines",s[s.Points=2]="Points",s))(an||{}),Tp=(s=>(s[s.None=0]="None",s[s.Faces=1]="Faces",s[s.Lines=2]="Lines",s[s.Points=4]="Points",s[s.All=7]="All",s))(Tp||{}),An=(s=>(s[s.Base=0]="Base",s[s.Specular=1]="Specular",s[s.Emissive=2]="Emissive",s[s.Ambient=3]="Ambient",s))(An||{}),Ar=(s=>(s[s.None=0]="None",s[s.Modulate=1]="Modulate",s[s.Desaturate=2]="Desaturate",s[s.Colorize=3]="Colorize",s))(Ar||{}),nu=(s=>(s[s.Visible=0]="Visible",s[s.VisibleWithFullOutline=1]="VisibleWithFullOutline",s))(nu||{}),Np=(s=>(s[s.Object=0]="Object",s[s.World=1]="World",s[s.ProportionOfScreenWidth=2]="ProportionOfScreenWidth",s[s.ProportionOfScreenHeight=3]="ProportionOfScreenHeight",s))(Np||{}),Dp=(s=>(s[s.Square=0]="Square",s[s.Disk=1]="Disk",s[s.Sphere=2]="Sphere",s))(Dp||{}),Op=(s=>(s[s.ScreenPixels=0]="ScreenPixels",s[s.CSSPixels=1]="CSSPixels",s[s.World=2]="World",s[s.ProportionOfScreenWidth=3]="ProportionOfScreenWidth",s[s.ProportionOfScreenHeight=4]="ProportionOfScreenHeight",s[s.ProportionOfBoundingDiagonal=5]="ProportionOfBoundingDiagonal",s))(Op||{}),rc=(s=>(s[s.Perspective=0]="Perspective",s[s.Orthographic=1]="Orthographic",s[s.Stretched=2]="Stretched",s))(rc||{}),Xi=(s=>(s[s.Uninitialized=0]="Uninitialized",s[s.Network=1]="Network",s[s.Scs=2]="Scs",s))(Xi||{}),to=(s=>(s[s.Hide=0]="Hide",s[s.Show=1]="Show",s[s.Initial=2]="Initial",s))(to||{}),af=(s=>(s[s.World=0]="World",s[s.ProportionOfBoundingHeight=1]="ProportionOfBoundingHeight",s))(af||{}),Rp=(s=>(s[s.Low=0]="Low",s[s.Medium=1]="Medium",s[s.High=2]="High",s[s.Ultra=3]="Ultra",s))(Rp||{}),lf=(s=>(s[s.SessionNotStarted=0]="SessionNotStarted",s[s.Cancelled=1]="Cancelled",s[s.CorruptRpcMessage=2]="CorruptRpcMessage",s))(lf||{}),su=(s=>(s[s.On=0]="On",s[s.Off=1]="Off",s))(su||{}),ru=(s=>(s[s.On=0]="On",s[s.Off=1]="Off",s))(ru||{}),oc=(s=>(s[s.None=0]="None",s[s.Decal=1]="Decal",s))(oc||{}),ou=(s=>(s[s.UV=0]="UV",s))(ou||{}),au=(s=>(s[s.Repeat=0]="Repeat",s[s.Clamp=1]="Clamp",s[s.Trim=2]="Trim",s))(au||{}),Lp=(s=>(s[s.Unsorted=0]="Unsorted",s[s.SingleLayer=1]="SingleLayer",s))(Lp||{}),lu=(s=>(s[s.Selected=0]="Selected",s[s.Unselected=1]="Unselected",s))(lu||{}),ln=(s=>(s[s.None=0]="None",s[s.Floor=1]="Floor",s[s.Wall=2]="Wall",s[s.Door=4]="Door",s))(ln||{}),ke=(s=>(s[s.Invalid=-1]="Invalid",s[s.Default=0]="Default",s))(ke||{}),lr=(s=>(s[s.UpperLeftCorner=0]="UpperLeftCorner",s[s.LowerLeftCorner=1]="LowerLeftCorner",s[s.LowerRightCorner=2]="LowerRightCorner",s[s.UpperRightCorner=3]="UpperRightCorner",s[s.TopCenter=4]="TopCenter",s[s.LeftCenter=5]="LeftCenter",s[s.RightCenter=6]="RightCenter",s[s.BottomCenter=7]="BottomCenter",s[s.Center=8]="Center",s))(lr||{}),Ka=(s=>(s[s.Pixels=0]="Pixels",s[s.ProportionOfScreen=1]="ProportionOfScreen",s[s.MinimumProportionOfScreen=2]="MinimumProportionOfScreen",s[s.ProportionOfOtherDimension=3]="ProportionOfOtherDimension",s))(Ka||{});const As=0;function ea(s){return s!==null&&typeof s=="object"&&"scFunction"in s&&typeof s.scFunction=="string"}function Fp(s){const t=s.data;return t!==null&&typeof t=="object"&&"scStateFailure"in t?t.scStateFailure:null}var ia=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function cu(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Bp={exports:{}};/*!
 * Bowser - a browser detector
 * https://github.com/ded/bowser
 * MIT License | (c) Dustin Diaz 2015
 */(function(s){(function(t,e,i){s.exports?s.exports=i():t[e]=i()})(ia,"bowser",function(){var t=!0;function e(u){function d(X){var Tt=u.match(X);return Tt&&Tt.length>1&&Tt[1]||""}function g(X){var Tt=u.match(X);return Tt&&Tt.length>1&&Tt[2]||""}var y=d(/(ipod|iphone|ipad)/i).toLowerCase(),m=/like android/i.test(u),I=!m&&/android/i.test(u),b=/nexus\s*[0-6]\s*/i.test(u),x=!b&&/nexus\s*[0-9]+/i.test(u),C=/CrOS/.test(u),P=/silk/i.test(u),k=/sailfish/i.test(u),O=/tizen/i.test(u),B=/(web|hpw)(o|0)s/i.test(u),j=/windows phone/i.test(u),V=!j&&/windows/i.test(u),Y=!y&&!P&&/macintosh/i.test(u),q=!I&&!k&&!O&&!B&&/linux/i.test(u),st=g(/edg([ea]|ios)\/(\d+(\.\d+)?)/i),ft=d(/version\/(\d+(\.\d+)?)/i),U=/tablet/i.test(u)&&!/tablet pc/i.test(u),J=!U&&/[^-]mobi/i.test(u),A=/xbox/i.test(u),R;/opera/i.test(u)?R={name:"Opera",opera:t,version:ft||d(/(?:opera|opr|opios)[\s\/](\d+(\.\d+)?)/i)}:/opr\/|opios/i.test(u)?R={name:"Opera",opera:t,version:d(/(?:opr|opios)[\s\/](\d+(\.\d+)?)/i)||ft}:/SamsungBrowser/i.test(u)?R={name:"Samsung Internet for Android",samsungBrowser:t,version:ft||d(/(?:SamsungBrowser)[\s\/](\d+(\.\d+)?)/i)}:/Whale/i.test(u)?R={name:"NAVER Whale browser",whale:t,version:d(/(?:whale)[\s\/](\d+(?:\.\d+)+)/i)}:/MZBrowser/i.test(u)?R={name:"MZ Browser",mzbrowser:t,version:d(/(?:MZBrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/coast/i.test(u)?R={name:"Opera Coast",coast:t,version:ft||d(/(?:coast)[\s\/](\d+(\.\d+)?)/i)}:/focus/i.test(u)?R={name:"Focus",focus:t,version:d(/(?:focus)[\s\/](\d+(?:\.\d+)+)/i)}:/yabrowser/i.test(u)?R={name:"Yandex Browser",yandexbrowser:t,version:ft||d(/(?:yabrowser)[\s\/](\d+(\.\d+)?)/i)}:/ucbrowser/i.test(u)?R={name:"UC Browser",ucbrowser:t,version:d(/(?:ucbrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/mxios/i.test(u)?R={name:"Maxthon",maxthon:t,version:d(/(?:mxios)[\s\/](\d+(?:\.\d+)+)/i)}:/epiphany/i.test(u)?R={name:"Epiphany",epiphany:t,version:d(/(?:epiphany)[\s\/](\d+(?:\.\d+)+)/i)}:/puffin/i.test(u)?R={name:"Puffin",puffin:t,version:d(/(?:puffin)[\s\/](\d+(?:\.\d+)?)/i)}:/sleipnir/i.test(u)?R={name:"Sleipnir",sleipnir:t,version:d(/(?:sleipnir)[\s\/](\d+(?:\.\d+)+)/i)}:/k-meleon/i.test(u)?R={name:"K-Meleon",kMeleon:t,version:d(/(?:k-meleon)[\s\/](\d+(?:\.\d+)+)/i)}:j?(R={name:"Windows Phone",osname:"Windows Phone",windowsphone:t},st?(R.msedge=t,R.version=st):(R.msie=t,R.version=d(/iemobile\/(\d+(\.\d+)?)/i))):/msie|trident/i.test(u)?R={name:"Internet Explorer",msie:t,version:d(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:C?R={name:"Chrome",osname:"Chrome OS",chromeos:t,chromeBook:t,chrome:t,version:d(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:/edg([ea]|ios)/i.test(u)?R={name:"Microsoft Edge",msedge:t,version:st}:/vivaldi/i.test(u)?R={name:"Vivaldi",vivaldi:t,version:d(/vivaldi\/(\d+(\.\d+)?)/i)||ft}:k?R={name:"Sailfish",osname:"Sailfish OS",sailfish:t,version:d(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(u)?R={name:"SeaMonkey",seamonkey:t,version:d(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel|fxios/i.test(u)?(R={name:"Firefox",firefox:t,version:d(/(?:firefox|iceweasel|fxios)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(u)&&(R.firefoxos=t,R.osname="Firefox OS")):P?R={name:"Amazon Silk",silk:t,version:d(/silk\/(\d+(\.\d+)?)/i)}:/phantom/i.test(u)?R={name:"PhantomJS",phantom:t,version:d(/phantomjs\/(\d+(\.\d+)?)/i)}:/slimerjs/i.test(u)?R={name:"SlimerJS",slimer:t,version:d(/slimerjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(u)||/rim\stablet/i.test(u)?R={name:"BlackBerry",osname:"BlackBerry OS",blackberry:t,version:ft||d(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:B?(R={name:"WebOS",osname:"WebOS",webos:t,version:ft||d(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(u)&&(R.touchpad=t)):/bada/i.test(u)?R={name:"Bada",osname:"Bada",bada:t,version:d(/dolfin\/(\d+(\.\d+)?)/i)}:O?R={name:"Tizen",osname:"Tizen",tizen:t,version:d(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||ft}:/qupzilla/i.test(u)?R={name:"QupZilla",qupzilla:t,version:d(/(?:qupzilla)[\s\/](\d+(?:\.\d+)+)/i)||ft}:/chromium/i.test(u)?R={name:"Chromium",chromium:t,version:d(/(?:chromium)[\s\/](\d+(?:\.\d+)?)/i)||ft}:/chrome|crios|crmo/i.test(u)?R={name:"Chrome",chrome:t,version:d(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:I?R={name:"Android",version:ft}:/safari|applewebkit/i.test(u)?(R={name:"Safari",safari:t},ft&&(R.version=ft)):y?(R={name:y=="iphone"?"iPhone":y=="ipad"?"iPad":"iPod"},ft&&(R.version=ft)):/googlebot/i.test(u)?R={name:"Googlebot",googlebot:t,version:d(/googlebot\/(\d+(\.\d+))/i)||ft}:R={name:d(/^(.*)\/(.*) /),version:g(/^(.*)\/(.*) /)},!R.msedge&&/(apple)?webkit/i.test(u)?(/(apple)?webkit\/537\.36/i.test(u)?(R.name=R.name||"Blink",R.blink=t):(R.name=R.name||"Webkit",R.webkit=t),!R.version&&ft&&(R.version=ft)):!R.opera&&/gecko\//i.test(u)&&(R.name=R.name||"Gecko",R.gecko=t,R.version=R.version||d(/gecko\/(\d+(\.\d+)?)/i)),!R.windowsphone&&(I||R.silk)?(R.android=t,R.osname="Android"):!R.windowsphone&&y?(R[y]=t,R.ios=t,R.osname="iOS"):Y?(R.mac=t,R.osname="macOS"):A?(R.xbox=t,R.osname="Xbox"):V?(R.windows=t,R.osname="Windows"):q&&(R.linux=t,R.osname="Linux");function bt(X){switch(X){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}var z="";R.windows?z=bt(d(/Windows ((NT|XP)( \d\d?.\d)?)/i)):R.windowsphone?z=d(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):R.mac?(z=d(/Mac OS X (\d+([_\.\s]\d+)*)/i),z=z.replace(/[_\s]/g,".")):y?(z=d(/os (\d+([_\s]\d+)*) like mac os x/i),z=z.replace(/[_\s]/g,".")):I?z=d(/android[ \/-](\d+(\.\d+)*)/i):R.webos?z=d(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):R.blackberry?z=d(/rim\stablet\sos\s(\d+(\.\d+)*)/i):R.bada?z=d(/bada\/(\d+(\.\d+)*)/i):R.tizen&&(z=d(/tizen[\/\s](\d+(\.\d+)*)/i)),z&&(R.osversion=z);var Pt=!R.windows&&z.split(".")[0];return U||x||y=="ipad"||I&&(Pt==3||Pt>=4&&!J)||R.silk?R.tablet=t:(J||y=="iphone"||y=="ipod"||I||b||R.blackberry||R.webos||R.bada)&&(R.mobile=t),R.msedge||R.msie&&R.version>=10||R.yandexbrowser&&R.version>=15||R.vivaldi&&R.version>=1||R.chrome&&R.version>=20||R.samsungBrowser&&R.version>=4||R.whale&&o([R.version,"1.0"])===1||R.mzbrowser&&o([R.version,"6.0"])===1||R.focus&&o([R.version,"1.0"])===1||R.firefox&&R.version>=20||R.safari&&R.version>=6||R.opera&&R.version>=10||R.ios&&R.osversion&&R.osversion.split(".")[0]>=6||R.blackberry&&R.version>=10.1||R.chromium&&R.version>=20?R.a=t:R.msie&&R.version<10||R.chrome&&R.version<20||R.firefox&&R.version<20||R.safari&&R.version<6||R.opera&&R.version<10||R.ios&&R.osversion&&R.osversion.split(".")[0]<6||R.chromium&&R.version<20?R.c=t:R.x=t,R}var i=e(typeof navigator<"u"&&navigator.userAgent||"");i.test=function(u){for(var d=0;d<u.length;++d){var g=u[d];if(typeof g=="string"&&g in i)return!0}return!1};function n(u){return u.split(".").length}function r(u,d){var g=[],y;if(Array.prototype.map)return Array.prototype.map.call(u,d);for(y=0;y<u.length;y++)g.push(d(u[y]));return g}function o(u){for(var d=Math.max(n(u[0]),n(u[1])),g=r(u,function(y){var m=d-n(y);return y=y+new Array(m+1).join(".0"),r(y.split("."),function(I){return new Array(20-I.length).join("0")+I}).reverse()});--d>=0;){if(g[0][d]>g[1][d])return 1;if(g[0][d]===g[1][d]){if(d===0)return 0}else return-1}}function l(u,d,g){var y=i;typeof d=="string"&&(g=d,d=void 0),d===void 0&&(d=!1),g&&(y=e(g));var m=""+y.version;for(var I in u)if(u.hasOwnProperty(I)&&y[I]){if(typeof u[I]!="string")throw new Error("Browser version in the minVersion map should be a string: "+I+": "+String(u));return o([m,u[I]])<0}return d}function h(u,d,g){return!l(u,d,g)}return i.isUnsupportedBrowser=l,i.compareVersions=o,i.check=h,i._detect=e,i.detect=e,i})})(Bp);var Vp=Bp.exports;const ev=Kw({__proto__:null,default:cu(Vp)},[Vp]);var iv=(()=>{var s=$d&&$d.tagName.toUpperCase()==="SCRIPT"&&$d.src||new URL("hoops-web-viewer.iife.js",document.baseURI).href;return function(t){t=t||{};var e;e||(e=typeof t<"u"?t:{});var i,n;e.ready=new Promise(function(a,c){i=a,n=c}),e.$$setReady=function(){e.kk(),e.$$onReady.apply(window,arguments),e.$$onReady=void 0,e.onAbort=void 0},e.kk=function(){function a(Vt){if(!Vt)return 0;var Dt=e.$$es.allocateUint8Buffer(8*Vt.length);if(Dt)Tt.set(Vt,Dt>>3);else throw Error("Out of memory.");return Dt}function c(Vt){if(!Vt)return 0;var Dt=e.$$es.allocateUint8Buffer(4*Vt.length);if(Dt)Pt.set(Vt,Dt>>2);else throw Error("Out of memory.");return Dt}function f(Vt){if(!Vt)return 0;var Dt=e.$$es.allocateUint8Buffer(Vt.length);if(Dt)A.set(Vt,Dt);else throw Error("Out of memory.");return Dt}function p(Vt){e.$$es.deallocateUint8Buffer(Vt)}function v(Vt){return function(){return H(Vt,arguments)}}function M(Vt,Dt,qe){function re(ns){return function(){return qt(),Pe&&wt.callRecord.push(ns+" "+ut(arguments)),L(this,e[Vt][ns],arguments)}}function Ai(){qt(),this.$$memory=new Uint8Array(e[Vt]["sizeof_"+Dt]()),L(this,e[Vt][Ee+"create"],arguments)}var Ee=Dt+"_";Ai.prototype={$$stackify:!0},Ai.copy=function(ns){qt();var Ss=Object.create(Ai.prototype);return Ss.$$memory=new Uint8Array(A.subarray(ns,ns+e[Vt]["sizeof_"+Dt]())),Ss},Ai.clone=function(ns){var Ss=Object.create(Ai.prototype);return Ss.$$memory=new Uint8Array(ns.$$memory),Ss},Ai.assign=function(ns,Ss){ns.$$memory.set(Ss.$$memory)};for(var Gn=0;Gn<qe.length;Gn++)Ai.prototype[qe[Gn]]=re(Ee+qe[Gn]);return wt[Dt]=Ai}function L(Vt,Dt,qe){return qe=Array.prototype.slice.call(qe),qe.unshift(Vt),H(Dt,qe)}function H(Vt,Dt){for(var qe=!1,re=0;re<Dt.length;++re)if(Dt[re].$$stackify){qe=!0;break}if(!qe)return Vt.apply(e,Dt);qe=Vd();try{var Ai=Array.prototype.slice.call(Dt);for(re=0;re<Dt.length;re++)if(Dt[re].$$stackify){var Ee=Gh(Dt[re].$$memory.length);A.set(Dt[re].$$memory,Ee),Ai[re]=Ee}var Gn=Vt.apply(e,Ai);for(re=0;re<Dt.length;re++)Dt[re].$$stackify&&Dt[re].$$memory.set(A.subarray(Ai[re],Ai[re]+Dt[re].$$memory.length))}finally{zd(qe)}return Gn}function Q(Vt){this.value=Vt}function ct(Vt){wt.suspendDrawing(Vt),e.ki("webgl_context_lost")}function ut(){return JSON.stringify(arguments,Nt)}function Nt(Vt,Dt){return Dt!==null&&typeof Dt=="object"&&Dt.$$memory?"stackified":Dt}function qt(){if(wt!==e.$$facade)throw new ReferenceError("member called after shutdown")}var et="$$cs";e.$$es.initializeLibrary();var wt=e.$$facade,Kt=e.Oj?new e.Oj:void 0;e.tj=Kt,wt.isValid=function(){return wt===e.$$facade};var Pe=!1;wt.callRecord=[],wt.startRecording=function(){Pe=!0},wt.stopRecording=function(){Pe=!1},wt.logCallRecord=function(){for(var Vt=wt.callRecord,Dt=0;Dt<Vt.length;++Dt)console.log(Vt[Dt])},wt.shutDown=function(){qt(),Pe&&wt.callRecord.push("shutDown"),et==="$$cs"&&e.canvas.removeEventListener("webglcontextlost",ct),e.$$es.shutDownLibrary(),Kt&&Kt.Xk(),e.$$legacyClient?(wt.container.innerHTML="",e.$$wrapper.innerHTML=""):(wt.containers.forEach(Vt=>{Vt.innerHTML=""}),wt.wrappers.forEach(Vt=>{Vt.innerHTML=""})),e.$$facade=void 0,e.tj=void 0,e.$$available=!0},wt.ByMeshInstance=new Q(0),wt.ByGroup=new Q(1),wt.ByExpandedGroup=new Q(2),function(){function Vt(G,tt){if(re([Jt.Scs]),!G)throw new Ee("InvalidConfig","Invalid load configuration");var ht,pt,Mt=new Promise(function(Ae,He){ht=Ae,pt=He});$n=Jt.Scs;var Zt=new XMLHttpRequest;if(Zt.open("GET",tt),Zt.responseType="arraybuffer",Zt.onload=function(){try{Dt(G,new Uint8Array(this.response)).then(function(Ae){ht(Ae)},function(Ae){pt(Ae)})}catch{}},typeof G.XHRonprogress=="function"&&(Zt.onprogress=G.XHRonprogress),typeof G.XHRonerror=="function"&&(Zt.onerror=G.XHRonerror),typeof G.XHRonloadend=="function"){var ri=G.XHRonloadend;Zt.onloadend=function(Ae){ri(Ae,Zt.status,tt)}}return Zt.send(),Mt}function Dt(G,tt){if(re([Jt.Scs]),!G)throw new Ee("InvalidConfig","Invalid load configuration");if(tt.constructor!==Uint8Array)throw new Ee("InvalidConfig","'buffer' must be a Uint8Array");if(0>=tt.byteLength)throw new Ee("EmptyBuffer","'buffer' has a length of 0");var ht=e.$$es.allocateUint8Buffer(tt.byteLength);A.set(tt,ht);try{return qe(G,ht,tt.byteLength)}catch(pt){throw e.$$es.deallocateUint8Buffer(ht),pt}}function qe(G,tt,ht){re([Jt.Scs]);var pt=G.attachScope,Mt=G.attachMeasurementUnit,Zt=G.attachInvisibly,ri=G.resolveOnFullyLoaded,Ae=G.inclusionMatrix;G=G.cancelUnitMatrix;var He=0;if(Ae){if(Ae.constructor!==Array&&Ae.constructor!==Float64Array)throw new TypeError("'inclusionMatrix' is not an Array or Float64Array.");if(Ae.length!==12)throw new TypeError("'inclusionMatrix' needs to have exactly 12 elements.");if(He=a(Ae),!He)throw Error("Internal logic error.")}$n=Jt.Scs;var ks,Ln;Ae=new Promise(function(qn,Ms){ks=qn,Ln=function(zs){try{Ai(zs),Ms(null)}catch(sr){Ms(sr)}}});try{e.$$es.attachScsBuffer(pt,tt,ht,He,Mt,Zt,ri,G,ks,Ln)}catch(qn){Ln(qn)}finally{p(He)}return Ae}function re(G){if($n!==Jt.Uninitialized){if(G!==void 0){for(var tt=0;tt<G.length;++tt)if($n===G[tt])return}throw new Ee("AlreadyCalled","load() already called with an incompatible session type")}}function Ai(G){switch(G){case e.LoadResult.WebGLMissing:throw new Ee("WebGLError","WebGL initialization failed");case e.LoadResult.SessionAlreadyStarted:throw new Ee("AlreadyCalled","load() already called")}}function Ee(G,tt){this.code=G,this.message=tt,this.stack=Error().stack}function Gn(G){var tt=JSON.parse(Y(G,0));if("rpc"in tt){if(G=tt.rpc,tt=G.length/2,tt===Math.floor(tt)){for(var ht=new Uint8Array(tt),pt=0;pt<tt;++pt)ht[pt]=parseInt(G.substr(pt+pt,2),16);G=ht,tt=new DataView(G.buffer).getUint32(0,!0),ht=G[4],G=G.subarray(5),pt=f(G),e[et].notifyRpcClientResult(tt,ht,pt,G.length)}}else if("event"in tt)switch(G=tt.event,tt=tt.data,G){case"camera_set":Yl=Va(tt),e.ki(G);break;default:Array.isArray(tt)?(tt.unshift(G),e.ki.apply(e,tt)):e.ki(G,tt)}}function ns(G){var tt=f(G);e.$$es.parseMetaData(Jl,tt,G.length)}function Ss(G){G=Y(G,0),e.ki("post_draw_json",G)}function Va(G){var tt=new Ps;return tt.reset.apply(tt,G),tt}function Xl(G){function tt(Ti,Jr,pe,Ze){if(0>Ze||Ze>=Jr.elementCount)throw new RangeError("invalid element index");var bn={vertexCount:ri[Ti][3*Ze+1],bits:ri[Ti][3*Ze+2],iterate:function(Hs){return pt(Ti,Jr,pe,Ze,this,Hs)}};return typeof Symbol<"u"&&typeof Symbol.iterator<"u"&&(bn[Symbol.iterator]=ht),bn}function ht(){return this.iterate(!0)}function pt(Ti,Jr,pe,Ze,bn,Hs){function Qo(){var Fn={position:void 0,normal:void 0,UV:void 0,RGBA:void 0};++Yr;for(var Bi=0;Bi<Io.length;++Bi)Io[Bi](Fn);return Fn}if(typeof Ze=="number")var jd=pe+ri[Ti][3*Ze],Wd=bn.vertexCount;else jd=pe,Wd=Jr.vertexCount;var lp=jd+Wd,Yr=jd,Io=[];if(He?Io.push(function(Fn){var Bi=[Mt[Us],Mt[Us+1],Mt[Us+2]];Fn.position=[He[0]*Bi[0]+He[4]*Bi[1]+He[8]*Bi[2]+He[12],He[1]*Bi[0]+He[5]*Bi[1]+He[9]*Bi[2]+He[13],He[2]*Bi[0]+He[6]*Bi[1]+He[10]*Bi[2]+He[14]]}):Io.push(function(Fn){Fn.position=[Mt[Us],Mt[Us+1],Mt[Us+2]]}),Jr.hasNormals&&Io.push(function(Fn){var Bi=Us+ks;Fn.normal=[Mt[Bi],Mt[Bi+1],Mt[Bi+2]]}),Jr.hasUVs&&Io.push(function(Fn){var Bi=Us+Ln;Fn.UV=[Mt[Bi],Mt[Bi+1]]}),Jr.hasRGBAs){var Gd=new Uint8Array(Mt.buffer);Io.push(function(Fn){var Bi=Us+qn<<2;Fn.RGBA=[Gd[Bi],Gd[Bi+1],Gd[Bi+2],Gd[Bi+3]]})}if(Zt){var Us=Zt[Yr]*Ae;Io.push(function(){Us=Zt[Yr]*Ae})}else Us=Yr*Ae,Io.push(function(){Us+=Ae});return{done:function(){return Yr>=lp},next:Hs?function(){return Yr<lp?{value:Qo(),done:!1}:{done:!0}}:function(){if(Yr<lp)return Qo()},goTo:function(Fn){0>Fn?Fn=0:Fn>=Wd&&(Fn=Wd),Yr=jd+Fn,Us=Zt?Zt[Yr]*Ae:Yr*Ae}}}var Mt=G.vertices,Zt=G.indices,ri=G.elements,Ae=G.stride,He=G.duplicateMatrix,ks=G.normalOffset,Ln=G.UVOffset,qn=G.RGBA32Offset,Ms=G.faceVertexCount,zs=Ms+G.lineVertexCount,sr={faces:{vertexCount:G.faceVertexCount,hasNormals:!!G.faceNormals,hasUVs:!!G.faceUVs,hasRGBAs:!!G.faceRGBA32s,elementCount:ri[0]?ri[0].length/3:0,iterate:function(Ti){return pt(0,this,0,void 0,void 0,Ti)},element:function(Ti){return tt(0,this,0,Ti)}},lines:{vertexCount:G.lineVertexCount,hasNormals:!!G.lineNormals,hasUVs:!!G.lineUVs,hasRGBAs:!!G.lineRGBA32s,elementCount:ri[1]?ri[1].length/3:0,iterate:function(Ti){return pt(1,this,Ms,void 0,void 0,Ti)},element:function(Ti){return tt(1,this,Ms,Ti)}},points:{vertexCount:G.pointVertexCount,hasNormals:!!G.pointNormals,hasUVs:!!G.pointUVs,hasRGBAs:!!G.pointRGBA32s,elementCount:ri[2]?ri[2].length/3:0,iterate:function(Ti){return pt(2,this,zs,void 0,void 0,Ti)},element:function(Ti){return tt(2,this,zs,Ti)}}};typeof Symbol<"u"&&typeof Symbol.iterator<"u"&&(sr.faces[Symbol.iterator]=ht,sr.lines[Symbol.iterator]=ht,sr.points[Symbol.iterator]=ht),G=G.forward;for(let Ti in G)G.hasOwnProperty(Ti)&&(sr[Ti]=G[Ti]);return sr}function Jl(G,tt,ht){var pt=Xr[G];pt||(pt=Xr[G]={}),pt[tt]=ht,e.ki("meta_data",G,tt,ht)}function un(G,tt){if(et==="$$cs")return Be.getMetaData(G);Kr(G);for(var ht=[],pt=0;pt<G.length;pt+=2){var Mt=G[pt],Zt=G[pt+1],ri=Xr[Mt];(ri?ri[Zt]:void 0)===void 0&&ht.push(Mt,Zt)}if(ht.length===0){for(tt=[],pt=0;pt<G.length;pt+=2)Mt=G[pt],Zt=G[pt+1],tt.push(Xr[Mt][Zt]);return Promise.resolve(tt)}return tt?(pt=new Ie("getMetaData",ht),Promise.reject(pt)):Be.requestMetaData(ht).then(function(){return qt(),un(G,!0)})}function Sr(){et==="$$cs"&&e.$$es.disconnectNetwork()}function D(G,tt,ht){if(typeof ht=="function")bo(G,tt,ht);else{ht=ht||0;var pt=typeof G=="string"?G+"_"+tt:tt,Mt;e.$$es[pt]?Mt=e.$$es[pt]:Mt=function(){return e[et][pt].apply(e,arguments)};var Zt=Mt;ht&1&&(Zt=function(pe){return pe==0?e.$$cs[pt].apply(e,arguments):Mt.apply(e,arguments)});var ri=Zt;ht&2&&(ri=function(pe){typeof pe=="number"&&(pe=[pe]);var Ze=c(pe);if(!Ze)throw new TypeError("`keys' is not an Array or Uint32Array");var bn=Array.prototype.slice.call(arguments,1);return bn.unshift(Ze,pe.length),Zt.apply(e,bn)});var Ae=ri;ht&4&&(Ae=function(pe){Kr(pe);var Ze=c(pe);if(!Ze)throw new TypeError("`ids' is not an Array or Uint32Array.");var bn=Array.prototype.slice.call(arguments,1);return bn.unshift(Ze,pe.length>>1),ri.apply(e,bn)});var He=Ae;ht&8&&(He=function(pe){pe.length===4&&typeof pe[0]=="number"&&(pe=[pe]);var Ze=pe,bn=e.$$es.allocateUint8Buffer(32*Ze.length);if(bn)for(var Hs=0;Hs<Ze.length;++Hs){var Qo=Ze[Hs];if(Qo.length!==4)throw Error("Planes are expected be exactly 4 numbers.");Tt.set(Qo,(bn>>3)+4*Hs)}return Ze=Array.prototype.slice.call(arguments,1),Ze.unshift(bn,pe.length),Ae.apply(e,Ze)});var ks=He;ht&16&&(ks=function(pe){pe.length===3&&typeof pe[0]=="number"&&(pe=[pe]);var Ze=pe,bn=e.$$es.allocateUint8Buffer(24*Ze.length);if(bn)for(var Hs=0;Hs<Ze.length;++Hs){var Qo=Ze[Hs];if(Qo.length!==3)throw Error("Points are expected be exactly 3 components.");Tt.set(Qo,(bn>>3)+3*Hs)}return Ze=Array.prototype.slice.call(arguments,1),Ze.unshift(bn,pe.length),He.apply(e,Ze)});var Ln=ks;ht&32&&(Ln=v(He));var qn=Ln;ht&64&&(qn=function(){return console.log("WARNING: Using deprecated function `"+(typeof G=="string"?G+"."+tt:tt)+"'"),Ln.apply(e,arguments)});var Ms=qn;ht&128&&(Ms=function(){var pe=arguments,Ze=pe[pe.length-1];return Ze.constructor===Q?pe[pe.length-1]=Ze.value:(pe=Array.prototype.slice.call(pe),pe.push(0)),qn.apply(e,pe)});var zs=Ms;ht&256&&(zs=function(){var pe=Array.prototype.slice.call(arguments);return new Promise(function(Ze,bn){pe.push(Ze),pe.push(Re(pt,bn)),Ms.apply(e,pe)})});var sr=zs;ht&512&&(sr=ht&256?function(){return zs.apply(e,arguments).then(function(pe){return qt(),Ps.copy(pe)})}:function(){return Ps.copy(zs.apply(e,arguments))});var Ti=sr;ht&1024&&(Ti=ht&256?function(){return sr.apply(e,arguments).then(Ha)}:function(){return Ha(sr.apply(e,arguments))});var Jr=Ti;ht&2048&&(Jr=ht&256?function(){return Ti.apply(e,arguments).then(za)}:function(){return za(Ti.apply(e,arguments))}),bo(G,tt,function(){return qt(),Pe&&wt.callRecord.push(tt+" "+ut(arguments)),Jr.apply(e,arguments)})}}function bo(G,tt,ht){var pt=typeof ht=="function"?function(){return qt(),Pe&&wt.callRecord.push(tt+" "+ut(arguments)),ht.apply(e,arguments)}:ht;G===null?wt[tt]=pt:typeof G=="string"?wt[G][tt]=pt:G[tt]=pt}function za(G){for(var tt=0;tt<G.length;++tt)0>G[tt][0]&&(G[tt]=null);return G}function Ha(G){for(var tt=0;tt<G.length;++tt)0>G[tt]&&(G[tt]=null);return G}function Re(G,tt){return function(ht){ht=new Ie(G,ht),tt(ht)}}function Ie(G,tt){this.scFunction=G,this.data=tt}function Kr(G){if(G.length&1)throw new TypeError("`ids.length' must be divisible by two. (An Id is a pair of keys.)")}wt.CreateImageError=e.CreateImageError,wt.CreateMeshInstanceErrorType=e.CreateMeshInstanceErrorType,wt.CuttingSectionError=e.CuttingSectionError,wt.MeshDataGetDataError=e.MeshDataGetDataError,wt.MeshDataReplaceError=e.MeshDataReplaceError,wt.SetMatrixErrorType=e.SetMatrixErrorType,wt.SetTextureErrorType=e.SetTextureErrorType;var Ps=M("$$es","Camera","reset viewMatrix projectionMatrix fullMatrix projection setProjection upVector setUpVector position setPosition target setTarget nearLimit setNearLimit fieldWidth fieldHeight setField setField setFieldByAngles setFieldByAngles dolly pan roll zoom orbit axisOrbit relativeOrbit unproject".split(" "));Ie.prototype.toString=function(){return this.scFunction+": "+this.data};var Be={},Xr={},Ud=new Uint8Array(0),Yl=new Ps;D(null,"addCuttingSection",264),D(null,"addDrawContext",function(){return new Promise(function(G,tt){e[et].addDrawContext(G,tt)}).then(function(G){return e.$$es.initializeDrawContext(G),G})}),D(null,"addLight",256),D(null,"setLightPower"),D(null,"setLightDecay"),D(null,"advanceVolumeSelection",256),D(null,"attachModels",function(G,tt,ht,pt){for(var Mt=[],Zt=[],ri=0;ri<tt.length;++ri){var Ae=tt[ri];if(Ae.length!==2)throw new TypeError("Expecting [name, matrix] pair.");var He=Ae[0];if(typeof He!="string")throw new TypeError("Name is not a string.");if(Ae=Ae[1],Ae.constructor!==Array&&Ae.constructor!==Float64Array)throw new TypeError("Matrix is not an Array or Float64Array.");if(Ae.length!==12)throw new TypeError("Inclusion matrix needs to have exactly 12 elements.");He=unescape(encodeURIComponent(He));for(var ks=0;ks<He.length;++ks)Mt.push(He.charCodeAt(ks));Mt.push(0),Array.prototype.push.apply(Zt,Ae)}var Ln=0,qn=0;if(Ln=f(Mt),!Ln||(qn=a(Zt),!qn))throw p(Ln),p(qn),Error("Internal logic error.");return new Promise(function(Ms,zs){e[et].attachModels(Ln,Mt.length,qn,Zt.length,G,ht,pt,Ms,Re("attachModels",zs))})}),D(null,"attachScsModelByKey",function(G,tt,ht,pt,Mt){var Zt=[];if(tt.constructor!==Array&&tt.constructor!==Float64Array)throw new TypeError("Matrix is not an Array or Float64Array.");if(tt.length!==12)throw new TypeError("Inclusion matrix needs to have exactly 12 elements.");if(Array.prototype.push.apply(Zt,tt),tt=a(Zt),!tt)throw p(tt),Error("Internal logic error.");return e.$$es.attachScsModelByKey(tt,Zt.length,G,ht,pt,Mt)}),D(null,"beginConvexPolyhedronSelection",264),D(null,"beginRayDrillSelection",256),D(null,"beginScreenAreaSelection",256),D(null,"beginSphereSelection",256),D(null,"clearLights"),D(null,"createFloorplanMesh",388),D(null,"cuttingSectionLimits"),D(null,"demandMeshInstances",132),D(null,"detachInclusions",258),D(null,"disableCapping"),D(null,"disconnectNetwork",Sr),D(null,"enableCapping"),D(null,"endComparison"),D(null,"endVolumeSelection"),D(null,"explode"),D(null,"exportToSvg",256),D(null,"beginExportToSvg",256),D(null,"advanceExportToSvg",256),D(null,"flushMetaDataCache",function(){et==="$$ss"&&(Xr={})}),D(null,"getAmbientOcclusionEnabled",256),D(null,"getAmbientOcclusionRadius",256),D(null,"getBackFacesVisible",256),D(null,"getBackgroundGradient",256),D(null,"getCamera",function(G){return et==="$$ss"?Ps.clone(Yl):Be.getCamera(G)}),D(null,"getCameraPromise",768),D(null,"getCappedInstances",256),D(null,"getCuttingSections",258),D(null,"getDefaultDepthRange",256),D(null,"getElementCount",256),D(null,"getEyeDomeLightingBlurEdgeDistance",256),D(null,"getEyeDomeLightingBlurInterval",256),D(null,"getEyeDomeLightingBlurSamples",256),D(null,"getEyeDomeLightingEnabled",256),D(null,"getEyeDomeLightingOpacity",256),D(null,"getEyeDomeLightingShadingEdgeDistance",256),D(null,"getFacesVisible",256),D(null,"getFaceWindingFlipped",256),D(null,"getFrontFacesVisible",256),D(null,"getInteractiveDrawLimitIncreaseEnabled",256),D(null,"getLightKeys",256),D(null,"getLight",256),D(null,"getLinesVisible",256),D(null,"getLooseBounding",256),D(null,"getMetaData",un),D(null,"getMinFrameRate",256),D(null,"getNetworkVersion"),D(null,"getPointShape",256),D(null,"getPointSize",256),D(null,"getPointSizeUnit",256),D(null,"getPointsVisible",256),D(null,"getStatistics",256),D(null,"getStreamedBounding",256),D(null,"getStreamVersion"),D(null,"getTriangleCount",256),D(null,"markAllMeshInstancesInteresting"),D(null,"markCameraAsEmpty"),D(null,"meshInstanceKeyInfo",257),D(null,"metaDataKeyInfo",257),D(null,"modelKeysFromInclusionKeys",258),D(null,"onResize",function(G){var tt=wt.allowHighDpi&&window.devicePixelRatio||1,ht=e.$$legacyClient?wt.container:wt.containers.get(G),pt=ht.clientWidth,Mt=ht.clientHeight;if(ht=pt*tt,tt*=Mt,et==="$$ss")Kt.Pk(ht,tt,pt,Mt);else{var Zt=e.$$es.maxFrameBufferSize();0>=Zt?(ht=pt,tt=Mt):((ht>Zt||tt>Zt)&&(ht=pt,tt=Mt),(ht>Zt||tt>Zt)&&(ht>tt?(tt=tt/ht*Zt,ht=Zt):(ht=ht/tt*Zt,tt=Zt)))}e.$$cs.setScreenDimensions(G,ht,tt,pt,Mt),et==="$$cs"&&(e.$$legacyClient&&(pt=e.canvas,pt.width=ht,pt.height=tt),wt.queueRedraw(G))}),D(null,"pauseCapping"),D(null,"primaryModelKey",256),D(null,"queueRedraw"),D(null,"registerBimInstances",4),D(null,"removeAllCuttingSections"),D(null,"removeCuttingSections",258),D(null,"removeDrawContext"),D(null,"removeLight"),D(null,"replaceCuttingSection",264),D(null,"requestGroups",260),D(null,"requestImages",260),D(null,"requestMeshInstances",260),D(null,"requestMeshInstancesByGroup",260),D(null,"resetExplode"),D(null,"resetToEmpty",function(G,tt){var ht=c(tt);if(!ht)throw new TypeError("`meshKeys' is not an Array or Uint32Array");return Be.resetToEmpty(G,ht,tt.length)}),D(null,"resumeCapping"),D(null,"resumeDrawing"),D(null,"screenSelectByRay",256),D(null,"serverSideRendering",function(){return et==="$$ss"}),D(null,"setAmbientLightColor"),D(null,"setAmbientOcclusionBias"),D(null,"setAmbientOcclusionBlurInterval"),D(null,"setAmbientOcclusionBlurSamples"),D(null,"setAmbientOcclusionContrast"),D(null,"setAmbientOcclusionEdgeDistance"),D(null,"setAmbientOcclusionEnabled"),D(null,"setAmbientOcclusionIntensity"),D(null,"setAmbientOcclusionNoiseSize"),D(null,"setAmbientOcclusionOpacity"),D(null,"setAmbientOcclusionRadius"),D(null,"setAmbientOcclusionSamples"),D(null,"setAntiAliasingMode"),D(null,"setBackFacesVisible"),D(null,"setBackgroundColor"),D(null,"setBackgroundGradient"),D(null,"setBloomBlurInterval"),D(null,"setBloomBlurSamples"),D(null,"setBloomEnabled"),D(null,"setBloomIntensity"),D(null,"setBloomIntensityScale"),D(null,"setBloomLayerCount"),D(null,"setBloomThreshold"),D(null,"setBloomThresholdRampWidth"),D(null,"setBoundingPreviewUnderdrawColor"),D(null,"setBoundingPreviewTestedColor"),D(null,"setBoundingPreviewEjectedColor"),D(null,"setBoundingPreviewColor"),D(null,"setBoundingPreviewUnderdraw",16),D(null,"setBoundingPreviewTested",16),D(null,"setBoundingPreviewEjected",16),D(null,"setBoundingDebugLevel"),D(null,"setCamera",function(G,tt){Ps.assign(Yl,tt),Be.setCamera(G,tt)}),D(null,"setCappingIdleHookEnabled",256),D(null,"setClumpingEnabled"),D(null,"setComparisonColors"),D(null,"setCurrentView"),D(null,"setDefaultDepthRange"),D(null,"setDefaultGloss"),D(null,"setDefaultMirror"),D(null,"setDefaultSpecularMix"),D(null,"setDefaultSphereMap"),D(null,"setDisplayIncompleteFrames"),D(null,"setDrawIdleDelay"),D(null,"setDrawMode"),D(null,"setDrawStrategy"),D(null,"setEyeDomeLightingBlurEdgeDistance"),D(null,"setEyeDomeLightingBlurInterval"),D(null,"setEyeDomeLightingBlurSamples"),D(null,"setEyeDomeLightingEnabled"),D(null,"setEyeDomeLightingOpacity"),D(null,"setEyeDomeLightingShadingEdgeDistance"),D(null,"setFacesVisible"),D(null,"setFaceWindingFlipped"),D(null,"setFixedDrawLimit"),D(null,"setFrontFacesVisible"),D(null,"setGoochBaseColorProminence"),D(null,"setGoochBlue"),D(null,"setGoochLuminanceShiftStrength"),D(null,"setGoochYellow"),D(null,"setGroundPlane"),D(null,"setGroundPlaneWithPosition"),D(null,"setHardEdgeColor"),D(null,"setHardEdgeOpacity"),D(null,"setHardEdgesEnabled"),D(null,"setHardEdgeThreshold"),D(null,"setHardEdgeThresholdRampWidth"),D(null,"setHiddenLineHiddenLineColor"),D(null,"setHiddenLineHighlightedElementFillColor"),D(null,"setHiddenLineHighlightedElementOutlineColor"),D(null,"setHiddenLineHighlightedInstanceFillColor"),D(null,"setHiddenLineHighlightedInstanceOutlineColor"),D(null,"setHiddenLineVisibleLineColor"),D(null,"setHighlightColorizeCompression"),D(null,"setHighlightedElementColor"),D(null,"setHighlightedElementFilter"),D(null,"setHighlightedElementOutlineColor"),D(null,"setHighlightedInstanceColor"),D(null,"setHighlightedInstanceFilter"),D(null,"setHighlightedInstanceOutlineColor"),D(null,"setHighlightMode"),D(null,"setImageBasedLightingEnabled"),D(null,"setImageBasedLightingEnvironment",function(G,tt){var ht=f(tt);if(!ht)throw new TypeError("`data' is not an Array or Uint8Array");return e[et].setImageBasedLightingEnvironment(G,ht,tt.length)}),D(null,"setImageBasedLightingEnvironmentToDefault"),D(null,"setImageBasedLightingIntensity"),D(null,"setImageBasedLightingMatrix"),D(null,"setInstancingEnabled"),D(null,"setInteractiveDrawLimitIncreaseEnabled"),D(null,"setInteractiveDrawLimitIncreaseInterval"),D(null,"setLightingEnabled"),D(null,"setLineJitterEnabled"),D(null,"setLineJitterFrequency"),D(null,"setLineJitterInstanceCount"),D(null,"setLineJitterRadius"),D(null,"setLinesVisible"),D(null,"setMeshLevel"),D(null,"setMetallicRoughnessMaterialOverride"),D(null,"setMinDrawLimit"),D(null,"setMinFrameRate"),D(null,"setMinIncrementalFrameRate"),D(null,"setMinInteractiveFrameRate"),D(null,"setPointShape"),D(null,"setPointSize"),D(null,"setPointsVisible"),D(null,"setPointVisibilityTest",16),D(null,"setPostInputDelay"),D(null,"setSilhouetteColor"),D(null,"setSilhouetteEnabled"),D(null,"setSilhouetteOpacity"),D(null,"setSilhouetteThreshold"),D(null,"setSilhouetteThresholdRampWidth"),D(null,"setSimpleReflectionAttenuation"),D(null,"setSimpleReflectionBlurInterval"),D(null,"setSimpleReflectionBlurSamples"),D(null,"setSimpleReflectionEnabled"),D(null,"setSimpleReflectionFadeAngle"),D(null,"setSimpleReflectionOpacity"),D(null,"setSimpleShadowBlurInterval"),D(null,"setSimpleShadowBlurSamples"),D(null,"setSimpleShadowColor"),D(null,"setSimpleShadowEnabled"),D(null,"setSimpleShadowInteractiveUpdateEnabled"),D(null,"setSimpleShadowOpacity"),D(null,"setSimpleShadowResolution"),D(null,"setSmaaQuality"),D(null,"setSsrQuality",function(G){Kt.Vk(G)}),D(null,"setStreamCutoffScale"),D(null,"setStreamIdleMarker",256),D(null,"setToonBandCount"),D(null,"setToonSpecularFactor"),D(null,"setTransparencyMode"),D(null,"setUnhighlightedColor"),D(null,"setUnhighlightedFilter"),D(null,"setVisibilityByAttachment"),D(null,"setXRayMaterial"),D(null,"setXRayOpacity"),D(null,"setXRayTransparencyMode"),D(null,"startComparison",function(G,tt,ht){Kr(tt),Kr(ht);var pt=c(tt);if(!pt)throw new TypeError("`instanceSet1' is not an Array or Uint32Array.");var Mt=c(ht);if(!Mt)throw new TypeError("`instanceSet2' is not an Array or Uint32Array.");return e[et].startComparison(G,pt,tt.length>>1,Mt,ht.length>>1)}),D(null,"startExplode",4),D(null,"suspendDrawing"),D(null,"testPointVisibility",272),D(null,"throttleLoad"),D(null,"triangulatePolygon",function(G,tt){if(3>G.length)throw new TypeError("'polygonPoints' does not describe a polygon.");var ht;if(G)if(ht=e.$$es.allocateUint8Buffer(4*G.length))X.set(G,ht>>2);else throw Error("Out of memory.");else ht=0;if(!ht)throw Error("Internal logic error.");return e.$$es.triangulatePolygon(ht,G.length,tt)}),D(null,"truncateMetaData",function(G){if(et==="$$cs")return Be.truncateMetaData(G);for(var tt=0;tt<G.length;tt+=2){var ht=G[tt+1],pt=Xr[G[tt]];pt&&(pt[ht]=Ud)}}),D(null,"unsetAllColors"),D(null,"unsetAllHighlighted"),D(null,"unsetAllOpacity"),D(null,"unsetAllXRay"),D(null,"unsetCurrentView"),D(null,"unsetXRayMaterial"),D(null,"updateLight"),D(null,"waitForImageDecoding",256),D(null,"worldSelectByRay",256),D(null,"_loseWebGlContext",function(){var G=e.Wi.getExtension("WEBGL_lose_context");return G!==null?(G.loseContext(),!0):!1}),D(Be,"getCamera",512),D(Be,"getMetaData",260),D(Be,"MeshData_getData",256),D(Be,"MeshInstance_setLinePattern",132),D(Be,"requestMetaData",260),D(Be,"resetToEmpty",258),D(Be,"setCamera",32),D(Be,"truncateMetaData",260),D(null,"Debug_log",function(G){G=unescape(encodeURIComponent(G));for(var tt=[],ht=0;ht<G.length;++ht)tt.push(G.charCodeAt(ht));tt.push(0);var pt=f(tt);if(!pt)throw Error("Internal logic error.");return new Promise(function(Mt,Zt){e[et].debug_log(pt,tt.length,Mt,Zt)})}),D(null,"Debug_stateFailure",256),D(null,"Debug_sync",256),wt.Image={},D("Image","create",function(G,tt,ht,pt,Mt,Zt,ri,Ae,He,ks){var Ln=f(tt);if(!Ln)throw Error("Internal logic error.");var qn=f(ri);return new Promise(function(Ms,zs){e[et].Image_create(Ln,tt.length,qn,ri?ri.length:0,G,ht,pt||0,Mt||0,Zt||0,Ae||!1,He||0,ks||0,Ms,Re("Image_create",zs))})}),D("Image","destroy",260),wt.Matrix={},D("Matrix","create",256),D("Matrix","destroy",260),D("Matrix","getElements",260),D("Matrix","setElements",260),wt.MeshData={},D("MeshData","create",function(G){return new Promise(function(tt,ht){var pt=G._marshal();e[et].MeshData_create(pt.bits,pt.totalFaceVertices,pt.totalLineVertices,pt.totalPointVertices,pt.floatDataPtr,pt.floatDataPtrLen,pt.faceElementInfosPtr,$e*G._faceElements.length,pt.lineElementInfosPtr,$e*G._lineElements.length,pt.pointElementInfosPtr,$e*G._pointElements.length,tt,Re("MeshData_create",ht))})}),D("MeshData","destroy",260),D("MeshData","getData",function(G){return Be.MeshData_getData(G).then(Xl)}),D("MeshData","lineElementSegments",256),D("MeshData","linesToIncidentFaces",258),D("MeshData","replace",function(G,tt){return new Promise(function(ht,pt){var Mt=tt._marshal();e[et].MeshData_replace(G[0],G[1],Mt.bits,Mt.totalFaceVertices,Mt.totalLineVertices,Mt.totalPointVertices,Mt.floatDataPtr,Mt.floatDataPtrLen,Mt.faceElementInfosPtr,$e*tt._faceElements.length,Mt.lineElementInfosPtr,$e*tt._lineElements.length,Mt.pointElementInfosPtr,$e*tt._pointElements.length,ht,Re("MeshData_replace",pt))})}),wt.MeshInstance={},D("MeshInstance","clearAllElementHighlight",132),D("MeshInstance","clearAllElementVisible",132),D("MeshInstance","clearAllElementXRay",132),D("MeshInstance","clearElementColors",132),D("MeshInstance","clearElementHighlight",132),D("MeshInstance","clearElementVisible",132),D("MeshInstance","clearElementXRay",132),D("MeshInstance","computeMinimalBodyBodyDistance",256),D("MeshInstance","computeMinimalFaceFaceDistance",256),D("MeshInstance","computeMinimalFaceLineDistance",256),D("MeshInstance","computeMinimalFaceRayDistance",256),D("MeshInstance","create",256),D("MeshInstance","destroy",388),D("MeshInstance","discardAnonymousMatrix",388),D("MeshInstance","getAlwaysDraw",388),D("MeshInstance","getCappingMeshData",388),D("MeshInstance","getColor",2436),D("MeshInstance","getCullingVector",388),D("MeshInstance","getDoNotCut",388),D("MeshInstance","getDoNotExplode",388),D("MeshInstance","getDoNotLight",388),D("MeshInstance","getDoNotOutlineHighlight",388),D("MeshInstance","getDoNotSelect",388),D("MeshInstance","getDoNotUseVertexColors",388),D("MeshInstance","getDrawnWorldSpaceBounding",260),D("MeshInstance","getEffectiveColor",388),D("MeshInstance","getEffectiveElementColor",388),D("MeshInstance","getEffectiveOpacity",388),D("MeshInstance","getElementColor",2436),D("MeshInstance","getElementHighlighted",388),D("MeshInstance","getElementVisible",388),D("MeshInstance","getElementXRay",388),D("MeshInstance","getExcludeBounding",388),D("MeshInstance","getFaceElementBounding",258),D("MeshInstance","getFacesVisible",388),D("MeshInstance","getHighlighted",388),D("MeshInstance","getLayerCount"),D("MeshInstance","getLineElementBounding",258),D("MeshInstance","getLinesVisible",388),D("MeshInstance","getMatrix",388),D("MeshInstance","getMeshData",388),D("MeshInstance","getMetallicRoughness",388),D("MeshInstance","getObjectSpaceBounding",388),D("MeshInstance","getOpacity",1412),D("MeshInstance","getOverrideSceneVisibility",388),D("MeshInstance","getPointElementBounding",258),D("MeshInstance","getPointsVisible",388),D("MeshInstance","getScreenOriented",388),D("MeshInstance","getSuppressCameraScale",388),D("MeshInstance","getWorldSpaceBounding",260),D("MeshInstance","hasDepthRange",388),D("MeshInstance","hasTransparency",388),D("MeshInstance","linesToIncidentFaces",258),D("MeshInstance","matrixPreMultiply",388),D("MeshInstance","reifyAnonymousMatrix",388),D("MeshInstance","setAlwaysDraw",132),D("MeshInstance","setAmbientMix",132),D("MeshInstance","setAnonymousMatrix",388),D("MeshInstance","setAnonymousMatrices",function(G,tt){var ht=0,pt=0;if(G.constructor!==Array&&G.constructor!==Uint32Array)throw new TypeError("Incs Buffer is not an Array or Uint32Array.");if(tt.constructor!==Array&&tt.constructor!==Float64Array)throw new TypeError("Matrices Buffer is not an Array or Float64Array.");if(ht=c(G),!ht||(pt=a(tt),!pt))throw p(ht),p(pt),Error("Internal logic error.");return new Promise(function(Mt,Zt){e[et].MeshInstance_setAnonymousMatrices(ht,G.length>>1,pt,tt.length,Mt,Re("MeshInstance_setAnonymousMatrices",Zt),0)})}),D("MeshInstance","setColor",132),D("MeshInstance","setCullingVector",132),D("MeshInstance","setDepthRange",132),D("MeshInstance","setDoNotCut",132),D("MeshInstance","setDoNotExplode",132),D("MeshInstance","setDoNotLight",132),D("MeshInstance","setDoNotOutlineHighlight",132),D("MeshInstance","setDoNotSelect",132),D("MeshInstance","setDoNotReset",132),D("MeshInstance","setDoNotUseVertexColors",132),D("MeshInstance","setDoNotXRay",132),D("MeshInstance","setElementColor",132),D("MeshInstance","setElementHighlighted",132),D("MeshInstance","setElementVisible",132),D("MeshInstance","setElementXRay",132),D("MeshInstance","setExcludeBounding",132),D("MeshInstance","setFacesVisible",132),D("MeshInstance","setHighlighted",132),D("MeshInstance","setLinePattern",function(G,tt,ht,pt){var Mt=f(tt);if(!Mt)throw new TypeError("`pattern' is not an Array or Uint8Array");return Be.MeshInstance_setLinePattern(G,Mt,tt.length,ht,pt)}),D("MeshInstance","setLinesVisible",132),D("MeshInstance","setMatrix",388),D("MeshInstance","setMeshLevel",132),D("MeshInstance","setMetallicRoughness",132),D("MeshInstance","unsetMetallicRoughness",132),D("MeshInstance","setOpacity",132),D("MeshInstance","setOverlayId",132),D("MeshInstance","setOverrideSceneVisibility",132),D("MeshInstance","setPointsVisible",132),D("MeshInstance","setScreenOriented",132),D("MeshInstance","setScreenSpace",132),D("MeshInstance","setScreenSpaceStretched",132),D("MeshInstance","setStreamCutoffScale",132),D("MeshInstance","setSuppressCameraScale",132),D("MeshInstance","setTexture",388),D("MeshInstance","setVisible",132),D("MeshInstance","setXRay",132),D("MeshInstance","synchronizeVisibilities",4),D("MeshInstance","unsetColor",132),D("MeshInstance","unsetCullingVector",132),D("MeshInstance","unsetDepthRange",132),D("MeshInstance","unsetElementColor",132),D("MeshInstance","unsetLinePattern",132),D("MeshInstance","unsetMatrix",388),D("MeshInstance","unsetOpacity",132),D("MeshInstance","unsetTexture",132),D("MeshInstance","setSpecularIntensity",132),D("MeshInstance","unsetSpecularIntensity",132),wt.Overlay={},D("Overlay","destroy"),D("Overlay","maxIndex"),D("Overlay","setCamera",32),D("Overlay","setViewport"),D("Overlay","setVisible");var $h={open_model_failed:Sr,session_started:function(){et==="$$cs"&&(e.canvas.addEventListener("webglcontextlost",ct,!1),wt.onResize(0))},post_draw_json:function(G,tt){try{var ht=JSON.parse(tt)}catch(pt){console.assert(!1,"malformed JSON from post_draw",pt);return}e.ki("post_draw",ht.draw_index,ht.stats,Va(ht.camera),ht.visiblePoints),ht.quality==="high"&&(e.ki("draw_complete"),e.ki("draw_idle"))}},Pi={session_started:function(){et==="$$ss"&&(wt.resumeDrawing(0),e[et].Debug_notifyLoggedRpcExecutionIsAllowed())}},ge={};e.ki=function(G){if(G in $h){var tt=$h[G];tt.apply(this,arguments)}var ht=ge[G];try{if(ht!==void 0)for(var pt=0;pt<ht.length;pt++)tt=ht[pt],typeof tt=="function"&&tt.apply(this,arguments)}catch(Mt){console.log("Unhandled exception in "+G+" event handler:"),console.log(Mt)}G in Pi&&(tt=Pi[G],tt.apply(this,arguments))},wt.setEventHandler=function(G,tt){ge.hasOwnProperty(G)||(ge[G]=[]),ge[G].push(tt)},wt.unsetEventHandler=function(G,tt){if(G=ge[G],G!==void 0)for(var ht=0;ht<G.length;)G[ht]===tt?G.splice(ht,1):++ht},Ee.prototype=Object.create(Error.prototype),Ee.prototype.constructor=Ee;var Jt={Uninitialized:0,Network:1,Scs:2};wt.SessionType=Jt;var $n=Jt.Uninitialized;wt.load=function(G){if(qt(),Pe&&wt.callRecord.push("load "+ut(G)),!G)throw new Ee("InvalidConfig","Invalid load configuration");var tt=G.uri;if(!!tt+!!G.buffer+!!G.empty!=1)throw new Ee("InvalidConfig","Must specify exactly one of 'uri', 'buffer', or 'empty'.");if(tt){{if(typeof tt!="string")throw new Ee("InvalidConfig","'uri' must be a string");const[ri,Ae,He]=tt.split("://");if(Ae){if(He)throw new Ee("InvalidConfig","Invalid URI");var ht=ri}else ht="http"}if(ht==="ws"||ht==="wss"){if(re(),!G)throw new Ee("InvalidConfig","Invalid load configuration");if(G.model&&typeof G.model=="string"||(G.model=""),ht=G.sessionToken,ht===void 0&&(ht=""),typeof ht!="string")throw new Ee("InvalidConfig","'sessionToken' must be a string");var pt=G.limitMiB;if(pt===void 0&&(pt=0),typeof pt!="number")throw new Ee("InvalidConfig","'limitMiB' must be a number");var Mt=G.meshLevel;if(Mt===void 0&&(Mt=0),typeof Mt!="number")throw new Ee("InvalidConfig","'meshLevel' must be a number");var Zt=G.streamCutoffScale;if(Zt===void 0&&(Zt=-1),typeof Zt!="number")throw new Ee("InvalidConfig","'streamCutoffScale' must be a number");if($n!==Jt.Uninitialized)throw new Ee("AlreadyCalled","load() already called for a non-streaming session");$n=Jt.Network,G.serverSideRendering?(et="$$ss",e.$$legacyClient?Kt.gj(e.$$wrapper):Kt.gj(wt.wrappers.get(0)),wt.onResize(0),Kt.Tk(Gn),Kt.Uk(ns),Kt.Sk(Ss),Kt.Rk(e.ki),Kt.connect(G)):(et="$$cs",Ai(e.$$es.loadNetwork(tt,unescape(encodeURIComponent(G.model)),unescape(encodeURIComponent(ht)),!!G.streamCulled,!!G.streamMetaDataOnIdle,!!G.streamNoLimit,!!G.streamInstancesOnDemand,!!G.streamAggressiveCompression,!!G.streamModelBoundingPreviews,!!G.streamInstanceBoundingPreviews,!!G.streamOnlyInterestingBoundingPreviews,!!G.streamEjectedBoundingPreviews,pt,Mt,Zt)))}else ht!=="http"&&ht!=="https"||Vt(G,tt)}else G.buffer?Dt(G,G.buffer):(G=!!G.streamInstancesOnDemand,re([Jt.Scs]),$n=Jt.Scs,G=e.$$es.loadEmptyScs(G),Ai(G));return $n},wt.attachScsBuffer=function(G,tt,ht,pt,Mt,Zt,ri){return G={attachScope:G,inclusionMatrix:ht,attachMeasurementUnit:pt,attachInvisibly:Mt,resolveOnFullyLoaded:Zt,cancelUnitMatrix:ri},tt===null||tt.length===0?qe(G,0,0):Dt(G,tt)},wt.feedScsBuffer=function(G,tt){if(re([Jt.Scs]),G===0)throw new Ee("InvalidConfig","'attachScope' should not be 0");var ht=0,pt=0;if(tt!==null){if(tt.constructor!==Uint8Array)throw new Ee("InvalidConfig","'buffer' must be a Uint8Array");if(0>=tt.byteLength)throw new Ee("EmptyBuffer","'buffer' has a length of 0");ht=tt.byteLength,pt=e.$$es.allocateUint8Buffer(tt.byteLength),A.set(tt,pt)}e.$$es.feedScsBuffer(G,pt,ht)}}();var $e=3,Fi=4*$e;wt.MeshDataBuilder=function(){this._faceElements=[],this._lineElements=[],this._pointElements=[],this.formatBits=0},wt.MeshDataBuilder.FormatBits={ClockwiseWinding:1,CounterClockwiseWinding:2,TwoSided:4,Manifold:65536},wt.MeshDataBuilder.prototype={constructor:wt.MeshDataBuilder,_getOptional:function(Vt,Dt){return Vt===void 0?null:Vt[Dt]?Vt[Dt]:null},_optionalGuard:function(Vt,Dt,qe){if(qe){if((qe=this[qe][0])&&!qe[Vt])throw Error("Cannot define "+Dt+" for some but not all vertices.")}else this._optionalGuard(Vt,Dt,"_faceElements"),this._optionalGuard(Vt,Dt,"_lineElements"),this._optionalGuard(Vt,Dt,"_pointElements")},addFace:function(Vt,Dt){var qe=this._faceElements,re=this._getOptional(Dt,"normals"),Ai=this._getOptional(Dt,"uvs"),Ee=this._getOptional(Dt,"rgba32s");if(Dt=this._getOptional(Dt,"bits")||0,Vt.length%9!==0)throw Error("Illegal triangles: 'vertexData.length' must be divisible by 9 (i.e. 3 numbers per vertex and 3 vertices per triangle).");if(re){if(re.length!==Vt.length)throw Error("Cannot define normals for some but not all vertices.");this._optionalGuard("normals","normals","_faceElements")}if(Ai){if(3*Ai.length!==2*Vt.length)throw Error("Cannot define UV parameters for some but not all vertices.");this._optionalGuard("uvs","UV parameters","_faceElements")}if(Ee){if(3*Ee.length!==4*Vt.length)throw Error("Cannot define RGBA32s for some but not all vertices.");if(this._optionalGuard("rgba32s","RGBA32s"),!(this.formatBits&32768)){for(var Gn=3;Gn<Ee.length;Gn+=4)if(Ee[Gn]!=255){this.formatBits|=32768;break}}}qe.push({vertexData:Vt,normals:re,uvs:Ai,rgba32s:Ee,bits:Dt})},addPolyline:function(Vt,Dt){var qe=this._lineElements,re=this._getOptional(Dt,"rgba32s");if(Dt=this._getOptional(Dt,"bits")||0,Vt.length%3!==0)throw Error("vertexData array must be divisible by 3 (i.e. 3 numbers per vertex).");if(6>Vt.length&&0<Vt.length)throw Error("Illegal polyline: '0 < vertexData.length < 6'.");if(re){if(3*re.length!==4*Vt.length)throw Error("Cannot define RGBA32s for some but not all vertices.");this._optionalGuard("rgba32s","RGBA32s")}qe.push({vertexData:Vt,rgba32s:re,bits:Dt})},addPoints:function(Vt,Dt){var qe=this._pointElements,re=this._getOptional(Dt,"rgba32s");if(Dt=this._getOptional(Dt,"bits")||0,Vt.length%3!==0)throw Error("vertexData array must be divisible by 3 (i.e. 3 numbers per vertex).");if(re){if(3*re.length!==4*Vt.length)throw Error("Cannot define RGBA32s for some but not all vertices.");this._optionalGuard("rgba32s","RGBA32s")}qe.push({vertexData:Vt,rgba32s:re,bits:Dt})},_marshal:function(){var Vt=this._faceElements,Dt=this._lineElements,qe=this._pointElements,re=!1,Ai=!1,Ee=!1,Gn=!1,ns=!1,Ss=!1,Va=!1,Xl=!1,Jl=!1,un=Vt[0],Sr=Dt[0],D=qe[0];un&&(re=!!un.normals,Ai=!!un.uvs,Ee=!!un.rgba32s),Sr&&(Gn=!!Sr.normals,ns=!!Sr.uvs,Ss=!!Sr.rgba32s),D&&(Va=!!D.normals,Xl=!!D.uvs,Jl=!!D.rgba32s);var bo=3;un=this.formatBits,(Sr=re||Gn||Va)&&(bo+=3,un|=4096,re&&(un|=8),Gn&&(un|=64),Va&&(un|=512)),(D=Ai||ns||Xl)&&(bo+=2,un|=8192,Ai&&(un|=16),ns&&(un|=128),Xl&&(un|=1024));var za=Ee||Ss||Jl;za&&(bo+=1,un|=16384,Ee&&(un|=32),Ss&&(un|=256),Jl&&(un|=2048));for(var Ha=0,Re=0;Re<Vt.length;++Re){var Ie=Vt[Re];Ha+=Ie.vertexData.length}Ha/=3;var Kr=0,Ps=0;for(Re=0;Re<Dt.length;++Re){Ie=Dt[Re];var Be=Ie.vertexData;Be.length&&(Kr+=Be.length,++Ps)}for(Kr=2*(Kr/3-Ps),Re=Ps=0;Re<qe.length;++Re)Ie=qe[Re],Ps+=Ie.vertexData.length;Ps/=3,bo*=Ha+Kr+Ps,Re=e.$$es.allocateUint8Buffer;var Xr=Re(4*bo),Ud=Vt.length?Re(Fi*Vt.length):0,Yl=Dt.length?Re(Fi*Dt.length):0,$h=qe.length?Re(Fi*qe.length):0,Pi=A.subarray(Xr),ge=X.subarray(Xr>>2),Jt=0,$n=0;for(Re=0;Re<Vt.length;++Re){Ie=Vt[Re],Be=Ie.vertexData;var G=Ie.normals,tt=Ie.uvs,ht=Ie.rgba32s,pt=Be.length/3,Mt=Pt.subarray((Ud>>2)+$e*Re);Mt[0]=$n,Mt[1]=pt,Mt[2]=Ie.bits,$n+=pt;var Zt=0;for(pt=Ie=0;pt<Be.length;pt+=3)ge[Jt]=Be[pt],ge[Jt+1]=Be[pt+1],ge[Jt+2]=Be[pt+2],Jt+=3,Sr&&(re?(ge[Jt]=G[pt],ge[Jt+1]=G[pt+1],ge[Jt+2]=G[pt+2]):(ge[Jt]=0,ge[Jt+1]=0,ge[Jt+2]=0),Jt+=3),D&&(Ai?(ge[Jt]=tt[Zt],ge[Jt+1]=tt[Zt+1],Zt+=2):(ge[Jt]=0,ge[Jt+1]=0),Jt+=2),za&&(Mt=Jt<<2,Ee?(Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++]):(Pi[Mt++]=0,Pi[Mt++]=0,Pi[Mt++]=0,Pi[Mt++]=0),++Jt)}for(Re=$n=0;Re<Dt.length;++Re)for(Ie=Dt[Re],Be=Ie.vertexData,G=Ie.normals,tt=Ie.uvs,ht=Ie.rgba32s,pt=Be.length/3,0<pt&&(pt=2*pt-2),Mt=Pt.subarray((Yl>>2)+$e*Re),Mt[0]=$n,Mt[1]=pt,Mt[2]=Ie.bits,$n+=pt,Ie=4,pt=3;pt<Be.length;pt+=3)for(Ie-=4,Vt=-3;0>=Vt;Vt+=3)re=pt+Vt,ge[Jt]=Be[re],ge[Jt+1]=Be[re+1],ge[Jt+2]=Be[re+2],Jt+=3,Sr&&(Gn?(ge[Jt]=G[re],ge[Jt+1]=G[re+1],ge[Jt+2]=G[re+2]):(ge[Jt]=0,ge[Jt+1]=0,ge[Jt+2]=0),Jt+=3),D&&(ns?(re=re/3*2,ge[Jt]=tt[re],ge[Jt+1]=tt[re+1]):(ge[Jt]=0,ge[Jt+1]=0),Jt+=2),za&&(Mt=Jt<<2,Ss?(Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++]):(Pi[Mt++]=0,Pi[Mt++]=0,Pi[Mt++]=0,Pi[Mt++]=0),++Jt);for(Re=$n=0;Re<qe.length;++Re)for(Ie=qe[Re],Be=Ie.vertexData,G=Ie.normals,tt=Ie.uvs,ht=Ie.rgba32s,pt=Be.length/3,Mt=Pt.subarray(($h>>2)+$e*Re),Mt[0]=$n,Mt[1]=pt,Mt[2]=Ie.bits,$n+=pt,pt=Ie=Zt=0;pt<Be.length;pt+=3)ge[Jt]=Be[pt],ge[Jt+1]=Be[pt+1],ge[Jt+2]=Be[pt+2],Jt+=3,Sr&&(Va?(ge[Jt]=G[pt],ge[Jt+1]=G[pt+1],ge[Jt+2]=G[pt+2]):(ge[Jt]=0,ge[Jt+1]=0,ge[Jt+2]=0),Jt+=3),D&&(Xl?(ge[Jt]=tt[Zt],ge[Jt+1]=tt[Zt+1],Zt+=2):(ge[Jt]=0,ge[Jt+1]=0),Jt+=2),za&&(Mt=Jt<<2,Jl?(Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++],Pi[Mt++]=ht[Ie++]):(Pi[Mt++]=0,Pi[Mt++]=0,Pi[Mt++]=0,Pi[Mt++]=0),++Jt);return{totalFaceVertices:Ha,totalLineVertices:Kr,totalPointVertices:Ps,faceElementInfosPtr:Ud,lineElementInfosPtr:Yl,pointElementInfosPtr:$h,floatDataPtr:Xr,floatDataPtrLen:bo,bits:un}}}},e.Oj=function(){var a={Tj:null,aj:null,connection:null,jj:null,mj:null,fj:null,ej:null,dj:1280,cj:800,lj:1280,kj:800,Vi:1,hk:{command:"SERVER_SETTINGS"},gj:function(f){this.Tj=f,c.gj()},Xk:function(){this.ak=!0,delete this.jj,delete this.mj,delete this.fj,delete this.ej,this.connection&&this.connection.close()},pk:function(f){a.aj!==f&&(a.aj&&(a.aj.style.display="none"),a.aj=f,a.aj.style.display="")},connected:function(){return a.connection&&a.connection.readyState===WebSocket.OPEN},Ij:function(){a.connected()&&a.connection.send(JSON.stringify({command:"SERVER_SIDE_CLIENT_INFO",width:a.dj*a.Vi,height:a.cj*a.Vi,layoutWidth:a.lj,layoutHeight:a.kj,encoding:"jpeg"}))},Pk:function(f,p,v,M){0>=f||0>=p||0>=v||0>=M||a.dj===f&&a.cj===p&&a.lj===v&&a.kj===M||(a.dj=f,a.cj=p,a.lj=v,a.kj=M,a.connected()&&(a.Hj!==void 0&&window.clearTimeout(a.Hj),a.Hj=setTimeout(function(){a.ak||(a.Hj=void 0,a.Ij())},500)))},Ok:function(f){a.connected()&&a.connection.send(f)},Tk:function(f){a.jj=f},Uk:function(f){a.mj=f},Sk:function(f){a.fj=f},Rk:function(f){a.ej=f},Jk:function(f){a.fj&&a.fj(f)},Vk:function(f){var p={command:"SERVER_SETTINGS"},v;for(v in f)if(f.hasOwnProperty(v)){if(v==="scaleHigh"){var M=f[v];if(typeof M!="number")continue;M=Math.min(1,M),0>=M&&(M=1),a.Vi!==M&&(a.Vi=M,a.Ij())}v!=="jpegQualityHigh"&&v!=="jpegQualityLow"&&v!=="jpegChromaSamplesHigh"&&v!=="jpegChromaSamplesLow"&&v!=="scaleLow"||typeof f[v]!="number"||(p[v]=a.hk[v]=f[v])}a.connected()&&a.connection.send(JSON.stringify(p))},connect:function(f){var p=e.$$es.getNetworkVersion();a.connection=new WebSocket(f.uri,["binary"]),a.connection.binaryType="arraybuffer";var v=!1;a.connection.onclose=function(){e.ki("websocket_connection_closed")},a.connection.onopen=function(){v=!0,a.connection.send(JSON.stringify({command:"SERVER_SIDE_RENDER",width:a.dj*a.Vi,height:a.cj*a.Vi,layoutWidth:a.lj,layoutHeight:a.kj,model:f.model,networkVersion:p,streamCulled:!!f.streamCulled,streamKeyedDataOnIdle:!!f.streamMetaDataOnIdle,streamNoLimit:!!f.streamNoLimit,streamInstancesOnDemand:!!f.streamInstancesOnDemand,streamBoundingPreviews:!!f.streamBoundingPreviews,streamModelBoundingPreviews:!!f.streamModelBoundingPreviews,streamInstanceBoundingPreviews:!!f.streamInstanceBoundingPreviews,streamOnlyInterestingBoundingPreviews:!!f.streamOnlyInterestingBoundingPreviews,streamEjectedBoundingPreviews:!!f.streamEjectedBoundingPreviews,limitMiB:f.limitMiB,meshLevel:f.meshLevel,streamCutoffScale:f.streamCutoffScale,sessionToken:f.sessionToken})),a.Ij(),a.connection.send(JSON.stringify(a.hk))},a.connection.onerror=function(){a.ej&&a.ej(v?"socket_error":"socket_open_failed")},a.connection.onmessage=function(M){if(!a.ak&&M.data instanceof ArrayBuffer){var L=new Uint8Array(M.data);if(M=L[0],M===123)a.jj&&a.jj(L);else if(M===68)a.mj&&a.mj(L.subarray(1));else{a.connection.send('{"command":"ACK"}');var H=[L[1],L[2]],Q=L[4]<<24|L[5]<<16|L[6]<<8|L[7],ct=new Uint8Array(L.subarray(8,8+Q));L=L.subarray(8+Q),M===0&&c.zk(L,H,ct)}}}}},c={canvas:null,Rj:null,gj:function(){},createElement:function(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.setAttribute("style","display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;"),this.Rj=this.canvas.getContext("2d"),a.Tj.appendChild(this.canvas))},drawImage:function(f,p){var v=f.width-p[0];p=f.height-p[1],this.canvas.width!==v&&(this.canvas.width=v),this.canvas.height!==p&&(this.canvas.height=p),this.Rj.drawImage(f,0,0)},sk:function(f,p,v){var M=document.createElement("img");return this.Hk=M,M.onload=function(){M===c.Hk&&(c.drawImage(M,p),a.pk(c.canvas),a.Jk(v)),URL.revokeObjectURL(f)},M.onerror=function(){URL.revokeObjectURL(f)},M.src=f,M},zk:function(f,p,v){12>=f.byteLength||(this.createElement(),this.sk(URL.createObjectURL(new Blob([f],{type:"image/jpeg"})),p,v))}};return a};var r=Object.assign({},e),o="./this.program",l=(a,c)=>{throw c},h=typeof window=="object",u=typeof importScripts=="function",d=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string",g="",y,m,I;if(d){g=u?require("path").dirname(g)+"/":__dirname+"/";var b,x;typeof require=="function"&&(b=require("fs"),x=require("path")),y=(a,c)=>(a=x.normalize(a),b.readFileSync(a,c?void 0:"utf8")),I=a=>(a=y(a,!0),a.buffer||(a=new Uint8Array(a)),a),m=(a,c,f)=>{a=x.normalize(a),b.readFile(a,function(p,v){p?f(p):c(v.buffer)})},1<process.argv.length&&(o=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),process.on("uncaughtException",function(a){if(!(a instanceof St))throw a}),process.on("unhandledRejection",function(a){throw a}),l=(a,c)=>{if(O)throw process.exitCode=a,c;c instanceof St||P("exiting due to exception: "+c),process.exit(a)},e.inspect=function(){return"[Emscripten Module object]"}}else(h||u)&&(u?g=self.location.href:typeof document<"u"&&document.currentScript&&(g=document.currentScript.src),s&&(g=s),g.indexOf("blob:")!==0?g=g.substr(0,g.replace(/[?#].*/,"").lastIndexOf("/")+1):g="",y=a=>{var c=new XMLHttpRequest;return c.open("GET",a,!1),c.send(null),c.responseText},u&&(I=a=>{var c=new XMLHttpRequest;return c.open("GET",a,!1),c.responseType="arraybuffer",c.send(null),new Uint8Array(c.response)}),m=(a,c,f)=>{var p=new XMLHttpRequest;p.open("GET",a,!0),p.responseType="arraybuffer",p.onload=()=>{p.status==200||p.status==0&&p.response?c(p.response):f()},p.onerror=f,p.send(null)});var C=e.print||console.log.bind(console),P=e.printErr||console.warn.bind(console);Object.assign(e,r),r=null,e.thisProgram&&(o=e.thisProgram),e.quit&&(l=e.quit);var k;e.wasmBinary&&(k=e.wasmBinary);var O=e.noExitRuntime||!0;typeof WebAssembly!="object"&&Le("no native wasm support detected");var B,j=!1,V=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function Y(a,c,f){var p=c+f;for(f=c;a[f]&&!(f>=p);)++f;if(16<f-c&&a.buffer&&V)return V.decode(a.subarray(c,f));for(p="";c<f;){var v=a[c++];if(v&128){var M=a[c++]&63;if((v&224)==192)p+=String.fromCharCode((v&31)<<6|M);else{var L=a[c++]&63;v=(v&240)==224?(v&15)<<12|M<<6|L:(v&7)<<18|M<<12|L<<6|a[c++]&63,65536>v?p+=String.fromCharCode(v):(v-=65536,p+=String.fromCharCode(55296|v>>10,56320|v&1023))}}else p+=String.fromCharCode(v)}return p}function q(a,c){return a?Y(A,a,c):""}function st(a,c,f,p){if(!(0<p))return 0;var v=f;p=f+p-1;for(var M=0;M<a.length;++M){var L=a.charCodeAt(M);if(55296<=L&&57343>=L){var H=a.charCodeAt(++M);L=65536+((L&1023)<<10)|H&1023}if(127>=L){if(f>=p)break;c[f++]=L}else{if(2047>=L){if(f+1>=p)break;c[f++]=192|L>>6}else{if(65535>=L){if(f+2>=p)break;c[f++]=224|L>>12}else{if(f+3>=p)break;c[f++]=240|L>>18,c[f++]=128|L>>12&63}c[f++]=128|L>>6&63}c[f++]=128|L&63}}return c[f]=0,f-v}function ft(a){for(var c=0,f=0;f<a.length;++f){var p=a.charCodeAt(f);127>=p?c++:2047>=p?c+=2:55296<=p&&57343>=p?(c+=4,++f):c+=3}return c}var U,J,A,R,bt,z,Pt,X,Tt;function lt(){var a=B.buffer;U=a,e.HEAP8=J=new Int8Array(a),e.HEAP16=R=new Int16Array(a),e.HEAP32=z=new Int32Array(a),e.HEAPU8=A=new Uint8Array(a),e.HEAPU16=bt=new Uint16Array(a),e.HEAPU32=Pt=new Uint32Array(a),e.HEAPF32=X=new Float32Array(a),e.HEAPF64=Tt=new Float64Array(a)}var at,Gt=[],kt=[],Ft=[],ni=[];function ji(){var a=e.preRun.shift();Gt.unshift(a)}var oe=0,Se=null;function We(){oe++,e.monitorRunDependencies&&e.monitorRunDependencies(oe)}function Ve(){if(oe--,e.monitorRunDependencies&&e.monitorRunDependencies(oe),oe==0&&Se){var a=Se;Se=null,a()}}function Le(a){throw e.onAbort&&e.onAbort(a),a="Aborted("+a+")",P(a),j=!0,a=new WebAssembly.RuntimeError(a+". Build with -sASSERTIONS for more info."),n(a),a}function yn(){return T.startsWith("data:application/octet-stream;base64,")}var T;if(e.locateFile){if(T="engine.esm.wasm",!yn()){var yt=T;T=e.locateFile?e.locateFile(yt,g):g+yt}}else T=void 0;function gt(){var a=T;try{if(a==T&&k)return new Uint8Array(k);if(I)return I(a);throw"both async and sync fetching of the wasm failed"}catch(c){Le(c)}}function $(){if(!k&&(h||u)){if(typeof fetch=="function"&&!T.startsWith("file://"))return fetch(T,{credentials:"same-origin"}).then(function(a){if(!a.ok)throw"failed to load wasm binary file at '"+T+"'";return a.arrayBuffer()}).catch(function(){return gt()});if(m)return new Promise(function(a,c){m(T,function(f){a(new Uint8Array(f))},c)})}return Promise.resolve().then(function(){return gt()})}var W,nt,It={731184:()=>{console.log("RPC parsing failed")},731223:(a,c,f)=>{e.$$facade&&(e.$$legacyClient?(Tt[a>>3]=e.$$facade.container.clientWidth,Tt[c>>3]=e.$$facade.container.clientHeight):(Tt[a>>3]=e.$$facade.containers.get(f).clientWidth,Tt[c>>3]=e.$$facade.containers.get(f).clientHeight))},731574:()=>{try{var a=window.bowser;return a&&a.windows&&(a.webkit||a.blink||a.gecko)?1:0}catch{return 1}},731747:()=>{try{var a=window.bowser;if(!(a&&a.windows&&(a.chrome&&0<=a.compareVersions([a.version,"55"])&&0>a.compareVersions([a.version,"57"])||a.firefox&&0<=a.compareVersions([a.version,"51"])&&0>a.compareVersions([a.version,"58"]))))return 0}catch{return 0}try{var c=e.Wi,f=c.getExtension("WEBGL_debug_renderer_info");if(f){var p=c.getParameter(f.UNMASKED_RENDERER_WEBGL);if(!(p&&0<=p.indexOf("ANGLE")&&(0<=p.indexOf("AMD")||0<=p.indexOf("Radeon"))&&0<=p.indexOf("Direct3D11")))return 0}}catch{}return 1}};function St(a){this.name="ExitStatus",this.message="Program terminated with exit("+a+")",this.status=a}function ot(a){for(;0<a.length;)a.shift()(e)}var xt=[],Lt=[],Ot=(a,c)=>{for(var f=0,p=a.length-1;0<=p;p--){var v=a[p];v==="."?a.splice(p,1):v===".."?(a.splice(p,1),f++):f&&(a.splice(p,1),f--)}if(c)for(;f;f--)a.unshift("..");return a},Ut=a=>{var c=a.charAt(0)==="/",f=a.substr(-1)==="/";return(a=Ot(a.split("/").filter(p=>!!p),!c).join("/"))||c||(a="."),a&&f&&(a+="/"),(c?"/":"")+a},Ge=a=>{var c=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(a).slice(1);return a=c[0],c=c[1],!a&&!c?".":(c&&(c=c.substr(0,c.length-1)),a+c)},we=a=>{if(a==="/")return"/";a=Ut(a),a=a.replace(/\/$/,"");var c=a.lastIndexOf("/");return c===-1?a:a.substr(c+1)};function hn(){if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function"){var a=new Uint8Array(1);return()=>(crypto.getRandomValues(a),a[0])}if(d)try{var c=require("crypto");return()=>c.randomBytes(1)[0]}catch{}return()=>Le("randomDevice")}function Rn(){for(var a="",c=!1,f=arguments.length-1;-1<=f&&!c;f--){if(c=0<=f?arguments[f]:"/",typeof c!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!c)return"";a=c+"/"+a,c=c.charAt(0)==="/"}return a=Ot(a.split("/").filter(p=>!!p),!c).join("/"),(c?"/":"")+a||"."}function Qi(a,c){var f=Array(ft(a)+1);return a=st(a,f,0,f.length),c&&(f.length=a),f}var ds=[];function ui(a,c){ds[a]={input:[],output:[],Ui:c},Hl(a,Qs)}var Qs={open:function(a){var c=ds[a.node.rdev];if(!c)throw new Bt(43);a.tty=c,a.seekable=!1},close:function(a){a.tty.Ui.fsync(a.tty)},fsync:function(a){a.tty.Ui.fsync(a.tty)},read:function(a,c,f,p){if(!a.tty||!a.tty.Ui.$j)throw new Bt(60);for(var v=0,M=0;M<p;M++){try{var L=a.tty.Ui.$j(a.tty)}catch{throw new Bt(29)}if(L===void 0&&v===0)throw new Bt(6);if(L==null)break;v++,c[f+M]=L}return v&&(a.node.timestamp=Date.now()),v},write:function(a,c,f,p){if(!a.tty||!a.tty.Ui.Ej)throw new Bt(60);try{for(var v=0;v<p;v++)a.tty.Ui.Ej(a.tty,c[f+v])}catch{throw new Bt(29)}return p&&(a.node.timestamp=Date.now()),v}},tr={$j:function(a){if(!a.input.length){var c=null;if(d){var f=Buffer.alloc(256),p=0;try{p=b.readSync(process.stdin.fd,f,0,256,-1)}catch(v){if(v.toString().includes("EOF"))p=0;else throw v}0<p?c=f.slice(0,p).toString("utf-8"):c=null}else typeof window<"u"&&typeof window.prompt=="function"?(c=window.prompt("Input: "),c!==null&&(c+=`
`)):typeof readline=="function"&&(c=readline(),c!==null&&(c+=`
`));if(!c)return null;a.input=Qi(c,!0)}return a.input.shift()},Ej:function(a,c){c===null||c===10?(C(Y(a.output,0)),a.output=[]):c!=0&&a.output.push(c)},fsync:function(a){a.output&&0<a.output.length&&(C(Y(a.output,0)),a.output=[])}},Un={Ej:function(a,c){c===null||c===10?(P(Y(a.output,0)),a.output=[]):c!=0&&a.output.push(c)},fsync:function(a){a.output&&0<a.output.length&&(P(Y(a.output,0)),a.output=[])}},te={yi:null,Di:function(){return te.createNode(null,"/",16895,0)},createNode:function(a,c,f,p){if((f&61440)===24576||(f&61440)===4096)throw new Bt(63);return te.yi||(te.yi={dir:{node:{Hi:te.hi.Hi,ui:te.hi.ui,lookup:te.hi.lookup,nj:te.hi.nj,rename:te.hi.rename,unlink:te.hi.unlink,rmdir:te.hi.rmdir,readdir:te.hi.readdir,symlink:te.hi.symlink},stream:{Li:te.ii.Li}},file:{node:{Hi:te.hi.Hi,ui:te.hi.ui},stream:{Li:te.ii.Li,read:te.ii.read,write:te.ii.write,Pj:te.ii.Pj,Dj:te.ii.Dj,ek:te.ii.ek}},link:{node:{Hi:te.hi.Hi,ui:te.hi.ui,readlink:te.hi.readlink},stream:{}},Sj:{node:{Hi:te.hi.Hi,ui:te.hi.ui},stream:Fg}}),f=vd(a,c,f,p),(f.mode&61440)===16384?(f.hi=te.yi.dir.node,f.ii=te.yi.dir.stream,f.gi={}):(f.mode&61440)===32768?(f.hi=te.yi.file.node,f.ii=te.yi.file.stream,f.mi=0,f.gi=null):(f.mode&61440)===40960?(f.hi=te.yi.link.node,f.ii=te.yi.link.stream):(f.mode&61440)===8192&&(f.hi=te.yi.Sj.node,f.ii=te.yi.Sj.stream),f.timestamp=Date.now(),a&&(a.gi[c]=f,a.timestamp=f.timestamp),f},ll:function(a){return a.gi?a.gi.subarray?a.gi.subarray(0,a.mi):new Uint8Array(a.gi):new Uint8Array(0)},Xj:function(a,c){var f=a.gi?a.gi.length:0;f>=c||(c=Math.max(c,f*(1048576>f?2:1.125)>>>0),f!=0&&(c=Math.max(c,256)),f=a.gi,a.gi=new Uint8Array(c),0<a.mi&&a.gi.set(f.subarray(0,a.mi),0))},Nk:function(a,c){if(a.mi!=c)if(c==0)a.gi=null,a.mi=0;else{var f=a.gi;a.gi=new Uint8Array(c),f&&a.gi.set(f.subarray(0,Math.min(c,a.mi))),a.mi=c}},hi:{Hi:function(a){var c={};return c.dev=(a.mode&61440)===8192?a.id:1,c.ino=a.id,c.mode=a.mode,c.nlink=1,c.uid=0,c.gid=0,c.rdev=a.rdev,(a.mode&61440)===16384?c.size=4096:(a.mode&61440)===32768?c.size=a.mi:(a.mode&61440)===40960?c.size=a.link.length:c.size=0,c.atime=new Date(a.timestamp),c.mtime=new Date(a.timestamp),c.ctime=new Date(a.timestamp),c.qk=4096,c.blocks=Math.ceil(c.size/c.qk),c},ui:function(a,c){c.mode!==void 0&&(a.mode=c.mode),c.timestamp!==void 0&&(a.timestamp=c.timestamp),c.size!==void 0&&te.Nk(a,c.size)},lookup:function(){throw zl[44]},nj:function(a,c,f,p){return te.createNode(a,c,f,p)},rename:function(a,c,f){if((a.mode&61440)===16384){try{var p=Go(c,f)}catch{}if(p)for(var v in p.gi)throw new Bt(55)}delete a.parent.gi[a.name],a.parent.timestamp=Date.now(),a.name=f,c.gi[f]=a,c.timestamp=a.parent.timestamp,a.parent=c},unlink:function(a,c){delete a.gi[c],a.timestamp=Date.now()},rmdir:function(a,c){var f=Go(a,c),p;for(p in f.gi)throw new Bt(55);delete a.gi[c],a.timestamp=Date.now()},readdir:function(a){var c=[".",".."],f;for(f in a.gi)a.gi.hasOwnProperty(f)&&c.push(f);return c},symlink:function(a,c,f){return a=te.createNode(a,c,41471,0),a.link=f,a},readlink:function(a){if((a.mode&61440)!==40960)throw new Bt(28);return a.link}},ii:{read:function(a,c,f,p,v){var M=a.node.gi;if(v>=a.node.mi)return 0;if(a=Math.min(a.node.mi-v,p),8<a&&M.subarray)c.set(M.subarray(v,v+a),f);else for(p=0;p<a;p++)c[f+p]=M[v+p];return a},write:function(a,c,f,p,v,M){if(c.buffer===J.buffer&&(M=!1),!p)return 0;if(a=a.node,a.timestamp=Date.now(),c.subarray&&(!a.gi||a.gi.subarray)){if(M)return a.gi=c.subarray(f,f+p),a.mi=p;if(a.mi===0&&v===0)return a.gi=c.slice(f,f+p),a.mi=p;if(v+p<=a.mi)return a.gi.set(c.subarray(f,f+p),v),p}if(te.Xj(a,v+p),a.gi.subarray&&c.subarray)a.gi.set(c.subarray(f,f+p),v);else for(M=0;M<p;M++)a.gi[v+M]=c[f+M];return a.mi=Math.max(a.mi,v+p),p},Li:function(a,c,f){if(f===1?c+=a.position:f===2&&(a.node.mode&61440)===32768&&(c+=a.node.mi),0>c)throw new Bt(28);return c},Pj:function(a,c,f){te.Xj(a.node,c+f),a.node.mi=Math.max(a.node.mi,c+f)},Dj:function(a,c,f,p,v){if((a.node.mode&61440)!==32768)throw new Bt(43);if(a=a.node.gi,v&2||a.buffer!==U){if((0<f||f+c<a.length)&&(a.subarray?a=a.subarray(f,f+c):a=Array.prototype.slice.call(a,f,f+c)),f=!0,Le(),c=void 0,!c)throw new Bt(48);J.set(a,c)}else f=!1,c=a.byteOffset;return{li:c,dl:f}},ek:function(a,c,f,p){return te.ii.write(a,c,0,p,f,!1),0}}};function jn(a,c,f){var p="al "+a;m(a,v=>{v||Le('Loading data file "'+a+'" failed (no arrayBuffer).'),c(new Uint8Array(v)),p&&Ve()},()=>{if(f)f();else throw'Loading data file "'+a+'" failed.'}),p&&We()}var Wn=null,vs={},tn=[],Oi=1,es=null,yo=!0,Bt=null,zl={},er=(a,c={})=>{if(a=Rn("/",a),!a)return{path:"",node:null};if(c=Object.assign({Zj:!0,Fj:0},c),8<c.Fj)throw new Bt(32);a=Ot(a.split("/").filter(L=>!!L),!1);for(var f=Wn,p="/",v=0;v<a.length;v++){var M=v===a.length-1;if(M&&c.parent)break;if(f=Go(f,a[v]),p=Ut(p+"/"+a[v]),f.Xi&&(!M||M&&c.Zj)&&(f=f.Xi.root),!M||c.wj){for(M=0;(f.mode&61440)===40960;)if(f=Z(p),p=Rn(Ge(p),f),f=er(p,{Fj:c.Fj+1}).node,40<M++)throw new Bt(32)}}return{path:p,node:f}},pi=a=>{for(var c;;){if(a===a.parent)return a=a.Di.dk,c?a[a.length-1]!=="/"?a+"/"+c:a+c:a;c=c?a.name+"/"+c:a.name,a=a.parent}},kh=(a,c)=>{for(var f=0,p=0;p<c.length;p++)f=(f<<5)-f+c.charCodeAt(p)|0;return(a+f>>>0)%es.length},Go=(a,c)=>{var f;if(f=(f=Na(a,"x"))?f:a.hi.lookup?0:2)throw new Bt(f,a);for(f=es[kh(a.id,c)];f;f=f.Ti){var p=f.name;if(f.parent.id===a.id&&p===c)return f}return a.hi.lookup(a,c)},vd=(a,c,f,p)=>(a=new Hw(a,c,f,p),c=kh(a.parent.id,a.name),a.Ti=es[c],es[c]=a),Rg={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},bd=a=>{var c=["r","w","rw"][a&3];return a&512&&(c+="w"),c},Na=(a,c)=>{if(yo)return 0;if(!c.includes("r")||a.mode&292){if(c.includes("w")&&!(a.mode&146)||c.includes("x")&&!(a.mode&73))return 2}else return 2;return 0},Id=(a,c)=>{try{return Go(a,c),20}catch{}return Na(a,"wx")},Lg=(a=0)=>{for(;4096>=a;a++)if(!tn[a])return a;throw new Bt(33)},Mh=(a,c)=>(ee||(ee=function(){this.ti={}},ee.prototype={},Object.defineProperties(ee.prototype,{object:{get:function(){return this.node},set:function(f){this.node=f}},flags:{get:function(){return this.ti.flags},set:function(f){this.ti.flags=f}},position:{get:function(){return this.ti.position},set:function(f){this.ti.position=f}}})),a=Object.assign(new ee,a),c=Lg(c),a.fd=c,tn[c]=a),Fg={open:a=>{a.ii=vs[a.node.rdev].ii,a.ii.open&&a.ii.open(a)},Li:()=>{throw new Bt(70)}},Hl=(a,c)=>{vs[a]={ii:c}},Eh=(a,c)=>{var f=c==="/",p=!c;if(f&&Wn)throw new Bt(10);if(!f&&!p){var v=er(c,{Zj:!1});if(c=v.path,v=v.node,v.Xi)throw new Bt(10);if((v.mode&61440)!==16384)throw new Bt(54)}c={type:a,rl:{},dk:c,Ik:[]},a=a.Di(c),a.Di=c,c.root=a,f?Wn=a:v&&(v.Xi=c,v.Di&&v.Di.Ik.push(c))},w=(a,c,f)=>{var p=er(a,{parent:!0}).node;if(a=we(a),!a||a==="."||a==="..")throw new Bt(28);var v=Id(p,a);if(v)throw new Bt(v);if(!p.hi.nj)throw new Bt(63);return p.hi.nj(p,a,c,f)},S=(a,c,f)=>(typeof f>"u"&&(f=c,c=438),w(a,c|8192,f)),E=(a,c)=>{if(!Rn(a))throw new Bt(44);var f=er(c,{parent:!0}).node;if(!f)throw new Bt(44);c=we(c);var p=Id(f,c);if(p)throw new Bt(p);if(!f.hi.symlink)throw new Bt(63);f.hi.symlink(f,c,a)},F=a=>{var c=er(a,{parent:!0}).node;if(!c)throw new Bt(44);var f=we(a);a=Go(c,f);t:{try{var p=Go(c,f)}catch(M){p=M.Gi;break t}var v=Na(c,"wx");p=v||((p.mode&61440)===16384?31:0)}if(p)throw new Bt(p);if(!c.hi.unlink)throw new Bt(63);if(a.Xi)throw new Bt(10);if(c.hi.unlink(c,f),c=kh(a.parent.id,a.name),es[c]===a)es[c]=a.Ti;else for(c=es[c];c;){if(c.Ti===a){c.Ti=a.Ti;break}c=c.Ti}},Z=a=>{if(a=er(a).node,!a)throw new Bt(44);if(!a.hi.readlink)throw new Bt(28);return Rn(pi(a.parent),a.hi.readlink(a))},it=(a,c)=>{if(a=typeof a=="string"?er(a,{wj:!0}).node:a,!a.hi.ui)throw new Bt(63);a.hi.ui(a,{mode:c&4095|a.mode&-4096,timestamp:Date.now()})},mt=(a,c,f)=>{if(a==="")throw new Bt(44);if(typeof c=="string"){var p=Rg[c];if(typeof p>"u")throw Error("Unknown file open mode: "+c);c=p}if(f=c&64?(typeof f>"u"?438:f)&4095|32768:0,typeof a=="object")var v=a;else{a=Ut(a);try{v=er(a,{wj:!(c&131072)}).node}catch{}}if(p=!1,c&64)if(v){if(c&128)throw new Bt(20)}else v=w(a,f,0),p=!0;if(!v)throw new Bt(44);if((v.mode&61440)===8192&&(c&=-513),c&65536&&(v.mode&61440)!==16384)throw new Bt(54);if(!p&&(f=v?(v.mode&61440)===40960?32:(v.mode&61440)===16384&&(bd(c)!=="r"||c&512)?31:Na(v,bd(c)):44))throw new Bt(f);if(c&512&&!p){if(f=v,f=typeof f=="string"?er(f,{wj:!0}).node:f,!f.hi.ui)throw new Bt(63);if((f.mode&61440)===16384)throw new Bt(31);if((f.mode&61440)!==32768)throw new Bt(28);if(p=Na(f,"w"))throw new Bt(p);f.hi.ui(f,{size:0,timestamp:Date.now()})}return c&=-131713,v=Mh({node:v,path:pi(v),flags:c,seekable:!0,position:0,ii:v.ii,bl:[],error:!1}),v.ii.open&&v.ii.open(v),!e.logReadFiles||c&1||(ce||(ce={}),a in ce||(ce[a]=1)),v},Et=a=>{if(a.fd===null)throw new Bt(8);a.xj&&(a.xj=null);try{a.ii.close&&a.ii.close(a)}catch(c){throw c}finally{tn[a.fd]=null}a.fd=null},Ht=(a,c,f)=>{if(a.fd===null)throw new Bt(8);if(!a.seekable||!a.ii.Li)throw new Bt(70);if(f!=0&&f!=1&&f!=2)throw new Bt(28);a.position=a.ii.Li(a,c,f),a.bl=[]},ve=(a,c,f,p,v,M)=>{if(0>p||0>v)throw new Bt(28);if(a.fd===null)throw new Bt(8);if(!(a.flags&2097155))throw new Bt(8);if((a.node.mode&61440)===16384)throw new Bt(31);if(!a.ii.write)throw new Bt(28);a.seekable&&a.flags&1024&&Ht(a,0,2);var L=typeof v<"u";if(!L)v=a.position;else if(!a.seekable)throw new Bt(70);return c=a.ii.write(a,c,f,p,v,M),L||(a.position+=c),c},oi=()=>{Bt||(Bt=function(a,c){this.node=c,this.Qk=function(f){this.Gi=f},this.Qk(a),this.message="FS error"},Bt.prototype=Error(),Bt.prototype.constructor=Bt,[44].forEach(a=>{zl[a]=new Bt(a),zl[a].stack="<generic error, no stack>"}))},en,Si=(a,c)=>{var f=0;return a&&(f|=365),c&&(f|=146),f},Ri=(a,c)=>{for(a=typeof a=="string"?a:pi(a),c=c.split("/").reverse();c.length;){var f=c.pop();if(f){var p=Ut(a+"/"+f);try{w(p,16895,0)}catch{}a=p}}return p},qi=(a,c,f,p)=>(a=Ut((typeof a=="string"?a:pi(a))+"/"+c),f=Si(f,p),w(a,(f!==void 0?f:438)&4095|32768,0)),bs=(a,c,f,p,v,M)=>{var L=c;if(a&&(a=typeof a=="string"?a:pi(a),L=c?Ut(a+"/"+c):a),a=Si(p,v),L=w(L,(a!==void 0?a:438)&4095|32768,0),f){if(typeof f=="string"){for(c=Array(f.length),p=0,v=f.length;p<v;++p)c[p]=f.charCodeAt(p);f=c}it(L,a|146),c=mt(L,577),ve(c,f,0,f.length,0,M),Et(c),it(L,a)}return L},Mn=(a,c,f,p)=>{a=Ut((typeof a=="string"?a:pi(a))+"/"+c),c=Si(!!f,!!p),Mn.ck||(Mn.ck=64);var v=Mn.ck++<<8|0;return Hl(v,{open:M=>{M.seekable=!1},close:()=>{p&&p.buffer&&p.buffer.length&&p(10)},read:(M,L,H,Q)=>{for(var ct=0,ut=0;ut<Q;ut++){try{var Nt=f()}catch{throw new Bt(29)}if(Nt===void 0&&ct===0)throw new Bt(6);if(Nt==null)break;ct++,L[H+ut]=Nt}return ct&&(M.node.timestamp=Date.now()),ct},write:(M,L,H,Q)=>{for(var ct=0;ct<Q;ct++)try{p(L[H+ct])}catch{throw new Bt(29)}return Q&&(M.node.timestamp=Date.now()),ct}}),S(a,c,v)},$o=a=>{if(!(a.Ek||a.Fk||a.link||a.gi)){if(typeof XMLHttpRequest<"u")throw Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(y)try{a.gi=Qi(y(a.url),!0),a.mi=a.gi.length}catch{throw new Bt(29)}else throw Error("Cannot load without read() or XMLHttpRequest.")}},is=(a,c,f,p,v)=>{function M(){this.Bj=!1,this.ti=[]}if(M.prototype.get=function(ut){if(!(ut>this.length-1||0>ut)){var Nt=ut%this.chunkSize;return this.Si(ut/this.chunkSize|0)[Nt]}},M.prototype.yk=function(ut){this.Si=ut},M.prototype.Qj=function(){var ut=new XMLHttpRequest;if(ut.open("HEAD",f,!1),ut.send(null),!(200<=ut.status&&300>ut.status||ut.status===304))throw Error("Couldn't load "+f+". Status: "+ut.status);var Nt=Number(ut.getResponseHeader("Content-length")),qt,et=(qt=ut.getResponseHeader("Accept-Ranges"))&&qt==="bytes";ut=(qt=ut.getResponseHeader("Content-Encoding"))&&qt==="gzip";var wt=1048576;et||(wt=Nt);var Kt=this;Kt.yk(Pe=>{var $e=Pe*wt,Fi=(Pe+1)*wt-1;if(Fi=Math.min(Fi,Nt-1),typeof Kt.ti[Pe]>"u"){var Vt=Kt.ti;if($e>Fi)throw Error("invalid range ("+$e+", "+Fi+") or no bytes requested!");if(Fi>Nt-1)throw Error("only "+Nt+" bytes available! programmer error!");var Dt=new XMLHttpRequest;if(Dt.open("GET",f,!1),Nt!==wt&&Dt.setRequestHeader("Range","bytes="+$e+"-"+Fi),Dt.responseType="arraybuffer",Dt.overrideMimeType&&Dt.overrideMimeType("text/plain; charset=x-user-defined"),Dt.send(null),!(200<=Dt.status&&300>Dt.status||Dt.status===304))throw Error("Couldn't load "+f+". Status: "+Dt.status);$e=Dt.response!==void 0?new Uint8Array(Dt.response||[]):Qi(Dt.responseText||"",!0),Vt[Pe]=$e}if(typeof Kt.ti[Pe]>"u")throw Error("doXHR failed!");return Kt.ti[Pe]}),(ut||!Nt)&&(wt=Nt=1,wt=Nt=this.Si(0).length,C("LazyFiles on gzip forces download of the whole file when length is accessed")),this.nk=Nt,this.mk=wt,this.Bj=!0},typeof XMLHttpRequest<"u"){if(!u)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var L=new M;Object.defineProperties(L,{length:{get:function(){return this.Bj||this.Qj(),this.nk}},chunkSize:{get:function(){return this.Bj||this.Qj(),this.mk}}});var H=void 0}else H=f,L=void 0;var Q=qi(a,c,p,v);L?Q.gi=L:H&&(Q.gi=null,Q.url=H),Object.defineProperties(Q,{mi:{get:function(){return this.gi.length}}});var ct={};return Object.keys(Q.ii).forEach(ut=>{var Nt=Q.ii[ut];ct[ut]=function(){return $o(Q),Nt.apply(null,arguments)}}),ct.read=(ut,Nt,qt,et,wt)=>{if($o(Q),ut=ut.node.gi,wt>=ut.length)Nt=0;else{if(et=Math.min(ut.length-wt,et),ut.slice)for(var Kt=0;Kt<et;Kt++)Nt[qt+Kt]=ut[wt+Kt];else for(Kt=0;Kt<et;Kt++)Nt[qt+Kt]=ut.get(wt+Kt);Nt=et}return Nt},ct.Dj=()=>{throw $o(Q),Le(),new Bt(48)},Q.ii=ct,Q},Ur=(a,c,f,p,v,M,L,H,Q,ct)=>{function ut(qt){function et(wt){ct&&ct(),H||bs(a,c,wt,p,v,Q),M&&M(),Ve()}DC(qt,Nt,et,()=>{L&&L(),Ve()})||et(qt)}var Nt=c?Rn(Ut(a+"/"+c)):a;We(),typeof f=="string"?jn(f,qt=>ut(qt),L):ut(f)},nn={},ee,ce,de=void 0;function Oe(){return de+=4,z[de-4>>2]}function ai(a){if(a=tn[a],!a)throw new Bt(8);return a}var Li={};function Ei(a){for(;a.length;){var c=a.pop();a.pop()(c)}}function Ke(a){return this.fromWireType(z[a>>2])}var bi={},Ye={},dt={};function Rt(a){if(a===void 0)return"_unknown";a=a.replace(/[^a-zA-Z0-9_]/g,"$");var c=a.charCodeAt(0);return 48<=c&&57>=c?"_"+a:a}function $t(a,c){return a=Rt(a),new Function("body","return function "+a+`() {
    "use strict";    return body.apply(this, arguments);
};
`)(c)}function fe(a){var c=Error,f=$t(a,function(p){this.name=a,this.message=p,p=Error(p).stack,p!==void 0&&(this.stack=this.toString()+`
`+p.replace(/^Error(:[^\n]*)?\n/,""))});return f.prototype=Object.create(c.prototype),f.prototype.constructor=f,f.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},f}var si=void 0;function di(a){throw new si(a)}function Ii(a,c,f){function p(H){H=f(H),H.length!==a.length&&di("Mismatched type converter count");for(var Q=0;Q<a.length;++Q)jr(a[Q],H[Q])}a.forEach(function(H){dt[H]=c});var v=Array(c.length),M=[],L=0;c.forEach((H,Q)=>{Ye.hasOwnProperty(H)?v[Q]=Ye[H]:(M.push(H),bi.hasOwnProperty(H)||(bi[H]=[]),bi[H].push(()=>{v[Q]=Ye[H],++L,L===M.length&&p(v)}))}),M.length===0&&p(v)}var ir={};function Da(a){switch(a){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+a)}}var xd=void 0;function wn(a){for(var c="";A[a];)c+=xd[A[a++]];return c}var Ul=void 0;function ze(a){throw new Ul(a)}function jr(a,c,f={}){if(!("argPackAdvance"in c))throw new TypeError("registerType registeredInstance requires argPackAdvance");var p=c.name;if(a||ze('type "'+p+'" must have a positive integer typeid pointer'),Ye.hasOwnProperty(a)){if(f.Bk)return;ze("Cannot register type '"+p+"' twice")}Ye[a]=c,delete dt[a],bi.hasOwnProperty(a)&&(c=bi[a],delete bi[a],c.forEach(v=>v()))}function Bg(a){ze(a.fi.ni.ji.name+" instance already deleted")}var Vg=!1;function ow(){}function aw(a){--a.count.value,a.count.value===0&&(a.ri?a.wi.vi(a.ri):a.ni.ji.vi(a.li))}function lw(a,c,f){return c===f?a:f.xi===void 0?null:(a=lw(a,c,f.xi),a===null?null:f.tk(a))}var cw={},Ah=[];function zg(){for(;Ah.length;){var a=Ah.pop();a.fi.Ri=!1,a.delete()}}var Th=void 0,Nh={};function lC(a,c){for(c===void 0&&ze("ptr should not be undefined");a.xi;)c=a.$i(c),a=a.xi;return Nh[c]}function Cd(a,c){return c.ni&&c.li||di("makeClassHandle requires ptr and ptrType"),!!c.wi!=!!c.ri&&di("Both smartPtrType and smartPtr must be specified"),c.count={value:1},Dh(Object.create(a,{fi:{value:c}}))}function Dh(a){return typeof FinalizationRegistry>"u"?(Dh=c=>c,a):(Vg=new FinalizationRegistry(c=>{aw(c.fi)}),Dh=c=>{var f=c.fi;return f.ri&&Vg.register(c,{fi:f},c),c},ow=c=>{Vg.unregister(c)},Dh(a))}function qo(){}function hw(a,c,f){if(a[c].Ei===void 0){var p=a[c];a[c]=function(){return a[c].Ei.hasOwnProperty(arguments.length)||ze("Function '"+f+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+a[c].Ei+")!"),a[c].Ei[arguments.length].apply(this,arguments)},a[c].Ei=[],a[c].Ei[p.uj]=p}}function uw(a,c){e.hasOwnProperty(a)?(ze("Cannot register public name '"+a+"' twice"),hw(e,a,a),e.hasOwnProperty(void 0)&&ze("Cannot register multiple overloads of a function with the same number of arguments (undefined)!"),e[a].Ei[void 0]=c):e[a]=c}function cC(a,c,f,p,v,M,L,H){this.name=a,this.constructor=c,this.Ki=f,this.vi=p,this.xi=v,this.wk=M,this.$i=L,this.tk=H}function Sd(a,c,f){for(;c!==f;)c.$i||ze("Expected null or instance of "+f.name+", got an instance of "+c.name),a=c.$i(a),c=c.xi;return a}function hC(a,c){return c===null?(this.Aj&&ze("null is not a valid "+this.name),0):(c.fi||ze('Cannot pass "'+jg(c)+'" as a '+this.name),c.fi.li||ze("Cannot pass deleted object as a pointer of type "+this.name),Sd(c.fi.li,c.fi.ni.ji,this.ji))}function uC(a,c){if(c===null){if(this.Aj&&ze("null is not a valid "+this.name),this.ij){var f=this.Zi();return a!==null&&a.push(this.vi,f),f}return 0}if(c.fi||ze('Cannot pass "'+jg(c)+'" as a '+this.name),c.fi.li||ze("Cannot pass deleted object as a pointer of type "+this.name),!this.hj&&c.fi.ni.hj&&ze("Cannot convert argument of type "+(c.fi.wi?c.fi.wi.name:c.fi.ni.name)+" to parameter type "+this.name),f=Sd(c.fi.li,c.fi.ni.ji,this.ji),this.ij)switch(c.fi.ri===void 0&&ze("Passing raw pointer to smart pointer is illegal"),this.Wk){case 0:c.fi.wi===this?f=c.fi.ri:ze("Cannot convert argument of type "+(c.fi.wi?c.fi.wi.name:c.fi.ni.name)+" to parameter type "+this.name);break;case 1:f=c.fi.ri;break;case 2:if(c.fi.wi===this)f=c.fi.ri;else{var p=c.clone();f=this.Mk(f,Is(function(){p.delete()})),a!==null&&a.push(this.vi,f)}break;default:ze("Unsupporting sharing policy")}return f}function dC(a,c){return c===null?(this.Aj&&ze("null is not a valid "+this.name),0):(c.fi||ze('Cannot pass "'+jg(c)+'" as a '+this.name),c.fi.li||ze("Cannot pass deleted object as a pointer of type "+this.name),c.fi.ni.hj&&ze("Cannot convert argument of type "+c.fi.ni.name+" to parameter type "+this.name),Sd(c.fi.li,c.fi.ni.ji,this.ji))}function Wr(a,c,f,p,v,M,L,H,Q,ct,ut){this.name=a,this.ji=c,this.Aj=f,this.hj=p,this.ij=v,this.Kk=M,this.Wk=L,this.gk=H,this.Zi=Q,this.Mk=ct,this.vi=ut,v||c.xi!==void 0?this.toWireType=uC:(this.toWireType=p?hC:dC,this.si=null)}function fC(a,c){e.hasOwnProperty(a)||di("Replacing nonexistant public symbol"),e[a]=c,e[a].uj=void 0}function gC(a,c){var f=[];return function(){if(f.length=0,Object.assign(f,arguments),a.includes("j")){var p=e["dynCall_"+a];p=f&&f.length?p.apply(null,[c].concat(f)):p.call(null,c)}else p=at.get(c).apply(null,f);return p}}function vn(a,c){a=wn(a);var f=a.includes("j")?gC(a,c):at.get(c);return typeof f!="function"&&ze("unknown function pointer with signature "+a+": "+c),f}var dw=void 0;function fw(a){a=Ww(a);var c=wn(a);return qr(a),c}function Oh(a,c){function f(M){v[M]||Ye[M]||(dt[M]?dt[M].forEach(f):(p.push(M),v[M]=!0))}var p=[],v={};throw c.forEach(f),new dw(a+": "+p.map(fw).join([", "]))}function gw(a){var c=Function;if(!(c instanceof Function))throw new TypeError("new_ called with constructor type "+typeof c+" which is not a function");var f=$t(c.name||"unknownFunctionName",function(){});return f.prototype=c.prototype,f=new f,a=c.apply(f,a),a instanceof Object?a:f}function pw(a,c,f,p){var v=c.length;2>v&&ze("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var M=c[1]!==null&&!1,L=!1,H=1;H<c.length;++H)if(c[H]!==null&&c[H].si===void 0){L=!0;break}var Q=c[0].name!=="void",ct="",ut="";for(H=0;H<v-2;++H)ct+=(H!==0?", ":"")+"arg"+H,ut+=(H!==0?", ":"")+"arg"+H+"Wired";a="return function "+Rt(a)+"("+ct+`) {
if (arguments.length !== `+(v-2)+`) {
throwBindingError('function `+a+" called with ' + arguments.length + ' arguments, expected "+(v-2)+` args!');
}
`,L&&(a+=`var destructors = [];
`);var Nt=L?"destructors":"null";for(ct="throwBindingError invoker fn runDestructors retType classParam".split(" "),f=[ze,f,p,Ei,c[0],c[1]],M&&(a+="var thisWired = classParam.toWireType("+Nt+`, this);
`),H=0;H<v-2;++H)a+="var arg"+H+"Wired = argType"+H+".toWireType("+Nt+", arg"+H+"); // "+c[H+2].name+`
`,ct.push("argType"+H),f.push(c[H+2]);if(M&&(ut="thisWired"+(0<ut.length?", ":"")+ut),a+=(Q?"var rv = ":"")+"invoker(fn"+(0<ut.length?", ":"")+ut+`);
`,L)a+=`runDestructors(destructors);
`;else for(H=M?1:2;H<c.length;++H)v=H===1?"thisWired":"arg"+(H-2)+"Wired",c[H].si!==null&&(a+=v+"_dtor("+v+"); // "+c[H].name+`
`,ct.push(v+"_dtor"),f.push(c[H].si));return Q&&(a+=`var ret = retType.fromWireType(rv);
return ret;
`),ct.push(a+`}
`),gw(ct).apply(null,f)}function mw(a,c){for(var f=[],p=0;p<a;p++)f.push(Pt[c+4*p>>2]);return f}function _w(a,c,f){return a instanceof Object||ze(f+' with invalid "this": '+a),a instanceof c.ji.constructor||ze(f+' incompatible with "this" of type '+a.constructor.name),a.fi.li||ze("cannot call emscripten binding method "+f+" on deleted object"),Sd(a.fi.li,a.fi.ni.ji,c.ji)}var Hg=[],vr=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Ug(a){4<a&&--vr[a].Gj===0&&(vr[a]=void 0,Hg.push(a))}var br=a=>(a||ze("Cannot use deleted val. handle = "+a),vr[a].value),Is=a=>{switch(a){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var c=Hg.length?Hg.pop():vr.length;return vr[c]={Gj:1,value:a},c}};function pC(a,c,f){switch(c){case 0:return function(p){return this.fromWireType((f?J:A)[p])};case 1:return function(p){return this.fromWireType((f?R:bt)[p>>1])};case 2:return function(p){return this.fromWireType((f?z:Pt)[p>>2])};default:throw new TypeError("Unknown integer type: "+a)}}function Rh(a,c){var f=Ye[a];return f===void 0&&ze(c+" has unknown type "+fw(a)),f}function jg(a){if(a===null)return"null";var c=typeof a;return c==="object"||c==="array"||c==="function"?a.toString():""+a}function mC(a,c){switch(c){case 2:return function(f){return this.fromWireType(X[f>>2])};case 3:return function(f){return this.fromWireType(Tt[f>>3])};default:throw new TypeError("Unknown float type: "+a)}}function _C(a,c,f){switch(c){case 0:return f?function(p){return J[p]}:function(p){return A[p]};case 1:return f?function(p){return R[p>>1]}:function(p){return bt[p>>1]};case 2:return f?function(p){return z[p>>2]}:function(p){return Pt[p>>2]};default:throw new TypeError("Unknown integer type: "+a)}}var yw=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function yC(a,c){for(var f=a>>1,p=f+c/2;!(f>=p)&&bt[f];)++f;if(f<<=1,32<f-a&&yw)return yw.decode(A.subarray(a,f));for(f="",p=0;!(p>=c/2);++p){var v=R[a+2*p>>1];if(v==0)break;f+=String.fromCharCode(v)}return f}function wC(a,c,f){if(f===void 0&&(f=2147483647),2>f)return 0;f-=2;var p=c;f=f<2*a.length?f/2:a.length;for(var v=0;v<f;++v)R[c>>1]=a.charCodeAt(v),c+=2;return R[c>>1]=0,c-p}function vC(a){return 2*a.length}function bC(a,c){for(var f=0,p="";!(f>=c/4);){var v=z[a+4*f>>2];if(v==0)break;++f,65536<=v?(v-=65536,p+=String.fromCharCode(55296|v>>10,56320|v&1023)):p+=String.fromCharCode(v)}return p}function IC(a,c,f){if(f===void 0&&(f=2147483647),4>f)return 0;var p=c;f=p+f-4;for(var v=0;v<a.length;++v){var M=a.charCodeAt(v);if(55296<=M&&57343>=M){var L=a.charCodeAt(++v);M=65536+((M&1023)<<10)|L&1023}if(z[c>>2]=M,c+=4,c+4>f)break}return z[c>>2]=0,c-p}function xC(a){for(var c=0,f=0;f<a.length;++f){var p=a.charCodeAt(f);55296<=p&&57343>=p&&++f,c+=4}return c}function ww(a,c){for(var f=Array(a),p=0;p<a;++p)f[p]=Rh(Pt[c+4*p>>2],"parameter "+p);return f}var CC={};function Pd(a){var c=CC[a];return c===void 0?wn(a):c}var Wg=[];function vw(){return typeof globalThis=="object"?globalThis:Function("return this")()}function SC(a){var c=Wg.length;return Wg.push(a),c}var bw=[];function PC(a){for(var c="",f=0;f<a;++f)c+=(f!==0?", ":"")+"arg"+f;var p="return function emval_allocator_"+a+`(constructor, argTypes, args) {
  var HEAPU32 = getMemory();
`;for(f=0;f<a;++f)p+="var argType"+f+" = requireRegisteredType(HEAPU32[((argTypes)>>2)], 'parameter "+f+`');
var arg`+f+" = argType"+f+`.readValueFromPointer(args);
args += argType`+f+`['argPackAdvance'];
argTypes += 4;
`;return new Function("requireRegisteredType","Module","valueToHandle","getMemory",p+("var obj = new constructor("+c+`);
return valueToHandle(obj);
}
`))(Rh,e,Is,()=>Pt)}var Iw={},Gg=[];function kC(a,c){if(Ed=a,Ad=c,Lh){if(a==0)Oa=function(){var p=Math.max(0,kw+c-kd())|0;setTimeout(Fh,p)};else if(a==1)Oa=function(){Xg(Fh)};else if(a==2){if(typeof setImmediate>"u"){var f=[];addEventListener("message",p=>{(p.data==="setimmediate"||p.data.target==="setimmediate")&&(p.stopPropagation(),f.shift()())},!0),setImmediate=function(p){f.push(p),u?(e.setImmediates===void 0&&(e.setImmediates=[]),e.setImmediates.push(p),postMessage({target:"setimmediate"})):postMessage("setimmediate","*")}}Oa=function(){setImmediate(Fh)}}}}var kd;kd=d?()=>{var a=process.hrtime();return 1e3*a[0]+a[1]/1e6}:()=>performance.now();function xw(a){O||(e.onExit&&e.onExit(a),j=!0),l(a,new St(a))}function Cw(a){a instanceof St||a=="unwind"||l(1,a)}function MC(a){!Lh||Le("emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),Lh=a;var c=jl;Fh=function(){if(!j)if(0<Pw.length){var f=Date.now(),p=Pw.shift();p.kl(p.el);var v;C('main loop blocker "'+p.name+'" took '+(Date.now()-f)+" ms"),e.setStatus&&(f=e.statusMessage||"Please wait...",p=TC,v=AC.jl,p?p<v?e.setStatus(f+" ("+(v-p)+"/"+v+")"):e.setStatus(f):e.setStatus("")),c<jl||setTimeout(Fh,0)}else c<jl||(qg=qg+1|0,Ed==1&&1<Ad&&qg%Ad!=0?Oa():(Ed==0&&(kw=kd()),j||e.preMainLoop&&e.preMainLoop()===!1||($g(a),e.postMainLoop&&e.postMainLoop()),c<jl||(typeof SDL=="object"&&SDL.audio&&SDL.audio.Lk&&SDL.audio.Lk(),Oa())))}}function $g(a){if(!j)try{a()}catch(c){Cw(c)}}function Sw(a,c){setTimeout(function(){$g(a)},c)}function EC(a){Md||(Md={}),Md[a]||(Md[a]=1,d&&(a="warning: "+a),P(a))}var Md,Oa=null,jl=0,Lh=null,Ed=0,Ad=0,qg=0,Pw=[],AC={},kw,Fh,TC,Wl=!1,Mw=!1,NC=[];function Kg(){function a(){Mw=document.pointerLockElement===e.canvas||document.mozPointerLockElement===e.canvas||document.webkitPointerLockElement===e.canvas||document.msPointerLockElement===e.canvas}if(e.preloadPlugins||(e.preloadPlugins=[]),!Aw){Aw=!0;try{$l=!0}catch{$l=!1,P("warning: no blob constructor, cannot create blobs with mimetypes")}Zg=typeof MozBlobBuilder<"u"?MozBlobBuilder:typeof WebKitBlobBuilder<"u"?WebKitBlobBuilder:$l?null:P("warning: no BlobBuilder"),Ko=typeof window<"u"?window.URL?window.URL:window.webkitURL:void 0,e.fk||typeof Ko<"u"||(P("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),e.fk=!0),e.preloadPlugins.push({canHandle:function(f){return!e.fk&&/\.(jpg|jpeg|png|bmp)$/i.test(f)},handle:function(f,p,v,M){var L=null;if($l)try{L=new Blob([f],{type:Jg(p)}),L.size!==f.length&&(L=new Blob([new Uint8Array(f).buffer],{type:Jg(p)}))}catch(ct){EC("Blob constructor present but fails: "+ct+"; falling back to blob builder")}L||(L=new Zg,L.append(new Uint8Array(f).buffer),L=L.getBlob());var H=Ko.createObjectURL(L),Q=new Image;Q.onload=()=>{Q.complete||Le("Image "+p+" could not be decoded");var ct=document.createElement("canvas");ct.width=Q.width,ct.height=Q.height,ct.getContext("2d").drawImage(Q,0,0),Ko.revokeObjectURL(H),v&&v(f)},Q.onerror=()=>{C("Image "+H+" could not be decoded"),M&&M()},Q.src=H}}),e.preloadPlugins.push({canHandle:function(f){return!e.ql&&f.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(f,p,v,M){function L(){Q||(Q=!0,v&&v(f))}function H(){Q||(Q=!0,new Audio,M&&M())}var Q=!1;if($l){try{var ct=new Blob([f],{type:Jg(p)})}catch{return H()}ct=Ko.createObjectURL(ct);var ut=new Audio;ut.addEventListener("canplaythrough",()=>L(),!1),ut.onerror=function(){if(!Q){P("warning: browser could not fully decode audio "+p+", trying slower base64 approach");for(var Nt="",qt=0,et=0,wt=0;wt<f.length;wt++)for(qt=qt<<8|f[wt],et+=8;6<=et;){var Kt=qt>>et-6&63;et-=6,Nt+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[Kt]}et==2?(Nt+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(qt&3)<<4],Nt+="=="):et==4&&(Nt+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(qt&15)<<2],Nt+="="),ut.src="data:audio/x-"+p.substr(-3)+";base64,"+Nt,L()}},ut.src=ct,Sw(function(){L()},1e4)}else return H()}});var c=e.canvas;c&&(c.requestPointerLock=c.requestPointerLock||c.mozRequestPointerLock||c.webkitRequestPointerLock||c.msRequestPointerLock||(()=>{}),c.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||(()=>{}),c.exitPointerLock=c.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",a,!1),document.addEventListener("mozpointerlockchange",a,!1),document.addEventListener("webkitpointerlockchange",a,!1),document.addEventListener("mspointerlockchange",a,!1),e.elementPointerLock&&c.addEventListener("click",f=>{!Mw&&e.canvas.requestPointerLock&&(e.canvas.requestPointerLock(),f.preventDefault())},!1))}}function DC(a,c,f,p){Kg();var v=!1;return e.preloadPlugins.forEach(function(M){!v&&M.canHandle(c)&&(M.handle(a,c,f,p),v=!0)}),v}function OC(a,c,f,p){if(c&&e.Wi&&a==e.canvas)return e.Wi;var v;if(c){var M={antialias:!1,alpha:!1,Cj:typeof WebGL2RenderingContext<"u"?2:1};if(p)for(var L in p)M[L]=p[L];if(typeof ep<"u"&&(v=Dw(a,M)))var H=$r[v].Qi}else H=a.getContext("2d");return H?(f&&(c||typeof N>"u"||Le("cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),e.Wi=H,c&&Ow(v),e.wl=c,NC.forEach(function(Q){Q()}),Kg()),H):null}var Ew=!1,Td=void 0,Gl=void 0;function RC(a,c){function f(){Wl=!1;var M=p.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===M?(p.exitFullscreen=LC,Td&&p.requestPointerLock(),Wl=!0,Gl?(typeof SDL<"u"&&(z[SDL.screen>>2]=Pt[SDL.screen>>2]|8388608),Vh(e.canvas),Yg()):Vh(p)):(M.parentNode.insertBefore(p,M),M.parentNode.removeChild(M),Gl?(typeof SDL<"u"&&(z[SDL.screen>>2]=Pt[SDL.screen>>2]&-8388609),Vh(e.canvas),Yg()):Vh(p)),e.onFullScreen&&e.onFullScreen(Wl),e.onFullscreen&&e.onFullscreen(Wl)}Td=a,Gl=c,typeof Td>"u"&&(Td=!0),typeof Gl>"u"&&(Gl=!1);var p=e.canvas;Ew||(Ew=!0,document.addEventListener("fullscreenchange",f,!1),document.addEventListener("mozfullscreenchange",f,!1),document.addEventListener("webkitfullscreenchange",f,!1),document.addEventListener("MSFullscreenChange",f,!1));var v=document.createElement("div");p.parentNode.insertBefore(v,p),v.appendChild(p),v.requestFullscreen=v.requestFullscreen||v.mozRequestFullScreen||v.msRequestFullscreen||(v.webkitRequestFullscreen?()=>v.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):null)||(v.webkitRequestFullScreen?()=>v.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):null),v.requestFullscreen()}function LC(){return Wl?((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0):!1}var Bh=0;function Xg(a){if(typeof requestAnimationFrame=="function")requestAnimationFrame(a);else{var c=Date.now();if(Bh===0)Bh=c+1e3/60;else for(;c+2>=Bh;)Bh+=1e3/60;setTimeout(a,Math.max(Bh-c,0))}}function FC(a){Xg(function(){$g(a)})}function Jg(a){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[a.substr(a.lastIndexOf(".")+1)]}var BC=[];function Yg(){var a=e.canvas;BC.forEach(function(c){c(a.width,a.height)})}function Vh(a,c,f){c&&f?(a.cl=c,a.Ak=f):(c=a.cl,f=a.Ak);var p=c,v=f;if(e.forcedAspectRatio&&0<e.forcedAspectRatio&&(p/v<e.forcedAspectRatio?p=Math.round(v*e.forcedAspectRatio):v=Math.round(p/e.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===a.parentNode&&typeof screen<"u"){var M=Math.min(screen.width/p,screen.height/v);p=Math.round(p*M),v=Math.round(v*M)}Gl?(a.width!=p&&(a.width=p),a.height!=v&&(a.height=v),typeof a.style<"u"&&(a.style.removeProperty("width"),a.style.removeProperty("height"))):(a.width!=c&&(a.width=c),a.height!=f&&(a.height=f),typeof a.style<"u"&&(p!=c||v!=f?(a.style.setProperty("width",p+"px","important"),a.style.setProperty("height",v+"px","important")):(a.style.removeProperty("width"),a.style.removeProperty("height"))))}var Aw,$l,Zg,Ko;function VC(a){var c=a.getExtension("ANGLE_instanced_arrays");c&&(a.vertexAttribDivisor=function(f,p){c.vertexAttribDivisorANGLE(f,p)},a.drawArraysInstanced=function(f,p,v,M){c.drawArraysInstancedANGLE(f,p,v,M)},a.drawElementsInstanced=function(f,p,v,M,L){c.drawElementsInstancedANGLE(f,p,v,M,L)})}function zC(a){var c=a.getExtension("OES_vertex_array_object");c&&(a.createVertexArray=function(){return c.createVertexArrayOES()},a.deleteVertexArray=function(f){c.deleteVertexArrayOES(f)},a.bindVertexArray=function(f){c.bindVertexArrayOES(f)},a.isVertexArray=function(f){return c.isVertexArrayOES(f)})}function HC(a){var c=a.getExtension("WEBGL_draw_buffers");c&&(a.drawBuffers=function(f,p){c.drawBuffersWEBGL(f,p)})}var Qg=1,Ir=[],Fe=[],wo=[],xr=[],nr=[],sn=[],Gr=[],$r=[],Nd={},rn=[],Cr=[],zh=[],Xo=[],Dd={},Tw={},tp=4;function Xt(a){ql||(ql=a)}function Jo(a){for(var c=Qg++,f=a.length;f<c;f++)a[f]=null;return c}function Nw(a,c,f){for(var p="",v=0;v<a;++v){var M=f?z[f+4*v>>2]:-1;p+=q(z[c+4*v>>2],0>M?void 0:M)}return p}function Dw(a,c){a.ti||(a.ti=a.getContext,a.getContext=function(p,v){return v=a.ti(p,v),p=="webgl"==v instanceof WebGLRenderingContext?v:null});var f=1<c.Cj?a.getContext("webgl2",c):a.getContext("webgl",c);return f?UC(f,c):0}function UC(a,c){var f=Jo($r),p={ml:f,attributes:c,version:c.Cj,Qi:a};return a.canvas&&(a.canvas.lk=p),$r[f]=p,(typeof c.Wj>"u"||c.Wj)&&jC(p),f}function Ow(a){return be=$r[a],e.Wi=N=be&&be.Qi,!(a&&!N)}function jC(a){if(a||(a=be),!a.Ck){a.Ck=!0;var c=a.Qi;VC(c),zC(c),HC(c),c.gl=c.getExtension("WEBGL_draw_instanced_base_vertex_base_instance"),c.nl=c.getExtension("WEBGL_multi_draw_instanced_base_vertex_base_instance"),2<=a.version&&(c.pi=c.getExtension("EXT_disjoint_timer_query_webgl2")),(2>a.version||!c.pi)&&(c.pi=c.getExtension("EXT_disjoint_timer_query")),c.pl=c.getExtension("WEBGL_multi_draw"),(c.getSupportedExtensions()||[]).forEach(function(f){f.includes("lose_context")||f.includes("debug")||c.getExtension(f)})}}var ep={},ql,be,Ra=[];function Rw(a,c,f,p){N.drawElements(a,c,f,p)}function xs(a,c,f,p){for(var v=0;v<a;v++){var M=N[f](),L=M&&Jo(p);M?(M.name=L,p[L]=M):Xt(1282),z[c+4*v>>2]=L}}function Od(a,c,f,p,v,M,L,H){c=Fe[c],(a=N[a](c,f))&&(p=H&&st(a.name,A,H,p),v&&(z[v>>2]=p),M&&(z[M>>2]=a.size),L&&(z[L>>2]=a.type))}function Hh(a,c){Pt[a>>2]=c,Pt[a+4>>2]=(c-Pt[a>>2])/4294967296}function La(a,c,f){if(c){var p=void 0;switch(a){case 36346:p=1;break;case 36344:f!=0&&f!=1&&Xt(1280);return;case 34814:case 36345:p=0;break;case 34466:var v=N.getParameter(34467);p=v?v.length:0;break;case 33309:if(2>be.version){Xt(1282);return}p=2*(N.getSupportedExtensions()||[]).length;break;case 33307:case 33308:if(2>be.version){Xt(1280);return}p=a==33307?3:0}if(p===void 0)switch(v=N.getParameter(a),typeof v){case"number":p=v;break;case"boolean":p=v?1:0;break;case"string":Xt(1280);return;case"object":if(v===null)switch(a){case 34964:case 35725:case 34965:case 36006:case 36007:case 32873:case 34229:case 36662:case 36663:case 35053:case 35055:case 36010:case 35097:case 35869:case 32874:case 36389:case 35983:case 35368:case 34068:p=0;break;default:Xt(1280);return}else{if(v instanceof Float32Array||v instanceof Uint32Array||v instanceof Int32Array||v instanceof Array){for(a=0;a<v.length;++a)switch(f){case 0:z[c+4*a>>2]=v[a];break;case 2:X[c+4*a>>2]=v[a];break;case 4:J[c+a>>0]=v[a]?1:0}return}try{p=v.name|0}catch(M){Xt(1280),P("GL_INVALID_ENUM in glGet"+f+"v: Unknown object returned from WebGL getParameter("+a+")! (error: "+M+")");return}}break;default:Xt(1280),P("GL_INVALID_ENUM in glGet"+f+"v: Native code calling glGet"+f+"v("+a+") and it returns "+v+" of type "+typeof v+"!");return}switch(f){case 1:Hh(c,p);break;case 0:z[c>>2]=p;break;case 2:X[c>>2]=p;break;case 4:J[c>>0]=p?1:0}}else Xt(1281)}function Lw(a,c,f,p){if(f){switch(c=N.getIndexedParameter(a,c),typeof c){case"boolean":a=c?1:0;break;case"number":a=c;break;case"object":if(c===null)switch(a){case 35983:case 35368:a=0;break;default:Xt(1280);return}else if(c instanceof WebGLBuffer)a=c.name|0;else{Xt(1280);return}break;default:Xt(1280);return}switch(p){case 1:Hh(f,a);break;case 0:z[f>>2]=a;break;case 2:X[f>>2]=a;break;case 4:J[f>>0]=a?1:0;break;default:throw"internal emscriptenWebGLGetIndexed() error, bad type: "+p}}else Xt(1281)}function vo(a){var c=ft(a)+1,f=Wh(c);return st(a,A,f,c),f}function ip(a){return a.slice(-1)=="]"&&a.lastIndexOf("[")}function np(a){var c=a.Pi,f=a.sj,p;if(!c)for(a.Pi=c={},a.jk={},p=0;p<N.getProgramParameter(a,35718);++p){var v=N.getActiveUniform(a,p),M=v.name;v=v.size;var L=ip(M);L=0<L?M.slice(0,L):M;var H=a.rj;for(a.rj+=v,f[L]=[v,H],M=0;M<v;++M)c[H]=M,a.jk[H++]=L}}function Qt(a){var c=N.Uj;if(c){var f=c.Pi[a];return typeof f=="number"&&(c.Pi[a]=f=N.getUniformLocation(c,c.jk[a]+(0<f?"["+f+"]":""))),f}Xt(1282)}function sp(a,c,f,p){if(f)if(a=Fe[a],np(a),a=N.getUniform(a,Qt(c)),typeof a=="number"||typeof a=="boolean")switch(p){case 0:z[f>>2]=a;break;case 2:X[f>>2]=a}else for(c=0;c<a.length;c++)switch(p){case 0:z[f+4*c>>2]=a[c];break;case 2:X[f+4*c>>2]=a[c]}else Xt(1281)}function Rd(a,c,f,p){if(f)if(a=N.getVertexAttrib(a,c),c==34975)z[f>>2]=a&&a.name;else if(typeof a=="number"||typeof a=="boolean")switch(p){case 0:z[f>>2]=a;break;case 2:X[f>>2]=a;break;case 5:z[f>>2]=Math.fround(a)}else for(c=0;c<a.length;c++)switch(p){case 0:z[f+4*c>>2]=a[c];break;case 2:X[f+4*c>>2]=a[c];break;case 5:z[f+4*c>>2]=Math.fround(a[c])}else Xt(1281)}function Yo(a){return a-=5120,a==0?J:a==1?A:a==2?R:a==4?z:a==6?X:a==5||a==28922||a==28520||a==30779||a==30782?Pt:bt}function Zo(a){return 31-Math.clz32(a.BYTES_PER_ELEMENT)}function Uh(a,c,f,p,v){a=Yo(a);var M=Zo(a),L=tp;return a.subarray(v>>M,v+p*(f*({5:3,6:4,8:2,29502:3,29504:4,26917:2,26918:2,29846:3,29847:4}[c-6402]||1)*(1<<M)+L-1&-L)>>M)}var Cs=[],jh=[],Ld=[],WC={},GC=["default","low-power","high-performance"],$C=[0,typeof document<"u"?document:0,typeof window<"u"?window:0];function qC(a){try{return a?(typeof a=="number"&&(a=$C[a]||q(a)),a==="#window"?window:a==="#document"?document:a==="#screen"?screen:a==="#canvas"?e.canvas:typeof a=="string"?document.getElementById(a):a):window}catch{return null}}var rp={};function Fw(){if(!op){var a={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:o||"./this.program"},c;for(c in rp)rp[c]===void 0?delete a[c]:a[c]=rp[c];var f=[];for(c in a)f.push(c+"="+a[c]);op=f}return op}var op;function Bw(a,c){a=new Uint8Array(a);var f=a.byteLength;if(e.bk+=f+24,327680>=f){var p=Vd();try{var v=Gh(f);A.subarray(v,v+f).set(a),c(v,f)}finally{zd(p)}}else{v=Wh(f);try{A.subarray(v,v+f).set(a),c(v,f)}finally{qr(v)}}}var Fa={connect:function(a,c,f){if(e.vj=c,e.oj=Kl("webSocketHandlerOnMessage",null,["number","number","number","number"]),e.Mi?e.Mi++:e.Mi=1,e.ik=!1,!e.worker){a=new Worker(URL.createObjectURL(new Blob(['var socket;self.onmessage = function (event) {	if (event.data.constructor === ArrayBuffer) {		socket.send (event.data);	} else if (event.data[0] === "connect") {		socket = new WebSocket (event.data[1]);		socket.binaryType = "arraybuffer";		var token = event.data[2];		socket.onclose = function (event) {			self.postMessage (["close", token]);		};		socket.onerror = function (event) {			self.postMessage (["error", token]);		};		socket.onopen = function (event) {			self.postMessage (["open", token]);		};		socket.onmessage = function (event) {			self.postMessage (["data", event.data, token], [event.data]);		};	} else if (event.data[0] === "close") {		socket.close ();	}}'],{type:"application/javascript"}))),e.worker=a;var p=function(v,M){e.oj(v,M,e.vj,2)};a.onmessage=function(v){e.$$facade&&(v.data[0]==="data"?v.data[2]===e.Mi&&Bw(v.data[1],p):v.data[0]==="open"?v.data[1]===e.Mi&&(e.ik=!0,e.oj(0,0,e.vj,0)):v.data[0]==="close"?v.data[1]===e.Mi&&(e.oj(0,0,e.vj,3),e.ki("websocket_connection_closed")):v.data[0]==="error"&&v.data[1]===e.Mi&&e.ki(e.ik?"socket_error":"socket_open_failed"))}}e.worker.postMessage(["connect",q(f),e.Mi])},Jj:function(a,c){e.worker&&(a=new Uint8Array(A.subarray(a,a+c)).buffer,e.worker.postMessage(a,[a]))},close:function(){e.worker&&e.worker.postMessage(["close"]),e.oj=function(){}}},Ba={connect:function(a,c,f){function p(H,Q){M(H,Q,c,2)}a=q(f);var v=new WebSocket(a);e.Fi=v,v.binaryType="arraybuffer";var M=Kl("webSocketHandlerOnMessage",null,["number","number","number","number"]),L=!1;v.onclose=function(){e.Fi===v&&(M(0,0,c,3),e.ki("websocket_connection_closed"))},v.onerror=function(){e.Fi===v&&e.ki(L?"socket_error":"socket_open_failed")},v.onopen=function(){e.Fi===v&&(L=!0,M(0,0,c,0))},v.onmessage=function(H){e.Fi===v&&Bw(H.data,p)}},Jj:function(a,c){e.Fi&&e.Fi.send(A.subarray(a,a+c))},close:function(){e.Fi&&e.Fi.close(),delete e.Fi}};function Fd(a){return a%4===0&&(a%100!==0||a%400===0)}var Vw=[31,29,31,30,31,30,31,31,30,31,30,31],zw=[31,28,31,30,31,30,31,31,30,31,30,31];function KC(a,c,f,p){function v(et,wt,Kt){for(et=typeof et=="number"?et.toString():et||"";et.length<wt;)et=Kt[0]+et;return et}function M(et,wt){return v(et,wt,"0")}function L(et,wt){function Kt($e){return 0>$e?-1:0<$e?1:0}var Pe;return(Pe=Kt(et.getFullYear()-wt.getFullYear()))===0&&(Pe=Kt(et.getMonth()-wt.getMonth()))===0&&(Pe=Kt(et.getDate()-wt.getDate())),Pe}function H(et){switch(et.getDay()){case 0:return new Date(et.getFullYear()-1,11,29);case 1:return et;case 2:return new Date(et.getFullYear(),0,3);case 3:return new Date(et.getFullYear(),0,2);case 4:return new Date(et.getFullYear(),0,1);case 5:return new Date(et.getFullYear()-1,11,31);case 6:return new Date(et.getFullYear()-1,11,30)}}function Q(et){var wt=et.Ni;for(et=new Date(new Date(et.Oi+1900,0,1).getTime());0<wt;){var Kt=et.getMonth(),Pe=(Fd(et.getFullYear())?Vw:zw)[Kt];if(wt>Pe-et.getDate())wt-=Pe-et.getDate()+1,et.setDate(1),11>Kt?et.setMonth(Kt+1):(et.setMonth(0),et.setFullYear(et.getFullYear()+1));else{et.setDate(et.getDate()+wt);break}}return Kt=new Date(et.getFullYear()+1,0,4),wt=H(new Date(et.getFullYear(),0,4)),Kt=H(Kt),0>=L(wt,et)?0>=L(Kt,et)?et.getFullYear()+1:et.getFullYear():et.getFullYear()-1}var ct=z[p+40>>2];p={$k:z[p>>2],Zk:z[p+4>>2],pj:z[p+8>>2],Nj:z[p+12>>2],qj:z[p+16>>2],Oi:z[p+20>>2],zi:z[p+24>>2],Ni:z[p+28>>2],ul:z[p+32>>2],Yk:z[p+36>>2],al:ct?q(ct):""},f=q(f),ct={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var ut in ct)f=f.replace(new RegExp(ut,"g"),ct[ut]);var Nt="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),qt="January February March April May June July August September October November December".split(" ");ct={"%a":function(et){return Nt[et.zi].substring(0,3)},"%A":function(et){return Nt[et.zi]},"%b":function(et){return qt[et.qj].substring(0,3)},"%B":function(et){return qt[et.qj]},"%C":function(et){return M((et.Oi+1900)/100|0,2)},"%d":function(et){return M(et.Nj,2)},"%e":function(et){return v(et.Nj,2," ")},"%g":function(et){return Q(et).toString().substring(2)},"%G":function(et){return Q(et)},"%H":function(et){return M(et.pj,2)},"%I":function(et){return et=et.pj,et==0?et=12:12<et&&(et-=12),M(et,2)},"%j":function(et){for(var wt=0,Kt=0;Kt<=et.qj-1;wt+=(Fd(et.Oi+1900)?Vw:zw)[Kt++]);return M(et.Nj+wt,3)},"%m":function(et){return M(et.qj+1,2)},"%M":function(et){return M(et.Zk,2)},"%n":function(){return`
`},"%p":function(et){return 0<=et.pj&&12>et.pj?"AM":"PM"},"%S":function(et){return M(et.$k,2)},"%t":function(){return"	"},"%u":function(et){return et.zi||7},"%U":function(et){return M(Math.floor((et.Ni+7-et.zi)/7),2)},"%V":function(et){var wt=Math.floor((et.Ni+7-(et.zi+6)%7)/7);if(2>=(et.zi+371-et.Ni-2)%7&&wt++,wt)wt==53&&(Kt=(et.zi+371-et.Ni)%7,Kt==4||Kt==3&&Fd(et.Oi)||(wt=1));else{wt=52;var Kt=(et.zi+7-et.Ni-1)%7;(Kt==4||Kt==5&&Fd(et.Oi%400-1))&&wt++}return M(wt,2)},"%w":function(et){return et.zi},"%W":function(et){return M(Math.floor((et.Ni+7-(et.zi+6)%7)/7),2)},"%y":function(et){return(et.Oi+1900).toString().substring(2)},"%Y":function(et){return et.Oi+1900},"%z":function(et){et=et.Yk;var wt=0<=et;return et=Math.abs(et)/60,(wt?"+":"-")+("0000"+(et/60*100+et%60)).slice(-4)},"%Z":function(et){return et.al},"%%":function(){return"%"}},f=f.replace(/%%/g,"\0\0");for(ut in ct)f.includes(ut)&&(f=f.replace(new RegExp(ut,"g"),ct[ut](p)));return f=f.replace(/\0\0/g,"%"),ut=Qi(f,!1),ut.length>c?0:(J.set(ut,a),ut.length-1)}function ap(a,c,f,p){var v={string:ct=>{var ut=0;if(ct!=null&&ct!==0){var Nt=(ct.length<<2)+1;ut=Gh(Nt),st(ct,A,ut,Nt)}return ut},array:ct=>{var ut=Gh(ct.length);return J.set(ct,ut),ut}};a=e["_"+a];var M=[],L=0;if(p)for(var H=0;H<p.length;H++){var Q=v[f[H]];Q?(L===0&&(L=Vd()),M[H]=Q(p[H])):M[H]=p[H]}return f=a.apply(null,M),f=function(ct){return L!==0&&zd(L),c==="string"?q(ct):c==="boolean"?!!ct:ct}(f)}function Kl(a,c,f,p){f=f||[];var v=f.every(M=>M==="number"||M==="boolean");return c!=="string"&&v&&!p?e["_"+a]:function(){return ap(a,c,f,arguments)}}function Hw(a,c,f,p){a||(a=this),this.parent=a,this.Di=a.Di,this.Xi=null,this.id=Oi++,this.name=c,this.mode=f,this.hi={},this.ii={},this.rdev=p}Object.defineProperties(Hw.prototype,{read:{get:function(){return(this.mode&365)===365},set:function(a){a?this.mode|=365:this.mode&=-366}},write:{get:function(){return(this.mode&146)===146},set:function(a){a?this.mode|=146:this.mode&=-147}},Fk:{get:function(){return(this.mode&61440)===16384}},Ek:{get:function(){return(this.mode&61440)===8192}}}),oi(),es=Array(4096),Eh(te,"/"),w("/tmp",16895,0),w("/home",16895,0),w("/home/web_user",16895,0),(()=>{w("/dev",16895,0),Hl(259,{read:()=>0,write:(c,f,p,v)=>v}),S("/dev/null",259),ui(1280,tr),ui(1536,Un),S("/dev/tty",1280),S("/dev/tty1",1536);var a=hn();Mn("/dev","random",a),Mn("/dev","urandom",a),w("/dev/shm",16895,0),w("/dev/shm/tmp",16895,0)})(),(()=>{w("/proc",16895,0);var a=w("/proc/self",16895,0);w("/proc/self/fd",16895,0),Eh({Di:()=>{var c=vd(a,"fd",16895,73);return c.hi={lookup:(f,p)=>{var v=tn[+p];if(!v)throw new Bt(8);return f={parent:null,Di:{dk:"fake"},hi:{readlink:()=>v.path}},f.parent=f}},c}},"/proc/self/fd")})(),e.FS_createPath=Ri,e.FS_createDataFile=bs,e.FS_createPreloadedFile=Ur,e.FS_unlink=F,e.FS_createLazyFile=is,e.FS_createDevice=Mn,si=e.InternalError=fe("InternalError");for(var Uw=Array(256),Bd=0;256>Bd;++Bd)Uw[Bd]=String.fromCharCode(Bd);xd=Uw,Ul=e.BindingError=fe("BindingError"),qo.prototype.isAliasOf=function(a){if(!(this instanceof qo&&a instanceof qo))return!1;var c=this.fi.ni.ji,f=this.fi.li,p=a.fi.ni.ji;for(a=a.fi.li;c.xi;)f=c.$i(f),c=c.xi;for(;p.xi;)a=p.$i(a),p=p.xi;return c===p&&f===a},qo.prototype.clone=function(){if(this.fi.li||Bg(this),this.fi.Yi)return this.fi.count.value+=1,this;var a=Dh,c=Object,f=c.create,p=Object.getPrototypeOf(this),v=this.fi;return a=a(f.call(c,p,{fi:{value:{count:v.count,Ri:v.Ri,Yi:v.Yi,li:v.li,ni:v.ni,ri:v.ri,wi:v.wi}}})),a.fi.count.value+=1,a.fi.Ri=!1,a},qo.prototype.delete=function(){this.fi.li||Bg(this),this.fi.Ri&&!this.fi.Yi&&ze("Object already scheduled for deletion"),ow(this),aw(this.fi),this.fi.Yi||(this.fi.ri=void 0,this.fi.li=void 0)},qo.prototype.isDeleted=function(){return!this.fi.li},qo.prototype.deleteLater=function(){return this.fi.li||Bg(this),this.fi.Ri&&!this.fi.Yi&&ze("Object already scheduled for deletion"),Ah.push(this),Ah.length===1&&Th&&Th(zg),this.fi.Ri=!0,this},e.getInheritedInstanceCount=function(){return Object.keys(Nh).length},e.getLiveInheritedInstances=function(){var a=[],c;for(c in Nh)Nh.hasOwnProperty(c)&&a.push(Nh[c]);return a},e.flushPendingDeletes=zg,e.setDelayFunction=function(a){Th=a,Ah.length&&Th&&Th(zg)},Wr.prototype.xk=function(a){return this.gk&&(a=this.gk(a)),a},Wr.prototype.Vj=function(a){this.vi&&this.vi(a)},Wr.prototype.argPackAdvance=8,Wr.prototype.readValueFromPointer=Ke,Wr.prototype.deleteObject=function(a){a!==null&&a.delete()},Wr.prototype.fromWireType=function(a){function c(){return this.ij?Cd(this.ji.Ki,{ni:this.Kk,li:f,wi:this,ri:a}):Cd(this.ji.Ki,{ni:this,li:a})}var f=this.xk(a);if(!f)return this.Vj(a),null;var p=lC(this.ji,f);if(p!==void 0)return p.fi.count.value===0?(p.fi.li=f,p.fi.ri=a,p.clone()):(p=p.clone(),this.Vj(a),p);if(p=this.ji.wk(f),p=cw[p],!p)return c.call(this);p=this.hj?p.rk:p.pointerType;var v=lw(f,this.ji,p.ji);return v===null?c.call(this):this.ij?Cd(p.ji.Ki,{ni:p,li:v,wi:this,ri:a}):Cd(p.ji.Ki,{ni:p,li:v})},dw=e.UnboundTypeError=fe("UnboundTypeError"),e.count_emval_handles=function(){for(var a=0,c=5;c<vr.length;++c)vr[c]!==void 0&&++a;return a},e.get_first_emval=function(){for(var a=5;a<vr.length;++a)if(vr[a]!==void 0)return vr[a];return null},e.requestFullscreen=function(a,c){RC(a,c)},e.requestAnimationFrame=function(a){Xg(a)},e.setCanvasSize=function(a,c,f){Vh(e.canvas,a,c),f||Yg()},e.pauseMainLoop=function(){Oa=null,jl++},e.resumeMainLoop=function(){jl++;var a=Ed,c=Ad,f=Lh;Lh=null,MC(f),kC(a,c),Oa()},e.getUserMedia=function(){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(void 0)},e.createContext=function(a,c,f,p){return OC(a,c,f,p)};for(var N,Vs=0;32>Vs;++Vs)Ra.push(Array(Vs));var XC=new Float32Array(288);for(Vs=0;288>Vs;++Vs)Cs[Vs]=XC.subarray(0,Vs+1);var JC=new Int32Array(288);for(Vs=0;288>Vs;++Vs)jh[Vs]=JC.subarray(0,Vs+1);var YC={Ka:function(a,c,f){xt[a]=void 0;try{var p=[new Float32Array(c),new Uint16Array(f)]}catch{return 0}return xt[a]=p,1},Ja:function(a,c,f,p,v){xt[a]=void 0,f>>=2,v>>=1;try{var M=[new Float32Array(X.subarray(f,f+c)),new Uint16Array(bt.subarray(v,v+p))]}catch{return 0}return xt[a]=M,1},La:function(a){xt[a]=void 0},Na:function(){if(Lt.length)return Lt.pop();var a=xt.length;return xt[a]=void 0,a},Ma:function(a){xt[a]=void 0,Lt.push(a)},Dh:function(a,c){return!c||(a=xt[a],!a)?0:(a=a[1],a.length?(bt.set(a,c>>1),1):0)},Eh:function(a,c){return!c||(a=xt[a],!a)?0:(a=a[0],a.length?(X.set(a,c>>2),1):0)},Gh:function(a){return(a=xt[a])?a[1].length:0},Bh:function(a,c){return a=xt[a],a?(a=a[1],a.length?(N.bufferSubData(N.ELEMENT_ARRAY_BUFFER,c,a),1):0):0},zh:function(a,c,f,p){if(a=xt[a],!a)return 0;a=a[1];try{var v=new Uint8Array(a.buffer,c,f)}catch{return 0}return v.length?(N.bufferSubData(N.ELEMENT_ARRAY_BUFFER,p,v),1):0},Ch:function(a,c){return a=xt[a],a?(a=a[0],a.length?(N.bufferSubData(N.ARRAY_BUFFER,c,a),1):0):0},Ah:function(a,c,f,p){if(a=xt[a],!a)return 0;a=a[0];try{var v=new Uint8Array(a.buffer,c,f)}catch{return 0}return v.length?(N.bufferSubData(N.ARRAY_BUFFER,p,v),1):0},Fh:function(a,c,f,p){return a=xt[a],a?(a=a[0],a.length&&c<a.length&&a.length-c>=f?(p>>=2,a.set(X.subarray(p,p+f),c),1):0):0},Hh:function(a){return(a=xt[a])?a[0].length:0},wb:function(a,c){0>a&&(a+=4294967296),0>c&&(c+=4294967296),e.ki("announce_model",a,c)},Y:function(a,c,f){var p=e.$$facade;if(p){var v=e.callAfterMap,M=++v.index,L=function(H){p===e.$$facade&&ap("callFuncWrapper",null,["number","number","number"],[a,!H,c]),delete v.indexedWrappers[M]};v.indexedWrappers[M]=L,0<=f?Sw(L,f):FC(L)}},Td:function(){for(var a=e.callAfterMap,c=a.indexedWrappers,f=Object.keys(c),p=0;p<f.length;++p)c[f[p]](!0);a.indexedWrappers={},a.index=0},vb:function(a,c){e.ki("capping_idle",!!a,c)},pb:function(a){0>a&&(a+=4294967296),e.ki("data_access_attached",a)},ob:function(){e.ki("first_instance")},X:function(a){e.ki(q(a))},ha:function(a,c){c=q(c);try{var f=JSON.parse(c)}catch{f=c}e.ki(q(a),f)},ub:function(a,c,f){0>a&&(a+=4294967296),0>c&&(c+=4294967296),0>f&&(f+=4294967296),e.ki("inclusion",a,c,f)},nc:function(a,c,f,p){e.ki("meta_data",a,c,e.HEAPU8.subarray(f,f+p))},tb:function(a,c){0>a&&(a+=4294967296),c=q(c),e.ki("missing_model",a,c)},Cb:function(a){e.ki("network_receive_data",a)},nb:function(a){e.ki("post_draw_json","{"+q(a)+"}")},qb:function(a,c){0>a&&(a+=4294967296),0>c&&(c+=4294967296),e.ki("priority_meta_data_sent",a,c)},rb:function(a,c,f,p){0>a&&(a+=4294967296),0>c&&(c+=4294967296),0>f&&(f+=4294967296),0>p&&(p+=4294967296),e.ki("remap_inclusion",a,c,f,p)},sb:function(a,c,f){0>a&&(a+=4294967296),0>c&&(c+=4294967296),0>f&&(f+=4294967296),e.ki("remap_model",a,c,f)},h:function(a,c){e.tj&&(a=e.HEAP8.buffer.slice(a,c),e.tj.Ok(a))},cc:function(){e.ki("session_started")},xd:function(){e.$$setReady()},l:function(a,c,f,p){Le("Assertion failed: "+q(a)+", at: "+[c?q(c):"unknown filename",f,p?q(p):"unknown function"])},ua:function(a,c,f){de=f;try{var p=ai(a);switch(c){case 0:var v=Oe();return 0>v?-28:Mh(p,v).fd;case 1:case 2:return 0;case 3:return p.flags;case 4:return v=Oe(),p.flags|=v,0;case 5:return v=Oe(),R[v+0>>1]=2,0;case 6:case 7:return 0;case 16:case 8:return-28;case 9:return z[jw()>>2]=28,-1;default:return-28}}catch(M){if(typeof nn>"u"||!(M instanceof Bt))throw M;return-M.Gi}},Gb:function(a,c,f){de=f;try{var p=ai(a);switch(c){case 21509:case 21505:return p.tty?0:-59;case 21510:case 21511:case 21512:case 21506:case 21507:case 21508:return p.tty?0:-59;case 21519:if(!p.tty)return-59;var v=Oe();return z[v>>2]=0;case 21520:return p.tty?-28:-59;case 21531:if(a=v=Oe(),!p.ii.Dk)throw new Bt(59);return p.ii.Dk(p,c,a);case 21523:return p.tty?0:-59;case 21524:return p.tty?0:-59;default:return-28}}catch(M){if(typeof nn>"u"||!(M instanceof Bt))throw M;return-M.Gi}},Hb:function(a,c,f,p){de=p;try{c=q(c);var v=c;if(v.charAt(0)==="/")c=v;else{var M=a===-100?"/":ai(a).path;if(v.length==0)throw new Bt(44);c=Ut(M+"/"+v)}var L=p?Oe():0;return mt(c,f,L).fd}catch(H){if(typeof nn>"u"||!(H instanceof Bt))throw H;return-H.Gi}},w:function(a){var c=Li[a];delete Li[a];var f=c.elements,p=f.length,v=f.map(function(H){return H.zj}).concat(f.map(function(H){return H.Lj})),M=c.Zi,L=c.vi;Ii([a],v,function(H){return f.forEach((Q,ct)=>{var ut=H[ct],Nt=Q.Si,qt=Q.yj,et=H[ct+p],wt=Q.Kj,Kt=Q.Mj;Q.read=Pe=>ut.fromWireType(Nt(qt,Pe)),Q.write=(Pe,$e)=>{var Fi=[];wt(Kt,Pe,et.toWireType(Fi,$e)),Ei(Fi)}}),[{name:c.name,fromWireType:function(Q){for(var ct=Array(p),ut=0;ut<p;++ut)ct[ut]=f[ut].read(Q);return L(Q),ct},toWireType:function(Q,ct){if(p!==ct.length)throw new TypeError("Incorrect number of tuple elements for "+c.name+": expected="+p+", actual="+ct.length);for(var ut=M(),Nt=0;Nt<p;++Nt)f[Nt].write(ut,ct[Nt]);return Q!==null&&Q.push(L,ut),ut},argPackAdvance:8,readValueFromPointer:Ke,si:L}]})},L:function(a){var c=ir[a];delete ir[a];var f=c.Zi,p=c.vi,v=c.Yj,M=v.map(L=>L.zj).concat(v.map(L=>L.Lj));Ii([a],M,L=>{var H={};return v.forEach((Q,ct)=>{var ut=L[ct],Nt=Q.Si,qt=Q.yj,et=L[ct+v.length],wt=Q.Kj,Kt=Q.Mj;H[Q.vk]={read:Pe=>ut.fromWireType(Nt(qt,Pe)),write:(Pe,$e)=>{var Fi=[];wt(Kt,Pe,et.toWireType(Fi,$e)),Ei(Fi)}}}),[{name:c.name,fromWireType:function(Q){var ct={},ut;for(ut in H)ct[ut]=H[ut].read(Q);return p(Q),ct},toWireType:function(Q,ct){for(var ut in H)if(!(ut in ct))throw new TypeError('Missing field:  "'+ut+'"');var Nt=f();for(ut in H)H[ut].write(Nt,ct[ut]);return Q!==null&&Q.push(p,Nt),Nt},argPackAdvance:8,readValueFromPointer:Ke,si:p}]})},yb:function(){},Tg:function(a,c,f,p,v){var M=Da(f);c=wn(c),jr(a,{name:c,fromWireType:function(L){return!!L},toWireType:function(L,H){return H?p:v},argPackAdvance:8,readValueFromPointer:function(L){if(f===1)var H=J;else if(f===2)H=R;else if(f===4)H=z;else throw new TypeError("Unknown boolean type size: "+c);return this.fromWireType(H[L>>M])},si:null})},_:function(a,c,f,p,v,M,L,H,Q,ct,ut,Nt,qt){ut=wn(ut),M=vn(v,M),H&&(H=vn(L,H)),ct&&(ct=vn(Q,ct)),qt=vn(Nt,qt);var et=Rt(ut);uw(et,function(){Oh("Cannot construct "+ut+" due to unbound types",[p])}),Ii([a,c,f],p?[p]:[],function(wt){if(wt=wt[0],p)var Kt=wt.ji,Pe=Kt.Ki;else Pe=qo.prototype;wt=$t(et,function(){if(Object.getPrototypeOf(this)!==$e)throw new Ul("Use 'new' to construct "+ut);if(Fi.Ii===void 0)throw new Ul(ut+" has no accessible constructor");var Dt=Fi.Ii[arguments.length];if(Dt===void 0)throw new Ul("Tried to invoke ctor of "+ut+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(Fi.Ii).toString()+") parameters instead!");return Dt.apply(this,arguments)});var $e=Object.create(Pe,{constructor:{value:wt}});wt.prototype=$e;var Fi=new cC(ut,wt,$e,qt,Kt,M,H,ct);Kt=new Wr(ut,Fi,!0,!1,!1),Pe=new Wr(ut+"*",Fi,!1,!1,!1);var Vt=new Wr(ut+" const*",Fi,!1,!0,!1);return cw[a]={pointerType:Pe,rk:Vt},fC(et,wt),[Kt,Pe,Vt]})},b:function(a,c,f,p,v,M,L){var H=mw(f,p);c=wn(c),M=vn(v,M),Ii([],[a],function(Q){function ct(){Oh("Cannot call "+ut+" due to unbound types",H)}Q=Q[0];var ut=Q.name+"."+c;c.startsWith("@@")&&(c=Symbol[c.substring(2)]);var Nt=Q.ji.constructor;return Nt[c]===void 0?(ct.uj=f-1,Nt[c]=ct):(hw(Nt,c,ut),Nt[c].Ei[f-1]=ct),Ii([],H,function(qt){return qt=[qt[0],null].concat(qt.slice(1)),qt=pw(ut,qt,M,L),Nt[c].Ei===void 0?(qt.uj=f-1,Nt[c]=qt):Nt[c].Ei[f-1]=qt,[]}),[]})},ja:function(a,c,f,p,v,M){0<c||Le();var L=mw(c,f);v=vn(p,v),Ii([],[a],function(H){H=H[0];var Q="constructor "+H.name;if(H.ji.Ii===void 0&&(H.ji.Ii=[]),H.ji.Ii[c-1]!==void 0)throw new Ul("Cannot register multiple constructors with identical number of parameters ("+(c-1)+") for class '"+H.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return H.ji.Ii[c-1]=()=>{Oh("Cannot construct "+H.name+" due to unbound types",L)},Ii([],L,function(ct){return ct.splice(1,0,null),H.ji.Ii[c-1]=pw(Q,ct,v,M),[]}),[]})},Z:function(a,c,f,p,v,M,L,H,Q,ct){c=wn(c),v=vn(p,v),Ii([],[a],function(ut){ut=ut[0];var Nt=ut.name+"."+c,qt={get:function(){Oh("Cannot access "+Nt+" due to unbound types",[f,L])},enumerable:!0,configurable:!0};return qt.set=Q?()=>{Oh("Cannot access "+Nt+" due to unbound types",[f,L])}:()=>{ze(Nt+" is a read-only property")},Object.defineProperty(ut.ji.Ki,c,qt),Ii([],Q?[f,L]:[f],function(et){var wt=et[0],Kt={get:function(){var $e=_w(this,ut,Nt+" getter");return wt.fromWireType(v(M,$e))},enumerable:!0};if(Q){Q=vn(H,Q);var Pe=et[1];Kt.set=function($e){var Fi=_w(this,ut,Nt+" setter"),Vt=[];Q(ct,Fi,Pe.toWireType(Vt,$e)),Ei(Vt)}}return Object.defineProperty(ut.ji.Ki,c,Kt),[]}),[]})},Sg:function(a,c){c=wn(c),jr(a,{name:c,fromWireType:function(f){var p=br(f);return Ug(f),p},toWireType:function(f,p){return Is(p)},argPackAdvance:8,readValueFromPointer:Ke,si:null})},K:function(a,c,f,p){function v(){}f=Da(f),c=wn(c),v.values={},jr(a,{name:c,constructor:v,fromWireType:function(M){return this.constructor.values[M]},toWireType:function(M,L){return L.value},argPackAdvance:8,readValueFromPointer:pC(c,f,p),si:null}),uw(c,v)},v:function(a,c,f){var p=Rh(a,"enum");c=wn(c),a=p.constructor,p=Object.create(p.constructor.prototype,{value:{value:f},constructor:{value:$t(p.name+"_"+c,function(){})}}),a.values[f]=p,a[c]=p},xa:function(a,c,f){f=Da(f),c=wn(c),jr(a,{name:c,fromWireType:function(p){return p},toWireType:function(p,v){return v},argPackAdvance:8,readValueFromPointer:mC(c,f),si:null})},P:function(a,c,f,p,v){c=wn(c),v===-1&&(v=4294967295),v=Da(f);var M=H=>H;if(p===0){var L=32-8*f;M=H=>H<<L>>>L}f=c.includes("unsigned")?function(H,Q){return Q>>>0}:function(H,Q){return Q},jr(a,{name:c,fromWireType:M,toWireType:f,argPackAdvance:8,readValueFromPointer:_C(c,v,p!==0),si:null})},D:function(a,c,f){function p(M){M>>=2;var L=Pt;return new v(U,L[M+1],L[M])}var v=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][c];f=wn(f),jr(a,{name:f,fromWireType:p,argPackAdvance:8,readValueFromPointer:p},{Bk:!0})},ia:function(a,c,f,p,v,M,L,H,Q,ct,ut,Nt){f=wn(f),M=vn(v,M),H=vn(L,H),ct=vn(Q,ct),Nt=vn(ut,Nt),Ii([a],[c],function(qt){return qt=qt[0],[new Wr(f,qt.ji,!1,!1,!0,qt,p,M,H,ct,Nt)]})},wa:function(a,c){c=wn(c);var f=c==="std::string";jr(a,{name:c,fromWireType:function(p){var v=Pt[p>>2],M=p+4;if(f)for(var L=M,H=0;H<=v;++H){var Q=M+H;if(H==v||A[Q]==0){if(L=q(L,Q-L),ct===void 0)var ct=L;else ct+="\0",ct+=L;L=Q+1}}else{for(ct=Array(v),H=0;H<v;++H)ct[H]=String.fromCharCode(A[M+H]);ct=ct.join("")}return qr(p),ct},toWireType:function(p,v){v instanceof ArrayBuffer&&(v=new Uint8Array(v));var M=typeof v=="string";M||v instanceof Uint8Array||v instanceof Uint8ClampedArray||v instanceof Int8Array||ze("Cannot pass non-string to std::string");var L=f&&M?ft(v):v.length,H=Wh(4+L+1),Q=H+4;if(Pt[H>>2]=L,f&&M)st(v,A,Q,L+1);else if(M)for(M=0;M<L;++M){var ct=v.charCodeAt(M);255<ct&&(qr(Q),ze("String has UTF-16 code units that do not fit in 8 bits")),A[Q+M]=ct}else for(M=0;M<L;++M)A[Q+M]=v[M];return p!==null&&p.push(qr,H),H},argPackAdvance:8,readValueFromPointer:Ke,si:function(p){qr(p)}})},ka:function(a,c,f){if(f=wn(f),c===2)var p=yC,v=wC,M=vC,L=()=>bt,H=1;else c===4&&(p=bC,v=IC,M=xC,L=()=>Pt,H=2);jr(a,{name:f,fromWireType:function(Q){for(var ct=Pt[Q>>2],ut=L(),Nt,qt=Q+4,et=0;et<=ct;++et){var wt=Q+4+et*c;(et==ct||ut[wt>>H]==0)&&(qt=p(qt,wt-qt),Nt===void 0?Nt=qt:(Nt+="\0",Nt+=qt),qt=wt+c)}return qr(Q),Nt},toWireType:function(Q,ct){typeof ct!="string"&&ze("Cannot pass non-string to C++ string type "+f);var ut=M(ct),Nt=Wh(4+ut+c);return Pt[Nt>>2]=ut>>H,v(ct,Nt+4,ut+c),Q!==null&&Q.push(qr,Nt),Nt},argPackAdvance:8,readValueFromPointer:Ke,si:function(Q){qr(Q)}})},x:function(a,c,f,p,v,M){Li[a]={name:wn(c),Zi:vn(f,p),vi:vn(v,M),elements:[]}},i:function(a,c,f,p,v,M,L,H,Q){Li[a].elements.push({zj:c,Si:vn(f,p),yj:v,Lj:M,Kj:vn(L,H),Mj:Q})},M:function(a,c,f,p,v,M){ir[a]={name:wn(c),Zi:vn(f,p),vi:vn(v,M),Yj:[]}},z:function(a,c,f,p,v,M,L,H,Q,ct){ir[a].Yj.push({vk:wn(c),zj:f,Si:vn(p,v),yj:M,Lj:L,Kj:vn(H,Q),Mj:ct})},Ug:function(a,c){c=wn(c),jr(a,{Gk:!0,name:c,argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},Vg:function(a){do{var c=Pt[a>>2];a+=4;var f=Pt[a>>2];a+=4;var p=Pt[a>>2];a+=4,c=q(c),Ri("/",Ge(c)),bs(c,null,J.subarray(p,p+f),!0,!0,!0)}while(Pt[a>>2])},Db:function(){return!0},p:function(a,c,f){a=br(a),c=Rh(c,"emval::as");var p=[],v=Is(p);return Pt[f>>2]=v,c.toWireType(p,a)},j:function(a,c,f,p){a=br(a),f=ww(c,f);for(var v=Array(c),M=0;M<c;++M){var L=f[M];v[M]=L.readValueFromPointer(p),p+=L.argPackAdvance}return a=a.apply(void 0,v),Is(a)},Q:function(a,c,f,p,v){a=Wg[a],c=br(c),f=Pd(f);var M=[];return Pt[p>>2]=Is(M),a(c,f,M,v)},a:Ug,J:function(a){return a===0?Is(vw()):(a=Pd(a),Is(vw()[a]))},R:function(a,c){var f=ww(a,c),p=f[0];c=p.name+"_$"+f.slice(1).map(function(ut){return ut.name}).join("_")+"$";var v=bw[c];if(v!==void 0)return v;v=["retType"];for(var M=[p],L="",H=0;H<a-1;++H)L+=(H!==0?", ":"")+"arg"+H,v.push("argType"+H),M.push(f[1+H]);var Q="return function "+Rt("methodCaller_"+c)+`(handle, name, destructors, args) {
`,ct=0;for(H=0;H<a-1;++H)Q+="    var arg"+H+" = argType"+H+".readValueFromPointer(args"+(ct?"+"+ct:"")+`);
`,ct+=f[H+1].argPackAdvance;for(Q+="    var rv = handle[name]("+L+`);
`,H=0;H<a-1;++H)f[H+1].deleteObject&&(Q+="    argType"+H+".deleteObject(arg"+H+`);
`);return p.Gk||(Q+=`    return retType.toWireType(destructors, rv);
`),v.push(Q+`};
`),a=gw(v).apply(null,M),v=SC(a),bw[c]=v},aa:function(a){return a=Pd(a),Is(e[a])},o:function(a,c){return a=br(a),c=br(c),Is(a[c])},d:function(a){4<a&&(vr[a].Gj+=1)},S:function(a,c,f,p){a=br(a);var v=Iw[c];return v||(v=PC(c),Iw[c]=v),v(a,f,p)},u:function(){return Is([])},f:function(a){return Is(Pd(a))},B:function(){return Is({})},m:function(a){var c=br(a);Ei(c),Ug(a)},g:function(a,c,f){a=br(a),c=br(c),f=br(f),a[c]=f},e:function(a,c){return a=Rh(a,"_emval_take_value"),a=a.readValueFromPointer(c),Is(a)},c:function(){Le("")},da:function(a,c,f){Gg.length=0;var p;for(f>>=2;p=A[c++];)f+=p!=105&f,Gg.push(p==105?z[f]:Tt[f++>>1]),++f;return It[a].apply(null,Gg)},Id:function(a,c,f){var p=e.canvas;z[a>>2]=p.width,z[c>>2]=p.height,z[f>>2]=Wl?1:0},A:kd,yg:function(a){N.activeTexture(a)},xg:function(a,c){N.attachShader(Fe[a],sn[c])},Bd:function(a,c){N.beginQuery(a,rn[c])},Og:function(a,c){N.pi.beginQueryEXT(a,rn[c])},hd:function(a){N.beginTransformFeedback(a)},wg:function(a,c,f){N.bindAttribLocation(Fe[a],c,q(f))},vg:function(a,c){a==35051?N.Ji=c:a==35052&&(N.oi=c),N.bindBuffer(a,Ir[c])},ed:function(a,c,f){N.bindBufferBase(a,c,Ir[f])},fd:function(a,c,f,p,v){N.bindBufferRange(a,c,Ir[f],p,v)},ug:function(a,c){N.bindFramebuffer(a,wo[c])},tg:function(a,c){N.bindRenderbuffer(a,xr[c])},ic:function(a,c){N.bindSampler(a,Cr[c])},sg:function(a,c){N.bindTexture(a,nr[c])},$b:function(a,c){N.bindTransformFeedback(a,zh[c])},md:function(a){N.bindVertexArray(Gr[a])},Gg:function(a){N.bindVertexArray(Gr[a])},rg:function(a,c,f,p){N.blendColor(a,c,f,p)},qg:function(a){N.blendEquation(a)},pg:function(a,c){N.blendEquationSeparate(a,c)},og:function(a,c){N.blendFunc(a,c)},ng:function(a,c,f,p){N.blendFuncSeparate(a,c,f,p)},pd:function(a,c,f,p,v,M,L,H,Q,ct){N.blitFramebuffer(a,c,f,p,v,M,L,H,Q,ct)},mg:function(a,c,f,p){2<=be.version?f&&c?N.bufferData(a,A,p,f,c):N.bufferData(a,c,p):N.bufferData(a,f?A.subarray(f,f+c):c,p)},lg:function(a,c,f,p){2<=be.version?f&&N.bufferSubData(a,c,A,p,f):N.bufferSubData(a,c,A.subarray(p,p+f))},kg:function(a){return N.checkFramebufferStatus(a)},jg:function(a){N.clear(a)},Hc:function(a,c,f,p){N.clearBufferfi(a,c,f,p)},Ic:function(a,c,f){N.clearBufferfv(a,c,X,f>>2)},Lc:function(a,c,f){N.clearBufferiv(a,c,z,f>>2)},Kc:function(a,c,f){N.clearBufferuiv(a,c,Pt,f>>2)},ig:function(a,c,f,p){N.clearColor(a,c,f,p)},hg:function(a){N.clearDepth(a)},gg:function(a){N.clearStencil(a)},sc:function(a,c,f,p){return N.clientWaitSync(Xo[a],c,(f>>>0)+4294967296*p)},fg:function(a,c,f,p){N.colorMask(!!a,!!c,!!f,!!p)},eg:function(a){N.compileShader(sn[a])},dg:function(a,c,f,p,v,M,L,H){2<=be.version?N.oi||!L?N.compressedTexImage2D(a,c,f,p,v,M,L,H):N.compressedTexImage2D(a,c,f,p,v,M,A,H,L):N.compressedTexImage2D(a,c,f,p,v,M,H?A.subarray(H,H+L):null)},Gd:function(a,c,f,p,v,M,L,H,Q){N.oi?N.compressedTexImage3D(a,c,f,p,v,M,L,H,Q):N.compressedTexImage3D(a,c,f,p,v,M,L,A,Q,H)},cg:function(a,c,f,p,v,M,L,H,Q){2<=be.version?N.oi||!H?N.compressedTexSubImage2D(a,c,f,p,v,M,L,H,Q):N.compressedTexSubImage2D(a,c,f,p,v,M,L,A,Q,H):N.compressedTexSubImage2D(a,c,f,p,v,M,L,Q?A.subarray(Q,Q+H):null)},Fd:function(a,c,f,p,v,M,L,H,Q,ct,ut){N.oi?N.compressedTexSubImage3D(a,c,f,p,v,M,L,H,Q,ct,ut):N.compressedTexSubImage3D(a,c,f,p,v,M,L,H,Q,A,ut,ct)},Fc:function(a,c,f,p,v){N.copyBufferSubData(a,c,f,p,v)},bg:function(a,c,f,p,v,M,L,H){N.copyTexImage2D(a,c,f,p,v,M,L,H)},ag:function(a,c,f,p,v,M,L,H){N.copyTexSubImage2D(a,c,f,p,v,M,L,H)},Hd:function(a,c,f,p,v,M,L,H,Q){N.copyTexSubImage3D(a,c,f,p,v,M,L,H,Q)},$f:function(){var a=Jo(Fe),c=N.createProgram();return c.name=a,c.Ci=c.Ai=c.Bi=0,c.rj=1,Fe[a]=c,a},_f:function(a){var c=Jo(sn);return sn[c]=N.createShader(a),c},Zf:function(a){N.cullFace(a)},Yf:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=Ir[p];v&&(N.deleteBuffer(v),v.name=0,Ir[p]=null,p==N.Ji&&(N.Ji=0),p==N.oi&&(N.oi=0))}},Xf:function(a,c){for(var f=0;f<a;++f){var p=z[c+4*f>>2],v=wo[p];v&&(N.deleteFramebuffer(v),v.name=0,wo[p]=null)}},Wf:function(a){if(a){var c=Fe[a];c?(N.deleteProgram(c),c.name=0,Fe[a]=null):Xt(1281)}},Dd:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=rn[p];v&&(N.deleteQuery(v),rn[p]=null)}},Qg:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=rn[p];v&&(N.pi.deleteQueryEXT(v),rn[p]=null)}},Vf:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=xr[p];v&&(N.deleteRenderbuffer(v),v.name=0,xr[p]=null)}},kc:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=Cr[p];v&&(N.deleteSampler(v),v.name=0,Cr[p]=null)}},Uf:function(a){if(a){var c=sn[a];c?(N.deleteShader(c),sn[a]=null):Xt(1281)}},tc:function(a){if(a){var c=Xo[a];c?(N.deleteSync(c),c.name=0,Xo[a]=null):Xt(1281)}},Tf:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=nr[p];v&&(N.deleteTexture(v),v.name=0,nr[p]=null)}},_b:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=zh[p];v&&(N.deleteTransformFeedback(v),v.name=0,zh[p]=null)}},ld:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2];N.deleteVertexArray(Gr[p]),Gr[p]=null}},Fg:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2];N.deleteVertexArray(Gr[p]),Gr[p]=null}},Sf:function(a){N.depthFunc(a)},Rf:function(a){N.depthMask(!!a)},Qf:function(a,c){N.depthRange(a,c)},Pf:function(a,c){N.detachShader(Fe[a],sn[c])},Of:function(a){N.disable(a)},Nf:function(a){N.disableVertexAttribArray(a)},Mf:function(a,c,f){N.drawArrays(a,c,f)},xc:function(a,c,f,p){N.drawArraysInstanced(a,c,f,p)},Bg:function(a,c,f,p){N.drawArraysInstanced(a,c,f,p)},Kb:function(a,c,f,p){N.drawArraysInstanced(a,c,f,p)},Pd:function(a,c,f,p){N.drawArraysInstanced(a,c,f,p)},Lb:function(a,c,f,p){N.drawArraysInstanced(a,c,f,p)},wd:function(a,c){for(var f=Ra[a],p=0;p<a;p++)f[p]=z[c+4*p>>2];N.drawBuffers(f)},Nd:function(a,c){for(var f=Ra[a],p=0;p<a;p++)f[p]=z[c+4*p>>2];N.drawBuffers(f)},Cg:function(a,c){for(var f=Ra[a],p=0;p<a;p++)f[p]=z[c+4*p>>2];N.drawBuffers(f)},Lf:function(a,c,f,p){N.drawElements(a,c,f,p)},wc:function(a,c,f,p,v){N.drawElementsInstanced(a,c,f,p,v)},Ag:function(a,c,f,p,v){N.drawElementsInstanced(a,c,f,p,v)},Ib:function(a,c,f,p,v){N.drawElementsInstanced(a,c,f,p,v)},Jb:function(a,c,f,p,v){N.drawElementsInstanced(a,c,f,p,v)},Od:function(a,c,f,p,v){N.drawElementsInstanced(a,c,f,p,v)},Ld:function(a,c,f,p,v,M){Rw(a,p,v,M)},Kf:function(a){N.enable(a)},Jf:function(a){N.enableVertexAttribArray(a)},Ad:function(a){N.endQuery(a)},Ng:function(a){N.pi.endQueryEXT(a)},gd:function(){N.endTransformFeedback()},vc:function(a,c){return(a=N.fenceSync(a,c))?(c=Jo(Xo),a.name=c,Xo[c]=a,c):0},If:function(){N.finish()},Hf:function(){N.flush()},Gf:function(a,c,f,p){N.framebufferRenderbuffer(a,c,f,xr[p])},Ff:function(a,c,f,p,v){N.framebufferTexture2D(a,c,f,nr[p],v)},nd:function(a,c,f,p,v){N.framebufferTextureLayer(a,c,nr[f],p,v)},Ef:function(a){N.frontFace(a)},Df:function(a,c){xs(a,c,"createBuffer",Ir)},Bf:function(a,c){xs(a,c,"createFramebuffer",wo)},Ed:function(a,c){xs(a,c,"createQuery",rn)},Rg:function(a,c){for(var f=0;f<a;f++){var p=N.pi.createQueryEXT();if(!p){for(Xt(1282);f<a;)z[c+4*f++>>2]=0;break}var v=Jo(rn);p.name=v,rn[v]=p,z[c+4*f>>2]=v}},Af:function(a,c){xs(a,c,"createRenderbuffer",xr)},lc:function(a,c){xs(a,c,"createSampler",Cr)},zf:function(a,c){xs(a,c,"createTexture",nr)},Zb:function(a,c){xs(a,c,"createTransformFeedback",zh)},kd:function(a,c){xs(a,c,"createVertexArray",Gr)},Eg:function(a,c){xs(a,c,"createVertexArray",Gr)},Cf:function(a){N.generateMipmap(a)},yf:function(a,c,f,p,v,M,L){Od("getActiveAttrib",a,c,f,p,v,M,L)},xf:function(a,c,f,p,v,M,L){Od("getActiveUniform",a,c,f,p,v,M,L)},Ac:function(a,c,f,p,v){a=Fe[a],(a=N.getActiveUniformBlockName(a,c))&&(v&&0<f?(f=st(a,A,v,f),p&&(z[p>>2]=f)):p&&(z[p>>2]=0))},Bc:function(a,c,f,p){if(p){if(a=Fe[a],f==35393)f=N.getActiveUniformBlockName(a,c),z[p>>2]=f.length+1;else if(a=N.getActiveUniformBlockParameter(a,c,f),a!==null)if(f==35395)for(f=0;f<a.length;f++)z[p+4*f>>2]=a[f];else z[p>>2]=a}else Xt(1281)},Dc:function(a,c,f,p,v){if(v)if(0<c&&f==0)Xt(1281);else{a=Fe[a];for(var M=[],L=0;L<c;L++)M.push(z[f+4*L>>2]);if(a=N.getActiveUniforms(a,M,p))for(c=a.length,L=0;L<c;L++)z[v+4*L>>2]=a[L]}else Xt(1281)},wf:function(a,c,f,p){a=N.getAttachedShaders(Fe[a]);var v=a.length;for(v>c&&(v=c),z[f>>2]=v,c=0;c<v;++c)z[p+4*c>>2]=sn.indexOf(a[c])},vf:function(a,c){return N.getAttribLocation(Fe[a],q(c))},uf:function(a,c){La(a,c,4)},mc:function(a,c,f){f?Hh(f,N.getBufferParameter(a,c)):Xt(1281)},tf:function(a,c,f){f?z[f>>2]=N.getBufferParameter(a,c):Xt(1281)},sf:function(){var a=N.getError()||ql;return ql=0,a},rf:function(a,c){La(a,c,2)},Uc:function(a,c){return N.getFragDataLocation(Fe[a],q(c))},qf:function(a,c,f,p){a=N.getFramebufferAttachmentParameter(a,c,f),(a instanceof WebGLRenderbuffer||a instanceof WebGLTexture)&&(a=a.name|0),z[p>>2]=a},oc:function(a,c,f){Lw(a,c,f,1)},qc:function(a,c){La(a,c,1)},id:function(a,c,f){Lw(a,c,f,0)},pf:function(a,c){La(a,c,0)},Ob:function(a,c,f,p,v){if(0>p)Xt(1281);else if(v){if(a=N.getInternalformatParameter(a,c,f),a!==null)for(c=0;c<a.length&&c<p;++c)z[v+4*c>>2]=a[c]}else Xt(1281)},Vb:function(){Xt(1282)},nf:function(a,c,f,p){a=N.getProgramInfoLog(Fe[a]),a===null&&(a="(unknown error)"),c=0<c&&p?st(a,A,p,c):0,f&&(z[f>>2]=c)},of:function(a,c,f){if(f)if(a>=Qg)Xt(1281);else if(a=Fe[a],c==35716)a=N.getProgramInfoLog(a),a===null&&(a="(unknown error)"),z[f>>2]=a.length+1;else if(c==35719){if(!a.Ci)for(c=0;c<N.getProgramParameter(a,35718);++c)a.Ci=Math.max(a.Ci,N.getActiveUniform(a,c).name.length+1);z[f>>2]=a.Ci}else if(c==35722){if(!a.Ai)for(c=0;c<N.getProgramParameter(a,35721);++c)a.Ai=Math.max(a.Ai,N.getActiveAttrib(a,c).name.length+1);z[f>>2]=a.Ai}else if(c==35381){if(!a.Bi)for(c=0;c<N.getProgramParameter(a,35382);++c)a.Bi=Math.max(a.Bi,N.getActiveUniformBlockName(a,c).length+1);z[f>>2]=a.Bi}else z[f>>2]=N.getProgramParameter(a,c);else Xt(1281)},Ig:function(a,c,f){if(f){a=rn[a],c=2>be.version?N.pi.getQueryObjectEXT(a,c):N.getQueryParameter(a,c);var p;typeof c=="boolean"?p=c?1:0:p=c,Hh(f,p)}else Xt(1281)},Kg:function(a,c,f){if(f){a=N.pi.getQueryObjectEXT(rn[a],c);var p;typeof a=="boolean"?p=a?1:0:p=a,z[f>>2]=p}else Xt(1281)},Hg:function(a,c,f){if(f){a=rn[a],c=2>be.version?N.pi.getQueryObjectEXT(a,c):N.getQueryParameter(a,c);var p;typeof c=="boolean"?p=c?1:0:p=c,Hh(f,p)}else Xt(1281)},yd:function(a,c,f){if(f){a=N.getQueryParameter(rn[a],c);var p;typeof a=="boolean"?p=a?1:0:p=a,z[f>>2]=p}else Xt(1281)},Jg:function(a,c,f){if(f){a=N.pi.getQueryObjectEXT(rn[a],c);var p;typeof a=="boolean"?p=a?1:0:p=a,z[f>>2]=p}else Xt(1281)},zd:function(a,c,f){f?z[f>>2]=N.getQuery(a,c):Xt(1281)},Lg:function(a,c,f){f?z[f>>2]=N.pi.getQueryEXT(a,c):Xt(1281)},mf:function(a,c,f){f?z[f>>2]=N.getRenderbufferParameter(a,c):Xt(1281)},bc:function(a,c,f){f?X[f>>2]=N.getSamplerParameter(Cr[a],c):Xt(1281)},dc:function(a,c,f){f?z[f>>2]=N.getSamplerParameter(Cr[a],c):Xt(1281)},kf:function(a,c,f,p){a=N.getShaderInfoLog(sn[a]),a===null&&(a="(unknown error)"),c=0<c&&p?st(a,A,p,c):0,f&&(z[f>>2]=c)},jf:function(a,c,f,p){a=N.getShaderPrecisionFormat(a,c),z[f>>2]=a.rangeMin,z[f+4>>2]=a.rangeMax,z[p>>2]=a.precision},hf:function(a,c,f,p){(a=N.getShaderSource(sn[a]))&&(c=0<c&&p?st(a,A,p,c):0,f&&(z[f>>2]=c))},lf:function(a,c,f){f?c==35716?(a=N.getShaderInfoLog(sn[a]),a===null&&(a="(unknown error)"),z[f>>2]=a?a.length+1:0):c==35720?(a=N.getShaderSource(sn[a]),z[f>>2]=a?a.length+1:0):z[f>>2]=N.getShaderParameter(sn[a],c):Xt(1281)},gf:function(a){var c=Dd[a];if(!c){switch(a){case 7939:c=N.getSupportedExtensions()||[],c=c.concat(c.map(function(p){return"GL_"+p})),c=vo(c.join(" "));break;case 7936:case 7937:case 37445:case 37446:(c=N.getParameter(a))||Xt(1280),c=c&&vo(c);break;case 7938:c=N.getParameter(7938),c=2<=be.version?"OpenGL ES 3.0 ("+c+")":"OpenGL ES 2.0 ("+c+")",c=vo(c);break;case 35724:c=N.getParameter(35724);var f=c.match(/^WebGL GLSL ES ([0-9]\.[0-9][0-9]?)(?:$| .*)/);f!==null&&(f[1].length==3&&(f[1]+="0"),c="OpenGL ES GLSL ES "+f[1]+" ("+c+")"),c=vo(c);break;default:Xt(1280)}Dd[a]=c}return c},Gc:function(a,c){if(2>be.version)return Xt(1282),0;var f=Tw[a];if(f)return 0>c||c>=f.length?(Xt(1281),0):f[c];switch(a){case 7939:return f=N.getSupportedExtensions()||[],f=f.concat(f.map(function(p){return"GL_"+p})),f=f.map(function(p){return vo(p)}),f=Tw[a]=f,0>c||c>=f.length?(Xt(1281),0):f[c];default:return Xt(1280),0}},pc:function(a,c,f,p,v){0>f?Xt(1281):v?(a=N.getSyncParameter(Xo[a],c),a!==null&&(z[v>>2]=a,p&&(z[p>>2]=1))):Xt(1281)},ff:function(a,c,f){f?X[f>>2]=N.getTexParameter(a,c):Xt(1281)},ef:function(a,c,f){f?z[f>>2]=N.getTexParameter(a,c):Xt(1281)},bd:function(a,c,f,p,v,M,L){a=Fe[a],(a=N.getTransformFeedbackVarying(a,c))&&(L&&0<f?(f=st(a.name,A,L,f),p&&(z[p>>2]=f)):p&&(z[p>>2]=0),v&&(z[v>>2]=a.size),M&&(z[M>>2]=a.type))},Cc:function(a,c){return N.getUniformBlockIndex(Fe[a],q(c))},Ec:function(a,c,f,p){if(p)if(0<c&&(f==0||p==0))Xt(1281);else{a=Fe[a];for(var v=[],M=0;M<c;M++)v.push(q(z[f+4*M>>2]));if(a=N.getUniformIndices(a,v))for(c=a.length,M=0;M<c;M++)z[p+4*M>>2]=a[M]}else Xt(1281)},bf:function(a,c){if(c=q(c),a=Fe[a]){np(a);var f=a.Pi,p=0,v=c,M=ip(c);if(0<M&&(p=parseInt(c.slice(M+1))>>>0,v=c.slice(0,M)),(v=a.sj[v])&&p<v[0]&&(p+=v[1],f[p]=f[p]||N.getUniformLocation(a,c)))return p}else Xt(1281);return-1},df:function(a,c,f){sp(a,c,f,2)},cf:function(a,c,f){sp(a,c,f,0)},Vc:function(a,c,f){sp(a,c,f,0)},$c:function(a,c,f){Rd(a,c,f,0)},_c:function(a,c,f){Rd(a,c,f,0)},_e:function(a,c,f){f?z[f>>2]=N.getVertexAttribOffset(a,c):Xt(1281)},af:function(a,c,f){Rd(a,c,f,2)},$e:function(a,c,f){Rd(a,c,f,5)},Ze:function(a,c){N.hint(a,c)},Sb:function(a,c,f){for(var p=Ra[c],v=0;v<c;v++)p[v]=z[f+4*v>>2];N.invalidateFramebuffer(a,p)},Rb:function(a,c,f,p,v,M,L){for(var H=Ra[c],Q=0;Q<c;Q++)H[Q]=z[f+4*Q>>2];N.invalidateSubFramebuffer(a,H,p,v,M,L)},Ye:function(a){return(a=Ir[a])?N.isBuffer(a):0},Xe:function(a){return N.isEnabled(a)},We:function(a){return(a=wo[a])?N.isFramebuffer(a):0},Ve:function(a){return(a=Fe[a])?N.isProgram(a):0},Cd:function(a){return(a=rn[a])?N.isQuery(a):0},Pg:function(a){return(a=rn[a])?N.pi.isQueryEXT(a):0},Ue:function(a){return(a=xr[a])?N.isRenderbuffer(a):0},jc:function(a){return(a=Cr[a])?N.isSampler(a):0},Te:function(a){return(a=sn[a])?N.isShader(a):0},uc:function(a){return N.isSync(Xo[a])},Se:function(a){return(a=nr[a])?N.isTexture(a):0},Yb:function(a){return N.isTransformFeedback(zh[a])},jd:function(a){return(a=Gr[a])?N.isVertexArray(a):0},Dg:function(a){return(a=Gr[a])?N.isVertexArray(a):0},Re:function(a){N.lineWidth(a)},Qe:function(a){a=Fe[a],N.linkProgram(a),a.Pi=0,a.sj={}},Xb:function(){N.pauseTransformFeedback()},Pe:function(a,c){a==3317&&(tp=c),N.pixelStorei(a,c)},Oe:function(a,c){N.polygonOffset(a,c)},Ub:function(){Xt(1280)},Tb:function(){Xt(1280)},Mg:function(a,c){N.pi.queryCounterEXT(rn[a],c)},Md:function(a){N.readBuffer(a)},Ne:function(a,c,f,p,v,M,L){if(2<=be.version)if(N.Ji)N.readPixels(a,c,f,p,v,M,L);else{var H=Yo(M);N.readPixels(a,c,f,p,v,M,H,L>>Zo(H))}else(L=Uh(M,v,f,p,L))?N.readPixels(a,c,f,p,v,M,L):Xt(1280)},Me:function(){},Le:function(a,c,f,p){N.renderbufferStorage(a,c,f,p)},od:function(a,c,f,p,v){N.renderbufferStorageMultisample(a,c,f,p,v)},Wb:function(){N.resumeTransformFeedback()},Ke:function(a,c){N.sampleCoverage(a,!!c)},fc:function(a,c,f){N.samplerParameterf(Cr[a],c,f)},ec:function(a,c,f){N.samplerParameterf(Cr[a],c,X[f>>2])},hc:function(a,c,f){N.samplerParameteri(Cr[a],c,f)},gc:function(a,c,f){N.samplerParameteri(Cr[a],c,z[f>>2])},Je:function(a,c,f,p){N.scissor(a,c,f,p)},Ie:function(){Xt(1280)},He:function(a,c,f,p){c=Nw(c,f,p),N.shaderSource(sn[a],c)},Ge:function(a,c,f){N.stencilFunc(a,c,f)},Fe:function(a,c,f,p){N.stencilFuncSeparate(a,c,f,p)},Ee:function(a){N.stencilMask(a)},De:function(a,c){N.stencilMaskSeparate(a,c)},Ce:function(a,c,f){N.stencilOp(a,c,f)},Be:function(a,c,f,p){N.stencilOpSeparate(a,c,f,p)},Ae:function(a,c,f,p,v,M,L,H,Q){if(2<=be.version)if(N.oi)N.texImage2D(a,c,f,p,v,M,L,H,Q);else if(Q){var ct=Yo(H);N.texImage2D(a,c,f,p,v,M,L,H,ct,Q>>Zo(ct))}else N.texImage2D(a,c,f,p,v,M,L,H,null);else N.texImage2D(a,c,f,p,v,M,L,H,Q?Uh(H,L,p,v,Q):null)},Kd:function(a,c,f,p,v,M,L,H,Q,ct){if(N.oi)N.texImage3D(a,c,f,p,v,M,L,H,Q,ct);else if(ct){var ut=Yo(Q);N.texImage3D(a,c,f,p,v,M,L,H,Q,ut,ct>>Zo(ut))}else N.texImage3D(a,c,f,p,v,M,L,H,Q,null)},ze:function(a,c,f){N.texParameterf(a,c,f)},ye:function(a,c,f){N.texParameterf(a,c,X[f>>2])},xe:function(a,c,f){N.texParameteri(a,c,f)},we:function(a,c,f){N.texParameteri(a,c,z[f>>2])},Qb:function(a,c,f,p,v){N.texStorage2D(a,c,f,p,v)},Pb:function(a,c,f,p,v,M){N.texStorage3D(a,c,f,p,v,M)},ve:function(a,c,f,p,v,M,L,H,Q){if(2<=be.version)if(N.oi)N.texSubImage2D(a,c,f,p,v,M,L,H,Q);else if(Q){var ct=Yo(H);N.texSubImage2D(a,c,f,p,v,M,L,H,ct,Q>>Zo(ct))}else N.texSubImage2D(a,c,f,p,v,M,L,H,null);else ct=null,Q&&(ct=Uh(H,L,v,M,Q)),N.texSubImage2D(a,c,f,p,v,M,L,H,ct)},Jd:function(a,c,f,p,v,M,L,H,Q,ct,ut){if(N.oi)N.texSubImage3D(a,c,f,p,v,M,L,H,Q,ct,ut);else if(ut){var Nt=Yo(ct);N.texSubImage3D(a,c,f,p,v,M,L,H,Q,ct,Nt,ut>>Zo(Nt))}else N.texSubImage3D(a,c,f,p,v,M,L,H,Q,ct,null)},dd:function(a,c,f,p){a=Fe[a];for(var v=[],M=0;M<c;M++)v.push(q(z[f+4*M>>2]));N.transformFeedbackVaryings(a,v,p)},ue:function(a,c){N.uniform1f(Qt(a),c)},te:function(a,c,f){if(2<=be.version)c&&N.uniform1fv(Qt(a),X,f>>2,c);else{if(288>=c)for(var p=Cs[c-1],v=0;v<c;++v)p[v]=X[f+4*v>>2];else p=X.subarray(f>>2,f+4*c>>2);N.uniform1fv(Qt(a),p)}},se:function(a,c){N.uniform1i(Qt(a),c)},re:function(a,c,f){if(2<=be.version)c&&N.uniform1iv(Qt(a),z,f>>2,c);else{if(288>=c)for(var p=jh[c-1],v=0;v<c;++v)p[v]=z[f+4*v>>2];else p=z.subarray(f>>2,f+4*c>>2);N.uniform1iv(Qt(a),p)}},Tc:function(a,c){N.uniform1ui(Qt(a),c)},Pc:function(a,c,f){c&&N.uniform1uiv(Qt(a),Pt,f>>2,c)},qe:function(a,c,f){N.uniform2f(Qt(a),c,f)},pe:function(a,c,f){if(2<=be.version)c&&N.uniform2fv(Qt(a),X,f>>2,2*c);else{if(144>=c)for(var p=Cs[2*c-1],v=0;v<2*c;v+=2)p[v]=X[f+4*v>>2],p[v+1]=X[f+(4*v+4)>>2];else p=X.subarray(f>>2,f+8*c>>2);N.uniform2fv(Qt(a),p)}},oe:function(a,c,f){N.uniform2i(Qt(a),c,f)},ne:function(a,c,f){if(2<=be.version)c&&N.uniform2iv(Qt(a),z,f>>2,2*c);else{if(144>=c)for(var p=jh[2*c-1],v=0;v<2*c;v+=2)p[v]=z[f+4*v>>2],p[v+1]=z[f+(4*v+4)>>2];else p=z.subarray(f>>2,f+8*c>>2);N.uniform2iv(Qt(a),p)}},Sc:function(a,c,f){N.uniform2ui(Qt(a),c,f)},Oc:function(a,c,f){c&&N.uniform2uiv(Qt(a),Pt,f>>2,2*c)},me:function(a,c,f,p){N.uniform3f(Qt(a),c,f,p)},le:function(a,c,f){if(2<=be.version)c&&N.uniform3fv(Qt(a),X,f>>2,3*c);else{if(96>=c)for(var p=Cs[3*c-1],v=0;v<3*c;v+=3)p[v]=X[f+4*v>>2],p[v+1]=X[f+(4*v+4)>>2],p[v+2]=X[f+(4*v+8)>>2];else p=X.subarray(f>>2,f+12*c>>2);N.uniform3fv(Qt(a),p)}},ke:function(a,c,f,p){N.uniform3i(Qt(a),c,f,p)},je:function(a,c,f){if(2<=be.version)c&&N.uniform3iv(Qt(a),z,f>>2,3*c);else{if(96>=c)for(var p=jh[3*c-1],v=0;v<3*c;v+=3)p[v]=z[f+4*v>>2],p[v+1]=z[f+(4*v+4)>>2],p[v+2]=z[f+(4*v+8)>>2];else p=z.subarray(f>>2,f+12*c>>2);N.uniform3iv(Qt(a),p)}},Rc:function(a,c,f,p){N.uniform3ui(Qt(a),c,f,p)},Nc:function(a,c,f){c&&N.uniform3uiv(Qt(a),Pt,f>>2,3*c)},ie:function(a,c,f,p,v){N.uniform4f(Qt(a),c,f,p,v)},he:function(a,c,f){if(2<=be.version)c&&N.uniform4fv(Qt(a),X,f>>2,4*c);else{if(72>=c){var p=Cs[4*c-1],v=X;f>>=2;for(var M=0;M<4*c;M+=4){var L=f+M;p[M]=v[L],p[M+1]=v[L+1],p[M+2]=v[L+2],p[M+3]=v[L+3]}}else p=X.subarray(f>>2,f+16*c>>2);N.uniform4fv(Qt(a),p)}},ge:function(a,c,f,p,v){N.uniform4i(Qt(a),c,f,p,v)},fe:function(a,c,f){if(2<=be.version)c&&N.uniform4iv(Qt(a),z,f>>2,4*c);else{if(72>=c)for(var p=jh[4*c-1],v=0;v<4*c;v+=4)p[v]=z[f+4*v>>2],p[v+1]=z[f+(4*v+4)>>2],p[v+2]=z[f+(4*v+8)>>2],p[v+3]=z[f+(4*v+12)>>2];else p=z.subarray(f>>2,f+16*c>>2);N.uniform4iv(Qt(a),p)}},Qc:function(a,c,f,p,v){N.uniform4ui(Qt(a),c,f,p,v)},Mc:function(a,c,f){c&&N.uniform4uiv(Qt(a),Pt,f>>2,4*c)},zc:function(a,c,f){a=Fe[a],N.uniformBlockBinding(a,c,f)},ee:function(a,c,f,p){if(2<=be.version)c&&N.uniformMatrix2fv(Qt(a),!!f,X,p>>2,4*c);else{if(72>=c)for(var v=Cs[4*c-1],M=0;M<4*c;M+=4)v[M]=X[p+4*M>>2],v[M+1]=X[p+(4*M+4)>>2],v[M+2]=X[p+(4*M+8)>>2],v[M+3]=X[p+(4*M+12)>>2];else v=X.subarray(p>>2,p+16*c>>2);N.uniformMatrix2fv(Qt(a),!!f,v)}},vd:function(a,c,f,p){c&&N.uniformMatrix2x3fv(Qt(a),!!f,X,p>>2,6*c)},td:function(a,c,f,p){c&&N.uniformMatrix2x4fv(Qt(a),!!f,X,p>>2,8*c)},de:function(a,c,f,p){if(2<=be.version)c&&N.uniformMatrix3fv(Qt(a),!!f,X,p>>2,9*c);else{if(32>=c)for(var v=Cs[9*c-1],M=0;M<9*c;M+=9)v[M]=X[p+4*M>>2],v[M+1]=X[p+(4*M+4)>>2],v[M+2]=X[p+(4*M+8)>>2],v[M+3]=X[p+(4*M+12)>>2],v[M+4]=X[p+(4*M+16)>>2],v[M+5]=X[p+(4*M+20)>>2],v[M+6]=X[p+(4*M+24)>>2],v[M+7]=X[p+(4*M+28)>>2],v[M+8]=X[p+(4*M+32)>>2];else v=X.subarray(p>>2,p+36*c>>2);N.uniformMatrix3fv(Qt(a),!!f,v)}},ud:function(a,c,f,p){c&&N.uniformMatrix3x2fv(Qt(a),!!f,X,p>>2,6*c)},rd:function(a,c,f,p){c&&N.uniformMatrix3x4fv(Qt(a),!!f,X,p>>2,12*c)},ce:function(a,c,f,p){if(2<=be.version)c&&N.uniformMatrix4fv(Qt(a),!!f,X,p>>2,16*c);else{if(18>=c){var v=Cs[16*c-1],M=X;p>>=2;for(var L=0;L<16*c;L+=16){var H=p+L;v[L]=M[H],v[L+1]=M[H+1],v[L+2]=M[H+2],v[L+3]=M[H+3],v[L+4]=M[H+4],v[L+5]=M[H+5],v[L+6]=M[H+6],v[L+7]=M[H+7],v[L+8]=M[H+8],v[L+9]=M[H+9],v[L+10]=M[H+10],v[L+11]=M[H+11],v[L+12]=M[H+12],v[L+13]=M[H+13],v[L+14]=M[H+14],v[L+15]=M[H+15]}}else v=X.subarray(p>>2,p+64*c>>2);N.uniformMatrix4fv(Qt(a),!!f,v)}},sd:function(a,c,f,p){c&&N.uniformMatrix4x2fv(Qt(a),!!f,X,p>>2,8*c)},qd:function(a,c,f,p){c&&N.uniformMatrix4x3fv(Qt(a),!!f,X,p>>2,12*c)},be:function(a){a=Fe[a],N.useProgram(a),N.Uj=a},ae:function(a){N.validateProgram(Fe[a])},$d:function(a,c){N.vertexAttrib1f(a,c)},_d:function(a,c){N.vertexAttrib1f(a,X[c>>2])},Zd:function(a,c,f){N.vertexAttrib2f(a,c,f)},Yd:function(a,c){N.vertexAttrib2f(a,X[c>>2],X[c+4>>2])},Xd:function(a,c,f,p){N.vertexAttrib3f(a,c,f,p)},Wd:function(a,c){N.vertexAttrib3f(a,X[c>>2],X[c+4>>2],X[c+8>>2])},Vd:function(a,c,f,p,v){N.vertexAttrib4f(a,c,f,p,v)},Ud:function(a,c){N.vertexAttrib4f(a,X[c>>2],X[c+4>>2],X[c+8>>2],X[c+12>>2])},ac:function(a,c){N.vertexAttribDivisor(a,c)},zg:function(a,c){N.vertexAttribDivisor(a,c)},Mb:function(a,c){N.vertexAttribDivisor(a,c)},Qd:function(a,c){N.vertexAttribDivisor(a,c)},Nb:function(a,c){N.vertexAttribDivisor(a,c)},Zc:function(a,c,f,p,v){N.vertexAttribI4i(a,c,f,p,v)},Xc:function(a,c){N.vertexAttribI4i(a,z[c>>2],z[c+4>>2],z[c+8>>2],z[c+12>>2])},Yc:function(a,c,f,p,v){N.vertexAttribI4ui(a,c,f,p,v)},Wc:function(a,c){N.vertexAttribI4ui(a,Pt[c>>2],Pt[c+4>>2],Pt[c+8>>2],Pt[c+12>>2])},ad:function(a,c,f,p,v){N.vertexAttribIPointer(a,c,f,p,v)},Sd:function(a,c,f,p,v,M){N.vertexAttribPointer(a,c,f,!!p,v,M)},Rd:function(a,c,f,p){N.viewport(a,c,f,p)},rc:function(a,c,f,p){N.waitSync(Xo[a],c,(f>>>0)+4294967296*p)},Eb:function(a){var c=A.length;if(a>>>=0,2147483648<a)return!1;for(var f=1;4>=f;f*=2){var p=c*(1+.2/f);p=Math.min(p,a+100663296);var v=Math;p=Math.max(a,p),v=v.min.call(v,2147483648,p+(65536-p%65536)%65536);t:{try{B.grow(v-U.byteLength+65535>>>16),lt();var M=1;break t}catch{}M=void 0}if(M)return!0}return!1},va:function(a,c){return c>>=2,c={alpha:!!z[c],depth:!!z[c+1],stencil:!!z[c+2],antialias:!!z[c+3],premultipliedAlpha:!!z[c+4],preserveDrawingBuffer:!!z[c+5],powerPreference:GC[z[c+6]],failIfMajorPerformanceCaveat:!!z[c+7],Cj:z[c+8],ol:z[c+9],Wj:z[c+10],uk:z[c+11],sl:z[c+12],tl:z[c+13]},typeof a=="number"&&(a=q(a)),a=a&&a!=="#canvas"?typeof ep<"u"&&Nd[a]?Nd[a]:qC(a):typeof ep<"u"&&Nd.canvas?Nd.canvas:e.canvas,!a||c.uk?0:Dw(a,c)},yc:function(a){if(be==a&&(be=0),be===$r[a]&&(be=null),typeof WC=="object"){for(var c=$r[a].Qi.canvas,f=0;f<Ld.length;++f)if(Ld[f].target==c){var p=f--,v=Ld[p];v.target.removeEventListener(v.il,v.hl,v.vl),Ld.splice(p,1)}}$r[a]&&$r[a].Qi.canvas&&($r[a].Qi.canvas.lk=void 0),$r[a]=null},cd:function(a){a>>=2;for(var c=0;14>c;++c)z[a+c]=0;z[a]=z[a+1]=z[a+3]=z[a+4]=z[a+8]=z[a+10]=1},Jc:function(a){return Ow(a)?0:-5},Ab:function(a,c){var f=0;return Fw().forEach(function(p,v){var M=c+f;for(v=Pt[a+4*v>>2]=M,M=0;M<p.length;++M)J[v++>>0]=p.charCodeAt(M);J[v>>0]=0,f+=p.length+1}),0},Bb:function(a,c){var f=Fw();Pt[a>>2]=f.length;var p=0;return f.forEach(function(v){p+=v.length+1}),Pt[c>>2]=p,0},la:xw,sa:function(a){try{var c=ai(a);return Et(c),0}catch(f){if(typeof nn>"u"||!(f instanceof Bt))throw f;return f.Gi}},Fb:function(a,c,f,p){try{t:{var v=ai(a);a=c;for(var M=c=0;M<f;M++){var L=Pt[a>>2],H=Pt[a+4>>2];a+=8;var Q=v,ct=L,ut=H,Nt=void 0,qt=J;if(0>ut||0>Nt)throw new Bt(28);if(Q.fd===null)throw new Bt(8);if((Q.flags&2097155)===1)throw new Bt(8);if((Q.node.mode&61440)===16384)throw new Bt(31);if(!Q.ii.read)throw new Bt(28);var et=typeof Nt<"u";if(!et)Nt=Q.position;else if(!Q.seekable)throw new Bt(70);var wt=Q.ii.read(Q,qt,ct,ut,Nt);et||(Q.position+=wt);var Kt=wt;if(0>Kt){var Pe=-1;break t}if(c+=Kt,Kt<H)break}Pe=c}return Pt[p>>2]=Pe,0}catch($e){if(typeof nn>"u"||!($e instanceof Bt))throw $e;return $e.Gi}},xb:function(a,c,f,p,v){try{if(c=f+2097152>>>0<4194305-!!c?(c>>>0)+4294967296*f:NaN,isNaN(c))return 61;var M=ai(a);return Ht(M,c,p),nt=[M.position>>>0,(W=M.position,1<=+Math.abs(W)?0<W?(Math.min(+Math.floor(W/4294967296),4294967295)|0)>>>0:~~+Math.ceil((W-+(~~W>>>0))/4294967296)>>>0:0)],z[v>>2]=nt[0],z[v+4>>2]=nt[1],M.xj&&c===0&&p===0&&(M.xj=null),0}catch(L){if(typeof nn>"u"||!(L instanceof Bt))throw L;return L.Gi}},ta:function(a,c,f,p){try{t:{var v=ai(a);a=c;for(var M=c=0;M<f;M++){var L=Pt[a>>2],H=Pt[a+4>>2];a+=8;var Q=ve(v,J,L,H);if(0>Q){var ct=-1;break t}c+=Q}ct=c}return Pt[p>>2]=ct,0}catch(ut){if(typeof nn>"u"||!(ut instanceof Bt))throw ut;return ut.Gi}},ga:function(a){N.activeTexture(a)},oa:function(a,c){N.attachShader(Fe[a],sn[c])},_g:function(a,c){N.beginQuery(a,rn[c])},ca:function(a,c){a==35051?N.Ji=c:a==35052&&(N.oi=c),N.bindBuffer(a,Ir[c])},fa:function(a,c){N.bindFramebuffer(a,wo[c])},eb:function(a,c){N.bindRenderbuffer(a,xr[c])},ib:function(a,c){N.bindTexture(a,nr[c])},Wa:function(a,c){N.blendFunc(a,c)},Xa:function(a,c,f,p){N.blendFuncSeparate(a,c,f,p)},xh:function(a,c,f,p){2<=be.version?f&&c?N.bufferData(a,A,p,f,c):N.bufferData(a,c,p):N.bufferData(a,f?A.subarray(f,f+c):c,p)},wh:function(a,c,f,p){2<=be.version?f&&N.bufferSubData(a,c,A,p,f):N.bufferSubData(a,c,A.subarray(p,p+f))},s:function(a){N.clear(a)},Za:function(a,c,f,p){N.clearColor(a,c,f,p)},Ya:function(a){N.clearStencil(a)},ab:function(a,c,f,p){N.colorMask(!!a,!!c,!!f,!!p)},oh:function(a){N.compileShader(sn[a])},Ia:function(){var a=Jo(Fe),c=N.createProgram();return c.name=a,c.Ci=c.Ai=c.Bi=0,c.rj=1,Fe[a]=c,a},qh:function(a){var c=Jo(sn);return sn[c]=N.createShader(a),c},gb:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=Ir[p];v&&(N.deleteBuffer(v),v.name=0,Ir[p]=null,p==N.Ji&&(N.Ji=0),p==N.oi&&(N.oi=0))}},cb:function(a,c){for(var f=0;f<a;++f){var p=z[c+4*f>>2],v=wo[p];v&&(N.deleteFramebuffer(v),v.name=0,wo[p]=null)}},nh:function(a){if(a){var c=Fe[a];c?(N.deleteProgram(c),c.name=0,Fe[a]=null):Xt(1281)}},$g:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=rn[p];v&&(N.deleteQuery(v),rn[p]=null)}},db:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=xr[p];v&&(N.deleteRenderbuffer(v),v.name=0,xr[p]=null)}},rh:function(a){if(a){var c=sn[a];c?(N.deleteShader(c),sn[a]=null):Xt(1281)}},hb:function(a,c){for(var f=0;f<a;f++){var p=z[c+4*f>>2],v=nr[p];v&&(N.deleteTexture(v),v.name=0,nr[p]=null)}},Va:function(a){N.depthFunc(a)},$a:function(a){N.depthMask(!!a)},Ua:function(a,c){N.depthRange(a,c)},Oa:function(a){N.disable(a)},I:function(a){N.disableVertexAttribArray(a)},U:function(a,c,f){N.drawArrays(a,c,f)},Ba:function(a,c,f,p){N.drawArraysInstanced(a,c,f,p)},fh:function(a,c){for(var f=Ra[a],p=0;p<a;p++)f[p]=z[c+4*p>>2];N.drawBuffers(f)},Ga:Rw,Ca:function(a,c,f,p,v){N.drawElementsInstanced(a,c,f,p,v)},Pa:function(a){N.enable(a)},E:function(a){N.enableVertexAttribArray(a)},Zg:function(a){N.endQuery(a)},ih:function(){N.finish()},Ea:function(a,c,f,p){N.framebufferRenderbuffer(a,c,f,xr[p])},eh:function(a,c,f,p,v){N.framebufferTexture2D(a,c,f,nr[p],v)},_a:function(a){N.frontFace(a)},yh:function(a,c){xs(a,c,"createBuffer",Ir)},Fa:function(a,c){xs(a,c,"createFramebuffer",wo)},ah:function(a,c){xs(a,c,"createQuery",rn)},hh:function(a,c){xs(a,c,"createRenderbuffer",xr)},th:function(a,c){xs(a,c,"createTexture",nr)},vh:function(a){N.generateMipmap(a)},kh:function(a,c,f,p,v,M,L){Od("getActiveAttrib",a,c,f,p,v,M,L)},jh:function(a,c,f,p,v,M,L){Od("getActiveUniform",a,c,f,p,v,M,L)},mh:function(a,c){return N.getAttribLocation(Fe[a],q(c))},kb:function(a,c){La(a,c,4)},mb:function(){var a=N.getError()||ql;return ql=0,a},W:function(a,c){La(a,c,2)},n:function(a,c){La(a,c,0)},ba:function(a,c,f){if(f)if(a>=Qg)Xt(1281);else if(a=Fe[a],c==35716)a=N.getProgramInfoLog(a),a===null&&(a="(unknown error)"),z[f>>2]=a.length+1;else if(c==35719){if(!a.Ci)for(c=0;c<N.getProgramParameter(a,35718);++c)a.Ci=Math.max(a.Ci,N.getActiveUniform(a,c).name.length+1);z[f>>2]=a.Ci}else if(c==35722){if(!a.Ai)for(c=0;c<N.getProgramParameter(a,35721);++c)a.Ai=Math.max(a.Ai,N.getActiveAttrib(a,c).name.length+1);z[f>>2]=a.Ai}else if(c==35381){if(!a.Bi)for(c=0;c<N.getProgramParameter(a,35382);++c)a.Bi=Math.max(a.Bi,N.getActiveUniformBlockName(a,c).length+1);z[f>>2]=a.Bi}else z[f>>2]=N.getProgramParameter(a,c);else Xt(1281)},za:function(a,c,f){if(f){a=N.getQueryParameter(rn[a],c);var p;typeof a=="boolean"?p=a?1:0:p=a,z[f>>2]=p}else Xt(1281)},lb:function(a,c,f,p){a=N.getShaderPrecisionFormat(a,c),z[f>>2]=a.rangeMin,z[f+4>>2]=a.rangeMax,z[p>>2]=a.precision},ra:function(a){var c=Dd[a];if(!c){switch(a){case 7939:c=N.getSupportedExtensions()||[],c=c.concat(c.map(function(p){return"GL_"+p})),c=vo(c.join(" "));break;case 7936:case 7937:case 37445:case 37446:(c=N.getParameter(a))||Xt(1280),c=c&&vo(c);break;case 7938:c=N.getParameter(7938),c=2<=be.version?"OpenGL ES 3.0 ("+c+")":"OpenGL ES 2.0 ("+c+")",c=vo(c);break;case 35724:c=N.getParameter(35724);var f=c.match(/^WebGL GLSL ES ([0-9]\.[0-9][0-9]?)(?:$| .*)/);f!==null&&(f[1].length==3&&(f[1]+="0"),c="OpenGL ES GLSL ES "+f[1]+" ("+c+")"),c=vo(c);break;default:Xt(1280)}Dd[a]=c}return c},lh:function(a,c){if(c=q(c),a=Fe[a]){np(a);var f=a.Pi,p=0,v=c,M=ip(c);if(0<M&&(p=parseInt(c.slice(M+1))>>>0,v=c.slice(0,M)),(v=a.sj[v])&&p<v[0]&&(p+=v[1],f[p]=f[p]||N.getUniformLocation(a,c)))return p}else Xt(1281);return-1},O:function(a){return N.isEnabled(a)},Ha:function(a){a=Fe[a],N.linkProgram(a),a.Pi=0,a.sj={}},bb:function(a,c){a==3317&&(tp=c),N.pixelStorei(a,c)},Ta:function(a,c){N.polygonOffset(a,c)},dh:function(a,c,f,p,v,M,L){if(2<=be.version)if(N.Ji)N.readPixels(a,c,f,p,v,M,L);else{var H=Yo(M);N.readPixels(a,c,f,p,v,M,H,L>>Zo(H))}else(L=Uh(M,v,f,p,L))?N.readPixels(a,c,f,p,v,M,L):Xt(1280)},gh:function(a,c,f,p){N.renderbufferStorage(a,c,f,p)},Sa:function(a,c,f,p){N.scissor(a,c,f,p)},ph:function(a,c,f,p){c=Nw(c,f,p),N.shaderSource(sn[a],c)},ea:function(a,c,f){N.stencilFunc(a,c,f)},V:function(a,c,f,p){N.stencilFuncSeparate(a,c,f,p)},Ra:function(a){N.stencilMask(a)},qa:function(a,c){N.stencilMaskSeparate(a,c)},Qa:function(a,c,f){N.stencilOp(a,c,f)},pa:function(a,c,f,p){N.stencilOpSeparate(a,c,f,p)},$:function(a,c,f,p,v,M,L,H,Q){if(2<=be.version)if(N.oi)N.texImage2D(a,c,f,p,v,M,L,H,Q);else if(Q){var ct=Yo(H);N.texImage2D(a,c,f,p,v,M,L,H,ct,Q>>Zo(ct))}else N.texImage2D(a,c,f,p,v,M,L,H,null);else N.texImage2D(a,c,f,p,v,M,L,H,Q?Uh(H,L,p,v,Q):null)},uh:function(a,c,f){N.texParameterf(a,c,f)},G:function(a,c,f){N.texParameteri(a,c,f)},q:function(a,c){N.uniform1f(Qt(a),c)},N:function(a,c,f){if(2<=be.version)c&&N.uniform1fv(Qt(a),X,f>>2,c);else{if(288>=c)for(var p=Cs[c-1],v=0;v<c;++v)p[v]=X[f+4*v>>2];else p=X.subarray(f>>2,f+4*c>>2);N.uniform1fv(Qt(a),p)}},k:function(a,c){N.uniform1i(Qt(a),c)},y:function(a,c,f){N.uniform2f(Qt(a),c,f)},Da:function(a,c,f){if(2<=be.version)c&&N.uniform2fv(Qt(a),X,f>>2,2*c);else{if(144>=c)for(var p=Cs[2*c-1],v=0;v<2*c;v+=2)p[v]=X[f+4*v>>2],p[v+1]=X[f+(4*v+4)>>2];else p=X.subarray(f>>2,f+8*c>>2);N.uniform2fv(Qt(a),p)}},ch:function(a,c,f){N.uniform2i(Qt(a),c,f)},ma:function(a,c,f,p){N.uniform3f(Qt(a),c,f,p)},F:function(a,c,f){if(2<=be.version)c&&N.uniform3fv(Qt(a),X,f>>2,3*c);else{if(96>=c)for(var p=Cs[3*c-1],v=0;v<3*c;v+=3)p[v]=X[f+4*v>>2],p[v+1]=X[f+(4*v+4)>>2],p[v+2]=X[f+(4*v+8)>>2];else p=X.subarray(f>>2,f+12*c>>2);N.uniform3fv(Qt(a),p)}},T:function(a,c,f,p,v){N.uniform4f(Qt(a),c,f,p,v)},r:function(a,c,f){if(2<=be.version)c&&N.uniform4fv(Qt(a),X,f>>2,4*c);else{if(72>=c){var p=Cs[4*c-1],v=X;f>>=2;for(var M=0;M<4*c;M+=4){var L=f+M;p[M]=v[L],p[M+1]=v[L+1],p[M+2]=v[L+2],p[M+3]=v[L+3]}}else p=X.subarray(f>>2,f+16*c>>2);N.uniform4fv(Qt(a),p)}},na:function(a,c,f,p){if(2<=be.version)c&&N.uniformMatrix3fv(Qt(a),!!f,X,p>>2,9*c);else{if(32>=c)for(var v=Cs[9*c-1],M=0;M<9*c;M+=9)v[M]=X[p+4*M>>2],v[M+1]=X[p+(4*M+4)>>2],v[M+2]=X[p+(4*M+8)>>2],v[M+3]=X[p+(4*M+12)>>2],v[M+4]=X[p+(4*M+16)>>2],v[M+5]=X[p+(4*M+20)>>2],v[M+6]=X[p+(4*M+24)>>2],v[M+7]=X[p+(4*M+28)>>2],v[M+8]=X[p+(4*M+32)>>2];else v=X.subarray(p>>2,p+36*c>>2);N.uniformMatrix3fv(Qt(a),!!f,v)}},t:function(a,c,f,p){if(2<=be.version)c&&N.uniformMatrix4fv(Qt(a),!!f,X,p>>2,16*c);else{if(18>=c){var v=Cs[16*c-1],M=X;p>>=2;for(var L=0;L<16*c;L+=16){var H=p+L;v[L]=M[H],v[L+1]=M[H+1],v[L+2]=M[H+2],v[L+3]=M[H+3],v[L+4]=M[H+4],v[L+5]=M[H+5],v[L+6]=M[H+6],v[L+7]=M[H+7],v[L+8]=M[H+8],v[L+9]=M[H+9],v[L+10]=M[H+10],v[L+11]=M[H+11],v[L+12]=M[H+12],v[L+13]=M[H+13],v[L+14]=M[H+14],v[L+15]=M[H+15]}}else v=X.subarray(p>>2,p+64*c>>2);N.uniformMatrix4fv(Qt(a),!!f,v)}},fb:function(a){a=Fe[a],N.useProgram(a),N.Uj=a},Aa:function(a,c){N.vertexAttrib1f(a,c)},bh:function(a,c,f,p,v){N.vertexAttrib4f(a,c,f,p,v)},H:function(a,c){N.vertexAttribDivisor(a,c)},C:function(a,c,f,p,v,M){N.vertexAttribPointer(a,c,f,!!p,v,M)},jb:function(a,c,f,p){N.viewport(a,c,f,p)},sh:function(a,c,f,p,v){Kg(),a=A.subarray(a,a+c),c=null,f=["image/jpeg","image/png","image/gif","image/bmp","image/svg+xml"][f];var M=[N.LUMINANCE,N.LUMINANCE_ALPHA,N.RGB,N.RGBA][p-1];if(M===void 0&&(M=N.RGBA),$l)try{c=new Blob([a],{type:f}),c.size!==a.length&&(c=new Blob([new Uint8Array(a).buffer],{type:f}))}catch{}c||(f=new Zg,f.append(new Uint8Array(a).buffer),c=f.getBlob());var L=Kl("wrapperTexturePreLoad","number",["number","number","number","number"]),H=Kl("wrapperTexturePostLoad",null,["number","number","number"]),Q=Kl("wrapperTextureOnError",null,["number","number"]),ct=Ko.createObjectURL(c),ut=document.createElement("img"),Nt=e.$$facade;ut.onload=function(){if(Nt===e.$$facade){var qt=1;L&&(qt=L(v,ut.width,ut.height,p));var et=0;if(qt)try{N.texImage2D(N.TEXTURE_2D,0,M,M,N.UNSIGNED_BYTE,ut),et=1}catch{}H&&H(0,v,et)}else H&&H(1,v,0);Ko.revokeObjectURL(ct)},ut.onerror=function(){Nt===e.$$facade?Q&&Q(0,v):Q&&Q(1,v),Ko.revokeObjectURL(ct)},ut.src=ct},ya:function(){return e.bj?Fa.close.apply(Fa,arguments):Ba.close.apply(Ba,arguments)},Yg:function(){window.addEventListener("beforeunload",function(){e.bj?Fa.close():Ba.close()})},Xg:function(a,c,f){return e.bk=0,self.bowser.chrome&&0>self.bowser.compareVersions([self.bowser.version,"68"])&&(e.bj=!0),e.bj?Fa.connect.apply(Fa,arguments):Ba.connect.apply(Ba,arguments)},Wg:function(a,c){return e.bj?Fa.Jj.apply(Fa,arguments):Ba.Jj.apply(Ba,arguments)},zb:function(a,c,f,p){return KC(a,c,f,p)}};(function(){function a(v){e.asm=v.exports,B=e.asm.Ih,lt(),at=e.asm.Kh,kt.unshift(e.asm.Jh),Ve()}function c(v){a(v.instance)}function f(v){return $().then(function(M){return WebAssembly.instantiate(M,p)}).then(function(M){return M}).then(v,function(M){P("failed to asynchronously prepare wasm: "+M),Le(M)})}var p={a:YC};if(We(),e.instantiateWasm)try{return e.instantiateWasm(p,a)}catch(v){P("Module.instantiateWasm callback failed with error: "+v),n(v)}return function(){return k||typeof WebAssembly.instantiateStreaming!="function"||yn()||T.startsWith("file://")||d||typeof fetch!="function"?f(c):fetch(T,{credentials:"same-origin"}).then(function(v){return WebAssembly.instantiateStreaming(v,p).then(c,function(M){return P("wasm streaming compile failed: "+M),P("falling back to ArrayBuffer instantiation"),f(c)})})}().catch(n),{}})(),e.___wasm_call_ctors=function(){return(e.___wasm_call_ctors=e.asm.Jh).apply(null,arguments)},e._callFuncWrapper=function(){return(e._callFuncWrapper=e.asm.Lh).apply(null,arguments)},e._main=function(){return(e._main=e.asm.Mh).apply(null,arguments)},e._wrapperTexturePreLoad=function(){return(e._wrapperTexturePreLoad=e.asm.Nh).apply(null,arguments)},e._wrapperTexturePostLoad=function(){return(e._wrapperTexturePostLoad=e.asm.Oh).apply(null,arguments)},e._wrapperTextureOnError=function(){return(e._wrapperTextureOnError=e.asm.Ph).apply(null,arguments)};var qr=e._free=function(){return(qr=e._free=e.asm.Qh).apply(null,arguments)},jw=e.___errno_location=function(){return(jw=e.___errno_location=e.asm.Rh).apply(null,arguments)},Wh=e._malloc=function(){return(Wh=e._malloc=e.asm.Sh).apply(null,arguments)};e._webSocketHandlerOnMessage=function(){return(e._webSocketHandlerOnMessage=e.asm.Th).apply(null,arguments)};var Ww=e.___getTypeName=function(){return(Ww=e.___getTypeName=e.asm.Uh).apply(null,arguments)};e.__embind_initialize_bindings=function(){return(e.__embind_initialize_bindings=e.asm.Vh).apply(null,arguments)};var Vd=e.stackSave=function(){return(Vd=e.stackSave=e.asm.Wh).apply(null,arguments)},zd=e.stackRestore=function(){return(zd=e.stackRestore=e.asm.Xh).apply(null,arguments)},Gh=e.stackAlloc=function(){return(Gh=e.stackAlloc=e.asm.Yh).apply(null,arguments)};e.dynCall_viiijiiiiiiiiiii=function(){return(e.dynCall_viiijiiiiiiiiiii=e.asm.Zh).apply(null,arguments)},e.dynCall_iij=function(){return(e.dynCall_iij=e.asm._h).apply(null,arguments)},e.dynCall_iiiiiijii=function(){return(e.dynCall_iiiiiijii=e.asm.$h).apply(null,arguments)},e.dynCall_jiji=function(){return(e.dynCall_jiji=e.asm.ai).apply(null,arguments)},e.dynCall_viijii=function(){return(e.dynCall_viijii=e.asm.bi).apply(null,arguments)},e.dynCall_iiiiij=function(){return(e.dynCall_iiiiij=e.asm.ci).apply(null,arguments)},e.dynCall_iiiiijj=function(){return(e.dynCall_iiiiijj=e.asm.di).apply(null,arguments)},e.dynCall_iiiiiijj=function(){return(e.dynCall_iiiiiijj=e.asm.ei).apply(null,arguments)},e.___emscripten_embedded_file_data=662400,e.addRunDependency=We,e.removeRunDependency=Ve,e.FS_createPath=Ri,e.FS_createDataFile=bs,e.FS_createPreloadedFile=Ur,e.FS_createLazyFile=is,e.FS_createDevice=Mn,e.FS_unlink=F,e.ccall=ap,e.cwrap=Kl;var Hd;Se=function a(){Hd||Gw(),Hd||(Se=a)};function Gw(){function a(){if(!Hd&&(Hd=!0,e.calledRun=!0,!j)){if(e.noFSInit||en||(en=!0,oi(),e.stdin=e.stdin,e.stdout=e.stdout,e.stderr=e.stderr,e.stdin?Mn("/dev","stdin",e.stdin):E("/dev/tty","/dev/stdin"),e.stdout?Mn("/dev","stdout",null,e.stdout):E("/dev/tty","/dev/stdout"),e.stderr?Mn("/dev","stderr",null,e.stderr):E("/dev/tty1","/dev/stderr"),mt("/dev/stdin",0),mt("/dev/stdout",1),mt("/dev/stderr",1)),yo=!1,ot(kt),ot(Ft),i(e),e.onRuntimeInitialized&&e.onRuntimeInitialized(),$w){var c=e._main;try{var f=c(0,0);xw(f,!0)}catch(p){Cw(p)}}if(e.postRun)for(typeof e.postRun=="function"&&(e.postRun=[e.postRun]);e.postRun.length;)c=e.postRun.shift(),ni.unshift(c);ot(ni)}}if(!(0<oe)){if(e.preRun)for(typeof e.preRun=="function"&&(e.preRun=[e.preRun]);e.preRun.length;)ji();ot(Gt),0<oe||(e.setStatus?(e.setStatus("Running..."),setTimeout(function(){setTimeout(function(){e.setStatus("")},1),a()},1)):a())}}if(e.preInit)for(typeof e.preInit=="function"&&(e.preInit=[e.preInit]);0<e.preInit.length;)e.preInit.pop()();var $w=!0;return e.noInitialRun&&($w=!1),Gw(),t.ready}})();window.bowser=ev;const _n=class _n{static async createInstance(t){const e={isWrapper:!0,base:{},args:t,enginePath:t.enginePath??_n.defaultEnginePath};return await _n.createScInstance(e),e.base}static catchExceptions(t,e){return function(...i){try{e.apply(this,i)}catch(n){console.log("Unhandled exception in "+t+"():"),console.log(n)}}}static getElement(t){return typeof t!="string"?t:document.getElementById(t)}static getAvailableCore(){for(const t of _n.core_pool)if(t.$$available)return t;return null}static async getWasmBinary(t){if(_n.defaultBinary)return _n.defaultBinary;const e=new URL((t||"")+"/engine.esm.wasm",window.location.toString()),i=await fetch(e);if(!i.ok)return;const n=await i.arrayBuffer();return new Uint8Array(n)}static createRenderCanvas(t){const e=t.containers.get(ke.Default);let i=new OffscreenCanvas(e.clientWidth,e.clientHeight);return i.getContext("webgl2")||(console.debug("WebGL2 context not supported with OffscreenCanvas, fallback with HTMLCanvasElement"),i=document.createElement("canvas"),i.width=e.clientWidth,i.height=e.clientHeight),i}static createCore(t,e){console.assert(t.canvas!==void 0);const i={$$available:!1,$$facade:t,callAfterMap:{index:0,indexedWrappers:{}},canvas:t.canvas,wasmBinary:e};return _n.core_pool.push(i),i}static async getCore(t,e){let i=_n.getAvailableCore();const n=!i;if(n?t.canvas=_n.createRenderCanvas(t):t.canvas=i==null?void 0:i.canvas,i===null){const r=await _n.getWasmBinary(e.enginePath);if(r===void 0)throw typeof e.onError=="function"&&e.onError("Unable to load engine binary"),"Unable to load engine binary";i=_n.createCore(t,r)}return i.$$available=!1,i.$$facade=t,i.$$onReady=_n.catchExceptions("onReady",function(){const r=e.onReady;typeof r=="function"&&r(t)}),typeof e.onError=="function"&&(i.onAbort=_n.catchExceptions("onError",function(r){e.onError("fatal error: see console "+r)})),typeof e.enginePath=="string"&&(i.locateFile=r=>`${e.enginePath}/${r}`),{core:i,isNew:n}}static getFacade(t){let e,i;e=t.base,i=t.args;const n=_n.getElement(i.container);if(!n)throw new TypeError("'container' argument is missing or invalid");e.containers=new Map,e.containers.set(ke.Default,n);const r=this.createWrapper();return e.wrappers=new Map,e.wrappers.set(ke.Default,r),{facade:e,args:i}}static setupNewView(t,e,i){const n=_n.getElement(i),r=this.createWrapper();if(t.wrappers.set(e,r),!n)throw new TypeError("'container' argument is missing or invalid");t.containers.set(e,n),this.createSubContainer(t,e)}static createWrapper(){const t=document.createElement("div");return t.setAttribute("style","position: absolute; overflow: hidden; width: 100%; height: 100%; padding: 0; margin: 0; border: 0;"),t}static createSubContainer(t,e){const i=document.createElement("div");i.setAttribute("style","position: relative; overflow: hidden; width: 100%; height: 100%; padding: 0; margin: 0; border: 0;");const n=document.createElement("div");n.setAttribute("style","position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 0; margin: 0; border: 0;"),n.onmousedown=function(l){l.preventDefault()},n.oncontextmenu=function(l){l.preventDefault()};const r=t.wrappers.get(e);i.appendChild(r),i.appendChild(n);const o=t.containers.get(e);return o.innerHTML="",o.appendChild(i),i}static async createScInstance(t){const{facade:e,args:i}=_n.getFacade(t),{core:n,isNew:r}=await _n.getCore(e,i);return _n.createSubContainer(e,ke.Default),r?iv(n):setTimeout(function(){n.$$setReady&&n.$$setReady()}),e}};_n.core_pool=[];let eo=_n;const nv=Object.freeze(Object.defineProperty({__proto__:null,AntiAliasingMode:qa,AttachScope:ta,BimMask:ln,BimType:nc,BlurIntervalUnit:sc,ColorType:An,CullingVectorSpace:Ep,CuttingSectionKey:$a,DataKey:eu,DrawMode:ar,DrawStrategy:Ap,ElementMask:Tp,ElementType:an,GroupKey:Cp,HighlightFilter:Ar,HighlightMode:nu,ImageFormat:xo,ImageKey:Sp,InclusionKey:ki,InstanceKey:of,Key:rf,LightKey:Pp,LightSpace:Mp,LightType:iu,LinePatternLengthUnit:Np,MasterModelKey:Er,MatrixKey:kp,MeshKey:ic,ModelKey:fs,OverlayAnchor:lr,OverlayUnit:Ka,PointShape:Dp,PointSizeUnit:Op,Projection:rc,SessionType:Xi,SetVisibility:to,SimpleReflectionAttenuationUnit:af,SmaaQuality:Rp,StateFailure:lf,StreamcacheModule:eo,TextureInterpolation:su,TextureMipMapping:ru,TextureModifier:oc,TextureParameterization:ou,TextureTiling:au,TransparencyMode:Lp,UnspecifiedMeasurementUnit:As,ViewKey:ke,XRayGroup:lu,getStateFailure:Fp,isError:ea},Symbol.toStringTag,{value:"Module"}));function hu(s){const t=new Map;return s.forEach((e,i)=>{t.set(i,e)}),t}function sv(s){const t=new Set;return s.forEach(e=>{t.add(e)}),t}function ac(s){const t=new Set;for(const e of s)t.add(e);return t}function io(s){const t=[];return s.forEach(e=>{t.push(e)}),t}function cf(s,t){const e=io(s).filter(i=>!t.has(i));return ac(e)}function uu(s){const t={origin:[],direction:[]};return s.origin.toArray(t.origin),s.direction.toArray(t.direction),t}function du(s){const t=new Lm;return t.pos1.fromArray(s.point1),t.pos2.fromArray(s.point2),t.distance=s.distance,t}function ne(s,t){return(s&t)===t}function na(s,t,e){return e?s|t:s&~t}function rv(s){let t="";const e=s.byteLength;for(let i=0;i<e;i++)t+=String.fromCharCode(s[i]);return window.btoa(t)}function zp(s){let t=Math.abs(s.x),e=Math.abs(s.y),i=Math.abs(s.z);return t=+t.toFixed(6),e=+e.toFixed(6),i=+i.toFixed(6),t>e&&t>i?new _(1,0,0):e>t&&e>i?new _(0,1,0):i>t&&i>e?new _(0,0,1):null}function lc(s){return JSON.parse(JSON.stringify(s))}function ov(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&(t[e]=s[e])}function Xa(s,t){return s===void 0?t:s}function cc(s,t){const e=s.length>t.length?s.length:t.length;for(let i=0;i<e;++i){const n=s[i]||0,r=t[i]||0;if(n>r)return!0;if(n<r)return!1}return!0}function Hp(s){if(s.length===0)return"";let t=`${s[0]}`;for(let e=1;e<s.length;++e)t+=`.${s[e]}`;return t}function av(){return window.crypto||window.msCrypto}const lv="²",cv="³";function Up(s){if(s instanceof Map)return s;const t=new Map,e=Object.keys(s);for(const i of e){const n=s[i];t.set(parseInt(i,10),n)}return t}const jp=new Map;function ss(s,t){jp.set(s,t)}function hf(s){return jp.get(s)}const Ts=-1;function Ja(s){return console.assert(s!==Ts),s>Ts}function hv(s){return console.assert(Ja(s)),s}function Co(s,t){return Ja(s)?Gi(t).toRuntimeId(s):s}class uf{static parseXml(t){console.assert(t.localName==="Material");let e=null,i=null;const n=t.getAttribute("Color");if(n!==null){const r=n.split(" ");if(r.length!==4)throw new ii('Expected "Color" attribute to have four channel components.');const o=parseFloat(r[0]),l=parseFloat(r[1]),h=parseFloat(r[2]),u=parseFloat(r[3]);e=new vt(o,l,h),i=u}return new uf(e,i)}constructor(t,e){t!==null&&(this._color=t),e!==null&&(this._alpha=e)}getColor(){return this._color!==void 0?this._color:null}getAlpha(){return this._alpha!==void 0?this._alpha:null}}var Qe=(s=>(s[s.Id=1]="Id",s[s.Name=2]="Name",s[s.Visiblity=4]="Visiblity",s[s.Transform=8]="Transform",s[s.SubNodes=16]="SubNodes",s[s.Instance=32]="Instance",s[s.InstanceQuickAccess=64]="InstanceQuickAccess",s[s.BodyInstances=128]="BodyInstances",s[s.Attributes=256]="Attributes",s[s.PartDataLink=512]="PartDataLink",s[s.Bodies=1024]="Bodies",s[s.FaceMeasurement=2048]="FaceMeasurement",s[s.EdgeMeasurement=4096]="EdgeMeasurement",s[s.MeshKey=8192]="MeshKey",s[s.Unit=16384]="Unit",s[s.Views=32768]="Views",s[s.Pmis=65536]="Pmis",s[s.ScInclusionKey=131072]="ScInclusionKey",s[s.ScInstanceKey=262144]="ScInstanceKey",s[s.ExternalModel=524288]="ExternalModel",s[s.PhysicalProperties=1048576]="PhysicalProperties",s[s.VersionNumber=2097152]="VersionNumber",s[s.ProductBits=4194304]="ProductBits",s[s.Header=8388608]="Header",s[s.FrontUpVector=16777216]="FrontUpVector",s[s.ExchangeId=33554432]="ExchangeId",s[s.LayerId=67108864]="LayerId",s[s.LayerList=134217728]="LayerList",s[s.Filters=268435456]="Filters",s[s.UserData=536870912]="UserData",s[s.UseNodeParseBits2=1073741824]="UseNodeParseBits2",s))(Qe||{}),cr=(s=>(s[s.FaceAttributes=1]="FaceAttributes",s[s.EdgeAttributes=2]="EdgeAttributes",s[s.OriginalName=4]="OriginalName",s[s.GenericTypes=8]="GenericTypes",s[s.GenericTypeId=16]="GenericTypeId",s[s.GenericId=32]="GenericId",s[s.DoublePrecisionMatrices=64]="DoublePrecisionMatrices",s[s.PointAttributes=128]="PointAttributes",s[s.Relationships=256]="Relationships",s[s.Modifiers=512]="Modifiers",s))(cr||{}),xn=(s=>(s[s.Name=1]="Name",s[s.Camera=2]="Camera",s[s.Pmi=4]="Pmi",s[s.Frame=8]="Frame",s[s.ShowNodes=16]="ShowNodes",s[s.HideNodes=32]="HideNodes",s[s.MoveNodes=64]="MoveNodes",s[s.CuttingPlanes=128]="CuttingPlanes",s[s.IsAnnotationView=256]="IsAnnotationView",s[s.IsNotCameraSet=512]="IsNotCameraSet",s[s.IsNotPmiFilteringSet=1024]="IsNotPmiFilteringSet",s[s.IsNotGeomFilteringSet=2048]="IsNotGeomFilteringSet",s[s.IsNotCrosssectionSet=4096]="IsNotCrosssectionSet",s[s.IsNotExplosionSet=8192]="IsNotExplosionSet",s[s.IsCombineState=16384]="IsCombineState",s[s.IsPerspective=32768]="IsPerspective",s[s.IsDefaultView=65536]="IsDefaultView",s[s.ViewFilters=131072]="ViewFilters",s))(xn||{}),sa=(s=>(s[s.Name=1]="Name",s[s.TopoRef=2]="TopoRef",s[s.Attributes=4]="Attributes",s[s.InitiallyHidden=8]="InitiallyHidden",s[s.HasMultipleBodies=16]="HasMultipleBodies",s[s.ExchangeId=32]="ExchangeId",s))(sa||{}),hc=(s=>(s[s.Name=1]="Name",s[s.LayerItem=2]="LayerItem",s[s.EntityItem=4]="EntityItem",s[s.ScId=8]="ScId",s))(hc||{}),Wp=(s=>(s[s.Name=1]="Name",s))(Wp||{}),df=(s=>(s[s.ValueName=1]="ValueName",s[s.Units=2]="Units",s))(df||{}),fu=(s=>(s[s.Type=1]="Type",s[s.Related=2]="Related",s[s.Relating=4]="Relating",s))(fu||{}),Tn=(s=>(s[s.BeforeAction=0]="BeforeAction",s[s.AfterAction=1]="AfterAction",s))(Tn||{});function uv(s,t){let e=0;for(let i=0;i<s.length;++i){const n=s[i];t(n)&&(s[e++]=n)}s.length=e}class gs{static create(t){return new gs(t)}constructor(t){this._deferredValue=t}get(){return this._deferredValue!==null&&(this._resolvedValue=this._deferredValue(),this._deferredValue=null),this._resolvedValue}}const dv=1024;class Gp{constructor(){this.items=[],this.next=null}}class $p{constructor(){this.clear()}clear(){this._head=new Gp,this._tail=this._head,this._size=0}get length(){return this._size}push(t){if(++this._size,this._tail.items.length===dv){const e=new Gp;this._tail.next=e,this._tail=e}this._tail.items.push(t)}pop(){console.assert(this._size>0),console.assert(this._head.items.length>0),--this._size;const t=this._head.items.shift();if(this._head.items.length===0){const e=this._head.next;e===null?console.assert(this._head===this._tail):this._head=e}return t}}function mi(){let s,t;const e=new Promise((i,n)=>{s=i,t=n});return e.resolve=s,e.reject=t,e}class uc{constructor(t,e){this._failed=!1,this._failureError=null,this._activePromiseCount=0,this._idlePromise=null,console.assert(t>0,"Don't create a non-progressible queue."),this._maxActivePromises=t,this._suppressFailures=e,this._deferredActions=new $p}isIdle(){return this._activePromiseCount===0}async waitForIdle(){if(this.isIdle()){if(this._failed)throw this._failureError;return}return this._idlePromise===null&&(this._idlePromise=mi()),this._idlePromise}push(t){typeof t=="function"&&(t=gs.create(t)),this._activePromiseCount<this._maxActivePromises?(console.assert(this._deferredActions.length===0),this._immediateAction(t)):this._deferredActions.push(t)}_immediateAction(t){if(this._failed)return console.assert(this._deferredActions.length===0),!0;let e;try{e=t.get()}catch(i){this._suppressFailures||(this._failed=!0,this._failureError=i,this._deferredActions.clear())}return e===void 0?!0:(++this._activePromiseCount,e.then(i=>(this._finalizePromise(),i)).catch(i=>{throw this._finalizePromise(),i}),!1)}_finalizePromise(){if(--this._activePromiseCount,this._failed&&console.assert(this._deferredActions.length===0),this._deferredActions.length>0)do{const t=this._deferredActions.pop();if(!this._immediateAction(t))break}while(this._deferredActions.length>0);this._tryActivateIdlePromise()}_tryActivateIdlePromise(){this._activePromiseCount===0&&(console.assert(this._deferredActions.length===0),this._idlePromise!==null&&(this._failed?this._idlePromise.reject(this._failureError):this._idlePromise.resolve(),this._idlePromise=null))}}class no{constructor(t){this._active=null,this._pending=null,this._idlePromise=null,this._suppressFailures=t}isIdle(){return this._active===null}waitForIdle(){return this.isIdle()?Promise.resolve():(this._idlePromise===null&&(this._idlePromise=mi()),this._idlePromise)}set(t){if(typeof t=="function"&&(t=gs.create(t)),this._active===null){let e;try{e=t.get()}catch(i){return this._advance(!this._suppressFailures,i)}if(e===void 0)return this._advance(!1,null);this._active=e.then(()=>{this._advance(!1,null)}).catch(i=>{this._advance(!this._suppressFailures,i)})}else this._pending=t}_advance(t,e){if(this._active=null,t&&(this._pending=null),this._pending===null)this._idlePromise!==null&&(t?this._idlePromise.reject(e):this._idlePromise.resolve(),this._idlePromise=null);else{const i=this._pending;this._pending=null,this.set(i)}}clear(){this._pending=null}}function Ue(s){return Promise.all(s)}class fv{constructor(t){this.promise=mi(),this.ids=t}}class gv{constructor(){this._aliasMap=new Map,this._callbackMap=new Map,this._activeTriggerDepth=0,this._pendingClearUnboundFilteredNames=new Set,this._aliasMap.set("sceneRendered","frameDrawn")}_filterName(t){const e=this._aliasMap.get(t);return e===void 0?t:e}bind(t,e){const i=Object.keys(t);for(const n of i){const r=t[n];if(typeof r=="function"){const o=this._filterName(n),l=this._callbackMap.get(o);l===void 0?this._callbackMap.set(o,[r]):e?l.unshift(r):l.push(r)}}}unbind(t){const e=Object.keys(t);for(const i of e){const n=this._filterName(i),r=this._callbackMap.get(n);if(r!==void 0){const o=t[i];for(let l=0;l<r.length;l++)r[l]===o&&(r[l]=null,this._pendingClearUnboundFilteredNames.add(n))}}this._clearUnboundCallbacks()}_clearUnboundCallbacks(){this._pendingClearUnboundFilteredNames.size!==0&&this._activeTriggerDepth===0&&(this._pendingClearUnboundFilteredNames.forEach(t=>{let e=this._callbackMap.get(t);e!==void 0&&(e=e.filter(i=>i!==null),e.length===0?this._callbackMap.delete(t):this._callbackMap.set(t,e))}),this._pendingClearUnboundFilteredNames.clear())}async promiseTrigger(t,e,...i){console.assert(t!==e);try{await this._unsafePromiseTrigger(t,i)}catch(n){console.error(`Rejected promise in '${t}' callback:`,n)}finally{e!==null&&this.unsafeTrigger(e,i)}}_unsafePromiseTrigger(t,e){const i=this._filterName(t),n=this._callbackMap.get(i),r=[];if(n!==void 0){++this._activeTriggerDepth;for(const o of n)if(o!==null)try{r.push(o(...e??[]))}catch(l){console.error(`Unhandled exception in '${t}' callback:`,l)}--this._activeTriggerDepth,this._clearUnboundCallbacks()}return Ue(r)}trigger(t,...e){this.unsafeTrigger(t,e)}unsafeTrigger(t,e){const i=this._filterName(t),n=this._callbackMap.get(i);if(n!==void 0){++this._activeTriggerDepth;for(const r of n)if(r!==null)try{r(...e??[])}catch(o){console.error(`Unhandled exception in '${t}' callback:`,o)}--this._activeTriggerDepth,this._clearUnboundCallbacks()}}}var qp=(s=>(s[s.Undefined=0]="Undefined",s[s.Line=1]="Line",s[s.Circle=2]="Circle",s[s.Other=6]="Other",s))(qp||{}),Kp=(s=>(s[s.Undefined=0]="Undefined",s[s.Cylinder=3]="Cylinder",s[s.Plane=4]="Plane",s[s.Cone=5]="Cone",s[s.Other=6]="Other",s[s.Sphere=7]="Sphere",s[s.Torus=8]="Torus",s[s.Blend01=9]="Blend01",s[s.Blend02=10]="Blend02",s[s.Blend03=11]="Blend03",s[s.Nurbs=12]="Nurbs",s[s.Cylindrical=13]="Cylindrical",s[s.Offset=14]="Offset",s[s.Pipe=15]="Pipe",s[s.Ruled=16]="Ruled",s[s.Revolution=17]="Revolution",s[s.Extrusion=18]="Extrusion",s[s.FromCurves=19]="FromCurves",s[s.Transform=20]="Transform",s))(Kp||{});let dc=class cp{constructor(t){this.length=t}static fromJson(t){return new cp(t.length)}copy(){return new cp(this.length)}type(){return 1}},Ya=class hp{constructor(t,e,i){this.radius=t,this.origin=e.copy(),this.normal=i.copy()}static fromJson(t){const e=t.radius,i=new _(t.origin.x,t.origin.y,t.origin.z),n=new _(t.normal.x,t.normal.y,t.normal.z);return new hp(e,i,n)}copy(){return new hp(this.radius,this.origin,this.normal)}type(){return 2}};class So{constructor(t){this.length=t}static fromJson(t){return new So(t.length)}copy(){return new So(this.length)}type(){return 6}}class fc{copy(){return new fc}type(){return 6}}class Ni{constructor(t,e,i){this.radius=t,this.origin=e.copy(),this.normal=i.copy()}static fromJson(t){const e=t.radius,i=new _(t.origin.x,t.origin.y,t.origin.z),n=new _(t.normal.x,t.normal.y,t.normal.z);return new Ni(e,i,n)}copy(){return new Ni(this.radius,this.origin,this.normal)}type(){return 3}}class Wi{constructor(t,e){this.origin=t.copy(),this.normal=e.copy()}static fromJson(t){const e=new _(t.origin.x,t.origin.y,t.origin.z),i=new _(t.normal.x,t.normal.y,t.normal.z);return new Wi(e,i)}copy(){return new Wi(this.origin,this.normal)}type(){return 4}}class ra{constructor(t,e,i,n){this.radius=t,this.origin=e.copy(),this.normal=i.copy(),this.halfAngle=n}static fromJson(t){const e=t.radius,i=t.halfAngle,n=new _(t.origin.x,t.origin.y,t.origin.z),r=new _(t.normal.x,t.normal.y,t.normal.z);return new ra(e,n,r,i)}copy(){return new ra(this.radius,this.origin,this.normal,this.halfAngle)}type(){return 5}}class oa{constructor(t,e,i){this.radius=t,this.origin=e.copy(),this.normal=i.copy()}static fromJson(t){const e=t.radius,i=new _(t.origin.x,t.origin.y,t.origin.z),n=new _(t.normal.x,t.normal.y,t.normal.z);return new oa(e,i,n)}copy(){return new oa(this.radius,this.origin,this.normal)}type(){return 7}}class aa{constructor(t,e,i,n){this.majorRadius=t,this.minorRadius=e,this.origin=i.copy(),this.normal=n.copy()}static fromJson(t){const e=new _(t.origin.x,t.origin.y,t.origin.z),i=new _(t.normal.x,t.normal.y,t.normal.z),n=t.majRadius,r=t.minRadius;return new aa(n,r,e,i)}copy(){return new aa(this.majorRadius,this.minorRadius,this.origin,this.normal)}type(){return 8}}class gc{copy(){return new gc}type(){return 9}}class pc{copy(){return new pc}type(){return 10}}class mc{copy(){return new mc}type(){return 11}}class _c{copy(){return new _c}type(){return 12}}class yc{copy(){return new yc}type(){return 13}}class wc{copy(){return new wc}type(){return 14}}class vc{copy(){return new vc}type(){return 15}}class bc{copy(){return new bc}type(){return 16}}class Ic{copy(){return new Ic}type(){return 17}}class xc{copy(){return new xc}type(){return 18}}class Cc{copy(){return new Cc}type(){return 19}}class Sc{copy(){return new Sc}type(){return 20}}function gu(){let s,t;const e=new Promise((i,n)=>{s=r=>{e.state=Nr.Resolved,i(r)},t=r=>{e.state=Nr.Rejected,n(r)}});return e.state=Nr.Pending,e.resolve=s,e.reject=t,e}function Po(s,t){const e=new Promise((i,n)=>{t.then(()=>{e.isReady=!0,i(s)},n)});return e.unsafeValue=s,e.readyPromise=t,e.isReady=!1,e}class rs{constructor(){this._faceMeshData=[],this._pointMeshData=[],this._polylineMeshData=[],this._faceWinding=Rs.CounterClockwise,this._backfacesEnabled=!1,this._isManifold=!1}addFaces(t,e,i,n,r=0){this._faceMeshData.push(new Xp(t,e,i,n,r))}addPoints(t,e,i=0){this._pointMeshData.push(new Yp(t,e,i))}addPolyline(t,e,i=0){this._polylineMeshData.push(new Jp(t,e,i))}clear(){this._faceMeshData.length=0,this._pointMeshData.length=0,this._polylineMeshData.length=0}setFaceWinding(t){this._faceWinding=t}getFaceWinding(){return this._faceWinding}setBackfacesEnabled(t){this._backfacesEnabled=t}getBackfacesEnabled(){return this._backfacesEnabled}setManifold(t){this._isManifold=t}isManifold(){return this._isManifold}_getFaceData(){return this._faceMeshData}_getPointData(){return this._pointMeshData}_getPolylineData(){return this._polylineMeshData}}class Ns{constructor(t,e,i,n,r,o,l){this._meshId=null,this._matrix=null,this._faceColor=null,this._lineColor=null,this._pointColor=null,this._instanceName=null,this._faceOpacity=1,this._lineOpacity=1,this._pointOpacity=1,this._creationFlags=ie.None,this.overlayId={viewKey:ke.Default,overayIndex:0},t&&(this._meshId=t.slice()),e&&(this._matrix=e.copy()),i&&(this._instanceName=i),n&&(this._faceColor=n.copy()),r&&(this._lineColor=r.copy()),o&&(this._pointColor=o.copy()),l&&(this._creationFlags=l)}copy(){const t=new Ns(this.getMeshId(),this.getMatrix(),this.getInstanceName(),this.getFaceColor(),this.getLineColor(),this.getPointColor(),this.getCreationFlags());return t.setPointOpacity(this.getOpacity()),t.setLineOpacity(this.getLineOpacity()),t.setOpacity(this.getOpacity()),t.overlayId=Object.assign({},this.overlayId),t}clear(){this._meshId=null,this._matrix=null,this._faceColor=null,this._lineColor=null,this._pointColor=null,this._instanceName=null,this._faceOpacity=1,this._lineOpacity=1,this._pointOpacity=1,this._creationFlags=ie.None,this.overlayId={viewKey:ke.Default,overayIndex:0}}getMeshId(){return this._meshId!==null?this._meshId.slice():null}setMeshId(t){this._meshId=t.slice()}getMatrix(){return this._matrix!==null?this._matrix.copy():null}getCreationFlags(){return this._creationFlags}setCreationFlags(t){this._creationFlags=t}setMatrix(t){this._matrix=t.copy()}getInstanceName(){return this._instanceName}setInstanceName(t){this._instanceName=t}setFaceColor(t){this._faceColor=t.copy()}getFaceColor(){return this._faceColor!==null?this._faceColor.copy():null}setLineColor(t){this._lineColor=t.copy()}getLineColor(){return this._lineColor!==null?this._lineColor.copy():null}setPointColor(t){this._pointColor=t.copy()}getPointColor(){return this._pointColor!==null?this._pointColor.copy():null}setPointOpacity(t){this._pointOpacity=t}getPointOpacity(){return this._pointOpacity}setLineOpacity(t){this._lineOpacity=t}getLineOpacity(){return this._lineOpacity}setOpacity(t){this._faceOpacity=t}getOpacity(){return this._faceOpacity}setOverlayIndex(t){this.overlayId.overayIndex=t}getOverlayIndex(){return this.overlayId.overayIndex}}class Xp{constructor(t,e,i,n,r=0){this.vertexData=t,this.normalData=e,this.rgba32data=i,this.uvData=n,this.bits=r}}class Jp{constructor(t,e,i=0){this.vertexData=t,this.rgba32data=e,this.bits=i}}class Yp{constructor(t,e,i=0){this.vertexData=t,this.rgba32data=e,this.bits=i}}function Zp(){const s=(1+Math.sqrt(5))/2,t=Math.sqrt(10+2*Math.sqrt(5))/(4*s),e=t/2,i=t/(2*s),n=[];n[0]=new _(-i,e,0),n[1]=new _(i,e,0),n[2]=new _(-i,-e,0),n[3]=new _(i,-e,0),n[4]=new _(0,-i,e),n[5]=new _(0,i,e),n[6]=new _(0,-i,-e),n[7]=new _(0,i,-e),n[8]=new _(e,0,-i),n[9]=new _(e,0,i),n[10]=new _(-e,0,-i),n[11]=new _(-e,0,i);for(const g of n)g.normalize();let r=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],o=12;const l=2;for(let g=0;g<l;g++){const y=[];r.map(m=>{const I=n[m[0]],b=n[m[1]],x=n[m[2]];n[o++]=new _(I.x+b.x,I.y+b.y,I.z+b.z).scale(.5).normalize(),n[o++]=new _(b.x+x.x,b.y+x.y,b.z+x.z).scale(.5).normalize(),n[o++]=new _(x.x+I.x,x.y+I.y,x.z+I.z).scale(.5).normalize(),y.push([m[0],o-3,o-1]),y.push([o-3,o-2,o-1]),y.push([o-3,m[1],o-2]),y.push([o-2,m[2],o-1])}),r=y}const h=[],u=[];for(const g of r)for(let y=0;y<3;y++){const m=g[y];h.push(n[m].x),h.push(n[m].y),h.push(n[m].z);const I=n[m].normalize();u.push(I.x),u.push(I.y),u.push(I.z)}const d=new rs;return d.addFaces(h,u),d.setFaceWinding(Rs.CounterClockwise),d}function ff(s,t,e,i,n,r){const o=new _t,l=mv(i,t,e+r,n,o),h=pv(s,t,e,o),u=_v(s,i,t,e,r),d=l[0].concat(h[0]).concat(u[0]),g=l[1].concat(h[1]).concat(u[1]),y=new rs;return y.setFaceWinding(Rs.Clockwise),y.addFaces(d,g),y}function Qp(s){const t=Math.PI*2/s,e=[];for(let i=0;i<s;i++){const n=i*t,r=Math.cos(n),o=Math.sin(n);e.push(r),e.push(o)}return e}function ko(s,t,e,i=1){let n=_.cross(e,new _(0,1,0));n.length()<.001&&(n=_.cross(e,new _(0,0,1)));const r=_.cross(n,e),o=Math.PI*2/s,l=[];for(let h=0;h<s;h++){const u=h*o,d=Math.sin(u),g=Math.cos(u),y=n.copy().scale(d).add(r.copy().scale(g)).scale(i).add(t);l.push(y)}return l}function tm(s,t,e,i){const o=[],l=[];let h;for(let k=0;k<s.length-3;k+=3){const O=new _(s[k],s[k+1],s[k+2]),B=new _(s[k+3],s[k+4],s[k+5]),j=ko(e,O,t,i),V=ko(e,B,t,i);h=pu(O,B,j,V,!1),Array.prototype.push.apply(o,h[0]),Array.prototype.push.apply(l,h[1])}const u=s.length;let d=new _(s[u-3],s[u-2],s[u-1]),g=d.copy().subtract(new _(s[u-6],s[u-5],s[u-4])).normalize(),y=ko(e*2,d,t,i),m=d.copy().add(g.copy().scale(2/3)),I=ko(e*2,m,t,i*2),b=m.copy().add(g.copy().scale(2));h=pu(d,m,y,I,!1),Array.prototype.push.apply(o,h[0]),Array.prototype.push.apply(l,h[1]);for(let k=0;k<y.length;k++){const O=(k+1)%y.length;o.push(b),o.push(I[k]),o.push(I[O]);const B=I[k].copy().subtract(m).normalize().add(b.copy().normalize()).normalize();l.push(B),l.push(B),l.push(B)}d=new _(s[0],s[1],s[2]),g=d.copy().subtract(new _(s[3],s[4],s[5])).normalize(),y=ko(e*2,d,t,i),m=d.copy().add(g.copy().scale(.6666666666666666)),I=ko(e*2,m,t,i*2),b=m.copy().add(g.copy().scale(2)),h=pu(m,d,I,y,!1),Array.prototype.push.apply(o,h[0]),Array.prototype.push.apply(l,h[1]);for(let k=0;k<y.length;k++){const O=(k+1)%y.length;o.push(b),o.push(I[O]),o.push(I[k]);const B=I[k].copy().subtract(m).normalize().add(b.copy().normalize()).normalize();l.push(B),l.push(B),l.push(B)}const x=[],C=[];for(let k=0;k<o.length;k++){const O=o[k];x.push(O.x),x.push(O.y),x.push(O.z);const B=l[k];C.push(B.x),C.push(B.y),C.push(B.z)}const P=new rs;return P.setFaceWinding(Rs.CounterClockwise),P.addFaces(x,C),P}function pu(s,t,e,i,n){const r=[],o=[];for(let l=0;l<e.length;l++){const h=(l+1)%e.length;r.push(e[l]),r.push(e[h]),r.push(i[l]),r.push(e[h]),r.push(i[h]),r.push(i[l]),o.push(_.subtract(e[l],s)),o.push(_.subtract(e[h],s)),o.push(_.subtract(i[l],t)),o.push(_.subtract(e[h],s)),o.push(_.subtract(i[h],t)),o.push(_.subtract(i[l],t))}if(n){const l=_.subtract(s,t);for(const h of o)h.add(l).normalize()}return[r,o]}function pv(s,t,e,i){const n=[],r=[],o=Qp(t),l=o;for(let y=0;y<l.length;y++)l[y]*=s;const h=[],u=[];for(let y=0;y<l.length;y+=2){const m=l[y],I=l[y+1],b=(y+2)%l.length,x=l[b],C=l[b+1],P=o[y],k=o[y+1],O=o[b],B=o[b+1];h[0]=new _(m,e,I),h[1]=new _(m,0,I),h[2]=new _(x,0,C),h[3]=new _(x,0,C),h[4]=new _(x,e,C),h[5]=new _(m,e,I),u[0]=new _(P,0,k),u[1]=new _(P,0,k),u[2]=new _(O,0,B),u[3]=new _(O,0,B),u[4]=new _(O,0,B),u[5]=new _(P,0,k);for(let j=0;j<h.length;j++){const V=i.transform(h[j]);n.push(V);const Y=i.transform(u[j]);r.push(Y)}h[0]=new _(x,0,C),h[1]=new _(m,0,I),h[2]=_.zero(),u[0]=new _(0,-1,0),u[1]=new _(0,-1,0),u[2]=new _(0,-1,0);for(let j=0;j<3;j++){const V=i.transform(h[j]);n.push(V);const Y=i.transform(u[j]);r.push(Y)}}const d=[],g=[];for(let y=0;y<n.length;y++){const m=n[y];d.push(m.x),d.push(m.y),d.push(m.z);const I=r[y];g.push(I.x),g.push(I.y),g.push(I.z)}return[d,g]}function mv(s,t,e,i,n){const r=Qp(t),o=r;for(let b=0;b<o.length;b++)o[b]*=s;const l=new _(0,e+i,0),h=new _(0,e,0),u=n.transform(l),d=n.transform(h),g=[],y=[];for(let b=0;b<o.length;b+=2){const x=o[b],C=o[b+1],P=(b+2)%o.length,k=o[P],O=o[P+1],B=r[b],j=r[b+1],V=r[P],Y=r[P+1],q=new _(x,e,C),st=new _(k,e,O),ft=n.transform(q),U=n.transform(st);g.push(u),g.push(ft),g.push(U);const J=new _(0,1,0),A=new _(B,0,j),R=new _(V,0,Y),bt=n.transform(J),z=n.transform(A),Pt=n.transform(R);y.push(bt),y.push(z),y.push(Pt);const X=new _(x,e,C),Tt=new _(k,e,O),lt=n.transform(X),at=n.transform(Tt);g.push(d),g.push(at),g.push(lt);const Gt=new _(0,-1,0),kt=n.transform(Gt);y.push(kt),y.push(kt),y.push(kt)}const m=[],I=[];for(let b=0;b<g.length;b++){const x=g[b];m.push(x.x),m.push(x.y),m.push(x.z);const C=y[b];I.push(C.x),I.push(C.y),I.push(C.z)}return[m,I]}function _v(s,t,e,i,n){const r=new _(0,0,i),o=new _(0,0,i+n),l=new _(0,0,1),h=ko(e,r,l,s),u=ko(e,o,l,t),d=pu(r,o,h,u,!0),g=[],y=[];for(let m=0;m<d[0].length;m++)g.push(d[0][m].x),g.push(d[0][m].z),g.push(d[0][m].y),y.push(d[1][m].x),y.push(d[1][m].z),y.push(d[1][m].y);return[g,y]}function yv(s){}function Tr(s){throw new ei}class wv{constructor(t,e){this._state=t,this._reducer=e}handle(t,e){this._state=this._reducer(this._state,{name:t,payload:e})}}function mu(s){return new Promise(t=>{setTimeout(t,s)})}function vv(s,...t){return setTimeout(s,0,...t)}function bv(s,t){return s===t}function Iv(s){return s instanceof dc}function xv(s){return s instanceof Ya}function Cv(s){return s instanceof So}function Sv(s){return s instanceof Wi}function Pv(s){return s instanceof Ni||s instanceof Wi||s instanceof ra||s instanceof oa||s instanceof aa||s instanceof gc||s instanceof pc||s instanceof mc||s instanceof _c||s instanceof yc||s instanceof wc||s instanceof vc||s instanceof bc||s instanceof Ic||s instanceof xc||s instanceof Cc||s instanceof Sc||s instanceof fc}class Mo{constructor(){this._timerId=null,this._action=null,this._beforeActionIdlePromise=null,this._afterActionIdlePromise=null}isIdle(t){return t===Tn.BeforeAction?this._timerId===null:this._action===null}waitForIdle(t){return t===Tn.BeforeAction?this._timerId===null?Promise.resolve():(this._beforeActionIdlePromise===null&&(this._beforeActionIdlePromise=mi()),this._beforeActionIdlePromise):this._action===null?Promise.resolve():(this._afterActionIdlePromise===null&&(this._afterActionIdlePromise=mi()),this._afterActionIdlePromise)}_triggerIdlePromise(t){t===Tn.BeforeAction?this._beforeActionIdlePromise!==null&&(this._beforeActionIdlePromise.resolve(),this._beforeActionIdlePromise=null):this._afterActionIdlePromise!==null&&(this._afterActionIdlePromise.resolve(),this._afterActionIdlePromise=null)}_clearTimeout(){this._timerId!==null&&(clearTimeout(this._timerId),this._timerId=null)}clear(){this._clearTimeout(),this._triggerIdlePromise(Tn.BeforeAction),this._action=null,this._triggerIdlePromise(Tn.AfterAction)}set(t,e){this._clearTimeout(),this._action=e,this._timerId=setTimeout(()=>{this._timerId=null,this._triggerIdlePromise(Tn.BeforeAction);const i=this._afterActionIdlePromise;this._afterActionIdlePromise=null,this._action(),this._timerId===null&&(this._action=null),i!==null&&i.resolve()},t)}}function kv(){const s=new Mo;s.set(0,()=>{s.set(0,()=>{}),s.waitForIdle(Tn.AfterAction).then(()=>{console.log("inner-1")}),s.clear(),s.waitForIdle(Tn.AfterAction).then(()=>{console.log("inner-2")}),s.set(0,()=>{}),s.waitForIdle(Tn.AfterAction).then(()=>{console.log("inner-3")})}),s.waitForIdle(Tn.AfterAction).then(()=>{console.log("outer")})}const Mv=Object.freeze(Object.defineProperty({__proto__:null,ActionQueue:uc,CurrentAction:no,Lazy:gs,StateMachine:wv,Timer:Mo,TimerIdleType:Tn,TypeAssert:yv,TypeAssertNever:Tr,_timerStressTest:kv,copyMap:hu,copySet:sv,createCylinderMeshDataFromArc:tm,createOpenPromise:mi,createTrackedOpenPromise:gu,createUnsafePromise:Po,delayCall:vv,exchangeIdEqual:bv,filterInPlace:uv,generateConeCylinderMeshData:ff,generateSphereMeshData:Zp,isCircleElement:xv,isFace:Pv,isLineElement:Iv,isOtherEdgeElement:Cv,isPlaneElement:Sv,setSubtraction:cf,setToArray:io,sleep:mu,toSet:ac,waitForAll:Ue},Symbol.toStringTag,{value:"Module"}));var Nr=(s=>(s[s.Pending=0]="Pending",s[s.Resolved=1]="Resolved",s[s.Rejected=2]="Rejected",s))(Nr||{}),ps=(s=>(s[s.Direct=0]="Direct",s[s.Indirect=1]="Indirect",s))(ps||{}),_u=(s=>(s[s.X=2]="X",s[s.Y=4]="Y",s[s.Z=8]="Z",s))(_u||{}),yu=(s=>(s[s.X=16]="X",s[s.Y=32]="Y",s[s.Z=64]="Z",s))(yu||{}),Pc=(s=>(s[s.None=0]="None",s[s.EyeX_UpY=34]="EyeX_UpY",s[s.EyeX_UpZ=66]="EyeX_UpZ",s[s.EyeY_UpX=20]="EyeY_UpX",s[s.EyeY_UpZ=68]="EyeY_UpZ",s[s.EyeZ_UpX=24]="EyeZ_UpX",s[s.EyeZ_UpY=40]="EyeZ_UpY",s))(Pc||{}),Gs=(s=>(s[s.StemHeight=2]="StemHeight",s[s.CapHeight=.5]="CapHeight",s[s.TaperHeight=.1]="TaperHeight",s[s.SegmentCount=20]="SegmentCount",s[s.CylinderRadius=.2]="CylinderRadius",s[s.ConeBaseRadius=.4]="ConeBaseRadius",s[s.LetterOffsetPos=.6]="LetterOffsetPos",s[s.LetterWidth=.3]="LetterWidth",s[s.LetterHeight=.5]="LetterHeight",s))(Gs||{}),Kn=(s=>(s[s.None=0]="None",s[s.Position=1]="Position",s[s.Target=2]="Target",s[s.Up=4]="Up",s[s.Width=8]="Width",s[s.Height=16]="Height",s[s.Projection=32]="Projection",s[s.NearLimit=64]="NearLimit",s))(Kn||{}),wu=(s=>(s[s.Attachment=0]="Attachment",s[s.Model=1]="Model",s))(wu||{}),vu=(s=>(s[s.AllKeys=0]="AllKeys",s[s.KeyCountOnly=1]="KeyCountOnly",s))(vu||{}),kc=(s=>(s[s.Add=0]="Add",s[s.Update=1]="Update",s))(kc||{}),Mc=(s=>(s[s.MetaData=0]="MetaData",s[s.Count=1]="Count",s))(Mc||{}),em=(s=>(s[s.SelectionBitsFaceHasMeasurementData=1]="SelectionBitsFaceHasMeasurementData",s[s.SelectionBitsFacePlanar=2]="SelectionBitsFacePlanar",s[s.SelectionBitsEdgeHasMeasurementData=4]="SelectionBitsEdgeHasMeasurementData",s))(em||{}),bu=(s=>(s[s.Outside=0]="Outside",s[s.PartiallyInside=1]="PartiallyInside",s[s.FullyInside=2]="FullyInside",s))(bu||{}),im=(s=>(s[s.Unsent=0]="Unsent",s[s.Opened=1]="Opened",s[s.HeadersRecieved=2]="HeadersRecieved",s[s.Loading=3]="Loading",s[s.Done=4]="Done",s))(im||{}),nm=(s=>(s[s.Ok=200]="Ok",s))(nm||{});class dn{constructor(){this._position=new _(0,0,1),this._target=_.zero(),this._up=new _(0,1,0),this._width=0,this._height=0,this._projection=ti.Orthographic,this._nearLimit=.01,this._cameraFlags=Kn.None}_clearFlags(){this._cameraFlags=Kn.None}_getFlags(){return this._cameraFlags}copy(){return dn.create(this._position,this._target,this._up,this._projection,this._width,this._height,this._nearLimit)}setPosition(t){this._position.assign(t),this._cameraFlags|=Kn.Position}getPosition(){return this._position.copy()}setTarget(t){this._target.assign(t),this._cameraFlags|=Kn.Target}getTarget(){return this._target.copy()}setUp(t){this._up.assign(t),this._cameraFlags|=Kn.Up}getUp(){return this._up.copy()}setWidth(t){this._width=t,this._cameraFlags|=Kn.Width}getWidth(){return this._width}setHeight(t){this._height=t,this._cameraFlags|=Kn.Height}getHeight(){return this._height}setProjection(t){this._projection=t,this._cameraFlags|=Kn.Projection}getProjection(){return this._projection}setNearLimit(t){this._nearLimit=t,this._cameraFlags|=Kn.NearLimit}getNearLimit(){return this._nearLimit}equals(t){return this._position.equals(t._position)&&this._target.equals(t._target)&&this._up.equals(t._up)&&this._width===t._width&&this._height===t._height&&this._projection===t._projection&&this._nearLimit===t._nearLimit}equalsWithTolerance(t,e){const i=(n,r)=>Math.abs(n-r)<e;return this._position.equalsWithTolerance(t._position,e)&&this._target.equalsWithTolerance(t._target,e)&&this._up.equalsWithTolerance(t._up,e)&&i(this._width,t._width)&&i(this._height,t._height)&&i(this._projection,t._projection)&&i(this._nearLimit,t._nearLimit)}dolly(t){this._position.subtract(t),this._target.subtract(t)}getCameraPlaneIntersectionPoint(t,e){const i=_.subtract(this._position,this._target).normalize(),n=Ki.createFromPointAndNormal(this._target,i),r=e.raycastFromPoint(t);if(r===null)return null;const o=_.zero();return n.intersectsRay(r,o)?o:null}getViewMatrix(t){return t._getScEngine().getViewMatrix(this)}getProjectionMatrix(t,e){return e=e??t.view,t._getScEngine().getProjectionMatrix(this,e.id)}getFullMatrix(t,e){return e=e??t.view,t._getScEngine().getFullCameraMatrix(this,e.id)}static create(t,e,i,n,r,o,l){const h=new dn;return h._position.assign(t),h._target.assign(e),h._up.assign(i),h._projection=n,h._width=r,h._height=o,l!==void 0&&(h._nearLimit=l),h}toJson(){return this._toJson()}_toJson(){return{position:this._position.toJson(),target:this._target.toJson(),up:this._up.toJson(),width:this._width,height:this._height,projection:this._projection,nearLimit:this._nearLimit,className:"Communicator.Camera"}}static fromJson(t){const e=t,i=_.fromJson(e.position),n=_.fromJson(e.target),r=_.fromJson(e.up);return dn.create(i,n,r,e.projection,e.width,e.height,e.nearLimit)}transform(t){if(t.isIdentity())return this.copy();const e=Math.abs(this._width),i=Math.abs(this._height),n=this.getUp().normalize().scale(i),r=_.subtract(this._position,this._target),o=_.cross(n,r).normalize().scale(e),l=this.getTarget(),h=_.add(l,o),u=_.add(l,n),d=_.add(l,r);t.transform(l,l),t.transform(h,h),t.transform(u,u),t.transform(d,d);const g=_.subtract(h,l),y=_.subtract(u,l),m=_.subtract(d,l),I=_.add(l,m),b=l,x=y.copy().normalize();let C=g.length(),P=y.length();return this._width<0&&(C=-C),this._height<0&&(P=-P),dn.create(I,b,x,this._projection,C,P,this._nearLimit)}}function Ev(s){if(typeof window<"u"&&s.length<8192&&"escape"in window){let l;try{const h=String.fromCharCode.apply(null,s),u=window.escape(h);l=decodeURIComponent(u)}catch{l=""}return l}let t,e,i,n,r;t="";const o=s.length;for(e=0;e<o;)switch(i=s[e++],i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(i);break;case 12:case 13:n=s[e++],t+=String.fromCharCode((i&31)<<6|n&63);break;case 14:n=s[e++],r=s[e++],t+=String.fromCharCode((i&15)<<12|(n&63)<<6|(r&63)<<0);break}return t}const Av=/^\d+$/;function sm(s){return Av.test(s)}const Iu="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz`~!@#$%^&*()_+-=[]{};:'\",.<>\\|/?".split("");function gf(s){if(console.assert(s>=0),s===0)return Iu[0];const t=[];for(;s!==0;){const e=Math.floor(s/Iu.length),i=s%Iu.length,n=Iu[i];t.push(n),s=e}return t.join("")}const Tv=["0000000","000000","00000","0000","000","00","0",""];function Nv(s){const t=s.toString(16);return Tv[t.length-1]+t}class gi{static _parseUint_32(t){if(!sm(t))return null;const e=parseInt(t,10);return e<=4294967295?e:null}static _parseFloat(t){const e=parseFloat(t);return isNaN(e)?null:e}static parseFloat(t,e){const i=t.getAttribute(e);return i===null?null:this._parseFloat(i)}static _parseScKey(t,e){const i=t.getAttribute(e);return i===null?null:this._parseUint_32(i)}static parseDataKey(t,e){return this._parseScKey(t,e)}static parseMeshKey(t,e){return this._parseScKey(t,e)}static parseInstanceKeyFromInc(t,e){const i=t.getAttribute(e);if(i===null)return null;const n=i.split(" ");return n.length!==2||this._parseUint_32(n[0])===null?null:this._parseUint_32(n[1])}static parseNodeId(t,e){const i=t.getAttribute(e);return i===null?null:this._parseUint_32(i)}static parseLayerId(t,e){const i=t.getAttribute(e);return i===null?null:this._parseUint_32(i)}static parseUint(t,e){const i=t.getAttribute(e);return i===null?null:this._parseUint_32(i)}static parseUints(t,e){const i=t.getAttribute(e);if(i===null)return null;const n=[],r=i.match(/[0-9]+/g)||[];for(const o of r){const l=this._parseUint_32(o);if(l===null)return null;n.push(l)}return n}static parseFloats(t,e){const i=t.getAttribute(e);if(i===null)return null;const n=[],r=i.match(/\S+/g)||[];for(const o of r){const l=this._parseFloat(o);if(l===null)return null;n.push(l)}return n}static parseNodeIds(t,e){return this.parseUints(t,e)}static _parsePoint3(t,e){const i=t.getAttribute(e);if(i===null)return null;const n=i.split(" ");if(n.length!==3)return null;const r=[];for(const o of n){const l=Number(o);if(isNaN(l))return null;r.push(l)}return new _(r[0],r[1],r[2])}static parseBounding(t,e){const i=t.getElementsByTagName(e);if(i.length!==1)return null;const n=i[0],r=this._parsePoint3(n,"Min");if(r===null)return null;const o=this._parsePoint3(n,"Max");return o===null?null:new on(r,o)}static parseCamera(t){const e=gi.parseUint(t,"Projection");if(e===null)return null;const i=t.getAttribute("field");if(i===null)return null;const n=i.split(" ");if(n.length!==2)return null;const r=parseFloat(n[0]),o=parseFloat(n[1]),l=t.getAttribute("definition");if(l===null)return null;const h=l.split(" ");if(h.length!==9)return null;const u=(m,I)=>new _(parseFloat(m[I]),parseFloat(m[I+1]),parseFloat(m[I+2])),d=u(h,0),g=u(h,3),y=u(h,6);return dn.create(d,g,y,e,r,o)}}class Ec{constructor(){this.isInclusive=!1,this.ids=[]}static parseBinary(t){const e=new Ec;e.isInclusive=t.parseBoolean();const i=t.parseCount_32();for(let n=0;n<i;n++)e.ids.push(t.parseNodeId());return e}static parseXml(t){const e=new Ec;e.isInclusive=t.getAttribute("Inclusive")==="1";const i=gi.parseNodeIds(t,"Ids");if(i!==null){e.ids=i;const n=t.getAttribute("Count");if(n!==null){const r=parseInt(n,10);console.assert(r===e.ids.length)}}else console.error("'Entities' tag has missing or malformed 'Ids' attribute");return e}}class Ac{constructor(){this.isInclusive=!1,this.authoredIds=[]}static parseBinary(t){const e=new Ac;e.isInclusive=t.parseBoolean();const i=t.parseCount_32();for(let n=0;n<i;n++)e.authoredIds.push(t.parseLayerId());return e}static parseXml(t){const e=new Ac;e.isInclusive=t.getAttribute("Inclusive")==="1";const i=gi.parseUints(t,"Ids");if(i!==null){e.authoredIds=i;const n=t.getAttribute("Count");if(n!==null){const r=parseInt(n,10);console.assert(r===e.authoredIds.length)}}else console.error("'Layers' tag has missing or malformed 'Ids' attribute");return e}}class Tc{constructor(){this.isDisplayfilter=!1,this.name=null,this.isActive=!1,this.layers=null,this.entities=null,this.scId=null}static parseBinary(t){const e=new Tc;let i=null,n=null;const r=t.parseLayerParseBits();return e.isDisplayfilter=t.parseBoolean(),ne(r,hc.ScId)&&(e.scId=t.parseUInt32()),ne(r,hc.Name)&&(e.name=t.parseCString()),e.isActive=t.parseBoolean(),ne(r,hc.LayerItem)&&(i=Ac.parseBinary(t)),ne(r,hc.EntityItem)&&(n=Ec.parseBinary(t)),e.layers=i,e.entities=n,e}static parseXml(t){const e=new Tc,i=t.getAttribute("Name");i!==null&&(e.name=i),e.isDisplayfilter=t.getAttribute("Display")==="1",e.isActive=t.getAttribute("Active")==="1";for(let n=t.firstElementChild;n!==null;n=n.nextElementSibling)n.localName==="Layers"?(console.assert(e.layers===null),e.layers=Ac.parseXml(n)):n.localName==="Entities"?(console.assert(e.entities===null),e.entities=Ec.parseXml(n)):console.error(`Unknown tag: ${t.localName}`);return e}}var Eo=(s=>(s[s.Undefined=0]="Undefined",s[s.Unconnected=1]="Unconnected",s[s.Connected=2]="Connected",s))(Eo||{});class pf{constructor(){this.relationships=[]}static parseBinary(t,e){const i=new pf,n=e.parseCount_32();for(let r=0;r<n;r++){let o=Eo.Undefined;const l=e.parseCString(),h=e.parseCString();e.parseBoolean()?(o=Eo.Connected,la.registerBimId(l,t)):o=Eo.Unconnected,i.relationships.push({category:o,id:l,name:h})}return i}}class xu{constructor(){this.relationElt={id:"",name:"",category:Eo.Undefined}}static parseBinary(t,e){const i=new xu;return i.relationElt.id=e.parseCString(),i.relationElt.name=e.parseCString(),e.parseBoolean()?(i.relationElt.category=Eo.Connected,la.registerBimId(i.relationElt.id,t)):i.relationElt.category=Eo.Unconnected,i}static parseXml(t){return new xu}}class la{constructor(){this.type=Lf.Undefined,this.related=null,this.relating=null}static registerBimId(t,e){const i=e.toRuntimeId(parseInt(t,10));i!==null&&e.addBimIdToMap(t,i)}static parseBinary(t,e){const i=new la,n=e.parseRelationshipParseBits();return ne(n,fu.Type)&&(i.type=e.parseCount_32()),ne(n,fu.Relating)&&(i.relating=xu.parseBinary(t,e)),ne(n,fu.Related)&&(i.related=pf.parseBinary(t,e)),i}static parseXml(t){const e=new la,i=t.getAttribute("Type");return i!==null&&(e.type=Number(i)),e}}class hr{static parseBinary(t){let e=null;const i=t.getHeader();let n=0;i!==null&&i.supportsAttributeBits()&&(n=t.parseAttributeParseBits());const r=t.parseCString();ne(n,df.ValueName)&&(e=t.parseCString());const o=t.parseAttributeType(),l=t.parseCString();let h=[];return ne(n,df.Units)&&(h=t.parseUnits()),new hr(o,r,e,l,h)}static parseXml(t){console.assert(t.localName==="Attr");let e=gr.Undefined,i="",n="";const r=[],o=t.getAttribute("ValueName"),l=t.getAttribute("Name");if(l!==null&&(i=l,i==="__PRC_RESERVED_ATTRIBUTE_A3DF_ProductInformation"))return new hr(e,i,o,n,r);const h=t.getAttribute("Type");if(h!==null)switch(h){case"i":e=gr.Int;break;case"f":e=gr.Float;break;case"t":e=gr.Time;break;case"s":e=gr.String;break}const u=t.getAttribute("Value");return u!==null&&(n=u),new hr(e,i,o,n,r)}constructor(t,e,i,n,r){this._type=t,this._valueName=i,this._title=e,this._value=n,this._unit=r}getType(){return this._type}getValueName(){return this._valueName}getTitle(){return this._title}getValue(){return this._value}getUnit(){return wp(this._unit)}copy(){let t=null;return this._valueName!==null&&(t=this._valueName.slice()),new hr(this._type,this._title.slice(),t,this._value.slice(),this._unit.slice())}}let Vn=class qw{static parseBinary(t){return t.parseMatrix()}static parseXml(t){console.assert(t.localName==="Transformation");const e=[],i=t.getAttribute("RelativeTransfo");if(i!==null){const n=i.split(" ");console.assert(n.length===16);for(let r=0;r<16;++r){const o=parseFloat(n[r]);console.assert(!isNaN(o)),e.push(o)}}return e}static getIdentity(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}static copy(t){return t.slice()}static isIdentity(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1}static multiply(t,e){const i=qw.getIdentity();return i[0]=t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],i[1]=t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],i[2]=t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],i[3]=t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],i[4]=t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],i[5]=t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],i[6]=t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],i[7]=t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],i[8]=t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],i[9]=t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],i[10]=t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],i[11]=t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],i[12]=t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],i[13]=t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],i[14]=t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],i[15]=t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15],i}constructor(){}};const rm=Vi.InitiallyShown;let Ao=class{static parseXml(t,e,i){let n=gi.parseNodeId(e,"Id");n===null&&(console.assert(!1),n=t.generateDynamicNodeId());const r=e.getAttribute("Name");let o=null;const l=[];let h=e.firstElementChild;for(;h!==null;){if(h.localName==="Transformation")console.assert(o===null),o=Vn.parseXml(h),Vn.isIdentity(o)&&(o=null);else if(h.localName==="Attributes"){let g=h.firstElementChild;for(;g!==null;){console.assert(g.localName==="Attr");const y=hr.parseXml(g);l.push(y),g=g.nextElementSibling}}h=h.nextElementSibling}const u=e.getAttribute("ExchangeId"),d=i.ignoreLayers?null:gi.parseLayerId(e,"LayerId");return{nodeId:n,bits:rm,name:r,localTransform:o,attributes:l,header:qs.dynamic,exchangeId:u,layerId:d,genericTypeId:null,genericId:null,userDatas:null}}static parseBinary(t,e,i,n){let r;i.hasBits1(Qe.Id)?r=e.parseNodeId():(console.assert(!1),r=t.generateDynamicNodeId());const o=i.hasBits1(Qe.Name)?e.parseCString():null;let l=rm;if(i.hasBits1(Qe.Visiblity)){const b=e.parseVisibility();b.shown||(l&=~Vi.InitiallyShown),b.removed&&(l|=Vi.InitiallyRemoved)}let h=null;i.hasBits1(Qe.Transform)&&(h=Vn.parseBinary(e),Vn.isIdentity(h)&&(h=null));let u=null;i.hasBits1(Qe.Attributes)&&(u=e.parseDataKey());const d=i.hasBits1(Qe.ExchangeId)?e.parseCString():null;let g=null;if(i.hasBits1(Qe.LayerId)){const b=e.parseLayerId();n.ignoreLayers||(g=b)}let y=null;if(i.hasBits2(cr.GenericTypeId)){const b=e.parseGenericTypeId();n.ignoreGenericTypes||(y=b)}let m=null;i.hasBits2(cr.GenericId)&&(m=e.parseGenericId());let I=null;if(i.hasBits1(Qe.UserData)){I=new Map;const b=e.parseCount_32();for(let x=0;x<b;++x){const C=e.parseUserDataIndex(),P=e.parseCount_32(),k=e.parseBytes(P);I.set(C,k)}}return{nodeId:r,bits:l,name:o,localTransform:h,attributes:u!==null?u:[],header:e.getHeader(),exchangeId:d,layerId:g,genericTypeId:y,genericId:m,userDatas:I}}constructor(){console.assert(!1)}};function Dv(s,t){const e=typeof s=="number";return e===(typeof t=="number")?s<t?-1:s>t?1:0:e?-1:1}class To{static create(t){return new To(t)}constructor(t){this._value=t}get(){return typeof this._value=="function"&&(this._value=this._value()),this._value}}class zn{static create(t){return new zn(t)}constructor(t){typeof t=="function"&&(t=To.create(t)),t instanceof Promise&&(t=this._rectifyResult(t)),this._value=t}isUnforced(){return this._value instanceof To}isResolved(){return!(this._value instanceof To)&&!(this._value instanceof Promise)}getResolved(){return console.assert(this.isResolved()),this._value}then(t,e){return this._value instanceof To&&(this._value=this._rectifyResult(this._value.get())),this._value instanceof Promise?this._value.then(t,e):(this._value,Promise.resolve(this._value).then(t,e))}_rectifyResult(t){return t instanceof Promise?t.then(e=>(this._value=e,e)):t}}function Ov(s){return s==null}function ci(s){return Array.isArray(s)?s.slice():s==null?[]:[s]}function ms(s){return s.length===0?null:s.length===1?s[0]:s}function Xn(s,t){return s?Array.isArray(s)?(s.push(t),s):[s,t]:t}class Jn{constructor(t,e,i){if(this._bits=0,this._nodeId=i.nodeId,this._bits=i.bits,i.name!==null&&(this._name=i.name),i.localTransform!==null&&(this._localTransform=Vn.copy(i.localTransform)),typeof i.attributes=="number"){const n=i.attributes;this._lazyAttributes=Jn._lazyLoadAttributes(t,e,n,i.header)}else i.attributes.length>0&&(this._lazyAttributes=zn.create(i.attributes));i.exchangeId!==null&&(this._exchangeId=i.exchangeId),i.layerId!==null&&(this._layerId=i.layerId),i.genericTypeId!==null&&(this._genericTypeId=i.genericTypeId),i.genericId!==null&&(this._genericId=i.genericId),i.userDatas!==null&&(this._userDatas=hu(i.userDatas))}static _lazyLoadAttributes(t,e,i,n){return zn.create(async()=>{const r=t.getAbstractScEngine(),o=await t.enqueue(()=>r.safeGetMetaData(e,i)),l=[];if(o!==null){const h=new fa(n,o),u=new Vc(h);for(;u.hasNext();){const d=hr.parseBinary(u);l.push(d)}}return l})}hasAuthoredId(){return Ja(this._nodeId)}getAuthoredId(){return hv(this._nodeId)}getName(){return this._name!==void 0?this._name:null}getExchangeId(){return this._exchangeId??null}getAuthoredLayerId(){return this._layerId!==void 0?this._layerId:null}getGenericTypeId(){return this._genericTypeId!==void 0?this._genericTypeId:null}getGenericId(){return this._genericId!==void 0?this._genericId:null}_hasBits(t){return ne(this._bits,t)}isLoaded(){return this._hasBits(Vi.IsLoaded)}markLoaded(){this._bits|=Vi.IsLoaded}_setVisibility(t){this._bits|=Vi.IsShownSpecified,t?this._bits|=Vi.IsShown:this._bits&=~Vi.IsShown}isVisible(){return this._hasBits(Vi.IsShownSpecified)?this._hasBits(Vi.IsShown):this.isInitiallyShown()}isInitiallyShown(){return this._hasBits(Vi.InitiallyRemoved)?!1:this._hasBits(Vi.InitiallyShown)}_toAffineTransformation(t){const e=t.slice();return e[3]=0,e[7]=0,e[11]=0,e[15]=1,e}setLocalTransformAsInitial(t){this._localTransform=this._toAffineTransformation(t)}overrideLocalTransform(t){this._localTransformOverride=this._toAffineTransformation(t)}hasLocalTransformOverride(){return this._localTransformOverride!==void 0}removeLocalTransformOverride(){console.assert(this._localTransformOverride!==void 0),delete this._localTransformOverride}getLocalTransform(){return this._localTransformOverride!==void 0?this._localTransformOverride:this._localTransform!==void 0?this._localTransform:null}async getAttributes(){return this._lazyAttributes!==void 0?this._lazyAttributes.then(t=>{if(this._lazyAttributes!==void 0){for(const e of t)this.addAttribute(e);delete this._lazyAttributes}return this.getAttributes()}):ci(this._attributes)}addAttribute(t){this._attributes=Xn(this._attributes,t)}getUserDataIndices(){const t=[];return this._userDatas!==void 0&&this._userDatas.forEach((e,i)=>{t.push(i)}),t.sort(Dv)}getUserData(t){if(this._userDatas!==void 0){const e=this._userDatas.get(t);if(e!==void 0)return e}throw new Ru(t)}}class Za{static parseBinary(t){const e=t.parseInstanceKey(),i=t.parsePmiTopoRef(),n=t.parseIndex_32();return{bodyInstanceKey:e,topoItemType:i,itemIndex:n}}static reify(t,e){const i=t.getInclusionKey();return new Za(i,e.bodyInstanceKey,e.topoItemType,e.itemIndex)}static fromBodyInstance(t,e,i){const n=t.getInstanceInc();return new Za(n[0],n[1],e,i)}constructor(t,e,i,n){this._inclusionKey=t,this._bodyInstanceKey=e,this._topoItemType=i,this._itemIndex=n}getBodyInstanceInc(){return[this._inclusionKey,this._bodyInstanceKey]}getTopoItemType(){return this._topoItemType}getItemIndex(){return this._itemIndex}}const Dg=class Dg{static parseBinary(t){const e=t.parseLayerParseBits(),i=t.parseLayerId();let n=null;return ne(e,Wp.Name)&&(n=t.parseCString()),{id:i,name:n}}static parseXml(t){const e=t.getAttribute("Name"),i=gi.parseUint(t,"Id");return i===null?(console.error("'Layer' tag missing 'Id' attribute"),null):{id:i,name:e}}constructor(t,e,i,n){this.id=t,this.name=e,this.nodes=i,this.treeNodes=n}};Dg.NoLayerId=-1;let so=Dg;class Qa extends Jn{constructor(t,e,i,n){super(t,e,n.nodeInfo),this._bits|=n.bits,this._modifiers=n.modifierbits,this._parent=i,this._instanceKey=n.instanceKey;const r=this.getAuthoredLayerId();r!==null&&t.registerNodeInLayer(this,r),r!==null&&!this.isOutOfHierarchy()&&t.registerTreeNodeInLayer(this,r),r===null&&!this.isOutOfHierarchy()&&Ja(n.nodeInfo.nodeId)&&(t.registerNodeInLayer(this,so.NoLayerId),t.registerTreeNodeInLayer(this,so.NoLayerId))}setRequested(){this._bits|=Mr.Requested}isRequested(){return this._hasBits(Mr.Requested)}isOutOfHierarchy(){return this._hasBits(Mr.OutOfHierarchy)}preventFromResetting(){return this._hasBits(Mr.PreventFromResetting)}isImplicitBody(){return this._hasBits(Mr.ImplicitBody)}getParent(){return this._parent}getInstanceKey(){return this._instanceKey}hasModifiers(){return this._modifiers!=0}ignoreParentScale(){return ne(this._modifiers,nf.IgnoreParentScale)}ignoreParentRotation(){return ne(this._modifiers,nf.IgnoreParentRotation)}}class zi extends Qa{static parseXml(t,e,i,n){const r=Ao.parseXml(t,e,n),o=gi.parseInstanceKeyFromInc(e,"MeshInstanceKey");if(o===null)throw new ii('Expected "MeshInstanceKey" attribute.');return{nodeInfo:r,inclusionKey:i,instanceKey:o,bits:0,modifierbits:0}}static parseBinary(t,e,i,n){const r=Di(e),o=r.getRemapper(),l=r.getMasterModelKey(),h=i.parseNodeParseBits(),u=Ao.parseBinary(t,i,h,n);let d;if(h.hasBits1(Qe.ScInclusionKey)?d=i.parseInclusionKey(o,l):d=e.getInclusionKey(),!h.hasBits1(Qe.ScInstanceKey))throw new Lo('Expected "ScInstanceKey" in binary data.');const g=i.parseInstanceKey();let y=0;return h.hasBits2(cr.Modifiers)&&(y=i.parseModifiers()),{nodeInfo:u,inclusionKey:d,instanceKey:g,bits:0,modifierbits:y}}static reify(t,e,i,n){const r=Di(i),o=new zi(t,e,i,n);return r.attachedInvisibly()&&o.setVisibility(!1),o}static createDynamic(t,e,i,n,r,o,l,h){const u=Gi(o),g=Di(u).getMasterModelKey(),I={nodeInfo:{nodeId:t.massageAuthoredUserId(u,n),bits:l,name:r,localTransform:null,attributes:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null},inclusionKey:e,instanceKey:i,bits:h,modifierbits:0};return new zi(t,g,o,I)}constructor(t,e,i,n){super(t,e,i,n),t.registerBodyInstance(this,n.inclusionKey)}getName(){const t=super.getName();if(t!==null)return t;const i=this.getParent().getBodyInstances();if(i.length>1){for(let n=0;n<i.length;++n){const r=i[n];if(this===r)return`body ${n+1}`}console.assert(!1)}return"body"}getInstanceInc(){const t=this._instanceKey;let e=ki.Local;return(this.hasAuthoredId()||this.isImplicitBody())&&(e=Gi(this).getInclusionKey()),[e,t]}setVisibility(t){t!==this.isVisible()&&this.getParent().markBranchVisibilityDirty(),this._setVisibility(t)}getRuntimeId(){return Co(this._nodeId,this)}}class Ds extends Qa{static parseBinary(t,e,i,n,r){let o=zi.parseBinary(t,e,i,r);if(n){let l=o.nodeInfo,h=l.bits;h&=~Vi.InitiallyShown,l={...l,bits:h},o={...o,nodeInfo:l}}return o}static reify(t,e,i,n){const r=Di(i),o=new Ds(t,e,i,n);return r.attachedInvisibly()&&o.setVisibility(!1),o}constructor(t,e,i,n){super(t,e,i,n),this._modifiers=n.modifierbits,t.registerPmiBody(this,n.inclusionKey)}getName(){const t=super.getName();return t!==null?t:"PMI body"}getInstanceInc(){const t=this._instanceKey;let e=ki.Local;return(this.hasAuthoredId()||this.isImplicitBody())&&(e=Gi(this).getInclusionKey()),[e,t]}setVisibility(t){t!==this.isVisible()&&this.getParent().getParent().markBranchVisibilityDirty(),this._setVisibility(t)}getRuntimeId(){return Co(this._nodeId,this)}}class Rv{constructor(t){this.faceIds=[],this.edgeIds=[],this.body=t}}class Cn extends Jn{static parseBinary(t,e,i,n){const r=i.parsePmiParseBits(),o=i.parseNodeId();let l=null;ne(r,sa.Name)&&(l=i.parseCString());let h=null;ne(r,sa.ExchangeId)&&(h=i.parseCString());let u=null;ne(r,sa.Attributes)&&(u=i.parseDataKey());let d=1;ne(r,sa.HasMultipleBodies)&&(d=i.parseCount_32());const g=[],y=ne(r,sa.InitiallyHidden);for(let C=0;C<d;++C){const P=Ds.parseBinary(t,e,i,y,n);g.push(P)}const m=g.length>0?ne(g[0].nodeInfo.bits,Vi.InitiallyShown):!1,I=i.parsePmiType(),b=i.parsePmiSubType(),x=[];if(ne(r,sa.TopoRef)){const C=i.parseCount_32();for(let P=0;P<C;++P){const k=Za.parseBinary(i);x.push(k)}}return{nodeId:o,name:l,attributesDataKey:u,pmiBodyInfos:g,initiallyShown:m,pmiType:I,pmiSubType:b,topoRefInfos:x,topoRefs:[],exchangeId:h}}static reify(t,e,i,n){const r=Di(e),o=new Cn(t,e,i,n);return r.attachedInvisibly()&&o.setVisibility(!1),o}static createDynamic(t,e,i,n,r,o,l,h){const d={nodeId:t.generateDynamicNodeId(),name:n,attributesDataKey:null,pmiBodyInfos:l,initiallyShown:!0,pmiType:r,pmiSubType:o,topoRefInfos:[],topoRefs:h,exchangeId:null};return new Cn(t,e,d,i)}constructor(t,e,i,n){const o=Di(e).getMasterModelKey();let l=0;i.initiallyShown&&(l|=Vi.InitiallyShown);const h={nodeId:i.nodeId,bits:l,name:i.name,localTransform:null,attributes:i.attributesDataKey?i.attributesDataKey:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null};super(t,o,h),this._bits|=Mr.PreventFromResetting,this._parent=n,this._packed=Cn._pack(i.pmiType,i.pmiSubType);for(const u of i.pmiBodyInfos){const d=this._loadPmiBody(t,o,u);this._pmiBodies=Xn(this._pmiBodies,d),d.markLoaded()}if(i.topoRefInfos.length>0&&(this._topoRefs=Cn._loadTopoRefs(e,i.topoRefInfos)),i.topoRefs.length>0)if(this._topoRefs===void 0)this._topoRefs=i.topoRefs.slice();else for(const u of i.topoRefs)this._topoRefs.push(u);t.registerPmi(this)}static _loadTopoRefs(t,e){const i=[];for(const n of e){const r=Za.reify(t,n);i.push(r)}return i}_loadPmiBody(t,e,i){return Ds.reify(t,e,this,i)}getPmiBodies(){return ci(this._pmiBodies)}static _pack(t,e){return t+100*e}getPmiType(){return this._packed%100}getPmiSubType(){return Math.floor(this._packed/100)%100}getParent(){return this._parent}getRuntimeId(){return Co(this._nodeId,this)}getBranchVisibility(){let t=this.isVisible()?he.Shown:he.Hidden;for(const e of ci(this._pmiBodies))e.isOutOfHierarchy()||(t|=e.isVisible()?he.Shown:he.Hidden);return t}setVisibility(t){this._setVisibility(t)}getPmiTopologyReferences(t){if(this._topoRefs===void 0)return[];const e=new Map;for(const n of this._topoRefs){const r=n.getBodyInstanceInc(),o=t.lookupAnyBodyByInstanceInc(r[0],r[1]);if(o===null)continue;let l=e.get(o);switch(l===void 0&&(l=new Rv(o),e.set(o,l)),n.getTopoItemType()){case ul.Face:l.faceIds.push(n.getItemIndex());break;case ul.Edge:l.edgeIds.push(n.getItemIndex());break}}const i=[];return e.forEach(n=>{i.push(n)}),i}}class ca{static parseBinary(t){const e=t.parseFloat_64(),i=t.parseFloat_64(),n=t.parsePoint3_64();return new ca(e,i,n)}constructor(t,e,i){this.surfaceArea=t,this.volume=e,this.centerOfGravity=i}}function Lv(s){const t=Kp;switch(s.parseFaceType()){case t.Cylinder:return Fv.parseBinary(s);case t.Plane:return Bv.parseBinary(s);case t.Cone:return Vv.parseBinary(s);case t.Other:return Uv.parseBinary(s);case t.Sphere:return zv.parseBinary(s);case t.Torus:return Hv.parseBinary(s);case t.Blend01:return jv.parseBinary(s);case t.Blend02:return Wv.parseBinary(s);case t.Blend03:return Gv.parseBinary(s);case t.Nurbs:return $v.parseBinary(s);case t.Cylindrical:return qv.parseBinary(s);case t.Offset:return Kv.parseBinary(s);case t.Pipe:return Xv.parseBinary(s);case t.Ruled:return Jv.parseBinary(s);case t.Revolution:return Yv.parseBinary(s);case t.Extrusion:return Zv.parseBinary(s);case t.FromCurves:return Qv.parseBinary(s);case t.Transform:return t0.parseBinary(s);default:throw new Lo("Unexpected measurement face type.")}}class Fv{static parseBinary(t){const e=t.parseFloat_32(),i=t.parsePoint3_32(),n=t.parsePoint3_32();return new Ni(e,i,n)}}class Bv{static parseBinary(t){const e=t.parsePoint3_32(),i=t.parsePoint3_32();return new Wi(e,i)}}class Vv{static parseBinary(t){const e=t.parseFloat_32(),i=t.parsePoint3_32(),n=t.parsePoint3_32(),r=t.parseFloat_32();return new ra(e,i,n,r)}}class zv{static parseBinary(t){const e=t.parseFloat_32(),i=t.parsePoint3_32(),n=t.parsePoint3_32();return new oa(e,i,n)}}class Hv{static parseBinary(t){const e=t.parseFloat_32(),i=t.parseFloat_32(),n=t.parsePoint3_32(),r=t.parsePoint3_32();return new aa(e,i,n,r)}}let Uv=class{static parseBinary(t){return new fc}};class jv{static parseBinary(t){return new gc}}class Wv{static parseBinary(t){return new pc}}class Gv{static parseBinary(t){return new mc}}class $v{static parseBinary(t){return new _c}}class qv{static parseBinary(t){return new yc}}let Kv=class{static parseBinary(t){return new wc}};class Xv{static parseBinary(t){return new vc}}class Jv{static parseBinary(t){return new bc}}class Yv{static parseBinary(t){return new Ic}}class Zv{static parseBinary(t){return new xc}}class Qv{static parseBinary(t){return new Cc}}let t0=class{static parseBinary(t){return new Sc}};function e0(s){const t=qp;switch(s.parseEdgeType()){case t.Line:return i0.parseBinary(s);case t.Circle:return n0.parseBinary(s);case t.Other:return s0.parseBinary(s);default:throw new Lo("Unexpected measurement edge type.")}}let i0=class{static parseBinary(t){const e=t.parseFloat_32();return new dc(e)}},n0=class{static parseBinary(t){const e=t.parseFloat_32(),i=t.parsePoint3_32(),n=t.parsePoint3_32();return new Ya(e,i,n)}};class s0{static parseBinary(t){const e=t.parseFloat_32();return new So(e)}}class tl{constructor(t){this.attributes=t}copy(){return new tl(this.attributes.map(t=>t.copy()))}}function Nc(s,t){return s!==void 0&&t<s.length?s[t]:null}function om(s,t,e){return s===void 0&&(s=[]),s.length=Math.max(s.length,t+1),s[t]=e,s}var el=(s=>(s[s.Unknown=0]="Unknown",s[s.BRep=1]="BRep",s[s.Tessellation=2]="Tessellation",s[s.Wireframe=3]="Wireframe",s[s.PointCloud=4]="PointCloud",s))(el||{});class Ji extends Jn{static parseXml(t,e,i){const n=Ao.parseXml(t,e,i),r=gi.parseMeshKey(e,"TCKey_Mesh");return{nodeInfo:n,meshKey:r,bodyType:0,faceMeasurementProps:[],edgeMeasurementProps:[],physicalProps:null,faceAttributes:[],edgeAttributes:[],pointAttributes:[]}}static parseBinary(t,e,i){const n=e.parseNodeParseBits(),r=Ao.parseBinary(t,e,n,i),o=e.parseBodyType();let l=null;n.hasBits1(Qe.MeshKey)&&(l=e.parseMeshKey());const h=[];if(n.hasBits1(Qe.FaceMeasurement)){const I=e.parseCount_32();for(let b=0;b<I;++b){const x=Lv(e);h.push(x)}}const u=[];if(n.hasBits1(Qe.EdgeMeasurement)){const I=e.parseCount_32();for(let b=0;b<I;++b){const x=e0(e);u.push(x)}}let d=null;n.hasBits1(Qe.PhysicalProperties)&&(d=ca.parseBinary(e));const g=[];if(n.hasBits2(cr.FaceAttributes)){const I=e.parseCount_32();for(let b=0;b<I;b++){const x=[],C=e.parseCount_32();for(let P=0;P<C;P++){const k=hr.parseBinary(e);k.getType()!==gr.Ignored&&x.push(k)}g.push(x.length>0?new tl(x):null)}}const y=[];if(n.hasBits2(cr.EdgeAttributes)){const I=e.parseCount_32();for(let b=0;b<I;b++){const x=[],C=e.parseCount_32();for(let P=0;P<C;P++){const k=hr.parseBinary(e);k.getType()!==gr.Ignored&&x.push(k)}y.push(x.length>0?new tl(x):null)}}const m=[];if(n.hasBits2(cr.PointAttributes)){const I=e.parseCount_32();for(let b=0;b<I;b++){const x=[],C=e.parseCount_32();for(let P=0;P<C;P++){const k=hr.parseBinary(e);k.getType()!==gr.Ignored&&x.push(k)}m.push(x.length>0?new tl(x):null)}}return{nodeInfo:r,meshKey:l,bodyType:o,faceMeasurementProps:h,edgeMeasurementProps:u,physicalProps:d,faceAttributes:g,edgeAttributes:y,pointAttributes:m}}static reify(t,e,i,n){return new Ji(t,e,i,n)}static createDynamic(t,e,i,n,r){const o=r.getInclusionContextForNodeId(),u={nodeInfo:{nodeId:t.massageAuthoredUserId(o,e),bits:Vi.InitiallyShown,name:i,localTransform:null,attributes:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null},meshKey:null,bodyType:0,faceMeasurementProps:[],edgeMeasurementProps:[],physicalProps:null,faceAttributes:[],edgeAttributes:[],pointAttributes:[]};return new Ji(t,n,u,r)}constructor(t,e,i,n){if(super(t,e,i.nodeInfo),this._parent=n,this._bodyType=i.bodyType,i.faceMeasurementProps.length>0&&(this._faceMeasurementProps=i.faceMeasurementProps.slice()),i.edgeMeasurementProps.length>0&&(this._edgeMeasurementProps=i.edgeMeasurementProps.slice()),i.physicalProps!==null&&(this._physicalProps=i.physicalProps),i.faceAttributes.length>0){this._faceAttributes=[];for(const r of i.faceAttributes)this._faceAttributes.push(r===null?null:r.copy())}if(i.edgeAttributes.length>0){this._edgeAttributes=[];for(const r of i.edgeAttributes)this._edgeAttributes.push(r===null?null:r.copy())}if(i.pointAttributes.length>0){this._pointAttributes=[];for(const r of i.pointAttributes)this._pointAttributes.push(r===null?null:r.copy())}t.registerRepresentationItem(this)}setPhysicalProperties(t){this._physicalProps=t}getPhysicalProperties(){return this._physicalProps!==void 0?this._physicalProps:null}getParent(){return this._parent}getFaceCount(){return this._faceMeasurementProps!==void 0?this._faceMeasurementProps.length:0}getEdgeCount(){return this._edgeMeasurementProps!==void 0?this._edgeMeasurementProps.length:0}getFaceAttributes(t){return Nc(this._faceAttributes,t)}getEdgeAttributes(t){return Nc(this._edgeAttributes,t)}getPointAttributes(t){return Nc(this._pointAttributes,t)}getFaceMeasurementProperty(t){return Nc(this._faceMeasurementProps,t)}getEdgeMeasurementProperty(t){return Nc(this._edgeMeasurementProps,t)}setFaceMeasurementProperty(t,e){this._faceMeasurementProps=om(this._faceMeasurementProps,t,e.copy())}setEdgeMeasurementProperty(t,e){this._edgeMeasurementProps=om(this._edgeMeasurementProps,t,e.copy())}getBodyType(){return this._bodyType}getRuntimeId(){return Co(this._nodeId,this._parent.getInclusionContextForNodeId())}}class os extends Jn{static parseXml(t,e,i){let n=Ao.parseXml(t,e,i);if(n.name===null){const l=e.getAttribute("FilePath");l!==null&&(n={...n,name:l})}const r=[];let o=e.firstElementChild;for(;o!==null;){if(o.localName==="Body"){const l=Ji.parseXml(t,o,i);r.push(l)}o=o.nextElementSibling}return{nodeInfo:n,repItemInfos:r}}static parseBinary(t,e,i){const n=e.parseNodeParseBits(),r=Ao.parseBinary(t,e,n,i),o=[];if(n.hasBits1(Qe.Bodies)){const l=e.parseCount_32();for(let h=0;h<l;++h){const u=Ji.parseBinary(t,e,i);o.push(u)}}return{nodeInfo:r,repItemInfos:o}}static reify(t,e,i,n){return new os(t,e,i,n)}static createDynamic(t,e,i){const n=t.getRootNode(),r=Gi(n),h={nodeInfo:{nodeId:t.massageAuthoredUserId(r,e),bits:Vi.InitiallyShown,name:i,localTransform:null,attributes:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null},repItemInfos:[]};return new os(t,r,fs.Local,h)}static createMissing(t){const e=this.createDynamic(t,null,null);return e._bits|=sf.IsMissing,e}isMissing(){return this._hasBits(sf.IsMissing)}constructor(t,e,i,n){const r=i;if(super(t,r,n.nodeInfo),this._inclusionContextForNodeId=e,this._modelKey=i,n.repItemInfos.length>0){const o=this._loadRepresentationItems(t,r,n.repItemInfos);this._repItems=ms(o)}t.registerPartDefinition(this)}_loadRepresentationItems(t,e,i){const n=[];for(const r of i){const o=Ji.reify(t,e,r,this);this._addRepresentationItem(o),n.push(o)}return n}getRuntimeId(){return Co(this._nodeId,this._inclusionContextForNodeId)}getInclusionContextForNodeId(){return this._inclusionContextForNodeId}addReferrer(t){const e=Ks(t),i=Ks(this._inclusionContextForNodeId);console.assert(e===i),this._referrers=Xn(this._referrers,t)}createRepItem(t,e){const i=this._modelKey,n=Ji.createDynamic(t,e,null,i,this);return this._addRepresentationItem(n),n}_addRepresentationItem(t){this._repItems=Xn(this._repItems,t)}getRepresentationItems(){return ci(this._repItems)}getReferrers(){return ci(this._referrers)}removeAllReferrers(){const t=this.getReferrers();for(const e of t){const i=e.removePartDefinition();console.assert(this===i)}delete this._referrers}getModelKey(){return this._modelKey}}class ha{static pushRelatedItemFromParser(t){const e=[];for(const i of t.relationships)e.push({category:i.category,id:i.id,name:i.name});return e}static addFromRelatingElt(t,e){const i=t.related,n=t.type;if(n!=null)if(!e.has(n)&&i!==null)e.set(n,{related:this.pushRelatedItemFromParser(i),relating:[]});else{const r=t.related;if(r!==null)for(const o of r.relationships){const l=e.get(n);l!==void 0&&this.findBimObjectInArray(l.related,{id:o.id,category:o.category,name:o.name})===!1&&l.related.push({id:o.id,category:o.category,name:o.name})}}}static findBimObjectInArray(t,e){for(const i of t)if(i.category===e.category&&i.name===e.name&&i.id===e.id)return!0;return!1}static addFromRelatedElt(t,e){const i=t.type;i!==null&&!e.has(i)&&t.relating!==null&&e.set(i,{related:[],relating:[{category:t.relating.relationElt.category,id:t.relating.relationElt.id,name:t.relating.relationElt.name}]})}static findIndexInRelated(t,e){let i=-1,n=0;for(const r of e){if(r.id===t){i=n;break}n++}return i}}class ro extends Qa{static parseXml(t,e,i,n){return zi.parseXml(t,e,i,n)}static parseBinary(t,e,i,n){return zi.parseBinary(t,e,i,n)}static reify(t,e,i,n){const r=Di(i),o=new ro(t,e,i,n);return r.attachedInvisibly()&&o.setVisibility(!1),o}constructor(t,e,i,n){super(t,e,i,n),this._bits&=~Vi.InitiallyShown,t.registerViewFrame(this,n.inclusionKey)}getName(){const t=this.getName();return t!==null?t:"CAD View frame"}getInstanceInc(){const t=this._instanceKey;let e=ki.Local;return(this.hasAuthoredId()||this.isImplicitBody())&&(e=Gi(this).getInclusionKey()),[e,t]}setVisibility(t){t!==this.isVisible()&&this.getParent().getParent().markBranchVisibilityDirty(),this._setVisibility(t)}getRuntimeId(){return Co(this._nodeId,this)}}var zt=(s=>(s[s.None=0]="None",s[s.LoadedNodesOnly=1]="LoadedNodesOnly",s))(zt||{});class am{constructor(t){this._configuration=t.configuration,this._visibilityFormatter=t.visibilityFormatter,this._resetNonAffectedToDefault=t.resetNonAffectedToDefault,this._resetNonAffectedPmiToDefault=t.resetNonAffectedPmiToDefault,this._state={currentNode:null,nodeConfiguration:null,appliedVisibility:null,inheritedVisibilityStack:[],bodiesToShow:[],bodiesToHide:[]},this.enterProductOccurrence=this.enterProductOccurrence.bind(this),this.leaveProductOccurrence=this.leaveProductOccurrence.bind(this),this.enterAnyBody=this.enterAnyBody.bind(this),this.leaveAnyBody=this.leaveAnyBody.bind(this),this.enterCadView=this.enterCadView.bind(this),this.leaveCadView=this.leaveCadView.bind(this),this.enterPmi=this.enterPmi.bind(this),this.leavePmi=this.leavePmi.bind(this)}get visibilityFormatter(){return this._visibilityFormatter}set visibilityFormatter(t){this._visibilityFormatter=t}get currentNode(){return this._state.currentNode}get configuration(){return this._configuration}get nodeConfiguration(){return this._state.nodeConfiguration}get appliedVisibility(){return this._state.appliedVisibility}get state(){return this._state}get result(){return{bodies:{hide:this._state.bodiesToHide,show:this._state.bodiesToShow}}}_updateNodeVisibility(t){this._updateVisitorState(t,!1);const e=this.appliedVisibility;e!==null&&t.setVisibility(e)}_getVisibilityConfig(){const t=this.currentNode,e=t.isInitiallyShown();let i=e;return!this._configuration.initially.shown&&this._configuration.filterByConfiguration&&(i=i||!this._configuration.containsAnyConfig||this._configuration.containsCurrentConfig),{explicitVisibility:this._visibilityFormatter?this._visibilityFormatter(t):void 0,visible:t.isVisible(),initiallyShown:e,initiallyOrConfigurationShown:i}}_getPmiBodyVisibility(){const e=this.currentNode.getParent();return this._visibilityFormatter&&this._visibilityFormatter(e)===!0?!0:null}_getInitiallyHiddenNodeVisibility(){return this.currentNode instanceof Ds?this._getPmiBodyVisibility():null}_getInheritedVisibility(){const t=this._state.inheritedVisibilityStack[this._state.inheritedVisibilityStack.length-1];return t!==this.nodeConfiguration.visible?t&&!this.nodeConfiguration.initiallyShown&&this._configuration.initially.immutableHidden?this._getInitiallyHiddenNodeVisibility():t:null}_handleNonAffectedNodeVisibility(){return typeof this._resetNonAffectedPmiToDefault<"u"&&this.state.currentNode!==null&&(this.state.currentNode instanceof Cn||this.state.currentNode instanceof Ds)?this._resetNonAffectedPmiToDefault&&this.nodeConfiguration.visible!==this.nodeConfiguration.initiallyOrConfigurationShown?this._state.nodeConfiguration.initiallyOrConfigurationShown:null:this._resetNonAffectedToDefault&&this.nodeConfiguration.visible!==this.nodeConfiguration.initiallyOrConfigurationShown?this._state.nodeConfiguration.initiallyOrConfigurationShown:null}_getNodeVisibility(t){return this.nodeConfiguration&&this.nodeConfiguration.explicitVisibility!==void 0?this.nodeConfiguration.explicitVisibility:Do(this.currentNode)?null:this._configuration.node!==void 0&&this._configuration.filterByConfiguration&&this._configuration.containsAnyConfig&&!this._configuration.containsCurrentConfig?!1:this._state.inheritedVisibilityStack.length>0?this._getInheritedVisibility():t?null:this._handleNonAffectedNodeVisibility()}_updateVisitorState(t,e){this._state.currentNode=t,this._state.nodeConfiguration=this._getVisibilityConfig(),this._state.nodeConfiguration.explicitVisibility!==void 0?this._state.inheritedVisibilityStack.push(this._state.nodeConfiguration.explicitVisibility):this._state.inheritedVisibilityStack.length>0&&this._state.inheritedVisibilityStack.push(this._state.inheritedVisibilityStack[this._state.inheritedVisibilityStack.length-1]),this._state.appliedVisibility=this._getNodeVisibility(e)}leaveNode(){this._state.inheritedVisibilityStack.length>0&&this._state.inheritedVisibilityStack.pop()}enterProductOccurrence(t){t.isAConfigurationNode()&&(this._configuration.containsAnyConfig=!0,this._configuration.node===t&&(this._configuration.containsCurrentConfig=!0)),this._updateNodeVisibility(t)}leaveProductOccurrence(t){this.leaveNode(),t.isAConfigurationNode()&&(this._configuration.containsAnyConfig=!1,this._configuration.node===t&&(this._configuration.containsCurrentConfig=!1))}enterPmi(t){this._updateNodeVisibility(t)}leavePmi(t){this.leaveNode()}enterCadView(t){this._updateNodeVisibility(t)}leaveCadView(t){this.leaveNode()}enterAnyBody(t){const e=t.preventFromResetting();this._updateVisitorState(t,e);const i=this.appliedVisibility;i!==null&&(t.setVisibility(i),i?this._state.bodiesToShow.push(t):this._state.bodiesToHide.push(t))}leaveAnyBody(t){return this.leaveNode()}}class r0 extends am{constructor(t){super(t),this.enterProductOccurrence=this.enterProductOccurrence.bind(this)}enterProductOccurrence(t){t.isAConfigurationNode()&&(this.configuration.containsAnyConfig=!0,this.configuration.node===t&&(this.configuration.containsCurrentConfig=!0)),this._updateVisitorState(t,!0)}}async function lm(s,t=!1){const e=new Set,i=new Set,n=l=>t?l.isInitiallyShown():l.isVisible(),r={enterAnyBody:l=>{if(l instanceof zi){const h=l.getRuntimeId();n(l)?e.add(h):i.add(h)}}};await Nn.walk(r,s,zt.None);const o=e.size>=i.size;return new Bm(o,o?i:e)}function Cu(s){const t=[];for(const e of s){const i=e.getInstanceInc();t.push(i[0],i[1])}return t}function cm(s){const t=[];for(const e of s){const i=e.getRuntimeId();t.push(i)}return t}class hm{constructor(t){this._assemblyTree=t.assemblyTree,this._engine=t.engine,this._callbackManager=t.callbackManager,this._startNode=t.startNode,this._setVisibility=t.setVisibility,this._initiallyHiddenStayHidden=t.initiallyHiddenStayHidden,this._configurationNode=t.configurationNode,this._configuration=null}static getAttachContextFormatter(t,e){return i=>{if(i instanceof me&&t.getChildren().indexOf(i)!==-1)switch(e){case to.Hide:return!1;case to.Show:return!0;case to.Initial:return}}}get configuration(){return this._configuration}async _generateConfig(){let t=!1,e=!1,i=!1,n=!1;if(this._configurationNode){console.assert(this._configurationNode.isAConfigurationNode()),t=!0;const r=await lm(this._configurationNode,!0);if((r.defaultVisibility||r.visibilityExceptions.size!==0)&&(n=!0),!(this._startNode instanceof Sn)){let o=this._startNode;for(;o!==null;){if(o instanceof me&&o.isAConfigurationNode()){i=!0,o===this._configurationNode&&(e=!0);break}const l=o.getParent();if(!(l instanceof me))break;o=l}}}return this._initiallyHiddenStayHidden===void 0&&(this._configurationNode!==void 0?this._initiallyHiddenStayHidden=n:this._initiallyHiddenStayHidden=this._assemblyTree.getInitiallyHiddenStayHidden()),{filterByConfiguration:t,containsCurrentConfig:e,containsAnyConfig:i,node:this._configurationNode,setVisibility:this._setVisibility,initially:{shown:n,immutableHidden:this._initiallyHiddenStayHidden}}}_applyVisibilities(t){if(this._setVisibility){const e=this._startNode.getAttachScope();console.assert(e!==ta.OfInitialEmptyModel),this._engine.setVisibilityByAttachment(e,this._setVisibility)}else{const e=Cu(t.show),i=Cu(t.hide);if(this._engine.pauseAllRendering(),this._engine.setPartVisibility(e,!0,!0),this._engine.setPartVisibility(i,!1,!0),this._engine.resumeAllRendering(),this._callbackManager){const n=cm(t.show),r=cm(t.hide);this._callbackManager.trigger("visibilityChanged",n,r)}}}async traverse(t,e){await Nn.walk(t,e||this._startNode,zt.None)}async init(){this._startNode instanceof Sn||console.assert(this._setVisibility===void 0),this._configuration=await this._generateConfig()}async quit(){}async update(t,e,...i){const n=new t({...e,configuration:this.configuration},...i);return await this.traverse(n),this._applyVisibilities(n.result.bodies),n}async updatePerNode(t,e,i,...n){const r=new t({...i,configuration:this.configuration},...n);return e.forEach(async(o,l)=>{const h=r.visibilityFormatter;r.visibilityFormatter=u=>u===u?o:h?h(u):void 0,await this.traverse(r,l),r.visibilityFormatter=h}),this._applyVisibilities(r.result.bodies),r}}async function o0(s){return _f({...s,startNode:s.attachContext,visibilityFormatter:hm.getAttachContextFormatter(s.attachContext,s.setVisibility),resetNonAffectedToDefault:s.setVisibility===to.Initial,initiallyHiddenStayHidden:s.setVisibility!==to.Show})}async function mf(s){return _f(s)}async function a0(s){return _f({...s,visitorType:r0})}async function _f(s,...t){const e=new hm({assemblyTree:s.assemblyTree,engine:s.engine,callbackManager:s.callbackManager,startNode:s.startNode,setVisibility:s.setVisibility!==null?s.setVisibility:void 0,initiallyHiddenStayHidden:s.initiallyHiddenStayHidden,configurationNode:s.configurationNode});await e.init();const i=await e.update(s.visitorType||am,{visibilityFormatter:s.visibilityFormatter,resetNonAffectedToDefault:s.resetNonAffectedToDefault,resetNonAffectedPmiToDefault:s.resetNonAffectedPmiToDefault},...t);console.assert(i.state.inheritedVisibilityStack.length===0),await e.quit()}async function l0(s,t){const e=[],i=[],n={enterAnyBody:l=>{if(l instanceof Ds||l instanceof ro){const h=l.isVisible();l.setVisibility(h),h?e.push(l):i.push(l)}}};await Nn.walk(n,t,zt.None);const r=Cu(e),o=Cu(i);s.pauseAllRendering(),s.synchronizeVisibilities(r,!0),s.synchronizeVisibilities(o,!1),s.resumeAllRendering()}const il=0,yf=s=>(s+1>>>1)-1,Su=s=>(s<<1)+1,Dc=s=>s+1<<1;class c0{constructor(t){this._heap=[],this._comparator=t}clear(){this._heap.length=0}get length(){return this._heap.length}peek(){return this._heap[il]}push(t){this._heap.push(t),this._siftUp()}pop(){const t=this.peek(),e=this.length-1;return e>il&&this._swap(il,e),this._heap.pop(),this._siftDown(),t}replace(t){const e=this.peek();return this._heap[il]=t,this._siftDown(),e}_greater(t,e){return this._comparator(this._heap[t],this._heap[e])}_swap(t,e){[this._heap[t],this._heap[e]]=[this._heap[e],this._heap[t]]}_siftUp(){let t=this.length-1;for(;t>il&&this._greater(t,yf(t));)this._swap(t,yf(t)),t=yf(t)}_siftDown(){let t=il;for(;Su(t)<this.length&&this._greater(Su(t),t)||Dc(t)<this.length&&this._greater(Dc(t),t);){const e=Dc(t)<this.length&&this._greater(Dc(t),Su(t))?Dc(t):Su(t);this._swap(t,e),t=e}}}class um{constructor(t,e,i){this._lazyPromise=t,this._wrapperPromise=e,i!==null&&(this.compareValue=i)}kill(){this._lazyPromise=null}cancel(t){this._lazyPromise=null,this._wrapperPromise.resolve(t)}fetch(t,e){this._lazyPromise===null?(this._wrapperPromise.reject(null),setTimeout(e,0)):t(this._lazyPromise).then(i=>{this._wrapperPromise.resolve(i)}).catch(i=>{this._wrapperPromise.reject(i)})}}class dm{constructor(t,e,i){this._failed=!1,this._failureError=null,this._activePromiseCount=0,this._idlePromise=null,this._latestPromise=Promise.resolve(),this._needsResorting=!1,console.assert(t>0,"Don't create a non-progressible queue."),this._maxActivePromises=t,this._deferredPromises=e,this._failureFailsAll=i}maxActivePromises(){return this._maxActivePromises}activePromiseCount(){return this._activePromiseCount}isIdle(){return this._activePromiseCount===0}async waitForIdle(){if(this.isIdle()){if(this._failureFailsAll&&this._failed)throw this._failureError;return}return this._idlePromise===null&&(this._idlePromise=mi()),this._idlePromise}killDeferred(){const t=[];for(;this._deferredPromises.length>0;){const e=this._dequeue();e.kill(),t.push(e)}for(const e of t)this._queue(e)}_push(t,e){typeof t=="function"&&(t=gs.create(t));let i;return this._activePromiseCount<this._maxActivePromises?i=this._immediatePromise(t):i=this._deferPromise(t,e),this._latestPromise=i,i}_resort(){console.assert(this._needsResorting),this._needsResorting=!1;const t=this._drainQueue();for(const e of t)this._queue(e)}_drainQueue(){const t=[];for(;this._deferredPromises.length>0;){const e=this._dequeue();t.push(e)}return t}_deferPromise(t,e){const i=mi(),n=new um(t,i,e);return this._queue(n),i}async _immediatePromise(t){if(this._failureFailsAll&&this._failed)throw this._failureError;++this._activePromiseCount;try{const e=await t.get();return this._finalizePromise(),e}catch(e){throw this._failureFailsAll&&!this._failed&&(this._failed=!0,this._failureError=e,this._idlePromise!==null&&this._idlePromise.reject(e)),this._finalizePromise(),e}}_fetchNext(){this._dequeue().fetch(t=>this._immediatePromise(t),()=>{this._finalizePromise()})}_finalizePromise(){--this._activePromiseCount,this._deferredPromises.length>0?(this._needsResorting&&this._resort(),this._fetchNext()):this._activePromiseCount===0&&(this._idlePromise!==null&&(this._failureFailsAll&&this._failed?this._idlePromise.reject(this._failureError):this._idlePromise.resolve(),this._idlePromise=null),this._latestPromise=Promise.resolve())}}class No extends dm{_queue(t){this._deferredPromises.push(t)}_dequeue(){return this._deferredPromises.pop()}constructor(t,e){super(t,new $p,e)}push(t){return this._push(t,null)}async waitOnLatest(){await this._latestPromise}}class fm extends dm{_queue(t){this._deferredPromises.push(t)}_dequeue(){return this._deferredPromises.pop()}constructor(t,e,i){const n=(o,l)=>e(o.compareValue,l.compareValue),r=new c0(n);super(t,r,i)}push(t,e){return this._push(t,e)}markDirty(){this._needsResorting=!0}}class h0 extends No{_queue(t){this._deferredPromises.clear(),this._deferredPromises.push(t)}constructor(t){super(1,t)}}class u0 extends fm{constructor(t,e,i,n,r){super(i,n,r),this._cutoffAttachments=[],this._attachPriorityManager=e,this._cutoffScale=t}setCutoffScale(t){this._cutoffScale=Math.max(Math.min(t,2),0)}cutoffEnabled(){return this._cutoffScale!==0}isEmpty(){return this._cutoffAttachments.length===0&&this._deferredPromises.length===0}killDeferred(){const t=this._drainQueue(),e=this._cutoffAttachments;this._cutoffAttachments=[];for(const i of t)i.cancel(null);for(const i of e)i.cancel(null)}_getCutoffValue(){return this._cutoffScale*-this._attachPriorityManager.getCalculatedCutoff()-1}push(t,e){if(!this.cutoffEnabled())return this._push(t,e);const i=this._attachPriorityManager.getPriorityCompareValue(e),n=this._getCutoffValue();if(i>n){typeof t=="function"&&(t=gs.create(t));const r=mi(),o=new um(t,r,e);return this._cutoffAttachments.push(o),r}else return this._push(t,e)}_resort(){if(!this.cutoffEnabled()){super._resort();return}this._needsResorting=!1;const t=this._drainQueue(),e=this._cutoffAttachments;this._cutoffAttachments=[],this._updateDeferredPromiseArray(t),this._updateDeferredPromiseArray(e)}update(){if(!this.cutoffEnabled()){this.markDirty();return}this._cutoffAttachments.length>0&&(this._resort(),this._refillQueue())}_refillQueue(){const t=Math.min(this.maxActivePromises()-this.activePromiseCount(),this._deferredPromises.length);for(let e=0;e<t;e++)this._fetchNext()}_updateDeferredPromiseArray(t){for(const e of t){const i=this._attachPriorityManager.getPriorityCompareValue(e.compareValue),n=this._getCutoffValue();i>n?this._cutoffAttachments.push(e):this._queue(e)}}}async function Oc(s,t,e,i){const n=[],r=[],o=[],l=new Set,h=(m,I)=>{if(!m.hasModifiers())return I;const b=m.getLocalTransform();if(b!=null){let x=I;if(m.ignoreParentScale()&&m.ignoreParentRotation())I=Vn.copy(b);else if(m.ignoreParentScale()){let C=new _(I[0],I[1],I[2]).length(),P=new _(b[0],b[1],b[2]).length();if(C>0){const k=P/C,O=new _t;O.setScaleComponent(k,k,k),I=Vn.multiply(I,O.m)}}else{let C=new _(I[0],I[1],I[2]).length();if(C>0){const P=C,k=new _t;k.setScaleComponent(P,P,P),I=k.m}}I[12]=x[12],I[13]=x[13],I[14]=x[14]}return I},u=m=>{if(l.has(m))return!1;l.add(m);const I=m.getLocalTransform();if(I!==null){let b=n[n.length-1];b=Vn.multiply(I,b),n.push(b)}return!0},d=m=>{m.getLocalTransform()!==null&&(console.assert(n.length>1),n.pop())},g={followProductOccurrence:u,leaveProductOccurrence:d,followPmi:u,leavePmi:d,followCadView:u,leaveCadView:d,followAnyBody:u,enterAnyBody:m=>{if(!m.isOutOfHierarchy()||i){const I=m.getInstanceInc();o.push(I[0],I[1]);const b=h(m,n[n.length-1]);r.push(_t.createFromArray(b))}},leaveAnyBody:d},y=new No(1,!0);for(const m of e){const I=gs.create(async()=>{console.assert(n.length===0);const b=zc(m.getParent());n.push(b),await Nn.walk(g,m,zt.None),console.assert(n.length===1),n.pop()});y.push(I)}await y.waitForIdle(),console.assert(2*r.length===o.length),s.setMatrices(o,r),t.trigger("_updateTransform",i)}function Pu(s){return s.isLoaded()}function nl(){return!0}function $s(){}class gm{constructor(t,e){this.followProductOccurrence=nl,this.enterProductOccurrence=$s,this.leaveProductOccurrence=$s,this.followPartDefinition=nl,this.enterPartDefinition=$s,this.leavePartDefinition=$s,this.followRepresentationItem=nl,this.enterRepresentationItem=$s,this.leaveRepresentationItem=$s,this.followAnyBody=nl,this.enterAnyBody=$s,this.leaveAnyBody=$s,this.followCadView=nl,this.enterCadView=$s,this.leaveCadView=$s,this.followPmi=nl,this.enterPmi=$s,this.leavePmi=$s,e===zt.LoadedNodesOnly&&(console.assert(t.followProductOccurrence===void 0),console.assert(t.followAnyBody===void 0),console.assert(t.followCadView===void 0),console.assert(t.followPmi===void 0),this.followProductOccurrence=Pu,this.followAnyBody=Pu,this.followCadView=Pu,this.followPmi=Pu),t.followProductOccurrence!==void 0&&(this.followProductOccurrence=t.followProductOccurrence),t.enterProductOccurrence!==void 0&&(this.enterProductOccurrence=t.enterProductOccurrence),t.leaveProductOccurrence!==void 0&&(this.leaveProductOccurrence=t.leaveProductOccurrence),t.followPartDefinition!==void 0&&(this.followPartDefinition=t.followPartDefinition),t.enterPartDefinition!==void 0&&(this.enterPartDefinition=t.enterPartDefinition),t.leavePartDefinition!==void 0&&(this.leavePartDefinition=t.leavePartDefinition),t.followRepresentationItem!==void 0&&(this.followRepresentationItem=t.followRepresentationItem),t.enterRepresentationItem!==void 0&&(this.enterRepresentationItem=t.enterRepresentationItem),t.leaveRepresentationItem!==void 0&&(this.leaveRepresentationItem=t.leaveRepresentationItem),t.followAnyBody!==void 0&&(this.followAnyBody=t.followAnyBody),t.enterAnyBody!==void 0&&(this.enterAnyBody=t.enterAnyBody),t.leaveAnyBody!==void 0&&(this.leaveAnyBody=t.leaveAnyBody),t.followCadView!==void 0&&(this.followCadView=t.followCadView),t.enterCadView!==void 0&&(this.enterCadView=t.enterCadView),t.leaveCadView!==void 0&&(this.leaveCadView=t.leaveCadView),t.followPmi!==void 0&&(this.followPmi=t.followPmi),t.enterPmi!==void 0&&(this.enterPmi=t.enterPmi),t.leavePmi!==void 0&&(this.leavePmi=t.leavePmi)}}class Rc{static walk(t,e,i){if(i===zt.LoadedNodesOnly&&!e.isLoaded())return;const n=new Rc(t,i);return e instanceof me?n._walkProductOccurrence(e):e instanceof Cn?n._walkPmi(e):e instanceof as?n._walkCadView(e):n._walkAnyBody(e)}constructor(t,e){this._visitor=new gm(t,e)}_walkRepresentationItem(t){console.assert(t.isLoaded()),this._visitor.followRepresentationItem(t)&&(this._visitor.enterRepresentationItem(t),this._visitor.leaveRepresentationItem(t))}_walkPartDefinition(t){if(console.assert(t.isLoaded()),this._visitor.followPartDefinition(t)){this._visitor.enterPartDefinition(t);const e=t.getRepresentationItems();for(const i of e)this._walkRepresentationItem(i);this._visitor.leavePartDefinition(t)}}_walkAnyBody(t){console.assert(t.isLoaded()),this._visitor.followAnyBody(t)&&(this._visitor.enterAnyBody(t),this._visitor.leaveAnyBody(t))}_walkPmi(t){if(console.assert(t.isLoaded()),this._visitor.followPmi(t)){this._visitor.enterPmi(t);for(const e of t.getPmiBodies())this._walkAnyBody(e);this._visitor.leavePmi(t)}}_walkCadView(t){if(console.assert(t.isLoaded()),this._visitor.followCadView(t)){this._visitor.enterCadView(t);const e=t.getViewFrame();e!==null&&this._walkAnyBody(e),this._visitor.leaveCadView(t)}}_walkProductOccurrence(t){if(console.assert(t.isLoaded()),this._visitor.followProductOccurrence(t)){this._visitor.enterProductOccurrence(t);const e=t.getPartDefinitionSync();e!==null&&this._walkPartDefinition(e);const i=t.getChildrenSync();for(const l of i)this._walkProductOccurrence(l);const n=t.getBodyInstances();for(const l of n)this._walkAnyBody(l);const r=t.getPmis();for(const l of r)this._walkPmi(l);const o=t.getCadViews();for(const l of o)this._walkCadView(l);this._visitor.leaveProductOccurrence(t)}}}function pm(s,t,e,i,n,r){const o=[],h={enterAnyBody:d=>{if(n.has(d))return;if(n.add(d),d instanceof zi){if(!ne(e,jt.BodyInstance)||d.isOutOfHierarchy()&&!i)return}else if(d instanceof Ds){if(!ne(e,jt.PmiBody))return}else if(!ne(e,jt.ViewFrame))return;const g=d.getInstanceInc();o.push(g[0],g[1])}},u=s.walk(h,t,r);return u?u.then(()=>o):o}function mm(s,t,e,i){return pm(Nn,s,t,e,i,zt.None)}function Lc(s,t,e,i,n){return pm(Rc,s,t,e,i,n)}function _m(s,t,e,i){let n=null;const r=new Set;for(const o of t){const l=s.lookupAnyTreeNode(o);if(l===null)throw new _s(o);const h=Do(l),u=Lc(l,e,h,r,i);if(n===null)n=u;else for(const d of u)n.push(d)}return n!==null?n:[]}async function ym(s,t,e,i,n,r){const o=_m(s,e,i,zt.None);if(o.length===0)throw new ae("Cannot get the bounding of node without geometry.");return t.getPartsBounding(o,n,r)}function d0(s,t){const e=new No(1,!0);e.push(()=>s.clear());for(const i of t)e.push(()=>s.addPlane(i,null));return e.waitForIdle()}function f0(s,t,e){const i=e.getRuntimeId(),n=s.get(i);n!==void 0?(e.overrideLocalTransform(n),t.push(e)):e.hasLocalTransformOverride()&&(e.removeLocalTransformOverride(),t.push(e))}function g0(s,t){t.hasLocalTransformOverride()&&(t.removeLocalTransformOverride(),s.push(t))}class as extends Jn{static parseXml(t,e,i,n){let r=0;const o=gi.parseNodeId(e,"Id");if(o===null)throw new ii('Expected "Id" attribute.');const l=e.getAttribute("Name");if(l===null)throw new ii('Expected "Name" attribute');const h=(Y,q,st,ft)=>{const U=Y.getAttribute("Enabled");if(U===null)throw new ii(`Expected ${st} attribute`);return q=na(q,ft,U==="1"),q},u=e.getAttribute("isAnnotationView");u===null?r=na(r,Ci.IsAnnotationView,!1):r=na(r,Ci.IsAnnotationView,u==="true");let d=null,g=null,y=[],m=[],I=[],b=[],x=new Map,C=[];const P=Y=>{const q=gi.parseUint(Y,"Projection");if(q===null)throw new ii('Expected "Projection" attribute');const st=Y.getAttribute("field");if(st===null)throw new ii('Expected "field" attribute');const ft=st.split(" ");if(ft.length!==2)throw new ii("Expected 2 field values");const U=parseFloat(ft[0]),J=parseFloat(ft[1]),A=Y.getAttribute("definition");if(A===null)throw new ii('Expected "definition" attribute');const R=A.split(" ");if(R.length!==9)throw new ii("Expected 9 definition values");const bt=(Tt,lt)=>new _(parseFloat(Tt[lt]),parseFloat(Tt[lt+1]),parseFloat(Tt[lt+2])),z=bt(R,0),Pt=bt(R,3),X=bt(R,6);return dn.create(z,Pt,X,q,U,J)},k=Y=>{if(gi.parseUint(Y,"Count")===null)throw new ii('Expected "Count" attribute');const st=gi.parseUints(Y,"FilterIds");if(st===null)throw new ii('Expected "FilterIds" attribute');return st},O=Y=>{const q=[];if(gi.parseUint(Y,"Count")===null)throw new ii('Expected "PMIToShow Count" attribute');const ft=gi.parseNodeIds(Y,"IDs");if(ft===null)throw new ii('Expected "PMIToShow Ids" attribute');for(let U=0;U<ft.length;U+=2)q.push(ft[U+1]);return q},B=Y=>{const q=[],st=gi.parseUint(Y,"Count");if(st===null)throw new ii('Expected "ClipPlanes Count" attribute');const ft=gi.parseFloats(Y,"Plane");if(ft===null)throw new ii('Expected "Plane" attribute');if(ft.length/4!==st)throw new ii(`Expected ${st} Planes`);for(let U=0;U<ft.length;U+=4)q.push(Ki.createFromCoefficients(ft[U],ft[U+1],ft[U+2],ft[U+3]));return q},j=Y=>{const q=new Map,st=gi.parseUint(Y,"Count");if(st===null)throw new ii('Expected "IDLocalTransform Count" attribute');const ft=gi.parseFloats(Y,"IDTransform");if(ft===null)throw new ii('Expected "IDTransform" attribute');{if(ft.length/13!==st)throw new ii(`Expected ${st} IDTransform values`);const U=(J,A)=>{const R=Vn.getIdentity();return R[1]=J[A+1],R[2]=J[A+2],R[3]=J[A+3],R[4]=J[A+4],R[6]=J[A+5],R[7]=J[A+6],R[8]=J[A+7],R[9]=J[A+8],R[11]=J[A+9],R[12]=J[A+10],R[13]=J[A+11],R[14]=J[A+12],R};for(let J=0;J<ft.length;J+=13){const A=ft[J],R=U(ft,J);q.set(A,R)}}return q};let V=e.firstElementChild;for(;V!==null;)V.localName==="Camera"?(console.assert(d===null),d=P(V)):V.localName==="Frame"?g=ro.parseXml(t,V,i.getInclusionKey(),n):V.localName==="PMIToShow"?y=O(V):V.localName==="InstanceToShow"?m=gi.parseNodeIds(V,"IDs"):V.localName==="InstanceToHide"?I=gi.parseNodeIds(V,"IDs"):V.localName==="ClipPlanes"?C=B(V):V.localName==="IDLocalTransform"?x=j(V):V.localName==="IsCameraSet"?r=h(V,r,"IsCameraSet",Ci.IsCameraSet):V.localName==="IsPMIFilteringSet"?r=h(V,r,"IsPMIFilteringSet",Ci.IsPmiFilteringSet):V.localName==="IsGeomFilteringSet"?r=h(V,r,"IsGeomFilteringSet",Ci.IsGeomFilteringSet):V.localName==="IsCrosssectionSet"?r=h(V,r,"IsCrosssectionSet",Ci.IsCrossSectionSet):V.localName==="IsExplosionSet"?r=h(V,r,"IsExplosionSet",Ci.IsExplosionSet):V.localName==="IsCombineState"?r=h(V,r,"IsCombineState",Ci.IsCombineState):V.localName==="Filters"&&(b=k(V)),V=V.nextElementSibling;return{nodeId:o,name:l,camera:d,instanceMarkupKeysToShow:y,viewFrameInfo:g,nodesToShow:m??[],nodesToHide:I??[],filters:b??[],transformMap:x,cuttingPlanes:C,bits:r}}static parseBinary(t,e,i,n){const r=i.parseViewParseBits(),o=i.parseNodeId();let l=null;ne(r,xn.Name)&&(l=i.parseCString());let h=0,u=!1;ne(r,xn.IsAnnotationView)?(u=!0,l+=" # Annotation View"):l!==null&&l.indexOf("# Annotation View")>=0&&(u=!0),u&&(h|=Ci.IsAnnotationView),ne(r,xn.IsNotPmiFilteringSet)||(h|=Ci.IsPmiFilteringSet),ne(r,xn.IsNotGeomFilteringSet)||(h|=Ci.IsGeomFilteringSet),ne(r,xn.IsNotCrosssectionSet)||(h|=Ci.IsCrossSectionSet),ne(r,xn.IsNotExplosionSet)||(h|=Ci.IsExplosionSet),ne(r,xn.IsCombineState)&&(h|=Ci.IsCombineState),ne(r,xn.IsDefaultView)&&(h|=Ci.IsDefaultView);const d=ne(r,xn.IsPerspective);d&&(h|=Ci.IsPerspective);let g=null;if(ne(r,xn.Camera)){const k=d?ti.Perspective:ti.Orthographic,O=i.parsePoint3_32(),B=i.parsePoint3_32(),j=i.parsePoint3_32(),V=i.parseFloat_32(),Y=i.parseFloat_32();ne(r,xn.IsNotCameraSet)||(h|=Ci.IsCameraSet,g=dn.create(O,B,j,k,V,Y),(V<0||Y<0)&&(h|=Ci.HasDynamicFrame))}const y=[];if(ne(r,xn.Pmi)){const k=i.parseCount_32();for(let O=0;O<k;++O){const B=i.parseInstanceKey();y.push(B)}}let m=null;ne(r,xn.Frame)&&(m=ro.parseBinary(t,e,i,n));const I=[];if(ne(r,xn.ShowNodes)){const k=i.parseCount_32();for(let O=0;O<k;++O){const B=i.parseNodeId();I.push(B)}}const b=[];if(ne(r,xn.HideNodes)){const k=i.parseCount_32();for(let O=0;O<k;++O){const B=i.parseNodeId();b.push(B)}}const x=new Array;if(ne(r,xn.ViewFilters)){const k=i.parseCount_32();for(let O=0;O<k;++O){const B=i.parseUInt32();x.push(B)}}const C=new Map;if(ne(r,xn.MoveNodes)){const k=i.parseCount_32();for(let O=0;O<k;++O){const B=i.parseNodeId(),j=Vn.parseBinary(i);C.set(B,j)}}const P=[];if(ne(r,xn.CuttingPlanes)){const k=i.parseCount_32();for(let O=0;O<k;++O){const B=i.parsePlane3_32();P.push(B)}}return{nodeId:o,name:l,camera:g,instanceMarkupKeysToShow:y,viewFrameInfo:m,nodesToShow:I,nodesToHide:b,filters:x,transformMap:C,cuttingPlanes:P,bits:h}}static reify(t,e,i,n){const r=Di(e),o=new as(t,e,i,0,n);return r.attachedInvisibly()&&o.setVisibility(!1),o}static createDynamic(t,e,i,n,r,o,l,h,u){const d=Gi(e),g=t.generateDynamicNodeId(),y=[];let m=Ci.IsCameraSet;if(r!=null){m=na(m,Ci.IsPmiFilteringSet,!0);for(const x of r)for(const C of x.getPmiBodies()){const P=Gi(C);console.assert(d===P);const O=C.getInstanceInc()[1];y.push(O)}}const I={nodeId:g,name:i,camera:n,instanceMarkupKeysToShow:y,viewFrameInfo:null,nodesToShow:o,nodesToHide:l,filters:[],transformMap:h,cuttingPlanes:u!==null?[u]:[],bits:m};return new as(t,d,I,1,e)}static isAuthoredViewInfo(t,e){return e===0}constructor(t,e,i,n,r){const l=Di(e).getMasterModelKey(),h={nodeId:i.nodeId,bits:0,name:i.name,localTransform:null,attributes:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null};if(super(t,l,h),this._parent=r,this._bits|=i.bits,i.camera!==null&&(this._camera={initial:i.camera.copy(),derived:i.camera.copy()}),i.filters.length>0&&(this._filters=i.filters),this._instanceMarkupKeysToShow=ac(i.instanceMarkupKeysToShow),as.isAuthoredViewInfo(i,n)?(this._nodesToShow=as._toRuntimeIds(e,i.nodesToShow),this._nodesToHide=as._toRuntimeIds(e,i.nodesToHide),i.transformMap.size>0&&(this._transformMap=new Map,i.transformMap.forEach((u,d)=>{const g=e.toRuntimeId(d);this._transformMap.set(g,Vn.copy(u))}))):(this._nodesToShow=ac(i.nodesToShow),this._nodesToHide=ac(i.nodesToHide),i.transformMap.size>0&&(this._transformMap=hu(i.transformMap))),i.viewFrameInfo!==null&&(this._viewFrame=this._loadViewFrame(t,l,i.viewFrameInfo)),i.cuttingPlanes.length>0){this._cuttingPlanes=ms(i.cuttingPlanes);let u=1;const d=Pm(this),g=Di(d),y=ur(g);if(y){const m=d.getMeasurementUnit(),I=y.getMeasurementUnit();m!==I&&(u=m/I)}u!==1&&ci(this._cuttingPlanes).forEach(m=>{m.d*=u})}t.registerCadView(this)}getFilters(){return this._filters!==void 0?this._filters:null}static _toRuntimeIds(t,e){const i=new Set;for(const n of e){const r=t.toRuntimeId(n);i.add(r)}return i}_loadViewFrame(t,e,i){return ro.reify(t,e,this,i)}getViewFrame(){return this._viewFrame??null}getParent(){return this._parent}getRuntimeId(){return Co(this._nodeId,this)}getBranchVisibility(){let t=this.isVisible()?he.Shown:he.Hidden;return this._viewFrame!==void 0&&!this._viewFrame.isOutOfHierarchy()&&(t|=this._viewFrame.isVisible()?he.Shown:he.Hidden),t}setVisibility(t){this._setVisibility(t)}isPmiFilteringSet(){return this._hasBits(Ci.IsPmiFilteringSet)}isDefaultView(){return this._hasBits(Ci.IsDefaultView)}IsCombineState(){return this._hasBits(Ci.IsCombineState)}deactivate(t){return t.clearAllCuttingSections()}async _replaceCuttingPlanes(t,e){await t.clearAllCuttingSections();const i=t.getCuttingSectionCount();if(e.length>i)throw new ae(`System does not support more than ${i} cutting planes in a CadView`);const n=e.reduce((r,o,l)=>{const h=t.getCuttingSection(l);return console.assert(h!==null),r.push(d0(h,[o])),r},[]);await Promise.all(n),await t.activateCuttingSections()}async activate(t,e,i,n,r,o,l,h){return await this._activateView(t,e,i,n,h),this._activateCamera(t,e,r,o,l)}async _activateView(t,e,i,n,r){const o=t.getRootNode();r!==null&&console.assert(r.isAConfigurationNode());const l=(r==null?void 0:r.getRuntimeId())??Ts;let h=Ts;const u=new Map,d=[],g=[];let y=g0;this._transformMap!==void 0&&(y=(C,P)=>{f0(this._transformMap,C,P)});const m={enterProductOccurrence:C=>{const P=C;P.isAConfigurationNode()&&(h=P.getRuntimeId());const k=h,O=P.forEachPmi(B=>{const j=B.getPmiBodies();if(j.length!==0&&this.isPmiFilteringSet()){let V=!1;for(const Y of j){const st=Y.getInstanceInc()[1];if(this._instanceMarkupKeysToShow.has(st)){V=!0;break}}r!==null&&(V=V&&(k===l||k===Ts)),u.set(B,V);for(const Y of j)u.set(Y,V)}}).then(()=>{const B=P.getRuntimeId();return this._nodesToHide.has(B)||P.isADrawingSheetNode()?u.set(P,!1):this._nodesToShow.has(B)&&(r!==null?u.set(P,k===l||k===Ts):u.set(P,!0)),y(d,P),P.forEachCadView(j=>{const V=j;if(V._viewFrame!==void 0){let Y=V===this;r!==null&&(Y=Y&&(k===l||k===Ts)),u.set(j,Y),u.set(V._viewFrame,Y)}})});g.push(O)},leaveProductOccurrence:C=>{C.isAConfigurationNode()&&(h=Ts)},enterAnyBody:C=>{if(C.isOutOfHierarchy())return;y(d,C);let P=C.getParent();for(;P!==null&&!(P instanceof Cn);){const O=P.getRuntimeId();if(this._nodesToHide.has(O)){u.set(P,!1);break}else if(this._nodesToShow.has(O)){u.set(P,!0);break}P=Sm(P.getParent())}const k=C.getRuntimeId();this._nodesToShow.has(k)?u.set(C,!0):this._nodesToHide.has(k)&&u.set(C,!1),r!==null&&h!==Ts&&h!==l&&u.set(C,!1)}};await Nn.walk(m,o,zt.None),await Promise.all(g);const I=[];let b=mf({assemblyTree:t,engine:e,startNode:o,visibilityFormatter:C=>u.get(C),resetNonAffectedToDefault:!0,resetNonAffectedPmiToDefault:this.isPmiFilteringSet(),configurationNode:r??void 0,callbackManager:i,initiallyHiddenStayHidden:!1});I.push(b),b=Oc(e,i,d,!1),I.push(b),await Ue(I);const x=ci(this._cuttingPlanes);await this._replaceCuttingPlanes(n,x)}async _activateCamera(t,e,i,n,r){const o=this._camera;if(o===void 0){t.disableAutomaticFitWorld()||await i.fitWorld(n);return}if(!r)return i._setCameraPromise(o.initial,n);const l=Pm(this),h=Di(l),u=ur(h);let d=_t.createFromArray(zc(h));if(u!==null){const g=l.getMeasurementUnit(),y=u.getMeasurementUnit();if(g!==y){const m=g/y,I=new _t;I.setScaleComponent(m,m,m),d=_t.multiply(I,d)}}if(o.derived=o.initial.transform(d),this._hasBits(Ci.HasDynamicFrame)){const y=this._viewFrame!==void 0?await ym(t,e,[this._viewFrame.getRuntimeId()],jt.All,!1,!1):await e.getModelBounding(!0,!1,!1),m=_.subtract(o.derived.getTarget(),o.derived.getPosition()),I=y.extents().length(),b=m.copy().normalize().scale(I),x=y.center(),C=_.subtract(x,b);return o.derived.setPosition(C),o.derived.setTarget(x),o.derived.setWidth(I),o.derived.setHeight(I),i._setCameraPromise(o.derived,n)}else if(o.derived.getProjection()===ti.Orthographic){const g=_.subtract(o.derived.getTarget(),o.derived.getPosition()),y=await e.getModelBounding(!0,!1,!1),m=_.subtract(y.center(),o.derived.getPosition()),I=1/g.length(),b=I*_.dot(g,m);if(b>0){g.scale(I);const x=Math.max(o.derived.getWidth(),o.derived.getHeight()),C=_.add(o.derived.getPosition(),_.scale(g,b)),P=_.subtract(C,_.scale(g,2.5*x));o.derived.setPosition(P),o.derived.setTarget(C)}return i._setCameraPromise(o.derived,n)}else if(o.derived.getProjection()===ti.Perspective){const y=await e.getModelBounding(!0,!1,!1),m=_.subtract(y.max,y.min).length(),I=_.subtract(o.derived.getTarget(),o.derived.getPosition()),b=I.length(),x=b/m;if(m===0||x>.01)return i._setCameraPromise(o.derived,n);const C=m*.01*1.001,P=o.derived.getWidth()/b,k=o.derived.getHeight()/b,O=P*C,B=k*C,j=I.copy().normalize().scale(C),V=_.add(o.derived.getPosition(),j);return o.derived.setTarget(V),o.derived.setWidth(O),o.derived.setHeight(B),i._setCameraPromise(o.derived,n)}else return i._setCameraPromise(o.derived,n)}hasPmi(t){const e=Gi(this).getInclusionKey(),i=Gi(t).getInclusionKey();if(e!==i)return!1;for(const n of t.getPmiBodies()){const r=n.getInstanceInc()[1];if(this._instanceMarkupKeysToShow.has(r))return!0}return!1}isAnnotationView(){return this._hasBits(Ci.IsAnnotationView)}isCombineStateView(){return this._hasBits(Ci.IsCombineState)}setViewFrame(t){console.assert(this._viewFrame===void 0),this._viewFrame=t}}class Nn{static walk(t,e,i){if(i===zt.LoadedNodesOnly&&!e.isLoaded())return Promise.resolve();const n=new Nn(t,i);if(e instanceof Jn)return n._walkAnyTreeNode(e);{const r=new uc(1,!1),o=e.getChildren();for(const l of o)r.push(()=>n._walkAnyTreeNode(l));return r.waitForIdle()}}static forceLazyPromises(t){return this.walk({},t,zt.None)}constructor(t,e){this._visitor=new gm(t,e)}_walkAnyTreeNode(t){let e;return t instanceof me?e=this._walkProductOccurrence(t):t instanceof Cn?e=this._walkPmi(t):t instanceof as?e=this._walkCadView(t):e=this._walkAnyBody(t),e===void 0?Promise.resolve():e}_walkRepresentationItem(t){this._visitor.followRepresentationItem(t)&&(this._visitor.enterRepresentationItem(t),this._visitor.leaveRepresentationItem(t))}_walkPartDefinition(t){if(this._visitor.followPartDefinition(t)){this._visitor.enterPartDefinition(t);const e=t.getRepresentationItems();for(const i of e)this._walkRepresentationItem(i);this._visitor.leavePartDefinition(t)}}_walkAnyBody(t){this._visitor.followAnyBody(t)&&(this._visitor.enterAnyBody(t),this._visitor.leaveAnyBody(t))}_walkPmi(t){if(this._visitor.followPmi(t)){this._visitor.enterPmi(t);for(const e of t.getPmiBodies())this._walkAnyBody(e);this._visitor.leavePmi(t)}}_walkCadView(t){if(this._visitor.followCadView(t)){this._visitor.enterCadView(t);const e=t.getViewFrame();e!==null&&this._walkAnyBody(e),this._visitor.leaveCadView(t)}}_walkProductOccurrence(t){const e=new uc(1,!1);if(this._visitor.followProductOccurrence(t)){this._visitor.enterProductOccurrence(t);const i=t.getRawPartDefinition();i!==null&&(i instanceof zn?e.push(()=>{if(i.isResolved())return this._walkPartDefinition(i.getResolved())}):e.push(()=>i.then(h=>{if(h!==null){const u=h.value;if(u.isResolved())return this._walkPartDefinition(u.getResolved())}return Promise.resolve()})));const n=t.tryGetChildrenSync();if(n!==null)for(const h of n)e.push(()=>this._walkProductOccurrence(h));else e.push(()=>t.getChildren().then(h=>{if(h.length===0)return;const u=new uc(1,!1);for(const d of h)u.push(()=>this._walkProductOccurrence(d));if(!u.isIdle())return u.waitForIdle()}));const r=t.getBodyInstances();for(const h of r)e.push(()=>this._walkAnyBody(h));const o=t.getPmis();for(const h of o)e.push(()=>this._walkPmi(h));const l=t.getCadViews();for(const h of l)e.push(()=>this._walkCadView(h));e.push(()=>this._visitor.leaveProductOccurrence(t))}if(!e.isIdle())return e.waitForIdle()}}function wm(s){const t=s.getPrototype();if(t===null)return;let e;const i=t.getProductOccurrence();return i.isResolved()?e=wf(i.getResolved()):e=i.then(wf),e.then(()=>{console.assert(i.isResolved()),i.getResolved().markLoaded()})}async function wf(s){const t=[],e={enterProductOccurrence:i=>{const n=wm(i);n!==void 0&&t.push(n)}};return await Nn.walk(e,s,zt.None),Ue(t)}function vm(s){s.markLoaded();const t=s.getRepresentationItems();for(const e of t)e.markLoaded()}function bm(s){const t=s.getRawPartDefinition();if(t!==null)return t instanceof zn?t.isResolved()?void 0:t.then(vm):t.then(e=>{if(e===null)return;const i=e.value;if(!i.isResolved())return i.then(vm)})}function Fc(s){const t=wm(s);return t!==void 0?t.then(()=>bm(s)):bm(s)}async function p0(s){const t=[],e={enterProductOccurrence:i=>{const n=Fc(i);n!==void 0&&t.push(n)}};return await Nn.walk(e,s,zt.None),Ue(t)}class vf{constructor(t){this._referrers=null,this._prototype=t}_addReferrer(t){this._referrers=Xn(this._referrers,t)}_getReferrers(){return ci(this._referrers)}_getPrototype(){return this._prototype}_removeReferrer(t){let e=!1,i=ci(this._referrers);return i=i.filter(n=>n===t?(e=!0,!1):!0),e?(i.length===0?this._referrers=null:this._referrers=ms(i),!0):!1}async _purgeContents(){this._prototype.isUnforced()||await(await this._prototype).purgeContents()}_isLoaded(){return this._prototype.isResolved()&&this._prototype.getResolved().isLoaded()}}class sl{constructor(t,e){t instanceof vf&&(t=To.create(t)),this._shared=t,this._inclusionContext=e}getInclusionContext(){return this._inclusionContext}addReferrer(t){this._shared.get()._addReferrer(t)}getReferrers(){return this._shared.get()._getReferrers()}getProductOccurrence(){return this._shared.get()._getPrototype()}removeReferrer(t){if(this._shared.get()._removeReferrer(t)){const e=t.removePrototype();return console.assert(this===e),!0}return!1}removeAllReferrers(){const t=this.getReferrers();for(const e of t)this.removeReferrer(e)||console.assert(!1)}purgeContents(){return this._shared.get()._purgeContents()}isLoaded(){return this._shared.get()._isLoaded()}}function Bc(s){return"modelName"in s}function m0(s){return!Bc(s)}function Im(s){return s.config.implicitlyLoadXmlExternalModels||m0(s)}class bf{static create(t){return new bf(t)}constructor(t){this.value=t}}function If(s){if(s.length===0)return;const t=s[0].getBranchVisibility();for(let e=1,i=s.length;e<i;++e)if(t!==s[e].getBranchVisibility())return he.Mixed;return t}function _0(s){const t=s.getBodyInstances();if(t.length===0)return;const e=t[0].isVisible();for(let i=1,n=t.length;i<n;++i)if(e!==t[i].isVisible())return he.Mixed;return e?he.Shown:he.Hidden}function y0(s){return If(s.getChildrenSync())}function w0(s){return If(s.getPmis())}function v0(s){return If(s.getCadViews())}function b0(s){const t=s.isVisible()?he.Shown:he.Hidden,e=y0(s);if(e!==void 0&&e!==t)return he.Mixed;const i=_0(s);if(i!==void 0&&i!==t)return he.Mixed;const n=w0(s);if(n!==void 0&&n!==t)return he.Mixed;const r=v0(s);return r!==void 0&&r!==t?he.Mixed:e===void 0&&i===void 0&&n===void 0&&r===void 0?null:t}const I0=-2;function rl(s,t){const e=[];for(const i of s){const n=t(i);n&&e.push(n)}return Ue(e)}var xf=(s=>(s[s.NodeTypeDrawingSheet=6]="NodeTypeDrawingSheet",s))(xf||{}),hi=(s=>(s[s.IsAConfigurationNode=fi.IsAConfigurationNode]="IsAConfigurationNode",s[s.NodeTypeProduct=fi.NodeTypeProduct]="NodeTypeProduct",s[s.NodeTypeGroup=fi.NodeTypeGroup]="NodeTypeGroup",s[s.NodeTypeDrawingSheet=fi.NodeTypeDrawingSheet]="NodeTypeDrawingSheet",s[s.NodeTypeDrawingView=fi.NodeTypeDrawingView]="NodeTypeDrawingView",s[s.IsADefaultNodeType=fi.IsADefaultNodeType]="IsADefaultNodeType",s[s.BranchVisibilityHidden=fi.BranchVisibilityHidden]="BranchVisibilityHidden",s[s.BranchVisibilityShown=fi.BranchVisibilityShown]="BranchVisibilityShown",s[s.BranchVisibilityDirty=fi.BranchVisibilityDirty]="BranchVisibilityDirty",s[s.IsMissing=fi.IsMissing]="IsMissing",s[s.OutOfHierarchy=fi.OutOfHierarchy]="OutOfHierarchy",s[s.IsExternalModelRoot=fi.IsExternalModelRoot]="IsExternalModelRoot",s))(hi||{});class me extends Jn{static parseXml(t,e,i,n,r){const o=i.getInclusionKey(),l=Ao.parseXml(e,n,t),h=gi.parseFloat(n,"Unit"),u=[],d=[],g=[],y=[],m=[],I=[];let b=null,x=null,C=null,P=n.firstElementChild;for(;P!==null;){if(P.localName==="PartDefinition"){b=os.parseXml(e,P,t);break}else if(P.localName==="BodyInstance"){const k=zi.parseXml(e,P,o,t);u.push(k)}else if(P.localName==="Material")console.assert(x===null),x=uf.parseXml(P);else if(P.localName==="ExternalModel"){console.assert(C===null);const k=P.getAttribute("Name");if(k!==null){const O=gi.parseFloat(P,"Unit"),B=gi.parseBounding(P,"BoundingBox"),j=0,V=gi.parseUint(P,"CancelUnitScale")===1;C={config:t,modelName:k,bounding:B,measurementUnit:O,toAttachData:r,reservedNodeIdOffset:j,cancelUnitScale:V}}}else if(P.localName==="CADView"&&!t.ignoreCadViews){const k=as.parseXml(e,P,i,t);I.push(k)}else if(P.localName==="Filter"&&!t.ignoreFilters)d.push(Tc.parseXml(P));else if(P.localName==="Layer"&&!t.ignoreLayers){const k=so.parseXml(P);k!==null&&g.push(k)}else if(P.localName==="Relationships"&&!t.ignoreBimRelationships){const k=la.parseXml(P);if(k!==null&&y.push(k),k.related!==null)for(const O of k.related.relationships)ha.findBimObjectInArray(m,O)===!1&&m.push(O);k.relating!==null&&ha.findBimObjectInArray(m,k.relating.relationElt)===!1&&m.push(k.relating.relationElt)}P=P.nextElementSibling}return{nodeInfo:l,productBits:0,childDataKeys:[],prototypeDataKey:null,partDefinition:b,quickAccessPartDefinitionDataId:null,externalModelInfo:C,bodyInstanceInfos:u,cadViewInfos:I,pmiInfos:[],measurementUnit:h,simpleMaterial:x,layerInfos:g,filters:d,relationships:y,bimInfos:m}}static parseBinary(t,e,i,n){const r=Di(i),o=r.getRemapper(),l=n.parseNodeParseBits();if(l.hasBits1(Qe.VersionNumber)&&n.parseAssemblyDataVersion(2),l.hasBits2(cr.GenericTypes)){const V=n.parseGenericTypes();t.ignoreGenericTypes||r.setGenericTypeMaps(V)}const h=Ao.parseBinary(e,n,l,t);let u=0;l.hasBits1(Qe.ProductBits)&&(u=n.parseProductBits());const d=[];if(l.hasBits1(Qe.SubNodes)){const V=n.parseCount_32();for(let Y=0;Y<V;++Y){const q=n.parseDataKey();d.push(q)}}let g=null,y=null;if(l.hasBits1(Qe.Instance)&&(g=n.parseDataKey(),l.hasBits1(Qe.InstanceQuickAccess))){const V=n.parseModelKey(o);console.assert(V!==fs.Local);const Y=n.parseDataKey();y=[V,Y]}const m=[];if(l.hasBits1(Qe.BodyInstances)){const V=n.parseCount_32();for(let Y=0;Y<V;++Y){const q=zi.parseBinary(e,i,n,t);m.push(q)}}let I=null;if(l.hasBits1(Qe.ExternalModel)){const V=n.parseModelKey(o);console.assert(V!==fs.Local);const Y=n.parseInclusionKey(o,V);I={config:t,inclusionKey:Y,modelKey:V}}let b=null;if(l.hasBits1(Qe.PartDataLink)){let V=n.parseModelKey(o);V===fs.Local&&(V=r.getMasterModelKey());const Y=n.parseDataKey();b=[V,Y]}const x=[];if(l.hasBits1(Qe.Views)){const V=n.parseCount_32();for(let Y=0;Y<V;++Y){const q=as.parseBinary(e,i,n,t);t.ignoreCadViews||x.push(q)}}const C=[];if(l.hasBits1(Qe.Pmis)){const V=n.parseCount_32();for(let Y=0;Y<V;++Y){const q=Cn.parseBinary(e,i,n,t);C.push(q)}}let P=null;if(l.hasBits1(Qe.Unit)&&(P=n.parseFloat_64()),l.hasBits1(Qe.FrontUpVector)){const V=n.parsePoint3_64(),Y=n.parsePoint3_64();e.setViewAxes(V,Y)}const k=[];if(l.hasBits1(Qe.LayerList)){const V=n.parseCount_32();for(let Y=0;Y<V;++Y){const q=so.parseBinary(n);t.ignoreLayers||k.push(q)}}const O=[];if(l.hasBits1(Qe.Filters)){const V=n.parseCount_32();for(let Y=0;Y<V;++Y){const q=Tc.parseBinary(n);t.ignoreFilters||O.push(q)}}const B=[],j=[];if(l.hasBits2(cr.Relationships)){const V=n.parseCount_32();for(let Y=0;Y<V;++Y){const q=la.parseBinary(i,n);if(t.ignoreBimRelationships||B.push(q),q.relating!==null&&!t.ignoreBimRelationships&&(ha.findBimObjectInArray(j,q.relating.relationElt)===!1&&j.push(q.relating.relationElt),q.related!==null))for(const st of q.related.relationships)ha.findBimObjectInArray(j,st)===!1&&j.push(st)}}return{nodeInfo:h,productBits:u,childDataKeys:d,prototypeDataKey:g,partDefinition:b,quickAccessPartDefinitionDataId:y,externalModelInfo:I,bodyInstanceInfos:m,cadViewInfos:x,pmiInfos:C,measurementUnit:P,simpleMaterial:null,layerInfos:k,filters:O,relationships:B,bimInfos:j}}static reifySync(t,e,i,n,r,o){console.assert(r.childDataKeys.length===0),console.assert(r.externalModelInfo===null);const l=Di(n),h=new me(null,t,e,i,n,o,r);return l.attachedInvisibly()&&h.setVisibility(!1),h}static async reify(t,e,i,n,r,o){const l=mi(),h=new me(l,t,e,i,n,o,r);return await l,h}static createDynamic(t,e,i,n,r,o,l=!1,h=null){const u=Gi(e),d=t.massageAuthoredUserId(u,n),g=o?Vi.InitiallyShown:0,y={nodeId:d,bits:g,name:i,localTransform:r,attributes:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null},m=l?hi.OutOfHierarchy:0,I={nodeInfo:y,productBits:m,childDataKeys:[],prototypeDataKey:null,partDefinition:null,quickAccessPartDefinitionDataId:null,bodyInstanceInfos:[],externalModelInfo:null,cadViewInfos:[],pmiInfos:[],measurementUnit:h,simpleMaterial:null,layerInfos:[],filters:[],relationships:[],bimInfos:[]},b=new Ro;return b.attachInvisibly=!o,new me(null,b,null,t,u,e,I)}static createMissing(t,e){const i=this.createDynamic(t,e,"Missing",null,null,!1);return i._bits|=hi.IsMissing,i}isMissing(){return this._hasBits(hi.IsMissing)}static _amendInfo(t,e){if(e.nodeInfo.name!==null)return e;let i=null;if(ne(e.productBits,hi.NodeTypeProduct)?i=t.generateProductName():ne(e.productBits,hi.NodeTypeGroup)?i=t.generateGroupName():ne(e.productBits,hi.NodeTypeDrawingSheet)?i=t.generateDrawingSheetName():ne(e.productBits,hi.NodeTypeDrawingView)&&(i=t.generateDrawingViewName()),i===null)return e;const n={...e.nodeInfo,name:i};return{...e,nodeInfo:n}}constructor(t,e,i,n,r,o,l){l=me._amendInfo(n,l);const h=Di(r),u=h.getMasterModelKey(),d=Ks(h);super(n,u,l.nodeInfo),this._parent=o,this._bits|=l.productBits|hi.BranchVisibilityDirty;const g=l.nodeInfo.header,y=[];if(l.prototypeDataKey!==null&&(console.assert(i!==null),this._prototypeContext=this._loadPrototypeContext(e,i,n,r,l.prototypeDataKey,g)),console.assert(l.quickAccessPartDefinitionDataId===null||l.partDefinition===null),l.partDefinition!==null?Array.isArray(l.partDefinition)?this._partDefinition=this._lazyLoadPartDefinitionById(n,r,l.partDefinition,g,e):this._partDefinition=this._lazyLoadPartDefinitionByInfo(n,r,l.partDefinition,u):l.quickAccessPartDefinitionDataId!==null&&(this._partDefinition=this._lazyLoadPartDefinitionById(n,r,l.quickAccessPartDefinitionDataId,g,e)),l.childDataKeys.length>0){console.assert(i!==null);const I=(async()=>{const b=await this._loadProductOccurrences(e,i,n,r,l.childDataKeys,g);this._children=ms(b)})();y.push(I)}if(l.bodyInstanceInfos.length>0){const I=this._loadBodyInstances(n,u,l.bodyInstanceInfos);this._bodyInstances=ms(I)}if(l.cadViewInfos.length>0){const I=this._loadCadViews(n,r,l.cadViewInfos);this._cadViews=ms(I)}if(l.pmiInfos.length>0){const I=this._loadPmis(n,r,l.pmiInfos);this._pmis=ms(I)}if(l.measurementUnit!==null&&(this._measurementUnit=l.measurementUnit),l.externalModelInfo!==null)if(console.assert(t!==null),console.assert(i!==null),Im(l.externalModelInfo)){const I=this._loadAndAttachExternalModel(i,r,l.externalModelInfo);y.push(I)}else this._pendingExternalModels=Xn(this._pendingExternalModels,l.externalModelInfo);for(const I of l.layerInfos){const b=d.getRuntimeLayerId(I.id);b===null?n.createLayer(I.id,I.name,d):I.name!==null&&n.updateLayerName(b,I.name)}for(const I of l.filters)n.addFilter(I,d);for(const I of l.relationships)r.addRelationship(I);for(const I of l.bimInfos)r.addBimInfos(I);const m=this.getAuthoredLayerId();if(m!==null&&(n.registerNodeInLayer(this,m),this.isOutOfHierarchy()||n.registerTreeNodeInLayer(this,m)),n.registerProductOccurrence(this),t===null){if(y.length>0)throw new ei}else t.resolve(Ue(y))}async _loadExternalModel(t,e,i){if(Bc(i))return t.attachByExternalModelInfo(i,this,e);const n=this.getAuthoredId();return Ks(e).handleExternalModel(n,e,i.inclusionKey)?t.attachByExternalModelInfo(i,this,e):null}async _loadAndAttachExternalModel(t,e,i){const n=await this._loadExternalModel(t,e,i);return n!==null&&this.addAttachContext(n),n}async loadPendingExternalModels(t){if(!this.hasPendingExternalModels())return[];const e=Gi(this),i=[];for(const r of ci(this._pendingExternalModels)){const o=this._loadAndAttachExternalModel(t,e,r);i.push(o)}delete this._pendingExternalModels;const n=[];for(const r of await Promise.all(i))r!==null&&n.push(r);return n}_lazyLoadPartDefinitionByInfo(t,e,i,n){const r=n,o=os.reify(t,e,r,i);return zn.create(o)}_lazyLoadPartDefinitionById(t,e,i,n,r){const o=t.getAbstractScEngine(),l=Ks(e);let h=t.lookupPartDefinitionByDataId(l,i[0],i[1]);return h!==null?zn.create(async()=>{const u=await h;return u.addReferrer(this),u}):(h=zn.create(async()=>{const u=i[0],d=i[1],g=await t.enqueue(()=>o.safeGetMetaData(u,d));if(g!==null){const y=new fa(n,g),m=new Vc(y),I=os.parseBinary(t,m,r),b=os.reify(t,e,u,I);return b.addReferrer(this),b}return os.createMissing(t)}),t.registerPartDefinitionByDataId(l,i[0],i[1],h),h)}static async _loadProductOccurrence(t,e,i,n,r,o){const l=new Vc(r),h=me.parseBinary(t,i,n,l);return me.reify(t,e,i,n,h,o)}_loadPrototypeContext(t,e,i,n,r,o){const l=Di(n),h=Ks(l),d=l.getMasterModelKey(),g={prototypeContext:null,sharedPrototypeContext:i.lookupPrototypeByDataId(h,d,r)};if(g.sharedPrototypeContext===null){const y=zn.create(async()=>{const m=i.getAbstractScEngine(),I=await i.enqueue(()=>m.safeGetMetaData(d,r));if(I!==null){const b=new fa(o,I);return me._loadProductOccurrence(t,e,i,n,b,g.prototypeContext)}return me.createMissing(i,g.prototypeContext)});g.sharedPrototypeContext=new vf(y),i.registerPrototypeByDataId(h,d,r,g.sharedPrototypeContext)}return g.prototypeContext=new sl(g.sharedPrototypeContext,n),g.prototypeContext.addReferrer(this),g.prototypeContext}async _loadProductOccurrences(t,e,i,n,r,o){const u=Di(n).getMasterModelKey(),d=i.getAbstractScEngine(),g=await i.enqueue(()=>d.safeGetMetaDatas(u,r)),y=[];for(let m=0;m<r.length;++m){let I;if(g!==null){const b=g[m];g[m]=new Uint8Array(0);const x=new fa(o,b);I=await me._loadProductOccurrence(t,e,i,n,x,this);const C=e.onLoadChildProductOccurrence();C&&await C}else I=me.createMissing(i,this);y.push(I)}return y}_loadBodyInstances(t,e,i){const n=[];for(const r of i){const o=zi.reify(t,e,this,r);n.push(o)}return n}_loadCadViews(t,e,i){const n=[];for(const r of i){const o=as.reify(t,e,r,this);n.push(o),o.markLoaded()}return n}_loadPmis(t,e,i){const n=[];for(const r of i){const o=Cn.reify(t,e,r,this);n.push(o)}return n}getParent(){return this._parent}getRuntimeId(){return Co(this._nodeId,this)}isAbsoluteRoot(){return this._nodeId===I0}getPrototype(){return this._prototypeContext!==void 0?this._prototypeContext:null}isAConfigurationNode(){return this._hasBits(hi.IsAConfigurationNode)}isADefaultNode(){return this._hasBits(hi.IsADefaultNodeType)}isAProductNode(){return ne(this._bits,hi.NodeTypeProduct)}isAGroupNode(){return ne(this._bits,hi.NodeTypeGroup)}isADrawingSheetNode(){return ne(this._bits,hi.NodeTypeDrawingSheet)}isADrawingViewNode(){return ne(this._bits,hi.NodeTypeDrawingView)}addProductOccurrence(t){console.assert(t.getParent()===this),this._children=Xn(this._children,t),this._itemWasAdded()}addBodyInstance(t){console.assert(t.getParent()===this),this._bodyInstances=Xn(this._bodyInstances,t),this._itemWasAdded()}addCadView(t){console.assert(t.getParent()===this),this._cadViews=Xn(this._cadViews,t),this._itemWasAdded()}addPmi(t){console.assert(t.getParent()===this),this._pmis=Xn(this._pmis,t),this._itemWasAdded()}addLoadContext(t){console.assert(t.getParent()===this),this._childContexts=Xn(this._childContexts,t),this._itemWasAdded()}addAttachContext(t){console.assert(t.getParent()===this),this._childContexts=Xn(this._childContexts,t),this._itemWasAdded()}_followPrototypesWhileEmpty(){if(this._prototypeContext===void 0||this._children!==void 0||this._childContexts!==void 0)return this;const t=this._prototypeContext.getProductOccurrence();return t.isResolved()?t.getResolved()._followPrototypesWhileEmpty():this}getRawPartDefinition(){if(this._partDefinition!==void 0)return this._partDefinition;if(this._prototypeContext!==void 0){const t=this._prototypeContext.getProductOccurrence();return t.isResolved()?t.getResolved().getRawPartDefinition():null}return null}async getPartDefinition(){const t=this.getRawPartDefinition();return t instanceof zn?bf.create(t):t instanceof Promise?t:null}getPartDefinitionSync(){if(console.assert(this.isLoaded()),this._partDefinition!==void 0&&this._partDefinition.isResolved())return this._partDefinition.getResolved();if(this._prototypeContext!==void 0){const t=this._prototypeContext.getProductOccurrence();if(t.isResolved())return t.getResolved().getPartDefinitionSync()}return null}getChildContexts(){return ci(this._childContexts)}_getChildren(){const t=ci(this._children),e=ci(this._childContexts);for(const i of e)t.push(...i.getChildren());return t}async getChildren(){return(await this._followPrototypesWhileEmpty())._getChildren()}getChildrenSync(){console.assert(this.isLoaded());const t=this.tryGetChildrenSync();if(t===null)throw new ei;return t}tryGetChildrenSync(){const t=this._followPrototypesWhileEmpty();return t instanceof Promise?null:t._getChildren()}async forEachChild(t){const e=await this.getChildren();return rl(e,t)}forEachBodyInstance(t){const e=this.getBodyInstances();return rl(e,t)}forEachPmi(t){const e=this.getPmis();return rl(e,t)}forEachCadView(t){const e=this.getCadViews();return rl(e,t)}hasBodyInstances(){return this._bodyInstances!==void 0}getBodyInstances(){return ci(this._bodyInstances)}getCadViews(){return ci(this._cadViews)}getPmis(){return ci(this._pmis)}setMeasurementUnit(t){this._measurementUnit=t}unsetMeasurementUnit(){this._measurementUnit=void 0}hasMeasurementUnit(){return this._measurementUnit!==void 0}getMeasurementUnit(){let t=this;do{if(t._measurementUnit!==void 0)return t._measurementUnit;t=ur(t._parent)}while(t!==null);return 1}async getPhysicalProperties(t){const e=async()=>{if(Array.isArray(this._children)){const y=[];for(const P of this._children)await Fc(P),y.push(await P.getPhysicalProperties(t));if(!y.some(P=>P!==null))return null;let m=0,I=0;const b=_.zero();let x=0;if(y.forEach(P=>{P!==null&&(x+=1,m+=P.volume,I+=P.surfaceArea,b.add(P.centerOfGravity))}),x===0)return null;const C=_.scale(b,1/x);return Promise.resolve(new ca(I,m,C))}return this._children instanceof me?(await Fc(this._children),this._children.getPhysicalProperties(t)):null},i=await this.getPartDefinition();if(i===null)return t?e():null;const r=(await i.value).getRepresentationItems();if(r.length===0)return t?e():null;let o=0,l=0;const h=_.zero();let u=0;for(const y of r){const m=y.getPhysicalProperties();m!==null&&(o+=m.volume,l+=m.surfaceArea,h.add(m.centerOfGravity),u++)}u!==0&&h.scale(1/u);const d=new ca(l,o,h),g=await e();return g!==null?new ca(d.surfaceArea+g.surfaceArea,d.volume+g.volume,_.add(d.centerOfGravity,g.centerOfGravity).scale(.5)):d}setPartDefinition(t){console.assert(this._partDefinition===void 0),this._partDefinition=zn.create(t)}setPrototype(t){console.assert(this._prototypeContext===void 0),this._prototypeContext=t,this._markBranchVisibilityDirty(!1)}removePrototype(){if(this._prototypeContext===void 0)throw new ei;const t=this._prototypeContext;return delete this._prototypeContext,this._markBranchVisibilityDirty(!1),t}getBranchVisibility(){return this._updateBranchVisibility(),this._getBranchVisibility()}_getBranchVisibility(){let t=this.isVisible()?he.Shown:he.Hidden;return this._hasBits(hi.BranchVisibilityShown)&&t!==he.Shown&&(t=he.Mixed),this._hasBits(hi.BranchVisibilityHidden)&&t!==he.Hidden&&(t=he.Mixed),t}_setBranchVisibility(t){const e=this.isVisible();console.assert(e?t!==he.Hidden:t===he.Hidden),this._bits&=~(hi.BranchVisibilityHidden|hi.BranchVisibilityShown),(t===he.Hidden||t===he.Mixed)&&(this._bits|=hi.BranchVisibilityHidden),(ne(t,he.Shown)||t===he.Mixed)&&(this._bits|=hi.BranchVisibilityShown)}_updateBranchVisibility(){if(!this._hasBits(hi.BranchVisibilityDirty))return;let t=this.isVisible()?he.Shown:he.Hidden;const e=this._getSubBranchVisibilities();e!==null&&e!==t&&(t=he.Mixed),this._setBranchVisibility(t),this._bits&=~hi.BranchVisibilityDirty}_getSubBranchVisibilities(){return b0(this)}_itemWasAdded(){this._getBranchVisibility()!==he.Mixed&&this._markBranchVisibilityDirty(!0)}_onItemRemoved(){this._getBranchVisibility()!==he.Hidden&&this._markBranchVisibilityDirty(!1)}markBranchVisibilityDirty(){this._markBranchVisibilityDirty(!1)}_markBranchVisibilityDirty(t){if(!this._hasBits(hi.BranchVisibilityDirty)&&!(t&&this._getBranchVisibility()===he.Mixed))if(this._bits|=hi.BranchVisibilityDirty,this._parent instanceof sl){const e=this._parent.getReferrers();for(const i of e)i._markBranchVisibilityDirty(t)}else{const e=ur(this._parent);if(e!==null)return e._markBranchVisibilityDirty(t)}}setVisibility(t){this.isVisible()!==t&&(this._setVisibility(t),this._markBranchVisibilityDirty(!1))}_removeDirectChild(t){let e=ci(this._children);const i=e.length;return e=e.filter(n=>n!==t),e.length===i?!1:(e.length===0?delete this._children:this._children=ms(e),this._onItemRemoved(),!0)}_removeIndirectChild(t){let e=!1,i=ci(this._childContexts);for(const n of i)if(n.removeProductOccurrence(t)){e=!0;break}return e?(i=i.filter(n=>n.hasChildren()),i.length===0?delete this._childContexts:this._childContexts=ms(i),this._onItemRemoved(),!0):!1}removeProductOccurrence(t){return this._removeDirectChild(t)?!0:this._removeIndirectChild(t)}removePmi(t){let e=ci(this._pmis);const i=e.length;return e=e.filter(n=>n!==t),e.length===i?!1:(e.length===0?delete this._pmis:this._pmis=ms(e),this._onItemRemoved(),!0)}removeBodyInstance(t){let e=ci(this._bodyInstances);const i=e.length;return e=e.filter(n=>n!==t),e.length===i?!1:(e.length===0?delete this._bodyInstances:this._bodyInstances=ms(e),this._onItemRemoved(),!0)}purgeContents(){this._markBranchVisibilityDirty(!1);const t=[];let e;this._partDefinition!==void 0&&(this._partDefinition.isUnforced()||(e=this._partDefinition.then(r=>{r.removeAllReferrers(),delete this._partDefinition}),t.push(e))),this._prototypeContext!==void 0&&(e=this._prototypeContext.purgeContents(),t.push(e),this._prototypeContext.removeReferrer(this),delete this._prototypeContext);const i=ci(this._children);e=rl(i,r=>r.purgeContents()),t.push(e),delete this._children;const n=ci(this._childContexts);return e=rl(n,r=>r.purgeContents()),t.push(e),delete this._childContexts,delete this._bodyInstances,delete this._cadViews,delete this._pmis,delete this._measurementUnit,Ue(t)}removePartDefinition(){if(this._partDefinition===void 0||!this._partDefinition.isResolved())throw new ei;const t=this._partDefinition;return delete this._partDefinition,t.getResolved()}isOutOfHierarchy(){return this._hasBits(hi.OutOfHierarchy)}markIsExternalModelRoot(t){console.assert(!this._hasBits(hi.IsExternalModelRoot)),this._bits|=hi.IsExternalModelRoot,t.markSeenExternalModel()}isExternalModelRoot(){return this._hasBits(hi.IsExternalModelRoot)}addPendingExternalModel(t){this._pendingExternalModels=Xn(this._pendingExternalModels,t)}hasPendingExternalModels(){return!Ov(this._pendingExternalModels)}}class xm{constructor(){this._leftToRight=new Map,this._rightToLeft=new Map}set(t,e){this._leftToRight.set(t,e),this._rightToLeft.set(e,t)}getLeft(t){return this._rightToLeft.get(t)}getRight(t){return this._leftToRight.get(t)}}class Cm{constructor(){this._bits1=0,this._bits2=0}hasBits1(t){return ne(this._bits1,t)}hasBits2(t){return ne(this._bits2,t)}parseBits1(t){this._bits1=t.parseIndex_32()}parseBits2(t){this.hasBits1(Qe.UseNodeParseBits2)&&(this._bits2=t.parseIndex_32())}}class x0{constructor(t,e){this.shown=t,this.removed=e}}class Vc{constructor(t){this._bytes=t.bytes,this._header=t.header,this._dataView=new DataView(this._bytes.buffer,this._bytes.byteOffset,this._bytes.byteLength),this._currentPos=0}hasNext(){return this._currentPos<this._bytes.length}parseCount_32(){return this._parseUint_32()}parseIndex_32(){return this._parseUint_32()}parseAssemblyDataVersion(t){const e=[];for(let i=0;i<t;++i)e.push(this._parseUint_32());return e}parseAssemblyDataHeaderVersion(){return this._parseUint_32()}parseVisibility(){let t;(r=>{r[r.Removed=1]="Removed",r[r.Shown=2]="Shown"})(t||(t={}));const e=this._parseInt_8(),i=ne(e,2),n=ne(e,1);return new x0(i,n)}parseProductBits(){let t=this._parseUint_8();return this._header!==null&&this._header.headerVersion>=2||!ne(t,xf.NodeTypeDrawingSheet)||(t&=~xf.NodeTypeDrawingSheet,t|=hi.NodeTypeDrawingSheet),t}parseUnits(){const t=this.parseInt32(),e=[];for(let i=0;i<t;i++){const n=this.parseUInt32(),r=this.parseInt32(),o=this.parseFloat_64();e.push({basicUnit:n,exponent:r,factor:o})}return e}parseCString(){const t=this._currentPos;let e=this._bytes[this._currentPos++];for(;e!==0;)e=this._bytes[this._currentPos++];return Ev(this._bytes.subarray(t,this._currentPos-1))}parseUInt32(){return this._parseUint_32()}parseInt32(){return this._parseInt_32()}parseBytes(t){const e=this._currentPos;this._currentPos+=t;const i=this._bytes.subarray(e,this._currentPos);return new Uint8Array(i)}parseNodeId(){const t=this._parseUint_32();return console.assert(t!==Ts),t}parseLayerId(){const t=this._parseUint_32();return console.assert(t!==Ts),t}parseGenericTypes(){const t=this._parseUint_32(),e=new xm;for(let i=0;i<t;i++){const n=this.parseCString(),r=this._parseUint_32();e.set(r,n)}return e}parseGenericTypeId(){return this._parseUint_32()}parseGenericId(){return this.parseCString()}parseModifiers(){return this._parseUint_32()}_parseScKey(){const t=this._parseUint_32();return console.assert(t!==rf.Invalid),t}parseDataKey(){return this._parseScKey()}parseInstanceKey(){return this._parseScKey()}parseMeshKey(){return this._parseScKey()}parseModelKey(t){const e=this._parseScKey();return t!==null?t.getEffectiveModelKey(e):e}parseInclusionKey(t,e){const i=this._parseScKey();return t!==null?t.getEffectiveInclusionKey(i,e):i}parseMatrix(){const t=this._header!==null&&this._header.doublePrecisionMatrices?()=>this.parseFloat_64():()=>this.parseFloat_32(),e=Vn.getIdentity();for(let i=0;i<4;++i)for(let n=0;n<3;++n)e[4*i+n]=t();return e}_parseInt_8(){return this._dataView.getInt8(this._currentPos++)}_parseUint_8(){return this._dataView.getUint8(this._currentPos++)}_parseUint_32(){const t=this._dataView.getUint32(this._currentPos,!0);return this._currentPos+=4,t}_parseInt_32(){const t=this._dataView.getInt32(this._currentPos,!0);return this._currentPos+=4,t}_parseFloat_32(){const t=this._dataView.getFloat32(this._currentPos,!0);return this._currentPos+=4,t}_parseFloat_64(){const t=this._dataView.getFloat64(this._currentPos,!0);return this._currentPos+=8,t}parseFloat_32(){return this._parseFloat_32()}parseFloat_64(){return this._parseFloat_64()}parseAttributeType(){return this._parseInt_8()}parseNodeParseBits(){const t=new Cm;return t.parseBits1(this),t.parseBits2(this),t}parseViewParseBits(){return this._parseUint_32()}parsePmiParseBits(){return this._parseUint_32()}parseLayerParseBits(){return this._parseUint_32()}parseAttributeParseBits(){return this._parseUint_32()}parseRelationshipParseBits(){return this._parseUint_32()}parseBoolean(){return this._parseUint_8()!==0}parsePoint3_32(){return new _(this._parseFloat_32(),this._parseFloat_32(),this._parseFloat_32())}parsePoint3_64(){return new _(this._parseFloat_64(),this._parseFloat_64(),this._parseFloat_64())}parsePlane3_32(){return Ki.createFromCoefficients(this._parseFloat_32(),this._parseFloat_32(),this._parseFloat_32(),this._parseFloat_32())}parsePmiType(){return this._parseUint_32()}parsePmiSubType(){return this._parseUint_32()}parsePmiTopoRef(){return this._parseInt_8()}parseBodyType(){return this._parseUint_8()}parseFaceType(){return this._parseInt_8()}parseEdgeType(){return this._parseInt_8()}parseUserDataIndex(){const t=this._parseUint_32(),e=this._parseUint_32();return e<=2097151?4294967296*e+t:`${e.toString(16)}${Nv(t)}`.toUpperCase()}getHeader(){return this._header}}function C0(s,t){const e=n=>{t.push(n)},i={enterProductOccurrence:e,enterAnyBody:e,enterCadView:e,enterPmi:e,enterPartDefinition:e,enterRepresentationItem:e};return Nn.walk(i,s,zt.None)}async function ua(s){const t=[],e=[];for(const i of s){const n=C0(i,e);t.push(n)}await Ue(t);for(const i of e)i.markLoaded()}class S0{constructor(t,e){this.value=t,this.kids=e.slice()}}const Cf=[25,1,0];class da{constructor(t){this.referencedInfo=t}}function Sf(s){return s instanceof da?s.referencedInfo:s}function P0(s,t){let e=s.nodeInfo.localTransform;return e===null?e=t:e=Vn.multiply(e,t),{...s,nodeInfo:{...s.nodeInfo,localTransform:e}}}class Pf{static parseXml(t,e,i,n,r){console.assert(n.localName==="ModelFile");const o=new Map,l=new Map,h=new Map,u=m=>{let I=me.parseXml(t,e,i,m,r);const b=I.nodeInfo.nodeId;if(h.has(I.nodeInfo.nodeId)){const k=new da(I);o.set(b,k)}else l.has(I.nodeInfo.nodeId)||(l.set(I.nodeInfo.nodeId,null),t.additionalMatrix!==null&&(I=P0(I,t.additionalMatrix.m))),o.set(b,I);const C=gi.parseNodeIds(m,"Children")??[];for(const k of C)l.set(k,I);const P=gi.parseNodeId(m,"InstanceRef");if(P!==null){const k=h.get(P);k===void 0?h.set(P,[I]):k.push(I)}};let d=n.firstElementChild;for(;d!==null;){if(d.localName!=="ProductOccurence")throw new ii(`Unexpected element "${d.localName}".`);if(gi.parseNodeId(d,"Id")===null)throw new ii('Expected "Id" attribute.');u(d),d=d.nextElementSibling}const g=this._parentMapToChildMap(o,l,h);return{treeInfos:this._childMapRoseTrees(g)}}static _parentMapToChildMap(t,e,i){const n=new Map,r=(o,l)=>{const h=n.get(o);h===void 0?n.set(o,[l]):h.push(l)};return e.forEach((o,l)=>{const h=t.get(l);if(h instanceof da)throw new ii('Expected a referenced node for "InstanceRef".');r(o,h)}),i.forEach((o,l)=>{console.assert(o.length>0);const h=t.get(l);if(!(h instanceof da))throw new ii(`Node is both an "InstanceRef" and contained in another node's "Children" list.`);for(const u of o)r(u,h)}),n}static _childMapRoseTrees(t){const e=r=>{const o=[],l=Sf(r),h=t.get(l);if(h!==void 0){console.assert(h.length>0);for(const u of h){const d=e(u);o.push(d)}}return new S0(r,o)},i=t.get(null);if(i===void 0)return console.assert(t.size===0),[];const n=[];for(const r of i){if(r instanceof da){console.assert(!1);continue}const o=e(r);n.push(o)}return n}static async reify(t,e,i,n,r,o){const l=[],h=[],u=[];for(const g of o.treeInfos){if(g.value instanceof da){console.assert(!1);continue}const y=this._reifyProductOccurrence(t,e,i,n,r,r,g,l);h.push(y),u.push(y.getRuntimeId())}const d=e.promiseTrigger("_subtreeLoaded","subtreeLoaded",u,Dr.LoadModel);return l.push(d),await Ue(l),h}static _rectifyExternalModelInfo(t,e){let i={...e.referencedInfo.externalModelInfo,reservedNodeIdOffset:0};if(i===null)throw new ii('"InstanceRef" node does not contain "ExternalModel".');if(!Bc(i))throw new ei;console.assert(i.reservedNodeIdOffset===0);const n=t.newNodeIdOffset();return i={...i,reservedNodeIdOffset:n},i}static _reifyProductOccurrence(t,e,i,n,r,o,l,h){const u=Sf(l.value);if(u.childDataKeys.length!==0)throw new ei;if(u.externalModelInfo!==null)throw new pr('Unexpected "ExternalModel". Should be a child of an "InstanceRef".');const d=me.reifySync(t,i,n,r,u,o);o.addProductOccurrence(d),d.markLoaded();for(const g of l.kids)if(g.value instanceof da){console.assert(g.kids.length===0);const y=this._rectifyExternalModelInfo(n,g.value);if(Im(y)){const m=i.attachByExternalModelInfo(y,d,r).then(async I=>{if(I===null)return;await ua([I]),d.addAttachContext(I);const b=I.getChildren().map(x=>x.getRuntimeId());await e.promiseTrigger("_subtreeLoaded","subtreeLoaded",b,Dr.LoadModel)});h.push(m)}else d.addPendingExternalModel(y)}else console.assert(g.value.externalModelInfo===null),this._reifyProductOccurrence(t,e,i,n,r,d,g,h);return d}static _parseBounding(t,e){const i=Sf(t.value);let n=As;i.measurementUnit!==null&&(n=i.measurementUnit);let r=1;n===As?n=e:e!==As&&(r=n/e);let o=new _t().setScaleComponent(r,r,r);const l=i.nodeInfo.localTransform;if(l!==null){const d=_t.createFromArray(l);o=_t.multiply(d,o)}const h=on.invalid();for(const d of t.kids){let g=this._parseBounding(d,n);g=o.transformBox(g),h.addBox(g)}const u=i.externalModelInfo;if(u!==null){if(!Bc(u))throw new ei;let d=u.bounding;if(d!==null&&!d.isDegenerate()){const g=u.measurementUnit||As;if(e!==As&&g!==As){const y=g/n,m=new _t().setScaleComponent(y,y,y);o=_t.multiply(m,o)}d=o.transformBox(d),h.addBox(d)}}return h}static parseBounding(t,e){const i=on.invalid();for(const n of t.treeInfos)for(const r of n.kids){const o=this._parseBounding(r,e);i.addBox(o)}return i}constructor(){}}const jo=class jo{constructor(t,e,i,n,r,o,l,h){this.headerVersion=t,this._rootAssemblyDataKey=e,this.isDrawing=i,this.isMeasurable=n,this.originalFileName=r,this.originalFileType=o,this.doublePrecisionMatrices=l,this.assemblyDataVersion=h}supportsAttributeBits(){return this.headerVersion>=5}rootAssemblyDataKey(){return console.assert(this._rootAssemblyDataKey!==eu.Invalid),this._rootAssemblyDataKey}static parseBinary(t){if(t.length===0)return null;const e=new Vc(new fa(null,t)),i=new Cm;if(i.parseBits1(e),!i.hasBits1(Qe.Header))return null;const n=e.parseAssemblyDataHeaderVersion();if(n>jo._maxHeaderVersion)throw new Lo(`Unknown header version: ${n}`);let r=[];if(n>=4&&(r=e.parseAssemblyDataVersion(3),!cc(Cf,r)))throw new Lo(`Invalid version: ${Hp(r)}`);i.parseBits2(e);const o=e.parseDataKey(),l=e.parseBoolean();let h,u="",d=Ga.Unknown,g=!1;return n>=1?h=e.parseBoolean():h=!0,n>=3&&(g=i.hasBits2(cr.DoublePrecisionMatrices),i.hasBits2(cr.OriginalName)&&(u=e.parseCString()),d=e.parseIndex_32()),new jo(n,o,l,h,u,d,g,r)}};jo._maxHeaderVersion=5,jo.dynamic=new jo(jo._maxHeaderVersion,eu.Invalid,!1,!1,"",Ga.Unknown,!0,[]);let qs=jo;class fa{constructor(t,e){this.header=t,this.bytes=e}}class Hn{constructor(t,e,i,n){this._productOccurrences=null,this._relationship=[],this._bimNodeIdMap=new Map,this._bimInfos=[],console.assert(i!==void 0),console.assert(i===ki.Local==(n===fs.Local)),this._attachContext=e,this._inclusionKey=i,this._modelKey=n;let r=e.getReservedNodeIdOffset();r!==null?e.forgetReservedNodeIdOffset():r=t.newNodeIdOffset(),this._nodeIdOffset=r,t.registerInclusionContext(this)}split(t,e){return new Hn(t,e,this._inclusionKey,this._modelKey)}getIdOffset(){return this._nodeIdOffset}toRuntimeId(t){return console.assert(Ja(t)),t+this._nodeIdOffset}getInclusionKey(){return this._inclusionKey}getModelKey(){return this._modelKey}getParent(){return this._attachContext}getAttachContext(){return this._attachContext}addProductOccurrence(t){console.assert(t.getParent()===this),this._productOccurrences=Xn(this._productOccurrences,t)}getChildren(){return ci(this._productOccurrences)}removeProductOccurrence(t){let e=ci(this._productOccurrences);const i=e.length;return e=e.filter(n=>n!==t),e.length===0?this._productOccurrences=null:this._productOccurrences=ms(e),e.length<i}purgeContents(){const t=[],e=ci(this._productOccurrences);for(const i of e){const n=i.purgeContents();t.push(n)}return this._productOccurrences=null,this._relationship.length=0,Ue(t)}hasChildren(){return this._productOccurrences!==null}isLoaded(){if(this._productOccurrences instanceof me)return this._productOccurrences.isLoaded();if(this._productOccurrences===null)return!0;for(const t of this._productOccurrences)if(!t.isLoaded())return!1;return!0}addRelationship(t){this._relationship.push(t)}getRelationships(){return this._relationship}addBimInfos(t){this._bimInfos.push(t)}getBimInfos(){return this._bimInfos}addBimIdToMap(t,e){this._bimNodeIdMap.set(t,e)}getRuntimeNodeFromBimId(t){const e=this._bimNodeIdMap.get(t);return e!==void 0?e:null}}class Sn{constructor(t,e,i,n,r){this._reservedNodeIdOffset=null,this._inclusionContexts=null,this._originalFileName="",this._originalFileType=fl.Unknown,this._assemblyDataVersion=[],this._genericTypeMaps=null,console.assert(n!==Er.Invalid),this._remapper=t,this._attachScope=e,this._attachedInvisibly=i,this._masterModelKey=n,this._parent=r}async getRootNodeMetaData(t){if(this._masterModelKey===Er.Invalid)return null;const e=t.getAbstractScEngine(),i=this._masterModelKey,r=await e.safeGetMetaData(i,1);if(r!==null){const o=t.tryParseHeader(r);if(o===null)return new fa(null,r);const l=await o;this._originalFileName=l.originalFileName,this._originalFileType=l.originalFileType,this._assemblyDataVersion=l.assemblyDataVersion;const h=await e.safeGetMetaData(i,l.rootAssemblyDataKey());return h!==null?new fa(l,h):null}return null}getAttachScope(){return this._attachScope}attachedInvisibly(){return this._attachedInvisibly}getMasterModelKey(){return this._masterModelKey}addInclusionContext(t){console.assert(t.getParent()===this),this._inclusionContexts=Xn(this._inclusionContexts,t)}getRemapper(){return this._remapper}getParent(){return this._parent}getChildren(){const t=this._inclusionContexts;if(t===null)return[];if(Array.isArray(t)){console.assert(t.length>0);const e=t[0].getChildren();for(let i=1;i<t.length;++i){const n=t[i];e.push(...n.getChildren())}return e}else return t.getChildren()}getInclusionContexts(){return ci(this._inclusionContexts)}split(t,e,i){return new Sn(this._remapper,t,e,this._masterModelKey,i)}hasChildren(){return this._inclusionContexts!==null}removeProductOccurrence(t){let e=null,i=ci(this._inclusionContexts);for(const n of i)if(n.removeProductOccurrence(t)){e=n;break}return e===null?!1:(i=i.filter(n=>n.hasChildren()),i.length===0?this._inclusionContexts=null:this._inclusionContexts=ms(i),!0)}purgeContents(){const t=[],e=ci(this._inclusionContexts);for(const i of e){const n=i.purgeContents();t.push(n)}return this._inclusionContexts=null,Ue(t)}isLoaded(){if(this._inclusionContexts instanceof Hn)return this._inclusionContexts.isLoaded();if(this._inclusionContexts===null)return!0;for(const t of this._inclusionContexts)if(!t.isLoaded())return!1;return!0}setReservedNodeIdOffset(t){console.assert(this._reservedNodeIdOffset===null),this._reservedNodeIdOffset=t}getReservedNodeIdOffset(){return this._reservedNodeIdOffset}forgetReservedNodeIdOffset(){console.assert(this._reservedNodeIdOffset!==null),this._reservedNodeIdOffset=null}getOriginalFileName(){return this._originalFileName}getOriginalFileType(){return this._originalFileType}setGenericTypeMaps(t){this._genericTypeMaps=t}getGenericTypeMaps(){return this._genericTypeMaps}getAssemblyDataVersion(){return this._assemblyDataVersion}}function k0(s){if(typeof s=="string")throw new ei;return s}class Os{constructor(t,e,i){this._handledExternalModels=null,this._attachContexts=null,this._registeredScsModelKeys=new Map,this._layerIdMap=new xm,this._parent=t,this._scsBufferCache=i}handleExternalModel(t,e,i){const n=e.getInclusionKey(),r=`${gf(i)} ${gf(n)} ${gf(t)}`;return this._handledExternalModels===null&&(this._handledExternalModels=new Set),this._handledExternalModels.has(r)?!1:(this._handledExternalModels.add(r),!0)}getParent(){return this._parent}addAttachContext(t){this._attachContexts=Xn(this._attachContexts,t)}getChildren(){const t=this._attachContexts;if(t===null)return[];if(Array.isArray(t)){console.assert(t.length>0);const e=t[0].getChildren();for(let i=1;i<t.length;++i){const n=t[i];e.push(...n.getChildren())}return e}else return t.getChildren()}getAttachContexts(){return this._attachContexts===null?[]:Array.isArray(this._attachContexts)?this._attachContexts:[this._attachContexts]}hasChildren(){return this._attachContexts!==null}removeProductOccurrence(t){let e=null,i=ci(this._attachContexts);for(const n of i)if(n.removeProductOccurrence(t)){e=n;break}return e===null?!1:(i=i.filter(n=>n.hasChildren()),i.length===0?this._attachContexts=null:this._attachContexts=ms(i),!0)}purgeContents(){const t=[],e=ci(this._attachContexts);for(const i of e){const n=i.purgeContents();t.push(n)}return this._attachContexts=null,Ue(t)}isLoaded(){if(this._attachContexts instanceof Sn)return this._attachContexts.isLoaded();if(this._attachContexts===null)return!0;for(const t of this._attachContexts)if(!t.isLoaded())return!1;return!0}initializeScsModelKeysOf(t){console.assert(this._registeredScsModelKeys.get(t)===void 0),this._registeredScsModelKeys.set(t,gu())}getScsModelKeysOf(t){const e=this._registeredScsModelKeys.get(t);return e===void 0?null:e}markAsFirstLoad(){console.assert(this._isFirstLoad===void 0),this._isFirstLoad=!0}isFirstLoad(){return this._isFirstLoad===!0}async toScsBuffer(t,e){const i=zn.create(async()=>{const n=await e(t);return k0(n)});return this._scsBufferCache===null?i:this._scsBufferCache.load(t,i)}onLoadComplete(){this._scsBufferCache=null}addLayerIdToMap(t,e){this._layerIdMap.set(t,e)}getAuthoredLayerId(t){const e=this._layerIdMap.getRight(t);return e!==void 0?e:null}getRuntimeLayerId(t){const e=this._layerIdMap.getLeft(t);return e!==void 0?e:null}}function zc(s){let t=Vn.getIdentity(),e=s;for(;e!==null;)if(e instanceof Jn){const i=e.getLocalTransform();i&&(t=Vn.multiply(t,i)),e instanceof os?e=null:e=e.getParent()}else if(e instanceof Hn)e=e.getParent();else if(e instanceof Sn)e=e.getParent();else if(e instanceof Os)e=e.getParent();else return t;return t}function Sm(s){let t=s;for(;;)if(t instanceof Jn)if(t instanceof Qa)t=t.getParent();else return t;else if(t instanceof Os)t=t.getParent();else if(t instanceof Hn)t=t.getParent();else if(t instanceof Sn)t=t.getParent();else{if(t===null)return null;console.assert(!1),t=t.getInclusionContext()}}function Do(s){return s instanceof Qa||s instanceof me?s.isOutOfHierarchy():!1}function M0(s){return s instanceof me||s instanceof Cn||s instanceof as?s.getBranchVisibility():s.isVisible()?he.Shown:he.Hidden}function E0(s){if(s instanceof me)return s.isADrawingSheetNode()?Ne.DrawingSheet:s.hasBodyInstances()?Ne.PartInstance:Ne.AssemblyNode;if(s instanceof os)return Ne.Part;if(s instanceof Ds)return Ne.PmiBody;if(s instanceof ro)return Ne.ViewFrame;if(s instanceof zi)return Ne.BodyInstance;if(s instanceof Ji)switch(s.getBodyType()){case el.BRep:return Ne.BrepBody;case el.Tessellation:return Ne.TessBody;case el.Wireframe:return Ne.WireBody;case el.PointCloud:return Ne.PointsBody;case el.Unknown:default:return Ne.Body}else return s instanceof Cn?Ne.Pmi:Ne.CadView}function Hc(s){const t=s.getGenericTypeId();if(t!==null){const i=Di(s).getGenericTypeMaps();if(i!==null)return i.getRight(t)||null}return null}function Gi(s){let t=s;for(;;)if(t instanceof Jn)t=t.getParent();else{if(t instanceof Hn)return t;if(t instanceof Ds)t=t.getParent();else if(t instanceof ro)t=t.getParent();else return t.getInclusionContext()}}function Ks(s){let t=s;for(;;)if(t instanceof Sn)t=t.getParent();else{if(t instanceof Os)return t;t instanceof Jn||t instanceof Hn?t=t.getParent():t=t.getInclusionContext()}}function Di(s){let t=s;for(;;)if(t instanceof Hn)t=t.getParent();else{if(t instanceof Sn)return t;if(t instanceof Jn)t=t.getParent();else if(t instanceof Os){const e=t.getParent();if(e===null)throw new ei;t=e}else t=t.getInclusionContext()}}function Pm(s){let t=null,e=s;for(;;)if(e instanceof me)t=e,e=e.getParent();else if(e instanceof Jn)e=e.getParent();else if(e instanceof Hn){if(t===null)throw new ei;return t}else e=e.getInclusionContext()}function ur(s){let t=s;for(;;){if(t instanceof me)return t;if(t instanceof Sn)t=t.getParent();else if(t instanceof Hn)t=t.getParent();else if(t instanceof Os){const e=t.getParent();if(e===null)return null;t=e}else if(t instanceof Qa)t=t.getParent();else if(t instanceof Cn)t=t.getParent();else if(t instanceof as)t=t.getParent();else return console.assert(!1),null}}const A0="IFCCOLUMN",T0="IFCCOVERING",N0="IFCCURTAINWALL",D0="IFCDOOR",O0="IFCRAMP",R0="IFCROOF",L0="IFCSLAB",F0="IFCSTAIR",B0="IFCSTAIRFLIGHT",V0="IFCTRANSPORTELEMENT",z0="IFCWALL",H0="IFCWALLSTANDARDCASE",U0="IFCWINDOW";function j0(s,t){let e=s;for(;e!==null;){if(e.getName()===t||Hc(e)===t)return!0;e=ur(e.getParent())}return!1}function W0(s){switch(s){case A0:case N0:case F0:case B0:case z0:case H0:case U0:return ln.Wall|ln.Floor;case T0:case O0:case R0:case L0:return ln.Floor;case D0:case V0:return ln.Door|ln.Floor}return ln.None}async function G0(s,t,e,i){const n=await t.getNodeOrRepItem(e);if(n===null||n instanceof Ji||n instanceof os)return ln.None;let r=Hc(n);if(r===null){if(i===null)return ln.None;const l=await n.getAttributes();for(const h of l)if(h.getTitle()===i){r=h.getValue();break}if(r===null)return ln.None}const o=s(r);return o!==ln.None?o:ln.None}async function $0(s){const t=[],e={enterAnyBody:i=>{i instanceof zi&&t.push(i)}};return await Nn.walk(e,s,zt.None),t}async function q0(s){const t=await $0(s),e=new Set;for(const i of t){const n=i.getParent();e.add(n)}return io(e)}async function K0(s,t,e,i){const n=[];for(const u of e){const d=G0(s,t,u,i);n.push(d)}const r=await Promise.all(n),o=[],l=[],h=[];for(let u=0;u<e.length;++u){const d=e[u],g=r[u];g!==ln.None&&(g&ln.Floor&&o.push(d),g&ln.Wall&&l.push(d),g&ln.Door&&h.push(d))}return{floors:o,walls:l,doors:h}}function kf(s){const t=[];for(const e of s){const i=e.getBodyInstances();for(const n of i){const r=n.getInstanceInc();t.push(r[0],r[1])}}return t}async function X0(s,t,e,i,n){const r=await q0(i),o=await K0(s,e,r,n),l=kf(o.floors);t.registerBimInstances(l,nc.Floor);const h=kf(o.walls);t.registerBimInstances(h,nc.Wall);const u=kf(o.doors);t.registerBimInstances(u,nc.Door)}async function J0(s,t,e){const i=[],n=[],r={enterAnyBody:u=>{if(u instanceof zi&&!u.isOutOfHierarchy()){i.push(u);const d=u.getInstanceInc();n.push(d[0],d[1])}}};await Nn.walk(r,s,zt.None);const o=new Map,l=await t.getPartColor(n,e),h=l.length;console.assert(h===i.length);for(let u=0;u<h;++u){const d=l[u];d!==null&&o.set(i[u].getRuntimeId(),d)}return o}function ol(s){return[s.x,s.y,s.z]}function Y0(s){return[Math.abs(s[0]),Math.abs(s[1]),Math.abs(s[2])]}function Z0(s,t){return[s[0]*t[0],s[1]*t[1],s[2]*t[2]]}function Q0(s,t){return[s[0]+t[0],s[1]+t[1],s[2]+t[2]]}function tb(s,t){return[s[0]-t[0],s[1]-t[1],s[2]-t[2]]}function eb(s,t){return[s[0]+t[0],s[1]+t[1],s[2]+t[2],s[3]+t[3]]}function Mf(s,t){return[s[0]-t[0],s[1]-t[1],s[2]-t[2],s[3]-t[3]]}function oo(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]}function Ef(s){const t=s[0],e=s[1],i=s[2];return t*t+e*e+i*i}function km(s){return Math.sqrt(Ef(s))}function ib(s,t){return[s*t[0],s*t[1],s*t[2]]}function Af(s){return[s.x,s.y,s.z,s.w]}function Uc(s,t){const e=s.m,i=t;return[e[i],e[i+4],e[i+8],e[i+12]]}function Mm(s){const t=s[0],e=s[1],i=s[2],n=s[3];return t*t+e*e+i*i+n*n}function Tf(s,t){return[s*t[0],s*t[1],s*t[2],s*t[3]]}function nb(s,t,e){let i=oo(s,e)+e[3];return i*=i,i<1e-5&&(i=1e-5),t/i}const Yn=400,Oo="_empty",ku=Ts;function Mu(s){return s}class al{constructor(t,e){this._pmiColor=vt.black(),this._pmiColorOverride=!1,this._viewAxes=new Of,this._viewAxesSet=!1,this._engine=t,this._callbackManager=e,this._callbackManager.bind({_firstModelLoaded:async i=>{},_resetAssemblyTreeBegin:async()=>{this._viewAxes=new Of,this._viewAxesSet=!1}})}_setModelStructure(t){console.assert(this._modelStructure===void 0),this._modelStructure=t}_setDefaultView(t){this._defaultView=t}setViewAxes(t,e){if(t.isAxis()&&e.isAxis()&&!t.equals(e))this._viewAxes.frontVector=t,this._viewAxes.upVector=e,this._callbackManager.trigger("viewAxes",t,e),this._viewAxesSet=!0;else throw new ae("The upVector and frontVector must be unique, cardinal axes.")}viewAxesHaveBeenSet(){return this._viewAxesSet}getViewAxes(){return this._viewAxes}async getModelBounding(t,e,i=!1){let n=new on;try{n=await this._engine.getModelBounding(t,e,i)}catch(r){console.assert(ea(r)&&Fp(r)===lf.Cancelled)}return n}async getLooseBounding(){return this._engine.getLooseBounding()}_allowNodeDeletion(t){return this._modelStructure.allowNodeDeletion(t)}_preventNodeDeletion(t){return this._modelStructure.preventNodeDeletion(t)}_preventMeshDeletion(t){return console.assert(t[0]===fs.Local),this._modelStructure.preventMeshDeletion(t[1])}_getNodeFromInstanceInc(t,e,i,n){return this._modelStructure.getNodeFromInstanceInc(t,e,i,n)}getNodesBounding(t,e){let i=jt.All;return(e==null?void 0:e.bodyInstance)===!1&&(i&=~jt.BodyInstance),(e==null?void 0:e.pmiBody)===!1&&(i&=~jt.PmiBody),(e==null?void 0:e.viewFrame)===!1&&(i&=~jt.ViewFrame),this._modelStructure.getBounding(t,i,(e==null?void 0:e.ignoreInvisible)??!1,(e==null?void 0:e.tightBounding)??!1)}async getNodeRealBounding(t,e){const i=e!==void 0?e.id:ke.Default,n=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.None);if(n.length===0)throw new ae("Cannot get bounding of node without geometry.");return this._engine.getDrawnPartsBounding(n,i)}setNodesVisibilities(t,e=null){return t=Up(t),this._modelStructure.setVisibilitiesByMap(t,e!==null?e:void 0)}setNodesVisibility(t,e,i=null){return this._modelStructure.setVisibilitiesByValue(t,e,i)}setBodyNodesVisibility(t,e){const i=this._modelStructure.lookupAnyTreeNode(t);if(i===null)throw new _s(t);const n=typeof e=="boolean"?r=>e:e;return this._modelStructure.setBodyNodesVisibility(i,r=>n(r.getRuntimeId()))}resetNodesVisibility(){return this.isDrawing()?this._callbackManager.promiseTrigger("_resetDrawing",null):this._modelStructure.resetAllVisibilities()}async getVisibilityState(t){const e=this._modelStructure.lookupAnyTreeNode(t);if(e===null)throw new _s(t);return lm(e)}resetNodesTransform(){return this._modelStructure.resetAllTransforms()}reset(){return this.resetModelOpacity(),this._modelStructure.reset()}clear(){return this._modelStructure.clear()}setNodesFaceColor(t,e){return this._setNodesFaceColor(t,e),Promise.resolve()}setNodesAmbientColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartAmbientColor(i,Yt.Faces,e)}setNodesAmbientMix(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartAmbientMix(i,Yt.Faces,e)}getNodesAmbientColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return e.length>0?this._engine.getPartAmbientColor(e,Yt.Faces):Promise.resolve([])}getNodesEffectiveAmbientColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return e.length>0?this._engine.getPartEffectiveAmbientColor(e,Yt.Faces):Promise.resolve([])}unsetNodesAmbientColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);e.length>0&&this._engine.unsetPartAmbientColor(e,Yt.Faces)}setNodesFaceEmissiveColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartEmissiveColor(i,Yt.Faces,e)}getNodesFaceEmissiveColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return e.length>0?this._engine.getPartEmissiveColor(e,Yt.Faces):Promise.resolve([])}getNodesEffectiveEmissiveColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return e.length>0?this._engine.getPartEffectiveEmissiveColor(e,Yt.Faces):Promise.resolve([])}unsetNodesFaceEmissiveColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);e.length>0&&this._engine.unsetPartEmissiveColor(e,Yt.Faces)}setNodesFaceSpecularColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartSpecularColor(i,Yt.Faces,e)}getNodesFaceSpecularColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return e.length>0?this._engine.getPartSpecularColor(e,Yt.Faces):Promise.resolve([])}getNodesEffectiveSpecularColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return e.length>0?this._engine.getPartEffectiveSpecularColor(e,Yt.Faces):Promise.resolve([])}unsetNodesFaceSpecularColor(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);e.length>0&&this._engine.unsetPartSpecularColor(e,Yt.Faces)}setNodesFaceSpecularIntensity(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartSpecularIntensity(i,Yt.Faces,e)}unsetNodesFaceSpecularIntensity(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);e.length>0&&this._engine.unsetPartSpecularIntensity(e,Yt.Faces)}_setNodesFaceColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartColor(i,Yt.Faces,e)}_unsetNodesColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.unsetPartColor(i,e)}unsetNodesFaceColor(t){return this._unsetNodesColor(t,Yt.Faces),Promise.resolve()}setNodesLineColor(t,e){return this._setNodesLineColor(t,e),Promise.resolve()}_setNodesLineColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartColor(i,Yt.Lines,e)}unsetNodesLineColor(t){return this._unsetNodesColor(t,Yt.Lines),Promise.resolve()}setNodesHighlighted(t,e){if(t.length===0)return Promise.resolve();const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.LoadedNodesOnly);return i.length>0&&this._engine.highlightParts(i,e),Promise.resolve()}getNodesHighlighted(t){const e=this._getInstanceIncsFromLeafNodes(t);return e.length>0?this._engine.getPartHighlighted(e):Promise.resolve([])}setNodesColors(t,e=!1,i=!1){const n=new Set,r=new Map,o=(l,h)=>{const u=this._modelStructure.lookupAnyTreeNode(l);if(u!==null){const d=Lc(u,jt.All,!1,n,zt.None);if(d.length>0){const g=(h.r<<16)+(h.g<<8)+h.b,y=r.get(g);y?r.set(g,y.concat(d)):r.set(g,d)}}};if(t instanceof Map)t.forEach((l,h)=>{o(h,l)});else{const l=Object.keys(t);for(const h of l){const u=parseInt(h,10);o(u,t[u])}}return r.forEach((l,h)=>{const u=new vt(h>>16,(h&65280)>>8,h&255);this._engine.setPartColor(l,Yt.Faces,u),e&&this._engine.setPartColor(l,Yt.Lines,u),i&&this._engine.setPartColor(l,Yt.Points,u)}),Promise.resolve()}getPmiTopologyReferences(t){const e=[],i=(r,o,l)=>{const h=new Om;return h.bodyId=r,h.subElementType=o,h.subElementIndex=l,h},n=this._modelStructure.getPmiTopologyReferences(t);if(n!==null)for(const r of n){const o=r.body.getRuntimeId(),l=r.faceIds;for(const u of l)e.push(i(o,ul.Face,u));const h=r.edgeIds;for(const u of h)e.push(i(o,ul.Edge,u))}return e.length===0?null:e}getPmis(){return this._modelStructure.getPmis()}getPmiType(t){return this._modelStructure.getPmiType(t)}getPmiSubtype(t){return this._modelStructure.getPmiSubType(t)}setPmiColor(t){this._pmiColor.assign(t)}getPmiColor(){return this._pmiColor.copy()}setPmiColorOverride(t,e){return this._pmiColorOverride=t,t?this._modelStructure.setPmiColor(this._pmiColor,e):this._modelStructure.resetPmiColor(e),Promise.resolve()}getPmiColorOverride(){return this._pmiColorOverride}computeMinimumBodyBodyDistance(t,e){const i=this._modelStructure.lookupAnyBody(t);if(i===null)throw new Zn(t,In.AnyBody);const n=this._modelStructure.lookupAnyBody(e);if(n===null)throw new Zn(e,In.AnyBody);const r=i.getInstanceInc(),o=n.getInstanceInc();return this._engine.computeMinimumBodyBodyDistance(r,o)}computeMinimumFaceFaceDistance(t,e,i,n){const r=this._modelStructure.lookupAnyBody(t);if(r===null)throw new Zn(t,In.AnyBody);const o=this._modelStructure.lookupAnyBody(i);if(o===null)throw new Zn(i,In.AnyBody);const l=r.getInstanceInc(),h=o.getInstanceInc();return this._engine.computeMininimumFaceFaceDistance([l[0],l[1]],e,[h[0],h[1]],n)}computeMinimumFaceRayDistance(t,e,i){const n=this._modelStructure.lookupAnyBody(t);if(n===null)throw new Zn(t,In.AnyBody);const r=n.getInstanceInc();return this._engine.computeMinimumFaceRayDistance(r,e,i)}computeMinimumFaceLineDistance(t,e,i){const n=this._modelStructure.lookupAnyBody(t);if(n===null)throw new Zn(t,In.AnyBody);const r=n.getInstanceInc();return this._engine.computeMinimumFaceLineDistance(r,e,i)}setNodeFaceColor(t,e,i){return this._setNodeFaceColor(t,e,i),Promise.resolve()}_setNodeFaceColor(t,e,i){const n=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.None);if(n.length===2){const r=n;this._engine.setElementColor(r,Yt.Faces,e,1,i)}}setNodeFaceVisibility(t,e,i){this._setNodeElementVisibility(t,e,i,Yt.Faces)}clearNodeFaceVisibility(t){this._clearNodeElementVisibility(t,Yt.Faces)}_setNodeElementVisibility(t,e,i,n){const r=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.None);if(r.length===2){const o=r;this._engine.setElementVisibility(o,n,e,1,i)}}_clearNodeElementVisibility(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.None);if(i.length===2){const n=i;this._engine.clearElementVisibility(n,e)}}_unsetElementColor(t,e,i){if(i<0)return;const n=this._getInstanceIncFromSingleLeafNode(t);this._engine.unsetElementColor(n,e,i,1)}unsetNodeFaceColor(t,e){return this._unsetElementColor(t,Yt.Faces,e),Promise.resolve()}setNodeFaceHighlighted(t,e,i){return this._setNodeFaceHighlighted(t,e,i),Promise.resolve()}_setNodeFaceHighlighted(t,e,i){const n=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.LoadedNodesOnly);n.length>0&&this._engine.highlightElements(n,Yt.Faces,e,1,i)}async _getElementHighlighted(t,e,i){const n=this._getInstanceIncFromSingleLeafNode(t),[r]=await this._engine.getElementHighlighted(n,e,i);return r}getNodeFaceHighlighted(t,e){return this._getElementHighlighted(t,Yt.Faces,e)}getNodePointColor(t,e){return this._getNodeElementColor(t,Yt.Points,e)}getNodeEffectivePointColor(t,e,i){return this._getNodeEffectiveElementColor(t,Yt.Points,e,i)}setNodePointColor(t,e,i){const n=this._modelStructure.lookupAnyBody(t);if(n===null)throw new Zn(t,In.AnyBody);const r=n.getInstanceInc();this._engine.setElementColor(r,Yt.Points,e,1,i)}unsetNodePointColor(t,e){this._unsetElementColor(t,Yt.Points,e)}getNodesPointColor(t){return this._getNodesColor(t,Yt.Points)}getNodesEffectivePointColor(t){return this._getNodesEffectiveColor(t,Yt.Points)}setNodesPointColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartColor(i,Yt.Points,e)}unsetNodesPointColor(t){this._unsetNodesColor(t,Yt.Points)}setNodeLineColor(t,e,i){return this._setNodeLineColor(t,e,i),Promise.resolve()}_setNodeLineColor(t,e,i){const n=this._modelStructure.lookupAnyBody(t);if(n===null)throw new Zn(t,In.AnyBody);const r=n.getInstanceInc();this._engine.setElementColor(r,Yt.Lines,e,1,i)}unsetNodeLineColor(t,e){return this._unsetElementColor(t,Yt.Lines,e),Promise.resolve()}setNodeLineVisibility(t,e,i){this._setNodeElementVisibility(t,e,i,Yt.Lines)}clearNodeLineVisibility(t){this._clearNodeElementVisibility(t,Yt.Lines)}setNodeLineHighlighted(t,e,i){return this._setNodeLineHighlighted(t,e,i),Promise.resolve()}_setNodeLineHighlighted(t,e,i){const n=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.LoadedNodesOnly);n.length>0&&this._engine.highlightElements(n,Yt.Lines,e,1,i)}getNodeLineHighlighted(t,e){return this._getElementHighlighted(t,Yt.Lines,e)}setNodePointVisibility(t,e,i){this._setNodeElementVisibility(t,e,i,Yt.Points)}clearNodePointVisibility(t){this._clearNodeElementVisibility(t,Yt.Points)}setNodePointHighlighted(t,e,i){return this._setNodePointHighlighted(t,e,i),Promise.resolve()}_setNodePointHighlighted(t,e,i){const n=this._modelStructure.lookupAnyBody(t);if(n===null)throw new Zn(t,In.AnyBody);const r=n.getInstanceInc();this._engine.highlightElements(r,Yt.Points,e,1,i)}getNodePointHighlighted(t,e){return this._getElementHighlighted(t,Yt.Points,e)}resetNodesColor(){return this._engine.resetColors(),Promise.resolve()}setNodesOpacity(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);i.length>0&&this._engine.setPartOpacity(i,e)}getNodesHaveTransparency(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return e.length>0?this._engine.getPartHasTransparency(e):Promise.resolve([])}setNodesOpacities(t){t=Up(t);const e=new Set;t.forEach((i,n)=>{const r=this._modelStructure.lookupAnyTreeNode(n);if(r!==null){const o=Lc(r,jt.BodyInstance,!1,e,zt.None);o.length>0&&this._engine.setPartOpacity(o,i)}})}resetModelOpacity(){this._engine.resetOpacity(),this._callbackManager.trigger("_resetOpacity")}resetModelHighlight(){return this._engine.clearHighlight(),Promise.resolve()}resetNodesOpacity(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);e.length>0&&this._engine.unsetPartOpacity(e)}_getNodesColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return i.length>0?this._engine.getPartColor(i,e):Promise.resolve([])}_getNodesEffectiveColor(t,e){const i=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return i.length>0?this._engine.getEffectivePartColor(i,e):Promise.resolve([])}getNodesFaceColor(t){return this._getNodesColor(t,Yt.Faces)}getNodesEffectiveFaceColor(t){return this._getNodesEffectiveColor(t,Yt.Faces)}getNodesLineColor(t){return this._getNodesColor(t,Yt.Lines)}getNodesEffectiveLineColor(t){return this._getNodesEffectiveColor(t,Yt.Lines)}async getNodeColorMap(t,e){const i=this._modelStructure.lookupAnyTreeNode(t);if(i!==null)return J0(i,this._engine,e);throw new _s(t)}getNodesOpacity(t){return Promise.resolve(this._getNodesOpacity(t))}_getNodesOpacity(t){const e=this._getInstanceIncsFromLeafNodes(t);return e.length>0?this._engine.getPartOpacity(e):[]}getNodesEffectiveOpacity(t,e){const i=this._getInstanceIncsFromLeafNodes(t);return i&&i.length>0?this._engine.getEffectivePartOpacity(i,e):Promise.resolve([])}async _getNodeElementColor(t,e,i){const n=this._getInstanceIncFromSingleLeafNode(t),[r]=await this._engine.getElementColor(n,e,i);return r}async _getNodeEffectiveElementColor(t,e,i,n){const r=n!==void 0?n.id:ke.Default,o=this._getInstanceIncFromSingleLeafNode(t),[l]=await this._engine.getEffectiveElementColor(o,e,i,r);return l}getNodeFaceColor(t,e){return this._getNodeElementColor(t,Yt.Faces,e)}getNodeEffectiveFaceColor(t,e,i){return this._getNodeEffectiveElementColor(t,Yt.Faces,e,i)}getNodeLineColor(t,e){return this._getNodeElementColor(t,Yt.Lines,e)}getNodeEffectiveLineColor(t,e,i){return this._getNodeEffectiveElementColor(t,Yt.Lines,e,i)}getOutOfHierarchy(t){return this._modelStructure.isOutOfHierarchy(t)}getAbsoluteRootNode(){return this._modelStructure.getAbsoluteRootNodeId()}getNodeChildren(t,e){return this._modelStructure.getChildIds(t,e||!1)}getNodesInstancingSamePart(t){return this._modelStructure.getPartReferrers(t)}getNodeUnitMultiplier(t){return this._modelStructure.getUnit(t)}createCadView(t,e,i,n,r,o,l,h,u){n===void 0&&(n=null),r||(r=[]),o||(o=[]),l||(l=[]),h===void 0&&(h=null),u===void 0&&(u=null);const d=this._modelStructure.createCadView(t,e,i,n,r,o,l,h,u);return d!==null&&this._callbackManager.trigger("cadViewCreated",d,e),d}getCadViewMap(){return this._modelStructure.getCadViewMap()}activateCadView(t,e=Yn,i=!0,n=this._defaultView){return this.resetModelOpacity(),this._modelStructure.activateCadView(n,t,e,i)}getCadViewPmis(t){return this._modelStructure.getCadViewPmis(t)}cadConfigurationsEnabled(){return this._modelStructure.cadConfigurationsEnabled()}getCadConfigurations(){return this._modelStructure.getCadConfigurations()}getDefaultCadConfiguration(){return this._modelStructure.getDefaultCadConfiguration()}getDefaultCadView(){return this._modelStructure.getDefaultCadView()}activateDefaultCadView(t=Yn,e=!0,i=this._defaultView){return this._modelStructure.activateDefaultCadView(i,t,e)}getActiveCadConfiguration(){return this._modelStructure.getActiveCadConfiguration()}getCadViewConfiguration(t){return this._modelStructure.getCadViewConfiguration(t)}activateCadConfiguration(t,e=this._defaultView){return this._modelStructure.activateCadConfiguration(e,t,!0)}activateDefaultCadConfiguration(t=!0,e=this._defaultView){return this._modelStructure.activateDefaultCadConfiguration(e,t)}getPointAttributes(t,e){return this._modelStructure.getPointAttributes(t,e)}getEdgeCount(t){return this._modelStructure.getEdgeCount(t)}getEdgeAttributes(t,e){return this._modelStructure.getEdgeAttributes(t,e)}getEdgeProperty(t,e){return this._modelStructure.getEdgeProperty(t,e)}getFaceCount(t){return this._modelStructure.getFaceCount(t)}getFaceAttributes(t,e){return this._modelStructure.getFaceAttributes(t,e)}getFaceProperty(t,e){return this._modelStructure.getFaceProperty(t,e)}setEdgeProperty(t,e,i){this._modelStructure.setEdgeProperty(t,e,i)}setFaceProperty(t,e,i){this._modelStructure.setFaceProperty(t,e,i)}async getNodeMeshData(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.None);if(e.length===0)throw new ae("Node does not refer to a mesh instance");if(e.length>2)throw new ae("Node refers to multiple mesh instances");const i=e,n=await this._engine.getInstancesMeshData(i);if(n[1]===ic.Invalid)throw new ae("Node has instance, but no mesh data");return this._engine.getMeshData(n)}async getNodeCappingMeshData(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.None);if(e.length===0)throw new ae("Node does not refer to a mesh instance");if(e.length>2)throw new ae("Node refers to multiple mesh instances");const i=e,n=await this._engine.getInstancesCappingMeshData(i);return n[1]===ic.Invalid?null:this._engine.getMeshData(n)}async getNodesCappingMeshData(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None),i=await this._engine.getInstancesCappingMeshData(e),n=[];for(let r=1;r<i.length;r+=2)if(i[r]!==ic.Invalid){const o=[i[r-1],i[r]],l=await this._engine.getMeshData(o);n.push(l)}return n}getNodeMatrix(t){return this._modelStructure.getMatrix(t)}setNodeMatrix(t,e,i=!1){return this._modelStructure.setMatrix(t,e,i)}_setNodesMatrices(t,e,i=!1){return this._modelStructure.setMatrices(t,e,i)}resetNodeMatrixToInitial(t){return this._modelStructure.resetToInitialMatrix(t)}getNodeNetMatrix(t){return _t.createFromArray(this._modelStructure.getNetMatrix(t))}getNodeParent(t){return this._modelStructure.getParentId(t)}getNodeType(t){return this._modelStructure.getType(t)}getNodeProperties(t,e=!0){return this._modelStructure.getProperties(t,e)}addPropertyToNode(t,e,i,n){return this._modelStructure.addProperty(t,e,i,n)}setPhysicalProperties(t,e,i,n){return this._modelStructure.setPhysicalProperties(t,e,i,n)}requestNodes(t){return this._modelStructure.requestNodes(t)}getNodeName(t){return this._modelStructure.getName(t)||null}getNodeExchangeId(t){return this._modelStructure.getNodeExchangeId(t)}getFilters(){return this._modelStructure.getFilters()}getFilterName(t){return this._modelStructure.getFilterName(t)}getFiltersWithNode(t){return this._modelStructure.getFiltersWithNode(t)}getNodesFromFiltersId(t){return this._modelStructure.getNodesFromFilterIds(t)}getLayers(){return this._modelStructure.getLayers()}getUniqueLayerNames(){return this._modelStructure.getUniqueLayerNames()}getLayerName(t){return this._modelStructure.getLayerName(t)}getLayerIdsFromName(t){return this._modelStructure.getLayerIdsFromName(t)}getNodeLayerId(t){return this._modelStructure.getNodeLayerId(t)}getNodesFromLayer(t,e){return this._modelStructure.getRuntimeNodesFromLayer(t,e)}getNodesFromLayers(t,e){return this._modelStructure.getRuntimeNodesFromLayers(t,e)}getNodesFromLayerName(t,e){return this._modelStructure.getRuntimeNodesFromLayerName(t,e)}getNodeVisibility(t){return this._modelStructure.isVisible(t)}getBranchVisibility(t){const e=this._modelStructure.getBranchVisibility(t);return e===he.Shown?he.Shown:e===he.Hidden?he.Hidden:(console.assert(e===he.Mixed),he.Mixed)}getDataFromIds(t){return this._engine.getDataFromIds(t)}async createMesh(t,e){const i=await this._engine.createMesh(t);return e&&e.doNotDelete&&this._preventMeshDeletion(i),i}static _flatArrayToPairArray(t){const e=[];for(let i=0;i<t.length;i+=2)e.push([t[i],t[i+1]]);return e}static _pairArrayToFlatArray(t){const e=[];for(const i of t)e.push(i[0],i[1]);return e}async getMeshIds(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None),i=await this._engine.getInstancesMeshData(e);return al._flatArrayToPairArray(i)}replaceMesh(t,e){return this._engine.replaceMesh(t,e)}createMeshInstance(t,e,i,n){return e===void 0&&(e=null),i||(i=!1),n||(n=!1),this._createMeshInstance(t,e,i,n)}async _createMeshInstance(t,e,i,n){const r=t.getMatrix(),o=r!==null||e!==null;let l=t.getCreationFlags();i&&(l|=ie.DoNotReset),console.assert(!e||!n,"Out of hierarchy instances should not have a parent node.");const h=e===null||this.getNodeVisibility(e);let u=t;(o||!h)&&(u=t.copy(),u.setCreationFlags(l|ie.Invisible));const d=await this._engine.createMeshInstance(u),g=this._modelStructure.createMeshInstance(d[0],d[1],t.getInstanceName(),e,i,n,!1);if(o||!h){const I=r||new _t;await this.setNodeMatrix(g,I,!0),!(l&ie.Invisible)&&h&&this._engine.setPartVisibility(d,!0,!0)}let y=h;l&ie.Invisible&&(y=!1);const m=this._modelStructure.lookupAnyTreeNode(g);return m!==null&&m.setVisibility(y),e!==null&&await this._callbackManager.promiseTrigger("_subtreeLoaded","subtreeLoaded",[g],Dr.CreateInstance),g}async createPmiInstance(t,e,i,n,r){r===void 0&&(r=null);const o=[];for(const u of n){const d=this._modelStructure.lookupBodyInstance(u.bodyId);if(d===null)throw new _s(u.bodyId);const g=Za.fromBodyInstance(d,u.subElementType,u.subElementIndex);o.push(g)}const l=await this._engine.createMeshInstance(t),h=this._modelStructure.createPmiInstance(l[0],l[1],e,i,o,t.getInstanceName(),r);return r!==null&&await this._callbackManager.promiseTrigger("_subtreeLoaded","subtreeLoaded",[h],Dr.CreatePmi),h}createImage(t,e){return this._engine.createImage(t,e)}deleteImages(t){return this._engine.destroyImages(al._pairArrayToFlatArray(t))}setNodesTexture(t,e){const i=this._getInstanceIncsFromLeafNodes(t);return this._engine.setTexture(i,e)}unsetNodesTexture(t){const e=this._getInstanceIncsFromLeafNodes(t);this._engine.unsetTexture(e)}deleteMeshes(t){return this._engine.destroyMeshes(al._pairArrayToFlatArray(t))}deleteMeshInstances(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None),i=[];if(e.length>0){for(const n of t)i.push(this._modelStructure.deleteNode(n));i.push(this._engine.destroyLocalInstances(e))}return Ue(i)}_obtainLoadSubtreeConfig(t){if(t[0]instanceof Ro)return t[0].copy();{const e=new Ro;return e.additionalMatrix=t[0]||null,e.allowMissingExternalModels=!!t[1],e.copy()}}loadSubtreeFromXmlFile(t,e,i,...n){const r=this._obtainLoadSubtreeConfig(n);return i||(i=Mu),this._modelStructure.loadSubtreeFromXmlFile(t,e,i,r)}loadSubtreeFromXmlBuffer(t,e,i,...n){const r=this._obtainLoadSubtreeConfig(n);return i||(i=Mu),this._modelStructure.loadSubtreeFromXmlDoc(t,e,i,r)}loadSubtreeFromScsXmlFile(t,e,i,...n){const r=this._obtainLoadSubtreeConfig(n);return i||(i=Mu),this._modelStructure.loadSubtreeFromScsXmlFile(t,e,i,r)}loadSubtreeFromScsXmlBuffer(t,e,i,...n){const r=this._obtainLoadSubtreeConfig(n);return i||(i=Mu),this._modelStructure.loadSubtreeFromScsXmlDoc(t,e,i,r)}loadSubtreeFromModel(t,e,...i){const n=this._obtainLoadSubtreeConfig(i);return this._modelStructure.loadSubtreeFromStream(t,e,n)}loadSubtreeFromScsFile(t,e,...i){const n=this._obtainLoadSubtreeConfig(i);return this._modelStructure.loadSubtreeFromScsFile(t,e,n)}loadSubtreeFromScsBuffer(t,e,...i){const n=this._obtainLoadSubtreeConfig(i);return this._modelStructure.loadSubtreeFromScsBuffer(t,e,n)}loadMeasurementFromJson(t){return this._modelStructure.loadMeasurementFromJson(t)}loadMeasurementFromString(t){return this._modelStructure.loadMeasurementFromString(t)}loadMeasurementFromFile(t){return this._modelStructure.loadMeasurementFromFile(t)}switchToModel(t){return this._callbackManager.trigger("modelLoadBegin"),this._modelStructure.switchToModel(t)}createNode(t,e,i,n,r,o){t===void 0&&(t=null),i===void 0&&(i=null),n===void 0&&(n=null),r==null&&(r=!0);const l=this._modelStructure.createNode(t,e,i,n,r,o);return l!==null&&this._callbackManager.promiseTrigger("_subtreeLoaded","subtreeLoaded",[l],Dr.CreateNode),l}async deleteNode(t){const e=this._modelStructure.gatherInclusionKeysFromNodeIds([t]);await this._modelStructure.deleteNode(t),await this._engine.detachInclusions(e),this._callbackManager.trigger("subtreeDeleted",[t])}createPart(t){return t===void 0&&(t=null),this._modelStructure.createPart(t)}setPart(t,e){return t==null||e==null?!1:this._modelStructure.setPart(t,e)}createAndAddRepresentationItem(t,e){return t==null?null:(e===void 0&&(e=null),this._modelStructure.createAndAddRepItem(t,e))}getLowestAvailableNodeId(){return this._modelStructure.getLowestAvailableNodeId()}setInstanceModifier(t,e,i){return this._setInstanceModifier(t,e,i,jt.All),Promise.resolve()}_setInstanceModifier(t,e,i,n){const r=this._modelStructure.gatherInstanceIncsFromNodeIds(e,n,zt.None);r.length>0&&this._engine.setInstanceModifier(t,r,i)}getAssociatedModelKey(t){const e=this._modelStructure.getAssociatedModelKey(t);return Promise.resolve(e)}hasDepthRange(t){const e=this._getInstanceIncsFromLeafNodes(t);return this._engine.hasDepthRange(e)}setDepthRange(t,e,i){return this._setDepthRange(t,e,i),Promise.resolve()}_setDepthRange(t,e,i){const n=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);this._engine.setDepthRange(n,e,i)}unsetDepthRange(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);this._engine.unsetDepthRange(e)}_gatherInstanceIncsFromNodeIds(t,e=jt.All){return this._modelStructure.gatherInstanceIncsFromNodeIds(t,e,zt.None)}_getInstanceIncsFromLeafNodes(t){const e=[];for(const i of t){const n=this._modelStructure.gatherInstanceIncsFromNodeIds([i],jt.All,zt.None);if(n.length===2){const r=n;e.push(r[0],r[1])}else throw new ae("Non-leaf node encountered")}return e}_getInstanceIncFromSingleLeafNode(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds([t],jt.All,zt.None);if(e.length===2)return e;throw new ae("Non-leaf node encountered")}setMeshLevel(t,e){return this._modelStructure.setMeshLevel(t,e),Promise.resolve()}setMetallicRoughness(t,e,i){const n=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);this._engine.setMetallicRoughness(n,e,i)}getMetallicRoughness(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return this._engine.getMetallicRoughness(e)}unsetMetallicRoughness(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);this._engine.unsetMetallicRoughness(e)}setEnableAutomaticUnitScaling(t){return this._modelStructure.setEnableAutomaticUnitScaling(t)}setBehaviorInitiallyHidden(t){return this._modelStructure.setBehaviorInitiallyHidden(t)}isDrawing(){return this._modelStructure.isACadDrawing()}isMeasurable(){return this._modelStructure.isMeasurable()}isLineMeasurable(t,e){return this._modelStructure.isLineMeasurable(t,e)}isFaceMeasurable(t,e){return this._modelStructure.isFaceMeasurable(t,e)}getModelFileNameFromNode(t){return this._modelStructure.getModelFileNameFromNode(t)}getModelFileTypeFromNode(t){return this._modelStructure.getModelFileTypeFromNode(t)}getNodeGenericType(t){return this._modelStructure.getNodeGenericType(t)}getNodeGenericId(t){return this._modelStructure.getNodeGenericId(t)}async registerBimNodes(t,e,i=null){const n=this._modelStructure.lookupAnyTreeNode(t);if(n!==null)return typeof i=="boolean"&&(i=i?"TYPE":null),X0(e,this._engine,this._modelStructure,n,i)}getGenericTypeIdMap(){return this._modelStructure.getGenericTypeIdMap()}getNodesByGenericType(t){return this._modelStructure.getNodesByGenericType(t)}getGenericTypes(){return this._modelStructure.getGenericTypes()}hasEffectiveGenericType(t,e){return this._modelStructure.hasEffectiveGenericType(t,e)}registerIfcNodes(t,e=null){return this.registerBimNodes(t,W0,e)}isAnnotationView(t){return this._modelStructure.isAnnotationView(t)}isCombineStateView(t){return this._modelStructure.isCombineStateView(t)}setNodesCullingVector(t,e,i,n){return this._setNodesCullingVector(t,e,i,n),Promise.resolve()}_setNodesCullingVector(t,e,i,n){const r=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);return this._engine.setCullingVector(r,e,i,n)}unsetNodesCullingVectors(t){return this._unsetNodesCullingVectors(t),Promise.resolve()}_unsetNodesCullingVectors(t){const e=this._modelStructure.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None);this._engine.unsetCullingVector(e)}getNodesCullingVectors(t){const e=this._getInstanceIncsFromLeafNodes(t);return this._engine.getCullingVector(e)}getNodeIdOffset(t){return this._modelStructure.getIdOffset(t)}isNodeLoaded(t){return this._modelStructure.isNodeLoaded(t)}triangulatePolygon(t,e){const i=ol(e);return this._engine.triangulatePolygon(t,i)}setNodesLinePattern(t,e,i,n){const r=this._gatherInstanceIncsFromNodeIds(t);this._engine.setLinePattern(r,e,i,n)}unsetNodesLinePattern(t){const e=this._gatherInstanceIncsFromNodeIds(t);this._engine.unsetLinePattern(e)}async _hwfAwaitAssemblyTreeReady(){const t=this.getAbsoluteRootNode(),e=this._modelStructure.lookupAnyTreeNode(t);if(e===null)throw new ei;const i=Ks(e);await Nn.forceLazyPromises(i),await ua([i])}getNodeUserDataIndices(t){return this._modelStructure.getUserDataIndices(t)}getNodeUserData(t,e){return this._modelStructure.getUserData(t,e)}getNodeIdsByGenericIds(t){const e=[];for(const i of t){const n=this._modelStructure.getNodesByGenericId(i);n!==null&&n.forEach(r=>{e.push(r)})}return e}_getModelStructure(){return this._modelStructure}isWithinExternalModel(t){return this._modelStructure.isWithinExternalModel(t)}_firstAssemblyDataHeader(){return this._modelStructure.firstAssemblyDataHeader()}getBimIdFromNode(t){return this._modelStructure.getBimIdFromNode(t)}getBimIdsFromGenericId(t){const e=[],i=this._modelStructure.getNodesByGenericId(t);return i!==null&&i.forEach(n=>{const r=this.getBimIdFromNode(n);r!==null&&e.push(r)}),e}getNodeIdFromBimId(t,e){return this._modelStructure.getRuntimeNodeFromBimId(t,e)}getGenericIdFromBimId(t,e){const i=this._modelStructure.getRuntimeNodeFromBimId(t,e);return i!==null?this._modelStructure.getNodeGenericId(i):null}getRelationshipTypesFromBimId(t,e){const i=[],n=this._modelStructure.getBimIdRelationshipTypes(t,e);for(const r of n)i.push(r.type);return i}getBimIdRelatedElements(t,e,i){const n=this._modelStructure.getBimIdRelationshipTypes(t,e);for(const r of n)if(r.type===i)return r.relateds;return[]}getBimIdRelatingElements(t,e,i){const n=this._modelStructure.getBimIdRelationshipTypes(t,e);for(const r of n)if(r.type===i)return r.relatings;return[]}getBimIdConnectedElements(t,e,i){const n=this._modelStructure.getBimIdRelationshipTypes(t,e);for(const r of n)if(r.type===i)return{relateds:r.relateds,relatings:r.relatings};return{relateds:[],relatings:[]}}getBimInfoFromBimId(t,e){return this._modelStructure.getInfoOfBimId(t,e)}}var Em=(s=>s)(Em||{}),Am=(s=>s)(Am||{}),Dr=(s=>(s[s.LoadModel=0]="LoadModel",s[s.CreateNode=1]="CreateNode",s[s.CreateInstance=2]="CreateInstance",s[s.CreatePmi=3]="CreatePmi",s))(Dr||{}),Tm=(s=>(s[s.Desktop=0]="Desktop",s[s.Mobile=1]="Mobile",s))(Tm||{}),Yt=(s=>(s[s.Faces=0]="Faces",s[s.Lines=1]="Lines",s[s.Points=2]="Points",s))(Yt||{}),ti=(s=>(s[s.Perspective=0]="Perspective",s[s.Orthographic=1]="Orthographic",s))(ti||{}),Ct=(s=>(s[s.Top=0]="Top",s[s.Bottom=1]="Bottom",s[s.Left=2]="Left",s[s.Right=3]="Right",s[s.Front=4]="Front",s[s.Back=5]="Back",s[s.Iso=6]="Iso",s[s.TopRightFront=7]="TopRightFront",s[s.TopLeftFront=8]="TopLeftFront",s[s.TopLeftBack=9]="TopLeftBack",s[s.TopRightBack=10]="TopRightBack",s[s.TopBack=11]="TopBack",s[s.TopFront=12]="TopFront",s[s.TopLeft=13]="TopLeft",s[s.TopRight=14]="TopRight",s[s.BottomRightBack=15]="BottomRightBack",s[s.BottomLeftBack=16]="BottomLeftBack",s[s.BottomLeftFront=17]="BottomLeftFront",s[s.BottomRightFront=18]="BottomRightFront",s[s.BottomFront=19]="BottomFront",s[s.BottomBack=20]="BottomBack",s[s.BottomLeft=21]="BottomLeft",s[s.BottomRight=22]="BottomRight",s[s.RightBottomBack=23]="RightBottomBack",s[s.RightBottomFront=24]="RightBottomFront",s[s.RightTopFront=25]="RightTopFront",s[s.RightTopBack=26]="RightTopBack",s[s.RightTop=27]="RightTop",s[s.RightBottom=28]="RightBottom",s[s.RightFront=29]="RightFront",s[s.RightBack=30]="RightBack",s[s.LeftBottomFront=31]="LeftBottomFront",s[s.LeftBottomBack=32]="LeftBottomBack",s[s.LeftTopBack=33]="LeftTopBack",s[s.LeftTopFront=34]="LeftTopFront",s[s.LeftTop=35]="LeftTop",s[s.LeftBottom=36]="LeftBottom",s[s.LeftBack=37]="LeftBack",s[s.LeftFront=38]="LeftFront",s[s.FrontBottomRight=39]="FrontBottomRight",s[s.FrontTopRight=40]="FrontTopRight",s[s.FrontTopLeft=41]="FrontTopLeft",s[s.FrontBottomLeft=42]="FrontBottomLeft",s[s.FrontRight=43]="FrontRight",s[s.FrontLeft=44]="FrontLeft",s[s.FrontTop=45]="FrontTop",s[s.FrontBottom=46]="FrontBottom",s[s.BackTopRight=47]="BackTopRight",s[s.BackBottomRight=48]="BackBottomRight",s[s.BackBottomLeft=49]="BackBottomLeft",s[s.BackTopLeft=50]="BackTopLeft",s[s.BackLeft=51]="BackLeft",s[s.BackRight=52]="BackRight",s[s.BackBottom=53]="BackBottom",s[s.BackTop=54]="BackTop",s))(Ct||{}),Xe=(s=>(s[s.X=0]="X",s[s.Y=1]="Y",s[s.Z=2]="Z",s))(Xe||{}),Me=(s=>(s[s.None=-1]="None",s[s.Left=0]="Left",s[s.Middle=1]="Middle",s[s.Right=2]="Right",s))(Me||{}),ls=(s=>(s[s.None=0]="None",s[s.Left=1]="Left",s[s.Right=2]="Right",s[s.Middle=4]="Middle",s))(ls||{}),dr=(s=>(s[s.Axis=0]="Axis",s[s.Plane=1]="Plane",s[s.ViewPlane=2]="ViewPlane",s[s.Rotate=3]="Rotate",s))(dr||{}),ao=(s=>(s[s.Translate=0]="Translate",s[s.Rotate=1]="Rotate",s))(ao||{}),_e=(s=>(s[s.Invalid=-1]="Invalid",s[s.None=0]="None",s[s.Navigate=1]="Navigate",s[s.Orbit=2]="Orbit",s[s.Pan=3]="Pan",s[s.Zoom=4]="Zoom",s[s.WindowZoom=5]="WindowZoom",s[s.Walk=6]="Walk",s[s.KeyboardWalk=7]="KeyboardWalk",s[s.WalkMode=8]="WalkMode",s[s.Turntable=9]="Turntable",s[s.Select=10]="Select",s[s.AreaSelect=11]="AreaSelect",s[s.RayDrillSelect=12]="RayDrillSelect",s[s.RedlineCircle=13]="RedlineCircle",s[s.RedlineText=14]="RedlineText",s[s.RedlineRectangle=15]="RedlineRectangle",s[s.RedlinePolyline=16]="RedlinePolyline",s[s.MeasureEdgeLength=17]="MeasureEdgeLength",s[s.MeasureFaceFaceDistance=18]="MeasureFaceFaceDistance",s[s.MeasureLineLineAngle=19]="MeasureLineLineAngle",s[s.MeasurePointPointDistance=20]="MeasurePointPointDistance",s[s.MeasureBodyBodyDistance=21]="MeasureBodyBodyDistance",s[s.MeasureFaceFaceAngle=22]="MeasureFaceFaceAngle",s[s.MeasurePolylineDistance=23]="MeasurePolylineDistance",s[s.MeasurePolygonArea=24]="MeasurePolygonArea",s[s.Note=25]="Note",s[s.Cutting=26]="Cutting",s[s.Handle=27]="Handle",s[s.NavCube=28]="NavCube",s[s.AxisTriad=29]="AxisTriad",s[s.Floorplan=30]="Floorplan",s[s.SpaceMouse=31]="SpaceMouse",s))(_e||{}),le=(s=>(s[s.MouseDown=0]="MouseDown",s[s.MouseMove=1]="MouseMove",s[s.MouseUp=2]="MouseUp",s[s.Mousewheel=3]="Mousewheel",s[s.TouchStart=4]="TouchStart",s[s.TouchMove=5]="TouchMove",s[s.TouchEnd=6]="TouchEnd",s[s.KeyDown=7]="KeyDown",s[s.KeyUp=8]="KeyUp",s[s.ViewOrientationChange=9]="ViewOrientationChange",s))(le||{}),_i=(s=>(s[s.None=0]="None",s[s.Shift=2]="Shift",s[s.Alt=4]="Alt",s[s.Control=8]="Control",s[s.Command=16]="Command",s))(_i||{}),Xs=(s=>(s[s.Down=0]="Down",s[s.Up=1]="Up",s[s.Move=2]="Move",s[s.Wheel=3]="Wheel",s))(Xs||{}),jc=(s=>(s[s.Start=0]="Start",s[s.Move=1]="Move",s[s.End=2]="End",s))(jc||{}),Eu=(s=>(s[s.Down=0]="Down",s[s.Up=1]="Up",s))(Eu||{}),Te=(s=>(s[s.Forward=0]="Forward",s[s.Backward=1]="Backward",s[s.Left=2]="Left",s[s.Right=3]="Right",s[s.Up=4]="Up",s[s.Down=5]="Down",s[s.RotateRight=6]="RotateRight",s[s.RotateLeft=7]="RotateLeft",s[s.TiltUp=8]="TiltUp",s[s.TiltDown=9]="TiltDown",s))(Te||{}),Je=(s=>(s[s.Backspace=8]="Backspace",s[s.Shift=16]="Shift",s[s.Escape=27]="Escape",s[s.PgUp=33]="PgUp",s[s.PgDown=34]="PgDown",s[s.LeftArrow=37]="LeftArrow",s[s.UpArrow=38]="UpArrow",s[s.RightArrow=39]="RightArrow",s[s.DownArrow=40]="DownArrow",s[s.Delete=46]="Delete",s[s.a=65]="a",s[s.b=66]="b",s[s.c=67]="c",s[s.d=68]="d",s[s.e=69]="e",s[s.f=70]="f",s[s.g=71]="g",s[s.h=72]="h",s[s.i=73]="i",s[s.j=74]="j",s[s.k=75]="k",s[s.l=76]="l",s[s.m=77]="m",s[s.n=78]="n",s[s.o=79]="o",s[s.p=80]="p",s[s.q=81]="q",s[s.r=82]="r",s[s.s=83]="s",s[s.t=84]="t",s[s.u=85]="u",s[s.v=86]="v",s[s.w=87]="w",s[s.x=88]="x",s[s.y=89]="y",s[s.z=90]="z",s[s._0=48]="_0",s[s._1=49]="_1",s[s._2=50]="_2",s[s._3=51]="_3",s[s._4=52]="_4",s[s._5=53]="_5",s[s._6=54]="_6",s[s._7=55]="_7",s[s._8=56]="_8",s[s._9=57]="_9",s[s.NumPad_0=96]="NumPad_0",s[s.NumPad_1=97]="NumPad_1",s[s.NumPad_2=98]="NumPad_2",s[s.NumPad_3=99]="NumPad_3",s[s.NumPad_4=100]="NumPad_4",s[s.NumPad_5=101]="NumPad_5",s[s.NumPad_6=102]="NumPad_6",s[s.NumPad_7=103]="NumPad_7",s[s.NumPad_8=104]="NumPad_8",s[s.NumPad_9=105]="NumPad_9",s))(Je||{}),xe=(s=>(s[s.None=0]="None",s[s.Face=1]="Face",s[s.Line=2]="Line",s[s.Point=4]="Point",s[s.All=7]="All",s))(xe||{}),Pn=(s=>(s[s.None=0]="None",s[s.Face=1]="Face",s[s.Line=2]="Line",s[s.Point=3]="Point",s[s.Part=4]="Part",s))(Pn||{}),fn=(s=>(s[s.Set=0]="Set",s[s.Add=1]="Add",s[s.Toggle=2]="Toggle",s))(fn||{}),fr=(s=>(s[s.HighlightOnly=0]="HighlightOnly",s[s.OutlineOnly=1]="OutlineOnly",s[s.HighlightAndOutline=2]="HighlightAndOutline",s))(fr||{}),Nm=(s=>(s[s.Info=0]="Info",s[s.Warning=1]="Warning",s[s.Error=2]="Error",s))(Nm||{}),lo=(s=>(s[s.Interactive=1]="Interactive",s[s.All=2]="All",s[s.OnDemand=4]="OnDemand",s[s.Default=1]="Default",s))(lo||{}),ll=(s=>(s[s.Client=0]="Client",s[s.Server=1]="Server",s))(ll||{}),Js=(s=>(s[s.Wireframe=0]="Wireframe",s[s.Shaded=1]="Shaded",s[s.WireframeOnShaded=2]="WireframeOnShaded",s[s.HiddenLine=3]="HiddenLine",s[s.XRay=4]="XRay",s[s.Gooch=5]="Gooch",s[s.Toon=6]="Toon",s))(Js||{}),Dm=(s=>(s[s.Unsorted=0]="Unsorted",s[s.SingleLayer=1]="SingleLayer",s))(Dm||{}),Au=(s=>(s[s.SMAA=0]="SMAA",s[s.None=1]="None",s))(Au||{}),$i=(s=>(s[s.DoNotExplode=0]="DoNotExplode",s[s.DoNotCut=1]="DoNotCut",s[s.DoNotSelect=2]="DoNotSelect",s[s.SuppressCameraScale=3]="SuppressCameraScale",s[s.OverrideSceneVisibility=4]="OverrideSceneVisibility",s[s.DoNotLight=5]="DoNotLight",s[s.DoNotOutlineHighlight=6]="DoNotOutlineHighlight",s[s.ExcludeBounding=7]="ExcludeBounding",s[s.DoNotUseVertexColors=8]="DoNotUseVertexColors",s[s.AlwaysDraw=9]="AlwaysDraw",s[s.DoNotXRay=10]="DoNotXRay",s[s.ScreenOriented=11]="ScreenOriented",s[s.ScreenSpace=12]="ScreenSpace",s[s.ScreenSpaceStretched=13]="ScreenSpaceStretched",s[s.DoNotReset=14]="DoNotReset",s))($i||{}),ie=(s=>(s[s.None=0]="None",s[s.SuppressCameraScale=1]="SuppressCameraScale",s[s.ScreenOriented=2]="ScreenOriented",s[s.DoNotCut=4]="DoNotCut",s[s.DoNotExplode=8]="DoNotExplode",s[s.DoNotSelect=16]="DoNotSelect",s[s.DoNotLight=32]="DoNotLight",s[s.DoNotOutlineHighlight=64]="DoNotOutlineHighlight",s[s.ExcludeBounding=128]="ExcludeBounding",s[s.DoNotUseVertexColors=256]="DoNotUseVertexColors",s[s.Invisible=512]="Invisible",s[s.DoNotXRay=1024]="DoNotXRay",s[s.AlwaysDraw=2048]="AlwaysDraw",s[s.OverrideSceneVisibility=4096]="OverrideSceneVisibility",s[s.ScreenSpace=8192]="ScreenSpace",s[s.ScreenSpaceStretched=16384]="ScreenSpaceStretched",s[s.DoNotReset=32768]="DoNotReset",s))(ie||{}),co=(s=>(s[s.None=0]="None",s[s.Model=1]="Model",s[s.Instance=2]="Instance",s[s.Ejected=4]="Ejected",s[s.All=7]="All",s))(co||{}),cl=(s=>(s[s.CameraTarget=0]="CameraTarget",s[s.ModelCenter=1]="ModelCenter",s[s.OrbitTarget=2]="OrbitTarget",s))(cl||{}),hl=(s=>(s[s.Mouse=0]="Mouse",s[s.Keyboard=1]="Keyboard",s))(hl||{}),Ne=(s=>(s[s.AssemblyNode=0]="AssemblyNode",s[s.PartInstance=1]="PartInstance",s[s.Part=2]="Part",s[s.BodyInstance=3]="BodyInstance",s[s.PmiBody=4]="PmiBody",s[s.ViewFrame=5]="ViewFrame",s[s.Body=6]="Body",s[s.BrepBody=7]="BrepBody",s[s.TessBody=8]="TessBody",s[s.WireBody=9]="WireBody",s[s.PointsBody=10]="PointsBody",s[s.Pmi=11]="Pmi",s[s.CadView=12]="CadView",s[s.DrawingSheet=13]="DrawingSheet",s[s.Unknown=14]="Unknown",s))(Ne||{}),Nf=(s=>(s[s.Unknown=0]="Unknown",s[s.Text=1]="Text",s[s.Dimension=2]="Dimension",s[s.Arrow=3]="Arrow",s[s.Balloon=4]="Balloon",s[s.CircleCenter=5]="CircleCenter",s[s.Coordinate=6]="Coordinate",s[s.Datum=7]="Datum",s[s.Fastener=8]="Fastener",s[s.Gdt=9]="Gdt",s[s.Locator=10]="Locator",s[s.MeasurementPoint=11]="MeasurementPoint",s[s.Roughness=12]="Roughness",s[s.Welding=13]="Welding",s[s.Table=14]="Table",s[s.Other=15]="Other",s[s.GeometricalTolerance=16]="GeometricalTolerance",s))(Nf||{}),Df=(s=>(s[s.Unknown=0]="Unknown",s[s.DatumIdent=1]="DatumIdent",s[s.DatumTarget=2]="DatumTarget",s[s.DimensionDistance=1]="DimensionDistance",s[s.DimensionDistanceOffset=2]="DimensionDistanceOffset",s[s.DimensionDistanceCumulate=3]="DimensionDistanceCumulate",s[s.DimensionChamfer=4]="DimensionChamfer",s[s.DimensionSlope=5]="DimensionSlope",s[s.DimensionOrdinate=6]="DimensionOrdinate",s[s.DimensionRadius=7]="DimensionRadius",s[s.DimensionRadiusTangent=8]="DimensionRadiusTangent",s[s.DimensionRadiusCylinder=9]="DimensionRadiusCylinder",s[s.DimensionRadiusEdge=10]="DimensionRadiusEdge",s[s.DimensionDiameter=11]="DimensionDiameter",s[s.DimensionDiameterTangent=12]="DimensionDiameterTangent",s[s.DimensionDiameterCylinder=13]="DimensionDiameterCylinder",s[s.DimensionDiameterEdge=14]="DimensionDiameterEdge",s[s.DimensionDiameterCone=15]="DimensionDiameterCone",s[s.DimensionLength=16]="DimensionLength",s[s.DimensionLengthCurvilinear=17]="DimensionLengthCurvilinear",s[s.DimensionLengthCircular=18]="DimensionLengthCircular",s[s.DimensionAngle=19]="DimensionAngle",s[s.GdtFcf=1]="GdtFcf",s[s.WeldingLine=1]="WeldingLine",s[s.WeldingSpot=2]="WeldingSpot",s[s.OtherSymbolUser=1]="OtherSymbolUser",s[s.OtherSymbolUtility=2]="OtherSymbolUtility",s[s.OtherSymbolCustom=3]="OtherSymbolCustom",s[s.OtherGeometricReference=4]="OtherGeometricReference",s[s.OtherRegion=5]="OtherRegion",s))(Df||{}),ul=(s=>(s[s.Unknown=-1]="Unknown",s[s.Context=1]="Context",s[s.Item=2]="Item",s[s.MultipleVertex=3]="MultipleVertex",s[s.UniqueVertex=4]="UniqueVertex",s[s.WireEdge=5]="WireEdge",s[s.Edge=6]="Edge",s[s.CoEdge=7]="CoEdge",s[s.Loop=8]="Loop",s[s.Face=9]="Face",s[s.Shell=10]="Shell",s[s.Connex=11]="Connex",s[s.Body=12]="Body",s[s.SingleWireBody=13]="SingleWireBody",s[s.BrepData=14]="BrepData",s[s.WireBody=17]="WireBody",s))(ul||{}),Rs=(s=>(s[s.Unknown=0]="Unknown",s[s.Clockwise=1]="Clockwise",s[s.CounterClockwise=2]="CounterClockwise",s))(Rs||{}),je=(s=>(s[s.UpperLeftCorner=0]="UpperLeftCorner",s[s.LowerLeftCorner=1]="LowerLeftCorner",s[s.LowerRightCorner=2]="LowerRightCorner",s[s.UpperRightCorner=3]="UpperRightCorner",s[s.TopCenter=4]="TopCenter",s[s.LeftCenter=5]="LeftCenter",s[s.RightCenter=6]="RightCenter",s[s.BottomCenter=7]="BottomCenter",s[s.Center=8]="Center",s))(je||{}),De=(s=>(s[s.Pixels=0]="Pixels",s[s.ProportionOfCanvas=1]="ProportionOfCanvas",s[s.MinimumProportionOfCanvas=2]="MinimumProportionOfCanvas",s[s.ProportionOfOtherDimension=3]="ProportionOfOtherDimension",s))(De||{}),Tu=(s=>(s[s.ScreenPixels=0]="ScreenPixels",s[s.CSSPixels=1]="CSSPixels",s[s.World=2]="World",s[s.ProportionOfScreenWidth=3]="ProportionOfScreenWidth",s[s.ProportionOfScreenHeight=4]="ProportionOfScreenHeight",s[s.ProportionOfBoundingDiagonal=5]="ProportionOfBoundingDiagonal",s))(Tu||{}),Nu=(s=>(s[s.Square=0]="Square",s[s.Disk=1]="Disk",s[s.Sphere=2]="Sphere",s))(Nu||{});class Om{constructor(){this.bodyId=ku,this.subElementType=-1,this.subElementIndex=-1}}var he=(s=>(s[s.Hidden=0]="Hidden",s[s.Shown=1]="Shown",s[s.Mixed=2]="Mixed",s))(he||{}),Rm=(s=>(s[s.Object=0]="Object",s[s.World=1]="World",s))(Rm||{}),ye=(s=>(s[s.First=8]="First",s[s.Handles=8]="Handles",s[s.AxisTriad=9]="AxisTriad",s[s.NavCube=10]="NavCube",s[s.Floorplan=11]="Floorplan",s[s.TestFramework=12]="TestFramework",s))(ye||{});class Lm{constructor(){this.pos1=_.zero(),this.pos2=_.zero(),this.distance=0}}class Of{constructor(){this.frontVector=new _(-1,0,0),this.upVector=new _(0,0,1)}}var Fm=(s=>(s[s.Object=0]="Object",s[s.World=1]="World",s[s.ProportionOfScreenWidth=2]="ProportionOfScreenWidth",s[s.ProportionOfScreenHeight=3]="ProportionOfScreenHeight",s))(Fm||{}),dl=(s=>(s[s.Selected=0]="Selected",s[s.Unselected=1]="Unselected",s))(dl||{}),Ls=(s=>(s[s.Pixels=0]="Pixels",s[s.ProportionOfWidth=1]="ProportionOfWidth",s[s.ProportionOfHeight=2]="ProportionOfHeight",s))(Ls||{}),gr=(s=>(s[s.Undefined=0]="Undefined",s[s.Int=1]="Int",s[s.Float=2]="Float",s[s.Time=3]="Time",s[s.String=4]="String",s[s.Ignored=5]="Ignored",s))(gr||{});class Rf{constructor(t,e){this.isInclusive=t,this.nodeIds=e}}class Bm{constructor(t,e){this.defaultVisibility=t,this.visibilityExceptions=e}}class Ro{constructor(){this.additionalMatrix=null,this.allowMissingExternalModels=!1,this.attachInvisibly=!1,this.implicitlyLoadXmlExternalModels=!0,this.ignoreCadViews=!1,this.ignoreFilters=!1,this.ignoreLayers=!1,this.ignoreGenericTypes=!1,this.ignoreBimRelationships=!1,this._allowSubtreeLoadedCallback=!0}copy(){const t=new Ro;return t.additionalMatrix=this.additionalMatrix,t.additionalMatrix!==null&&(t.additionalMatrix=t.additionalMatrix.copy()),t.allowMissingExternalModels=this.allowMissingExternalModels,t.attachInvisibly=this.attachInvisibly,t.implicitlyLoadXmlExternalModels=this.implicitlyLoadXmlExternalModels,t.ignoreCadViews=this.ignoreCadViews,t.ignoreFilters=this.ignoreFilters,t.ignoreLayers=this.ignoreLayers,t.ignoreGenericTypes=this.ignoreGenericTypes,t.ignoreBimRelationships=this.ignoreBimRelationships,t._allowSubtreeLoadedCallback=this._allowSubtreeLoadedCallback,t}}var fl=(s=>(s[s.Unknown=0]="Unknown",s[s.Catia=2]="Catia",s[s.CatiaV5=3]="CatiaV5",s[s.Cadds=4]="Cadds",s[s.Unigraphics=5]="Unigraphics",s[s.Parasolid=6]="Parasolid",s[s.Euclid=7]="Euclid",s[s.Iges=9]="Iges",s[s.Unisurf=10]="Unisurf",s[s.Vda=11]="Vda",s[s.Stl=12]="Stl",s[s.Wrl=13]="Wrl",s[s.Dxf=14]="Dxf",s[s.Acis=15]="Acis",s[s.ProE=16]="ProE",s[s.Step=18]="Step",s[s.Ideas=19]="Ideas",s[s.Jt=20]="Jt",s[s.Slw=22]="Slw",s[s.Cgr=23]="Cgr",s[s.Prc=24]="Prc",s[s.Xvl=25]="Xvl",s[s.Hpgl=26]="Hpgl",s[s.TopSolid=27]="TopSolid",s[s.OneSpaceDesigner=28]="OneSpaceDesigner",s[s._3dxml=29]="_3dxml",s[s.Inventor=30]="Inventor",s[s.PostScript=31]="PostScript",s[s.Pdp=32]="Pdp",s[s.U3d=33]="U3d",s[s.Ifc=34]="Ifc",s[s.Dwg=35]="Dwg",s[s.Dwf=36]="Dwf",s[s.Se=37]="Se",s[s.Obj=38]="Obj",s[s.Kmz=39]="Kmz",s[s.Dae=40]="Dae",s[s._3ds=41]="_3ds",s[s.Rhino=43]="Rhino",s[s.Xml=44]="Xml",s[s._3mf=45]="_3mf",s[s.Scs=46]="Scs",s[s._3dHtml=47]="_3dHtml",s[s.Hsf=48]="Hsf",s[s.Gltf=49]="Gltf",s[s.Revit=50]="Revit",s[s.Fbx=51]="Fbx",s))(fl||{}),Du=(s=>(s[s.World=0]="World",s[s.ProportionOfBoundingHeight=1]="ProportionOfBoundingHeight",s))(Du||{}),Vm=(s=>(s[s.Default=0]="Default",s[s.PerNode=1]="PerNode",s))(Vm||{}),ga=(s=>(s[s.NorthUp=0]="NorthUp",s[s.AvatarUp=1]="AvatarUp",s))(ga||{}),Lf=(s=>(s[s.ContainedInSpatialStructure=0]="ContainedInSpatialStructure",s[s.Aggregates=1]="Aggregates",s[s.VoidsElement=2]="VoidsElement",s[s.FillsElement=3]="FillsElement",s[s.SpaceBoundary=4]="SpaceBoundary",s[s.ConnectsPathElements=5]="ConnectsPathElements",s[s.Undefined=6]="Undefined",s))(Lf||{}),Ff=(s=>(s[s.FixedFramerate=0]="FixedFramerate",s[s.OcclusionCulling=1]="OcclusionCulling",s))(Ff||{}),cs=(s=>(s[s.Rgba32=0]="Rgba32",s[s.Rgb24=1]="Rgb24",s[s.Gray8=2]="Gray8",s[s.GrayAlpha16=3]="GrayAlpha16",s[s.Jpeg=4]="Jpeg",s[s.Png=5]="Png",s))(cs||{}),Ou=(s=>(s[s.Clamp=0]="Clamp",s[s.Repeat=1]="Repeat",s[s.Trim=2]="Trim",s))(Ou||{}),zm=(s=>(s[s.UV=0]="UV",s))(zm||{}),Hm=(s=>(s[s.Decal=1]="Decal",s))(Hm||{}),gl=(s=>(s[s.Model=1]="Model",s[s.Svg=2]="Svg",s[s.Html=4]="Html",s[s.All=7]="All",s))(gl||{});class ae extends Error{constructor(t){super(t),Object.setPrototypeOf(this,ae.prototype)}}class Ru extends ae{constructor(t){super(`Invalid index (${t}).`),Object.setPrototypeOf(this,Ru.prototype)}}class ho extends ae{constructor(){super("Cannot pick from outside the canvas area."),Object.setPrototypeOf(this,ho.prototype)}}class Or extends ae{constructor(){super("Selection invalidated."),Object.setPrototypeOf(this,Or.prototype)}}class ei extends ae{constructor(){super("Internal logic error."),Object.setPrototypeOf(this,ei.prototype)}}class _s extends ae{constructor(t){super(`Invalid node (${t}).`),Object.setPrototypeOf(this,_s.prototype),this.nodeId=t}}class Zn extends ae{constructor(t,e,...i){i.push(e);const n=[];for(const l of i)switch(l){case In.ProductOccurrence:n.push(Ne.DrawingSheet,Ne.PartInstance,Ne.AssemblyNode);break;case In.AnyBody:n.push(Ne.BodyInstance),n.push(Ne.PmiBody),n.push(Ne.ViewFrame);break;case In.BodyInstance:n.push(Ne.BodyInstance);break;case In.CadView:n.push(Ne.CadView);break;default:Tr()}n.sort();const r=[];for(const l of n)r.push(Ne[l]);const o=r.length===1?`type (${r[0]})`:`types ${r}`;super(`Expected node (${t}) to be of ${o}.`),Object.setPrototypeOf(this,Zn.prototype),this.nodeId=t,this.expectedTypes=n}}class pr extends ae{constructor(t){super(t),Object.setPrototypeOf(this,pr.prototype)}}class Wc extends pr{constructor(){super("Load cancelled."),Object.setPrototypeOf(this,Wc.prototype)}}class Gc extends pr{constructor(t){super(`Missing model: '${t}'.`),Object.setPrototypeOf(this,Gc.prototype)}}class ys extends ae{constructor(t){super(t),Object.setPrototypeOf(this,ys.prototype)}}class Lo extends ys{constructor(t){super(t),Object.setPrototypeOf(this,Lo.prototype)}}class ii extends ys{constructor(t){super(t),Object.setPrototypeOf(this,ii.prototype)}}function sb(s){return rb(s)}function rb(s){const t=new Um;for(const i of s)i._gatherForExport(t);const e={};if(!t.buffers.isEmpty()){e.buffers=[];for(const i of t.buffers.toArray())e.buffers.push(i._export())}if(!t.samplers.isEmpty()){e.samplers=[];for(const i of t.samplers.toArray())e.samplers.push(i._export(t))}if(!t.colorMaps.isEmpty()){e.colorMaps=[];for(const i of t.colorMaps.toArray())e.colorMaps.push(ab(i))}if(s.length!==0){e.animations=[];for(const i of s)e.animations.push(i._export(t))}return{...e}}function ob(s){const t=s,e=new jm;if(t.buffers!==void 0)for(const n of t.buffers)e.buffers.push(Zl._import(n));if(t.samplers!==void 0)for(const n of t.samplers)e.samplers.push(ec._import(e,n));if(t.colorMaps!==void 0)for(const n of t.colorMaps)e.colorMaps.push(lb(n));const i=[];if(t.animations!==void 0)for(const n of t.animations)i.push(Qh._import(e,n));return i}function ab(s){const t=[];for(const e of s)t.push([e.position,e.color.r,e.color.g,e.color.b]);return t}function lb(s){const t=[];for(const e of s)t.push({position:e[0],color:new vt(e[1],e[2],e[3])});return t}class Um{constructor(){this.buffers=new Lu,this.samplers=new Lu,this.colorMaps=new Lu}}class jm{constructor(){this.buffers=[],this.samplers=[],this.colorMaps=[]}}class Lu{constructor(){this.map=new Map}add(t){this.map.has(t)||this.map.set(t,this.map.size)}getIndex(t){const e=this.map.get(t);if(e===void 0)throw new ei;return e}toArray(){const t=[];return this.map.forEach((e,i)=>{t[e]=i}),t}isEmpty(){return this.map.size===0}}var Wm=(s=>(s[s.Stopped=0]="Stopped",s[s.Playing=1]="Playing",s[s.Paused=2]="Paused",s[s.Complete=3]="Complete",s))(Wm||{});const Og=class Og{constructor(t,e){this._viewer=t,this.animation=e,this._nodeValues=new Map,this._disabledChannels=new Set,this._currentTime=0,this._lastUpdate=0,this.speed=1,this._animationTime=0,this._state=0,this.loop=0,this._loopCount=0,this.onComplete=null,this.nodeIdOffset=0,this.reload()}setChannelEnabled(t,e){e?this._disabledChannels.delete(t):this._disabledChannels.add(t)}reload(){this._nodeValues.clear(),this._animationTime=0;for(const t of this.animation.nodeChannels){const e=t.sampler.buffer.times.length;if(e!==0){if(!this._nodeValues.has(t.nodeId)){const i=new bp(t.nodeId);i.pivotPoint=this.animation.pivotPoints.get(t.nodeId),this._nodeValues.set(t.nodeId,i)}this._animationTime=Math.max(this._animationTime,t.sampler.buffer.times[e-1])}}for(const t of this.animation.cameraChannels){const e=t.sampler.buffer.times.length;e!==0&&(this._animationTime=Math.max(this._animationTime,t.sampler.buffer.times[e-1]))}}_tick(t,e){if(this._state!==1)return!1;const i=(t-this._lastUpdate)/1e3;return this._tickTime(i,e),this._lastUpdate=t,!0}_tickTime(t,e){if(this._state!==1)return!1;this._currentTime+=t*this.speed;const i=this._currentTime<0,n=this._currentTime>this._animationTime;return i||n?this.loop<0||this.loop>this._loopCount?(this._loopCount+=1,this._currentTime=i?this._animationTime:0,this.evaluate(this._currentTime,e)):(this._currentTime=this._animationTime,this.evaluate(this._currentTime,e),this._state=3,this._loopCount=0,this.onComplete&&this.onComplete()):this.evaluate(this._currentTime,e),!0}play(){this._state!==1&&(this._state===3&&(this._currentTime=0),this._lastUpdate=performance.now(),this._state=1)}pause(){this._state===1&&(this._state=2)}stop(){this._state=0,this.setTime(0)}setTime(t){const e=new Yh;this._currentTime=Math.min(t,this._animationTime),this.evaluate(this._currentTime,e),e.apply(this._viewer)}evaluate(t,e){e===void 0&&(e=new Yh);for(const i of this.animation.nodeChannels){const n=this._nodeValues.get(i.nodeId);n!==void 0&&!this._disabledChannels.has(i)&&i._getValue(t,n)}this._nodeValues.forEach(i=>{if(e===void 0)throw new ei;const n=i.nodeId+this.nodeIdOffset;(i.flags&En.Transform)===En.Transform&&(i.updateMatrix(),e.node.matrixNodeIds.push(n),e.node.matrices.push(i.matrix)),(i.flags&En.Opacity)===En.Opacity&&e.node.opacities.set(n,i.opacity),(i.flags&En.Visibility)===En.Visibility&&(i.visibility!==0?e.node.visibilityOn.push(n):e.node.visibilityOff.push(n)),(i.flags&En.Color)===En.Color&&e.node.colors.set(n,new vt(i.color.x,i.color.y,i.color.z)),i.flags=En.None});for(const i of this.animation.cameraChannels)i.sampler.buffer.times.length>0&&!this._disabledChannels.has(i)&&i._getValue(t,e.camera);return e}getState(){return this._state}getCurrentTime(){return this._currentTime}getAnimationTime(){return this._animationTime}};Og.LoopIndefinitely=-1;let Fu=Og;class Gm{constructor(t){this._viewer=t,this._players=[],this._intervalHandle=null,this._batch=new Yh,this._viewer.setCallbacks({assemblyTreeReady:()=>{this.setTickInterval(50)}})}createPlayer(t){const e=new Fu(this._viewer,t);return this._players.push(e),e}removePlayerByIndex(t){return t>=this._players.length?!1:(this._players.splice(t,1),!0)}removePlayer(t){for(let e=0;e<this._players.length;e++)if(this._players[e]===t)return this._players.splice(e,1),!0;return!1}clear(){this._players=[]}_tick(){if(this._players.length===0)return;this._batch.clear();let t=!1;const e=performance.now();for(const i of this._players)i._tick(e,this._batch)&&(t=!0);t&&(this._viewer.pauseRendering(),this._batch.apply(this._viewer),this._viewer.resumeRendering())}_shutdown(){this._intervalHandle!==null&&clearInterval(this._intervalHandle)}setTickInterval(t){this._intervalHandle&&clearInterval(this._intervalHandle),this._intervalHandle=setInterval(()=>{this._tick()},t)}}function $c(s,t,e,i){const n=e===or.Width||e===or.Height?Es.Scalar:Es.Vec3,r=new Zl(n),o=new ec(r,i);return s.createCameraChannel(t,e,o)}function cb(s,t,e){const i=[];return i.push($c(s,`${t}-Position`,or.Position,e)),i.push($c(s,`${t}-Target`,or.Target,e)),i.push($c(s,`${t}-Up`,or.Up,e)),i.push($c(s,`${t}-Width`,or.Width,e)),i.push($c(s,`${t}-Height`,or.Height,e)),i}function hb(s,t,e){const i=t.getPosition();e.cameraChannels[0].sampler.buffer.insertVec3Keyframe(s,i.x,i.y,i.z);const n=t.getTarget();e.cameraChannels[1].sampler.buffer.insertVec3Keyframe(s,n.x,n.y,n.z);const r=t.getUp();e.cameraChannels[2].sampler.buffer.insertVec3Keyframe(s,r.x,r.y,r.z),e.cameraChannels[3].sampler.buffer.insertScalarKeyframe(s,t.getWidth()),e.cameraChannels[4].sampler.buffer.insertScalarKeyframe(s,t.getHeight())}const ub=Object.freeze(Object.defineProperty({__proto__:null,Animation:Qh,BatchedCameraValues:Ip,BatchedNodeValues:xp,BatchedValues:Yh,CameraChannel:tc,CameraProperty:or,ExportContext:Um,ImportContext:jm,IndexedSet:Lu,InterpolationType:tu,KeyType:Es,KeyframeBuffer:Zl,Manager:Gm,NodeChannel:Ql,NodeProperty:Zh,NodeValues:bp,NodeValuesFlags:En,Player:Fu,PlayerState:Wm,Sampler:ec,createCameraChannels:cb,exportAnimations:sb,importAnimations:ob,keyframeCamera:hb},Symbol.toStringTag,{value:"Module"}));var Ys=(s=>(s[s.Unknown=0]="Unknown",s[s.v1_0=1]="v1_0",s[s.v2_0=2]="v2_0",s[s.v2_1=3]="v2_1",s))(Ys||{}),Qn=(s=>(s[s.Unknown=0]="Unknown",s[s.TopicFolder=1]="TopicFolder",s[s.Version=2]="Version",s[s.Markup=3]="Markup",s[s.Snapshot=4]="Snapshot",s[s.Viewpoint=5]="Viewpoint",s[s.Schema=6]="Schema",s[s.Project=7]="Project",s))(Qn||{});const Rr="HOOPS Communicator";function qc(s){return s?"true":"false"}function Bu(s,t){const e=s.createElement("Component");return t.ifcGuid!==void 0&&e.setAttribute("IfcGuid",t.ifcGuid),t.originatingSystem!==void 0&&e.setAttribute("OriginatingSystem",t.originatingSystem),t.authoringToolId!==void 0&&e.setAttribute("AuthoringToolId",t.authoringToolId.toString()),e}function Vu(s){return s.length===1?`0${s}`:s}function $m(s,t){const e=t?Vu(Math.round(t).toString(16)):"",i=Vu(Math.round(s.r).toString(16)),n=Vu(Math.round(s.g).toString(16)),r=Vu(Math.round(s.b).toString(16));return`${e}${i}${n}${r}`}function mr(s,t,e){const i=s.createElement("X"),n=s.createElement("Y"),r=s.createElement("Z");i.innerHTML=e.x.toString(),n.innerHTML=e.y.toString(),r.innerHTML=e.z.toString(),t.appendChild(i),t.appendChild(n),t.appendChild(r)}function Lr(s,t,e){e!=null&&s.setAttribute(t,e)}function Fr(s,t,e,i){const n=s.createElement(e);n.innerHTML=i,t.appendChild(n)}function cn(s,t,e,i){i!=null&&Fr(s,t,e,i)}function Kc(s){return s==null?null:s.toISOString()}function Bf(s){return s==null?null:s.toString()}function zu(s){return s==null?null:s?"true":"false"}function Hu(s){throw new Error('Could not dynamically require "'+s+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var qm={exports:{}};/*!

  JSZip v3.10.1 - A JavaScript class for generating and reading zip files
  <http://stuartk.com/jszip>

  (c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
  Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

  JSZip uses the library pako released under the MIT license :
  https://github.com/nodeca/pako/blob/main/LICENSE
  */(function(s,t){(function(e){s.exports=e()})(function(){return function e(i,n,r){function o(u,d){if(!n[u]){if(!i[u]){var g=typeof Hu=="function"&&Hu;if(!d&&g)return g(u,!0);if(l)return l(u,!0);var y=new Error("Cannot find module '"+u+"'");throw y.code="MODULE_NOT_FOUND",y}var m=n[u]={exports:{}};i[u][0].call(m.exports,function(I){var b=i[u][1][I];return o(b||I)},m,m.exports,e,i,n,r)}return n[u].exports}for(var l=typeof Hu=="function"&&Hu,h=0;h<r.length;h++)o(r[h]);return o}({1:[function(e,i,n){var r=e("./utils"),o=e("./support"),l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.encode=function(h){for(var u,d,g,y,m,I,b,x=[],C=0,P=h.length,k=P,O=r.getTypeOf(h)!=="string";C<h.length;)k=P-C,g=O?(u=h[C++],d=C<P?h[C++]:0,C<P?h[C++]:0):(u=h.charCodeAt(C++),d=C<P?h.charCodeAt(C++):0,C<P?h.charCodeAt(C++):0),y=u>>2,m=(3&u)<<4|d>>4,I=1<k?(15&d)<<2|g>>6:64,b=2<k?63&g:64,x.push(l.charAt(y)+l.charAt(m)+l.charAt(I)+l.charAt(b));return x.join("")},n.decode=function(h){var u,d,g,y,m,I,b=0,x=0,C="data:";if(h.substr(0,C.length)===C)throw new Error("Invalid base64 input, it looks like a data url.");var P,k=3*(h=h.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(h.charAt(h.length-1)===l.charAt(64)&&k--,h.charAt(h.length-2)===l.charAt(64)&&k--,k%1!=0)throw new Error("Invalid base64 input, bad content length.");for(P=o.uint8array?new Uint8Array(0|k):new Array(0|k);b<h.length;)u=l.indexOf(h.charAt(b++))<<2|(y=l.indexOf(h.charAt(b++)))>>4,d=(15&y)<<4|(m=l.indexOf(h.charAt(b++)))>>2,g=(3&m)<<6|(I=l.indexOf(h.charAt(b++))),P[x++]=u,m!==64&&(P[x++]=d),I!==64&&(P[x++]=g);return P}},{"./support":30,"./utils":32}],2:[function(e,i,n){var r=e("./external"),o=e("./stream/DataWorker"),l=e("./stream/Crc32Probe"),h=e("./stream/DataLengthProbe");function u(d,g,y,m,I){this.compressedSize=d,this.uncompressedSize=g,this.crc32=y,this.compression=m,this.compressedContent=I}u.prototype={getContentWorker:function(){var d=new o(r.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new h("data_length")),g=this;return d.on("end",function(){if(this.streamInfo.data_length!==g.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),d},getCompressedWorker:function(){return new o(r.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},u.createWorkerFrom=function(d,g,y){return d.pipe(new l).pipe(new h("uncompressedSize")).pipe(g.compressWorker(y)).pipe(new h("compressedSize")).withStreamInfo("compression",g)},i.exports=u},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,i,n){var r=e("./stream/GenericWorker");n.STORE={magic:"\0\0",compressWorker:function(){return new r("STORE compression")},uncompressWorker:function(){return new r("STORE decompression")}},n.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,i,n){var r=e("./utils"),o=function(){for(var l,h=[],u=0;u<256;u++){l=u;for(var d=0;d<8;d++)l=1&l?3988292384^l>>>1:l>>>1;h[u]=l}return h}();i.exports=function(l,h){return l!==void 0&&l.length?r.getTypeOf(l)!=="string"?function(u,d,g,y){var m=o,I=y+g;u^=-1;for(var b=y;b<I;b++)u=u>>>8^m[255&(u^d[b])];return-1^u}(0|h,l,l.length,0):function(u,d,g,y){var m=o,I=y+g;u^=-1;for(var b=y;b<I;b++)u=u>>>8^m[255&(u^d.charCodeAt(b))];return-1^u}(0|h,l,l.length,0):0}},{"./utils":32}],5:[function(e,i,n){n.base64=!1,n.binary=!1,n.dir=!1,n.createFolders=!0,n.date=null,n.compression=null,n.compressionOptions=null,n.comment=null,n.unixPermissions=null,n.dosPermissions=null},{}],6:[function(e,i,n){var r=null;r=typeof Promise<"u"?Promise:e("lie"),i.exports={Promise:r}},{lie:37}],7:[function(e,i,n){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",o=e("pako"),l=e("./utils"),h=e("./stream/GenericWorker"),u=r?"uint8array":"array";function d(g,y){h.call(this,"FlateWorker/"+g),this._pako=null,this._pakoAction=g,this._pakoOptions=y,this.meta={}}n.magic="\b\0",l.inherits(d,h),d.prototype.processChunk=function(g){this.meta=g.meta,this._pako===null&&this._createPako(),this._pako.push(l.transformTo(u,g.data),!1)},d.prototype.flush=function(){h.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},d.prototype.cleanUp=function(){h.prototype.cleanUp.call(this),this._pako=null},d.prototype._createPako=function(){this._pako=new o[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var g=this;this._pako.onData=function(y){g.push({data:y,meta:g.meta})}},n.compressWorker=function(g){return new d("Deflate",g)},n.uncompressWorker=function(){return new d("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,i,n){function r(m,I){var b,x="";for(b=0;b<I;b++)x+=String.fromCharCode(255&m),m>>>=8;return x}function o(m,I,b,x,C,P){var k,O,B=m.file,j=m.compression,V=P!==u.utf8encode,Y=l.transformTo("string",P(B.name)),q=l.transformTo("string",u.utf8encode(B.name)),st=B.comment,ft=l.transformTo("string",P(st)),U=l.transformTo("string",u.utf8encode(st)),J=q.length!==B.name.length,A=U.length!==st.length,R="",bt="",z="",Pt=B.dir,X=B.date,Tt={crc32:0,compressedSize:0,uncompressedSize:0};I&&!b||(Tt.crc32=m.crc32,Tt.compressedSize=m.compressedSize,Tt.uncompressedSize=m.uncompressedSize);var lt=0;I&&(lt|=8),V||!J&&!A||(lt|=2048);var at=0,Gt=0;Pt&&(at|=16),C==="UNIX"?(Gt=798,at|=function(Ft,ni){var ji=Ft;return Ft||(ji=ni?16893:33204),(65535&ji)<<16}(B.unixPermissions,Pt)):(Gt=20,at|=function(Ft){return 63&(Ft||0)}(B.dosPermissions)),k=X.getUTCHours(),k<<=6,k|=X.getUTCMinutes(),k<<=5,k|=X.getUTCSeconds()/2,O=X.getUTCFullYear()-1980,O<<=4,O|=X.getUTCMonth()+1,O<<=5,O|=X.getUTCDate(),J&&(bt=r(1,1)+r(d(Y),4)+q,R+="up"+r(bt.length,2)+bt),A&&(z=r(1,1)+r(d(ft),4)+U,R+="uc"+r(z.length,2)+z);var kt="";return kt+=`
\0`,kt+=r(lt,2),kt+=j.magic,kt+=r(k,2),kt+=r(O,2),kt+=r(Tt.crc32,4),kt+=r(Tt.compressedSize,4),kt+=r(Tt.uncompressedSize,4),kt+=r(Y.length,2),kt+=r(R.length,2),{fileRecord:g.LOCAL_FILE_HEADER+kt+Y+R,dirRecord:g.CENTRAL_FILE_HEADER+r(Gt,2)+kt+r(ft.length,2)+"\0\0\0\0"+r(at,4)+r(x,4)+Y+R+ft}}var l=e("../utils"),h=e("../stream/GenericWorker"),u=e("../utf8"),d=e("../crc32"),g=e("../signature");function y(m,I,b,x){h.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=I,this.zipPlatform=b,this.encodeFileName=x,this.streamFiles=m,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}l.inherits(y,h),y.prototype.push=function(m){var I=m.meta.percent||0,b=this.entriesCount,x=this._sources.length;this.accumulate?this.contentBuffer.push(m):(this.bytesWritten+=m.data.length,h.prototype.push.call(this,{data:m.data,meta:{currentFile:this.currentFile,percent:b?(I+100*(b-x-1))/b:100}}))},y.prototype.openedSource=function(m){this.currentSourceOffset=this.bytesWritten,this.currentFile=m.file.name;var I=this.streamFiles&&!m.file.dir;if(I){var b=o(m,I,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:b.fileRecord,meta:{percent:0}})}else this.accumulate=!0},y.prototype.closedSource=function(m){this.accumulate=!1;var I=this.streamFiles&&!m.file.dir,b=o(m,I,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(b.dirRecord),I)this.push({data:function(x){return g.DATA_DESCRIPTOR+r(x.crc32,4)+r(x.compressedSize,4)+r(x.uncompressedSize,4)}(m),meta:{percent:100}});else for(this.push({data:b.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},y.prototype.flush=function(){for(var m=this.bytesWritten,I=0;I<this.dirRecords.length;I++)this.push({data:this.dirRecords[I],meta:{percent:100}});var b=this.bytesWritten-m,x=function(C,P,k,O,B){var j=l.transformTo("string",B(O));return g.CENTRAL_DIRECTORY_END+"\0\0\0\0"+r(C,2)+r(C,2)+r(P,4)+r(k,4)+r(j.length,2)+j}(this.dirRecords.length,b,m,this.zipComment,this.encodeFileName);this.push({data:x,meta:{percent:100}})},y.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},y.prototype.registerPrevious=function(m){this._sources.push(m);var I=this;return m.on("data",function(b){I.processChunk(b)}),m.on("end",function(){I.closedSource(I.previous.streamInfo),I._sources.length?I.prepareNextSource():I.end()}),m.on("error",function(b){I.error(b)}),this},y.prototype.resume=function(){return!!h.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},y.prototype.error=function(m){var I=this._sources;if(!h.prototype.error.call(this,m))return!1;for(var b=0;b<I.length;b++)try{I[b].error(m)}catch{}return!0},y.prototype.lock=function(){h.prototype.lock.call(this);for(var m=this._sources,I=0;I<m.length;I++)m[I].lock()},i.exports=y},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,i,n){var r=e("../compressions"),o=e("./ZipFileWorker");n.generateWorker=function(l,h,u){var d=new o(h.streamFiles,u,h.platform,h.encodeFileName),g=0;try{l.forEach(function(y,m){g++;var I=function(P,k){var O=P||k,B=r[O];if(!B)throw new Error(O+" is not a valid compression method !");return B}(m.options.compression,h.compression),b=m.options.compressionOptions||h.compressionOptions||{},x=m.dir,C=m.date;m._compressWorker(I,b).withStreamInfo("file",{name:y,dir:x,date:C,comment:m.comment||"",unixPermissions:m.unixPermissions,dosPermissions:m.dosPermissions}).pipe(d)}),d.entriesCount=g}catch(y){d.error(y)}return d}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,i,n){function r(){if(!(this instanceof r))return new r;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var o=new r;for(var l in this)typeof this[l]!="function"&&(o[l]=this[l]);return o}}(r.prototype=e("./object")).loadAsync=e("./load"),r.support=e("./support"),r.defaults=e("./defaults"),r.version="3.10.1",r.loadAsync=function(o,l){return new r().loadAsync(o,l)},r.external=e("./external"),i.exports=r},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,i,n){var r=e("./utils"),o=e("./external"),l=e("./utf8"),h=e("./zipEntries"),u=e("./stream/Crc32Probe"),d=e("./nodejsUtils");function g(y){return new o.Promise(function(m,I){var b=y.decompressed.getContentWorker().pipe(new u);b.on("error",function(x){I(x)}).on("end",function(){b.streamInfo.crc32!==y.decompressed.crc32?I(new Error("Corrupted zip : CRC32 mismatch")):m()}).resume()})}i.exports=function(y,m){var I=this;return m=r.extend(m||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:l.utf8decode}),d.isNode&&d.isStream(y)?o.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):r.prepareContent("the loaded zip file",y,!0,m.optimizedBinaryString,m.base64).then(function(b){var x=new h(m);return x.load(b),x}).then(function(b){var x=[o.Promise.resolve(b)],C=b.files;if(m.checkCRC32)for(var P=0;P<C.length;P++)x.push(g(C[P]));return o.Promise.all(x)}).then(function(b){for(var x=b.shift(),C=x.files,P=0;P<C.length;P++){var k=C[P],O=k.fileNameStr,B=r.resolve(k.fileNameStr);I.file(B,k.decompressed,{binary:!0,optimizedBinaryString:!0,date:k.date,dir:k.dir,comment:k.fileCommentStr.length?k.fileCommentStr:null,unixPermissions:k.unixPermissions,dosPermissions:k.dosPermissions,createFolders:m.createFolders}),k.dir||(I.file(B).unsafeOriginalName=O)}return x.zipComment.length&&(I.comment=x.zipComment),I})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,i,n){var r=e("../utils"),o=e("../stream/GenericWorker");function l(h,u){o.call(this,"Nodejs stream input adapter for "+h),this._upstreamEnded=!1,this._bindStream(u)}r.inherits(l,o),l.prototype._bindStream=function(h){var u=this;(this._stream=h).pause(),h.on("data",function(d){u.push({data:d,meta:{percent:0}})}).on("error",function(d){u.isPaused?this.generatedError=d:u.error(d)}).on("end",function(){u.isPaused?u._upstreamEnded=!0:u.end()})},l.prototype.pause=function(){return!!o.prototype.pause.call(this)&&(this._stream.pause(),!0)},l.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},i.exports=l},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,i,n){var r=e("readable-stream").Readable;function o(l,h,u){r.call(this,h),this._helper=l;var d=this;l.on("data",function(g,y){d.push(g)||d._helper.pause(),u&&u(y)}).on("error",function(g){d.emit("error",g)}).on("end",function(){d.push(null)})}e("../utils").inherits(o,r),o.prototype._read=function(){this._helper.resume()},i.exports=o},{"../utils":32,"readable-stream":16}],14:[function(e,i,n){i.exports={isNode:typeof Buffer<"u",newBufferFrom:function(r,o){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(r,o);if(typeof r=="number")throw new Error('The "data" argument must not be a number');return new Buffer(r,o)},allocBuffer:function(r){if(Buffer.alloc)return Buffer.alloc(r);var o=new Buffer(r);return o.fill(0),o},isBuffer:function(r){return Buffer.isBuffer(r)},isStream:function(r){return r&&typeof r.on=="function"&&typeof r.pause=="function"&&typeof r.resume=="function"}}},{}],15:[function(e,i,n){function r(B,j,V){var Y,q=l.getTypeOf(j),st=l.extend(V||{},d);st.date=st.date||new Date,st.compression!==null&&(st.compression=st.compression.toUpperCase()),typeof st.unixPermissions=="string"&&(st.unixPermissions=parseInt(st.unixPermissions,8)),st.unixPermissions&&16384&st.unixPermissions&&(st.dir=!0),st.dosPermissions&&16&st.dosPermissions&&(st.dir=!0),st.dir&&(B=C(B)),st.createFolders&&(Y=x(B))&&P.call(this,Y,!0);var ft=q==="string"&&st.binary===!1&&st.base64===!1;V&&V.binary!==void 0||(st.binary=!ft),(j instanceof g&&j.uncompressedSize===0||st.dir||!j||j.length===0)&&(st.base64=!1,st.binary=!0,j="",st.compression="STORE",q="string");var U=null;U=j instanceof g||j instanceof h?j:I.isNode&&I.isStream(j)?new b(B,j):l.prepareContent(B,j,st.binary,st.optimizedBinaryString,st.base64);var J=new y(B,U,st);this.files[B]=J}var o=e("./utf8"),l=e("./utils"),h=e("./stream/GenericWorker"),u=e("./stream/StreamHelper"),d=e("./defaults"),g=e("./compressedObject"),y=e("./zipObject"),m=e("./generate"),I=e("./nodejsUtils"),b=e("./nodejs/NodejsStreamInputAdapter"),x=function(B){B.slice(-1)==="/"&&(B=B.substring(0,B.length-1));var j=B.lastIndexOf("/");return 0<j?B.substring(0,j):""},C=function(B){return B.slice(-1)!=="/"&&(B+="/"),B},P=function(B,j){return j=j!==void 0?j:d.createFolders,B=C(B),this.files[B]||r.call(this,B,null,{dir:!0,createFolders:j}),this.files[B]};function k(B){return Object.prototype.toString.call(B)==="[object RegExp]"}var O={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(B){var j,V,Y;for(j in this.files)Y=this.files[j],(V=j.slice(this.root.length,j.length))&&j.slice(0,this.root.length)===this.root&&B(V,Y)},filter:function(B){var j=[];return this.forEach(function(V,Y){B(V,Y)&&j.push(Y)}),j},file:function(B,j,V){if(arguments.length!==1)return B=this.root+B,r.call(this,B,j,V),this;if(k(B)){var Y=B;return this.filter(function(st,ft){return!ft.dir&&Y.test(st)})}var q=this.files[this.root+B];return q&&!q.dir?q:null},folder:function(B){if(!B)return this;if(k(B))return this.filter(function(q,st){return st.dir&&B.test(q)});var j=this.root+B,V=P.call(this,j),Y=this.clone();return Y.root=V.name,Y},remove:function(B){B=this.root+B;var j=this.files[B];if(j||(B.slice(-1)!=="/"&&(B+="/"),j=this.files[B]),j&&!j.dir)delete this.files[B];else for(var V=this.filter(function(q,st){return st.name.slice(0,B.length)===B}),Y=0;Y<V.length;Y++)delete this.files[V[Y].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(B){var j,V={};try{if((V=l.extend(B||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:o.utf8encode})).type=V.type.toLowerCase(),V.compression=V.compression.toUpperCase(),V.type==="binarystring"&&(V.type="string"),!V.type)throw new Error("No output type specified.");l.checkSupport(V.type),V.platform!=="darwin"&&V.platform!=="freebsd"&&V.platform!=="linux"&&V.platform!=="sunos"||(V.platform="UNIX"),V.platform==="win32"&&(V.platform="DOS");var Y=V.comment||this.comment||"";j=m.generateWorker(this,V,Y)}catch(q){(j=new h("error")).error(q)}return new u(j,V.type||"string",V.mimeType)},generateAsync:function(B,j){return this.generateInternalStream(B).accumulate(j)},generateNodeStream:function(B,j){return(B=B||{}).type||(B.type="nodebuffer"),this.generateInternalStream(B).toNodejsStream(j)}};i.exports=O},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,i,n){i.exports=e("stream")},{stream:void 0}],17:[function(e,i,n){var r=e("./DataReader");function o(l){r.call(this,l);for(var h=0;h<this.data.length;h++)l[h]=255&l[h]}e("../utils").inherits(o,r),o.prototype.byteAt=function(l){return this.data[this.zero+l]},o.prototype.lastIndexOfSignature=function(l){for(var h=l.charCodeAt(0),u=l.charCodeAt(1),d=l.charCodeAt(2),g=l.charCodeAt(3),y=this.length-4;0<=y;--y)if(this.data[y]===h&&this.data[y+1]===u&&this.data[y+2]===d&&this.data[y+3]===g)return y-this.zero;return-1},o.prototype.readAndCheckSignature=function(l){var h=l.charCodeAt(0),u=l.charCodeAt(1),d=l.charCodeAt(2),g=l.charCodeAt(3),y=this.readData(4);return h===y[0]&&u===y[1]&&d===y[2]&&g===y[3]},o.prototype.readData=function(l){if(this.checkOffset(l),l===0)return[];var h=this.data.slice(this.zero+this.index,this.zero+this.index+l);return this.index+=l,h},i.exports=o},{"../utils":32,"./DataReader":18}],18:[function(e,i,n){var r=e("../utils");function o(l){this.data=l,this.length=l.length,this.index=0,this.zero=0}o.prototype={checkOffset:function(l){this.checkIndex(this.index+l)},checkIndex:function(l){if(this.length<this.zero+l||l<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+l+"). Corrupted zip ?")},setIndex:function(l){this.checkIndex(l),this.index=l},skip:function(l){this.setIndex(this.index+l)},byteAt:function(){},readInt:function(l){var h,u=0;for(this.checkOffset(l),h=this.index+l-1;h>=this.index;h--)u=(u<<8)+this.byteAt(h);return this.index+=l,u},readString:function(l){return r.transformTo("string",this.readData(l))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var l=this.readInt(4);return new Date(Date.UTC(1980+(l>>25&127),(l>>21&15)-1,l>>16&31,l>>11&31,l>>5&63,(31&l)<<1))}},i.exports=o},{"../utils":32}],19:[function(e,i,n){var r=e("./Uint8ArrayReader");function o(l){r.call(this,l)}e("../utils").inherits(o,r),o.prototype.readData=function(l){this.checkOffset(l);var h=this.data.slice(this.zero+this.index,this.zero+this.index+l);return this.index+=l,h},i.exports=o},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,i,n){var r=e("./DataReader");function o(l){r.call(this,l)}e("../utils").inherits(o,r),o.prototype.byteAt=function(l){return this.data.charCodeAt(this.zero+l)},o.prototype.lastIndexOfSignature=function(l){return this.data.lastIndexOf(l)-this.zero},o.prototype.readAndCheckSignature=function(l){return l===this.readData(4)},o.prototype.readData=function(l){this.checkOffset(l);var h=this.data.slice(this.zero+this.index,this.zero+this.index+l);return this.index+=l,h},i.exports=o},{"../utils":32,"./DataReader":18}],21:[function(e,i,n){var r=e("./ArrayReader");function o(l){r.call(this,l)}e("../utils").inherits(o,r),o.prototype.readData=function(l){if(this.checkOffset(l),l===0)return new Uint8Array(0);var h=this.data.subarray(this.zero+this.index,this.zero+this.index+l);return this.index+=l,h},i.exports=o},{"../utils":32,"./ArrayReader":17}],22:[function(e,i,n){var r=e("../utils"),o=e("../support"),l=e("./ArrayReader"),h=e("./StringReader"),u=e("./NodeBufferReader"),d=e("./Uint8ArrayReader");i.exports=function(g){var y=r.getTypeOf(g);return r.checkSupport(y),y!=="string"||o.uint8array?y==="nodebuffer"?new u(g):o.uint8array?new d(r.transformTo("uint8array",g)):new l(r.transformTo("array",g)):new h(g)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,i,n){n.LOCAL_FILE_HEADER="PK",n.CENTRAL_FILE_HEADER="PK",n.CENTRAL_DIRECTORY_END="PK",n.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",n.ZIP64_CENTRAL_DIRECTORY_END="PK",n.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,i,n){var r=e("./GenericWorker"),o=e("../utils");function l(h){r.call(this,"ConvertWorker to "+h),this.destType=h}o.inherits(l,r),l.prototype.processChunk=function(h){this.push({data:o.transformTo(this.destType,h.data),meta:h.meta})},i.exports=l},{"../utils":32,"./GenericWorker":28}],25:[function(e,i,n){var r=e("./GenericWorker"),o=e("../crc32");function l(){r.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(l,r),l.prototype.processChunk=function(h){this.streamInfo.crc32=o(h.data,this.streamInfo.crc32||0),this.push(h)},i.exports=l},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,i,n){var r=e("../utils"),o=e("./GenericWorker");function l(h){o.call(this,"DataLengthProbe for "+h),this.propName=h,this.withStreamInfo(h,0)}r.inherits(l,o),l.prototype.processChunk=function(h){if(h){var u=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=u+h.data.length}o.prototype.processChunk.call(this,h)},i.exports=l},{"../utils":32,"./GenericWorker":28}],27:[function(e,i,n){var r=e("../utils"),o=e("./GenericWorker");function l(h){o.call(this,"DataWorker");var u=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,h.then(function(d){u.dataIsReady=!0,u.data=d,u.max=d&&d.length||0,u.type=r.getTypeOf(d),u.isPaused||u._tickAndRepeat()},function(d){u.error(d)})}r.inherits(l,o),l.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this.data=null},l.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,r.delay(this._tickAndRepeat,[],this)),!0)},l.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(r.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},l.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var h=null,u=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":h=this.data.substring(this.index,u);break;case"uint8array":h=this.data.subarray(this.index,u);break;case"array":case"nodebuffer":h=this.data.slice(this.index,u)}return this.index=u,this.push({data:h,meta:{percent:this.max?this.index/this.max*100:0}})},i.exports=l},{"../utils":32,"./GenericWorker":28}],28:[function(e,i,n){function r(o){this.name=o||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}r.prototype={push:function(o){this.emit("data",o)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(o){this.emit("error",o)}return!0},error:function(o){return!this.isFinished&&(this.isPaused?this.generatedError=o:(this.isFinished=!0,this.emit("error",o),this.previous&&this.previous.error(o),this.cleanUp()),!0)},on:function(o,l){return this._listeners[o].push(l),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(o,l){if(this._listeners[o])for(var h=0;h<this._listeners[o].length;h++)this._listeners[o][h].call(this,l)},pipe:function(o){return o.registerPrevious(this)},registerPrevious:function(o){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=o.streamInfo,this.mergeStreamInfo(),this.previous=o;var l=this;return o.on("data",function(h){l.processChunk(h)}),o.on("end",function(){l.end()}),o.on("error",function(h){l.error(h)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var o=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),o=!0),this.previous&&this.previous.resume(),!o},flush:function(){},processChunk:function(o){this.push(o)},withStreamInfo:function(o,l){return this.extraStreamInfo[o]=l,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var o in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,o)&&(this.streamInfo[o]=this.extraStreamInfo[o])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var o="Worker "+this.name;return this.previous?this.previous+" -> "+o:o}},i.exports=r},{}],29:[function(e,i,n){var r=e("../utils"),o=e("./ConvertWorker"),l=e("./GenericWorker"),h=e("../base64"),u=e("../support"),d=e("../external"),g=null;if(u.nodestream)try{g=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function y(I,b){return new d.Promise(function(x,C){var P=[],k=I._internalType,O=I._outputType,B=I._mimeType;I.on("data",function(j,V){P.push(j),b&&b(V)}).on("error",function(j){P=[],C(j)}).on("end",function(){try{var j=function(V,Y,q){switch(V){case"blob":return r.newBlob(r.transformTo("arraybuffer",Y),q);case"base64":return h.encode(Y);default:return r.transformTo(V,Y)}}(O,function(V,Y){var q,st=0,ft=null,U=0;for(q=0;q<Y.length;q++)U+=Y[q].length;switch(V){case"string":return Y.join("");case"array":return Array.prototype.concat.apply([],Y);case"uint8array":for(ft=new Uint8Array(U),q=0;q<Y.length;q++)ft.set(Y[q],st),st+=Y[q].length;return ft;case"nodebuffer":return Buffer.concat(Y);default:throw new Error("concat : unsupported type '"+V+"'")}}(k,P),B);x(j)}catch(V){C(V)}P=[]}).resume()})}function m(I,b,x){var C=b;switch(b){case"blob":case"arraybuffer":C="uint8array";break;case"base64":C="string"}try{this._internalType=C,this._outputType=b,this._mimeType=x,r.checkSupport(C),this._worker=I.pipe(new o(C)),I.lock()}catch(P){this._worker=new l("error"),this._worker.error(P)}}m.prototype={accumulate:function(I){return y(this,I)},on:function(I,b){var x=this;return I==="data"?this._worker.on(I,function(C){b.call(x,C.data,C.meta)}):this._worker.on(I,function(){r.delay(b,arguments,x)}),this},resume:function(){return r.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(I){if(r.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new g(this,{objectMode:this._outputType!=="nodebuffer"},I)}},i.exports=m},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,i,n){if(n.base64=!0,n.array=!0,n.string=!0,n.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",n.nodebuffer=typeof Buffer<"u",n.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")n.blob=!1;else{var r=new ArrayBuffer(0);try{n.blob=new Blob([r],{type:"application/zip"}).size===0}catch{try{var o=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);o.append(r),n.blob=o.getBlob("application/zip").size===0}catch{n.blob=!1}}}try{n.nodestream=!!e("readable-stream").Readable}catch{n.nodestream=!1}},{"readable-stream":16}],31:[function(e,i,n){for(var r=e("./utils"),o=e("./support"),l=e("./nodejsUtils"),h=e("./stream/GenericWorker"),u=new Array(256),d=0;d<256;d++)u[d]=252<=d?6:248<=d?5:240<=d?4:224<=d?3:192<=d?2:1;u[254]=u[254]=1;function g(){h.call(this,"utf-8 decode"),this.leftOver=null}function y(){h.call(this,"utf-8 encode")}n.utf8encode=function(m){return o.nodebuffer?l.newBufferFrom(m,"utf-8"):function(I){var b,x,C,P,k,O=I.length,B=0;for(P=0;P<O;P++)(64512&(x=I.charCodeAt(P)))==55296&&P+1<O&&(64512&(C=I.charCodeAt(P+1)))==56320&&(x=65536+(x-55296<<10)+(C-56320),P++),B+=x<128?1:x<2048?2:x<65536?3:4;for(b=o.uint8array?new Uint8Array(B):new Array(B),P=k=0;k<B;P++)(64512&(x=I.charCodeAt(P)))==55296&&P+1<O&&(64512&(C=I.charCodeAt(P+1)))==56320&&(x=65536+(x-55296<<10)+(C-56320),P++),x<128?b[k++]=x:(x<2048?b[k++]=192|x>>>6:(x<65536?b[k++]=224|x>>>12:(b[k++]=240|x>>>18,b[k++]=128|x>>>12&63),b[k++]=128|x>>>6&63),b[k++]=128|63&x);return b}(m)},n.utf8decode=function(m){return o.nodebuffer?r.transformTo("nodebuffer",m).toString("utf-8"):function(I){var b,x,C,P,k=I.length,O=new Array(2*k);for(b=x=0;b<k;)if((C=I[b++])<128)O[x++]=C;else if(4<(P=u[C]))O[x++]=65533,b+=P-1;else{for(C&=P===2?31:P===3?15:7;1<P&&b<k;)C=C<<6|63&I[b++],P--;1<P?O[x++]=65533:C<65536?O[x++]=C:(C-=65536,O[x++]=55296|C>>10&1023,O[x++]=56320|1023&C)}return O.length!==x&&(O.subarray?O=O.subarray(0,x):O.length=x),r.applyFromCharCode(O)}(m=r.transformTo(o.uint8array?"uint8array":"array",m))},r.inherits(g,h),g.prototype.processChunk=function(m){var I=r.transformTo(o.uint8array?"uint8array":"array",m.data);if(this.leftOver&&this.leftOver.length){if(o.uint8array){var b=I;(I=new Uint8Array(b.length+this.leftOver.length)).set(this.leftOver,0),I.set(b,this.leftOver.length)}else I=this.leftOver.concat(I);this.leftOver=null}var x=function(P,k){var O;for((k=k||P.length)>P.length&&(k=P.length),O=k-1;0<=O&&(192&P[O])==128;)O--;return O<0||O===0?k:O+u[P[O]]>k?O:k}(I),C=I;x!==I.length&&(o.uint8array?(C=I.subarray(0,x),this.leftOver=I.subarray(x,I.length)):(C=I.slice(0,x),this.leftOver=I.slice(x,I.length))),this.push({data:n.utf8decode(C),meta:m.meta})},g.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:n.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},n.Utf8DecodeWorker=g,r.inherits(y,h),y.prototype.processChunk=function(m){this.push({data:n.utf8encode(m.data),meta:m.meta})},n.Utf8EncodeWorker=y},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,i,n){var r=e("./support"),o=e("./base64"),l=e("./nodejsUtils"),h=e("./external");function u(b){return b}function d(b,x){for(var C=0;C<b.length;++C)x[C]=255&b.charCodeAt(C);return x}e("setimmediate"),n.newBlob=function(b,x){n.checkSupport("blob");try{return new Blob([b],{type:x})}catch{try{var C=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return C.append(b),C.getBlob(x)}catch{throw new Error("Bug : can't construct the Blob.")}}};var g={stringifyByChunk:function(b,x,C){var P=[],k=0,O=b.length;if(O<=C)return String.fromCharCode.apply(null,b);for(;k<O;)x==="array"||x==="nodebuffer"?P.push(String.fromCharCode.apply(null,b.slice(k,Math.min(k+C,O)))):P.push(String.fromCharCode.apply(null,b.subarray(k,Math.min(k+C,O)))),k+=C;return P.join("")},stringifyByChar:function(b){for(var x="",C=0;C<b.length;C++)x+=String.fromCharCode(b[C]);return x},applyCanBeUsed:{uint8array:function(){try{return r.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return r.nodebuffer&&String.fromCharCode.apply(null,l.allocBuffer(1)).length===1}catch{return!1}}()}};function y(b){var x=65536,C=n.getTypeOf(b),P=!0;if(C==="uint8array"?P=g.applyCanBeUsed.uint8array:C==="nodebuffer"&&(P=g.applyCanBeUsed.nodebuffer),P)for(;1<x;)try{return g.stringifyByChunk(b,C,x)}catch{x=Math.floor(x/2)}return g.stringifyByChar(b)}function m(b,x){for(var C=0;C<b.length;C++)x[C]=b[C];return x}n.applyFromCharCode=y;var I={};I.string={string:u,array:function(b){return d(b,new Array(b.length))},arraybuffer:function(b){return I.string.uint8array(b).buffer},uint8array:function(b){return d(b,new Uint8Array(b.length))},nodebuffer:function(b){return d(b,l.allocBuffer(b.length))}},I.array={string:y,array:u,arraybuffer:function(b){return new Uint8Array(b).buffer},uint8array:function(b){return new Uint8Array(b)},nodebuffer:function(b){return l.newBufferFrom(b)}},I.arraybuffer={string:function(b){return y(new Uint8Array(b))},array:function(b){return m(new Uint8Array(b),new Array(b.byteLength))},arraybuffer:u,uint8array:function(b){return new Uint8Array(b)},nodebuffer:function(b){return l.newBufferFrom(new Uint8Array(b))}},I.uint8array={string:y,array:function(b){return m(b,new Array(b.length))},arraybuffer:function(b){return b.buffer},uint8array:u,nodebuffer:function(b){return l.newBufferFrom(b)}},I.nodebuffer={string:y,array:function(b){return m(b,new Array(b.length))},arraybuffer:function(b){return I.nodebuffer.uint8array(b).buffer},uint8array:function(b){return m(b,new Uint8Array(b.length))},nodebuffer:u},n.transformTo=function(b,x){if(x=x||"",!b)return x;n.checkSupport(b);var C=n.getTypeOf(x);return I[C][b](x)},n.resolve=function(b){for(var x=b.split("/"),C=[],P=0;P<x.length;P++){var k=x[P];k==="."||k===""&&P!==0&&P!==x.length-1||(k===".."?C.pop():C.push(k))}return C.join("/")},n.getTypeOf=function(b){return typeof b=="string"?"string":Object.prototype.toString.call(b)==="[object Array]"?"array":r.nodebuffer&&l.isBuffer(b)?"nodebuffer":r.uint8array&&b instanceof Uint8Array?"uint8array":r.arraybuffer&&b instanceof ArrayBuffer?"arraybuffer":void 0},n.checkSupport=function(b){if(!r[b.toLowerCase()])throw new Error(b+" is not supported by this platform")},n.MAX_VALUE_16BITS=65535,n.MAX_VALUE_32BITS=-1,n.pretty=function(b){var x,C,P="";for(C=0;C<(b||"").length;C++)P+="\\x"+((x=b.charCodeAt(C))<16?"0":"")+x.toString(16).toUpperCase();return P},n.delay=function(b,x,C){setImmediate(function(){b.apply(C||null,x||[])})},n.inherits=function(b,x){function C(){}C.prototype=x.prototype,b.prototype=new C},n.extend=function(){var b,x,C={};for(b=0;b<arguments.length;b++)for(x in arguments[b])Object.prototype.hasOwnProperty.call(arguments[b],x)&&C[x]===void 0&&(C[x]=arguments[b][x]);return C},n.prepareContent=function(b,x,C,P,k){return h.Promise.resolve(x).then(function(O){return r.blob&&(O instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(O))!==-1)&&typeof FileReader<"u"?new h.Promise(function(B,j){var V=new FileReader;V.onload=function(Y){B(Y.target.result)},V.onerror=function(Y){j(Y.target.error)},V.readAsArrayBuffer(O)}):O}).then(function(O){var B=n.getTypeOf(O);return B?(B==="arraybuffer"?O=n.transformTo("uint8array",O):B==="string"&&(k?O=o.decode(O):C&&P!==!0&&(O=function(j){return d(j,r.uint8array?new Uint8Array(j.length):new Array(j.length))}(O))),O):h.Promise.reject(new Error("Can't read the data of '"+b+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,i,n){var r=e("./reader/readerFor"),o=e("./utils"),l=e("./signature"),h=e("./zipEntry"),u=e("./support");function d(g){this.files=[],this.loadOptions=g}d.prototype={checkSignature:function(g){if(!this.reader.readAndCheckSignature(g)){this.reader.index-=4;var y=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+o.pretty(y)+", expected "+o.pretty(g)+")")}},isSignature:function(g,y){var m=this.reader.index;this.reader.setIndex(g);var I=this.reader.readString(4)===y;return this.reader.setIndex(m),I},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var g=this.reader.readData(this.zipCommentLength),y=u.uint8array?"uint8array":"array",m=o.transformTo(y,g);this.zipComment=this.loadOptions.decodeFileName(m)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var g,y,m,I=this.zip64EndOfCentralSize-44;0<I;)g=this.reader.readInt(2),y=this.reader.readInt(4),m=this.reader.readData(y),this.zip64ExtensibleData[g]={id:g,length:y,value:m}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var g,y;for(g=0;g<this.files.length;g++)y=this.files[g],this.reader.setIndex(y.localHeaderOffset),this.checkSignature(l.LOCAL_FILE_HEADER),y.readLocalPart(this.reader),y.handleUTF8(),y.processAttributes()},readCentralDir:function(){var g;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(l.CENTRAL_FILE_HEADER);)(g=new h({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(g);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var g=this.reader.lastIndexOfSignature(l.CENTRAL_DIRECTORY_END);if(g<0)throw this.isSignature(0,l.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(g);var y=g;if(this.checkSignature(l.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===o.MAX_VALUE_16BITS||this.diskWithCentralDirStart===o.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===o.MAX_VALUE_16BITS||this.centralDirRecords===o.MAX_VALUE_16BITS||this.centralDirSize===o.MAX_VALUE_32BITS||this.centralDirOffset===o.MAX_VALUE_32BITS){if(this.zip64=!0,(g=this.reader.lastIndexOfSignature(l.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(g),this.checkSignature(l.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,l.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(l.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(l.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var m=this.centralDirOffset+this.centralDirSize;this.zip64&&(m+=20,m+=12+this.zip64EndOfCentralSize);var I=y-m;if(0<I)this.isSignature(y,l.CENTRAL_FILE_HEADER)||(this.reader.zero=I);else if(I<0)throw new Error("Corrupted zip: missing "+Math.abs(I)+" bytes.")},prepareReader:function(g){this.reader=r(g)},load:function(g){this.prepareReader(g),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},i.exports=d},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,i,n){var r=e("./reader/readerFor"),o=e("./utils"),l=e("./compressedObject"),h=e("./crc32"),u=e("./utf8"),d=e("./compressions"),g=e("./support");function y(m,I){this.options=m,this.loadOptions=I}y.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(m){var I,b;if(m.skip(22),this.fileNameLength=m.readInt(2),b=m.readInt(2),this.fileName=m.readData(this.fileNameLength),m.skip(b),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((I=function(x){for(var C in d)if(Object.prototype.hasOwnProperty.call(d,C)&&d[C].magic===x)return d[C];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+o.pretty(this.compressionMethod)+" unknown (inner file : "+o.transformTo("string",this.fileName)+")");this.decompressed=new l(this.compressedSize,this.uncompressedSize,this.crc32,I,m.readData(this.compressedSize))},readCentralPart:function(m){this.versionMadeBy=m.readInt(2),m.skip(2),this.bitFlag=m.readInt(2),this.compressionMethod=m.readString(2),this.date=m.readDate(),this.crc32=m.readInt(4),this.compressedSize=m.readInt(4),this.uncompressedSize=m.readInt(4);var I=m.readInt(2);if(this.extraFieldsLength=m.readInt(2),this.fileCommentLength=m.readInt(2),this.diskNumberStart=m.readInt(2),this.internalFileAttributes=m.readInt(2),this.externalFileAttributes=m.readInt(4),this.localHeaderOffset=m.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");m.skip(I),this.readExtraFields(m),this.parseZIP64ExtraField(m),this.fileComment=m.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var m=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),m==0&&(this.dosPermissions=63&this.externalFileAttributes),m==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var m=r(this.extraFields[1].value);this.uncompressedSize===o.MAX_VALUE_32BITS&&(this.uncompressedSize=m.readInt(8)),this.compressedSize===o.MAX_VALUE_32BITS&&(this.compressedSize=m.readInt(8)),this.localHeaderOffset===o.MAX_VALUE_32BITS&&(this.localHeaderOffset=m.readInt(8)),this.diskNumberStart===o.MAX_VALUE_32BITS&&(this.diskNumberStart=m.readInt(4))}},readExtraFields:function(m){var I,b,x,C=m.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});m.index+4<C;)I=m.readInt(2),b=m.readInt(2),x=m.readData(b),this.extraFields[I]={id:I,length:b,value:x};m.setIndex(C)},handleUTF8:function(){var m=g.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=u.utf8decode(this.fileName),this.fileCommentStr=u.utf8decode(this.fileComment);else{var I=this.findExtraFieldUnicodePath();if(I!==null)this.fileNameStr=I;else{var b=o.transformTo(m,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(b)}var x=this.findExtraFieldUnicodeComment();if(x!==null)this.fileCommentStr=x;else{var C=o.transformTo(m,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(C)}}},findExtraFieldUnicodePath:function(){var m=this.extraFields[28789];if(m){var I=r(m.value);return I.readInt(1)!==1||h(this.fileName)!==I.readInt(4)?null:u.utf8decode(I.readData(m.length-5))}return null},findExtraFieldUnicodeComment:function(){var m=this.extraFields[25461];if(m){var I=r(m.value);return I.readInt(1)!==1||h(this.fileComment)!==I.readInt(4)?null:u.utf8decode(I.readData(m.length-5))}return null}},i.exports=y},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,i,n){function r(I,b,x){this.name=I,this.dir=x.dir,this.date=x.date,this.comment=x.comment,this.unixPermissions=x.unixPermissions,this.dosPermissions=x.dosPermissions,this._data=b,this._dataBinary=x.binary,this.options={compression:x.compression,compressionOptions:x.compressionOptions}}var o=e("./stream/StreamHelper"),l=e("./stream/DataWorker"),h=e("./utf8"),u=e("./compressedObject"),d=e("./stream/GenericWorker");r.prototype={internalStream:function(I){var b=null,x="string";try{if(!I)throw new Error("No output type specified.");var C=(x=I.toLowerCase())==="string"||x==="text";x!=="binarystring"&&x!=="text"||(x="string"),b=this._decompressWorker();var P=!this._dataBinary;P&&!C&&(b=b.pipe(new h.Utf8EncodeWorker)),!P&&C&&(b=b.pipe(new h.Utf8DecodeWorker))}catch(k){(b=new d("error")).error(k)}return new o(b,x,"")},async:function(I,b){return this.internalStream(I).accumulate(b)},nodeStream:function(I,b){return this.internalStream(I||"nodebuffer").toNodejsStream(b)},_compressWorker:function(I,b){if(this._data instanceof u&&this._data.compression.magic===I.magic)return this._data.getCompressedWorker();var x=this._decompressWorker();return this._dataBinary||(x=x.pipe(new h.Utf8EncodeWorker)),u.createWorkerFrom(x,I,b)},_decompressWorker:function(){return this._data instanceof u?this._data.getContentWorker():this._data instanceof d?this._data:new l(this._data)}};for(var g=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],y=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},m=0;m<g.length;m++)r.prototype[g[m]]=y;i.exports=r},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,i,n){(function(r){var o,l,h=r.MutationObserver||r.WebKitMutationObserver;if(h){var u=0,d=new h(I),g=r.document.createTextNode("");d.observe(g,{characterData:!0}),o=function(){g.data=u=++u%2}}else if(r.setImmediate||r.MessageChannel===void 0)o="document"in r&&"onreadystatechange"in r.document.createElement("script")?function(){var b=r.document.createElement("script");b.onreadystatechange=function(){I(),b.onreadystatechange=null,b.parentNode.removeChild(b),b=null},r.document.documentElement.appendChild(b)}:function(){setTimeout(I,0)};else{var y=new r.MessageChannel;y.port1.onmessage=I,o=function(){y.port2.postMessage(0)}}var m=[];function I(){var b,x;l=!0;for(var C=m.length;C;){for(x=m,m=[],b=-1;++b<C;)x[b]();C=m.length}l=!1}i.exports=function(b){m.push(b)!==1||l||o()}}).call(this,typeof ia<"u"?ia:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,i,n){var r=e("immediate");function o(){}var l={},h=["REJECTED"],u=["FULFILLED"],d=["PENDING"];function g(C){if(typeof C!="function")throw new TypeError("resolver must be a function");this.state=d,this.queue=[],this.outcome=void 0,C!==o&&b(this,C)}function y(C,P,k){this.promise=C,typeof P=="function"&&(this.onFulfilled=P,this.callFulfilled=this.otherCallFulfilled),typeof k=="function"&&(this.onRejected=k,this.callRejected=this.otherCallRejected)}function m(C,P,k){r(function(){var O;try{O=P(k)}catch(B){return l.reject(C,B)}O===C?l.reject(C,new TypeError("Cannot resolve promise with itself")):l.resolve(C,O)})}function I(C){var P=C&&C.then;if(C&&(typeof C=="object"||typeof C=="function")&&typeof P=="function")return function(){P.apply(C,arguments)}}function b(C,P){var k=!1;function O(V){k||(k=!0,l.reject(C,V))}function B(V){k||(k=!0,l.resolve(C,V))}var j=x(function(){P(B,O)});j.status==="error"&&O(j.value)}function x(C,P){var k={};try{k.value=C(P),k.status="success"}catch(O){k.status="error",k.value=O}return k}(i.exports=g).prototype.finally=function(C){if(typeof C!="function")return this;var P=this.constructor;return this.then(function(k){return P.resolve(C()).then(function(){return k})},function(k){return P.resolve(C()).then(function(){throw k})})},g.prototype.catch=function(C){return this.then(null,C)},g.prototype.then=function(C,P){if(typeof C!="function"&&this.state===u||typeof P!="function"&&this.state===h)return this;var k=new this.constructor(o);return this.state!==d?m(k,this.state===u?C:P,this.outcome):this.queue.push(new y(k,C,P)),k},y.prototype.callFulfilled=function(C){l.resolve(this.promise,C)},y.prototype.otherCallFulfilled=function(C){m(this.promise,this.onFulfilled,C)},y.prototype.callRejected=function(C){l.reject(this.promise,C)},y.prototype.otherCallRejected=function(C){m(this.promise,this.onRejected,C)},l.resolve=function(C,P){var k=x(I,P);if(k.status==="error")return l.reject(C,k.value);var O=k.value;if(O)b(C,O);else{C.state=u,C.outcome=P;for(var B=-1,j=C.queue.length;++B<j;)C.queue[B].callFulfilled(P)}return C},l.reject=function(C,P){C.state=h,C.outcome=P;for(var k=-1,O=C.queue.length;++k<O;)C.queue[k].callRejected(P);return C},g.resolve=function(C){return C instanceof this?C:l.resolve(new this(o),C)},g.reject=function(C){var P=new this(o);return l.reject(P,C)},g.all=function(C){var P=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=C.length,O=!1;if(!k)return this.resolve([]);for(var B=new Array(k),j=0,V=-1,Y=new this(o);++V<k;)q(C[V],V);return Y;function q(st,ft){P.resolve(st).then(function(U){B[ft]=U,++j!==k||O||(O=!0,l.resolve(Y,B))},function(U){O||(O=!0,l.reject(Y,U))})}},g.race=function(C){var P=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var k=C.length,O=!1;if(!k)return this.resolve([]);for(var B=-1,j=new this(o);++B<k;)V=C[B],P.resolve(V).then(function(Y){O||(O=!0,l.resolve(j,Y))},function(Y){O||(O=!0,l.reject(j,Y))});var V;return j}},{immediate:36}],38:[function(e,i,n){var r={};(0,e("./lib/utils/common").assign)(r,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),i.exports=r},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,i,n){var r=e("./zlib/deflate"),o=e("./utils/common"),l=e("./utils/strings"),h=e("./zlib/messages"),u=e("./zlib/zstream"),d=Object.prototype.toString,g=0,y=-1,m=0,I=8;function b(C){if(!(this instanceof b))return new b(C);this.options=o.assign({level:y,method:I,chunkSize:16384,windowBits:15,memLevel:8,strategy:m,to:""},C||{});var P=this.options;P.raw&&0<P.windowBits?P.windowBits=-P.windowBits:P.gzip&&0<P.windowBits&&P.windowBits<16&&(P.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var k=r.deflateInit2(this.strm,P.level,P.method,P.windowBits,P.memLevel,P.strategy);if(k!==g)throw new Error(h[k]);if(P.header&&r.deflateSetHeader(this.strm,P.header),P.dictionary){var O;if(O=typeof P.dictionary=="string"?l.string2buf(P.dictionary):d.call(P.dictionary)==="[object ArrayBuffer]"?new Uint8Array(P.dictionary):P.dictionary,(k=r.deflateSetDictionary(this.strm,O))!==g)throw new Error(h[k]);this._dict_set=!0}}function x(C,P){var k=new b(P);if(k.push(C,!0),k.err)throw k.msg||h[k.err];return k.result}b.prototype.push=function(C,P){var k,O,B=this.strm,j=this.options.chunkSize;if(this.ended)return!1;O=P===~~P?P:P===!0?4:0,typeof C=="string"?B.input=l.string2buf(C):d.call(C)==="[object ArrayBuffer]"?B.input=new Uint8Array(C):B.input=C,B.next_in=0,B.avail_in=B.input.length;do{if(B.avail_out===0&&(B.output=new o.Buf8(j),B.next_out=0,B.avail_out=j),(k=r.deflate(B,O))!==1&&k!==g)return this.onEnd(k),!(this.ended=!0);B.avail_out!==0&&(B.avail_in!==0||O!==4&&O!==2)||(this.options.to==="string"?this.onData(l.buf2binstring(o.shrinkBuf(B.output,B.next_out))):this.onData(o.shrinkBuf(B.output,B.next_out)))}while((0<B.avail_in||B.avail_out===0)&&k!==1);return O===4?(k=r.deflateEnd(this.strm),this.onEnd(k),this.ended=!0,k===g):O!==2||(this.onEnd(g),!(B.avail_out=0))},b.prototype.onData=function(C){this.chunks.push(C)},b.prototype.onEnd=function(C){C===g&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=o.flattenChunks(this.chunks)),this.chunks=[],this.err=C,this.msg=this.strm.msg},n.Deflate=b,n.deflate=x,n.deflateRaw=function(C,P){return(P=P||{}).raw=!0,x(C,P)},n.gzip=function(C,P){return(P=P||{}).gzip=!0,x(C,P)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,i,n){var r=e("./zlib/inflate"),o=e("./utils/common"),l=e("./utils/strings"),h=e("./zlib/constants"),u=e("./zlib/messages"),d=e("./zlib/zstream"),g=e("./zlib/gzheader"),y=Object.prototype.toString;function m(b){if(!(this instanceof m))return new m(b);this.options=o.assign({chunkSize:16384,windowBits:0,to:""},b||{});var x=this.options;x.raw&&0<=x.windowBits&&x.windowBits<16&&(x.windowBits=-x.windowBits,x.windowBits===0&&(x.windowBits=-15)),!(0<=x.windowBits&&x.windowBits<16)||b&&b.windowBits||(x.windowBits+=32),15<x.windowBits&&x.windowBits<48&&!(15&x.windowBits)&&(x.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new d,this.strm.avail_out=0;var C=r.inflateInit2(this.strm,x.windowBits);if(C!==h.Z_OK)throw new Error(u[C]);this.header=new g,r.inflateGetHeader(this.strm,this.header)}function I(b,x){var C=new m(x);if(C.push(b,!0),C.err)throw C.msg||u[C.err];return C.result}m.prototype.push=function(b,x){var C,P,k,O,B,j,V=this.strm,Y=this.options.chunkSize,q=this.options.dictionary,st=!1;if(this.ended)return!1;P=x===~~x?x:x===!0?h.Z_FINISH:h.Z_NO_FLUSH,typeof b=="string"?V.input=l.binstring2buf(b):y.call(b)==="[object ArrayBuffer]"?V.input=new Uint8Array(b):V.input=b,V.next_in=0,V.avail_in=V.input.length;do{if(V.avail_out===0&&(V.output=new o.Buf8(Y),V.next_out=0,V.avail_out=Y),(C=r.inflate(V,h.Z_NO_FLUSH))===h.Z_NEED_DICT&&q&&(j=typeof q=="string"?l.string2buf(q):y.call(q)==="[object ArrayBuffer]"?new Uint8Array(q):q,C=r.inflateSetDictionary(this.strm,j)),C===h.Z_BUF_ERROR&&st===!0&&(C=h.Z_OK,st=!1),C!==h.Z_STREAM_END&&C!==h.Z_OK)return this.onEnd(C),!(this.ended=!0);V.next_out&&(V.avail_out!==0&&C!==h.Z_STREAM_END&&(V.avail_in!==0||P!==h.Z_FINISH&&P!==h.Z_SYNC_FLUSH)||(this.options.to==="string"?(k=l.utf8border(V.output,V.next_out),O=V.next_out-k,B=l.buf2string(V.output,k),V.next_out=O,V.avail_out=Y-O,O&&o.arraySet(V.output,V.output,k,O,0),this.onData(B)):this.onData(o.shrinkBuf(V.output,V.next_out)))),V.avail_in===0&&V.avail_out===0&&(st=!0)}while((0<V.avail_in||V.avail_out===0)&&C!==h.Z_STREAM_END);return C===h.Z_STREAM_END&&(P=h.Z_FINISH),P===h.Z_FINISH?(C=r.inflateEnd(this.strm),this.onEnd(C),this.ended=!0,C===h.Z_OK):P!==h.Z_SYNC_FLUSH||(this.onEnd(h.Z_OK),!(V.avail_out=0))},m.prototype.onData=function(b){this.chunks.push(b)},m.prototype.onEnd=function(b){b===h.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=o.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},n.Inflate=m,n.inflate=I,n.inflateRaw=function(b,x){return(x=x||{}).raw=!0,I(b,x)},n.ungzip=I},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,i,n){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";n.assign=function(h){for(var u=Array.prototype.slice.call(arguments,1);u.length;){var d=u.shift();if(d){if(typeof d!="object")throw new TypeError(d+"must be non-object");for(var g in d)d.hasOwnProperty(g)&&(h[g]=d[g])}}return h},n.shrinkBuf=function(h,u){return h.length===u?h:h.subarray?h.subarray(0,u):(h.length=u,h)};var o={arraySet:function(h,u,d,g,y){if(u.subarray&&h.subarray)h.set(u.subarray(d,d+g),y);else for(var m=0;m<g;m++)h[y+m]=u[d+m]},flattenChunks:function(h){var u,d,g,y,m,I;for(u=g=0,d=h.length;u<d;u++)g+=h[u].length;for(I=new Uint8Array(g),u=y=0,d=h.length;u<d;u++)m=h[u],I.set(m,y),y+=m.length;return I}},l={arraySet:function(h,u,d,g,y){for(var m=0;m<g;m++)h[y+m]=u[d+m]},flattenChunks:function(h){return[].concat.apply([],h)}};n.setTyped=function(h){h?(n.Buf8=Uint8Array,n.Buf16=Uint16Array,n.Buf32=Int32Array,n.assign(n,o)):(n.Buf8=Array,n.Buf16=Array,n.Buf32=Array,n.assign(n,l))},n.setTyped(r)},{}],42:[function(e,i,n){var r=e("./common"),o=!0,l=!0;try{String.fromCharCode.apply(null,[0])}catch{o=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{l=!1}for(var h=new r.Buf8(256),u=0;u<256;u++)h[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;function d(g,y){if(y<65537&&(g.subarray&&l||!g.subarray&&o))return String.fromCharCode.apply(null,r.shrinkBuf(g,y));for(var m="",I=0;I<y;I++)m+=String.fromCharCode(g[I]);return m}h[254]=h[254]=1,n.string2buf=function(g){var y,m,I,b,x,C=g.length,P=0;for(b=0;b<C;b++)(64512&(m=g.charCodeAt(b)))==55296&&b+1<C&&(64512&(I=g.charCodeAt(b+1)))==56320&&(m=65536+(m-55296<<10)+(I-56320),b++),P+=m<128?1:m<2048?2:m<65536?3:4;for(y=new r.Buf8(P),b=x=0;x<P;b++)(64512&(m=g.charCodeAt(b)))==55296&&b+1<C&&(64512&(I=g.charCodeAt(b+1)))==56320&&(m=65536+(m-55296<<10)+(I-56320),b++),m<128?y[x++]=m:(m<2048?y[x++]=192|m>>>6:(m<65536?y[x++]=224|m>>>12:(y[x++]=240|m>>>18,y[x++]=128|m>>>12&63),y[x++]=128|m>>>6&63),y[x++]=128|63&m);return y},n.buf2binstring=function(g){return d(g,g.length)},n.binstring2buf=function(g){for(var y=new r.Buf8(g.length),m=0,I=y.length;m<I;m++)y[m]=g.charCodeAt(m);return y},n.buf2string=function(g,y){var m,I,b,x,C=y||g.length,P=new Array(2*C);for(m=I=0;m<C;)if((b=g[m++])<128)P[I++]=b;else if(4<(x=h[b]))P[I++]=65533,m+=x-1;else{for(b&=x===2?31:x===3?15:7;1<x&&m<C;)b=b<<6|63&g[m++],x--;1<x?P[I++]=65533:b<65536?P[I++]=b:(b-=65536,P[I++]=55296|b>>10&1023,P[I++]=56320|1023&b)}return d(P,I)},n.utf8border=function(g,y){var m;for((y=y||g.length)>g.length&&(y=g.length),m=y-1;0<=m&&(192&g[m])==128;)m--;return m<0||m===0?y:m+h[g[m]]>y?m:y}},{"./common":41}],43:[function(e,i,n){i.exports=function(r,o,l,h){for(var u=65535&r|0,d=r>>>16&65535|0,g=0;l!==0;){for(l-=g=2e3<l?2e3:l;d=d+(u=u+o[h++]|0)|0,--g;);u%=65521,d%=65521}return u|d<<16|0}},{}],44:[function(e,i,n){i.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,i,n){var r=function(){for(var o,l=[],h=0;h<256;h++){o=h;for(var u=0;u<8;u++)o=1&o?3988292384^o>>>1:o>>>1;l[h]=o}return l}();i.exports=function(o,l,h,u){var d=r,g=u+h;o^=-1;for(var y=u;y<g;y++)o=o>>>8^d[255&(o^l[y])];return-1^o}},{}],46:[function(e,i,n){var r,o=e("../utils/common"),l=e("./trees"),h=e("./adler32"),u=e("./crc32"),d=e("./messages"),g=0,y=4,m=0,I=-2,b=-1,x=4,C=2,P=8,k=9,O=286,B=30,j=19,V=2*O+1,Y=15,q=3,st=258,ft=st+q+1,U=42,J=113,A=1,R=2,bt=3,z=4;function Pt(T,yt){return T.msg=d[yt],yt}function X(T){return(T<<1)-(4<T?9:0)}function Tt(T){for(var yt=T.length;0<=--yt;)T[yt]=0}function lt(T){var yt=T.state,gt=yt.pending;gt>T.avail_out&&(gt=T.avail_out),gt!==0&&(o.arraySet(T.output,yt.pending_buf,yt.pending_out,gt,T.next_out),T.next_out+=gt,yt.pending_out+=gt,T.total_out+=gt,T.avail_out-=gt,yt.pending-=gt,yt.pending===0&&(yt.pending_out=0))}function at(T,yt){l._tr_flush_block(T,0<=T.block_start?T.block_start:-1,T.strstart-T.block_start,yt),T.block_start=T.strstart,lt(T.strm)}function Gt(T,yt){T.pending_buf[T.pending++]=yt}function kt(T,yt){T.pending_buf[T.pending++]=yt>>>8&255,T.pending_buf[T.pending++]=255&yt}function Ft(T,yt){var gt,$,W=T.max_chain_length,nt=T.strstart,It=T.prev_length,St=T.nice_match,ot=T.strstart>T.w_size-ft?T.strstart-(T.w_size-ft):0,xt=T.window,Lt=T.w_mask,Ot=T.prev,Ut=T.strstart+st,Ge=xt[nt+It-1],we=xt[nt+It];T.prev_length>=T.good_match&&(W>>=2),St>T.lookahead&&(St=T.lookahead);do if(xt[(gt=yt)+It]===we&&xt[gt+It-1]===Ge&&xt[gt]===xt[nt]&&xt[++gt]===xt[nt+1]){nt+=2,gt++;do;while(xt[++nt]===xt[++gt]&&xt[++nt]===xt[++gt]&&xt[++nt]===xt[++gt]&&xt[++nt]===xt[++gt]&&xt[++nt]===xt[++gt]&&xt[++nt]===xt[++gt]&&xt[++nt]===xt[++gt]&&xt[++nt]===xt[++gt]&&nt<Ut);if($=st-(Ut-nt),nt=Ut-st,It<$){if(T.match_start=yt,St<=(It=$))break;Ge=xt[nt+It-1],we=xt[nt+It]}}while((yt=Ot[yt&Lt])>ot&&--W!=0);return It<=T.lookahead?It:T.lookahead}function ni(T){var yt,gt,$,W,nt,It,St,ot,xt,Lt,Ot=T.w_size;do{if(W=T.window_size-T.lookahead-T.strstart,T.strstart>=Ot+(Ot-ft)){for(o.arraySet(T.window,T.window,Ot,Ot,0),T.match_start-=Ot,T.strstart-=Ot,T.block_start-=Ot,yt=gt=T.hash_size;$=T.head[--yt],T.head[yt]=Ot<=$?$-Ot:0,--gt;);for(yt=gt=Ot;$=T.prev[--yt],T.prev[yt]=Ot<=$?$-Ot:0,--gt;);W+=Ot}if(T.strm.avail_in===0)break;if(It=T.strm,St=T.window,ot=T.strstart+T.lookahead,xt=W,Lt=void 0,Lt=It.avail_in,xt<Lt&&(Lt=xt),gt=Lt===0?0:(It.avail_in-=Lt,o.arraySet(St,It.input,It.next_in,Lt,ot),It.state.wrap===1?It.adler=h(It.adler,St,Lt,ot):It.state.wrap===2&&(It.adler=u(It.adler,St,Lt,ot)),It.next_in+=Lt,It.total_in+=Lt,Lt),T.lookahead+=gt,T.lookahead+T.insert>=q)for(nt=T.strstart-T.insert,T.ins_h=T.window[nt],T.ins_h=(T.ins_h<<T.hash_shift^T.window[nt+1])&T.hash_mask;T.insert&&(T.ins_h=(T.ins_h<<T.hash_shift^T.window[nt+q-1])&T.hash_mask,T.prev[nt&T.w_mask]=T.head[T.ins_h],T.head[T.ins_h]=nt,nt++,T.insert--,!(T.lookahead+T.insert<q)););}while(T.lookahead<ft&&T.strm.avail_in!==0)}function ji(T,yt){for(var gt,$;;){if(T.lookahead<ft){if(ni(T),T.lookahead<ft&&yt===g)return A;if(T.lookahead===0)break}if(gt=0,T.lookahead>=q&&(T.ins_h=(T.ins_h<<T.hash_shift^T.window[T.strstart+q-1])&T.hash_mask,gt=T.prev[T.strstart&T.w_mask]=T.head[T.ins_h],T.head[T.ins_h]=T.strstart),gt!==0&&T.strstart-gt<=T.w_size-ft&&(T.match_length=Ft(T,gt)),T.match_length>=q)if($=l._tr_tally(T,T.strstart-T.match_start,T.match_length-q),T.lookahead-=T.match_length,T.match_length<=T.max_lazy_match&&T.lookahead>=q){for(T.match_length--;T.strstart++,T.ins_h=(T.ins_h<<T.hash_shift^T.window[T.strstart+q-1])&T.hash_mask,gt=T.prev[T.strstart&T.w_mask]=T.head[T.ins_h],T.head[T.ins_h]=T.strstart,--T.match_length!=0;);T.strstart++}else T.strstart+=T.match_length,T.match_length=0,T.ins_h=T.window[T.strstart],T.ins_h=(T.ins_h<<T.hash_shift^T.window[T.strstart+1])&T.hash_mask;else $=l._tr_tally(T,0,T.window[T.strstart]),T.lookahead--,T.strstart++;if($&&(at(T,!1),T.strm.avail_out===0))return A}return T.insert=T.strstart<q-1?T.strstart:q-1,yt===y?(at(T,!0),T.strm.avail_out===0?bt:z):T.last_lit&&(at(T,!1),T.strm.avail_out===0)?A:R}function oe(T,yt){for(var gt,$,W;;){if(T.lookahead<ft){if(ni(T),T.lookahead<ft&&yt===g)return A;if(T.lookahead===0)break}if(gt=0,T.lookahead>=q&&(T.ins_h=(T.ins_h<<T.hash_shift^T.window[T.strstart+q-1])&T.hash_mask,gt=T.prev[T.strstart&T.w_mask]=T.head[T.ins_h],T.head[T.ins_h]=T.strstart),T.prev_length=T.match_length,T.prev_match=T.match_start,T.match_length=q-1,gt!==0&&T.prev_length<T.max_lazy_match&&T.strstart-gt<=T.w_size-ft&&(T.match_length=Ft(T,gt),T.match_length<=5&&(T.strategy===1||T.match_length===q&&4096<T.strstart-T.match_start)&&(T.match_length=q-1)),T.prev_length>=q&&T.match_length<=T.prev_length){for(W=T.strstart+T.lookahead-q,$=l._tr_tally(T,T.strstart-1-T.prev_match,T.prev_length-q),T.lookahead-=T.prev_length-1,T.prev_length-=2;++T.strstart<=W&&(T.ins_h=(T.ins_h<<T.hash_shift^T.window[T.strstart+q-1])&T.hash_mask,gt=T.prev[T.strstart&T.w_mask]=T.head[T.ins_h],T.head[T.ins_h]=T.strstart),--T.prev_length!=0;);if(T.match_available=0,T.match_length=q-1,T.strstart++,$&&(at(T,!1),T.strm.avail_out===0))return A}else if(T.match_available){if(($=l._tr_tally(T,0,T.window[T.strstart-1]))&&at(T,!1),T.strstart++,T.lookahead--,T.strm.avail_out===0)return A}else T.match_available=1,T.strstart++,T.lookahead--}return T.match_available&&($=l._tr_tally(T,0,T.window[T.strstart-1]),T.match_available=0),T.insert=T.strstart<q-1?T.strstart:q-1,yt===y?(at(T,!0),T.strm.avail_out===0?bt:z):T.last_lit&&(at(T,!1),T.strm.avail_out===0)?A:R}function Se(T,yt,gt,$,W){this.good_length=T,this.max_lazy=yt,this.nice_length=gt,this.max_chain=$,this.func=W}function We(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=P,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new o.Buf16(2*V),this.dyn_dtree=new o.Buf16(2*(2*B+1)),this.bl_tree=new o.Buf16(2*(2*j+1)),Tt(this.dyn_ltree),Tt(this.dyn_dtree),Tt(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new o.Buf16(Y+1),this.heap=new o.Buf16(2*O+1),Tt(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new o.Buf16(2*O+1),Tt(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ve(T){var yt;return T&&T.state?(T.total_in=T.total_out=0,T.data_type=C,(yt=T.state).pending=0,yt.pending_out=0,yt.wrap<0&&(yt.wrap=-yt.wrap),yt.status=yt.wrap?U:J,T.adler=yt.wrap===2?0:1,yt.last_flush=g,l._tr_init(yt),m):Pt(T,I)}function Le(T){var yt=Ve(T);return yt===m&&function(gt){gt.window_size=2*gt.w_size,Tt(gt.head),gt.max_lazy_match=r[gt.level].max_lazy,gt.good_match=r[gt.level].good_length,gt.nice_match=r[gt.level].nice_length,gt.max_chain_length=r[gt.level].max_chain,gt.strstart=0,gt.block_start=0,gt.lookahead=0,gt.insert=0,gt.match_length=gt.prev_length=q-1,gt.match_available=0,gt.ins_h=0}(T.state),yt}function yn(T,yt,gt,$,W,nt){if(!T)return I;var It=1;if(yt===b&&(yt=6),$<0?(It=0,$=-$):15<$&&(It=2,$-=16),W<1||k<W||gt!==P||$<8||15<$||yt<0||9<yt||nt<0||x<nt)return Pt(T,I);$===8&&($=9);var St=new We;return(T.state=St).strm=T,St.wrap=It,St.gzhead=null,St.w_bits=$,St.w_size=1<<St.w_bits,St.w_mask=St.w_size-1,St.hash_bits=W+7,St.hash_size=1<<St.hash_bits,St.hash_mask=St.hash_size-1,St.hash_shift=~~((St.hash_bits+q-1)/q),St.window=new o.Buf8(2*St.w_size),St.head=new o.Buf16(St.hash_size),St.prev=new o.Buf16(St.w_size),St.lit_bufsize=1<<W+6,St.pending_buf_size=4*St.lit_bufsize,St.pending_buf=new o.Buf8(St.pending_buf_size),St.d_buf=1*St.lit_bufsize,St.l_buf=3*St.lit_bufsize,St.level=yt,St.strategy=nt,St.method=gt,Le(T)}r=[new Se(0,0,0,0,function(T,yt){var gt=65535;for(gt>T.pending_buf_size-5&&(gt=T.pending_buf_size-5);;){if(T.lookahead<=1){if(ni(T),T.lookahead===0&&yt===g)return A;if(T.lookahead===0)break}T.strstart+=T.lookahead,T.lookahead=0;var $=T.block_start+gt;if((T.strstart===0||T.strstart>=$)&&(T.lookahead=T.strstart-$,T.strstart=$,at(T,!1),T.strm.avail_out===0)||T.strstart-T.block_start>=T.w_size-ft&&(at(T,!1),T.strm.avail_out===0))return A}return T.insert=0,yt===y?(at(T,!0),T.strm.avail_out===0?bt:z):(T.strstart>T.block_start&&(at(T,!1),T.strm.avail_out),A)}),new Se(4,4,8,4,ji),new Se(4,5,16,8,ji),new Se(4,6,32,32,ji),new Se(4,4,16,16,oe),new Se(8,16,32,32,oe),new Se(8,16,128,128,oe),new Se(8,32,128,256,oe),new Se(32,128,258,1024,oe),new Se(32,258,258,4096,oe)],n.deflateInit=function(T,yt){return yn(T,yt,P,15,8,0)},n.deflateInit2=yn,n.deflateReset=Le,n.deflateResetKeep=Ve,n.deflateSetHeader=function(T,yt){return T&&T.state?T.state.wrap!==2?I:(T.state.gzhead=yt,m):I},n.deflate=function(T,yt){var gt,$,W,nt;if(!T||!T.state||5<yt||yt<0)return T?Pt(T,I):I;if($=T.state,!T.output||!T.input&&T.avail_in!==0||$.status===666&&yt!==y)return Pt(T,T.avail_out===0?-5:I);if($.strm=T,gt=$.last_flush,$.last_flush=yt,$.status===U)if($.wrap===2)T.adler=0,Gt($,31),Gt($,139),Gt($,8),$.gzhead?(Gt($,($.gzhead.text?1:0)+($.gzhead.hcrc?2:0)+($.gzhead.extra?4:0)+($.gzhead.name?8:0)+($.gzhead.comment?16:0)),Gt($,255&$.gzhead.time),Gt($,$.gzhead.time>>8&255),Gt($,$.gzhead.time>>16&255),Gt($,$.gzhead.time>>24&255),Gt($,$.level===9?2:2<=$.strategy||$.level<2?4:0),Gt($,255&$.gzhead.os),$.gzhead.extra&&$.gzhead.extra.length&&(Gt($,255&$.gzhead.extra.length),Gt($,$.gzhead.extra.length>>8&255)),$.gzhead.hcrc&&(T.adler=u(T.adler,$.pending_buf,$.pending,0)),$.gzindex=0,$.status=69):(Gt($,0),Gt($,0),Gt($,0),Gt($,0),Gt($,0),Gt($,$.level===9?2:2<=$.strategy||$.level<2?4:0),Gt($,3),$.status=J);else{var It=P+($.w_bits-8<<4)<<8;It|=(2<=$.strategy||$.level<2?0:$.level<6?1:$.level===6?2:3)<<6,$.strstart!==0&&(It|=32),It+=31-It%31,$.status=J,kt($,It),$.strstart!==0&&(kt($,T.adler>>>16),kt($,65535&T.adler)),T.adler=1}if($.status===69)if($.gzhead.extra){for(W=$.pending;$.gzindex<(65535&$.gzhead.extra.length)&&($.pending!==$.pending_buf_size||($.gzhead.hcrc&&$.pending>W&&(T.adler=u(T.adler,$.pending_buf,$.pending-W,W)),lt(T),W=$.pending,$.pending!==$.pending_buf_size));)Gt($,255&$.gzhead.extra[$.gzindex]),$.gzindex++;$.gzhead.hcrc&&$.pending>W&&(T.adler=u(T.adler,$.pending_buf,$.pending-W,W)),$.gzindex===$.gzhead.extra.length&&($.gzindex=0,$.status=73)}else $.status=73;if($.status===73)if($.gzhead.name){W=$.pending;do{if($.pending===$.pending_buf_size&&($.gzhead.hcrc&&$.pending>W&&(T.adler=u(T.adler,$.pending_buf,$.pending-W,W)),lt(T),W=$.pending,$.pending===$.pending_buf_size)){nt=1;break}nt=$.gzindex<$.gzhead.name.length?255&$.gzhead.name.charCodeAt($.gzindex++):0,Gt($,nt)}while(nt!==0);$.gzhead.hcrc&&$.pending>W&&(T.adler=u(T.adler,$.pending_buf,$.pending-W,W)),nt===0&&($.gzindex=0,$.status=91)}else $.status=91;if($.status===91)if($.gzhead.comment){W=$.pending;do{if($.pending===$.pending_buf_size&&($.gzhead.hcrc&&$.pending>W&&(T.adler=u(T.adler,$.pending_buf,$.pending-W,W)),lt(T),W=$.pending,$.pending===$.pending_buf_size)){nt=1;break}nt=$.gzindex<$.gzhead.comment.length?255&$.gzhead.comment.charCodeAt($.gzindex++):0,Gt($,nt)}while(nt!==0);$.gzhead.hcrc&&$.pending>W&&(T.adler=u(T.adler,$.pending_buf,$.pending-W,W)),nt===0&&($.status=103)}else $.status=103;if($.status===103&&($.gzhead.hcrc?($.pending+2>$.pending_buf_size&&lt(T),$.pending+2<=$.pending_buf_size&&(Gt($,255&T.adler),Gt($,T.adler>>8&255),T.adler=0,$.status=J)):$.status=J),$.pending!==0){if(lt(T),T.avail_out===0)return $.last_flush=-1,m}else if(T.avail_in===0&&X(yt)<=X(gt)&&yt!==y)return Pt(T,-5);if($.status===666&&T.avail_in!==0)return Pt(T,-5);if(T.avail_in!==0||$.lookahead!==0||yt!==g&&$.status!==666){var St=$.strategy===2?function(ot,xt){for(var Lt;;){if(ot.lookahead===0&&(ni(ot),ot.lookahead===0)){if(xt===g)return A;break}if(ot.match_length=0,Lt=l._tr_tally(ot,0,ot.window[ot.strstart]),ot.lookahead--,ot.strstart++,Lt&&(at(ot,!1),ot.strm.avail_out===0))return A}return ot.insert=0,xt===y?(at(ot,!0),ot.strm.avail_out===0?bt:z):ot.last_lit&&(at(ot,!1),ot.strm.avail_out===0)?A:R}($,yt):$.strategy===3?function(ot,xt){for(var Lt,Ot,Ut,Ge,we=ot.window;;){if(ot.lookahead<=st){if(ni(ot),ot.lookahead<=st&&xt===g)return A;if(ot.lookahead===0)break}if(ot.match_length=0,ot.lookahead>=q&&0<ot.strstart&&(Ot=we[Ut=ot.strstart-1])===we[++Ut]&&Ot===we[++Ut]&&Ot===we[++Ut]){Ge=ot.strstart+st;do;while(Ot===we[++Ut]&&Ot===we[++Ut]&&Ot===we[++Ut]&&Ot===we[++Ut]&&Ot===we[++Ut]&&Ot===we[++Ut]&&Ot===we[++Ut]&&Ot===we[++Ut]&&Ut<Ge);ot.match_length=st-(Ge-Ut),ot.match_length>ot.lookahead&&(ot.match_length=ot.lookahead)}if(ot.match_length>=q?(Lt=l._tr_tally(ot,1,ot.match_length-q),ot.lookahead-=ot.match_length,ot.strstart+=ot.match_length,ot.match_length=0):(Lt=l._tr_tally(ot,0,ot.window[ot.strstart]),ot.lookahead--,ot.strstart++),Lt&&(at(ot,!1),ot.strm.avail_out===0))return A}return ot.insert=0,xt===y?(at(ot,!0),ot.strm.avail_out===0?bt:z):ot.last_lit&&(at(ot,!1),ot.strm.avail_out===0)?A:R}($,yt):r[$.level].func($,yt);if(St!==bt&&St!==z||($.status=666),St===A||St===bt)return T.avail_out===0&&($.last_flush=-1),m;if(St===R&&(yt===1?l._tr_align($):yt!==5&&(l._tr_stored_block($,0,0,!1),yt===3&&(Tt($.head),$.lookahead===0&&($.strstart=0,$.block_start=0,$.insert=0))),lt(T),T.avail_out===0))return $.last_flush=-1,m}return yt!==y?m:$.wrap<=0?1:($.wrap===2?(Gt($,255&T.adler),Gt($,T.adler>>8&255),Gt($,T.adler>>16&255),Gt($,T.adler>>24&255),Gt($,255&T.total_in),Gt($,T.total_in>>8&255),Gt($,T.total_in>>16&255),Gt($,T.total_in>>24&255)):(kt($,T.adler>>>16),kt($,65535&T.adler)),lt(T),0<$.wrap&&($.wrap=-$.wrap),$.pending!==0?m:1)},n.deflateEnd=function(T){var yt;return T&&T.state?(yt=T.state.status)!==U&&yt!==69&&yt!==73&&yt!==91&&yt!==103&&yt!==J&&yt!==666?Pt(T,I):(T.state=null,yt===J?Pt(T,-3):m):I},n.deflateSetDictionary=function(T,yt){var gt,$,W,nt,It,St,ot,xt,Lt=yt.length;if(!T||!T.state||(nt=(gt=T.state).wrap)===2||nt===1&&gt.status!==U||gt.lookahead)return I;for(nt===1&&(T.adler=h(T.adler,yt,Lt,0)),gt.wrap=0,Lt>=gt.w_size&&(nt===0&&(Tt(gt.head),gt.strstart=0,gt.block_start=0,gt.insert=0),xt=new o.Buf8(gt.w_size),o.arraySet(xt,yt,Lt-gt.w_size,gt.w_size,0),yt=xt,Lt=gt.w_size),It=T.avail_in,St=T.next_in,ot=T.input,T.avail_in=Lt,T.next_in=0,T.input=yt,ni(gt);gt.lookahead>=q;){for($=gt.strstart,W=gt.lookahead-(q-1);gt.ins_h=(gt.ins_h<<gt.hash_shift^gt.window[$+q-1])&gt.hash_mask,gt.prev[$&gt.w_mask]=gt.head[gt.ins_h],gt.head[gt.ins_h]=$,$++,--W;);gt.strstart=$,gt.lookahead=q-1,ni(gt)}return gt.strstart+=gt.lookahead,gt.block_start=gt.strstart,gt.insert=gt.lookahead,gt.lookahead=0,gt.match_length=gt.prev_length=q-1,gt.match_available=0,T.next_in=St,T.input=ot,T.avail_in=It,gt.wrap=nt,m},n.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,i,n){i.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,i,n){i.exports=function(r,o){var l,h,u,d,g,y,m,I,b,x,C,P,k,O,B,j,V,Y,q,st,ft,U,J,A,R;l=r.state,h=r.next_in,A=r.input,u=h+(r.avail_in-5),d=r.next_out,R=r.output,g=d-(o-r.avail_out),y=d+(r.avail_out-257),m=l.dmax,I=l.wsize,b=l.whave,x=l.wnext,C=l.window,P=l.hold,k=l.bits,O=l.lencode,B=l.distcode,j=(1<<l.lenbits)-1,V=(1<<l.distbits)-1;t:do{k<15&&(P+=A[h++]<<k,k+=8,P+=A[h++]<<k,k+=8),Y=O[P&j];e:for(;;){if(P>>>=q=Y>>>24,k-=q,(q=Y>>>16&255)===0)R[d++]=65535&Y;else{if(!(16&q)){if(!(64&q)){Y=O[(65535&Y)+(P&(1<<q)-1)];continue e}if(32&q){l.mode=12;break t}r.msg="invalid literal/length code",l.mode=30;break t}st=65535&Y,(q&=15)&&(k<q&&(P+=A[h++]<<k,k+=8),st+=P&(1<<q)-1,P>>>=q,k-=q),k<15&&(P+=A[h++]<<k,k+=8,P+=A[h++]<<k,k+=8),Y=B[P&V];i:for(;;){if(P>>>=q=Y>>>24,k-=q,!(16&(q=Y>>>16&255))){if(!(64&q)){Y=B[(65535&Y)+(P&(1<<q)-1)];continue i}r.msg="invalid distance code",l.mode=30;break t}if(ft=65535&Y,k<(q&=15)&&(P+=A[h++]<<k,(k+=8)<q&&(P+=A[h++]<<k,k+=8)),m<(ft+=P&(1<<q)-1)){r.msg="invalid distance too far back",l.mode=30;break t}if(P>>>=q,k-=q,(q=d-g)<ft){if(b<(q=ft-q)&&l.sane){r.msg="invalid distance too far back",l.mode=30;break t}if(J=C,(U=0)===x){if(U+=I-q,q<st){for(st-=q;R[d++]=C[U++],--q;);U=d-ft,J=R}}else if(x<q){if(U+=I+x-q,(q-=x)<st){for(st-=q;R[d++]=C[U++],--q;);if(U=0,x<st){for(st-=q=x;R[d++]=C[U++],--q;);U=d-ft,J=R}}}else if(U+=x-q,q<st){for(st-=q;R[d++]=C[U++],--q;);U=d-ft,J=R}for(;2<st;)R[d++]=J[U++],R[d++]=J[U++],R[d++]=J[U++],st-=3;st&&(R[d++]=J[U++],1<st&&(R[d++]=J[U++]))}else{for(U=d-ft;R[d++]=R[U++],R[d++]=R[U++],R[d++]=R[U++],2<(st-=3););st&&(R[d++]=R[U++],1<st&&(R[d++]=R[U++]))}break}}break}}while(h<u&&d<y);h-=st=k>>3,P&=(1<<(k-=st<<3))-1,r.next_in=h,r.next_out=d,r.avail_in=h<u?u-h+5:5-(h-u),r.avail_out=d<y?y-d+257:257-(d-y),l.hold=P,l.bits=k}},{}],49:[function(e,i,n){var r=e("../utils/common"),o=e("./adler32"),l=e("./crc32"),h=e("./inffast"),u=e("./inftrees"),d=1,g=2,y=0,m=-2,I=1,b=852,x=592;function C(U){return(U>>>24&255)+(U>>>8&65280)+((65280&U)<<8)+((255&U)<<24)}function P(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function k(U){var J;return U&&U.state?(J=U.state,U.total_in=U.total_out=J.total=0,U.msg="",J.wrap&&(U.adler=1&J.wrap),J.mode=I,J.last=0,J.havedict=0,J.dmax=32768,J.head=null,J.hold=0,J.bits=0,J.lencode=J.lendyn=new r.Buf32(b),J.distcode=J.distdyn=new r.Buf32(x),J.sane=1,J.back=-1,y):m}function O(U){var J;return U&&U.state?((J=U.state).wsize=0,J.whave=0,J.wnext=0,k(U)):m}function B(U,J){var A,R;return U&&U.state?(R=U.state,J<0?(A=0,J=-J):(A=1+(J>>4),J<48&&(J&=15)),J&&(J<8||15<J)?m:(R.window!==null&&R.wbits!==J&&(R.window=null),R.wrap=A,R.wbits=J,O(U))):m}function j(U,J){var A,R;return U?(R=new P,(U.state=R).window=null,(A=B(U,J))!==y&&(U.state=null),A):m}var V,Y,q=!0;function st(U){if(q){var J;for(V=new r.Buf32(512),Y=new r.Buf32(32),J=0;J<144;)U.lens[J++]=8;for(;J<256;)U.lens[J++]=9;for(;J<280;)U.lens[J++]=7;for(;J<288;)U.lens[J++]=8;for(u(d,U.lens,0,288,V,0,U.work,{bits:9}),J=0;J<32;)U.lens[J++]=5;u(g,U.lens,0,32,Y,0,U.work,{bits:5}),q=!1}U.lencode=V,U.lenbits=9,U.distcode=Y,U.distbits=5}function ft(U,J,A,R){var bt,z=U.state;return z.window===null&&(z.wsize=1<<z.wbits,z.wnext=0,z.whave=0,z.window=new r.Buf8(z.wsize)),R>=z.wsize?(r.arraySet(z.window,J,A-z.wsize,z.wsize,0),z.wnext=0,z.whave=z.wsize):(R<(bt=z.wsize-z.wnext)&&(bt=R),r.arraySet(z.window,J,A-R,bt,z.wnext),(R-=bt)?(r.arraySet(z.window,J,A-R,R,0),z.wnext=R,z.whave=z.wsize):(z.wnext+=bt,z.wnext===z.wsize&&(z.wnext=0),z.whave<z.wsize&&(z.whave+=bt))),0}n.inflateReset=O,n.inflateReset2=B,n.inflateResetKeep=k,n.inflateInit=function(U){return j(U,15)},n.inflateInit2=j,n.inflate=function(U,J){var A,R,bt,z,Pt,X,Tt,lt,at,Gt,kt,Ft,ni,ji,oe,Se,We,Ve,Le,yn,T,yt,gt,$,W=0,nt=new r.Buf8(4),It=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!U||!U.state||!U.output||!U.input&&U.avail_in!==0)return m;(A=U.state).mode===12&&(A.mode=13),Pt=U.next_out,bt=U.output,Tt=U.avail_out,z=U.next_in,R=U.input,X=U.avail_in,lt=A.hold,at=A.bits,Gt=X,kt=Tt,yt=y;t:for(;;)switch(A.mode){case I:if(A.wrap===0){A.mode=13;break}for(;at<16;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(2&A.wrap&&lt===35615){nt[A.check=0]=255&lt,nt[1]=lt>>>8&255,A.check=l(A.check,nt,2,0),at=lt=0,A.mode=2;break}if(A.flags=0,A.head&&(A.head.done=!1),!(1&A.wrap)||(((255&lt)<<8)+(lt>>8))%31){U.msg="incorrect header check",A.mode=30;break}if((15&lt)!=8){U.msg="unknown compression method",A.mode=30;break}if(at-=4,T=8+(15&(lt>>>=4)),A.wbits===0)A.wbits=T;else if(T>A.wbits){U.msg="invalid window size",A.mode=30;break}A.dmax=1<<T,U.adler=A.check=1,A.mode=512&lt?10:12,at=lt=0;break;case 2:for(;at<16;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(A.flags=lt,(255&A.flags)!=8){U.msg="unknown compression method",A.mode=30;break}if(57344&A.flags){U.msg="unknown header flags set",A.mode=30;break}A.head&&(A.head.text=lt>>8&1),512&A.flags&&(nt[0]=255&lt,nt[1]=lt>>>8&255,A.check=l(A.check,nt,2,0)),at=lt=0,A.mode=3;case 3:for(;at<32;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}A.head&&(A.head.time=lt),512&A.flags&&(nt[0]=255&lt,nt[1]=lt>>>8&255,nt[2]=lt>>>16&255,nt[3]=lt>>>24&255,A.check=l(A.check,nt,4,0)),at=lt=0,A.mode=4;case 4:for(;at<16;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}A.head&&(A.head.xflags=255&lt,A.head.os=lt>>8),512&A.flags&&(nt[0]=255&lt,nt[1]=lt>>>8&255,A.check=l(A.check,nt,2,0)),at=lt=0,A.mode=5;case 5:if(1024&A.flags){for(;at<16;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}A.length=lt,A.head&&(A.head.extra_len=lt),512&A.flags&&(nt[0]=255&lt,nt[1]=lt>>>8&255,A.check=l(A.check,nt,2,0)),at=lt=0}else A.head&&(A.head.extra=null);A.mode=6;case 6:if(1024&A.flags&&(X<(Ft=A.length)&&(Ft=X),Ft&&(A.head&&(T=A.head.extra_len-A.length,A.head.extra||(A.head.extra=new Array(A.head.extra_len)),r.arraySet(A.head.extra,R,z,Ft,T)),512&A.flags&&(A.check=l(A.check,R,Ft,z)),X-=Ft,z+=Ft,A.length-=Ft),A.length))break t;A.length=0,A.mode=7;case 7:if(2048&A.flags){if(X===0)break t;for(Ft=0;T=R[z+Ft++],A.head&&T&&A.length<65536&&(A.head.name+=String.fromCharCode(T)),T&&Ft<X;);if(512&A.flags&&(A.check=l(A.check,R,Ft,z)),X-=Ft,z+=Ft,T)break t}else A.head&&(A.head.name=null);A.length=0,A.mode=8;case 8:if(4096&A.flags){if(X===0)break t;for(Ft=0;T=R[z+Ft++],A.head&&T&&A.length<65536&&(A.head.comment+=String.fromCharCode(T)),T&&Ft<X;);if(512&A.flags&&(A.check=l(A.check,R,Ft,z)),X-=Ft,z+=Ft,T)break t}else A.head&&(A.head.comment=null);A.mode=9;case 9:if(512&A.flags){for(;at<16;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(lt!==(65535&A.check)){U.msg="header crc mismatch",A.mode=30;break}at=lt=0}A.head&&(A.head.hcrc=A.flags>>9&1,A.head.done=!0),U.adler=A.check=0,A.mode=12;break;case 10:for(;at<32;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}U.adler=A.check=C(lt),at=lt=0,A.mode=11;case 11:if(A.havedict===0)return U.next_out=Pt,U.avail_out=Tt,U.next_in=z,U.avail_in=X,A.hold=lt,A.bits=at,2;U.adler=A.check=1,A.mode=12;case 12:if(J===5||J===6)break t;case 13:if(A.last){lt>>>=7&at,at-=7&at,A.mode=27;break}for(;at<3;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}switch(A.last=1&lt,at-=1,3&(lt>>>=1)){case 0:A.mode=14;break;case 1:if(st(A),A.mode=20,J!==6)break;lt>>>=2,at-=2;break t;case 2:A.mode=17;break;case 3:U.msg="invalid block type",A.mode=30}lt>>>=2,at-=2;break;case 14:for(lt>>>=7&at,at-=7&at;at<32;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if((65535&lt)!=(lt>>>16^65535)){U.msg="invalid stored block lengths",A.mode=30;break}if(A.length=65535&lt,at=lt=0,A.mode=15,J===6)break t;case 15:A.mode=16;case 16:if(Ft=A.length){if(X<Ft&&(Ft=X),Tt<Ft&&(Ft=Tt),Ft===0)break t;r.arraySet(bt,R,z,Ft,Pt),X-=Ft,z+=Ft,Tt-=Ft,Pt+=Ft,A.length-=Ft;break}A.mode=12;break;case 17:for(;at<14;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(A.nlen=257+(31&lt),lt>>>=5,at-=5,A.ndist=1+(31&lt),lt>>>=5,at-=5,A.ncode=4+(15&lt),lt>>>=4,at-=4,286<A.nlen||30<A.ndist){U.msg="too many length or distance symbols",A.mode=30;break}A.have=0,A.mode=18;case 18:for(;A.have<A.ncode;){for(;at<3;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}A.lens[It[A.have++]]=7&lt,lt>>>=3,at-=3}for(;A.have<19;)A.lens[It[A.have++]]=0;if(A.lencode=A.lendyn,A.lenbits=7,gt={bits:A.lenbits},yt=u(0,A.lens,0,19,A.lencode,0,A.work,gt),A.lenbits=gt.bits,yt){U.msg="invalid code lengths set",A.mode=30;break}A.have=0,A.mode=19;case 19:for(;A.have<A.nlen+A.ndist;){for(;Se=(W=A.lencode[lt&(1<<A.lenbits)-1])>>>16&255,We=65535&W,!((oe=W>>>24)<=at);){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(We<16)lt>>>=oe,at-=oe,A.lens[A.have++]=We;else{if(We===16){for($=oe+2;at<$;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(lt>>>=oe,at-=oe,A.have===0){U.msg="invalid bit length repeat",A.mode=30;break}T=A.lens[A.have-1],Ft=3+(3&lt),lt>>>=2,at-=2}else if(We===17){for($=oe+3;at<$;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}at-=oe,T=0,Ft=3+(7&(lt>>>=oe)),lt>>>=3,at-=3}else{for($=oe+7;at<$;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}at-=oe,T=0,Ft=11+(127&(lt>>>=oe)),lt>>>=7,at-=7}if(A.have+Ft>A.nlen+A.ndist){U.msg="invalid bit length repeat",A.mode=30;break}for(;Ft--;)A.lens[A.have++]=T}}if(A.mode===30)break;if(A.lens[256]===0){U.msg="invalid code -- missing end-of-block",A.mode=30;break}if(A.lenbits=9,gt={bits:A.lenbits},yt=u(d,A.lens,0,A.nlen,A.lencode,0,A.work,gt),A.lenbits=gt.bits,yt){U.msg="invalid literal/lengths set",A.mode=30;break}if(A.distbits=6,A.distcode=A.distdyn,gt={bits:A.distbits},yt=u(g,A.lens,A.nlen,A.ndist,A.distcode,0,A.work,gt),A.distbits=gt.bits,yt){U.msg="invalid distances set",A.mode=30;break}if(A.mode=20,J===6)break t;case 20:A.mode=21;case 21:if(6<=X&&258<=Tt){U.next_out=Pt,U.avail_out=Tt,U.next_in=z,U.avail_in=X,A.hold=lt,A.bits=at,h(U,kt),Pt=U.next_out,bt=U.output,Tt=U.avail_out,z=U.next_in,R=U.input,X=U.avail_in,lt=A.hold,at=A.bits,A.mode===12&&(A.back=-1);break}for(A.back=0;Se=(W=A.lencode[lt&(1<<A.lenbits)-1])>>>16&255,We=65535&W,!((oe=W>>>24)<=at);){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(Se&&!(240&Se)){for(Ve=oe,Le=Se,yn=We;Se=(W=A.lencode[yn+((lt&(1<<Ve+Le)-1)>>Ve)])>>>16&255,We=65535&W,!(Ve+(oe=W>>>24)<=at);){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}lt>>>=Ve,at-=Ve,A.back+=Ve}if(lt>>>=oe,at-=oe,A.back+=oe,A.length=We,Se===0){A.mode=26;break}if(32&Se){A.back=-1,A.mode=12;break}if(64&Se){U.msg="invalid literal/length code",A.mode=30;break}A.extra=15&Se,A.mode=22;case 22:if(A.extra){for($=A.extra;at<$;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}A.length+=lt&(1<<A.extra)-1,lt>>>=A.extra,at-=A.extra,A.back+=A.extra}A.was=A.length,A.mode=23;case 23:for(;Se=(W=A.distcode[lt&(1<<A.distbits)-1])>>>16&255,We=65535&W,!((oe=W>>>24)<=at);){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(!(240&Se)){for(Ve=oe,Le=Se,yn=We;Se=(W=A.distcode[yn+((lt&(1<<Ve+Le)-1)>>Ve)])>>>16&255,We=65535&W,!(Ve+(oe=W>>>24)<=at);){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}lt>>>=Ve,at-=Ve,A.back+=Ve}if(lt>>>=oe,at-=oe,A.back+=oe,64&Se){U.msg="invalid distance code",A.mode=30;break}A.offset=We,A.extra=15&Se,A.mode=24;case 24:if(A.extra){for($=A.extra;at<$;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}A.offset+=lt&(1<<A.extra)-1,lt>>>=A.extra,at-=A.extra,A.back+=A.extra}if(A.offset>A.dmax){U.msg="invalid distance too far back",A.mode=30;break}A.mode=25;case 25:if(Tt===0)break t;if(Ft=kt-Tt,A.offset>Ft){if((Ft=A.offset-Ft)>A.whave&&A.sane){U.msg="invalid distance too far back",A.mode=30;break}ni=Ft>A.wnext?(Ft-=A.wnext,A.wsize-Ft):A.wnext-Ft,Ft>A.length&&(Ft=A.length),ji=A.window}else ji=bt,ni=Pt-A.offset,Ft=A.length;for(Tt<Ft&&(Ft=Tt),Tt-=Ft,A.length-=Ft;bt[Pt++]=ji[ni++],--Ft;);A.length===0&&(A.mode=21);break;case 26:if(Tt===0)break t;bt[Pt++]=A.length,Tt--,A.mode=21;break;case 27:if(A.wrap){for(;at<32;){if(X===0)break t;X--,lt|=R[z++]<<at,at+=8}if(kt-=Tt,U.total_out+=kt,A.total+=kt,kt&&(U.adler=A.check=A.flags?l(A.check,bt,kt,Pt-kt):o(A.check,bt,kt,Pt-kt)),kt=Tt,(A.flags?lt:C(lt))!==A.check){U.msg="incorrect data check",A.mode=30;break}at=lt=0}A.mode=28;case 28:if(A.wrap&&A.flags){for(;at<32;){if(X===0)break t;X--,lt+=R[z++]<<at,at+=8}if(lt!==(4294967295&A.total)){U.msg="incorrect length check",A.mode=30;break}at=lt=0}A.mode=29;case 29:yt=1;break t;case 30:yt=-3;break t;case 31:return-4;case 32:default:return m}return U.next_out=Pt,U.avail_out=Tt,U.next_in=z,U.avail_in=X,A.hold=lt,A.bits=at,(A.wsize||kt!==U.avail_out&&A.mode<30&&(A.mode<27||J!==4))&&ft(U,U.output,U.next_out,kt-U.avail_out)?(A.mode=31,-4):(Gt-=U.avail_in,kt-=U.avail_out,U.total_in+=Gt,U.total_out+=kt,A.total+=kt,A.wrap&&kt&&(U.adler=A.check=A.flags?l(A.check,bt,kt,U.next_out-kt):o(A.check,bt,kt,U.next_out-kt)),U.data_type=A.bits+(A.last?64:0)+(A.mode===12?128:0)+(A.mode===20||A.mode===15?256:0),(Gt==0&&kt===0||J===4)&&yt===y&&(yt=-5),yt)},n.inflateEnd=function(U){if(!U||!U.state)return m;var J=U.state;return J.window&&(J.window=null),U.state=null,y},n.inflateGetHeader=function(U,J){var A;return U&&U.state&&2&(A=U.state).wrap?((A.head=J).done=!1,y):m},n.inflateSetDictionary=function(U,J){var A,R=J.length;return U&&U.state?(A=U.state).wrap!==0&&A.mode!==11?m:A.mode===11&&o(1,J,R,0)!==A.check?-3:ft(U,J,R,R)?(A.mode=31,-4):(A.havedict=1,y):m},n.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,i,n){var r=e("../utils/common"),o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],l=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],h=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],u=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];i.exports=function(d,g,y,m,I,b,x,C){var P,k,O,B,j,V,Y,q,st,ft=C.bits,U=0,J=0,A=0,R=0,bt=0,z=0,Pt=0,X=0,Tt=0,lt=0,at=null,Gt=0,kt=new r.Buf16(16),Ft=new r.Buf16(16),ni=null,ji=0;for(U=0;U<=15;U++)kt[U]=0;for(J=0;J<m;J++)kt[g[y+J]]++;for(bt=ft,R=15;1<=R&&kt[R]===0;R--);if(R<bt&&(bt=R),R===0)return I[b++]=20971520,I[b++]=20971520,C.bits=1,0;for(A=1;A<R&&kt[A]===0;A++);for(bt<A&&(bt=A),U=X=1;U<=15;U++)if(X<<=1,(X-=kt[U])<0)return-1;if(0<X&&(d===0||R!==1))return-1;for(Ft[1]=0,U=1;U<15;U++)Ft[U+1]=Ft[U]+kt[U];for(J=0;J<m;J++)g[y+J]!==0&&(x[Ft[g[y+J]]++]=J);if(V=d===0?(at=ni=x,19):d===1?(at=o,Gt-=257,ni=l,ji-=257,256):(at=h,ni=u,-1),U=A,j=b,Pt=J=lt=0,O=-1,B=(Tt=1<<(z=bt))-1,d===1&&852<Tt||d===2&&592<Tt)return 1;for(;;){for(Y=U-Pt,st=x[J]<V?(q=0,x[J]):x[J]>V?(q=ni[ji+x[J]],at[Gt+x[J]]):(q=96,0),P=1<<U-Pt,A=k=1<<z;I[j+(lt>>Pt)+(k-=P)]=Y<<24|q<<16|st|0,k!==0;);for(P=1<<U-1;lt&P;)P>>=1;if(P!==0?(lt&=P-1,lt+=P):lt=0,J++,--kt[U]==0){if(U===R)break;U=g[y+x[J]]}if(bt<U&&(lt&B)!==O){for(Pt===0&&(Pt=bt),j+=A,X=1<<(z=U-Pt);z+Pt<R&&!((X-=kt[z+Pt])<=0);)z++,X<<=1;if(Tt+=1<<z,d===1&&852<Tt||d===2&&592<Tt)return 1;I[O=lt&B]=bt<<24|z<<16|j-b|0}}return lt!==0&&(I[j+lt]=U-Pt<<24|4194304|0),C.bits=bt,0}},{"../utils/common":41}],51:[function(e,i,n){i.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,i,n){var r=e("../utils/common"),o=0,l=1;function h(W){for(var nt=W.length;0<=--nt;)W[nt]=0}var u=0,d=29,g=256,y=g+1+d,m=30,I=19,b=2*y+1,x=15,C=16,P=7,k=256,O=16,B=17,j=18,V=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Y=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],q=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],st=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ft=new Array(2*(y+2));h(ft);var U=new Array(2*m);h(U);var J=new Array(512);h(J);var A=new Array(256);h(A);var R=new Array(d);h(R);var bt,z,Pt,X=new Array(m);function Tt(W,nt,It,St,ot){this.static_tree=W,this.extra_bits=nt,this.extra_base=It,this.elems=St,this.max_length=ot,this.has_stree=W&&W.length}function lt(W,nt){this.dyn_tree=W,this.max_code=0,this.stat_desc=nt}function at(W){return W<256?J[W]:J[256+(W>>>7)]}function Gt(W,nt){W.pending_buf[W.pending++]=255&nt,W.pending_buf[W.pending++]=nt>>>8&255}function kt(W,nt,It){W.bi_valid>C-It?(W.bi_buf|=nt<<W.bi_valid&65535,Gt(W,W.bi_buf),W.bi_buf=nt>>C-W.bi_valid,W.bi_valid+=It-C):(W.bi_buf|=nt<<W.bi_valid&65535,W.bi_valid+=It)}function Ft(W,nt,It){kt(W,It[2*nt],It[2*nt+1])}function ni(W,nt){for(var It=0;It|=1&W,W>>>=1,It<<=1,0<--nt;);return It>>>1}function ji(W,nt,It){var St,ot,xt=new Array(x+1),Lt=0;for(St=1;St<=x;St++)xt[St]=Lt=Lt+It[St-1]<<1;for(ot=0;ot<=nt;ot++){var Ot=W[2*ot+1];Ot!==0&&(W[2*ot]=ni(xt[Ot]++,Ot))}}function oe(W){var nt;for(nt=0;nt<y;nt++)W.dyn_ltree[2*nt]=0;for(nt=0;nt<m;nt++)W.dyn_dtree[2*nt]=0;for(nt=0;nt<I;nt++)W.bl_tree[2*nt]=0;W.dyn_ltree[2*k]=1,W.opt_len=W.static_len=0,W.last_lit=W.matches=0}function Se(W){8<W.bi_valid?Gt(W,W.bi_buf):0<W.bi_valid&&(W.pending_buf[W.pending++]=W.bi_buf),W.bi_buf=0,W.bi_valid=0}function We(W,nt,It,St){var ot=2*nt,xt=2*It;return W[ot]<W[xt]||W[ot]===W[xt]&&St[nt]<=St[It]}function Ve(W,nt,It){for(var St=W.heap[It],ot=It<<1;ot<=W.heap_len&&(ot<W.heap_len&&We(nt,W.heap[ot+1],W.heap[ot],W.depth)&&ot++,!We(nt,St,W.heap[ot],W.depth));)W.heap[It]=W.heap[ot],It=ot,ot<<=1;W.heap[It]=St}function Le(W,nt,It){var St,ot,xt,Lt,Ot=0;if(W.last_lit!==0)for(;St=W.pending_buf[W.d_buf+2*Ot]<<8|W.pending_buf[W.d_buf+2*Ot+1],ot=W.pending_buf[W.l_buf+Ot],Ot++,St===0?Ft(W,ot,nt):(Ft(W,(xt=A[ot])+g+1,nt),(Lt=V[xt])!==0&&kt(W,ot-=R[xt],Lt),Ft(W,xt=at(--St),It),(Lt=Y[xt])!==0&&kt(W,St-=X[xt],Lt)),Ot<W.last_lit;);Ft(W,k,nt)}function yn(W,nt){var It,St,ot,xt=nt.dyn_tree,Lt=nt.stat_desc.static_tree,Ot=nt.stat_desc.has_stree,Ut=nt.stat_desc.elems,Ge=-1;for(W.heap_len=0,W.heap_max=b,It=0;It<Ut;It++)xt[2*It]!==0?(W.heap[++W.heap_len]=Ge=It,W.depth[It]=0):xt[2*It+1]=0;for(;W.heap_len<2;)xt[2*(ot=W.heap[++W.heap_len]=Ge<2?++Ge:0)]=1,W.depth[ot]=0,W.opt_len--,Ot&&(W.static_len-=Lt[2*ot+1]);for(nt.max_code=Ge,It=W.heap_len>>1;1<=It;It--)Ve(W,xt,It);for(ot=Ut;It=W.heap[1],W.heap[1]=W.heap[W.heap_len--],Ve(W,xt,1),St=W.heap[1],W.heap[--W.heap_max]=It,W.heap[--W.heap_max]=St,xt[2*ot]=xt[2*It]+xt[2*St],W.depth[ot]=(W.depth[It]>=W.depth[St]?W.depth[It]:W.depth[St])+1,xt[2*It+1]=xt[2*St+1]=ot,W.heap[1]=ot++,Ve(W,xt,1),2<=W.heap_len;);W.heap[--W.heap_max]=W.heap[1],function(we,hn){var Rn,Qi,ds,ui,Qs,tr,Un=hn.dyn_tree,te=hn.max_code,jn=hn.stat_desc.static_tree,Wn=hn.stat_desc.has_stree,vs=hn.stat_desc.extra_bits,tn=hn.stat_desc.extra_base,Oi=hn.stat_desc.max_length,es=0;for(ui=0;ui<=x;ui++)we.bl_count[ui]=0;for(Un[2*we.heap[we.heap_max]+1]=0,Rn=we.heap_max+1;Rn<b;Rn++)Oi<(ui=Un[2*Un[2*(Qi=we.heap[Rn])+1]+1]+1)&&(ui=Oi,es++),Un[2*Qi+1]=ui,te<Qi||(we.bl_count[ui]++,Qs=0,tn<=Qi&&(Qs=vs[Qi-tn]),tr=Un[2*Qi],we.opt_len+=tr*(ui+Qs),Wn&&(we.static_len+=tr*(jn[2*Qi+1]+Qs)));if(es!==0){do{for(ui=Oi-1;we.bl_count[ui]===0;)ui--;we.bl_count[ui]--,we.bl_count[ui+1]+=2,we.bl_count[Oi]--,es-=2}while(0<es);for(ui=Oi;ui!==0;ui--)for(Qi=we.bl_count[ui];Qi!==0;)te<(ds=we.heap[--Rn])||(Un[2*ds+1]!==ui&&(we.opt_len+=(ui-Un[2*ds+1])*Un[2*ds],Un[2*ds+1]=ui),Qi--)}}(W,nt),ji(xt,Ge,W.bl_count)}function T(W,nt,It){var St,ot,xt=-1,Lt=nt[1],Ot=0,Ut=7,Ge=4;for(Lt===0&&(Ut=138,Ge=3),nt[2*(It+1)+1]=65535,St=0;St<=It;St++)ot=Lt,Lt=nt[2*(St+1)+1],++Ot<Ut&&ot===Lt||(Ot<Ge?W.bl_tree[2*ot]+=Ot:ot!==0?(ot!==xt&&W.bl_tree[2*ot]++,W.bl_tree[2*O]++):Ot<=10?W.bl_tree[2*B]++:W.bl_tree[2*j]++,xt=ot,Ge=(Ot=0)===Lt?(Ut=138,3):ot===Lt?(Ut=6,3):(Ut=7,4))}function yt(W,nt,It){var St,ot,xt=-1,Lt=nt[1],Ot=0,Ut=7,Ge=4;for(Lt===0&&(Ut=138,Ge=3),St=0;St<=It;St++)if(ot=Lt,Lt=nt[2*(St+1)+1],!(++Ot<Ut&&ot===Lt)){if(Ot<Ge)for(;Ft(W,ot,W.bl_tree),--Ot!=0;);else ot!==0?(ot!==xt&&(Ft(W,ot,W.bl_tree),Ot--),Ft(W,O,W.bl_tree),kt(W,Ot-3,2)):Ot<=10?(Ft(W,B,W.bl_tree),kt(W,Ot-3,3)):(Ft(W,j,W.bl_tree),kt(W,Ot-11,7));xt=ot,Ge=(Ot=0)===Lt?(Ut=138,3):ot===Lt?(Ut=6,3):(Ut=7,4)}}h(X);var gt=!1;function $(W,nt,It,St){kt(W,(u<<1)+(St?1:0),3),function(ot,xt,Lt,Ot){Se(ot),Gt(ot,Lt),Gt(ot,~Lt),r.arraySet(ot.pending_buf,ot.window,xt,Lt,ot.pending),ot.pending+=Lt}(W,nt,It)}n._tr_init=function(W){gt||(function(){var nt,It,St,ot,xt,Lt=new Array(x+1);for(ot=St=0;ot<d-1;ot++)for(R[ot]=St,nt=0;nt<1<<V[ot];nt++)A[St++]=ot;for(A[St-1]=ot,ot=xt=0;ot<16;ot++)for(X[ot]=xt,nt=0;nt<1<<Y[ot];nt++)J[xt++]=ot;for(xt>>=7;ot<m;ot++)for(X[ot]=xt<<7,nt=0;nt<1<<Y[ot]-7;nt++)J[256+xt++]=ot;for(It=0;It<=x;It++)Lt[It]=0;for(nt=0;nt<=143;)ft[2*nt+1]=8,nt++,Lt[8]++;for(;nt<=255;)ft[2*nt+1]=9,nt++,Lt[9]++;for(;nt<=279;)ft[2*nt+1]=7,nt++,Lt[7]++;for(;nt<=287;)ft[2*nt+1]=8,nt++,Lt[8]++;for(ji(ft,y+1,Lt),nt=0;nt<m;nt++)U[2*nt+1]=5,U[2*nt]=ni(nt,5);bt=new Tt(ft,V,g+1,y,x),z=new Tt(U,Y,0,m,x),Pt=new Tt(new Array(0),q,0,I,P)}(),gt=!0),W.l_desc=new lt(W.dyn_ltree,bt),W.d_desc=new lt(W.dyn_dtree,z),W.bl_desc=new lt(W.bl_tree,Pt),W.bi_buf=0,W.bi_valid=0,oe(W)},n._tr_stored_block=$,n._tr_flush_block=function(W,nt,It,St){var ot,xt,Lt=0;0<W.level?(W.strm.data_type===2&&(W.strm.data_type=function(Ot){var Ut,Ge=4093624447;for(Ut=0;Ut<=31;Ut++,Ge>>>=1)if(1&Ge&&Ot.dyn_ltree[2*Ut]!==0)return o;if(Ot.dyn_ltree[18]!==0||Ot.dyn_ltree[20]!==0||Ot.dyn_ltree[26]!==0)return l;for(Ut=32;Ut<g;Ut++)if(Ot.dyn_ltree[2*Ut]!==0)return l;return o}(W)),yn(W,W.l_desc),yn(W,W.d_desc),Lt=function(Ot){var Ut;for(T(Ot,Ot.dyn_ltree,Ot.l_desc.max_code),T(Ot,Ot.dyn_dtree,Ot.d_desc.max_code),yn(Ot,Ot.bl_desc),Ut=I-1;3<=Ut&&Ot.bl_tree[2*st[Ut]+1]===0;Ut--);return Ot.opt_len+=3*(Ut+1)+5+5+4,Ut}(W),ot=W.opt_len+3+7>>>3,(xt=W.static_len+3+7>>>3)<=ot&&(ot=xt)):ot=xt=It+5,It+4<=ot&&nt!==-1?$(W,nt,It,St):W.strategy===4||xt===ot?(kt(W,2+(St?1:0),3),Le(W,ft,U)):(kt(W,4+(St?1:0),3),function(Ot,Ut,Ge,we){var hn;for(kt(Ot,Ut-257,5),kt(Ot,Ge-1,5),kt(Ot,we-4,4),hn=0;hn<we;hn++)kt(Ot,Ot.bl_tree[2*st[hn]+1],3);yt(Ot,Ot.dyn_ltree,Ut-1),yt(Ot,Ot.dyn_dtree,Ge-1)}(W,W.l_desc.max_code+1,W.d_desc.max_code+1,Lt+1),Le(W,W.dyn_ltree,W.dyn_dtree)),oe(W),St&&Se(W)},n._tr_tally=function(W,nt,It){return W.pending_buf[W.d_buf+2*W.last_lit]=nt>>>8&255,W.pending_buf[W.d_buf+2*W.last_lit+1]=255&nt,W.pending_buf[W.l_buf+W.last_lit]=255&It,W.last_lit++,nt===0?W.dyn_ltree[2*It]++:(W.matches++,nt--,W.dyn_ltree[2*(A[It]+g+1)]++,W.dyn_dtree[2*at(nt)]++),W.last_lit===W.lit_bufsize-1},n._tr_align=function(W){kt(W,2,3),Ft(W,k,ft),function(nt){nt.bi_valid===16?(Gt(nt,nt.bi_buf),nt.bi_buf=0,nt.bi_valid=0):8<=nt.bi_valid&&(nt.pending_buf[nt.pending++]=255&nt.bi_buf,nt.bi_buf>>=8,nt.bi_valid-=8)}(W)}},{"../utils/common":41}],53:[function(e,i,n){i.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,i,n){(function(r){(function(o,l){if(!o.setImmediate){var h,u,d,g,y=1,m={},I=!1,b=o.document,x=Object.getPrototypeOf&&Object.getPrototypeOf(o);x=x&&x.setTimeout?x:o,h={}.toString.call(o.process)==="[object process]"?function(O){process.nextTick(function(){P(O)})}:function(){if(o.postMessage&&!o.importScripts){var O=!0,B=o.onmessage;return o.onmessage=function(){O=!1},o.postMessage("","*"),o.onmessage=B,O}}()?(g="setImmediate$"+Math.random()+"$",o.addEventListener?o.addEventListener("message",k,!1):o.attachEvent("onmessage",k),function(O){o.postMessage(g+O,"*")}):o.MessageChannel?((d=new MessageChannel).port1.onmessage=function(O){P(O.data)},function(O){d.port2.postMessage(O)}):b&&"onreadystatechange"in b.createElement("script")?(u=b.documentElement,function(O){var B=b.createElement("script");B.onreadystatechange=function(){P(O),B.onreadystatechange=null,u.removeChild(B),B=null},u.appendChild(B)}):function(O){setTimeout(P,0,O)},x.setImmediate=function(O){typeof O!="function"&&(O=new Function(""+O));for(var B=new Array(arguments.length-1),j=0;j<B.length;j++)B[j]=arguments[j+1];var V={callback:O,args:B};return m[y]=V,h(y),y++},x.clearImmediate=C}function C(O){delete m[O]}function P(O){if(I)setTimeout(P,0,O);else{var B=m[O];if(B){I=!0;try{(function(j){var V=j.callback,Y=j.args;switch(Y.length){case 0:V();break;case 1:V(Y[0]);break;case 2:V(Y[0],Y[1]);break;case 3:V(Y[0],Y[1],Y[2]);break;default:V.apply(l,Y)}})(B)}finally{C(O),I=!1}}}}function k(O){O.source===o&&typeof O.data=="string"&&O.data.indexOf(g)===0&&P(+O.data.slice(g.length))}})(typeof self>"u"?r===void 0?this:r:self)}).call(this,typeof ia<"u"?ia:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(qm);var Vf=qm.exports;const Km=cu(Vf),db=new Km;class Uu{constructor(t,e){this._version=Ys.Unknown,this._topicsMap=new Map,this._bcfFileName=t,this._id=e}async exportBCF(t){await this.toBcfZipBlob().then(e=>{const i=document.createElement("a"),n=URL.createObjectURL(e);i.href=n,i.download=`${t}.bcf`,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(n)},0)})}toBcfZipBlob(){const t=new XMLSerializer,i=db.file("bcf.version",'<?xml version="1.0" encoding="UTF-8"?><Version VersionId="2.1" xsi:noNamespaceSchemaLocation="version.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><DetailedVersion>2.1</DetailedVersion></Version>');return this._topicsMap.forEach((n,r)=>{const o=i.folder(r);if(o===null){console.error("Failed to create folder for BCF topic");return}const l=t.serializeToString(n.getMarkup().export());o.file("markup.bcf",l),n.getViewpointMap().forEach((d,g)=>{const y=t.serializeToString(d.export());o.file(g,y)}),n.getSnapshotMap().forEach((d,g)=>{o.file(g,d.getData())})}),i.generateAsync({type:"blob"})}addTopic(t,e){this._topicsMap.set(t,e)}getTopics(){return this._topicsMap}getTopic(t){return this._topicsMap.get(t)||null}getVersion(){return this._version}setVersion(t){this._version=t}getFilename(){return this._bcfFileName}getId(){return this._id}}function hs(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){const t=new Uint32Array(1);av().getRandomValues(t);const e=t[0]/4294967295*16|0;return(s==="x"?e:e&3|8).toString(16)})}class Xm{constructor(t,e,i,n,r,o){this._ifcProject=t,this._ifcSpatialStructureElement=e,this._isExternal=i,this._filename=n,this._date=r,this._reference=o}getIfcProject(){return this._ifcProject||null}getIfcSpacialStructureElement(){return this._ifcSpatialStructureElement||null}getIsExternal(){return this._isExternal||null}getBimFilename(){return this._filename||null}getBimDate(){return this._date||null}getReference(){return this._reference||null}}class Jm{constructor(t,e,i,n){this._viewpointFilename=void 0,this._snapshotFilename=void 0,this._index=void 0,this._guid=t,this._viewpointFilename=e,this._snapshotFilename=i,n!==void 0&&(this._index=parseInt(n,10))}getGuid(){return this._guid}getViewpointFilename(){return this._viewpointFilename||null}getSnapshotFilename(){return this._snapshotFilename||null}getIndex(){return this._index||null}}class zf{constructor(t,e,i,n,r,o,l){this._guid=t,this._date=e,this._author=i,this._text=n,this._viewpointGuid=r,this._modifiedDate=o,this._modifiedAuthor=l}getId(){return this._guid}getDate(){return this._date}setDate(t){this._date=t}getAuthor(){return this._author}setAuthor(t){this._author=t}getText(){return this._text}setText(t){this._text=t}getViewpointGuid(){return this._viewpointGuid||null}setViewpointGuid(t){this._viewpointGuid=t!==null?t:void 0}getModifiedDate(){return this._modifiedDate||null}setModifiedDate(t){this._modifiedDate=t!==null?t:void 0}getModifiedAuthor(){return this._modifiedAuthor||null}setModifiedAuthor(t){this._modifiedAuthor=t!==null?t:void 0}}class Ym{constructor(t,e,i){this._markupHeaderFiles=[],this._topic={guid:"",title:"",creationDate:new Date,creationAuthor:""},this._comments=new Map,this._viewpoints=new Map,this._filename=t,this._bcfTopic=i,this._parseDocument(e)}_parseDocument(t){if(t===null)return;let i=t.documentElement.firstElementChild;for(;i!==null;){const n=i.localName;if(n===null)break;switch(n){case"Header":this._parseHeader(i);break;case"Topic":this._parseTopic(i);break;case"Comment":this._parseComment(i);break;case"Viewpoints":this._parseViewpoint(i);break}i=i.nextElementSibling}}_exportHeader(t){const e=t.createElement("Header");return Lr(e,"ProjectGuid",this._projectGuid),this._markupHeaderFiles.forEach(i=>{const n=t.createElement("File");Lr(n,"IfcProject",i.getIfcProject()),Lr(n,"IfcSpatialStructureElement",i.getIfcSpacialStructureElement()),Lr(n,"isExternal",zu(i.getIsExternal())),cn(t,n,"Filename",i.getBimFilename()),cn(t,n,"Date",Kc(i.getBimDate())),cn(t,n,"Reference",i.getReference()),e.appendChild(n)}),e}_exportTopicData(t){const e=t.createElement("Topic");if(e.setAttribute("Guid",this._topic.guid),Lr(e,"TopicType",this._topic.topicType),Lr(e,"TopicStatus",this._topic.topicStatus),Fr(t,e,"Title",this._topic.title),Fr(t,e,"CreationDate",this._topic.creationDate.toISOString()),Fr(t,e,"CreationAuthor",this._topic.creationAuthor),cn(t,e,"ReferenceLink",this._topic.referenceLink),cn(t,e,"Priority",this._topic.priority),cn(t,e,"Index",Bf(this._topic.index)),cn(t,e,"ModifiedDate",Kc(this._topic.modifiedDate)),cn(t,e,"ModifiedAuthor",this._topic.modifiedAuthor),cn(t,e,"DueDate",Kc(this._topic.dueDate)),cn(t,e,"AssignedTo",this._topic.assignedTo),cn(t,e,"Description",this._topic.description),cn(t,e,"Stage",this._topic.stage),this._topic.labels){const i=t.createElement("Labels");this._topic.labels.forEach(n=>{Fr(t,i,"Label",n)}),e.appendChild(i)}return e}_exportBimSnippet(t,e){const i=t.createElement("BimSnippet");return i.setAttribute("SnippetType",e.snippetType),Lr(i,"isExternal",zu(e.isExternal)),Fr(t,i,"Reference",e.reference),cn(t,i,"ReferenceSchema",e.referenceSchema),i}_exportDocumentReference(t,e){const i=t.createElement("DocumentReference");return Lr(i,"Guid",e.guid),Lr(i,"isExternal",zu(e.isExternal)),cn(t,i,"ReferencedDocument",e.referencedDocument),cn(t,i,"Description",e.description),i}_exportRelatedTopic(t,e){const i=t.createElement("RelatedTopic");return i.setAttribute("Guid",e.guid),i}_exportTopic(t){const e=this._exportTopicData(t);return this._topic.bimSnippets&&this._topic.bimSnippets.forEach(i=>{e.appendChild(this._exportBimSnippet(t,i))}),this._topic.documentReferences&&this._topic.documentReferences.forEach(i=>{e.appendChild(this._exportDocumentReference(t,i))}),this._topic.relatedTopics&&this._topic.relatedTopics.forEach(i=>{e.appendChild(this._exportRelatedTopic(t,i))}),e}_exportComment(t,e){const i=t.createElement("Comment");i.setAttribute("Guid",e.getId()),Fr(t,i,"Date",e.getDate().toISOString()),Fr(t,i,"Author",e.getAuthor()),Fr(t,i,"Comment",e.getText()),cn(t,i,"ModifiedDate",Kc(e.getModifiedDate())),cn(t,i,"ModifiedAuthor",e.getModifiedAuthor());const n=e.getViewpointGuid();if(n){const r=t.createElement("Viewpoint");r.setAttribute("Guid",n),i.appendChild(r)}return i}_exportViewpoint(t,e){const i=t.createElement("Viewpoints");return i.setAttribute("Guid",e.getGuid()),cn(t,i,"Viewpoint",e.getViewpointFilename()),cn(t,i,"Snapshot",e.getSnapshotFilename()),cn(t,i,"Index",Bf(e.getIndex())),i}export(){const t=document.implementation.createDocument("","",null),e=t.createElement("Markup");return e.appendChild(this._exportHeader(t)),e.appendChild(this._exportTopic(t)),this._comments.forEach(i=>{e.appendChild(this._exportComment(t,i))}),this._viewpoints.forEach(i=>{e.appendChild(this._exportViewpoint(t,i))}),t.appendChild(e),t}getProjectGuid(){return this._projectGuid||null}getMarkupHeaderFiles(){return this._markupHeaderFiles}getFilename(){return this._filename}getTopicId(){return this._topic.guid}setTopicId(t){this._topic.guid=t}getTopicType(){return this._topic.topicType||null}setTopicType(t){this._topic.topicType=t!==null?t:void 0}getTopicStatus(){return this._topic.topicStatus||null}setTopicStatus(t){this._topic.topicStatus=t!==null?t:void 0}getTopicTitle(){return this._topic.title}setTopicTitle(t){this._topic.title=t}getTopicCreationDate(){return this._topic.creationDate}setTopicCreationDate(t){this._topic.creationDate=t}getTopicCreationAuthor(){return this._topic.creationAuthor}setTopicCreationAuthor(t){this._topic.creationAuthor=t}getTopicReferenceLink(){return this._topic.referenceLink||null}setTopicReferenceLink(t){this._topic.referenceLink=t===null?void 0:t}getTopicPriority(){return this._topic.priority||null}setTopicPriority(t){this._topic.priority=t===null?void 0:t}getTopicIndex(){return this._topic.index||null}setTopicIndex(t){this._topic.index=t===null?void 0:t}getTopicLabels(){return this._topic.labels===void 0?[]:this._topic.labels.slice()}setTopicLabels(t){this._topic.labels=t.slice()}getTopicModifiedDate(){return this._topic.modifiedDate||null}setTopicModifiedDate(t){this._topic.modifiedDate=t===null?void 0:t}getTopicModifiedAuthor(){return this._topic.modifiedAuthor||null}setTopicModifiedAuthor(t){this._topic.modifiedAuthor=t===null?void 0:t}getTopicDueDate(){return this._topic.dueDate||null}setTopicDueDate(t){this._topic.dueDate=t===null?void 0:t}getTopicAssignedTo(){return this._topic.assignedTo||null}setTopicAssignedTo(t){this._topic.assignedTo=t===null?void 0:t}getTopicDescription(){return this._topic.description||null}setTopicDescription(t){this._topic.description=t===null?void 0:t}getTopicStage(){return this._topic.stage||null}setTopicState(t){this._topic.stage=t===null?void 0:t}getComments(){return this._comments}addComment(t,e,i,n,r,o){const l=hs(),h=new zf(l,t,e,i,n,r,o);return this._comments.set(l,h),h}updateComment(t){const e=t.getId();this._comments.set(e,t)}deleteComment(t){this._comments.delete(t)}getViewpoints(){return this._viewpoints}_addFile(t){const e=this._getElementAttributes(t),i=this._getChildData(t),n=i.get("Date"),r={date:n===void 0?void 0:new Date(n),filename:i.get("Filename"),reference:i.get("Reference"),ifcProject:e.get("IfcProject"),ifcSpatialStructureElement:e.get("IfcSpatialStructureElement"),isExternal:e.get("isExternal")==="true"};this._markupHeaderFiles.push(new Xm(r.ifcProject,r.ifcSpatialStructureElement,r.isExternal,r.filename,r.date,r.reference))}_parseHeader(t){const i=this._getElementAttributes(t).get("ProjectGuid");i!==void 0&&(this._projectGuid=i);let n=t.firstElementChild;n!==null&&(this._addFile(n),n=n.nextElementSibling)}_parseTopic(t){const e=this._getElementAttributes(t),i=e.get("Guid");if(i===void 0)return;this._topic.guid=i,this._topic.topicType=e.get("TopicType")||e.get("Status"),this._topic.topicStatus=e.get("TopicStatus")||e.get("VerbalStatus");let n=t.firstElementChild;if(n!==null)for(;n!==null;){const r=n.localName;if(r===null)break;const o=this._getChildData(n),l=this._getElementAttributes(n);switch(r){case"BimSnippet":{this._topic.bimSnippets===void 0&&(this._topic.bimSnippets=[]);const h=o.get("Reference"),u=l.get("SnippetType");if(h!==void 0&&u!==void 0){const d={snippetType:u,reference:h};l.get("isExternal")&&(d.isExternal=l.get("isExternal")==="true"),o.get("ReferenceSchema")&&(d.referenceSchema=o.get("ReferenceSchema")),this._topic.bimSnippets.push(d)}}break;case"DocumentReference":{this._topic.documentReferences===void 0&&(this._topic.documentReferences=[]);const h={};o.get("Guid")&&(h.guid=o.get("Guid")),o.get("isExternal")&&(h.isExternal=o.get("isExternal")==="true"),o.get("Description")&&(h.description=o.get("Description")),o.get("ReferencedDocument")&&(h.referencedDocument=o.get("ReferencedDocument")),this._topic.documentReferences.push(h)}break;case"RelatedTopic":{this._topic.relatedTopics===void 0&&(this._topic.relatedTopics=[]);const h=o.get("Guid");if(h!==void 0){const u={guid:h};this._topic.relatedTopics.push(u)}}break;case"ReferenceLink":n.textContent&&(this._topic.referenceLink=n.textContent);break;case"Title":n.textContent&&(this._topic.title=n.textContent);break;case"Priority":n.textContent&&(this._topic.priority=n.textContent);break;case"Index":n.textContent&&(this._topic.index=parseInt(n.textContent,10));break;case"Labels":{let h=n.firstChild;if(!h)break;for(this._topic.labels===void 0&&(this._topic.labels=[]);h;)h.textContent&&this._topic.labels.push(h.textContent),h=h.nextSibling}break;case"CreationDate":n.textContent&&(this._topic.creationDate=new Date(n.textContent));break;case"CreationAuthor":n.textContent&&(this._topic.creationAuthor=n.textContent);break;case"ModifiedDate":n.textContent&&(this._topic.modifiedDate=new Date(n.textContent));break;case"ModifiedAuthor":n.textContent&&(this._topic.modifiedAuthor=n.textContent);break;case"DueDate":n.textContent&&(this._topic.dueDate=new Date(n.textContent));break;case"AssignedTo":n.textContent&&(this._topic.assignedTo=n.textContent);break;case"Description":n.textContent&&(this._topic.description=n.textContent);break;case"Stage":n.textContent&&(this._topic.stage=n.textContent);break}n=n.nextElementSibling}}_parseComment(t){let e="",i=new Date,n="",r="",o,l,h;const d=this._getElementAttributes(t).get("Guid");if(d)e=d;else return;let g=t.firstElementChild;if(g!==null)for(;g!==null;){const m=g.localName;if(m===null)break;switch(m){case"Date":g.textContent&&(i=new Date(g.textContent));break;case"Author":g.textContent&&(n=g.textContent);break;case"Comment":g.textContent&&(r=g.textContent);break;case"Viewpoint":o=this._getElementAttributes(g).get("Guid");break;case"ModifiedDate":g.textContent&&(l=new Date(g.textContent));break;case"ModifiedAuthor":g.textContent&&(h=g.textContent);break}g=g.nextElementSibling}const y=new zf(e,i,n,r,o,l,h);this._comments.set(e,y)}_parseViewpoint(t){const i=this._getElementAttributes(t).get("Guid");if(i!==void 0){const n=this._getChildData(t),r=n.get("Viewpoint"),o=n.get("Snapshot"),l=n.get("Index");this.addViewpoint(i,r,o,l)}}addViewpoint(t,e,i,n){this._viewpoints.set(t,new Jm(t,e,i,n))}_getChildData(t){const e=new Map;let i=t.firstElementChild;for(;i!==null;){const n=i.localName;let r=null;i.firstElementChild===null&&(r=i.textContent),n!==null&&r!==null&&e.set(n,r),i=i.nextElementSibling}return e}_getElementAttributes(t){const e=t.attributes,i=new Map;for(let n=0;n<e.length;++n){const r=e[n],o=r.name,l=r.value;i.set(o,l)}return i}}class pa{constructor(t,e){this._filename=t,this._data=e}static createFromImage(t,e){const i=pa.snapshotDataFromImage(e);return new pa(t,i)}getFilename(){return this._filename}getData(){return this._data}getUrl(){const t=new Blob([this._data],{type:"image/png"});return URL.createObjectURL(t,{oneTimeOnly:!0})}static snapshotDataFromImage(t){const e=t.src;return pa._convertDataURIToBinary(e)}static _convertDataURIToBinary(t){const e=";base64,",i=t.indexOf(e)+e.length,n=window.atob(t.substring(i)),r=new Uint8Array(n.length);for(let o=0;o<n.length;o++){const l=n[o].charCodeAt(0);r[o]=l}return r}}class uo{constructor(){this._behindView=!1}remove(t){}draw(t,e){}hit(t,e){return!1}hitWithTolerance(t,e,i){return!1}onSelect(t){}onDeselect(){}toJson(){return{}}getClassName(){return"Communicator.Markup.MarkupItem"}}class pl extends uo{constructor(t){super(),this._viewer=t}onDragStart(t,e){return!1}onDragMove(t,e){return!1}onDragEnd(t,e){return!1}remove(t){this._viewer.trigger("redlineDeleted",this)}}class Hf{constructor(){this._strokeWidth=1,this._strokeColor=vt.black()}_assign(t){this._strokeWidth=t._strokeWidth,this._strokeColor.assign(t._strokeColor)}setStrokeColor(t){this._strokeColor.assign(t)}getStrokeColor(){return this._strokeColor.copy()}setStrokeWidth(t){this._strokeWidth=t}getStrokeWidth(){return this._strokeWidth}}class ma extends Hf{constructor(){super(...arguments),this._fillColor=vt.black(),this._fillOpacity=1}_assign(t){super._assign(t),this._fillColor.assign(t._fillColor),this._fillOpacity=t._fillOpacity}getFillOpacity(){return this._fillOpacity}setFillOpacity(t){this._fillOpacity=t}setFillColor(t){this._fillColor.assign(t)}getFillColor(){return this._fillColor.copy()}}var gn=(s=>(s[s.None=0]="None",s[s.Arrowhead=1]="Arrowhead",s[s.Circle=2]="Circle",s))(gn||{});const Zm=9;class Xc extends Hf{constructor(){super(...arguments),this._startEndcapType=0,this._startEndcapColor=vt.black(),this._startEndcapSize=Zm,this._endEndcapType=0,this._endEndcapColor=vt.black(),this._endEndcapSize=Zm,this._endcapsInverted=!1}_assign(t){super._assign(t),this._startEndcapType=t._startEndcapType,this._startEndcapColor.assign(t._startEndcapColor),this._startEndcapSize=t._startEndcapSize,this._endEndcapType=t._endEndcapType,this._endEndcapColor.assign(t._endEndcapColor),this._endEndcapSize=t._endEndcapSize,this._endcapsInverted=t._endcapsInverted}getStartEndcapType(){return this._startEndcapType}setStartEndcapType(t){this._startEndcapType=t}getStartEndcapColor(){return this._startEndcapColor.copy()}setStartEndcapColor(t){this._startEndcapColor.assign(t)}getStartEndcapSize(){return this._startEndcapSize}setStartEndcapSize(t){this._startEndcapSize=t}getEndEndcapType(){return this._endEndcapType}setEndEndcapType(t){this._endEndcapType=t}setEndcapType(t){this._startEndcapType=t,this._endEndcapType=t}getEndEndcapSize(){return this._endEndcapSize}setEndEndcapSize(t){this._endEndcapSize=t}getEndEndcapColor(){return this._endEndcapColor.copy()}setEndEndcapColor(t){this._endEndcapColor.assign(t)}getEndcapsInverted(){return this._endcapsInverted}setEndcapsInverted(t){this._endcapsInverted=t}}class Br extends ma{constructor(){super(...arguments),this._center=K.zero(),this._radius=1}set(t,e){this._center.assign(t),this.setRadius(e)}getCenter(){return this._center.copy()}setCenter(t){this._center.assign(t)}getRadius(){return this._radius}setRadius(t){this._radius=t}}class Qm{constructor(t,e){this.center=t.copy(),this.radius=e}}class Uf extends ma{constructor(){super(...arguments),this._circles=[]}clear(){this._circles=[]}addCircle(t,e){this._circles.push(new Qm(t,e))}setCircle(t,e,i){const n=this._circles[t];n.center.assign(e),n.radius=i}getCircles(){return this._circles}}const Ea=class Ea extends pl{constructor(t){super(t),this._uniqueId=hs(),this._centerPt=_.zero(),this._radiusPt=_.zero(),this._circleShape=new Br,this._previousDragPlanePosition=_.zero(),this._circleShape.setFillOpacity(0),this._circleShape.setStrokeColor(vt.red()),this._circleShape.setStrokeWidth(2)}setCenter(t){this._centerPt.assign(t)}getCenter(){return this._centerPt.copy()}setRadiusPoint(t){this._radiusPt.assign(t)}getRadiusPoint(){return this._radiusPt.copy()}getUniqueId(){return this._uniqueId}_update(t){const e=K.fromPoint3(t.projectPoint(this._centerPt)),i=K.fromPoint3(t.projectPoint(this._radiusPt)),n=K.distance(e,i);this._circleShape.set(e,n)}draw(t,e){this._update(e),t.drawCircle(this._circleShape)}hit(t,e){return this.hitWithTolerance(t,e,0)}hitWithTolerance(t,e,i){this._update(e);const n=this._circleShape.getStrokeWidth()+i,r=K.distance(this._circleShape.getCenter(),t)-this._circleShape.getRadius();return Math.abs(r)<=n}onSelect(){this._circleShape.setStrokeWidth(4)}onDeselect(){this._circleShape.setStrokeWidth(2)}isValid(){return this._circleShape.getRadius()>Ea._validRadiusTolerance}onDragStart(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return i!==null&&this._previousDragPlanePosition.assign(i),!1}onDragMove(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);if(i!==null){const n=_.subtract(i,this._previousDragPlanePosition);this._centerPt.add(n),this._radiusPt.add(n),this._previousDragPlanePosition.assign(i)}return!0}toJson(){return this._toJson()}_toJson(){return{uniqueId:this._uniqueId,centerPoint:this._centerPt.toJson(),radiusPoint:this._radiusPt.toJson(),className:this.getClassName()}}static fromJson(t,e){const i=t,n=new Ea(e);return n._uniqueId=i.uniqueId,n.setCenter(_.fromJson(i.centerPoint)),n.setRadiusPoint(_.fromJson(i.radiusPoint)),n}getClassName(){return Ea.className}};Ea.className="Communicator.Markup.Redline.RedlineCircle",Ea._validRadiusTolerance=1;let _a=Ea;ss(_a.className,_a.fromJson);class ya extends Xc{constructor(){super(...arguments),this._points=[]}clearPoints(){this._points=[]}getPoints(){return this._points}pushPoint(t){this._points.push(t.copy())}}class fb extends Xc{constructor(){super(...arguments),this._polylines=[]}clear(){this._polylines=[]}createPolyline(){const t=[];return this._polylines.push(t),t}getPolylines(){return this._polylines}}const mh=class mh extends pl{constructor(t){super(t),this._uniqueId=hs(),this._points=[],this._polylineShape=new ya,this._previousDragPlanePosition=_.zero(),this._polylineShape.setStrokeWidth(2),this._polylineShape.setStrokeColor(vt.red())}addPoint(t){this._points.push(t.copy())}getPoints(){const t=[];return this._points.forEach(e=>{t.push(e.copy())}),t}_update(t){this._polylineShape.clearPoints();for(const e of this._points){const i=K.fromPoint3(t.projectPoint(e));this._polylineShape.pushPoint(i)}}draw(t,e){this._update(e),this.isValid()&&t.drawPolyline(this._polylineShape)}hit(t,e){return this.hitWithTolerance(t,e,0)}hitWithTolerance(t,e,i){this._update(e);const n=this._polylineShape.getStrokeWidth()+i,r=this._polylineShape.getPoints();if(r.length>1){for(let o=1;o<r.length;o++)if(Wa(t,r[o-1],r[o],n))return!0}return!1}onSelect(){this._polylineShape.setStrokeWidth(4)}onDeselect(){this._polylineShape.setStrokeWidth(2)}getClassName(){return mh.className}isValid(){return this._points.length>1}onDragStart(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return i!==null&&this._previousDragPlanePosition.assign(i),!1}onDragMove(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);if(i!==null){const n=_.subtract(i,this._previousDragPlanePosition);for(const r of this._points)r.add(n);this._polylineShape.clearPoints(),this._previousDragPlanePosition.assign(i)}return!0}toJson(){return this._toJson()}_toJson(){const t=[];for(const e of this._points)t.push(e.toJson());return{uniqueId:this._uniqueId,points:t}}static fromJson(t,e){const i=t,n=new mh(e);n._uniqueId=i.uniqueId;for(const r of i.points)n.addPoint(_.fromJson(r));return n}};mh.className="Communicator.Markup.Redline.RedlinePolyline";let wa=mh;ss(wa.className,wa.fromJson);class ju extends ma{constructor(){super(...arguments),this._borderRadius=0}_assign(t){super._assign(t),this._borderRadius=t._borderRadius}getBorderRadius(){return this._borderRadius}setBorderRadius(t){this._borderRadius=t}}class Wu extends ju{constructor(t,e){super(),this._position=K.zero(),this._size=K.zero(),t&&this._position.assign(t),e&&this._size.assign(e)}_assign(t){super._assign(t),this._position.assign(t._position),this._size.assign(t._size)}setPosition(t){this._position.assign(t)}getPosition(){return this._position.copy()}setSize(t){this._size.assign(t)}getSize(){return this._size.copy()}}class t_{constructor(t,e){this.position=t.copy(),this.size=e.copy()}}class gb extends ju{constructor(){super(...arguments),this._rectangles=[]}clear(){this._rectangles=[]}addRectangle(t,e){this._rectangles.push(new t_(t,e))}getRectangles(){return this._rectangles}}const Wo=class Wo extends pl{constructor(t){super(t),this._uniqueId=hs(),this._point1=_.zero(),this._point2=_.zero(),this._rectangleShape=new Wu,this._previousDragPlanePosition=_.zero(),this._rectangleShape.setFillOpacity(0),this._rectangleShape.setStrokeColor(vt.red()),this._rectangleShape.setStrokeWidth(2)}setPoint1(t){this._point1.assign(t)}getPoint1(){return this._point1.copy()}setPoint2(t){this._point2.assign(t)}getPoint2(){return this._point2.copy()}getUniqueId(){return this._uniqueId}_update(t){const e=t.projectPoint(this._point1),i=t.projectPoint(this._point2),n=new K(Math.min(e.x,i.x),Math.min(e.y,i.y)),r=new K(Math.max(e.x,i.x),Math.max(e.y,i.y)),o=K.subtract(r,n);this._rectangleShape.setPosition(n),this._rectangleShape.setSize(o)}draw(t,e){this._update(e),t.drawRectangle(this._rectangleShape)}hit(t,e){return this.hitWithTolerance(t,e,0)}hitWithTolerance(t,e,i){this._update(e);const n=this._rectangleShape.getStrokeWidth()+i,r=this._rectangleShape.getPosition(),o=this._rectangleShape.getSize(),l=r,h=new K(r.x+o.x,l.y),u=new K(r.x,r.y+o.y),d=new K(r.x+o.x,r.y+o.y);return Wa(t,l,h,n)||Wa(t,h,d,n)||Wa(t,d,u,n)?!0:!!Wa(t,u,l,n)}onSelect(){this._rectangleShape.setStrokeWidth(4)}onDeselect(){this._rectangleShape.setStrokeWidth(2)}isValid(){const t=this._rectangleShape.getSize();return t.x>Wo._validSizeTolerance.x&&t.y>Wo._validSizeTolerance.y}onDragStart(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return i!==null&&this._previousDragPlanePosition.assign(i),!1}onDragMove(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);if(i!==null){const n=_.subtract(i,this._previousDragPlanePosition);this._point1.add(n),this._point2.add(n),this._previousDragPlanePosition.assign(i)}return!0}toJson(){return this._toJson()}_toJson(){return{uniqueId:this._uniqueId,className:this.getClassName(),point1:this._point1.toJson(),point2:this._point2.toJson()}}static fromJson(t,e){const i=t,n=new Wo(e);return n._uniqueId=i.uniqueId,n.setPoint1(_.fromJson(i.point1)),n.setPoint2(_.fromJson(i.point2)),n}getClassName(){return Wo.className}};Wo.className="Communicator.Markup.Redline.RedlineRectangle",Wo._validSizeTolerance=new K(5,5);let va=Wo;ss(va.className,va.fromJson);const Bl=class Bl{constructor(t,e){this._sizeChanged=!1,this._sizeUpdateCallback=t,this._textUpdateCallback=e,this._createTextBox()}_createTextBox(){this._currentSize=Bl._defaultSize.copy(),this._textArea=document.createElement("textarea"),this._textArea.style.position="absolute",this._textArea.style.width=`${Bl._defaultSize.x}px`,this._textArea.style.height=`${Bl._defaultSize.y}px`,this._textArea.style.zIndex="1",this._textArea.style.pointerEvents="none",this._textArea.style.resize="none",this._textArea.style.letterSpacing="1px",this.setBorderWidth(2),this._textArea.onmousemove=e=>{e.stopPropagation();const i=new K(parseInt(this._textArea.style.width,10),parseInt(this._textArea.style.height,10));this.setSize(i)},this._textArea.onmouseup=e=>{e.stopPropagation(),this._sizeChanged&&(this._sizeChanged=!1,this._sizeUpdateCallback(this._currentSize))};const t=()=>{this._textUpdateCallback(this._textArea.value)};this._textArea.oninput=t}setPosition(t){this._textArea.style.left=`${t.x}px`,this._textArea.style.top=`${t.y}px`}setBorderWidth(t){this._textArea.style.outline=`${t}px solid red`}setText(t){this._textArea.textContent=t}setSize(t){this._currentSize.equals(t)||(this._sizeChanged=!0,this._currentSize.assign(t),this._textArea.style.width=`${t.x}px`,this._textArea.style.height=`${t.y}px`)}focus(){this._textArea.focus(),this._textArea.style.pointerEvents="auto",this._textArea.style.resize="both"}blur(){this._textArea.blur(),this._textArea.style.pointerEvents="none",this._textArea.style.resize="none"}getTextArea(){return this._textArea}};Bl._defaultSize=new K(100,100);let Gu=Bl;const Aa=class Aa extends pl{constructor(t,e=Aa.defaultText){super(t),this._uniqueId=hs(),this._position=_.zero(),this._size=new K(100,100),this._redlineTextElements=new Map,this._previousDragPlanePosition=_.zero(),this._callbacks=null,this._text=e}setPosition(t){this._position.assign(t)}getPosition(){return this._position.copy()}setSize(t){this._size.assign(t),this._redlineTextElements.forEach(e=>{e.element.setSize(t)}),this._viewer.trigger("redlineUpdated",this)}getSize(){return this._size.copy()}setText(t){this._text=t,this._redlineTextElements.forEach(e=>{e.element.setText(t)}),this._viewer.trigger("redlineUpdated",this)}getText(){return this._text}registerCallback(){this._callbacks===null&&(this._callbacks={selectionArray:()=>{this.onDeselect()}},this._viewer.setCallbacks(this._callbacks))}unregisterCallback(){this._callbacks!==null&&(this._viewer.unsetCallbacks(this._callbacks),this._callbacks=null)}createTextElement(){const t=n=>{this.setSize(n)},e=n=>{this.setText(n)},i=new Gu(t,e);return i.setText(this._text),this.registerCallback(),i}draw(t,e){const i=K.fromPoint3(e.projectPoint(this._position));let n=this._redlineTextElements.get(e);if(!n){const r=this.createTextElement(),o=this._viewer.markupManager.addMarkupElement(r.getTextArea(),e);n={id:o,element:r},this._redlineTextElements.set(e,{id:o,element:r})}n.element.setPosition(i)}hit(t,e){return this.hitWithTolerance(t,e,0)}hitWithTolerance(t,e,i){const n=this._redlineTextElements.get(e);if(!n)return!1;const r=n.element.getTextArea(),o=new K(parseFloat(r.style.left||"0"),parseFloat(r.style.top||"0")),l=new K(parseFloat(r.style.width||"0"),parseFloat(r.style.height||"0"));return ef(t,o,l,i)}getClassName(){return Aa.className}onSelect(t){const e=this._redlineTextElements.get(t);e&&(e.element.setBorderWidth(4),e.element.focus())}onDeselect(){this._redlineTextElements.forEach(t=>{t.element.setBorderWidth(2),t.element.blur()})}isValid(){return this._text.length>0}remove(t){const e=[];t?e.push(t):e.push(...this._redlineTextElements.keys());for(let i of e){const n=this._redlineTextElements.get(i);n&&(this._viewer.markupManager.removeMarkupElement(n.id,i),this._redlineTextElements.delete(i),this._redlineTextElements.size===0&&this.unregisterCallback())}super.remove(t)}onDragStart(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return i!==null&&this._previousDragPlanePosition.assign(i),!1}onDragMove(t,e){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);if(i!==null){const n=_.subtract(i,this._previousDragPlanePosition),r=this.getPosition();r.add(n),this.setPosition(r),this._previousDragPlanePosition.assign(i)}return!0}toJson(){return this._toJson()}_toJson(){return{uniqueId:this._uniqueId,className:this.getClassName(),position:this._position.toJson(),size:this._size.toJson(),text:this._text}}static fromJson(t,e){const i=t,n=new Aa(e,i.text);return n._uniqueId=i.uniqueId,n.setPosition(_.fromJson(i.position)),n.setSize(K.fromJson(i.size)),n}};Aa.className="Communicator.Markup.Redline.RedlineText",Aa.defaultText="Type Here...";let Fo=Aa;ss(Fo.className,Fo.fromJson);const pb=Object.freeze(Object.defineProperty({__proto__:null,RedlineCircle:_a,RedlinePolyline:wa,RedlineRectangle:va,RedlineText:Fo,RedlineTextElement:Gu},Symbol.toStringTag,{value:"Module"})),_h=class _h extends uo{constructor(t,e=null,i=null,n=null,r=null){super(),this._uniqueId=hs(),this._lineMeshId=null,this._lineMeshInstanceId=null,this._lineColor=vt.red(),this._lineOpacity=1,this._linePattern=null,this._linePatternLength=null,this._linePatternLengthUnit=null,this._viewer=t,this._firstPoint=e,this._secondPoint=i,this._firstNodeId=n,this._secondNodeId=r}setLineColor(t){this._lineColor=t}getLineColor(){return this._lineColor}setLineOpacity(t){this._lineOpacity=t}getLineOpacity(){return this._lineOpacity}setLinePattern(t,e,i){this._linePattern=t,this._linePatternLength=e,this._linePatternLengthUnit=i}getLinePattern(){return this._linePattern!==void 0?this._linePattern:null}getLinePatternLength(){return this._linePatternLength!==void 0?this._linePatternLength:null}getLinePatternLengthUnit(){return this._linePatternLengthUnit!==void 0?this._linePatternLengthUnit:null}setFirstPoint(t){this._firstPoint=t}getFirstPoint(){return this._firstPoint}setSecondPoint(t){this._secondPoint=t}getSecondPoint(){return this._secondPoint}setFirstNodeId(t){this._firstNodeId=t}getFirstNodeId(){return this._firstNodeId}setSecondNodeId(t){this._secondNodeId=t}getSecondNodeId(){return this._secondNodeId}getNodeId(){return this._lineMeshInstanceId}async removeLine(){const t=this._viewer.model;this._lineMeshInstanceId!==null&&(await t.deleteMeshInstances([this._lineMeshInstanceId]),this._lineMeshInstanceId=null,this._lineMeshId!==null&&(await t.deleteMeshes([this._lineMeshId]),this._lineMeshId=null))}async updateLine(){if(await this.removeLine(),this._firstPoint!==null&&this._secondPoint!==null){const t=new rs;t.addPolyline([this._firstPoint.x,this._firstPoint.y,this._firstPoint.z,this._secondPoint.x,this._secondPoint.y,this._secondPoint.z]);const e=this._viewer.model,i=await e.createMesh(t);this._lineMeshId=i;const n=new Ns(i);n.setLineColor(this._lineColor),n.setLineOpacity(this._lineOpacity),n.setCreationFlags(ie.ExcludeBounding);const r=await e.createMeshInstance(n);this._linePattern!==null&&e.setNodesLinePattern([r],this._linePattern,this._linePatternLength,this._linePatternLengthUnit),this._lineMeshInstanceId=r}}getId(){return this._uniqueId}setId(t){this._uniqueId=t}getClassName(){return _h.className}_toJson(){return{className:this.getClassName(),uniqueId:this._uniqueId,firstPoint:this.getFirstPoint(),secondPoint:this.getSecondPoint(),firstNodeId:this.getFirstNodeId(),secondNodeId:this.getSecondNodeId(),lineColor:this.getLineColor(),lineOpacity:this.getLineOpacity(),linePattern:this.getLinePattern(),linePatternLength:this.getLinePatternLength(),linePatternLengthUnit:this.getLinePatternLengthUnit()}}toJson(){return this._toJson()}static async fromJson(t,e){const i=t,n=new _h(e,_.fromJson(i.firstPoint),_.fromJson(i.secondPoint),i.firstNodeId,i.secondNodeId);return n.setId(i.uniqueId),n.setLineColor(vt.fromJson(i.lineColor)),n.setLineOpacity(i.lineOpacity),i.linePattern!=null&&i.linePatternLength!=null&&i.linePatternLengthUnit!=null&&n.setLinePattern(i.linePattern,i.linePatternLength,i.linePatternLengthUnit),n}};_h.className="Communicator.Markup.Line.LineMarkup";let ba=_h;ss(ba.className,ba.fromJson);const mb=Object.freeze(Object.defineProperty({__proto__:null,LineMarkup:ba},Symbol.toStringTag,{value:"Module"}));class ml{constructor(t,e,i,n,r,o){this._version=Ys.Unknown,this._components={},this._lines=[],this._clippingPlanes=[],this._viewer=o,this._filename=t,this._version=i,this._modelBounding=n,this._unitScale=1e3/r,this._parseDocument(e)}static async createViewpoint(t,e,i=null){const n=j=>{const V=[];return j.forEach(Y=>{let q=null;for(;Y!==null&&q===null;)q=r.getNodeGenericId(Y),Y=r.getNodeParent(Y);V.push(q)}),console.assert(j.length===V.length),V},r=t.model,o=r.getAbsoluteRootNode(),l=await r.getVisibilityState(o),h=await r.getNodeColorMap(o,an.Faces),u=await r.getModelBounding(!0,!1),d=r.getNodeUnitMultiplier(o),g=new ml(e,null,Ys.v2_1,u,d,t),y=l.defaultVisibility;g.setDefaultVisibility(y);const m=l.visibilityExceptions,I=[];m.forEach(j=>{I.push(j)});const b=[],x=n(I);for(let j=0;j<x.length;j++){const V=x[j];let Y;V!==null?Y=r.getNodeIdsByGenericIds([V]):Y=[I[j]];for(const q of Y){const st=await r.getVisibilityState(q),ft={genericId:V,nodeId:q};y?st.visibilityExceptions.size===0&&b.push(ft):(st.visibilityExceptions.size!==0||st.defaultVisibility)&&b.push(ft)}}g.setVisibilityExceptionNodes(b);const P=t.selectionManager.getResults().map(j=>j.getNodeId()),k=n(P),O=[];for(let j=0;j<P.length;j++){const V={genericId:k[j],nodeId:P[j]};O.push(V)}g.setSelectionNodes(O);const B=new Map;if(h.size>0&&h.forEach((j,V)=>{const Y=r.getNodeParent(V);if(Y===null)return;const q=r.getNodeGenericId(Y);let st=B.get(j);st===void 0&&(st=new Set,B.set(j,st)),st.add({genericId:q,nodeId:V})}),g.setColorNodes(B),g.setCamera(t.view.getCamera()),i!==null){const j=ml._markupRedlineToBcf(i.getMarkup(),t.view);g.setLines(j)}return g}static _markupRedlineToBcf(t,e){const r=d=>{const g=e.projectPoint(d);return e.unprojectPoint(K.fromPoint3(g),0)},o=(d,g,y)=>{const m=Math.PI*2/y,I=[];for(let b=0;b<=y;b++){const x=b*m;I.push(new K(d.x+Math.cos(x)*g,d.y+Math.sin(x)*g))}return I},l=d=>{for(let g=0;g<d.length-1;++g){const y=d[g],m=d[g+1];if(y!==null&&m!==null){const I=[y.copy().scale(.001),m.copy().scale(.001)];u.push(I)}}},h=d=>{for(let g=0;g<d.length;++g){const y=d[g],m=d[(g+1)%d.length];if(y!==null&&m!==null){const I=[y.copy().scale(.001),m.copy().scale(.001)];u.push(I)}}},u=[];return t.forEach(d=>{if(d instanceof wa){const y=d.getPoints().map(r);l(y)}else if(d instanceof _a){const g=d.getCenter(),y=d.getRadiusPoint(),m=K.fromPoint3(e.projectPoint(g)),I=K.fromPoint3(e.projectPoint(y)),b=K.subtract(I,m).length(),C=o(m,b,40).map(P=>e.unprojectPoint(P,0));h(C)}else if(d instanceof va){const g=d.getPoint1(),y=d.getPoint2(),m=K.fromPoint3(e.projectPoint(g)),I=K.fromPoint3(e.projectPoint(y)),b=[];b.push(e.unprojectPoint(m,0)),b.push(e.unprojectPoint(new K(m.x,I.y),0)),b.push(e.unprojectPoint(I,0)),b.push(e.unprojectPoint(new K(I.x,m.y),0)),h(b)}}),u}_parseDocument(t){if(t===null)return;const e=t.documentElement,i=e.attributes.getNamedItem("Guid");i!==null&&(this._viewpointGuid=i.value);let n=e.firstElementChild;for(;n!==null;){const r=n.localName;if(r===null)break;switch(r){case"Components":this._version>=Ys.v2_1?this._parseComponents(n):this._parseComponentsV2_0(n);break;case"OrthogonalCamera":this._parseOrthogonalCamera(n);break;case"PerspectiveCamera":this._parsePerspectiveCamera(n);break;case"Lines":this._parseLines(n);break;case"ClippingPlanes":this._parseClippingPlanes(n);break}n=n.nextElementSibling}}_exportComponents(t){const e=t.createElement("Components"),i=t.createElement("ViewSetupHints"),n=this._components.viewSetupHints;n&&(e.setAttribute("SpacesVisible",qc(n.spacesVisible)),e.setAttribute("SpaceBoundariesVisible",qc(n.spaceBoundariesVisible)),e.setAttribute("OpeningsVisible",qc(n.openingsVisible))),e.appendChild(i);const r=t.createElement("Selection"),o=this._components.selection;o&&o.forEach(y=>{r.appendChild(Bu(t,y))}),e.appendChild(r);const l=t.createElement("Visibility"),h=this._components.defaultVisibility,u=this._components.visibilityExceptions;if(h!==void 0&&u!==void 0){l.setAttribute("DefaultVisibility",qc(h));const y=t.createElement("Exceptions");u.forEach(m=>{y.appendChild(Bu(t,m))}),l.appendChild(y)}e.appendChild(l);const d=t.createElement("Coloring"),g=this._components.coloring;return g&&g.forEach(y=>{const m=t.createElement("Color");m.setAttribute("Color",$m(y.color,y.alpha)),y.components.forEach(I=>{m.appendChild(Bu(t,I))}),d.appendChild(m)}),e.appendChild(d),e}_exportOrthogonalCamera(t,e){const i=t.createElement("OrthogonalCamera"),n=t.createElement("CameraViewPoint"),r=t.createElement("CameraDirection"),o=t.createElement("CameraUpVector");mr(t,n,e.cameraViewPoint),mr(t,r,e.cameraDirection),mr(t,o,e.cameraUpVector);const l=t.createElement("ViewToWorldScale");return l.innerHTML=e.viewToWorldScale.toString(),i.appendChild(n),i.appendChild(r),i.appendChild(o),i.appendChild(l),i}_exportPerspectiveCamera(t,e){const i=t.createElement("PerspectiveCamera"),n=t.createElement("CameraViewPoint"),r=t.createElement("CameraDirection"),o=t.createElement("CameraUpVector");mr(t,n,e.cameraViewPoint),mr(t,r,e.cameraDirection),mr(t,o,e.cameraUpVector);const l=t.createElement("FieldOfView");return l.innerHTML=e.fieldOfView.toString(),i.appendChild(n),i.appendChild(r),i.appendChild(o),i.appendChild(l),i}_exportLines(t){const e=t.createElement("Lines");return this._lines.forEach(i=>{const n=t.createElement("Line"),r=t.createElement("StartPoint"),o=t.createElement("EndPoint");mr(t,r,i.startPoint),mr(t,o,i.endPoint),n.appendChild(r),n.appendChild(o),e.appendChild(n)}),e}_exportClippingPlanes(t){const e=t.createElement("ClippingPlanes");return this._clippingPlanes.forEach(i=>{const n=t.createElement("ClippingPlane"),r=t.createElement("Location"),o=t.createElement("Direction");mr(t,r,i.location),mr(t,o,i.direction),n.appendChild(r),n.appendChild(o),e.appendChild(n)}),e}export(){const t=document.implementation.createDocument("","",null),e=t.createElement("VisualizationInfo");return e.appendChild(this._exportComponents(t)),this._viewpointGuid!==void 0&&e.setAttribute("Guid",this._viewpointGuid),this._orthogonalCamera?e.appendChild(this._exportOrthogonalCamera(t,this._orthogonalCamera)):this._perspectiveCamera&&e.appendChild(this._exportPerspectiveCamera(t,this._perspectiveCamera)),this._lines.length>0&&e.appendChild(this._exportLines(t)),this._clippingPlanes.length>0&&e.appendChild(this._exportClippingPlanes(t)),t.appendChild(e),t}async activate(){await this._activateCamera(),await this._activateComponentsVisibility(),await this._activateMarkup(),await this._activateCuttingPlanes(),this._activateSelected(),await this._activateColors()}async _activateCamera(){const t=this.getCamera();t!==null&&await this._viewer.view._setCameraPromise(t,800)}async _activateComponentsVisibility(){const t=this._viewer.model,e=this._getDefaultVisibility(),i=this.getVisibilityExceptionNodes();i.length?(await t.setNodesVisibility([-2],e),await t.setNodesVisibility(i,!e)):await t.reset()}async _activateMarkup(){const t=this._viewer.lineManager;await t.removeAllLines();const e=[];for(let i=0;i<this._lines.length;++i){const n=this._lines[i],r=new ba(this._viewer,n.startPoint.copy().scale(1e3),n.endPoint.copy().scale(1e3));e.push(t.addLine(r))}await Promise.all(e)}async _activateCuttingPlanes(){const e=await this._viewer.model.getModelBounding(!0,!1),i=this._viewer.cuttingManager;await i.clearAllCuttingSections();for(let n=0;n<this._clippingPlanes.length;++n){const r=i.getCuttingSection(n);await r.clear();const o=this._clippingPlanes[n],l=o.location.copy().scale(1e3),h=o.direction.normalize(),u=Ki.createFromPointAndNormal(l,h),d=i.createReferenceGeometryFromFaceNormal(h,l,e);await r.addPlane(u,d)}await i.activateCuttingSections()}_activateSelected(){const t=this._getNodeIdsFromComponents(this._components.selection);this._viewer.selectionManager.clear(),t.forEach(e=>{this._viewer.selectionManager.selectNode(e,fn.Add)})}async _activateColors(){const t=this._viewer.model,e=t.getAbsoluteRootNode();if(t.unsetNodesFaceColor([e]),t.unsetNodesLineColor([e]),this._components.coloring!==void 0){const i=new Map;for(let n=0;n<this._components.coloring.length;++n){const r=this._components.coloring[n];this._getNodeIdsFromComponents(r.components).forEach(l=>{i.set(l,r.color)})}await this._viewer.model.setNodesColors(i)}}getFilename(){return this._filename}getViewpointGuid(){return this._viewpointGuid||null}_fromBCFPerspectiveCamera(t,e){const i=new dn;i.setProjection(ti.Perspective);const n=t.cameraViewPoint.copy().scale(this._unitScale),r=t.cameraDirection.copy().normalize().scale(e),o=_.add(n,r),l=t.cameraUpVector.copy().normalize();i.setPosition(n),i.setTarget(o),i.setUp(l);const h=Zr(t.fieldOfView),u=Math.tan(h/2),g=2*_.subtract(i.getTarget(),i.getPosition()).length()*u;return i.setWidth(g),i.setHeight(g),i}_fromBCFOrthogonalCamera(t,e){const i=new dn;i.setProjection(ti.Orthographic);const n=t.cameraViewPoint.copy().scale(this._unitScale),r=t.cameraDirection.copy().normalize().scale(e),o=_.add(n,r),l=t.cameraUpVector.copy().normalize();i.setPosition(n),i.setTarget(o),i.setUp(l);const h=t.viewToWorldScale*this._unitScale*2;return i.setWidth(h),i.setHeight(h),i}getCamera(){const t=this._modelBounding.extents().length();return this._perspectiveCamera?this._fromBCFPerspectiveCamera(this._perspectiveCamera,t/40):this._orthogonalCamera?this._fromBCFOrthogonalCamera(this._orthogonalCamera,t):null}setCamera(t){t.getProjection()===ti.Perspective?(this._perspectiveCamera=this._toBCFPerspectiveCamera(t),this._orthogonalCamera=void 0):(this._orthogonalCamera=this._toBCFOrthogonalCamera(t),this._perspectiveCamera=void 0)}_toBCFOrthogonalCamera(t){const e=t.getPosition(),i=t.getTarget(),n=_.subtract(i,e).normalize(),r=t.getUp().normalize(),o=e.copy().scale(1/this._unitScale),h=t.getWidth()/(this._unitScale*2);return{cameraDirection:n,cameraUpVector:r,cameraViewPoint:o,viewToWorldScale:h}}_toBCFPerspectiveCamera(t){const e=t.getPosition(),i=t.getTarget(),n=_.subtract(i,e).normalize(),r=t.getUp().normalize(),o=e.copy().scale(1/this._unitScale),l=t.getWidth(),h=_.subtract(t.getTarget(),t.getPosition()).length(),u=l/(2*h),d=Math.atan(u)*2,g=Xh(d);return{cameraDirection:n,cameraUpVector:r,cameraViewPoint:o,fieldOfView:g}}setDefaultVisibility(t){this._components.defaultVisibility=t}_getDefaultVisibility(){return this._components.defaultVisibility!==void 0?this._components.defaultVisibility:!0}setVisibilityExceptions(t){const e=t.map(i=>{const n=this._viewer.model.getNodeIdsByGenericIds([i]),r=n.length!==0?n[0]:void 0;return{ifcGuid:i,authoringToolId:r,originatingSystem:Rr}});this._components.visibilityExceptions=e}setVisibilityExceptionNodes(t){const e=t.map(i=>({ifcGuid:i.genericId!==null?i.genericId:void 0,authoringToolId:i.nodeId,originatingSystem:Rr}));this._components.visibilityExceptions=e}getVisibilityExceptions(){return this._getGenericIdsFromComponents(this._components.visibilityExceptions)}getVisibilityExceptionNodes(){return this._getNodeIdsFromComponents(this._components.visibilityExceptions)}setColors(t){const e=[];t.forEach((i,n)=>{const r=[];i.forEach(l=>{const h=this._viewer.model.getNodeIdsByGenericIds([l]),u=h.length!==0?h[0]:void 0;r.push({ifcGuid:l,authoringToolId:u,originatingSystem:Rr})});const o={color:n,components:r};e.push(o)}),this._components.coloring=e}setColorNodes(t){const e=[];t.forEach((i,n)=>{const r=[];i.forEach(l=>{const h=l.genericId!==null?l.genericId:void 0;r.push({ifcGuid:h,authoringToolId:l.nodeId,originatingSystem:Rr})});const o={color:n,components:r};e.push(o)}),this._components.coloring=e}getColors(){const t=new Map,e=this._components.coloring;return e!==void 0&&e.forEach(i=>{const n=i.color.copy(),r=new Set;i.components.map(o=>{o.ifcGuid!==void 0&&r.add(o.ifcGuid)}),t.set(n,r)}),t}getColorsToNodes(){const t=new Map,e=this._components.coloring;return e!==void 0&&e.forEach(i=>{const n=i.color.copy(),r=new Set;i.components.map(o=>{o.authoringToolId!==void 0&&o.originatingSystem===Rr&&r.add(o.authoringToolId)}),t.set(n,r)}),t}setLines(t){this._lines=[],t.forEach(e=>{const i={startPoint:e[0].copy(),endPoint:e[1].copy()};this._lines.push(i)})}getLines(){const t=[];return this._lines.forEach(e=>{t.push([e.startPoint.copy(),e.endPoint.copy()])}),t}setClippingPlanes(t){this._clippingPlanes=[],t.forEach(e=>{const i={location:e[0].copy(),direction:e[1].copy()};this._clippingPlanes.push(i)})}getClippingPlanes(){const t=[];return this._clippingPlanes.forEach(e=>{t.push([e.location.copy(),e.direction.copy()])}),t}setSelection(t){const e=t.map(i=>{const n=this._viewer.model.getNodeIdsByGenericIds([i]),r=n.length!==0?n[0]:void 0;return{ifcGuid:i,authoringToolId:r,originatingSystem:Rr}});this._components.selection=e}setSelectionNodes(t){const e=t.map(i=>({ifcGuid:i.genericId!==null?i.genericId:void 0,authoringToolId:i.nodeId,originatingSystem:Rr}));this._components.selection=e}getSelection(){const t=[],e=this._components.selection;return e!==void 0&&e.forEach(i=>{i.ifcGuid&&t.push(i.ifcGuid)}),t}getSelectionNodes(){const t=[],e=this._components.selection;return e!==void 0&&e.forEach(i=>{i.authoringToolId!==void 0&&i.originatingSystem===Rr&&t.push(i.authoringToolId)}),t}_getGenericIdsFromComponents(t){if(!t)return[];const e=[];for(let i=0;i<t.length;++i){const n=t[i];n.ifcGuid!==void 0&&e.push(n.ifcGuid)}return e}_getNodeIdsFromComponents(t){if(!t)return[];const e=new Set,i=[];for(let r=0;r<t.length;++r){const o=t[r];o.authoringToolId!==void 0&&o.originatingSystem===Rr?e.add(o.authoringToolId):o.ifcGuid!==void 0&&i.push(o.ifcGuid)}const n=this._viewer.model.getNodeIdsByGenericIds(i);for(const r of n)e.add(r);return Array.from(e)}_parseComponentsV2_0(t){console.assert(this._version<=Ys.v2_0);const e=[],i=[],n=[];let r=!0,o=t.firstElementChild;for(;o!==null;){const l=o.localName;if(l===null)break;switch(l){case"Component":{const h=o.attributes,u=h.getNamedItem("IfcGuid"),d=h.getNamedItem("Selected"),g=h.getNamedItem("Visible"),y=h.getNamedItem("Color");if(u!==null&&u.value){const I={ifcGuid:u.value};if(d!==null&&d.value==="true"&&e.push(I),r=!1,g!==null&&g.value==="false"||i.push(I),y!==null&&y.value){const b=y.value;n.push(this._colorFromArgb(b,[I]))}}}break}o=o.nextElementSibling}this._components={defaultVisibility:r,selection:e,visibilityExceptions:i,coloring:n}}_parseComponents(t){console.assert(this._version>=Ys.v2_1);let e=t.firstElementChild;const i={spacesVisible:!1,spaceBoundariesVisible:!1,openingsVisible:!1};let n=[],r=!0,o=[],l=[];for(;e!==null;){const h=e.localName;if(h===null)break;const u=e.attributes;switch(h){case"ViewSetupHints":{const d=u.getNamedItem("SpacesVisible"),g=u.getNamedItem("SpaceBoundariesVisible"),y=u.getNamedItem("OpeningsVisible");d!==null&&(i.spacesVisible=d.value==="true"),g!==null&&(i.spaceBoundariesVisible=g.value==="true"),y!==null&&(i.openingsVisible=y.value==="true")}break;case"Selection":n=this._getComponents(e);break;case"Visibility":{const d=u.getNamedItem("DefaultVisibility");d&&(r=d.value==="true");const g=e.firstElementChild;g!==null&&(o=this._getComponents(g))}break;case"Coloring":l=this._getColoring(e);break}e=e.nextElementSibling}this._components={viewSetupHints:i,selection:n,defaultVisibility:r,visibilityExceptions:o,coloring:l}}_getCameraData(t){const e=[];let i=t.firstElementChild;for(;i!==null;)switch(i.nodeName){case"FieldOfView":case"ViewToWorldScale":{const n=i.textContent;n!==null&&e.push(parseFloat(n)),i=null}break;default:e.push(this._getPoint(i)),i=i.nextElementSibling}return e}_parseOrthogonalCamera(t){const e=this._getCameraData(t);e.length===4&&(this._orthogonalCamera={cameraViewPoint:e[0],cameraDirection:e[1],cameraUpVector:e[2],viewToWorldScale:e[3]})}_parsePerspectiveCamera(t){const e=this._getCameraData(t);e.length===4&&(this._perspectiveCamera={cameraViewPoint:e[0],cameraDirection:e[1],cameraUpVector:e[2],fieldOfView:e[3]})}_parseLines(t){let e=t.firstElementChild;for(;e!==null;)this._lines.push(this._getLine(e)),e=e.nextElementSibling}_parseClippingPlanes(t){let e=t.firstElementChild;for(;e!==null;)this._clippingPlanes.push(this._getClippingPlane(e)),e=e.nextElementSibling}_getClippingPlane(t){let e=t.firstElementChild,i=_.zero(),n=_.zero();return e!==null&&(i=this._getPoint(e),e=e.nextElementSibling,e!==null&&(n=this._getPoint(e))),{location:i,direction:n}}_getLine(t){let e=t.firstElementChild,i=_.zero(),n=_.zero();return e!==null&&(i=this._getPoint(e),e=e.nextElementSibling,e!==null&&(n=this._getPoint(e))),{startPoint:i,endPoint:n}}_getPoint(t){const e=[];let i=t.firstElementChild;for(;i!==null;){const n=i.firstChild;n!==null&&e.push(parseFloat(n.wholeText)),i=i.nextElementSibling}return console.assert(e.length===3),new _(e[0],e[1],e[2])}_colorFromArgb(t,e){const i={color:vt.black(),components:e},n=[];for(let r=0;r<t.length;r+=2){const o=t.substr(r,2);n.push(parseInt(o,16))}return n.length===3?i.color.set(n[0],n[1],n[2]):n.length===4&&(i.alpha=n[0],i.color.set(n[1],n[2],n[3])),i}_getColoring(t){const e=[];let i=t.firstElementChild;for(;i!==null;){const r=i.attributes.getNamedItem("Color"),o=this._getComponents(i);r&&o.length&&e.push(this._colorFromArgb(r.value,o)),i=i.nextElementSibling}return e}_getComponents(t){const e=[];let i=t.firstElementChild;for(;i!==null;){const n=i.attributes,r=n.getNamedItem("IfcGuid"),o=n.getNamedItem("OriginatingSystem"),l=n.getNamedItem("AuthoringToolId");if(r!==null){const h={ifcGuid:r.value};o!==null&&(h.originatingSystem=o.value),l!==null&&(h.authoringToolId=parseInt(l.value,10)),e.push(h)}i=i.nextElementSibling}return e}}class $u{constructor(t,e,i,n){this._viewpointMap=new Map,this._snapshotMap=new Map,this._viewer=n,this._topicId=i,this._bcfDataId=t,this._bcfFilename=e}static async createTopic(t,e,i,n,r=null){const o=hs(),l=new $u(e,i,o,t),u=l.addMarkup("markup.bcf",null);u.setTopicTitle(n),u.setTopicId(o);const d="viewpoint.bcfv",g=await ml.createViewpoint(t,d,r);l.setViewpoint(d,g);const y="snapshot.png",m=(r!==null?r.getSnapshotImage():null)||await t.takeSnapshot(),I=pa.createFromImage(y,m);return l.setSnapshot(y,I),l}getTopicId(){return this._topicId}addMarkup(t,e){return this._markup=new Ym(t,e,this),this._markup}getMarkup(){return this._markup}addViewpoint(t,e,i,n,r){const o=new ml(t,e,i,n,r,this._viewer);return this.setViewpoint(t,o),o}setViewpoint(t,e){this._viewpointMap.set(t,e)}getViewpointMap(){return this._viewpointMap}getViewpoint(t){return this._viewpointMap.get(t)||null}addSnapshot(t,e){const i=new pa(t,e);this.setSnapshot(t,i)}setSnapshot(t,e){this._snapshotMap.set(t,e)}getSnapshotMap(){return this._snapshotMap}getSnapshot(t){return this._snapshotMap.get(this._massageSnapshotFilename(t))||null}_massageSnapshotFilename(t){if(t==="viewpoint.bcfv")return"snapshot.png";const e=t.split(".");return e[1]==="bcfv"?`${e[0]}.png`:t}}const _b=Object.freeze(Object.defineProperty({__proto__:null,BCFComment:zf,BCFData:Uu,BCFFileType:Qn,BCFMarkup:Ym,BCFMarkupHeaderFile:Xm,BCFMarkupViewpoint:Jm,BCFSnapshot:pa,BCFTopic:$u,BCFVersion:Ys,BCFViewpoint:ml,addElem:Fr,appendPoint3:mr,argbStringFromColor:$m,boolToString:qc,conditionalAddElem:cn,conditionalBoolToString:zu,conditionalDateToString:Kc,conditionalNumberToString:Bf,conditionalSetAttribute:Lr,defaultOriginatingSystem:Rr,exportComponent:Bu},Symbol.toStringTag,{value:"Module"}));var qu=(s=>(s[s.avatarOffset=1500]="avatarOffset",s[s.maxClimbHeight=600]="maxClimbHeight",s[s.negligibleClimbHeight=20]="negligibleClimbHeight",s[s.maxFallDistance=5e3]="maxFallDistance",s))(qu||{}),Ku=(s=>(s[s.avatarOffset=150]="avatarOffset",s))(Ku||{}),Xu=(s=>(s[s.transparencyRange=4e3]="transparencyRange",s))(Xu||{});const yb=Object.freeze(Object.defineProperty({__proto__:null,DefaultDoorConfig:Xu,DefaultFloorConfig:qu,DefaultWallConfig:Ku},Symbol.toStringTag,{value:"Module"}));var Bo=(s=>(s[s.Never=0]="Never",s[s.Bim=1]="Bim",s[s.BimWalk=2]="BimWalk",s))(Bo||{}),kn=(s=>(s.Inactive="inactive",s.Activating="activating",s.Active="active",s))(kn||{});function jf(s){if(s.length===0)return new _t;if(s.length===1)return s[0];let t=_t.multiply(s[1],s[0]);for(let e=2;e<s.length;++e)t=_t.multiply(s[e],t);return t}function _l(s,t,e){return Math.max(t,Math.min(e,s))}function e_(s,t){return s.x>=t.min.x&&s.x<=t.max.x&&s.y>=t.min.y&&s.y<=t.max.y&&s.z>=t.min.z&&s.z<=t.max.z}function Wf(s,t){return s.z>=t.min.z&&s.z<=t.max.z}class i_{constructor(t,e,i,n,r){this.floorplanNode=null,this.floorNode=t,this.bounds=e,this.slabNodes=i,this.spaceNodes=n,this.floorplanMeshCreationNodes=r}}class Jc{constructor(){this.overlayAnchor=je.LowerRightCorner,this.overlaySize=new K(.25,1),this.overlayWidthUnit=De.ProportionOfCanvas,this.overlayHeightUnit=De.ProportionOfOtherDimension,this.overlayOffset=new K(0,0),this.overlayOffsetXUnit=De.Pixels,this.overlayOffsetYUnit=De.Pixels,this.backgroundColor=vt.white(),this.backgroundOpacity=.25,this.borderColor=vt.black(),this.borderOpacity=1,this.avatarColor=vt.createFromFloat(1,0,1),this.avatarOutlineColor=vt.black(),this.avatarOpacity=1,this.avatarScale=1,this.fixedAvatarScale=!0,this.overlayFeetPerPixel=.1,this.zoomLevel=1,this.autoActivate=Bo.BimWalk,this.floorplanOrientation=ga.NorthUp,this.customAvatar=null,this.trackCameraEnabled=!1}copy(){const t=new Jc;return t.overlayAnchor=this.overlayAnchor,t.overlaySize=this.overlaySize.copy(),t.overlayWidthUnit=this.overlayWidthUnit,t.overlayHeightUnit=this.overlayHeightUnit,t.overlayOffset=this.overlayOffset.copy(),t.overlayOffsetXUnit=this.overlayOffsetXUnit,t.overlayOffsetYUnit=this.overlayOffsetYUnit,t.backgroundColor=this.backgroundColor.copy(),t.backgroundOpacity=this.backgroundOpacity,t.borderColor=this.borderColor.copy(),t.borderOpacity=this.borderOpacity,t.avatarColor=this.avatarColor.copy(),t.avatarOutlineColor=this.avatarOutlineColor.copy(),t.avatarOpacity=this.avatarOpacity,t.avatarScale=this.avatarScale,t.fixedAvatarScale=this.fixedAvatarScale,t.customAvatar=this.customAvatar,t.overlayFeetPerPixel=this.overlayFeetPerPixel,t.zoomLevel=this.zoomLevel,t.trackCameraEnabled=this.trackCameraEnabled,t.autoActivate=this.autoActivate,t.floorplanOrientation=this.floorplanOrientation,t}}class yi{constructor(t=xe.Face){this.respectVisibility=!0,this.forceEffectiveVisibilityMask=xe.None,this.forceEffectiveSceneVisibilityMask=xe.None,this.respectDepthRange=!0,this.oneEntityPerTypePerInstance=!0,this.restrictLinesAndPointsToSelectedFaceInstances=!0,this.enableProximityFaces=!1,this.ignoreCappingGeometry=!1,this.ignoreOverlays=!1,this.restrictToOverlays=!1,this.selectionMask=t}copy(){const t=new yi;return ov(this,t),t}get allowFaces(){return(this.selectionMask&xe.Face)!==0}set allowFaces(t){this.selectionMask=na(this.selectionMask,xe.Face,t)}get allowLines(){return(this.selectionMask&xe.Line)!==0}set allowLines(t){this.selectionMask=na(this.selectionMask,xe.Line,t)}get allowPoints(){return(this.selectionMask&xe.Point)!==0}set allowPoints(t){this.selectionMask=na(this.selectionMask,xe.Point,t)}}class Yc{constructor(t=xe.All){this.mustBeFullyContained=!1,this.respectVisibility=!0,this.forceEffectiveVisibilityMask=xe.None,this.forceEffectiveSceneVisibilityMask=xe.None,this.allowFaces=!0,this.allowLines=!0,this.allowPoints=!0,this.ignoreCuttingSections=!0,this.onlyStreamedInstances=!1,this.ignoreUnrequestedInstances=!1,this.allowFaces=(t&xe.Face)!==0,this.allowLines=(t&xe.Line)!==0,this.allowPoints=(t&xe.Point)!==0}}class Vo{constructor(t,e,i,n){this.x=t,this.xUnit=e,this.y=i,this.yUnit=n}}class n_{constructor(t,e,i){this._anchor=t,this._position=e,this._size=i}getAnchor(){return this._anchor}getPosition(){return this._position}getSize(){return this._size}}class s_{constructor(t,e,i,n){this._view=t,this._model=e,this._callbackManager=i,this._engine=n,this._viewports=[];for(let r=0;r<=this.maxIndex();r++)this._viewports.push(null)}maxIndex(){return ye.First-1}setViewport(t,e,i,n,r,o,l,h,u,d){if(t===0)throw new ae("Index 0 is reserved and may not be used to specify an overlay.");if(t<0)throw new ae(`Invalid index ${t} specified when setting viewport.`);if(n===De.ProportionOfOtherDimension&&o===De.ProportionOfOtherDimension)throw new ae("Both x and y may not be set proportional to each other");if(h===De.ProportionOfOtherDimension&&d===De.ProportionOfOtherDimension)throw new ae("Both width and height may not be set proportional to each other");this._validateUnit(i,n,"x"),this._validateUnit(r,o,"y"),this._validateUnit(l,h,"width"),this._validateUnit(u,d,"height");const g=new Vo(i,n,r,o),y=new Vo(l,h,u,d),m=new n_(e,g,y);return this._viewports[t]=m,this._engine.setOverlayViewport(t,e,i,n,r,o,l,h,u,d,this._view.id),this._callbackManager.trigger("overlayViewportSet",t,this._view),Promise.resolve()}_getViewportPosition(t){const e=this._viewports[t];return e===null?null:e.getPosition()}getViewportPixelPosition(t){const e=this._viewports[t];if(e===null)return null;const i=e.getPosition();return this._toPixelPoint(i)}getViewportPixelOffsetInCanvas(t){const e=this.getViewportPixelPosition(t);if(e===null)return null;const i=this.getViewportPixelSize(t);if(i===null)return null;const n=this.getViewportAnchor(t);if(n===null)return null;const r=this._getOverlayOffset(n,i),o=K.add(r,e);switch(n){case je.UpperRightCorner:case je.RightCenter:case je.LowerRightCorner:o.x=r.x-e.x;break}switch(n){case je.LeftCenter:case je.Center:case je.RightCenter:case je.LowerLeftCorner:case je.BottomCenter:case je.LowerRightCorner:o.y=r.y-e.y}return o}_getViewportSize(t){const e=this._viewports[t];return e===null?null:e.getSize()}getViewportPixelSize(t){const e=this._viewports[t];if(e===null)return null;const i=e.getSize();return this._toPixelPoint(i)}getViewportAnchor(t){const e=this._viewports[t];return e===null?null:e.getAnchor()}setVisibility(t,e){return this._engine.setOverlayVisibility(t,e,this._view.id),Promise.resolve()}destroy(t){return this._engine.destroyOverlay(t,this._view.id),this._viewports[t]=null,Promise.resolve()}addNodes(t,e){const i=this._model._gatherInstanceIncsFromNodeIds(e);return i.length>0&&this._engine.addNodesToOverlay(i,this._view.id,t),Promise.resolve()}setCamera(t,e){return this._engine.setOverlayCamera(t,e,this._view.id),Promise.resolve()}_getOverlayOffset(t,e){const i=this._view.getCanvasSize(),n=K.zero();return t===je.LowerRightCorner||t===je.UpperRightCorner||t===je.RightCenter?n.x=i.x-e.x:(t===je.Center||t===je.TopCenter||t===je.BottomCenter)&&(n.x=.5*(i.x-e.x)),t===je.LowerLeftCorner||t===je.LowerRightCorner||t===je.BottomCenter?n.y=i.y-e.y:(t===je.Center||t===je.LeftCenter||t===je.RightCenter)&&(n.y=.5*(i.y-e.y)),n}_toPixelPoint(t){const e=this._view.getCanvasSize(),i=K.zero();let n=!1;switch(t.xUnit){case De.Pixels:i.x=t.x;break;case De.ProportionOfCanvas:i.x=e.x*t.x;break;case De.MinimumProportionOfCanvas:i.x=t.x*Math.min(e.x,e.y);break;case De.ProportionOfOtherDimension:n=!0;break}switch(t.yUnit){case De.Pixels:i.y=t.y;break;case De.ProportionOfCanvas:i.y=e.y*t.y;break;case De.MinimumProportionOfCanvas:i.y=t.y*Math.min(e.x,e.y);break;case De.ProportionOfOtherDimension:i.y=i.x*t.y;break}return n&&(i.x=t.x*i.y),i}_validateUnit(t,e,i){if(e!==De.Pixels&&(t<0||t>1))throw new ys(`value for ${i} should be between 0.0 and 1.0 when specifying non pixel value`)}}const wb=Object.freeze(Object.defineProperty({__proto__:null,OverlayManager:s_,OverlayUnitPoint:Vo,OverlayViewport:n_},Symbol.toStringTag,{value:"Module"})),On=class On{constructor(t,e,i,n,r){this._active=kn.Inactive,this._isSceneReady=!1,this._isModelLoaded=!1,this._isOverlayVisible=!1,this._isCallbacksSet=!1,this._onCameraUpdateFunc=this._doCameraUpdate.bind(this),this._onFrameDrawnFunc=this._onFrameDrawn.bind(this),this._floorplanNode=null,this._currentFloorInfo=null,this._config=new Jc,this._floorLock=!1,this._tightBoundings=!1,this._genericStoreyType="IFCBUILDINGSTOREY",this._floorInfos=new Map,this._floorInfosArray=new Array,this._avatarNode=null,this._avatarDirty=!0,this._borderNode=null,this._borderDirty=!0,this._backgroundNode=null,this._backgroundDirty=!0,this._canvasSize=new K(1,1),this._sync=new No(1,!0),this._setFloorplanSync=new h0(!1),this._viewer=t,this._model=e,this._engine=n,this._overlayManager=i,this._config=r.copy(),this._viewer.setCallbacks({sceneReady:()=>{console.assert(this._active!==kn.Active,"Got sceneReady while Floorplan is Active"),this._isSceneReady=!0,this._active===kn.Activating&&this._sync.push(()=>this._doUpdateActivation())},modelSwitchStart:()=>{this._isModelLoaded=!1,this._sync.push(async()=>this._deactivate())},firstModelLoaded:()=>{this._isModelLoaded=!0,this._onModelLoaded()},subtreeLoaded:()=>{this._isModelLoaded=!0,this._onModelLoaded()}})}async setCustomAvatar(t){if(this._config.customAvatar!==t)return await this._doSetCustomAvatar(t),this._avatarDirty=!0,this._onConfigurationChanged()}async setOverlaySize(t,e,i){return this._config.overlaySize=t.copy(),this._config.overlayWidthUnit=e,this._config.overlayHeightUnit=i,this._onConfigurationChanged()}async setOverlayAnchor(t){return this._config.overlayAnchor=t,this._onConfigurationChanged()}async setOverlayOffset(t){return this._config.overlayOffset=t.copy(),this._onConfigurationChanged()}async setOverlayFeetPerPixel(t){return this._config.overlayFeetPerPixel=t,this._onConfigurationChanged()}async setZoomLevel(t){return this._config.zoomLevel=t,this._onConfigurationChanged()}async setBackgroundColor(t){return this._config.backgroundColor=t,this._backgroundDirty=!0,this._onConfigurationChanged()}async setBackgroundOpacity(t){return this._config.backgroundOpacity=t,this._backgroundDirty=!0,this._onConfigurationChanged()}async setBorderColor(t){return this._config.borderColor=t,this._borderDirty=!0,this._onConfigurationChanged()}async setBorderOpacity(t){return this._config.borderOpacity=t,this._borderDirty=!0,this._onConfigurationChanged()}async setAvatarColor(t){return this._config.avatarColor=t,this._avatarDirty=!0,this._onConfigurationChanged()}async setAvatarOutlineColor(t){return this._config.avatarOutlineColor=t,this._avatarDirty=!0,this._onConfigurationChanged()}async setAvatarOpacity(t){return this._config.avatarOpacity=t,this._avatarDirty=!0,this._onConfigurationChanged()}async setAvatarScale(t){return this._config.avatarScale=t,this._avatarDirty=!0,this._onConfigurationChanged()}async setFixedAvatarScale(t){if(this._config.fixedAvatarScale!==t)return await this._deleteAvatarNode(),this._config.fixedAvatarScale=t,this._avatarDirty=!0,this._onConfigurationChanged()}async setTrackCameraEnabled(t){return this._config.trackCameraEnabled=t,this._onConfigurationChanged()}async setFloorplanOrientation(t){return this._config.floorplanOrientation=t,this._onConfigurationChanged()}async setAutoActivate(t){return this._config.autoActivate=t,this._onConfigurationChanged()}async setFloorLock(t){if(this._floorLock=t,this.isActive()&&!t){const e=this._viewer.view.getCamera().getPosition();await this._setFloorplanFromPosition(e)}}getFloorLock(){return this._floorLock}async setUseTightBoundings(t){t!==this._tightBoundings&&(await this._deleteAllFloorplans(),this._tightBoundings=t,this.isActive()&&await this._onProcessIfc())}async setConfiguration(t){const e=this._config.customAvatar;return this._config=t.copy(),e!==this._config.customAvatar&&await this._doSetCustomAvatar(this._config.customAvatar),this._borderDirty=!0,this._backgroundDirty=!0,this._avatarDirty=!0,this._onConfigurationChanged()}getConfiguration(){return this._config.copy()}getCurrentFloorNodeId(){return this._currentFloorInfo!==null?this._currentFloorInfo.floorNode:null}getAvatarNodeId(){return this._avatarNode}insideOverlay(t){const e=this._getOverlaySizeInPixels(),i=this._getOverlayOffsetInPixels();return t.x>=i.x&&t.y>=i.y&&t.x<=i.x+e.x&&t.y<=i.y+e.y}async activate(){await this._sync.push(()=>this._activate())}async deactivate(){await this._sync.push(()=>this._deactivate())}async _deleteAvatarNode(){if(this._avatarNode!==null){try{this._model._getModelStructure().allowNodeDeletion(this._avatarNode),await this._model.deleteNode(this._avatarNode)}catch(t){console.log(`Problem deleting existing avatar: ${t.message}`)}this._avatarNode=null}}async _doSetCustomAvatar(t){await this._deleteAvatarNode(),this._config.customAvatar=t}async _onConfigurationChanged(){return this._config.zoomLevel=_l(this._config.zoomLevel,.1,10),this._config.avatarScale=_l(this._config.avatarScale,.1,10),this._config.backgroundOpacity=_l(this._config.backgroundOpacity,0,1),this._config.borderOpacity=_l(this._config.borderOpacity,0,1),this._config.avatarOpacity=_l(this._config.avatarOpacity,0,1),this._isModelLoaded&&this._active===kn.Inactive&&this._config.autoActivate===Bo.Bim?this._onModelLoaded():(this._isOverlayVisible&&(this._isOverlayVisible=!1,await this._setupOverlay()),this._doCameraUpdate())}async _setFloorplanFromPosition(t){return this._setFloorplanSync.push(()=>this._doSetFloorplanFromPosition(t))}async _doSetFloorplanFromPosition(t){let e=null;const i=[];for(const r of this._floorInfosArray)e_(t,r.bounds)&&i.push(r);if(e=await(async r=>{const o=await this._performDownwardSelection(t);for(const l of o){const h=l.getNodeId(),u=this._model.getNodeParent(h);if(u===null)continue;const d=this._viewer.model.getNodeGenericType(u);if(d!==null){if(On._ifcSpaceTypes.has(d)){const g=await this._viewer.model.getNodesBounding([u]);if(!Wf(t,g))continue;for(const m of r)if(m.spaceNodes.indexOf(u)!==-1)return m}else if(On._ifcFloorTypes.has(d)){for(const g of r)if(g.slabNodes.indexOf(u)!==-1)return g}}}return null})(i),e===null){for(const r of this._floorInfosArray)if(Wf(t,r.bounds)){e=r;break}}if(e!==null&&(this._currentFloorInfo=e,this._floorplanNode===null||this._floorplanNode!==e.floorplanNode))return this._setFloorplanFromFloorNode(e.floorNode)}async _performDownwardSelection(t){const e=new yi;e.respectVisibility=!1,e.oneEntityPerTypePerInstance=!0;const i=new Ws(t,new _(0,0,-1)),n=await this._viewer.view.pickAllFromRay(i,e),r=new Map;for(const l of n){const h=l.getNodeId(),u=await this._model.getNodesBounding([h]);r.set(h,u.max.z)}const o=(l,h)=>{const u=r.get(l.getNodeId()),d=r.get(h.getNodeId());return u===void 0||d===void 0?-1:d-u};return n.sort(o)}async _activate(){this._active===kn.Inactive&&(this._active=kn.Activating,await this._doUpdateActivation())}async _deactivate(){this._active!==kn.Inactive&&(this._active=kn.Inactive,this._isCallbacksSet&&(this._isCallbacksSet=!1,this._viewer.unsetCallbacks({camera:this._onCameraUpdateFunc,frameDrawn:this._onFrameDrawnFunc,transitionEnd:this._onCameraUpdateFunc})),this._isOverlayVisible=!1,await this._overlayManager.setVisibility(ye.Floorplan,this._isOverlayVisible),this._borderNode&&(await this._model.deleteNode(this._borderNode),this._borderNode=null),this._backgroundNode&&(await this._model.deleteNode(this._backgroundNode),this._backgroundNode=null),await this._deleteAllFloorplans())}async _onModelLoaded(){await this._sync.push(()=>this._doOnModelLoaded())}async _doOnModelLoaded(){console.assert(this._isModelLoaded,"Model not loaded as expected");const t=this._model.getNodesByGenericType(this._genericStoreyType),e=t&&t.size>0;if(!e){await this._deactivate();return}this._active===kn.Inactive?e&&this._config.autoActivate===Bo.Bim&&(this._active=kn.Activating):this._active===kn.Active&&(this._active=kn.Activating),this._active===kn.Activating&&await this._doUpdateActivation()}async _doUpdateActivation(){this._active!==kn.Activating||!this._isSceneReady||!this._isModelLoaded||(this._active=kn.Active,this._isOverlayVisible||await this._setupOverlay(),await this._onProcessIfc(),this._isCallbacksSet||(this._isCallbacksSet=!0,this._viewer.setCallbacks({camera:this._onCameraUpdateFunc,frameDrawn:this._onFrameDrawnFunc,transitionEnd:this._onCameraUpdateFunc})))}async _deleteAllFloorplans(){const t=this._floorInfosArray.slice();this._floorInfos.clear(),this._floorInfosArray.length=0,this._floorplanNode=null,this._currentFloorInfo=null;for(const e of t)e.floorplanNode&&await this._model.deleteNode(e.floorplanNode)}async _hideActiveFloorplan(){this._floorplanNode!==null&&(await this._hideOverlayNode(this._floorplanNode),this._floorplanNode=null,this._currentFloorInfo=null)}async _onProcessIfc(){console.assert(this._active===kn.Active),await this._gatherFloorInfos(),await this._doCameraUpdate()}_hasFloorInfo(t){return this._floorInfos.has(t)}_getFloorInfo(t){const e=this._floorInfos.get(t);return e===void 0?null:e}async _createFloorInfo(t){const e=new Array;this._gatherDescendentIfcNodes(t,On._ifcFloorTypes,e);const i=new Array;this._gatherDescendentIfcNodes(t,On._ifcSpaceTypes,i);const n=new Array;if(this._gatherDescendentIfcNodes(t,On._ifcFloorplanCreationTypes,n),n.length===0)return null;const r=await this._model.getNodesBounding(n,{bodyInstance:!0,pmiBody:!1,viewFrame:!1,tightBounding:this._tightBoundings}),o=new i_(t,r,e,i,n);return this._floorInfos.set(t,o),this._floorInfosArray.push(o),o}async _gatherFloorInfos(){const t=this._model.getNodesByGenericType(On._genericStoreyType);if(t===null||t.size===0){await this._deactivate();return}for(const e of io(t))this._hasFloorInfo(e)||await this._createFloorInfo(e);this._floorInfos.size===0&&await this._deactivate()}_gatherDescendentIfcNodes(t,e,i){const n=this._model.getNodeChildren(t);for(const r of n){const o=this._model.getNodeGenericType(r);o!==null&&e.has(o)&&i.push(r),this._gatherDescendentIfcNodes(r,e,i)}}async _createFloorplanFromFloorInfo(t){const e=this._model._gatherInstanceIncsFromNodeIds(t.floorplanMeshCreationNodes),i=await this._engine.createFloorplanMesh(e),n=i[0],r=i[1];return this._model._getModelStructure().createMeshInstance(n,r,"floorplan",null,!0,!0,!1)}async _onFrameDrawn(){const t=this._viewer.view.getCanvasSize();t.equals(this._canvasSize)||(this._canvasSize=t.copy(),this._isOverlayVisible&&(this._isOverlayVisible=!1,await this._setupOverlay()))}async _doCameraUpdate(){if(this.isActive()){this._floorLock||await this._setFloorplanFromPosition(this._viewer.view.getCamera().getPosition());try{this._viewer.pauseRendering(),await this._updateOverlay()}finally{this._viewer.resumeRendering()}}}isActive(){return this._active===kn.Active}async _updateOverlay(){if(!this.isActive())return;const t=this._viewer.view.getCamera(),e=t.getPosition();let i=_.subtract(t.getTarget(),e);i.z=0,i.normalize(),(isNaN(i.x)||i.length()===0)&&(i=new _(0,1,0)),await this._updateOverlayCamera(e,i),await this._updateOverlayNodes(e,i)}async _updateOverlayNodes(t,e){const i=this._model,n=this._config,r=this._model.getNodeUnitMultiplier(this._model.getAbsoluteRootNode())*304.8,o=this._getOverlaySizeInPixels(),l=o.x/o.y,h=r*n.overlayFeetPerPixel/n.zoomLevel,u=h/l;let d=h*o.x,g=d/l;if(!n.trackCameraEnabled){const B=this._getFixedCameraSize(l);B!==null&&(d=B.x,g=B.y)}const y=new _t().setTranslationComponent(t.x,t.y,On._avatarZ),m=r*n.avatarScale,I=new _t().setScaleComponent(m,m,m),b=new _t;b.m[0]=e.y,b.m[1]=-e.x,b.m[2]=0,b.m[4]=e.x,b.m[5]=e.y,b.m[6]=0,b.m[8]=0,b.m[9]=0,b.m[10]=1,await this._viewer.model.setNodeMatrix(this._avatarNode,jf([y,b,I])),this._avatarDirty&&(n.customAvatar===null&&(i.setNodesFaceColor([this._avatarNode],n.avatarColor),i.setNodesLineColor([this._avatarNode],n.avatarOutlineColor),i.setNodesOpacity([this._avatarNode],n.avatarOpacity)),this._avatarDirty=!1),this._borderDirty&&(i.setNodesLineColor([this._borderNode],n.borderColor),i.setNodesOpacity([this._borderNode],n.borderOpacity),this._borderDirty=!1),this._backgroundDirty&&(i.setNodesFaceColor([this._backgroundNode],n.backgroundColor),i.setNodesOpacity([this._backgroundNode],n.backgroundOpacity),this._backgroundDirty=!1);const x=d-h,C=g-u,P=new _t().setScaleComponent(x,C,1),k=new _t;if(!this._config.trackCameraEnabled&&this._currentFloorInfo!==null){const B=this._currentFloorInfo.bounds.center();k.setTranslationComponent(B.x,B.y,0)}else k.setTranslationComponent(t.x,t.y,0);const O=this._config.floorplanOrientation===ga.AvatarUp?jf([k,b,P]):_t.multiply(P,k);await this._viewer.model.setNodeMatrix(this._borderNode,O),await this._viewer.model.setNodeMatrix(this._backgroundNode,O)}snapAvatarToPoint(t){if(this._currentFloorInfo===null||!this.insideOverlay(t))return;if(this._config.trackCameraEnabled){console.log("FP: snapAvatarToPoint: currently only supported when trackCameraEnabled is false");return}const e=this._getOverlaySizeInPixels(),i=this._getOverlayOffsetInPixels(),n=new K(t.x-i.x,t.y-i.y),r=this._currentFloorInfo.bounds,o=r.extents(),l=o.x/o.y,h=e.x/e.y,u=this._viewer.view.getCamera(),d=u.getPosition(),g=u.getTarget();let y=new _t;if(this._config.floorplanOrientation!==ga.NorthUp){const P=_.subtract(g,d),k=new _(P.x,P.y,0).normalize(),O=new _(0,1,0),B=new _(-1,0,0),j=js(B,k)>90?new _(0,0,-1):new _(0,0,1),V=js(O,k);y=_t.createFromOffAxisRotation(j,V)}let m,I;h>l?(m=o.y/e.y,I=new K(r.center().x-o.y/2*h,r.center().y+o.y/2)):(m=o.x/e.x,I=new K(r.center().x-o.x/2,r.center().y+o.x/2/h));let b=new _(n.x*m+I.x,I.y-n.y*m,d.z);b=y.transform(b);const x=_.subtract(g,d),C=_.add(b,x);u.setPosition(b),u.setTarget(C),u.setProjection(ti.Perspective),this._viewer.view.setCamera(u)}_getOverlaySizeInPixels(){const t=new Vo(this._config.overlaySize.x,this._config.overlayWidthUnit,this._config.overlaySize.y,this._config.overlayHeightUnit);return this._viewer.overlayManager._toPixelPoint(t)}_getOverlayOffsetInPixels(){const t=this._overlayManager.getViewportPixelOffsetInCanvas(ye.Floorplan);return t===null?K.zero():t}_getFixedCameraSize(t){if(this._currentFloorInfo!==null){const e=this._currentFloorInfo.bounds.extents();return e.x/e.y>t?new K(e.x,e.x/t):new K(e.y*t,e.y)}return null}async _updateOverlayCamera(t,e){const i=this._config,n=this._getOverlaySizeInPixels(),r=n.x/n.y;let h=this._model.getNodeUnitMultiplier(this._model.getAbsoluteRootNode())*304.8*i.overlayFeetPerPixel/i.zoomLevel*n.x,u=h/r;if(!i.trackCameraEnabled){const g=this._getFixedCameraSize(r);g!==null&&(h=g.x,u=g.y)}const d=new dn;if(d.setWidth(h),d.setHeight(u),!this._config.trackCameraEnabled&&this._currentFloorInfo!==null){const g=this._currentFloorInfo.bounds.center();d.setTarget(new _(g.x,g.y,0)),d.setPosition(new _(g.x,g.y,10))}else d.setTarget(new _(t.x,t.y,0)),d.setPosition(new _(t.x,t.y,10));i.floorplanOrientation===ga.AvatarUp?d.setUp(e):i.floorplanOrientation===ga.NorthUp&&d.setUp(new _(0,1,0)),await this._overlayManager.setCamera(ye.Floorplan,d)}async _setFloorplanFromFloorNode(t){await this._hideActiveFloorplan();const e=this._hasFloorInfo(t)?this._getFloorInfo(t):await this._createFloorInfo(t);if(e!==null){if(e.floorplanNode===null){const i=await this._createFloorplanFromFloorInfo(e),n=new _t;await this._model.setNodeMatrix(i,n,!0),await this._overlayManager.addNodes(ye.Floorplan,[i]),e.floorplanNode=i,this._floorplanNode=i,this._currentFloorInfo=e,await this._showOverlayNode(i)}else this._floorplanNode=e.floorplanNode,this._currentFloorInfo=e,await this._showOverlayNode(e.floorplanNode);await this._updateOverlay()}}async _setupOverlay(){const t=this._config;console.assert(this.isActive());const e=this._overlayManager;this._isOverlayVisible=!0,await e.setViewport(ye.Floorplan,t.overlayAnchor,t.overlayOffset.x,t.overlayOffsetXUnit,t.overlayOffset.y,t.overlayOffsetYUnit,t.overlaySize.x,t.overlayWidthUnit,t.overlaySize.y,t.overlayHeightUnit),await e.setVisibility(ye.Floorplan,this._isOverlayVisible),this._avatarNode||(this._avatarNode=this._config.customAvatar=this._config.customAvatar??await this._createAvatar(),this._model._getModelStructure().preventNodeDeletion(this._avatarNode),await this._overlayManager.addNodes(ye.Floorplan,[this._avatarNode])),this._borderNode||(this._borderNode=await this._create2dBox(!0,!1,On._borderZ),await this._overlayManager.addNodes(ye.Floorplan,[this._borderNode]),this._borderDirty=!0),this._backgroundNode||(this._backgroundNode=await this._create2dBox(!1,!0,On._backgroundZ),await this._overlayManager.addNodes(ye.Floorplan,[this._backgroundNode]),this._backgroundDirty=!0),await this._updateOverlay()}async _hideOverlayNode(t){const e=new _t;e.setTranslationComponent(1e30,0,0),await this._model.setNodeMatrix(t,e,!0)}async _showOverlayNode(t){await this._model.setNodeMatrix(t,new _t,!0)}async _createAvatar(){const t=this._config.fixedAvatarScale?1e4:1,e=1.2/t,i=1.5/t,n=-1.1/t,r=[0,i,0,-e,-i,0,0,n,0,0,i,0,0,n,0,e,-i,0],o=[-e,-i,0,0,i,0,e,-i,0,0,n,0,-e,-i,0],l=new rs;l.setBackfacesEnabled(!1),l.addFaces(r,void 0,void 0,void 0),l.addPolyline(o,void 0);const h=await this._viewer.model.createMesh(l),u=new Ns(h),d=(this._config.fixedAvatarScale?ie.SuppressCameraScale:ie.None)|ie.ExcludeBounding;return u.setCreationFlags(d),await this._viewer.model.createMeshInstance(u,null,!0,!0)}async _create2dBox(t,e,i){const h=new rs;if(t){const y=[-.5,-.5,i,-.5,.5,i,.5,.5,i,.5,-.5,i,-.5,-.5,i];h.addPolyline(y,void 0)}if(e){const y=[.5,-.5,i,.5,.5,i,-.5,.5,i,-.5,.5,i,-.5,-.5,i,.5,-.5,i],m=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1];h.addFaces(y,m),h.setBackfacesEnabled(!1)}const u=await this._viewer.model.createMesh(h),d=new Ns(u);return d.setCreationFlags(ie.ExcludeBounding|ie.DoNotReset),await this._viewer.model.createMeshInstance(d,null,!0,!0)}};On._genericStoreyType="IFCBUILDINGSTOREY",On._ifcFloorTypes=new Set(["IFCSLAB"]),On._ifcSpaceTypes=new Set(["IFCSPACE"]),On._ifcFloorplanCreationTypes=new Set(["IFCWALL","IFCWALLSTANDARDCASE","IFCCURTAINWALL","IFCSLAB","IFCCOLUMN"]),On._backgroundZ=-1,On._avatarZ=1,On._borderZ=2;let Ju=On;const vb=Object.freeze(Object.defineProperty({__proto__:null,ActiveState:kn,FloorInfo:i_,FloorplanAutoActivation:Bo,FloorplanConfig:Jc,FloorplanManager:Ju,clamp:_l,isPointInBox:e_,isPointInBoxOnlyZ:Wf,multiplyMatrices:jf},Symbol.toStringTag,{value:"Module"}));class Yu{constructor(t=ke.Default){this._date=new Date,this._handled=!1,this._viewKey=t}get viewKey(){return this._viewKey}getHandled(){return this._handled}setHandled(t){this._handled=t}getDate(){return this._date}}class Gf extends Yu{constructor(t,e,i,n){super(n),this._keyCode=t,this._eventType=i}getKeyCode(){return this._keyCode}getEventType(){return this._eventType}}class $f extends Yu{constructor(t,e,i,n,r){super(r),this._position=new K(t,e),this._modifiers=i,this._inputType=n}getPosition(){return this._position.copy()}shiftDown(){return(this._modifiers&_i.Shift)===_i.Shift}altDown(){return(this._modifiers&_i.Alt)===_i.Alt}controlDown(){return(this._modifiers&_i.Control)===_i.Control}commandDown(){return(this._modifiers&_i.Command)===_i.Command}getEventType(){return this._inputType}getModifiers(){return this._modifiers}}class Vr extends $f{constructor(t,e,i,n,r,o,l){super(t,e,r,o,l),this._button=i,this._buttons=n}getButton(){return this._button}getButtons(){return this._buttons}}class r_ extends $f{constructor(t,e,i,n,r,o,l){super(t,e,r,o,l),this._wheelDelta=i,this._buttons=n}getWheelDelta(){return this._wheelDelta}getButtons(){return this._buttons}}var fo=(s=>(s[s.Dec=0]="Dec",s[s.Inc=1]="Inc",s))(fo||{});function qf(s,t){if(t.getNodeType(s)===Ne.BodyInstance){let e=s;for(;e!==null;){if(t.getNodeGenericId(e)!==null)return e;e=t.getNodeParent(e)}}return s}class Zu{constructor(t,e,i){this.faceItem=t,this.lineItem=e,this.pointItem=i}fetchMostRelevant(t){return this.pointItem!==null&&t&xe.Point?this.pointItem:this.lineItem!==null&&t&xe.Line?this.lineItem:this.faceItem!==null&&t&xe.Face?this.faceItem:null}}class Zc{constructor(t,e,i,n,r,o,l){this._position=t.copy(),this._normal=e.copy(),this._elementIndex=i,this._elementBits=r,this._bounding=o.copy(),this._overlayIndex=n,this._isProximityFace=l}isProximityFace(){return this._isProximityFace}isCappingGeometry(){return this._elementIndex===-1}toJson(){return this._toJson()}_toJson(){return{position:this._position.toJson(),normal:this._normal.toJson(),cadFaceIndex:this._elementIndex,cadFaceBits:this._elementBits,bounding:this._bounding.toJson(),overlayIndex:this._overlayIndex,isProximityFace:this._isProximityFace}}static fromJson(t){const e=t,i=_.fromJson(e.position),n=_.fromJson(e.normal),r=on.fromJson(e.bounding),o=e.overlayIndex,l=e.isProximityFace===!0;return new Zc(i,n,e.cadFaceIndex,o,e.cadFaceBits,r,l)}getPosition(){return this._position.copy()}getNormal(){return this._normal.copy()}getCadFaceIndex(){return this._elementIndex}getCadFaceBits(){return this._elementBits}getBounding(){return this._bounding.copy()}overlayIndex(){return this._overlayIndex}}class Qc{constructor(t){this._handle=t}}class th{constructor(t,e,i,n,r,o,l){if(this._lineSegmentVertices=[],this._elementIndex=t,this._elementBits=l,this._position=e.copy(),this._bounding=r.copy(),this._overlayIndex=o,i){if(n>=0){const h=3*n;this._bestLineSegmentVertexIndex=new _(i[h],i[h+1],i[h+2])}this._lineSegmentVertices.push(new _(i[0],i[1],i[2]));for(let h=3;h<i.length;h+=6)this._lineSegmentVertices.push(new _(i[h],i[h+1],i[h+2]))}}isCappingGeometry(){return this._elementIndex<0}toJson(){return this._toJson()}_toJson(){const t=[];for(const e of this._lineSegmentVertices)t.push(e.toJson());return{lineId:this._elementIndex,lineBits:this._elementBits,position:this._position.toJson(),linePoints:t,bounding:this._bounding.copy(),overlayIndex:this._overlayIndex}}static fromJson(t){const e=t,i=_.fromJson(e.position),n=on.fromJson(e.bounding),r=e.overlayIndex,o=new th(e.lineId,i,null,-1,n,r,0);for(const l of e.linePoints){const h=_.fromJson(l);o._lineSegmentVertices.push(h)}return o}getLineId(){return this._elementIndex}getPosition(){return this._position.copy()}getPoints(){return this._lineSegmentVertices}getBestVertex(){return this._bestLineSegmentVertexIndex?this._bestLineSegmentVertexIndex.copy():null}getLineBits(){return this._elementBits}getBounding(){return this._bounding.copy()}overlayIndex(){return this._overlayIndex}}class o_{constructor(){this.none=0,this.face=0,this.line=0,this.point=0,this.part=0}update(t,e){switch(t.getSelectionType()){case Pn.None:e===fo.Dec?--this.none:++this.none;break;case Pn.Face:e===fo.Dec?--this.face:++this.face;break;case Pn.Line:e===fo.Dec?--this.line:++this.line;break;case Pn.Point:e===fo.Dec?--this.point:++this.point;break;case Pn.Part:e===fo.Dec?--this.part:++this.part;break}}sum(){return this.none+this.face+this.line+this.point+this.part}}class eh{constructor(t,e,i,n){this._position=t.copy(),this._elementIndex=e,this._overlayIndex=i,this._elementBits=n}static fromJson(t){const e=t,i=_.fromJson(e.position),n=e.overlayIndex;return new eh(i,e.pointId,e.pointBits,n)}toJson(){return this._toJson()}_toJson(){return{pointId:this._elementIndex,pointBits:this._elementBits,position:this._position.toJson(),overlayIndex:this._overlayIndex}}getPosition(){return this._position.copy()}getPointBits(){return this._elementBits}getPointId(){return this._elementIndex}overlayIndex(){return this._overlayIndex}}class wi{constructor(t=null,e=null,i=null,n=null,r=null){this._nodeId=t,this._inclusionKey=e,this._faceEntity=i,this._lineEntity=n,this._pointEntity=r}static create(t,e,i,n,r){return new wi(t,e,i,n,r)}getSelectionType(){return this._nodeId===null?Pn.None:this._faceEntity!==null?Pn.Face:this._lineEntity!==null?Pn.Line:this._pointEntity!==null?Pn.Point:Pn.Part}toJson(){return this._toJson()}_toJson(){return{nodeId:this._nodeId,includeId:this._inclusionKey,faceEntity:this._faceEntity?this._faceEntity.toJson():null,lineEntity:this._lineEntity?this._lineEntity.toJson():null,pointEntity:this._pointEntity?this._pointEntity.toJson():null}}static _fromJson(t){const e=t;return new wi(e.nodeId,e.includeId,e.faceEntity?Zc.fromJson(e.faceEntity):null,e.lineEntity?th.fromJson(e.lineEntity):null,e.pointEntity?eh.fromJson(e.pointEntity):null)}getFaceEntity(){return this._faceEntity}getLineEntity(){return this._lineEntity}getPointEntity(){return this._pointEntity}getNodeId(){return this._nodeId??ku}getInclusionKey(){return this._inclusionKey}getPosition(){return this._faceEntity!==null?this._faceEntity.getPosition():this._lineEntity!==null?this._lineEntity.getPosition():this._pointEntity!==null?this._pointEntity.getPosition():null}overlayIndex(){return this._faceEntity?this._faceEntity.overlayIndex():this._lineEntity?this._lineEntity.overlayIndex():this._pointEntity?this._pointEntity.overlayIndex():null}_setNodeId(t){this._nodeId=t}equals(t){return this._nodeId!==t._nodeId||this.getSelectionType()!==t.getSelectionType()?!1:this._faceEntity&&t._faceEntity?this._faceEntity.getCadFaceIndex()===t._faceEntity.getCadFaceIndex():this._lineEntity&&t._lineEntity?this._lineEntity.getLineId()===t._lineEntity.getLineId():this._pointEntity&&t._pointEntity?this._pointEntity.getPointId()===t._pointEntity.getPointId():!0}_hash(t){let e=this._nodeId!==null?this._nodeId.toString(36):"";return t||(e+=`;${this.getSelectionType()};`,this._faceEntity&&(e+=this._faceEntity.getCadFaceIndex().toString(36)),e+=";",this._lineEntity&&(e+=this._lineEntity.getLineId().toString(36)),e+=";",this._pointEntity&&(e+=this._pointEntity.getPointId().toString(36))),e}isEntitySelection(){return this._faceEntity!==null||this._lineEntity!==null||this._pointEntity!==null}isNodeSelection(){return this._nodeId!==null}isNodeEntitySelection(){return this._nodeId!==null&&this.isEntitySelection()}isFaceSelection(){return this._nodeId!==null&&this._faceEntity!==null}isLineSelection(){return this._nodeId!==null&&this._lineEntity!==null}isPointSelection(){return this._nodeId!==null&&this._pointEntity!==null}}class a_{constructor(t){this.futureItemHash=null,this.pastItemHash=t}}class Qu{constructor(t,e,i,n,r){this._selectedItemsPruned=new Map,this._selectedItemsFull=new Map,this._selectedNodeCounts=new Map,this._temporalLinks=new Map,this._oldestItemHash=null,this._newestItemHash=null,this._selectedLayers=new Set,this._selectedTypes=new Set,this._nodeSelectionColor=new vt(255,255,0),this._nodeSelectionOutlineColor=new vt(255,255,0),this._elementSelectionColor=vt.red(),this._elementSelectionOutlineColor=vt.red(),this._nodeHighlightMode=fr.HighlightAndOutline,this._nodeElementHighlightMode=fr.HighlightAndOutline,this._highlightNodeSelection=!0,this._highlightFaceElementSelection=!0,this._highlightLineElementSelection=!0,this._highlightPointElementSelection=!0,this._selectParentIfSelected=!0,this._pruneSelectionDescendants=!0,this._ignoreEntityWhenTogglingChildSelection=!0,this._singleEntityToggleMode=!1,this._suppressImplicitRemovalCallback=!1,this._selectionFilter=null,this._incrementalBlacklistedInstanceNodes=new Set,this._viewer=t,this._engine=i,this._model=n,this._modelStructure=r,this._callbackManager=e,this._callbackManager.bind({_subtreeLoaded:o=>{for(const l of o)this._onSubtreeLoaded(l);return Promise.resolve()},_drawContextCreated:o=>{this._updateHighlightingMode()}})}_init(){this._updateHighlightingMode();for(const t of this._viewer.views)this._engine.setHighlightColorizeCompression(t.id,.7);this._callbackManager.bind({_drawContextCreated:t=>{this._engine.setHighlightColorizeCompression(t,.7)}})}setSelectionFilter(t){this._selectionFilter=t}getSelectionFilter(){return this._selectionFilter}setPruneSelectionDescendants(t){this._pruneSelectionDescendants=t,this.clear()}getPruneSelectionDescendants(){return this._pruneSelectionDescendants}setSelectParentIfSelected(t){this._selectParentIfSelected=t}getSelectParentIfSelected(){return this._selectParentIfSelected}setIgnoreEntityWhenTogglingChildSelection(t){this._ignoreEntityWhenTogglingChildSelection=t}getIgnoreEntityWhenTogglingChildSelection(){return this._ignoreEntityWhenTogglingChildSelection}setSingleEntityToggleModeEnabled(t){this._singleEntityToggleMode=t,this.clear()}getSingleEntityToggleModeEnabled(){return this._singleEntityToggleMode}setSuppressImplicitRemovalCallback(t){this._suppressImplicitRemovalCallback=t}getSuppressImplicitRemovalCallback(){return this._suppressImplicitRemovalCallback}async selectFromPoint(t,e,i=fn.Set,n=this._viewer.view){const r=await n.pickFromPoint(t,e);this._onSelectionItem(r,i)}async selectAllFromPoint(t,e,i=fn.Set,n=this._viewer.view){const r=await n.pickAllFromPoint(t,e);this._onSelectionItems(r,i)}async selectFromRay(t,e,i=fn.Set,n=this._viewer.view){const r=await n.pickFromRay(t,e);this._onSelectionItem(r,i)}async selectAllFromRay(t,e,i=fn.Set,n=this._viewer.view){const r=await n.pickAllFromRay(t,e);this._onSelectionItems(r,i)}_onSelectionItem(t,e){t.isNodeEntitySelection()?this._processSelection(t,e):this._triggerNullSelection()}_onSelectionItems(t,e){if(e===fn.Set&&this.clear(!1),t.length===0){this._triggerNullSelection();return}switch(e){case fn.Add:case fn.Set:this.add(t);break;case fn.Toggle:for(const i of t)this.toggle(i);break;default:Tr()}}beginScreenSelectByArea(t,e,i,n=this._viewer.view){return n.beginScreenSelectByArea(t,e,i)}beginRayDrillSelection(t,e,i,n=this._viewer.view){return n.beginRayDrillSelection(t,e,i)}beginConvexPolyhedronSelection(t,e,i){return this._viewer.view.beginConvexPolyhedronSelection(t,e,i)}beginSphereSelection(t,e,i){return this._viewer.view.beginSphereSelection(t,e,i)}endIncrementalSelection(t){return this._callbackManager.trigger("incrementalSelectionEnd"),this._viewer.view.endIncrementalSelection(t),Promise.resolve()}async advanceIncrementalSelection(t,e=null){let i=await this._viewer.view.advanceIncrementalSelection(t);if(i===null)return!1;if(e!==null){const n=await Promise.all(i.map(e));i=i.filter((r,o)=>n[o])}return this.add(i),!0}isSelected(t){return this.contains(t)?!0:t.isNodeSelection()?this._findAncestor(t)!==null:!1}isNodeSelected(t){for(const i of this.getResults())if(i.getNodeId()===t)return!0;const e=wi.create(t);return this._findAncestor(e)!==null}contains(t){return this._selectedItemsPruned.has(t._hash(this._singleEntityToggleMode))}containsParent(t){return this._findAncestor(t)}_findAncestor(t){if(this._selectedItemsPruned.size>0)for(;;){const e=this._model.getNodeParent(t.getNodeId());if(e===null)return null;t=wi.create(e);const i=t._hash(this._singleEntityToggleMode);if(this._selectedItemsPruned.has(i))return t}return null}selectLayer(t,e){e===fn.Set&&this.clear();const i=[],n=this._model.getLayerIdsFromName(t);if(n!==null)for(const o of n){const l=this._model.getNodesFromLayer(o,!0);if(l!==null)for(const h of l)i.push(wi.create(h))}const r=this._selectedLayers.has(t);e===fn.Toggle&&r?this.remove(i):(this.add(i),this._selectedLayers.add(t))}getSelectedLayers(){const t=[];return this._selectedLayers.forEach(e=>{t.push(e)}),t}selectType(t,e){e===fn.Set&&this.clear();const i=[],n=this._model.getNodesByGenericType(t);n!==null&&n.forEach(o=>{i.push(wi.create(o))});const r=this._selectedTypes.has(t);if(e===fn.Toggle&&r)for(const o of i)this.remove(o);else this.add(i),this._selectedTypes.add(t)}getSelectedTypes(){const t=[];return this._selectedTypes.forEach(e=>{t.push(e)}),t}selectNode(t,e=fn.Set){if(t!==null&&this._modelStructure.isIdValid(t)){const i=wi.create(t);return this._processSelection(i,e),i.getSelectionType()}else return this._processSelection(null,e),Pn.None}_triggerNullSelection(){this._callbackManager.trigger("selectionArray",[],!1)}_isInAxisOverlay(t){const i=t.getFaceEntity();if(i)return i.overlayIndex()===1;const n=t.getLineEntity();if(n)return n.overlayIndex()===1;const r=t.getPointEntity();return r?r.overlayIndex()===1:!1}_getNodeCounts(t){const e=t.getNodeId();let i=this._selectedNodeCounts.get(e);return i||(i=new o_,this._selectedNodeCounts.set(e,i)),i}_addToFull(t,e){for(;this._selectedItemsFull.set(e,t);){const i=this._model.getNodeParent(t.getNodeId());if(i===null)return;t=wi.create(i),e=t._hash(this._singleEntityToggleMode)}}_addItems(t,e){const i=t.length;if(i===0)return;this._callbackManager.trigger("incrementalSelectionBatchBegin");const n=[];for(let r=0;r<i;++r){const o=this._filterItem(t[r]);if(o!==null&&this._addImpl(o,o._hash(this._singleEntityToggleMode))){const l=new zr(o);n.push(l)}}n.length===0?this._triggerNullSelection():e||this._callbackManager.trigger("selectionArray",n,!1),this._callbackManager.trigger("incrementalSelectionBatchEnd")}_addItem(t,e){const i=this._filterItem(t);if(i!==null&&this._addImpl(i,i._hash(this._singleEntityToggleMode))){const n=new zr(i);e||this._callbackManager.trigger("selectionArray",[n],!1)}else this._triggerNullSelection()}add(t,e=!1){if(t===null){this._triggerNullSelection();return}Array.isArray(t)?this._addItems(t,e):this._addItem(t,e)}_filterItem(t){if(this._selectionFilter===null)return t;const e=t.getNodeId(),i=this._selectionFilter(e,this._model);return i===e?t:i===null?null:wi.create(i)}_addImpl(t,e){if(t.getSelectionType()===Pn.None)return!1;if(this._isInAxisOverlay(t))return!0;if(this._selectedItemsPruned.has(e))return!1;if(this._pruneSelectionDescendants){if(this._findAncestor(t)!==null)return!1;this._removeDescendants(t)}this._selectedItemsPruned.set(e,t),this._addToFull(t,e),this._getNodeCounts(t).update(t,fo.Inc);const i=this._newestItemHash;if(this._newestItemHash=e,this._oldestItemHash||(this._oldestItemHash=e),i!==null){const r=this._temporalLinks.get(i);r&&(r.futureItemHash=e)}const n=new a_(i);if(this._temporalLinks.set(e,n),this._updateItemHighlight(t,!0,!0),this._modelStructure.getType(t.getNodeId())===Ne.Pmi){const r=this._modelStructure.getPmiTopologyReferences(t.getNodeId());if(r!==null)for(const o of r){const l=o.body.getRuntimeId(),h=o.faceIds;for(const d of h)this._model.setNodeFaceHighlighted(l,d,!0);const u=o.edgeIds;for(const d of u)this._model.setNodeLineHighlighted(l,d,!0)}}return!0}_removeUpdateLayers(t){if(this._selectedLayers.size>0){const e=t.getNodeId();if(e!==null){const i=this._model.getNodeLayerId(e);if(i!==null){const n=this._model.getLayerName(i);n!==null&&this._selectedLayers.delete(n)}}}}_removeUpdateTypes(t){if(this._selectedTypes.size>0){const e=t.getNodeId();if(e!==null){const i=this._model.getNodeGenericType(e);i!==null&&this._selectedTypes.delete(i)}}}_removeFromFull(t,e){if(this._removeUpdateLayers(t),this._removeUpdateTypes(t),this._selectedItemsFull.delete(e)){const i=this._model.getNodeChildren(t.getNodeId());for(const n of i){const r=wi.create(n);this._removeFromFull(r,r._hash(this._singleEntityToggleMode))}}}_removeItems(t,e){const i=[];t.forEach(n=>{this._removeImpl(n,n._hash(this._singleEntityToggleMode))&&i.push(new zr(n))}),e||this._callbackManager.trigger("selectionArray",i,!0)}_removeItem(t,e){if(this._removeImpl(t,t._hash(this._singleEntityToggleMode))){const i=new zr(t);e||this._callbackManager.trigger("selectionArray",[i],!0)}}remove(t,e=!1){Array.isArray(t)?this._removeItems(t,e):this._removeItem(t,e)}_removeImpl(t,e){if(this._singleEntityToggleMode){const l=this._selectedItemsPruned.get(e);l&&(t=l)}if(!this._selectedItemsPruned.delete(e))return!1;this._removeFromFull(t,e);const i=this._getNodeCounts(t);i.update(t,fo.Dec);const n=this._temporalLinks.get(e);if(n!==void 0){if(this._temporalLinks.delete(e),n.pastItemHash!==null){const l=this._temporalLinks.get(n.pastItemHash);l&&(l.futureItemHash=n.futureItemHash)}if(n.futureItemHash!==null){const l=this._temporalLinks.get(n.futureItemHash);l&&(l.pastItemHash=n.pastItemHash)}this._oldestItemHash===e&&(this._oldestItemHash=n.futureItemHash),this._newestItemHash===e&&(this._newestItemHash=n.pastItemHash)}let r=!0;const o=!1;if(i.sum()===0){r=!1;const l=t.getNodeId();this._selectedNodeCounts.delete(l)}return this._updateItemHighlight(t,r,o),!0}static _selectionItemIsFromModelBrowser(t){return t.getFaceEntity()===null&&t.getLineEntity()===null&&t.getPointEntity()===null}toggle(t){const e=this._filterItem(t);if(e===null)return;const i=this._findAncestor(e),n=e._hash(this._singleEntityToggleMode);if(i!==null){if(Qu._selectionItemIsFromModelBrowser(t)?this._removeImplicit(t,i,this._suppressImplicitRemovalCallback):this._ignoreEntityWhenTogglingChildSelection||this._removeImplicit(wi.create(e.getNodeId()),i,this._suppressImplicitRemovalCallback),this._suppressImplicitRemovalCallback){const r=new zr(e);this._callbackManager.trigger("selectionArray",[r],!0)}}else if(this._selectedItemsPruned.has(n)){if(this._removeImpl(e,n)){const r=new zr(t);this._callbackManager.trigger("selectionArray",[r],!0)}}else if(e!==null&&this._addImpl(e,n)){const r=new zr(e);this._callbackManager.trigger("selectionArray",[r],!1)}}set(t){this.clear(!1),this.add(t)}getResults(){const t=[];return this.each(e=>{t.push(e)}),t}getResult(t){const e=this.size();if(t<0||t>=e)return null;const i=e-t-1;return t<=i?this._getItemFromOldest(t):this._getItemFromNewest(i)}_getItemFromOldest(t){let e=this._oldestItemHash;for(;e;){if(t--===0)return this._selectedItemsPruned.get(e)||null;e=this._temporalLinks.get(e).futureItemHash}return null}_getItemFromNewest(t){let e=this._newestItemHash;for(;e;){if(t--===0)return this._selectedItemsPruned.get(e)||null;e=this._temporalLinks.get(e).pastItemHash}return null}getFirst(){return this._oldestItemHash!==null&&this._selectedItemsPruned.get(this._oldestItemHash)||null}getLast(){return this._newestItemHash!==null&&this._selectedItemsPruned.get(this._newestItemHash)||null}size(){return this._selectedItemsPruned.size}each(t){let e=this._oldestItemHash;for(;e;){const i=this._selectedItemsPruned.get(e);t(i),e=this._temporalLinks.get(e).futureItemHash}}clear(t=!0){this._selectedLayers.clear(),this._selectedTypes.clear(),this._clearHighlight(),this._selectedItemsPruned.clear(),this._selectedItemsFull.clear(),this._selectedNodeCounts.clear(),this._temporalLinks.clear(),this._oldestItemHash=null,this._newestItemHash=null,t&&this._triggerNullSelection()}setNodeSelectionColor(t){return this._setNodeSelectionColor(t),Promise.resolve()}_setNodeSelectionColor(t){this._nodeSelectionColor.assign(t),this._updateHighlightingMode()}getNodeSelectionColor(){return this._nodeSelectionColor.copy()}setNodeSelectionOutlineColor(t){return this._setNodeSelectionOutlineColor(t),Promise.resolve()}_setNodeSelectionOutlineColor(t){this._nodeSelectionOutlineColor.assign(t),this._updateHighlightingMode()}getNodeSelectionOutlineColor(){return this._nodeSelectionOutlineColor.copy()}setNodeElementSelectionColor(t){return this._setNodeElementSelectionColor(t),Promise.resolve()}_setNodeElementSelectionColor(t){this._elementSelectionColor.assign(t),this._updateHighlightingMode()}getNodeElementSelectionColor(){return this._elementSelectionColor.copy()}setNodeElementSelectionOutlineColor(t){return this._setNodeElementSelectionOutlineColor(t),Promise.resolve()}_setNodeElementSelectionOutlineColor(t){this._elementSelectionOutlineColor.assign(t),this._updateHighlightingMode()}getNodeElementSelectionOutlineColor(){return this._elementSelectionOutlineColor.copy()}getHighlightFaceElementSelection(){return this._highlightFaceElementSelection}setHighlightFaceElementSelection(t){return this._highlightFaceElementSelection=t,this._updateHighlight(),Promise.resolve()}setNodeSelectionHighlightMode(t){return this._setNodeSelectionHighlightMode(t),Promise.resolve()}_setNodeSelectionHighlightMode(t){this._nodeHighlightMode=t,this._updateHighlightingMode()}getNodeSelectionHighlightMode(){return this._nodeHighlightMode}setNodeElementSelectionHighlightMode(t){return this._setNodeElementSelectionHighlightMode(t),Promise.resolve()}_setNodeElementSelectionHighlightMode(t){this._nodeElementHighlightMode=t,this._updateHighlightingMode()}getNodeElementSelectionHighlightMode(){return this._nodeElementHighlightMode}setHighlightNodeSelection(t){return this._highlightNodeSelection=t,this._updateHighlight(),Promise.resolve()}getHighlightNodeSelection(){return this._highlightNodeSelection}getHighlightLineElementSelection(){return this._highlightLineElementSelection}getHighlightPointElementSelection(){return this._highlightPointElementSelection}setHighlightLineElementSelection(t){return this._highlightLineElementSelection=t,this._updateHighlight(),Promise.resolve()}setHighlightPointElementSelection(t){return this._highlightPointElementSelection=t,this._updateHighlight(),Promise.resolve()}setPickTolerance(t){this._engine.setPickTolerance(t)}getPickTolerance(){return this._engine.getPickTolerance()}exportSelectionData(){const t=[],e=this.getResults();for(const i of e)t.push(i.toJson());return t}loadSelectionData(t){if(this.clear(!1),typeof t=="string"&&(t=JSON.parse(t),!Array.isArray(t)))throw new ys("Expected JSON depicting an Array.");const e=[];for(const i of t){const n=wi._fromJson(i);n.isNodeSelection()&&e.push(n)}this.add(e)}_pathToParent(t,e){const i=[];for(;!t.equals(e);){i.push(t);const n=this._model.getNodeParent(t.getNodeId());if(n===null)break;t=wi.create(n)}return i}_removeImplicit(t,e,i){const n=this._pathToParent(t,e),r=u=>{for(const d of n)if(u.equals(d))return!0;return!1};let o=e;const l=[t],h=[];for(;n.length>0;){l.push(o);const u=this._model.getNodeChildren(o.getNodeId());for(const d of u){const g=wi.create(d);r(g)||h.push(g)}o=n.pop()}console.assert(t===o),this.remove(l,i),this.add(h,i)}_removeDescendants(t){const e=this._model.getNodeChildren(t.getNodeId());for(const i of e){const n=wi.create(i);this._removeDescendantsRecursive(n)}}_removeDescendantsRecursive(t){const e=t._hash(this._singleEntityToggleMode);if(this._selectedItemsFull.delete(e)){this._removeImpl(t,e);const i=this._model.getNodeChildren(t.getNodeId());for(const n of i){const r=wi.create(n);this._removeDescendantsRecursive(r)}}}_processSelection(t,e){switch(e){case fn.Add:this.add(t);break;case fn.Set:this.set(t);break;case fn.Toggle:t!==null&&this.toggle(t);break}}_clearHighlight(){this._selectedItemsPruned.size>0&&this._engine.clearHighlight()}_updateHighlight(){this._clearHighlight(),this._selectedItemsPruned.forEach(t=>{t&&this._updateItemHighlight(t,!0,!0)}),this._highlightNodeSelection&&this._model.setNodesHighlighted([],!0)}_updateItemHighlight(t,e,i){const n=t.getNodeId();if(this._highlightNodeSelection&&this._model.setNodesHighlighted([n],e),this._model.getNodeType(n)!==Ne.Pmi){const r=t.getFaceEntity();this._highlightFaceElementSelection&&r!==null&&!r.isCappingGeometry()&&this._model.setNodeFaceHighlighted(n,r.getCadFaceIndex(),i);const o=t.getLineEntity();this._highlightLineElementSelection&&o!==null&&!o.isCappingGeometry()&&this._model.setNodeLineHighlighted(n,o.getLineId(),i);const l=t.getPointEntity();this._highlightPointElementSelection&&l!==null&&this._model.setNodePointHighlighted(n,l.getPointId(),i)}}_updateHighlightingMode(){for(const t of this._viewer.views){switch(this._nodeHighlightMode){case fr.HighlightOnly:this._engine.setNodeHighlightColor(t.id,this._nodeSelectionColor,null);break;case fr.OutlineOnly:this._engine.setNodeHighlightColor(t.id,null,this._nodeSelectionOutlineColor);break;case fr.HighlightAndOutline:this._engine.setNodeHighlightColor(t.id,this._nodeSelectionColor,this._nodeSelectionOutlineColor);break}switch(this._nodeElementHighlightMode){case fr.HighlightOnly:this._engine.setElementHighlightColor(t.id,this._elementSelectionColor,null);break;case fr.OutlineOnly:{this._nodeHighlightMode===fr.OutlineOnly?this._engine.setElementHighlightColor(t.id,null,this._elementSelectionOutlineColor):this._engine.setElementHighlightColor(t.id,this._nodeSelectionColor,this._elementSelectionOutlineColor);break}case fr.HighlightAndOutline:this._engine.setElementHighlightColor(t.id,this._elementSelectionColor,this._elementSelectionOutlineColor);break}}}_onSubtreeLoaded(t){const e=wi.create(t);if(this.isSelected(e))return this._updateItemHighlight(e,!0,!0)}}const bb=Object.freeze(Object.defineProperty({__proto__:null,CompositeSelectionItem:Zu,FaceEntity:Zc,IncrementalSelectionId:Qc,LineEntity:th,NodeCounts:o_,Op:fo,PointEntity:eh,SelectionItem:wi,SelectionManager:Qu,TemporalLink:a_,ifcSelectionFilter:qf},Symbol.toStringTag,{value:"Module"}));class zr{constructor(t){this._selection=t}getType(){return this._selection?this._selection.getSelectionType():Pn.None}getSelection(){return this._selection}static _createNull(){return new zr(wi.create())}}class td extends Yu{constructor(t,e,i,n,r,o){super(o),this._id=t,this._position=new K(e,i),this._buttons=n,this._inputType=r}getId(){return this._id}getPosition(){return this._position}getEventType(){return this._inputType}getButtons(){return this._buttons}}function Ib(s){switch(s){case le.MouseDown:return!0;case le.MouseMove:return!0;case le.MouseUp:return!0;case le.Mousewheel:return!0;case le.TouchStart:return!1;case le.TouchMove:return!1;case le.TouchEnd:return!1;case le.KeyDown:return!1;case le.KeyUp:return!1;case le.ViewOrientationChange:return!1;default:return!1}}const xb=Object.freeze(Object.defineProperty({__proto__:null,InputEvent:Yu,KeyInputEvent:Gf,MouseInputEvent:Vr,MouseInputEventBase:$f,MouseWheelInputEvent:r_,NodeSelectionEvent:zr,TouchInputEvent:td,isMouseEventType:Ib},Symbol.toStringTag,{value:"Module"}));class l_{constructor(t,e){this._markupItems=new Map,this._activeViews=new Map,this._selectedMarkup=null,this._pendingUpdateHandleTimer=new Mo,this._viewToUpdate=new Set,this._pickTolerance=0,this._callbackManager=t,this._markupRenderer=e}shutdown(){this._activeViews.forEach((t,e)=>{this.setActiveView(e,t)}),this._markupItems.forEach((t,e)=>{t.forEach(i=>{i.remove(e)})}),this._markupItems.clear()}_updateLater(t,e){this._viewToUpdate.add(t),this._pendingUpdateHandleTimer.isIdle(Tn.BeforeAction)&&this._pendingUpdateHandleTimer.set(0,()=>{this.update()}),e!==null&&this._pendingUpdateHandleTimer.waitForIdle(Tn.AfterAction).then(()=>{e.resolve()})}updateLater(t){this._updateLater(t,null)}_updateAllViews(){this._activeViews.forEach((t,e)=>{this._viewToUpdate.add(e)}),this._markupItems.forEach((t,e)=>{this._viewToUpdate.add(e)}),this.update()}update(){this._pendingUpdateHandleTimer.clear(),this._viewToUpdate.forEach(t=>{this.renderMarkup(t),this.renderActiveViewMarkup(t)}),this._viewToUpdate.clear()}registerMarkupItem(t,e){let i=this._markupItems.get(e);i||(i=new Map,this._markupItems.set(e,i));const n=hs();return i.set(n,t),n}unregisterMarkupItem(t,e){let i=this._markupItems.get(e);if(!i)throw new Error("Unable to remove markup from unknown view");const n=i.get(t);n&&(n.remove&&n.remove(e),i.delete(t))}getActiveView(t){const e=this._activeViews.get(t);return e!==void 0?e:null}getViews(t){const e=[];return this._activeViews.forEach((i,n)=>{t===i&&e.push(n)}),e}async setActiveView(t,e){this._selectedMarkup&&(this._selectedMarkup.onDeselect(),this._selectedMarkup=null,this._updateAllViews());const i=this.getActiveView(t);e?this._activeViews.set(t,e):this._activeViews.delete(t);const n=mi();if(this._updateLater(t,n),i!==null&&i!==e){const r=i.getMarkup();for(const o of r)o.remove(t);await n,this._callbackManager.trigger("viewDeactivated",i)}else await this._pendingUpdateHandleTimer.waitForIdle(Tn.AfterAction)}markupViewDeleted(t){const e=this.getViews(t);for(let i of e)this.setActiveView(i,null)}viewDeleted(t){this._activeViews.delete(t);const e=this._markupItems.get(t);e&&(e.forEach(i=>{i.remove(t)}),this._markupItems.delete(t))}renderMarkup(t){this._markupRenderer._setCanvas(t.domElements.getMarkupSvgElement()),this._markupRenderer._clear();const e=this._markupItems.get(t);e&&(e.forEach(i=>{i.draw(this._markupRenderer,t)}),this._markupRenderer._finalize())}renderActiveViewMarkup(t){this._markupRenderer._setCanvas(t.domElements.getRedlineSvgElement()),this._markupRenderer._clear();const e=this.getActiveView(t);if(!e)return;const i=e.getMarkup();for(const n of i)n.draw(this._markupRenderer,t);this._markupRenderer._finalize()}getPickTolerance(){return this._pickTolerance}setPickTolerance(t){this._pickTolerance=t}pick(t,e){const i=this.getActiveView(e);if(i){const o=i.getMarkup();for(const l of o)if(l.hitWithTolerance(t,e,this._pickTolerance)||l.hit(t,e))return l}const n=this._markupItems.get(e);if(!n)return null;let r=null;return n.forEach(o=>{r===null&&(o.hitWithTolerance(t,e,this._pickTolerance)||o.hit(t,e))&&(r=o)}),r}select(t,e){this._selectedMarkup&&t!==this._selectedMarkup&&this._selectedMarkup.onDeselect(),this._selectedMarkup=t,this._selectedMarkup&&this._selectedMarkup.onSelect(e),this._updateAllViews()}getSelected(){return this._selectedMarkup}}class c_{constructor(t,e){this.markupView=t,this.itemResults=e}}class ih{constructor(t,e,i,n,r,o=null){this._lineVisibility=!0,this._faceVisibility=!0,this._markupItems=new Set,this._sheetId=null,this._colorMap=new Map,this._snapshotImage=null,this._defaultVisibility=!0,this._visibilityExceptions=new Set,this._uniqueId=t,this._camera=i,this._name=e,this._explodeMagnitude=n,this._cuttingPlaneData=r,this._sheetId=o}getCamera(){return this._camera}getSheetId(){return this._sheetId}getUniqueId(){return this._uniqueId}getName(){return this._name}setName(t){this._name=t}getLineVisibility(){return this._lineVisibility}setLineVisibility(t){this._lineVisibility=t}getFaceVisibility(){return this._faceVisibility}setFaceVisibility(t){this._faceVisibility=t}addMarkupItem(t){this._markupItems.add(t)}getMarkup(){return io(this._markupItems)}removeMarkup(t){return t.remove(null),this._markupItems.delete(t)}getCuttingPlaneData(){return this._cuttingPlaneData}setCuttingPlaneData(t){this._cuttingPlaneData=t}getExplodeMagnitude(){return this._explodeMagnitude}setExplodeMagnitude(t){this._explodeMagnitude=t}getColorMap(){return this._colorMap}setColorMap(t){this._colorMap=t}getDefaultVisibility(){return this._defaultVisibility}setDefaultVisibility(t){this._defaultVisibility=t}getVisibilityExceptions(){return this._visibilityExceptions}setVisibilityExceptions(t){this._visibilityExceptions=t}getSnapshotImage(){return this._snapshotImage}setSnapshotImage(t){this._snapshotImage=t}_handleLoadMarkupItem(t){return t instanceof uo?(this.addMarkupItem(t),!0):!1}static async _fromJson(t,e){const i=t,n=dn.fromJson(i.camera);let r;if(i.hasOwnProperty("sheetId")&&i.sheetId){const y=parseInt(t.sheetId,10);isNaN(y)||(r=y)}const o=new ih(i.uniqueId,i.name,n,i.explodeMagnitude,i.cuttingData,r);if(o.setLineVisibility(i.lineVisibility),o.setFaceVisibility(i.faceVisibility),i.defaultVisibility!==void 0&&i.visibilityExceptions!==void 0){o.setDefaultVisibility(i.defaultVisibility);const y=new Set;i.visibilityExceptions.forEach(m=>{y.add(m)}),o.setVisibilityExceptions(y)}const l=new Map,h=i.colors;if(Array.isArray(h))for(const y of h){const m=y[0],I=vt.fromJson(y[1]);l.set(m,I)}o.setColorMap(l);const u=[];console.assert(Array.isArray(i.markup));for(const y of i.markup){const m=hf(y.className);if(m){const I=m(y,e);I instanceof Promise?u.push(I.then(b=>o._handleLoadMarkupItem(b))):u.push(Promise.resolve(o._handleLoadMarkupItem(I)))}}const d=i.imageSrc;if(d!==void 0&&d.length>0){const y=new Image;y.src=d,o.setSnapshotImage(y)}const g=await Promise.all(u);return new c_(o,g)}toJson(){return this._toJson()}_toJson(){const t={uniqueId:this._uniqueId,name:this._name,camera:this._camera.toJson(),cuttingData:this._cuttingPlaneData,explodeMagnitude:this._explodeMagnitude,lineVisibility:this._lineVisibility,faceVisibility:this._faceVisibility,markup:[],sheetId:this._sheetId,defaultVisibility:this._defaultVisibility,visibilityExceptions:[],colors:[],imageSrc:""};return this._markupItems.forEach(e=>{const i=e.toJson();i.className=e.getClassName(),t.markup.push(i)}),this._visibilityExceptions.forEach(e=>{t.visibilityExceptions.push(e)}),this._colorMap.forEach((e,i)=>{t.colors.push([i,e.toJson()])}),this._snapshotImage!==null&&(t.imageSrc=this._snapshotImage.src),t}}const Cb=Object.freeze(Object.defineProperty({__proto__:null,RedlineItem:pl},Symbol.toStringTag,{value:"Module"}));class ts extends Xc{constructor(t,e){super(),t?this._p1=t.copy():this._p1=K.zero(),e?this._p2=e.copy():this._p2=K.zero()}set(t,e){this._p1.assign(t),this._p2.assign(e)}getP1(){return this._p1.copy()}setP1(t){this._p1.assign(t)}getP2(){return this._p2}setP2(t){this._p2.assign(t)}}class h_{constructor(t,e){this.p1=t.copy(),this.p2=e.copy()}}class Sb extends Xc{constructor(){super(...arguments),this._lines=[]}addLine(t,e){this._lines.push(new h_(t,e))}getLines(){return this._lines}clear(){this._lines=[]}}class u_ extends ma{constructor(){super(...arguments),this._points=[]}clearPoints(){this._points=[]}getPoints(){return this._points}pushPoint(t){this._points.push(t.copy())}}class Pb extends ma{constructor(){super(...arguments),this._polygons=[]}clear(){this._polygons=[]}createPolygon(){const t=[];return this._polygons.push(t),t}getPolygons(){return this._polygons}}class ed extends ma{constructor(){super(),this._fontFamily=null,this._fontSize=12,this.setStrokeWidth(0)}_assign(t){super._assign(t),this._fontFamily=t._fontFamily,this._fontSize=t._fontSize}getFontFamily(){return this._fontFamily}setFontFamily(t){this._fontFamily=t}setFontSize(t){this._fontSize=t}getFontSize(){return this._fontSize}}class kb extends ed{constructor(t,e){super(),this._position=K.zero(),this._text="",e&&(this._position=e.copy()),t&&this.setText(t)}_assign(t){super._assign(t),this._text=t._text,this._position.assign(t._position)}setPosition(t){this._position.assign(t)}getPosition(){return this._position}setText(t){this._text=t}getText(){return this._text}}class Kf{constructor(t,e){this.text=t,this.position=e.copy()}}class d_ extends ed{constructor(){super(...arguments),this._textStrings=[]}clear(){this._textStrings=[]}addString(t,e){this._textStrings.push(new Kf(t,e))}getStrings(){return this._textStrings}}class Xf{constructor(){this._padding=5,this._text=new ed,this._box=new ju,this._box.setFillOpacity(0),this._box.setFillColor(vt.white())}_assign(t){this._text._assign(t._text),this._box._assign(t._box),this._padding=t._padding}getTextPortion(){return this._text}getBoxPortion(){return this._box}getPadding(){return this._padding}setPadding(t){this._padding=t}}class yl extends Xf{constructor(t,e){super(),this._position=K.zero(),this._textStr="",t&&this._position.assign(t),e&&(this._textStr=e)}_assign(t){super._assign(t),this._position.assign(t._position)}getPosition(){return this._position.copy()}setPosition(t){this._position.assign(t)}getTextString(){return this._textStr}setTextString(t){this._textStr=t}}class Mb extends Xf{constructor(){super(...arguments),this._textStrings=[]}clear(){this._textStrings=[]}addString(t,e){this._textStrings.push(new Kf(t,e))}getStrings(){return this._textStrings}}const Eb=Object.freeze(Object.defineProperty({__proto__:null,Circle:Br,CircleCollection:Uf,EndcapShape:Xc,EndcapType:gn,FilledShape:ma,Line:ts,LineCollection:Sb,Polygon:u_,PolygonCollection:Pb,Polyline:ya,PolylineCollection:fb,Rectangle:Wu,RectangleBase:ju,RectangleCollection:gb,StrokedShape:Hf,Text:kb,TextBox:yl,TextBoxBase:Xf,TextBoxCollection:Mb,TextCollection:d_,TextMarkupBase:ed,_MarkupCircleData:Qm,_MarkupLineData:h_,_MarkupRectangleData:t_,_MarkupTextData:Kf},Symbol.toStringTag,{value:"Module"})),ws="http://www.w3.org/2000/svg";function wl(s){return`rgb(${s.r}, ${s.g}, ${s.b})`}function Jf(s){let t="";for(let e=0;e<s.length;e++)e&&(t+=" "),t+=`${s[e].x},${s[e].y}`;return t}function Yf(s,t){const e=s*1.1,i=new K(e,0),n=new K(e,s),r=new K(0,s/2),o=document.createElementNS(ws,"marker");o.id=hs(),o.markerWidth.baseVal.value=e,o.markerHeight.baseVal.value=s,o.setOrientToAuto(),o.refY.baseVal.value=s/2;const l=`M${i.x},${i.y} L${n.x},${n.y} L${r.x},${r.y} Z`,h=document.createElementNS(ws,"path");return h.setAttribute("d",l),h.setAttributeNS(null,"fill",wl(t)),o.appendChild(h),o}function Zf(s,t){const e=s*1.1,i=K.zero(),n=new K(0,s),r=new K(e,s/2),o=document.createElementNS(ws,"marker");o.id=hs(),o.markerWidth.baseVal.value=e,o.markerHeight.baseVal.value=s,o.setOrientToAuto(),o.refY.baseVal.value=s/2,o.refX.baseVal.value=s;const l=`M${i.x},${i.y} L${n.x},${n.y} L${r.x},${r.y} Z`,h=document.createElementNS(ws,"path");return h.setAttribute("d",l),h.setAttributeNS(null,"fill",wl(t)),o.appendChild(h),o}function Qf(s,t,e,i){const n=e/2,r=wl(i),o=document.createElementNS(ws,"circle");return o.setAttributeNS(null,"cx",s.x.toString()),o.setAttributeNS(null,"cy",s.y.toString()),o.setAttributeNS(null,"r",n.toString()),o.setAttributeNS(null,"fill",r),t>0&&(o.setAttributeNS(null,"stroke-width",t.toString()),o.setAttributeNS(null,"stroke",r)),o}class f_{constructor(){this._svgCanvas=null,this._svgDefsElement=null,this._svgElements=[],this._svgTextElements=[]}_setCanvas(t){this._svgCanvas=t,this._svgDefsElement=document.createElementNS(ws,"defs"),this._svgCanvas.appendChild(this._svgDefsElement)}_clear(){if(this._svgCanvas===null||this._svgDefsElement===null)throw new ae("canvas not set");for(;this._svgCanvas.firstChild;)this._svgCanvas.removeChild(this._svgCanvas.firstChild);for(this._svgElements=[],this._svgTextElements=[];this._svgDefsElement.firstChild;)this._svgDefsElement.removeChild(this._svgDefsElement.firstChild);this._svgCanvas.appendChild(this._svgDefsElement)}_finalize(){if(this._svgCanvas===null)throw new ae("canvas not set");for(const t of this._svgElements)this._svgCanvas.appendChild(t);for(const t of this._svgTextElements)this._svgCanvas.appendChild(t)}drawCircle(t){return this._addCircleNode(t.getCenter(),t.getRadius(),t)}drawCircles(t){const e=t.getCircles(),i=[];for(const n of e){const r=this._addCircleNode(n.center,n.radius,t);i.push(r)}return i}drawLine(t){return this._addLineElement(t.getP1(),t.getP2(),t)}drawLines(t){const e=t.getLines(),i=[];for(const n of e){const r=this._addLineElement(n.p1,n.p2,t);i.push(r)}return i}drawText(t){return this._addTextElement(t.getText(),t.getPosition(),t)}drawTexts(t){const e=t.getStrings(),i=[];for(const n of e){const r=this._addTextElement(n.text,n.position,t);i.push(r)}return i}measureText(t,e){if(this._svgCanvas===null)throw new ae("canvas not set");const i=this._createTextElement(t,K.zero(),e);this._svgCanvas.appendChild(i);const n=i.getBoundingClientRect(),r=new K(n.width,n.height);return this._svgCanvas.removeChild(i),r}measureTextBox(t){const e=this.measureText(t.getTextString(),t.getTextPortion());return e.x+=2*t.getBoxPortion().getStrokeWidth(),e.y+=2*t.getBoxPortion().getStrokeWidth(),e.x+=2*t.getPadding(),e.y+=2*t.getPadding(),e}drawPolyline(t){return this._addPolylineElement(t.getPoints(),t)}drawPolylines(t){const e=t.getPolylines(),i=[];for(const n of e){const r=this._addPolylineElement(n,t);i.push(r)}return i}drawPolygon(t){return this._addPolygonElement(t.getPoints(),t)}drawPolygons(t){const e=t.getPolygons(),i=[];for(const n of e){const r=this._addPolygonElement(n,t);i.push(r)}return i}drawRectangle(t){return this._addRectangleElement(t.getPosition(),t.getSize(),t)}drawRectangles(t){const e=t.getRectangles(),i=[];for(const n of e){const r=this._addRectangleElement(n.position,n.size,t);i.push(r)}return i}drawTextBox(t){return this._addTextBoxElement(t.getTextString(),t.getPosition(),t)}drawTextBoxes(t){const e=t.getStrings(),i=[];for(const n of e){const r=this._addTextBoxElement(n.text,n.position,t);i.push(r)}return i}_addTextBoxElement(t,e,i){const n=this.measureText(t,i.getTextPortion());n.x+=2*i.getPadding(),n.y+=2*i.getPadding();const r=[],o=this._addRectangleElement(e,n,i.getBoxPortion(),!0);r.push(o);const l=e.copy();l.x+=i.getPadding(),l.y+=i.getPadding()/2+i.getBoxPortion().getStrokeWidth();const h=this._addTextElement(t,l,i.getTextPortion());return r.push(h),r}_renderEndcaps(t,e,i,n){if(this._svgDefsElement===null)throw new ae("canvas not set");if(i.getStartEndcapType()===gn.Arrowhead){let r;i.getEndcapsInverted()?(r=Zf(i.getStartEndcapSize(),i.getStartEndcapColor()),r.refX.baseVal.value=i.getStartEndcapSize()):r=Yf(i.getStartEndcapSize(),i.getStartEndcapColor()),n.style.markerStart=`url(#${r.id})`,this._svgDefsElement.appendChild(r)}else if(i.getStartEndcapType()===gn.Circle){const r=Qf(t,i.getStrokeWidth(),i.getStartEndcapSize(),i.getStartEndcapColor());this._addSVGElement(r)}if(i.getEndEndcapType()===gn.Arrowhead){let r;i.getEndcapsInverted()?r=Yf(i.getEndEndcapSize(),i.getEndEndcapColor()):r=Zf(i.getEndEndcapSize(),i.getEndEndcapColor()),n.style.markerEnd=`url(#${r.id})`,this._svgDefsElement.appendChild(r)}else if(i.getEndEndcapType()===gn.Circle){const r=Qf(e,i.getStrokeWidth(),i.getEndEndcapSize(),i.getEndEndcapColor());this._addSVGElement(r)}}_createTextElement(t,e,i){const n=document.createElementNS(ws,"text"),r=t.split(`
`);for(const l of r){const h=document.createElementNS(ws,"tspan");h.textContent=l,h.setAttributeNS(null,"x",`${e.x}`),h.setAttributeNS(null,"dy","1.2em"),n.appendChild(h)}const o=i.getFontFamily();return o&&n.setAttributeNS(null,"font-family",o),n.setAttributeNS(null,"font-size",i.getFontSize().toString()),n.setAttributeNS(null,"x",`${e.x}`),n.setAttributeNS(null,"y",`${e.y}`),this._setGenericFillAttributes(n,i),this._setGenericStrokeAttributes(n,i),n}_addTextElement(t,e,i){const n=this._createTextElement(t,e,i);return this._addSVGTextItemElement(n),n}_addRectangleElement(t,e,i,n=!1){const r=document.createElementNS(ws,"rect");r.setAttributeNS(null,"x",t.x.toString()),r.setAttributeNS(null,"y",t.y.toString()),r.setAttributeNS(null,"width",e.x.toString()),r.setAttributeNS(null,"height",e.y.toString());const o=i.getBorderRadius();return o>0&&(r.setAttributeNS(null,"rx",o.toString()),r.setAttributeNS(null,"ry",o.toString())),this._setGenericFillAttributes(r,i),this._setGenericStrokeAttributes(r,i),n?this._addSVGTextItemElement(r):this._addSVGElement(r),r}_addLineElement(t,e,i){const n=document.createElementNS(ws,"line");return n.setAttributeNS(null,"x1",t.x.toString()),n.setAttributeNS(null,"y1",t.y.toString()),n.setAttributeNS(null,"x2",e.x.toString()),n.setAttributeNS(null,"y2",e.y.toString()),this._setGenericStrokeAttributes(n,i),this._addSVGElement(n),this._renderEndcaps(t,e,i,n),n}_addPolygonElement(t,e){const i=Jf(t),n=document.createElementNS(ws,"polygon");return n.setAttributeNS(null,"points",i),this._setGenericStrokeAttributes(n,e),this._setGenericFillAttributes(n,e),this._addSVGElement(n),n}_addPolylineElement(t,e){const i=Jf(t),n=document.createElementNS(ws,"polyline");return n.setAttributeNS(null,"points",i),n.setAttributeNS(null,"fill","none"),this._renderEndcaps(t[0],t[t.length-1],e,n),this._setGenericStrokeAttributes(n,e),this._addSVGElement(n),n}_addCircleNode(t,e,i){const n=document.createElementNS(ws,"circle");return n.setAttributeNS(null,"cx",t.x.toString()),n.setAttributeNS(null,"cy",t.y.toString()),n.setAttributeNS(null,"r",e.toString()),this._setGenericFillAttributes(n,i),this._setGenericStrokeAttributes(n,i),this._addSVGElement(n),n}_setGenericFillAttributes(t,e){t.setAttributeNS(null,"fill",wl(e.getFillColor())),t.setAttributeNS(null,"fill-opacity",e.getFillOpacity().toString())}_setGenericStrokeAttributes(t,e){t.setAttributeNS(null,"stroke",wl(e.getStrokeColor())),t.setAttributeNS(null,"stroke-width",e.getStrokeWidth().toString())}_addSVGTextItemElement(t){this._svgTextElements.push(t)}_addSVGElement(t){this._svgElements.push(t)}}const Ab=Object.freeze(Object.defineProperty({__proto__:null,Line:mb,MarkupItem:uo,MarkupItemManager:l_,MarkupView:ih,Redline:Cb,Shapes:Eb,Svg:Object.freeze(Object.defineProperty({__proto__:null,SVGMarkupRenderer:f_,createCircleMarker:Qf,createEndArrowMarker:Zf,createStartArrowMarker:Yf,svgColorRgbString:wl,svgNamespace:ws,svgPointString:Jf},Symbol.toStringTag,{value:"Module"})),_MarkupViewConstruction:c_},Symbol.toStringTag,{value:"Module"})),g_=45,p_=-45,m_=150,__=30;function y_(s){vl(s,Te.Forward,Te.Backward),vl(s,Te.Left,Te.Right),vl(s,Te.Up,Te.Down),vl(s,Te.RotateLeft,Te.RotateRight),vl(s,Te.TiltUp,Te.TiltDown)}function vl(s,t,e){s.has(t)&&s.has(e)&&(s.delete(t),s.delete(e))}function tg(s,t,e){return Math.max(Math.min(s,e),t)}function w_(s){const t=s.getViewAxes().upVector;return console.assert(t.isAxis()),_.scale(t,-1)}function eg(s,t){const e=new yi(xe.Face);return e.bimMask=s,e.ignoreOverlays=!0,t!==null&&(e.maxWorldDistance=t),e}async function ig(s,t,e,i){const n=new Ws(t,e),r=eg(ln.Floor,i),o=await s.pickFromRay(n,r);return o.isFaceSelection()?o.getPosition():null}async function v_(s,t,e,i){const n=new Ws(t,e.copy().normalize()),r=eg(ln.Wall,i),o=await s.pickFromRay(n,r);return o.isFaceSelection()?o:null}class Tb{constructor(){this._action=new no(!0),this._latestPromise=null,this._timestamp=0}isIdle(){return this._latestPromise===null&&this._action.isIdle()}set(t){const e=++this._timestamp;this._latestPromise!==null&&this._latestPromise.reject(void 0);const i=mi();return this._latestPromise=i,this._action.clear(),this._action.waitForIdle().then(()=>{e===this._timestamp&&this._action.set(()=>{if(e!==this._timestamp)return;i===this._latestPromise&&(this._latestPromise=null),typeof t=="function"&&(t=gs.create(t));let n;try{n=t.get()}catch(r){return this._advance(i,!0,r)}return n===void 0?this._advance(i,!1,null):n.then(()=>this._advance(i,!1,null),r=>this._advance(i,!0,r))})}),i}_advance(t,e,i){t===this._latestPromise&&(this._latestPromise=null),e?t.reject(i):t.resolve()}}class ng{constructor(t,e){this._button=t,this._modifier=e}getButton(){return this._button}getModifier(){return this._modifier}}class Mi{constructor(t,e){this._ptFirst=K.zero(),this._ptPrevious=K.zero(),this._ptCurrent=K.zero(),this._dragging=!1,this._dragCount=0,this._primaryTouchId=null,this._mapping=[],this._buttonModifierActive=!1,this._doubleClickInterval=200,this._firstMouseDownTime=null,this._isDoubleClick=!1,this._viewer=t,this._view=e}onDoubleClick(t){}onMouseDown(t){if(this._firstMouseDownTime?Date.now()-this._firstMouseDownTime<this._doubleClickInterval?(this._isDoubleClick=!0,this._firstMouseDownTime=null):this._firstMouseDownTime=Date.now():(this._firstMouseDownTime=Date.now(),this._isDoubleClick=!1),this._isDoubleClick)this.onDoubleClick(t);else{if(this._buttonModifierActive=this.checkMapping(t),this._buttonModifierActive){const e=t.getPosition();this._ptFirst.assign(e),this._ptPrevious.assign(e),this._ptCurrent.assign(e)}this._dragging=!0}}onMouseMove(t){this.isActive()&&(this._ptPrevious.assign(this._ptCurrent),this._ptCurrent.assign(t.getPosition()),this._dragging&&(this._ptCurrent.equals(this._ptPrevious)||(++this._dragCount,this._dragCount===1&&this._viewer.trigger("beginInteraction"))))}onMouseUp(t){this._buttonModifierActive&&this.stopInteraction(),this._dragging=!1,this._dragCount=0}stopInteraction(){this._viewer.trigger("endInteraction"),this._dragging=!1,this._dragCount=0,this._buttonModifierActive=!1}isDragging(){return this._dragging}isActive(){return(this._buttonModifierActive||this._primaryTouchId!==null)&&!this._isDoubleClick&&!this._viewer.getContextMenuStatus()}onTouchStart(t){if(this._primaryTouchId===null){this._primaryTouchId=t.getId();const e=t.getPosition(),i=new Vr(e.x,e.y,Me.None,t.getButtons(),_i.None,Xs.Down,t.viewKey);this.onMouseDown(i)}t.setHandled(this.setHandled())}async onTouchMove(t){if(this._primaryTouchId===t.getId()){const e=t.getPosition(),i=new Vr(e.x,e.y,Me.None,t.getButtons(),_i.None,Xs.Move,t.viewKey);await this.onMouseMove(i)}return t.setHandled(this.setHandled()),Promise.resolve()}onTouchEnd(t){if(this._primaryTouchId===t.getId()){const e=t.getPosition(),i=new Vr(e.x,e.y,Me.None,t.getButtons(),_i.None,Xs.Up,t.viewKey);this.onMouseUp(i),this._primaryTouchId=null}t.setHandled(this.setHandled())}addMapping(t,e=_i.None){this._mapping.push(new ng(t,e))}clearMapping(){this._mapping=[]}setMapping(t,e=_i.None){this._mapping=[],this._mapping.push(new ng(t,e))}checkMapping(t){if(this._mapping.length===0)return!0;for(const e of this._mapping)if(e.getButton()===t.getButton()&&e.getModifier()===t.getModifiers())return!0;return!1}setHandled(){return!1}onDeactivate(){const t=this.stopInteraction();return this._primaryTouchId=null,t}}class nh{constructor(t,e){this._mode=t,this._impl=new Lb(e)}static create(t,e){return new nh(t,e)}performSelection(t,e,i){const n=this._impl.viewer;let r;return this._mode==="View"?(r=n.view,i===void 0&&(i=[])):(this._mode,r=n.selectionManager),e===void 0&&(e=null),this._impl.performSelection(r,t,e,i)}isIdle(){return this._impl.isIdle()}waitForIdle(){return this._impl.waitForIdle()}stopSelection(){return this._impl.stopSelection()}clearSelection(){return this._impl.clearSelection()}}function Nb(s){return"areaCssMin"in s}function Db(s){return"rayCssBoxRadius"in s}function Ob(s){return"volumePlanes"in s}function Rb(s){return"sphereRadius"in s}class Lb{constructor(t){this._killHandles=[],this._activeSelectionCount=0,this._inactivityPromise=null,this.viewer=t}isIdle(){return this._activeSelectionCount===0}async waitForIdle(){return this._activeSelectionCount===0?(console.assert(this._inactivityPromise===null),Promise.resolve()):(this._inactivityPromise===null&&(this._inactivityPromise=mi()),this._inactivityPromise)}async stopSelection(){console.assert(this._killHandles.length===this._activeSelectionCount);const t=[];for(const e of this._killHandles)t.push(e());return Ue(t)}async clearSelection(){const t=this.viewer.selectionManager;t.clear(),await this.stopSelection(),t.clear()}async _advanceBySelectionManager(t,e){return this.viewer.selectionManager.advanceIncrementalSelection(t,e)}async _advanceByView(t,e,i){let r=await this.viewer.view.advanceIncrementalSelection(t);if(r===null)return!1;if(e){const o=await Promise.all(r.map(e));r=r.filter((l,h)=>o[h])}for(const o of r)i.push(o);return!0}_wrapBeginSelection(t,e){return Nb(e)?t.beginScreenSelectByArea(e.areaCssMin,e.areaCssMax,e.pickConfig):Db(e)?t.beginRayDrillSelection(e.rayCssOrigin,e.rayCssBoxRadius,e.pickConfig):Ob(e)?t.beginConvexPolyhedronSelection(e.volumePlanes,e.heuristicOrigin,e.pickConfig):Rb(e)?t.beginSphereSelection(e.sphereCenter,e.sphereRadius,e.pickConfig):Tr()}async performSelection(t,e,i,n){return n===void 0?this._performSelection(t,e,i,null):(await this._performSelection(t,e,i,n),n)}async _performSelection(t,e,i,n){const r=this._wrapBeginSelection(t,e);if(r===null)return;++this._activeSelectionCount;const o=this.viewer.selectionManager,l=n===null;let h=!1;const u=gs.create(async()=>{h=!0;try{const g=await r;l?await o.endIncrementalSelection(g):await this.viewer.view.endIncrementalSelection(g)}finally{const g=this._killHandles.indexOf(d);console.assert(g>=0),this._killHandles.splice(g,1),--this._activeSelectionCount,this._activeSelectionCount===0&&this._inactivityPromise!==null&&(this._inactivityPromise.resolve(),this._inactivityPromise=null)}}),d=()=>u.get();this._killHandles.push(d);try{const g=await r;let y=!0;for(;y&&!h;)l?y=await this._advanceBySelectionManager(g,i):y=await this._advanceByView(g,i,n),y&&!h&&await mu(1)}finally{await d()}}}class b_{constructor(t){this._nearbyDoors=new Set,this._viewer=t}_performSphereSelection(t,e,i){const n=nh.create("View",this._viewer),r=new Yc(xe.Face);return r.bimMask=i,r.onlyStreamedInstances=!0,r.ignoreUnrequestedInstances=!0,n.performSelection({pickConfig:r,sphereCenter:t,sphereRadius:e})}async updateNearbyDoors(t,e,i){const n=await this._performSphereSelection(t,e,ln.Door),r=new Set;for(const g of n){const y=g.getNodeId();r.add(y)}const o=cf(r,this._nearbyDoors),l=cf(this._nearbyDoors,r),h=io(o),u=io(l),d=this._viewer.model;d.setNodesOpacity(h,i),d.resetNodesOpacity(u),this._nearbyDoors=r}forgetNearbyDoors(){const t=io(this._nearbyDoors);this._nearbyDoors.clear(),this._viewer.model.resetNodesOpacity(t)}}class sg extends Mi{constructor(t,e){super(t,e),this._elevationSpeed=0,this._rotationSpeed=0,this._viewAngle=90,this._zoomDistance=0,this._walkDistance=0,this._tilt=0,this._majorAxis=Xe.X,this._maxExtents=0,this._walkActive=!1,this._activeWalk=new no(!0),this._bimModeEnabled=!1,this._synchronizedToggleBimMode=new Tb,this._initialInteractiveDrawLimitIncreaseStatus=!0,this._logical={floor:{...qu},wall:{...Ku},door:{...Xu}},this._effective={floor:{...qu},wall:{...Ku},door:{...Xu}},this._doorCache=new b_(t),this._downAxis=new _(0,-1,0),t.setCallbacks({subtreeLoaded:(i,n)=>{n===Dr.LoadModel&&this._updateSceneFloor()}})}_updateSceneFloor(){this._downAxis=w_(this._viewer.model)}isBimModeEnabled(){return this._bimModeEnabled}async _enableBimMode(){this._bimModeEnabled=!0,this._effective.floor=this._scaleAgainstModelUnit(this._logical.floor),this._effective.wall=this._scaleAgainstModelUnit(this._logical.wall),this._effective.door=this._scaleAgainstModelUnit(this._logical.door),this._updateSceneFloor(),await this._applyGravity(),await this._updateNearbyDoors()}_disableBimMode(){this._bimModeEnabled=!1,this._doorCache.forgetNearbyDoors()}enableBimMode(){return this._synchronizedToggleBimMode.set(async()=>{await this._enableBimMode()})}disableBimMode(){return this._synchronizedToggleBimMode.set(()=>{this._disableBimMode()})}toggleBimMode(){return this._synchronizedToggleBimMode.set(()=>this._bimModeEnabled?this._disableBimMode():this._enableBimMode())}async onActivate(){this._view.setProjectionMode(ti.Perspective);const t=this._view;if(this._initialInteractiveDrawLimitIncreaseStatus=await t.getInteractiveDrawLimitIncreaseEnabled(),t.setInteractiveDrawLimitIncreaseEnabled(!1),this._calculateInitialPosition(),this._maxExtents===0&&await this.resetDefaultWalkSpeeds(),this._bimModeEnabled&&await this._updateNearbyDoors(),this._view.floorplanManager.getConfiguration().autoActivate===Bo.BimWalk){const i=this._viewer.model.getNodesByGenericType("IFCBUILDINGSTOREY");i&&i.size>0&&await this._view.floorplanManager.activate()}}async onDeactivate(){if(this._view.setInteractiveDrawLimitIncreaseEnabled(this._initialInteractiveDrawLimitIncreaseStatus),this._doorCache.forgetNearbyDoors(),this._view.floorplanManager.getConfiguration().autoActivate===Bo.BimWalk){const e=this._viewer.model.getNodesByGenericType("IFCBUILDINGSTOREY");e&&e.size>0&&await this._view.floorplanManager.deactivate()}super.onDeactivate()}async resetDefaultWalkSpeeds(){this._rotationSpeed=40,this._viewAngle=90;const e=(await this._viewer.model.getLooseBounding()).extents();this._maxExtents=Math.max(e.x,e.y,e.z),this._walkDistance=this._maxExtents/15,this._elevationSpeed=this._maxExtents/10,this._zoomDistance=this._maxExtents/30}getBimFloorConfig(){return{...this._logical.floor}}setBimFloorConfig(t){this._logical.floor={...t},this._effective.floor=this._scaleAgainstModelUnit(this._logical.floor)}getBimWallConfig(){return{...this._logical.wall}}setBimWallConfig(t){this._logical.wall={...t},this._effective.wall=this._scaleAgainstModelUnit(this._logical.wall)}getBimDoorConfig(){return{...this._logical.door}}setBimDoorConfig(t){this._logical.door={...t},this._effective.door=this._scaleAgainstModelUnit(this._logical.door)}_scaleAgainstModelUnit(t){const e=this._viewer.model,i=1/e.getNodeUnitMultiplier(e.getAbsoluteRootNode());t={...t};const n=Object.keys(t);for(const r of n)typeof t[r]=="number"&&(t[r]*=i);return t}onMouseDown(t){super.onMouseDown(t)}onMouseMove(t){super.onMouseMove(t)}onMouseUp(t){super.onMouseUp(t)}async _applyGravity(){const t=this._view,e=t.getCamera();let i=e.getPosition(),n=await ig(t,i,this._downAxis,this._effective.floor.maxFallDistance);if(n===null&&(i=_.subtract(i,_.scale(this._downAxis,this._effective.floor.avatarOffset)),n=await ig(t,i,this._downAxis,this._effective.floor.maxFallDistance),n===null))return;const r=new _(0,0,this._effective.floor.avatarOffset),o=_.add(n,r),l=_.subtract(o,i),h=l.length();h>this._effective.floor.negligibleClimbHeight&&js(l,this._downAxis)>90&&h>this._effective.floor.maxClimbHeight||this._applyWalkDelta(e,l)}_updateNearbyDoors(){const e=this._view.getCamera().getPosition();return this._doorCache.updateNearbyDoors(e,this._effective.door.transparencyRange,.5)}_updateCamera(t){this._resetPosition(t),this._updateCameraTilt(t),this._updateCameraViewAngle(t),this._view.setCamera(t)}_applyWalkDelta(t,e){t.dolly(_.scale(e,-1)),this._updateCamera(t)}async _applyWalkDeltaWithCollisionCheck(t,e,i){const n=t.getPosition(),o=_t.createFromOffAxisRotation(i,90).transform(e),h=_t.createFromOffAxisRotation(i,-90).transform(e),u=this._testWallCollision(n,o,this._effective.wall.avatarOffset),d=this._testWallCollision(n,h,this._effective.wall.avatarOffset),g=this._testWallCollision(n,e,e.length()+this._effective.wall.avatarOffset),[y,m]=await Promise.all([u,d]);if(y!==null||m!==null){const b=x=>{if(x!==null){const C=x.getFaceEntity().getNormal();return js(C,e)>90}return!1};if(b(y)||b(m))return}const I=await g;if(I!==null){const b=e.length(),x=_.scale(e,1/b),P=_.subtract(I.getPosition(),n).length()-this._effective.wall.avatarOffset,k=Math.min(b,P);e=_.scale(x,k)}this._applyWalkDelta(t,e)}_testWallCollision(t,e,i){return v_(this._view,t,e,i)}_walkBackward(t,e){const n=this._view.getCamera();this._resetPosition(n);const r=n.getTarget(),o=n.getPosition(),l=n.getUp(),u=_.subtract(o,r).normalize().copy().scale(t);return e?this._applyWalkDeltaWithCollisionCheck(n,u,l):this._applyWalkDelta(n,u)}_walkForward(t,e){return this._walkBackward(-t,e)}_walkLeft(t,e){const n=this._view.getCamera();this._resetPosition(n);const r=n.getTarget(),o=n.getPosition(),l=n.getUp(),h=_.subtract(r,o).normalize(),d=_.cross(l,h).normalize().copy().scale(t);return e?this._applyWalkDeltaWithCollisionCheck(n,d,l):this._applyWalkDelta(n,d)}_walkRight(t,e){return this._walkLeft(-t,e)}walkBackward(t){return this._walkBackward(t,!1)}walkForward(t){return this._walkForward(t,!1)}walkLeft(t){return this._walkLeft(t,!1)}walkRight(t){return this._walkRight(t,!1)}walkBackwardWithCollision(t){return this._walkBackward(t,!0)}walkForwardWithCollision(t){return this._walkForward(t,!0)}walkLeftWithCollision(t){return this._walkLeft(t,!0)}walkRightWithCollision(t){return this._walkRight(t,!0)}walkDown(t){const i=this._view.getCamera();this._resetPosition(i);const n=i.getUp().normalize().scale(t);this._applyWalkDelta(i,n)}walkUp(t){this.walkDown(-t)}rotateRight(t){const i=this._view.getCamera();this._resetPosition(i);const n=i.getTarget(),r=i.getPosition(),l=_.subtract(r,n).length(),h=_.subtract(n,r).normalize(),u=Zr(t),d=Math.tan(u),y=_.subtract(i.getTarget(),i.getPosition()).length()*d,m=_.cross(h,i.getUp()).scale(y);let I=n.copy().add(m);const b=_.subtract(I,r).normalize().scale(l);I=_.add(r,b),i.setTarget(I),this._updateCamera(i)}rotateLeft(t){this.rotateRight(-t)}tiltDown(t){this.setTilt(this._tilt+t);const i=this._view.getCamera();this._resetPosition(i),this._updateCamera(i)}tiltUp(t){this.tiltDown(-t)}_calculateInitialPosition(){const e=this._view.getCamera();this._calculateMajorAxis(e),this.setTilt(this._calculateInitialTilt(e)),this._resetPosition(e),this._updateCamera(e)}_updateCameraViewAngle(t){const e=Zr(this._viewAngle),i=Math.tan(e/2),r=_.subtract(t.getTarget(),t.getPosition()).length()*i;t.setWidth(r),t.setHeight(r)}_updateCameraTilt(t){const e=t.getPosition(),i=t.getTarget(),n=t.getUp().normalize(),r=_.subtract(i,e).normalize(),o=_.cross(n,r).normalize(),l=_.distance(i,e);_t.createFromOffAxisRotation(o,this._tilt).transform(r,r),t.setTarget(_.add(e,r.scale(l)))}_calculateInitialTilt(t){const e=t.getTarget(),i=t.getPosition(),n=_.subtract(e,i),r=n.length();this._majorAxis===Xe.X?n.x=0:this._majorAxis===Xe.Y?n.y=0:this._majorAxis===Xe.Z&&(n.z=0);const o=n.length();return Math.acos(o/r)*(180/Math.PI)}_resetPosition(t){this._calculateMajorAxis(t);const e=t.getPosition(),i=t.getTarget(),n=_.subtract(i,e);let r=n.length();switch(this.getWalkSpeed()>0&&(r=this.getWalkSpeed()),this._majorAxis){case Xe.X:n.set(0,n.y,n.z),t.setUp(new _(1,0,0));break;case Xe.Y:n.set(n.x,0,n.z),t.setUp(new _(0,1,0));break;case Xe.Z:n.set(n.x,n.y,0),t.setUp(new _(0,0,1));break}n.normalize().scale(r),t.setTarget(_.add(e,n))}_calculateMajorAxis(t){const e=t.getUp(),i=Math.abs(e.x),n=Math.abs(e.y),r=Math.abs(e.z);r>=i&&r>=n?this._majorAxis=Xe.Z:n>=i&&n>=r?this._majorAxis=Xe.Y:this._majorAxis=Xe.X}setZoomSpeed(t){this._zoomDistance=t}getZoomSpeed(){return this._zoomDistance}setTilt(t){this._tilt=tg(t,p_,g_);const e=this._view.getCamera();this._updateCamera(e)}getTilt(){return this._tilt}setViewAngle(t){const e=tg(t,__,m_);this._viewAngle!==e&&(this._viewAngle=e,this._updateCamera(this._view.getCamera()))}getViewAngle(){return this._viewAngle}setWalkSpeed(t){this._walkDistance=t}getWalkSpeed(){return this._walkDistance}setElevationSpeed(t){this._elevationSpeed=t}getElevationSpeed(){return this._elevationSpeed}setRotationSpeed(t){this._rotationSpeed=t}getRotationSpeed(){return this._rotationSpeed}setWalkActive(t){this._walkActive=t}getWalkActive(){return this._walkActive}getBimModeEnabled(){return this._bimModeEnabled}getMajorAxis(){return this._majorAxis}getActiveWalk(){return this._activeWalk}}class id extends sg{constructor(t,e){super(t,e),this._keyWalkMapping=new Map,this._keyUpMap=new Map,this._keyDownMap=new Map,this._mouseLookSpeed=0,this._mouseLookEnabled=!0,this._previousWalkTime=0,this._tickTimerId=null,t.setCallbacks({camera:i=>{i.getProjection()!==ti.Perspective&&this._keyDownMap.clear()}}),this.addKeyMapping(Je.a,Te.Left),this.addKeyMapping(Je.d,Te.Right),this.addKeyMapping(Je.w,Te.Forward),this.addKeyMapping(Je.s,Te.Backward),this.addKeyMapping(Je.q,Te.RotateLeft),this.addKeyMapping(Je.e,Te.RotateRight),this.addKeyMapping(Je.r,Te.TiltUp),this.addKeyMapping(Je.f,Te.TiltDown),this.addKeyMapping(Je.x,Te.Up),this.addKeyMapping(Je.c,Te.Down),this.addKeyMapping(Je.LeftArrow,Te.Left),this.addKeyMapping(Je.RightArrow,Te.Right),this.addKeyMapping(Je.UpArrow,Te.Forward),this.addKeyMapping(Je.DownArrow,Te.Backward)}addKeyMapping(t,e){this._keyWalkMapping.set(t,e)}getKeyMapping(){return hu(this._keyWalkMapping)}clearKeyMappings(){this._keyWalkMapping.clear()}onMouseDown(t){super.onMouseDown(t),this._viewer.focusInput(!0)}onMouseMove(t){if(super.onMouseMove(t),this._dragging&&this._mouseLookEnabled){this._view.setProjectionMode(ti.Perspective);const e=window.screen.width,i=window.screen.height;t.setHandled(!0);const n=K.subtract(this._ptPrevious,this._ptCurrent);this.rotateLeft(n.x/e*this._mouseLookSpeed),this.tiltUp(n.y/i*this._mouseLookSpeed)}}onMouseUp(t){this._dragCount>5&&t.setHandled(!0),super.onMouseUp(t)}onMousewheel(t){this._view.setProjectionMode(ti.Perspective);const e=this._view.getCamera(),i=t.getPosition(),n=t.getWheelDelta();this._view.pickFromPoint(i,new yi(xe.Face)).then(r=>{const o=r.getPosition();if(r!==null&&o!==null){const h=_.subtract(e.getPosition(),o).normalize().scale(this.getZoomSpeed()*n);this._applyWalkDelta(e,h)}else this.walkBackward(n*this.getWalkSpeed())})}onKeyDown(t){this._view.setProjectionMode(ti.Perspective);const e=t.getKeyCode();e===Je.v&&this.toggleBimMode(),this._keyCodeActive(e)||(this._keyDownMap.set(e,t.getDate().getTime()),this._onKeyChange(e))}onKeyUp(t){const e=t.getKeyCode();this._keyUpMap.set(e,t.getDate().getTime()),this._onKeyChange(e)}_keyCodeActive(t){const e=this._keyDownMap.get(t);if(e!==void 0){const i=this._keyUpMap.get(t);if(i===void 0||e>i)return!0}return!1}_onKeyChange(t){this._keyCodeActive(t)&&this._keyWalkMapping.has(t)&&(this.getWalkActive()||(this._previousWalkTime=Date.now()),this._onTick())}setMouseLookSpeed(t){this._mouseLookSpeed=t}getMouseLookSpeed(){return this._mouseLookSpeed}setMouseLookEnabled(t){this._mouseLookEnabled=t}getMouseLookEnabled(){return this._mouseLookEnabled}async resetDefaultWalkSpeeds(){return super.resetDefaultWalkSpeeds().then(()=>{this._mouseLookSpeed=300})}_execWalkDirection(t,e,i){const n=this.getWalkSpeed()*e;switch(t){case Te.Forward:return i?this.walkForwardWithCollision(n):this.walkForward(n);case Te.Backward:return i?this.walkBackwardWithCollision(n):this.walkBackward(n);case Te.Left:return i?this.walkLeftWithCollision(n):this.walkLeft(n);case Te.Right:return i?this.walkRightWithCollision(n):this.walkRight(n);case Te.Up:return this.walkUp(this.getElevationSpeed()*e);case Te.Down:return this.walkDown(this.getElevationSpeed()*e);case Te.RotateLeft:return this.rotateLeft(this.getRotationSpeed()*e);case Te.RotateRight:return this.rotateRight(this.getRotationSpeed()*e);case Te.TiltUp:return this.tiltUp(this.getRotationSpeed()*e);case Te.TiltDown:return this.tiltDown(this.getRotationSpeed()*e);default:Tr()}}_queueWalkDirections(t){const e=new Set;this._keyWalkMapping.forEach((n,r)=>{this._keyCodeActive(r)&&e.add(n)}),y_(e);const i=io(e);if(i.sort(),i.length>0){this.setWalkActive(!0);const n=this.getBimModeEnabled();this.getActiveWalk().set(async()=>{const r=new uc(1,!0);if(t>0)for(const o of i)r.push(()=>this._execWalkDirection(o,t,n));if(n&&(!e.has(Te.Up)&&!e.has(Te.Down)&&r.push(async()=>{await this._applyGravity()}),r.push(async()=>{await this._updateNearbyDoors()})),!r.isIdle())return r.waitForIdle()})}}_onTick(){const t=Date.now(),e=(t-this._previousWalkTime)/1e3;this._previousWalkTime=t;const i=!this.getActiveWalk().isIdle();this.setWalkActive(i),this._queueWalkDirections(e),this._tickTimerId!==null&&(cancelAnimationFrame(this._tickTimerId),this._tickTimerId=null),this.getWalkActive()&&(this._tickTimerId=requestAnimationFrame(()=>{this._onTick()}))}}class I_{constructor(t=10){this._count=0,this._points=new Array(t),this._times=new Array(t)}clear(){this._count=0}add(t,e=Date.now()){const i=this._count%this._points.length;this._points[i]===void 0?this._points[i]=t.copy():this._points[i].assign(t),this._times[i]=e,this._count++}getAverageOffsetWithinMilliseconds(t,e=Date.now()){let i=-1;const n=K.zero(),r=Math.min(this._points.length,this._count);if(r>0){let o=0;for(let l=0;l<r;l++){const h=(this._count-1-l)%this._points.length;if(e-this._times[h]>t)break;i=h,n.add(this._points[h]),o++}o>1?(n.subtract(this._points[i]),o--,n.scale(1/o)):(i=-1,n.set(0,0))}return i>=0?K.subtract(n,this._points[i]):n}}class rg extends Mi{constructor(t,e,i){super(t,e),this._cameraRotationMomentumEnabled=!1,this._isDown=!1,this._mouseDragged=!1,this._averagedMousePoints=new I_,this._averageTimeIntervalMilliseconds=150,this._previousMouseMovePoint=K.zero(),this._mouseMovePoint=K.zero(),this._mouseMoveOffset=K.zero(),this._previousMouseMoveTime=null,this._mouseMoveTime=null,this._mouseMoveElapsedTimeSeconds=0,this._rotationDegreesPerSecond=[0,0],this._animationLastTickTime=0,this._animationElapsedTimeSeconds=0,this._animationIntervalResult=null,this._preferredAnimationIntervalMilliseconds=16,this._momentum=0,this._momentumLossPerSecond=0,this._degreesPerPixel=.5,this._maxRotationMagnitudeScale=8,this._initialSelectionPosition=null,this._cameraRotateFunction=i}getCameraRotationMomentumEnabled(){return this._cameraRotationMomentumEnabled}setCameraRotationMomentumEnabled(t){t!==this._cameraRotationMomentumEnabled&&(this._cameraRotationMomentumEnabled=t,t||this.stopAnimation())}isCurrentlyAnimating(){return this._cameraRotationMomentumEnabled&&this.getMomentum()>0}onDeactivate(){return super.onDeactivate()}onViewOrientationChange(){this.stopAnimation()}supportsAnimation(){return!0}onMouseDown(t){super.onMouseDown(t),this.isActive()&&(this._initialSelectionPosition=t.getPosition(),this._isDown=!0,this.stopAnimation(),this._mouseDragged=!1,this._previousMouseMoveTime=Date.now(),this._mouseMoveTime=this._previousMouseMoveTime,this._mouseMovePoint.assign(this._initialSelectionPosition),this._previousMouseMovePoint.assign(this._mouseMovePoint),this._averagedMousePoints.clear(),this._averagedMousePoints.add(this._mouseMovePoint,this._mouseMoveTime))}onMouseMove(t){if(super.onMouseMove(t),this.isActive()){if(!this._isDown)return;this._mouseDragged=!0,this._previousMouseMovePoint.assign(this._mouseMovePoint),this._mouseMovePoint.assign(t.getPosition()),this._mouseMoveOffset=K.subtract(this._mouseMovePoint,this._previousMouseMovePoint),this._previousMouseMoveTime=this._mouseMoveTime,this._mouseMoveTime=Date.now(),this._mouseMoveElapsedTimeSeconds=this._previousMouseMoveTime===null?0:(this._mouseMoveTime-this._previousMouseMoveTime)/1e3,this._averagedMousePoints.add(this._mouseMovePoint,this._mouseMoveTime);const e=this._getMouseMoveOffsetForRotation();this._rotateCamera(e)}}onMouseUp(t){if(this.isActive()&&(this._isDown=!1,this._mouseDragged&&this.getCameraRotationMomentumEnabled())){this._mouseMoveOffset=this._averagedMousePoints.getAverageOffsetWithinMilliseconds(this._averageTimeIntervalMilliseconds);const e=this._getMouseMoveOffsetForRotation();if(e[0]!==0||e[1]!==0){for(let i=0;i<2;i++){const n=Math.abs(e[i])*this._maxRotationMagnitudeScale;this._rotationDegreesPerSecond[i]=e[i]/this._mouseMoveElapsedTimeSeconds,this._rotationDegreesPerSecond[i]<-n?this._rotationDegreesPerSecond[i]=-n:this._rotationDegreesPerSecond[i]>n&&(this._rotationDegreesPerSecond[i]=n)}this._momentum=1,this._startAnimation()}else this._momentum=0}super.onMouseUp(t)}_rotateCamera(t){this._cameraRotateFunction(t)}stopAnimation(){this._animationIntervalResult!==null&&(clearInterval(this._animationIntervalResult),this._animationIntervalResult=null)}getMomentum(){return this._momentum}setMomentumLossPerSecond(t){t>=0&&(this._momentumLossPerSecond=t)}getMomentumLossPerSecond(){return this._momentumLossPerSecond}isAnimating(){return this._animationIntervalResult!==null}_startAnimation(){this._animationIntervalResult===null&&(this._animationLastTickTime=Date.now(),this._animationIntervalResult=window.setInterval(()=>{this._onTick()},this._preferredAnimationIntervalMilliseconds))}_getMouseMoveOffsetForRotation(){return[-this._mouseMoveOffset.x*this._degreesPerPixel,this._mouseMoveOffset.y*this._degreesPerPixel]}_onTick(){const t=Date.now();this._animationElapsedTimeSeconds=(t-this._animationLastTickTime)/1e3,this._animationLastTickTime=t;const e=[this._animationElapsedTimeSeconds*this._rotationDegreesPerSecond[0],this._animationElapsedTimeSeconds*this._rotationDegreesPerSecond[1]];if(this._rotateCamera(e),this._momentumLossPerSecond>0)if(this._momentum=Math.max(0,this._momentum-this._animationElapsedTimeSeconds*this._momentumLossPerSecond),this._momentum>0)for(let i=0;i<this._rotationDegreesPerSecond.length;i++)this._rotationDegreesPerSecond[i]*=this._momentum;else{for(let i=0;i<this._rotationDegreesPerSecond.length;i++)this._rotationDegreesPerSecond[i]=0;this._rotateCamera(this._rotationDegreesPerSecond),this.stopAnimation()}}}class x_ extends uo{constructor(t,e,i,n){super(),this._circle=new Br,this._viewer=t,this._view=e,this._position=i,this._circle.setRadius(n)}draw(){if(this._circle){const t=this._view.projectPoint(this._position);this._circle.setCenter(K.fromPoint3(t)),this._viewer.markupManager.getRenderer().drawCircle(this._circle)}}}class og extends rg{constructor(t,e){super(t,e,i=>{if(!this._viewer.sheetManager.isDrawingSheetActive())if(this._pickPosition!==null){if(this._circleMarkupHandler===null){const n=new x_(this._viewer,this._view,this._pickPosition,this._circleRadius);this._circleMarkupHandler=this._viewer.markupManager.registerMarkup(n,this._view)}this._orbitByTurnTiltWithTarget(i,this._pickPosition)}else{const n=this._view.getCamera();switch(this._orbitFallbackMode){default:case cl.CameraTarget:this._orbitByTurnTiltWithTarget(i,n.getTarget());break;case cl.ModelCenter:this._modelCenter&&this._orbitByTurnTiltWithTarget(i,this._modelCenter);break;case cl.OrbitTarget:this._orbitByTurnTiltWithTarget(i,this._orbitTarget);break}}}),this._orbitTarget=_.zero(),this._orbitFallbackMode=cl.ModelCenter,this._modelCenter=_.zero(),this._circleMarkupHandler=null,this._circleRadius=3,this._updateCameraCenterAction=new no(!1),this._updateCameraCenterTimer=new Mo,this._primaryButton=Me.Middle,this._pickPosition=null,this._bimOrbitEnabled=!1,this._viewer.setCallbacks({sceneReady:()=>{this._updateModelCenter()},modelSwitched:()=>{this._updateModelCenter()},visibilityChanged:()=>{this._updateModelCenter()},_updateTransform:i=>{i||this._updateModelCenter()},_geometryCreated:()=>{this._updateModelCenter()},hwfParseComplete:()=>{this._updateModelCenter()}}),this._viewer.getSceneReady()&&this._updateModelCenter(0)}_updateModelCenter(t=50){this._updateCameraCenterTimer.clear(),this._updateCameraCenterAction.set(async()=>{const e=await this._viewer.model.getModelBounding(!0,!1);if(e.isDegenerate()&&t>0){this._updateCameraCenterTimer.set(500,()=>{this._updateModelCenter(t-1)});return}this._modelCenter=e.center()})}async onMouseDown(t){if(super.onMouseDown(t),this.isActive()&&t.getButton()===this._primaryButton){const e=await this._view.pickFromPoint(t.getPosition(),new yi(xe.Face));e!==null&&e.overlayIndex()===0?(this._pickPosition=e.getPosition(),t.setHandled(!0)):this._pickPosition=null}}onMouseUp(t){super.onMouseUp(t),t.getButton()===this._primaryButton&&(this._pickPosition=null),this._removeMarkup()}onDeactivate(){const t=super.onDeactivate();return this._updateCameraCenterTimer.clear(),t}setBimOrbitEnabled(t){this._bimOrbitEnabled=t}getBimOrbitEnabled(){return this._bimOrbitEnabled}_removeMarkup(){this._circleMarkupHandler!==null&&(this._viewer.markupManager.unregisterMarkup(this._circleMarkupHandler,this._view),this._circleMarkupHandler=null)}_getClampedRotationMatrix(t,e,i,n){const r=_t.createFromOffAxisRotation(t,e),o=_.zero();return r.transform(i,o),Xh(Math.asin(_.dot(n,o)))<=0?new _t:r}async _orbitByTurnTiltWithTarget(t,e){const i=this._view,n=i.getCamera();let r=n.getPosition().subtract(e),o=n.getTarget().subtract(e),l=n.getUp().normalize();const h=_.subtract(o,r).normalize(),u=_.cross(l,h).normalize(),d=t[0],g=t[1];let y=new _t,m=new _t;if(this._bimOrbitEnabled){const x=this._viewer.model.getViewAxes().upVector.copy();y=this._getClampedRotationMatrix(u,g,l,x),m=_t.createFromOffAxisRotation(x,d/4);const C=m.transform(y.transform(r)),P=m.transform(y.transform(o)),k=m.transform(y.transform(_.add(r,l)));k.subtract(C),r=C,o=P,l=k}else{y=_t.createFromOffAxisRotation(u,g),m=_t.createFromOffAxisRotation(l,d);const b=_t.multiply(m,y),x=b.transform(r),C=b.transform(o),P=b.transform(_.add(r,l));P.subtract(x),r=x,o=C,l=P}r.add(e),o.add(e),n.setPosition(r),n.setTarget(o),n.setUp(l),i.setCamera(n),(await this._viewer.model.getModelBounding(!1,!1)).isDegenerate()&&this._viewer.view.unsetDefaultCamera()}setOrbitFallbackMode(t){this._orbitFallbackMode=t}getOrbitFallbackMode(){return this._orbitFallbackMode}setOrbitTarget(t){this._orbitTarget=t}getOrbitTarget(){return this._orbitTarget}setPrimaryButton(t){this._primaryButton=t}getPrimaryButton(){return this._primaryButton}}class C_ extends Mi{constructor(t,e,i,n,r){super(t,e),this._activeOperator=null,this._activeTouchCount=0,this._touchMoveCount=0,this._returnToOrbit=!1,this._bimNavigationEnabled=!1,this._orbitOperator=i,this._panOperator=n,this._zoomOperator=r}setBimNavigationEnabled(t){this._bimNavigationEnabled=t;const e=this._orbitOperator,i=this._zoomOperator,n=this._panOperator;e.clearMapping(),i.clearMapping(),n.clearMapping(),e.setMapping(Me.Left),e.setBimOrbitEnabled(t),i.setDollyZoomEnabled(t),t?(e.setPrimaryButton(Me.Left),i.setMapping(Me.Right),n.setMapping(Me.Middle),this._setBimCamera()):(e.addMapping(Me.Middle),e.setPrimaryButton(Me.Middle),i.addMapping(Me.Left,_i.Shift),n.addMapping(Me.Right),n.addMapping(Me.Left,_i.Control))}_setBimCamera(){const t=this._view.getCamera(),e=_.subtract(t.getPosition(),t.getTarget()).normalize(),n=this._viewer.model.getViewAxes().upVector.copy(),r=_.cross(e,n),o=_.cross(r,e);t.setUp(o),t.setProjection(ti.Perspective),this._view.setCamera(t)}getBimNavigationEnabled(){return this._bimNavigationEnabled}onViewOrientationChange(){this._activeTouchCount=0,this._returnToOrbit=!1}onMouseDown(t){super.onMouseDown(t),this._setActiveOperatorForMouseInput(t),this._activeOperator&&(this._bimNavigationEnabled&&this._setBimCamera(),this._activeOperator.onMouseDown(t))}onMouseMove(t){super.onMouseMove(t),this._activeOperator&&this._dragging&&this._dragCount>3&&this._activeOperator.onMouseMove(t)}onMouseUp(t){this._activeOperator&&this._activeOperator.onMouseUp(t),this._activeOperator instanceof og||this._orbitOperator._removeMarkup(),super.onMouseUp(t)}async onMousewheel(t){await this._zoomOperator.onMousewheel(t)}onTouchStart(t){++this._activeTouchCount,this._orbitOperator.onTouchStart(t),this._zoomOperator.onTouchStart(t),this._viewer.sheetManager.isDrawingSheetActive()&&(this._panOperator.onTouchStart(t),this._orbitOperator.onDeactivate()),this._activeTouchCount===1&&(this._primaryTouchId=t.getId()),this._activeTouchCount===2&&(this._orbitOperator.onDeactivate(),this._panOperator.onTouchStart(t),this._zoomOperator.onTouchStart(t))}async onTouchMove(t){++this._touchMoveCount,this._touchMoveCount>5&&(this._returnToOrbit?(this._orbitOperator.onTouchStart(t),this._returnToOrbit=!1):this._activeTouchCount===1?(await this._orbitOperator.onTouchMove(t),await this._zoomOperator.onTouchMove(t),await this._panOperator.onTouchMove(t)):this._activeTouchCount===2&&(await this._zoomOperator.onTouchMove(t),await this._panOperator.onTouchMove(t)))}onTouchEnd(t){this._activeTouchCount===2&&(this._returnToOrbit=!0),this._zoomOperator.onTouchEnd(t),this._panOperator.onTouchEnd(t),this._orbitOperator.onTouchEnd(t),this._activeTouchCount>0&&--this._activeTouchCount,this._activeTouchCount===0&&(this._touchMoveCount=0)}stopInteraction(){const t=[];let e;return e=super.stopInteraction(),e!==void 0&&t.push(e),this._activeTouchCount=0,this._touchMoveCount=0,e=this._zoomOperator.onDeactivate(),e!==void 0&&t.push(e),e=this._panOperator.onDeactivate(),e!==void 0&&t.push(e),e=this._orbitOperator.onDeactivate(),e!==void 0&&t.push(e),Ue(t)}_setActiveOperatorForMouseInput(t){const e=this._orbitOperator,i=this._panOperator,n=this._zoomOperator;this._activeOperator=null,this._viewer.sheetManager.isDrawingSheetActive()?this._activeOperator=i:e.checkMapping(t)?this._activeOperator=e:n.checkMapping(t)?this._activeOperator=n:i.checkMapping(t)&&(this._activeOperator=i)}onDeactivate(){super.onDeactivate(),this._orbitOperator.onDeactivate(),this._panOperator.onDeactivate(),this._zoomOperator.onDeactivate()}}class S_ extends Mi{constructor(t,e){super(t,e),this._cameraPtPrevious=_.zero()}onMouseDown(t){if(super.onMouseDown(t),this.isActive()||this._viewer.sheetManager.isDrawingSheetActive()){const e=this._view,n=e.getCamera().getCameraPlaneIntersectionPoint(t.getPosition(),e);n&&this._cameraPtPrevious.assign(n)}}onMouseMove(t){if(super.onMouseMove(t),this.isActive()||this._viewer.sheetManager.isDrawingSheetActive()){const e=this._view,i=e.getCamera(),n=i.getCameraPlaneIntersectionPoint(t.getPosition(),e);if(n){const r=_.subtract(n,this._cameraPtPrevious);i.dolly(r),e.setCamera(i)}}}}class P_ extends rg{constructor(t,e){super(t,e,i=>{this._rotateAroundAxis(this._rotationAxis,i[0])}),this._rotationAxis=new _(0,0,1),this._tiltAmount=12}async _rotateAroundAxis(t,e){const i=this._view,n=i.getCamera(),r=n.getPosition(),o=n.getUp().normalize(),l=n.getTarget(),h=_t.createFromOffAxisRotation(t,e),u=new _t().setTranslationComponent(-l.x,-l.y,-l.z),d=_t.multiply(u,h),g=new _t().setTranslationComponent(l.x,l.y,l.z);_t.multiply(d,g).transform(r,r),h.transform(o,o),o.normalize(),n.setPosition(r),n.setUp(o),i.setCamera(n),(await this._viewer.model.getModelBounding(!1,!1)).isDegenerate()&&this._viewer.view.unsetDefaultCamera()}onMousewheel(t){const e=t.getWheelDelta(),i=this._view.getCamera(),n=i.getUp().normalize(),r=_.subtract(i.getTarget(),i.getPosition()).normalize(),o=_.cross(n,r).normalize();e>0?this._rotateAroundAxis(o,this._tiltAmount):this._rotateAroundAxis(o,-this._tiltAmount)}_axisToPoint3(t){let e=null;switch(t){case Xe.X:e=new _(1,0,0);break;case Xe.Y:e=new _(0,1,0);break;case Xe.Z:e=new _(0,0,1);break}return e}setRotationAxis(t){let e=null;return t instanceof _?e=t:e=this._axisToPoint3(t),e!==null?(this._rotationAxis.assign(e),!0):!1}}class k_{constructor(t,e,i){this._keyboardWalkOperator=i,this._walkOperator=e,this._activeOperator=e,this._walkMode=hl.Mouse,this._active=!1}async setWalkMode(t){this._walkMode!==t&&(this._walkMode=t,t===hl.Keyboard?(this._activeOperator=this._keyboardWalkOperator,this._active&&(await this._walkOperator.onDeactivate(),await this._keyboardWalkOperator.onActivate())):(this._activeOperator=this._walkOperator,this._active&&(await this._keyboardWalkOperator.onDeactivate(),await this._walkOperator.onActivate())))}getWalkMode(){return this._activeOperator instanceof id?hl.Keyboard:hl.Mouse}onMouseDown(t){this._activeOperator.onMouseDown(t)}onMouseMove(t){this._activeOperator.onMouseMove(t)}onMouseUp(t){this._activeOperator.onMouseUp(t)}onMousewheel(t){this._activeOperator.onMousewheel(t)}onTouchStart(t){this._activeOperator.onTouchStart(t)}async onTouchMove(t){await this._activeOperator.onTouchMove(t)}onTouchEnd(t){this._activeOperator.onTouchEnd(t)}onKeyDown(t){this._activeOperator.onKeyDown(t)}onKeyUp(t){this._activeOperator instanceof id&&this._activeOperator.onKeyUp(t)}onDeactivate(){return this._activeOperator.onDeactivate()}onActivate(){return this._active=!0,this._activeOperator.onActivate()}onViewOrientationChange(){this._active=!1}stopInteraction(){return this._activeOperator.stopInteraction()}async setBimModeEnabled(t){const e=[];return t?(e.push(this._keyboardWalkOperator.enableBimMode()),e.push(this._walkOperator.enableBimMode())):(e.push(this._keyboardWalkOperator.disableBimMode()),e.push(this._walkOperator.disableBimMode())),Promise.all(e).then(()=>{})}async resetDefaultWalkSpeeds(){return Promise.all([this._walkOperator.resetDefaultWalkSpeeds(),this._keyboardWalkOperator.resetDefaultWalkSpeeds()]).then(()=>{})}setBimFloorConfig(t){this._walkOperator.setBimFloorConfig(t),this._keyboardWalkOperator.setBimFloorConfig(t)}setBimWallConfig(t){this._walkOperator.setBimWallConfig(t),this._keyboardWalkOperator.setBimWallConfig(t)}setBimDoorConfig(t){this._walkOperator.setBimDoorConfig(t),this._keyboardWalkOperator.setBimDoorConfig(t)}setZoomSpeed(t){this._walkOperator.setZoomSpeed(t),this._keyboardWalkOperator.setZoomSpeed(t)}setWalkSpeed(t){this._walkOperator.setWalkSpeed(t),this._keyboardWalkOperator.setWalkSpeed(t)}setElevationSpeed(t){this._walkOperator.setElevationSpeed(t),this._keyboardWalkOperator.setElevationSpeed(t)}setRotationSpeed(t){this._walkOperator.setRotationSpeed(t),this._keyboardWalkOperator.setRotationSpeed(t)}setViewAngle(t){this._walkOperator.setViewAngle(t),this._keyboardWalkOperator.setViewAngle(t)}}class M_ extends sg{constructor(t,e){super(t,e),this._timerId=null,this._walkButton=Me.None,this._previousTimestamp=0,this._activeTouchCount=0,this._maxDistance=200}async onActivate(){await super.onActivate(),this._viewer.trigger("walkOperatorActivated")}onKeyDown(t){const e=t.getKeyCode(),i=this.getWalkSpeed();e===Je.PgUp&&this.setWalkSpeed(i*1.2),e===Je.PgDown&&this.setWalkSpeed(i*.8),e===Je.v&&this.toggleBimMode()}async onDeactivate(){const t=this._resetCameraTarget();return this.stopWalking(),await super.onDeactivate(),this._viewer.trigger("walkOperatorDeactivated"),t}_checkProjection(){const t=this._view;t.getProjectionMode()!==ti.Perspective&&(t.setProjectionMode(ti.Perspective),this._calculateInitialPosition())}onMouseDown(t){super.onMouseDown(t),this._checkProjection(),this.isActive()&&(this.stopWalking(),this.setWalkActive(!0),this._walkButton=t.getButton())}onMouseMove(t){super.onMouseMove(t),this.getWalkActive()&&this._timerId===null&&this.isActive()&&(this._previousTimestamp=Date.now(),this._onTick())}onMouseUp(t){this.isActive()&&this.stopWalking(),super.onMouseUp(t)}onTouchStart(t){super.onTouchStart(t),++this._activeTouchCount,this._activeTouchCount===1?this._walkButton=Me.Left:this._activeTouchCount===2?this._walkButton=Me.Right:this._activeTouchCount===3&&(this._walkButton=Me.None)}async onTouchMove(t){if(this._activeTouchCount===3&&this._primaryTouchId===t.getId()){this._ptCurrent.assign(t.getPosition());const e=K.subtract(this._ptCurrent,this._ptPrevious);this._adjustTilt(e.y/100*1.5)}else this._activeTouchCount<3&&await super.onTouchMove(t);return Promise.resolve()}onTouchEnd(t){super.onTouchEnd(t),this._activeTouchCount>0&&--this._activeTouchCount}onMousewheel(t){this._checkProjection(),t.getWheelDelta()>0?this._adjustTilt(3):this._adjustTilt(-3)}stopWalking(){this._timerId!==null&&(cancelAnimationFrame(this._timerId),this._timerId=null),this.setWalkActive(!1)}async _testWalk(t,e,i,n=ke.Default){const r=new Vr(0,0,i,ls.None,_i.None,Xs.Down,n),o=new Vr(0,t,i,ls.None,_i.None,Xs.Move,n),l=new Vr(0,t,i,ls.None,_i.None,Xs.Up,n);this.onMouseDown(r),this.onMouseMove(o),await mu(e),this.onMouseUp(l)}_onTick(){const t=Date.now(),e=(t-this._previousTimestamp)/1e3;this._previousTimestamp=t;const i=this._view,n=K.subtract(this._ptCurrent,this._ptFirst),r=new K(Math.abs(n.x)/this._maxDistance,Math.abs(n.y)/this._maxDistance),o=this.getRotationSpeed()*e*r.x,l=this.getWalkSpeed()*e*r.y,h=this.getElevationSpeed()*e*r.x,u=this.getElevationSpeed()*e*r.y;if(this._walkButton===Me.Left){if(n.x!==0&&(n.x>0?this.rotateRight(o):n.x<0&&this.rotateLeft(o)),n.y!==0){const d=i.getCamera();this._resetPosition(d);const g=d.getTarget(),y=d.getPosition(),m=_.subtract(g,y).normalize(),I=d.getUp();let b=_.scale(m,l);n.y>0&&(b=b.negate()),this.setWalkActive(!0);const x=this.getBimModeEnabled();this.getActiveWalk().set(async()=>{if(x)await this._applyWalkDeltaWithCollisionCheck(d,b,I),await this._applyGravity(),await this._updateNearbyDoors();else return this._applyWalkDelta(d,b)})}}else(this._walkButton===Me.Right||this._walkButton===Me.Middle)&&(Math.abs(n.y)>0&&(n.y>0?this.walkUp(u):this.walkDown(u)),Math.abs(n.x)>0&&(n.x>0?this.walkRight(h):this.walkLeft(h)));this._timerId=requestAnimationFrame(()=>{this._onTick()})}_adjustTilt(t){const e=this._view;this.setTilt(this.getTilt()+t);const i=e.getCamera();this._resetPosition(i);const n=i.getTarget(),r=i.getPosition(),o=_.distance(n,r),l=i.getUp().normalize(),h=_.subtract(n,r).normalize(),u=_.cross(l,h).normalize();_t.createFromOffAxisRotation(u,this.getTilt()).transform(h,h),h.normalize().scale(o),i.setTarget(_.add(r,h)),e.setCamera(i)}async _resetCameraTarget(){const t=this._view,e=t.getCanvasSize(),i=new K(Math.round(e.x/2),Math.round(e.y/2)),n=new yi,r=await t.pickFromPoint(i,n);if(r.isEntitySelection()){const o=t.getCamera();o.setTarget(r.getPosition()),t.updateCamera(o)}}}class Dn extends uo{constructor(t){super(),this._stage=0,this._finalized=!1,this._uniqueId="",this._positions=[],this._name="",this._measurementValue=0,this._unitMultiplier=1,this._textShape=new yl,this._visibility=!0,this._positions=[],this._lineShapes=[],this._viewer=t}getName(){return this._name}setName(t){this._name=t}_getStage(){return this._stage}_nextStage(){this._stage++}_setId(t){this._uniqueId=t}_getId(){return this._uniqueId}adjust(t){}_isFinalized(){return this._finalized}update(){}draw(){this.update()}setVisibility(t){this._visibility=t,this.draw(),t?this._viewer.trigger("measurementShown",this):this._viewer.trigger("measurementHidden",this)}getVisibility(){return this._visibility}toJson(){return{}}getMeasurementValue(){return this._measurementValue}getUnitMultiplier(){return this._unitMultiplier}setMeasurementText(t){this._textShape.setTextString(t)}getMeasurementText(){return this._textShape.getTextString()}isMarkupValid(){return!0}_setMeasurementValue(t){this._measurementValue=t/this._unitMultiplier,this.setMeasurementText(Ua(this._measurementValue,this._unitMultiplier)),this._viewer.trigger("measurementValueSet",this)}static _serializePointArray(t){const e=[];for(const i of t)e.push(i.toJson());return e}static _constructPointArray(t){const e=[];for(const i of t){const n=_.fromJson(i);e.push(n)}return e}}class ag extends Dn{constructor(t,e){super(t),this._rectangle=new Wu,this._markupHandle=null,this._dim=new K(0,0),this.initialPosition=new K(0,0),this.currentPosition=new K(0,0),this.min=new K(0,0),this.max=new K(0,0),this._name="_RectangleMarkup",this._rectangle.setFillOpacity(0),this._rectangle.setStrokeColor(vt.red()),this._constantStrokeColor=e}draw(){this._viewer.markupManager.getRenderer().drawRectangle(this._rectangle)}updateCurrentPosition(t){if(this.currentPosition.assign(t),this._constantStrokeColor||this._rectangle.setStrokeColor(this.initialPosition.x<this.currentPosition.x?vt.red():vt.blue()),this.min.assign(this.initialPosition),this.max.assign(this.currentPosition),this.max.x<this.min.x){const e=this.max.x;this.max.x=this.min.x,this.min.x=e}if(this.max.y<this.min.y){const e=this.max.y;this.max.y=this.min.y,this.min.y=e}this._dim.assign(this.max),this._dim.subtract(this.min),this._updateRectangleVertices()}_updateRectangleVertices(){this._rectangle.setPosition(this.min),this._rectangle.setSize(this._dim)}activate(t){this.initialPosition.assign(t),this.currentPosition.assign(t),this.min.assign(t),this.max.assign(t),this._dim.set(0,0),this._rectangle.setStrokeWidth(1),this._updateRectangleVertices();const e=this._viewer.markupManager;this._markupHandle=e.registerMarkup(this,this._viewer.view)}deactivate(){this.initialPosition.set(0,0),this.currentPosition.set(0,0),this.min.set(0,0),this.max.set(0,0),this._dim.set(0,0),this._rectangle.setStrokeWidth(0),this._updateRectangleVertices();const t=this._viewer.markupManager;this._markupHandle!==null&&(t.unregisterMarkup(this._markupHandle,this._viewer.view),this._markupHandle=null),t.refreshMarkup(this._viewer.view)}isActive(){return this._markupHandle!==null}}class E_ extends Mi{constructor(t,e){super(t,e),this._rectangleMarkup=new ag(t,!0),this._computeTarget=!1,this._preserveViewAngle=!0}setComputeTarget(t){this._computeTarget=t}getComputeTarget(){return this._computeTarget}setPreserveViewAngle(t){this._preserveViewAngle=t}getPreserveViewAngle(){return this._preserveViewAngle}adjustPositionToPlane(t,e){const n=this._view.getCamera().getViewMatrix(this._viewer),r=n.transform(e),o=n.transform(t);r.z=o.z;const l=_t.inverse(n);return l===null?null:l.transform(r)}computeNewField(t,e,i){const n=K.add(t,K.scale(K.subtract(e,t),.5)),r=new K(e.x,n.y),o=new K(n.x,e.y),l=new K(t.x,n.y),h=new K(n.x,t.y),u=this._view.getCamera(),d=u.getCameraPlaneIntersectionPoint(r,this._view),g=u.getCameraPlaneIntersectionPoint(o,this._view),y=u.getCameraPlaneIntersectionPoint(l,this._view),m=u.getCameraPlaneIntersectionPoint(h,this._view);if(d===null||g===null||y===null||m===null)return null;const I=this.adjustPositionToPlane(i,d),b=this.adjustPositionToPlane(i,g),x=this.adjustPositionToPlane(i,y),C=this.adjustPositionToPlane(i,m);if(I===null||b===null||x===null||C===null)return null;const P=_.subtract(I,x),k=_.subtract(b,C);return[P.length(),k.length()]}async computeReasonableTarget(t,e){const i=K.add(t,K.scale(K.subtract(e,t),.5)),n=await this._view.pickFromPoint(i,new yi);if(n.getNodeId()!==null)return n.getPosition();{let r=0;const o=_.zero(),l=await this._view.beginScreenSelectByArea(t,e,new Yc);for(;;){const d=await this._view.advanceIncrementalSelection(l);if(d===null)break;for(const g of d){const y=g.getPosition();y!==null&&(o.add(y),r++)}}let u=this._view.getCamera().getCameraPlaneIntersectionPoint(i,this._view);if(u===null)return null;if(r!==0){const d=_.scale(o,1/r);u=this.adjustPositionToPlane(d,u)}return u}}async getCameraTarget(t,e){if(this._computeTarget)return this.computeReasonableTarget(t,e);const i=this._view.getCamera(),n=K.add(t,K.scale(K.subtract(e,t),.5));return i.getCameraPlaneIntersectionPoint(n,this._view)}async doZoom(t,e){const i=this._view.getCamera(),n=i.copy(),r=i.getTarget(),o=await this.getCameraTarget(t,e);if(o===null)return;const l=this.computeNewField(t,e,o);if(l===null)return;const[h,u]=l,d=this._view.getCanvasSize(),g=new K(0,0),y=_.distance(i.getCameraPlaneIntersectionPoint(d,this._view),i.getCameraPlaneIntersectionPoint(g,this._view));n.setWidth(h),n.setHeight(u),n.setTarget(o),this._viewer.pauseRendering(()=>{this._view.setCamera(n);const m=_.subtract(r,i.getPosition());let I;if(this._preserveViewAngle){const b=_.distance(n.getCameraPlaneIntersectionPoint(d,this._view),n.getCameraPlaneIntersectionPoint(g,this._view)),x=m.length()/y;I=_.add(o,_.scale(m.negate().normalize(),x*b))}else I=_.subtract(o,m);n.setPosition(I),this._view.setCamera(n)})}onMouseDown(t){super.onMouseDown(t),this.isActive()&&(t.setHandled(!0),this._rectangleMarkup.isActive()&&this._rectangleMarkup.deactivate(),this._rectangleMarkup.activate(t.getPosition()))}onMouseMove(t){super.onMouseMove(t),this.isActive()&&this._rectangleMarkup.isActive()&&(t.setHandled(!0),this._rectangleMarkup.updateCurrentPosition(t.getPosition()),this._viewer.markupManager.refreshMarkup(this._view))}async onMouseUp(t){if(this.isActive()&&this._rectangleMarkup.isActive()){const e=this._rectangleMarkup;if(e.updateCurrentPosition(t.getPosition()),K.subtract(e.max,e.min).length()<=3){e.deactivate();return}t.setHandled(!0),await this.doZoom(e.min,e.max)}this._rectangleMarkup.isActive()&&this._rectangleMarkup.deactivate(),super.onMouseUp(t)}}class A_ extends Mi{constructor(t,e){super(t,e),this._mouseMoveZoomDelta=3,this._mouseWheelZoomDelta=.25,this._pinchZoomModifier=2.5,this._zoomToMousePosition=!0,this._dollyZoomEnabled=!1,this._adjustCameraTarget=!1,this._preserveViewAngle=!0,this._mouseMoveZoomFactor=1,this._mouseWheelZoomFactor=-1,this._secondaryTouchId=null,this._lastTouch1=K.zero(),this._lastTouch2=K.zero(),this._prevLen=0}setMouseWheelZoomInverted(t){t?this._mouseWheelZoomFactor=-1:this._mouseWheelZoomFactor=1}getMouseWheelZoomInverted(){return this._mouseWheelZoomFactor===-1}setMouseMoveZoomInverted(t){t?this._mouseMoveZoomFactor=-1:this._mouseMoveZoomFactor=1}getMouseMoveZoomInverted(){return this._mouseMoveZoomFactor===-1}setMouseMoveZoomDelta(t){this._mouseMoveZoomDelta=t}getMouseMoveZoomDelta(){return this._mouseMoveZoomDelta}setMouseWheelZoomDelta(t){this._mouseWheelZoomDelta=t}getMouseWheelZoomDelta(){return this._mouseWheelZoomDelta}setZoomToMousePosition(t){this._zoomToMousePosition=t}getZoomToMousePosition(){return this._zoomToMousePosition}setDollyZoomEnabled(t){this._dollyZoomEnabled=t}getDollyZoomEnabled(){return this._dollyZoomEnabled}setMouseWheelAdjustCameraTarget(t){this._adjustCameraTarget=t}getMouseWheelAdjustCameraTarget(){return this._adjustCameraTarget}setPreserveViewAngle(t){this._preserveViewAngle=t}getPreserveViewAngle(){return this._preserveViewAngle}async onMouseMove(t){if(super.onMouseMove(t),this.isDragging()&&this.isActive()){const e=this._view,i=e.pointToWindowPosition(this._ptCurrent),n=e.pointToWindowPosition(this._ptPrevious),r=i.y-n.y,o=i.x-n.x,l=this._mouseMoveZoomDelta*this._mouseMoveZoomFactor*(r-o);this._dollyZoomEnabled?await this._dollyZoom(l,void 0,void 0,!0):await this._doZoom(l)}}async onMousewheel(t){const e=this._mouseWheelZoomDelta*this._mouseWheelZoomFactor*t.getWheelDelta();this._dollyZoomEnabled?await this._dollyZoom(-e,void 0,t.getPosition()):await this._doZoom(e,void 0,t.getPosition())}onTouchStart(t){const e=this._view;this._primaryTouchId===null?(this._primaryTouchId=t.getId(),this._lastTouch1.assign(e.pointToWindowPosition(t.getPosition()))):this._secondaryTouchId===null&&(this._secondaryTouchId=t.getId(),this._lastTouch2.assign(e.pointToWindowPosition(t.getPosition()))),this._primaryTouchId!==null&&this._secondaryTouchId!==null&&(this._prevLen=K.subtract(this._lastTouch2,this._lastTouch1).length(),this._dragging=!0)}onTouchMove(t){const e=this._view,i=t.getId(),n=t.getPosition();if(i===this._primaryTouchId?this._lastTouch1.assign(e.pointToWindowPosition(n)):i===this._secondaryTouchId&&this._lastTouch2.assign(e.pointToWindowPosition(n)),this._dragging&&(i===this._primaryTouchId||i===this._secondaryTouchId)){const r=K.subtract(this._lastTouch2,this._lastTouch1).length(),l=1/(1-(this._prevLen-r)*this._pinchZoomModifier);this._zoomHelper(l,this._view.getCamera()),this._prevLen=r}return Promise.resolve()}onTouchEnd(t){const e=t.getId();this._primaryTouchId===e?this._primaryTouchId=null:this._secondaryTouchId===e&&(this._secondaryTouchId=null),this._dragging=!1}onDeactivate(){this._primaryTouchId=null,this._secondaryTouchId=null}_updateCameraViewAngle(t){const e=Zr(90),i=Math.tan(e/2),r=_.subtract(t.getTarget(),t.getPosition()).length()*i;return t.setWidth(r),t.setHeight(r),t}async _dollyZoom(t,e=this._view.getCamera(),i,n=!1){const r=this._view;e.setProjection(ti.Perspective);const o=e.getPosition(),l=e.getTarget();if(i){const d=(await this._viewer.model.getModelBounding(!1,!1,!1)).extents().length()/100,y=(await this._view.pickFromPoint(i,new yi)).getPosition();if(y!==null){const I=_.subtract(l,o),b=_.subtract(y,o),x=_.add(o,I.scale(_.dot(I,b)/_.dot(I,I)));e.setTarget(x)}let m=_.subtract(e.getTarget(),o);t>0&&m.length()<d&&e.setTarget(_.add(l,m.copy().normalize().scale(d*2))),m=_.subtract(e.getTarget(),o),e.setPosition(_.add(o,m.copy().scale(t/10)))}else{const h=_.subtract(l,o).scale(t/10);e.setPosition(_.add(o,h)),n&&e.setTarget(_.add(l,h))}e=this._updateCameraViewAngle(e),this._viewer.pauseRendering(()=>{if(i){const h=e.getCameraPlaneIntersectionPoint(i,this._view);r.setCamera(e);const u=e.getCameraPlaneIntersectionPoint(i,this._view);h!==null&&u!==null&&e.dolly(_.subtract(u,h))}r.setCamera(e)})}async _doZoom(t,e=this._view.getCamera(),i){const n=this._view,r=Math.max(1/(1-t),.001);if(i&&this._zoomToMousePosition){if(this._adjustCameraTarget){const o=await this._view.pickFromPoint(i,new yi);if(o!==void 0&&o.isEntitySelection()){const l=e.getPosition().subtract(e.getTarget()),h=_.subtract(e.getTarget(),e.getPosition()),u=_.subtract(o.getPosition(),e.getPosition()),d=e.getPosition().add(h.scale(_.dot(h,u)/_.dot(h,h)));e.setTarget(d),e.setPosition(_.add(d,l))}}this._viewer.pauseRendering(()=>{const o=e.getCameraPlaneIntersectionPoint(i,this._view);this._zoomHelper(r,e);const l=e.getCameraPlaneIntersectionPoint(i,this._view);o!==null&&l!==null&&e.dolly(_.subtract(l,o)),n.setCamera(e)})}else this._zoomHelper(r,e)}_zoomHelper(t,e){const i=this._view;if(e.setWidth(e.getWidth()*t),e.setHeight(e.getHeight()*t),this._preserveViewAngle&&!this._viewer.sheetManager.isDrawingSheetActive()){const n=e.getPosition(),r=e.getTarget(),o=_.subtract(r,n).scale(t),l=_.subtract(r,o);e.setPosition(l)}i.setCamera(e)}}const Fb=Object.freeze(Object.defineProperty({__proto__:null,CameraKeyboardWalkOperator:id,CameraNavigationOperator:C_,CameraOrbitBaseOperator:rg,CameraOrbitOperator:og,CameraPanOperator:S_,CameraTurntableOperator:P_,CameraWalkBaseOperator:sg,CameraWalkModeOperator:k_,CameraWalkOperator:M_,CameraWindowZoomOperator:E_,CameraZoomOperator:A_,DoorCache:b_,MAX_ANGLE:m_,MAX_TILT:g_,MIN_ANGLE:__,MIN_TILT:p_,OrbitMarkup:x_,TimedPoints:I_,applyGravity:ig,buildCollisionRayConfig:eg,clamp:tg,getDownAxis:w_,normalizeDirections:y_,removeOpposing:vl,testWallCollision:v_},Symbol.toStringTag,{value:"Module"}));var Fs=(s=>(s[s.NoPointsSelected=0]="NoPointsSelected",s[s.OnePointSelected=1]="OnePointSelected",s[s.TwoPointsSelected=2]="TwoPointsSelected",s))(Fs||{}),bl=(s=>(s[s.First=0]="First",s[s.Last=1]="Last",s[s.Midpoint=2]="Midpoint",s))(bl||{}),Il=(s=>(s[s.First=0]="First",s[s.Last=1]="Last",s[s.Midpoint=2]="Midpoint",s))(Il||{});function nd(s,t){const e=new rr(t.x,t.y,t.z,1),i=new rr(0,0,0,0);s.getFullCameraMatrix().transform4(e,i);const n=1/i.w,r=new K(i.x*n,i.y*n),{x:o,y:l}=s.getCanvasSize();return r.x=.5*o*(r.x+1),r.y=.5*l*(r.y+1),r.x=Math.max(0,Math.min(r.x,o)),r.y=l-Math.max(0,Math.min(r.y,l)),r}const yh=class yh extends Dn{constructor(t){super(t),this._firstNode=null,this._firstPointShape=new Br,this._secondPointShape=new Br,this._arrowsInvert=!1,this._measurePoint1=null,this._measurePoint2=null,this._leaderPoint1=null,this._leaderPoint2=null,this._textPoint=null,this._name="MeasureBodyBodyDistance",this._lineShapes=[];for(let e=0;e<6;e++)this._lineShapes.push(new ts),this._lineShapes[e].setStrokeColor(this._viewer.measureManager.getMeasurementColor()),this._lineShapes[e].setEndEndcapColor(this._viewer.measureManager.getMeasurementColor()),this._lineShapes[e].setStartEndcapColor(this._viewer.measureManager.getMeasurementColor());this._viewer=t,this.initCircle(this._firstPointShape),this.initCircle(this._secondPointShape),this._textShape=new yl,this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(new vt(255,255,255))}initCircle(t){t.setRadius(2.5),t.setFillColor(this._viewer.measureManager.getMeasurementColor())}setUnitMultiplier(t){this._unitMultiplier=t}setFirstNode(t){this._stage=1,this._firstNode=t}getFirstNode(){return this._firstNode}async setSecondNode(t){if(this._firstNode===null)return;this._stage=2;const e=await this._viewer.model.computeMinimumBodyBodyDistance(this._firstNode,t);this._measurePoint1=e.pos1.copy(),this._measurePoint2=e.pos2.copy(),this._textPoint=e.pos2.copy(),this._setMeasurementValue(e.distance)}_getStage(){return this._stage}finalize(){this._stage++}adjust(t){if(super.adjust(t),this._stage<2)return;const e=this._viewer.view.raycastFromPoint(t);if(e===null||this._measurePoint1===null||this._measurePoint2===null||this._textPoint==null)return;let i=new _(1,0,0);this._measurePoint2.equals(this._measurePoint1)||(i=_.subtract(this._measurePoint2,this._measurePoint1));const r=this._viewer.view.getCamera().getUp(),o=_.cross(e.direction,r).normalize(),l=new _((this._measurePoint1.x+this._measurePoint2.x)/2,(this._measurePoint1.y+this._measurePoint2.y)/2,(this._measurePoint1.z+this._measurePoint2.z)/2),h=new _(l.x+r.x,l.y+r.y,l.z+r.z),u=new _(l.x+o.x,l.y+o.y,l.z+o.z),d=new _(e.origin.x+e.direction.x*1e6,e.origin.y+e.direction.y*1e6,e.origin.z+e.direction.z*1e6);let g=new _(0,0,0);Qr(e.origin,d,l,h,u,g),this._textPoint.assign(g);let y=new _(0,0,0);Math.abs(i.x)<=Math.abs(i.y)&&Math.abs(i.x)<=Math.abs(i.z)?y=new _(1,0,0):Math.abs(i.y)<=Math.abs(i.x)&&Math.abs(i.y)<=Math.abs(i.z)?y=new _(0,1,0):y=new _(0,0,1);const m=_.cross(y,i),I=_.cross(m,i);m.set(this._measurePoint1.x+m.x,this._measurePoint1.y+m.y,this._measurePoint1.z+m.z),I.set(this._measurePoint1.x+I.x,this._measurePoint1.y+I.y,this._measurePoint1.z+I.z);const b=new _(g.x+i.x*1e4,g.y+i.y*1e4,g.z+i.z*1e4),x=new _(g.x-i.x*1e4,g.y-i.y*1e4,g.z-i.z*1e4),C=Qr(b,x,this._measurePoint1,m,I,g),P=!isNaN(g.x)&&!isNaN(g.y)&&!isNaN(g.z);(!C||!P)&&(g=this._measurePoint2.copy());const k=_.subtract(g,this._measurePoint1);this._leaderPoint1=new _(this._measurePoint1.x+k.x,this._measurePoint1.y+k.y,this._measurePoint1.z+k.z),this._leaderPoint2=new _(this._measurePoint2.x+k.x,this._measurePoint2.y+k.y,this._measurePoint2.z+k.z),this._updateArrowsInverted(),this._viewer.markupManager.refreshMarkup(this._viewer.view)}_updateArrowsInverted(){if(this._leaderPoint1===null||this._leaderPoint2===null||this._textPoint===null)return;const t=new _((this._leaderPoint1.x+this._leaderPoint2.x)/2,(this._leaderPoint1.y+this._leaderPoint2.y)/2,(this._leaderPoint1.z+this._leaderPoint2.z)/2),e=_.subtract(this._leaderPoint2,this._leaderPoint1);_.subtract(this._textPoint,t).length()*2>e.length()?this._arrowsInvert=!0:this._arrowsInvert=!1}update(){if(super.update(),this._stage<=1)return;const t=this._viewer.view;this._behindView=!1;const e=h=>{if(h===null)return K.zero();const u=t.projectPoint(h);return u.z<=0&&(this._behindView=!0),K.fromPoint3(u)},i=e(this._measurePoint1),n=e(this._measurePoint2),r=e(this._textPoint),o=e(this._leaderPoint1),l=e(this._leaderPoint2);this._firstPointShape.setCenter(i),this._textShape&&this._textShape.setPosition(r),this._secondPointShape.setCenter(n),this._lineShapes[0].set(i,n),this._lineShapes[1].set(o,l),this._lineShapes[2].set(i,o),this._lineShapes[3].set(n,l),this._lineShapes[4].set(o,r),this._lineShapes[5].set(o,l),this._lineShapes[5].setEndcapType(gn.Arrowhead),this._lineShapes[5].setStartEndcapType(gn.Arrowhead),this._lineShapes[5].setEndcapsInverted(this._arrowsInvert)}draw(){if(!this._visibility||this._viewer.explodeManager.getMagnitude()!==0||(this.update(),this._behindView))return;const t=this._viewer.markupManager.getRenderer();if(this._stage===2||this._stage===3){t.drawCircle(this._firstPointShape),t.drawCircle(this._secondPointShape);for(const e of this._lineShapes)t.drawLine(e);t.drawTextBox(this._textShape)}}toJson(){return this._toJson()}_toJson(){return{name:this._name,measurePoint1:this._measurePoint1,measurePoint2:this._measurePoint2,leaderPoint1:this._leaderPoint1,leaderPoint2:this._leaderPoint2,textPoint:this._textPoint,text:this._textShape.getTextString(),measurementValue:this._measurementValue,unitMultiplier:this._unitMultiplier,className:this.getClassName()}}static fromJson(t,e){const i=t,n=new yh(e);return n._name=i.name,n._measurePoint1=_.fromJson(i.measurePoint1),n._measurePoint2=_.fromJson(i.measurePoint2),n._textPoint=_.fromJson(i.textPoint),n._textShape.setTextString(i.text),n._leaderPoint1=_.fromJson(i.leaderPoint1),n._leaderPoint2=_.fromJson(i.leaderPoint2),n._measurementValue=i.measurementValue,n._unitMultiplier=i.unitMultiplier||1,n._updateArrowsInverted(),n._stage=2,n}getClassName(){return yh.className}};yh.className="Communicator.Markup.Measure.MeasureBodyBodyDistanceMarkup";let xl=yh;ss(xl.className,xl.fromJson);class T_ extends Mi{constructor(t,e,i){super(t,e),this._moveSelectionAction=new no(!0),this._currentMoveHighlight=null,this._currentSelectHighlight=null,this._markup=null,this._measureManager=i}_unsetCurrentMoveHighlight(){this._currentMoveHighlight!==null&&(this._viewer.model.setNodesHighlighted([this._currentMoveHighlight.getNodeId()],!1),this._currentMoveHighlight=null)}_unsetCurrentSelectionHighlight(){this._currentSelectHighlight!==null&&(this._viewer.model.setNodesHighlighted([this._currentSelectHighlight.getNodeId()],!1),this._currentSelectHighlight=null)}async _performMoveSelection(t){const e=this._view,i=this._viewer.model,n=await e.pickFromPoint(t,new yi);if(n.overlayIndex()!==0||!n.isNodeSelection()){this._unsetCurrentMoveHighlight();return}const r=n.getNodeId();if(!(r===null||i.getNodeType(r)!==Ne.BodyInstance)){if(this._markup){const o=this._markup.getFirstNode();if(o!==null&&r===o)return}this._currentMoveHighlight!==null?n.equals(this._currentMoveHighlight)?n.getSelectionType()===Pn.None&&this._unsetCurrentMoveHighlight():(this._unsetCurrentMoveHighlight(),this._currentMoveHighlight=n,i.setNodesHighlighted([r],!0)):(this._currentMoveHighlight=n,i.setNodesHighlighted([r],!0))}}async _performUpSelection(t){const e=this._view,i=this._viewer.model,n=await e.pickFromPoint(t,new yi);if(n.overlayIndex())return;if(this._markup&&this._markup._getStage()===1&&this._viewer.trigger("measurementBegin"),this._markup&&this._markup._getStage()>1){const o=this._markup;this._markup=null,o.finalize(),this._measureManager.finalizeMeasurement(o);return}const r=n.getNodeId();r!==null&&i.getNodeType(r)===Ne.BodyInstance&&(!this._markup||this._markup._getStage()<=1)&&(this._unsetCurrentMoveHighlight(),this._markup?(this._unsetCurrentSelectionHighlight(),await this._markup.setSecondNode(r),this._markup.adjust(t)):(this._markup=new xl(this._viewer),this._markup.setUnitMultiplier(i.getNodeUnitMultiplier(r)),this._markup.setFirstNode(r),n.isNodeSelection()&&(this._unsetCurrentSelectionHighlight(),this._currentSelectHighlight=n,this._viewer.model.setNodesHighlighted([r],!0)),this._measureManager.addMeasurement(this._markup)))}onMouseMove(t){super.onMouseMove(t);const e=t.getPosition();(!this._markup||this._markup._getStage()<=1)&&this._moveSelectionAction.set(()=>this._performMoveSelection(e)),this._viewer.markupManager.refreshMarkup(this._viewer.view),this._markup!==null&&this._markup._getStage()>0&&this._markup.adjust(e)}async _onMouseUpImpl(t){if(!this.isActive())return;const e=this._primaryTouchId!==null&&this._markup!==null&&this._markup._getStage()>1;if(!(this._dragCount<3||e))return;const i=t.getPosition();await this._performUpSelection(i)}async onMouseUp(t){await this._onMouseUpImpl(t),super.onMouseUp(t)}setDraggingEnabled(t){this._dragging=t}onKeyUp(t){}onKeyDown(t){t.getKeyCode()===Je.Escape&&(this._markup!==null?(this._measureManager.removeMeasurement(this._markup),this._markup=null):this._measureManager.removeLastMeasurement())}setHandled(){return this._markup!==null&&this._markup._getStage()>1}onDeactivate(){super.onDeactivate(),this._unsetCurrentMoveHighlight(),this._markup!==null&&(this._measureManager.removeMeasurement(this._markup),this._markup=null)}}const yd=class yd extends Dn{constructor(t){super(t),this._lineEdgeShape=new ya,this._linePositions=[],this._name="MeasureLength",this._positions=[],this._lineShapes=[],this._lineEdgeShape.setStrokeWidth(4),this._lineEdgeShape.setStrokeColor(t.measureManager.getMeasurementEdgeColor())}setLineGeometry(t){this._linePositions=t,this._stage=1}setMeasurementEdgeColor(t){this._lineEdgeShape.setStrokeColor(t)}reset(){this._stage=0}adjust(t){super.adjust(t)}draw(){}getLineEdgeShape(){return this._lineEdgeShape}getClassName(){return yd.className}};yd.className="Communicator.Markup.Measure.MeasureLengthMarkup";let sh=yd;const wh=class wh extends sh{constructor(t,e,i,n){super(t),this._circlePoints=[],this._radius=0,this._surfaceCenter=_.zero(),this._circlePlane=new Ki,this._arrowsInvert=!1,this._name="MeasureCircleEdgeLength",this._lineProperties=e,this._matrix=i.copy(),this._unitMultiplier=n,this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(new vt(255,255,255));const o=t.measureManager.getMeasurementColor();for(let l=0;l<5;l++)this._lineShapes.push(new ts),this._lineShapes[l].setStrokeColor(o),this._lineShapes[l].setEndEndcapColor(o),this._lineShapes[l].setStartEndcapColor(o)}createCircleData(){pp(this._circlePoints,this._lineProperties.origin,this._lineProperties.radius,32,this._lineProperties.normal),this._matrix.transformArray(this._circlePoints,this._circlePoints),this._positions[0]=this._circlePoints[0].copy(),this._positions[1]=this._circlePoints[16].copy();const t=new _(this._lineProperties.radius,0,0),e=new _(0,0,0);this._matrix.transform(t,t),this._matrix.transform(e,e);let i=_.subtract(e,t);this._radius=i.length(),i=_.subtract(this._positions[1],this._positions[0]),this._positions[4]=this._positions[1].copy(),this._surfaceCenter=this._matrix.transform(this._lineProperties.origin);const n=new _(this._circlePoints[0].x,this._circlePoints[0].y,this._circlePoints[0].z),r=new _(this._circlePoints[1].x,this._circlePoints[1].y,this._circlePoints[1].z);this._circlePlane=Ki.createFromPoints(n,r,this._surfaceCenter)}setLineGeometry(t){if(super.setLineGeometry(t),this._positions[0]=this._linePositions[0],this._positions[0].equals(this._positions[this._positions.length-1])){const e=Math.floor(this._positions.length/2);this._positions[1]=this._positions[e]}else this._positions[1]=this._linePositions[this._linePositions.length-1];this._positions[1]=this._linePositions[this._linePositions.length-1],this._positions[2]=this._linePositions[1].copy(),this.createCircleData(),this._setMeasurementValue(this._radius)}adjust(t){super.adjust(t);const e=this._viewer.view.raycastFromPoint(t);if(e===null)return;const i=this._surfaceCenter,n=this._circlePlane;let r=n.rayIntersection(e);if(r===null){const u=_.add(i,e.direction.copy().scale(-2*this._radius)),g=Ki.createFromPointAndNormal(u,e.direction).rayIntersection(e);console.assert(g!==null);const y=new Ws(g,n.normal);r=n.rayIntersection(y),r===null&&(r=n.rayIntersection(y.negate()))}r===null&&(console.assert(!1),r=i.copy());const o=_.subtract(r,i).normalize().scale(this._radius),l=_.add(i,o),h=_.subtract(i,o);this._positions[0]=l,this._positions[1]=h,this._positions[2]=l.copy(),this._positions[3]=h.copy(),this._positions[4]=r.copy(),this._positions[5]=this._surfaceCenter.copy(),this._updateArrowsInverted(),this._viewer.markupManager.refreshMarkup(this._viewer.view)}_updateArrowsInverted(){const t=new _((this._positions[4].x+this._positions[5].x)/2,(this._positions[4].y+this._positions[5].y)/2,(this._positions[4].z+this._positions[5].z)/2),e=_.subtract(this._positions[5],this._positions[4]),i=_.subtract(this._positions[2],t);this._arrowsInvert=i.length()*2>e.length()}update(){super.update();const t=this._viewer.view;if(this._stage>0){this._lineEdgeShape.clearPoints();for(const e of this._linePositions){const i=K.fromPoint3(t.projectPoint(e));this._lineEdgeShape.pushPoint(i)}}if(this._stage>1){const e=new Array(6);for(let i=0;i<this._positions.length;i++)e[i]=K.fromPoint3(t.projectPoint(this._positions[i]));this._textShape&&this._textShape.setPosition(e[4]),this._lineShapes[0].set(e[5],e[2]),this._lineShapes[1].set(e[5],e[4]),this._lineShapes[0].setEndcapType(gn.Arrowhead),this._lineShapes[0].setStartEndcapType(gn.None),this._lineShapes[0].setEndcapsInverted(this._arrowsInvert)}}draw(){if(this._visibility&&this._viewer.explodeManager.getMagnitude()===0){this.update();const e=this._viewer.markupManager.getRenderer();switch(this._stage){case 1:e.drawPolyline(this._lineEdgeShape);break;case 2:case 3:for(let i=0;i<2;i++)e.drawLine(this._lineShapes[i]);e.drawTextBox(this._textShape),e.drawPolyline(this._lineEdgeShape);break}}}toJson(){return this._toJson()}_toJson(){const t=Dn._serializePointArray(this._linePositions),e=Dn._serializePointArray(this._positions);return{matrix:this._matrix.toJson(),lineOrigin:this._lineProperties.origin,lineRadius:this._lineProperties.radius,lineNormal:this._lineProperties.normal,linePositions:t,positions:e,text:this._textShape.getTextString(),measurementValue:this._measurementValue,unitMultiplier:this._unitMultiplier,className:this.getClassName()}}static fromJson(t,e){const i=t,n=_t.fromJson(i.matrix),r=i.lineRadius,o=_.fromJson(i.lineOrigin),l=_.fromJson(i.lineNormal),h=new Ya(r,o,l),u=i.unitMultiplier||1,d=new wh(e,h,n,u),g=Dn._constructPointArray(i.linePositions),y=Dn._constructPointArray(i.positions);return d.setLineGeometry(g),d._positions=y,d._textShape.setTextString(i.text),d._stage=3,d._measurementValue=i.measurementValue,d}getClassName(){return wh.className}};wh.className="Communicator.Markup.Measure.MeasureCircleEdgeLengthMarkupMeasureMarkup";let Cl=wh;ss(Cl.className,Cl.fromJson);const vh=class vh extends sh{constructor(t,e,i,n){super(t),this._lineProperties=null,this._worldSpaceLength=0,this._arrowsInvert=!1,this._name="MeasureStraightEdgeLength",this._lineProperties=e,this._matrix=i.copy(),this._matrix.setTranslationComponent(0,0,0),this._unitMultiplier=n;const o=this._viewer.measureManager.getMeasurementColor();for(let h=0;h<5;h++){const u=new ts;u.setStrokeColor(o),u.setEndEndcapColor(o),u.setStartEndcapColor(o),this._lineShapes.push(u)}const l=this._textShape.getBoxPortion();l.setFillOpacity(1),l.setFillColor(new vt(255,255,255))}setLineGeometry(t){super.setLineGeometry(t),this._positions[0]=this._linePositions[0],this._positions[2]=this._linePositions[0].copy(),this._positions[1]=this._linePositions[this._linePositions.length-1];let e;if(this._lineProperties!==null&&this._lineProperties.length!==-1){const i=new _(this._lineProperties.length,0,0);this._matrix.transform(i,i),this._worldSpaceLength=i.length(),e=this._worldSpaceLength}else e=_.subtract(this._positions[1],this._positions[0]).length();this._setMeasurementValue(e)}adjust(t){super.adjust(t);const e=this._viewer.view,i=e.raycastFromPoint(t);if(i===null)return;const n=this._positions[0],r=this._positions[1];let o=new _(1,0,0);r.equals(n)||(o=_.subtract(r,n));const h=e.getCamera().getUp(),u=_.cross(i.direction,h).normalize(),d=_.add(n,r).scale(.5),g=_.add(d,h),y=_.add(d,u),m=_.add(_.scale(i.direction,1e6),i.origin),I=new _(0,0,0);Qr(i.origin,m,d,g,y,I),this._positions[2].assign(I);let b=new _(0,0,0);Math.abs(o.x)<=Math.abs(o.y)&&Math.abs(o.x)<=Math.abs(o.z)?b=new _(1,0,0):Math.abs(o.y)<=Math.abs(o.x)&&Math.abs(o.y)<=Math.abs(o.z)?b=new _(0,1,0):b=new _(0,0,1);const x=_.cross(b,o),C=_.cross(x,o);x.add(n),C.add(n);const P=_.add(_.scale(o,1e4),I),k=_.add(_.scale(o,-1e4),I);Qr(P,k,n,x,C,I);const O=_.subtract(I,n);this._positions[3]=_.add(n,O),this._positions[4]=_.add(r,O),this._updateArrowsInverted(),this._viewer.markupManager.refreshMarkup(this._viewer.view)}_updateArrowsInverted(){const t=_.add(this._positions[3],this._positions[4]).scale(.5),e=_.subtract(this._positions[4],this._positions[3]),i=_.subtract(this._positions[2],t);this._arrowsInvert=2*i.squaredLength()>e.squaredLength()}update(){super.update();const t=this._viewer.view;if(this._behindView=!1,this._stage>0){this._lineEdgeShape.clearPoints();const e=Array(this._linePositions.length);for(let i=0;i<this._linePositions.length;i++)e[i]=t.projectPoint(this._linePositions[i]),e[i].z<=0&&(this._behindView=!0),this._lineEdgeShape.pushPoint(K.fromPoint3(e[i]))}if(this._stage>1){const e=new Array(6),i=Array(6);for(let n=0;n<this._positions.length;n++)i[n]=t.projectPoint(this._positions[n]),i[n].z<=0&&(this._behindView=!0),e[n]=K.fromPoint3(i[n]);this._textShape&&this._textShape.setPosition(e[2]),this._lineShapes[0].set(e[3],e[4]),this._lineShapes[1].set(e[0],e[3]),this._lineShapes[2].set(e[1],e[4]),this._lineShapes[3].set(e[3],e[2]),this._lineShapes[4].set(e[3],e[4]),this._lineShapes[4].setEndcapType(gn.Arrowhead),this._lineShapes[4].setStartEndcapType(gn.Arrowhead),this._lineShapes[4].setEndcapsInverted(this._arrowsInvert)}}draw(){if(this._visibility&&this._viewer.explodeManager.getMagnitude()===0&&(this.update(),!this._behindView)){const t=this._viewer.markupManager.getRenderer();switch(this._stage){case 1:t.drawPolyline(this._lineEdgeShape);break;case 2:case 3:for(const e of this._lineShapes)t.drawLine(e);t.drawTextBox(this._textShape),t.drawPolyline(this._lineEdgeShape);break}}}toJson(){return this._toJson()}_toJson(){return{name:this._name,measurePoint1:this._positions[0].copy(),measurePoint2:this._positions[1].copy(),leaderPoint1:this._positions[3].copy(),leaderPoint2:this._positions[4].copy(),textPoint:this._positions[2].copy(),text:this._textShape.getTextString(),measurementValue:this._measurementValue,unitMultiplier:this._unitMultiplier,className:this.getClassName(),matrix:this._matrix.toJson()}}static fromJson(t,e){const i=t,n=_t.fromJson(i.matrix),r=i.unitMultiplier||1,o=new vh(e,null,n,r);return o._name=i.name,o._positions[0]=_.fromJson(i.measurePoint1),o._positions[1]=_.fromJson(i.measurePoint2),o._positions[2]=_.fromJson(i.textPoint),o._textShape.setTextString(i.text),o._positions[3]=_.fromJson(i.leaderPoint1),o._positions[4]=_.fromJson(i.leaderPoint2),o._measurementValue=i.measurementValue,o._updateArrowsInverted(),o._stage=2,o}getClassName(){return vh.className}};vh.className="Communicator.Markup.Measure.MeasureStraightEdgeLengthMarkup";let rh=vh;class N_ extends Mi{constructor(t,e,i){super(t,e),this._pickConfig=new yi(xe.Line),this._moveSelectionAction=new no(!0),this._lengthMarkup=null,this._edgeMarkup=null,this._measureManager=i,this._pickConfig.restrictLinesAndPointsToSelectedFaceInstances=!1}onActivate(){this._edgeMarkup===null&&(this._edgeMarkup=new rh(this._viewer,null,new _t,1))}_unregisterEdgeMarkup(){if(this._edgeMarkup===null)return;const t=this._edgeMarkup._getId();t!==""&&(this._viewer.markupManager.unregisterMarkup(t,this._viewer.view),this._edgeMarkup._setId(""))}_registerEdgeMarkup(){this._edgeMarkup!==null&&(this._unregisterEdgeMarkup(),this._edgeMarkup._setId(this._viewer.markupManager.registerMarkup(this._edgeMarkup,this._viewer.view)))}_resetEdgeMarkup(){this._edgeMarkup!==null&&(this._unregisterEdgeMarkup(),this._edgeMarkup.reset())}async _performMoveSelection(t,e){const n=await this._view.pickFromPoint(t,this._pickConfig),r=n.getNodeId(),o=n.getLineEntity();r&&o&&!o.isCappingGeometry()&&n.overlayIndex()===0&&await this._viewer.model.isLineMeasurable(r,o.getLineId())?(e.setLineGeometry(o.getPoints()),this._registerEdgeMarkup()):this._resetEdgeMarkup()}async _performUpSelection(t){const e=this._view,i=this._viewer.model,n=await e.pickFromPoint(t,this._pickConfig);if(n.overlayIndex())return;if(this._lengthMarkup&&this._lengthMarkup._getStage()===2){const d=this._lengthMarkup;this._lengthMarkup=null,d._nextStage(),this._measureManager.finalizeMeasurement(d);return}if(this._lengthMarkup||!n.isLineSelection())return;const r=n.getNodeId();if(!r)return;const o=n.getLineEntity();if(!await this._viewer.model.isLineMeasurable(r,o.getLineId()))return;const h=i.getNodeUnitMultiplier(r),u=await i.getEdgeProperty(r,o.getLineId());if(this._viewer.trigger("measurementBegin"),!!u){if(u instanceof dc||u instanceof So){const d=i.getNodeNetMatrix(r);this._lengthMarkup=new rh(this._viewer,u,d,h),this._measureManager.addMeasurement(this._lengthMarkup),this._lengthMarkup.setLineGeometry(o.getPoints()),this._lengthMarkup._nextStage(),this._lengthMarkup.adjust(t)}else if(u instanceof Ya){const d=i.getNodeNetMatrix(r);this._lengthMarkup=new Cl(this._viewer,u,d,h),this._measureManager.addMeasurement(this._lengthMarkup),this._lengthMarkup.setLineGeometry(o.getPoints()),this._lengthMarkup._nextStage(),this._lengthMarkup.adjust(t)}this._lengthMarkup._getStage()===2&&this._viewer.trigger("measurementValueSet",this._lengthMarkup)}}onMouseMove(t){super.onMouseMove(t);const e=this._edgeMarkup;if(e===null)return;e.setMeasurementEdgeColor(this._viewer.measureManager.getMeasurementEdgeColor());const i=t.getPosition();this.isDragging()&&this._primaryTouchId===null?this._resetEdgeMarkup():(this._lengthMarkup===null&&this._moveSelectionAction.set(()=>this._performMoveSelection(i,e)),this._viewer.markupManager.refreshMarkup(this._viewer.view),this._lengthMarkup!==null&&this._lengthMarkup._getStage()>0&&this._lengthMarkup.adjust(i))}async _onMouseUpImpl(t){if(!this.isActive())return;const e=this._primaryTouchId!==null&&this._lengthMarkup!==null;if(!(this._dragCount<3||e))return;const i=t.getPosition();await this._performUpSelection(i)}onMouseUp(t){this._onMouseUpImpl(t),super.onMouseUp(t)}setDraggingEnabled(t){this._dragging=t}onKeyUp(t){}onKeyDown(t){t.getKeyCode()===Je.Escape&&(this._lengthMarkup!==null?(this._measureManager.removeMeasurement(this._lengthMarkup),this._lengthMarkup=null):this._measureManager.removeLastMeasurement(),this._edgeMarkup!==null&&this._resetEdgeMarkup())}setHandled(){return this._lengthMarkup!==null}onDeactivate(){this._lengthMarkup!==null&&(this._measureManager.removeMeasurement(this._lengthMarkup),this._lengthMarkup=null),this._edgeMarkup!==null&&this._resetEdgeMarkup()}}const D_=30,bh=class bh extends Dn{constructor(t){super(t),this._faceSelection=[],this._arcArray=[],this._lineGeometryShape=new ya,this.planeIntersectionLine=[],this._pointOnLine=_.zero(),this._clickpointOriginal2=_.zero(),this._clickpointOriginal1=_.zero(),this._plane1=new Ki,this._plane2=new Ki,this._secondPoint=_.zero(),this._firstPoint=_.zero(),this._textPos=_.zero(),this._intermediatePoint=_.zero(),this._textAnchorPoint=_.zero(),this._angle=0,this._useAuthoredNormals=!0,this._name="MeasureFaceFaceAngle";const i=this._viewer.measureManager.getMeasurementColor();this._lineGeometryShape.setStrokeWidth(2),this._lineGeometryShape.setStrokeColor(i),this._lineGeometryShape.setEndEndcapColor(i),this._lineGeometryShape.setStartEndcapColor(i),this._textShape=new yl,this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(new vt(255,255,255));for(let n=0;n<5;n++)this._lineShapes.push(new ts),this._lineShapes[n].setStrokeColor(i),this._lineShapes[n].setEndEndcapColor(i),this._lineShapes[n].setStartEndcapColor(i)}async _getNormalAndPositionFromSelection(t,e,i){const n=t.getNodeId(),r=t.getFaceEntity().getCadFaceIndex();i.assign(t.getPosition().copy()),e.assign(t.getFaceEntity().getNormal());const o=await this._viewer.model.getFaceProperty(n,r);if(this._useAuthoredNormals&&o!==null&&o instanceof Wi){const h=this._viewer.model.getNodeNetMatrix(n).normalMatrix();h!==null&&h.transform(o.normal,e)}}getFirstSelection(){return this._faceSelection[0]}async setFirstFace(t){const e=t.getNodeId(),i=t.getFaceEntity().getCadFaceIndex();this._viewer.model.setNodeFaceColor(e,i,new vt(255,0,0)),this._faceSelection.push(t);const n=_.zero(),r=_.zero();await this._getNormalAndPositionFromSelection(t,n,r),this._firstPoint=r.copy(),this._plane1.setFromPointAndNormal(this._firstPoint,n),this._clickpointOriginal1=t.getPosition().copy(),this._stage++}async setSecondFace(t){const e=t.getNodeId(),i=t.getFaceEntity().getCadFaceIndex();this._faceSelection[1]=t,this._viewer.model.setNodeFaceColor(e,i,new vt(255,0,0));const n=_.zero(),r=_.zero();if(await this._getNormalAndPositionFromSelection(t,r,n),this._secondPoint=n.copy(),this._plane2.setFromPointAndNormal(this._secondPoint,r),this.planeIntersectionLine[0]=new _(0,0,0),this.planeIntersectionLine[1]=new _(0,0,0),gp(this._plane1,this._firstPoint,this._plane2,this._secondPoint,this.planeIntersectionLine[0],this.planeIntersectionLine[1])!==2)return!1;const l=_.subtract(this.planeIntersectionLine[1],this.planeIntersectionLine[0]);l.normalize(),this.planeIntersectionLine[0].set(this.planeIntersectionLine[0].x-l.x*100,this.planeIntersectionLine[0].y-l.y*100,this.planeIntersectionLine[0].z-l.z*100),this.planeIntersectionLine[1].set(this.planeIntersectionLine[1].x+l.x*100,this.planeIntersectionLine[1].y+l.y*100,this.planeIntersectionLine[1].z+l.z*100),kr(this._secondPoint,this.planeIntersectionLine[0],this.planeIntersectionLine[1],this._pointOnLine);const h=new _(0,0,0),u=new _(0,0,0);h.set(this._firstPoint.x+l.x,this._firstPoint.y+l.y,this._firstPoint.z+l.z),kr(this._pointOnLine,this._firstPoint,h,u),this._firstPoint=u.copy(),this._clickpointOriginal2=t.getPosition().copy();const d=new _t,g=_.subtract(this._secondPoint,this._pointOnLine),y=g.length(),m=_.subtract(this._firstPoint,this._pointOnLine);if(m.normalize(),this._intermediatePoint.set(this._pointOnLine.x+m.x*y,this._pointOnLine.y+m.y*y,this._pointOnLine.z+m.z*y),this._angle=js(g,m),this._angle===0)return!1;this._measurementValue=this._angle,this._textShape.setTextString(`${this._measurementValue.toFixed(2)}°`),this._viewer.trigger("measurementValueSet",this),this._textPos=this._pointOnLine.copy();let I=!1,b=new _(0,0,0);const x=new _(0,0,0);ja(l,1,d),d.transform(g,x),b.set(x.x+this._pointOnLine.x,x.y+this._pointOnLine.y,x.z+this._pointOnLine.z),b=_.subtract(b,this._firstPoint);const C=b.length();return ja(l,-1,d),d.transform(g,x),b.set(x.x+this._pointOnLine.x,x.y+this._pointOnLine.y,x.z+this._pointOnLine.z),_.subtract(b,this._firstPoint),b.length()<C&&(I=!0),this._arcArray=Jh(l,I?-this._angle:this._angle,this._pointOnLine,g,D_),this._stage++,!0}adjust(t){if(super.adjust(t),this._stage<=1)return;const e=this._viewer.view.raycastFromPoint(t);if(e===null)return;const i=new _(e.origin.x+e.direction.x*1e6,e.origin.y+e.direction.y*1e6,e.origin.z+e.direction.z*1e6),n=new _(0,0,0);Qr(e.origin,i,this._pointOnLine,this._firstPoint,this._secondPoint,n),this._textPos=n.copy();let r=new _(0,0,0);r=_.subtract(n,this._pointOnLine);const o=r.length();r=_.subtract(this._secondPoint,this._pointOnLine),r.normalize(),this._secondPoint.set(this._pointOnLine.x+r.x*o,this._pointOnLine.y+r.y*o,this._pointOnLine.z+r.z*o);const l=_.subtract(this.planeIntersectionLine[1],this.planeIntersectionLine[0]);l.normalize();const h=new _t,u=_.subtract(this._secondPoint,this._pointOnLine),d=u.length(),g=_.subtract(this._firstPoint,this._pointOnLine);g.normalize(),this._intermediatePoint.set(this._pointOnLine.x+g.x*d,this._pointOnLine.y+g.y*d,this._pointOnLine.z+g.z*d);let y=!1,m=new _(0,0,0);const I=new _(0,0,0);ja(l,1,h),h.transform(u,I),m.set(I.x+this._pointOnLine.x,I.y+this._pointOnLine.y,I.z+this._pointOnLine.z),m=_.subtract(m,this._firstPoint);const b=m.length();ja(l,-1,h),h.transform(u,I),m.set(I.x+this._pointOnLine.x,I.y+this._pointOnLine.y,I.z+this._pointOnLine.z),m=_.subtract(m,this._firstPoint),m.length()<b&&(y=!0),this._arcArray=Jh(l,y?-this._angle:this._angle,this._pointOnLine,u,D_);let C;const P=this._viewer.view.projectPoint(this._textPos);for(const k of this._arcArray){const O=this._viewer.view.projectPoint(k),j=new _(P.x-O.x,P.y-O.y,P.z-O.z).length();(C===void 0||C>j)&&(C=j)}if(C===void 0||C<=20)this._textAnchorPoint=this._textPos;else{const k=this._viewer.view.projectPoint(this._intermediatePoint),O=this._viewer.view.projectPoint(this._secondPoint),B=new _(k.x-P.x,k.y-P.y,k.z-P.z),j=new _(O.x-P.x,O.y-P.y,O.z-P.z),V=B.length(),Y=j.length();V<Y?this._textAnchorPoint=this._intermediatePoint:this._textAnchorPoint=this._secondPoint}}_nextStage(){this._stage++,this._stage>2&&(this._finalized=!0,this.cleanup())}cleanup(){const t=e=>{const i=this._faceSelection[e];this._viewer.model.unsetNodeFaceColor(i.getNodeId(),i.getFaceEntity().getCadFaceIndex())};this._stage>=2&&t(1),this._stage>=1&&t(0)}update(){super.update();const t=this._viewer.view;if(this._stage>1){this._lineGeometryShape.clearPoints();for(const n of this._arcArray)this._lineGeometryShape.pushPoint(K.fromPoint3(t.projectPoint(n)));this._lineGeometryShape.setEndcapType(gn.Arrowhead),this._lineGeometryShape.setStartEndcapType(gn.Arrowhead),this._lineGeometryShape.setEndEndcapSize(5),this._lineGeometryShape.setStartEndcapSize(5);const e=new Array(10);e[0]=t.projectPoint(this._textPos),e[1]=t.projectPoint(this._firstPoint),e[2]=t.projectPoint(this._clickpointOriginal1),e[3]=t.projectPoint(this._secondPoint),e[4]=t.projectPoint(this._clickpointOriginal2),e[5]=t.projectPoint(this._intermediatePoint),e[6]=t.projectPoint(this._textAnchorPoint),this._behindView=!1;const i=new Array(10);for(let n=0;n<=6;n++)e[n].z<=0&&(this._behindView=!0),i[n]=K.fromPoint3(e[n]);this._textShape&&this._textShape.setPosition(i[0]),this._lineShapes[0].set(i[1],i[2]),this._lineShapes[1].set(i[1],i[5]),this._lineShapes[2].set(i[3],i[4]),this._lineShapes[3].set(i[6],i[0])}}draw(){const t=this._viewer.explodeManager.getMagnitude()!==0;if(!(!this._visibility||t)&&(this.update(),!this._behindView&&this._stage>=2&&this._stage<=4)){const e=this._viewer.markupManager.getRenderer();for(let i=0;i<4;i++)e.drawLine(this._lineShapes[i]);e.drawTextBox(this._textShape),e.drawPolyline(this._lineGeometryShape)}}setUseAuthoredNormals(t){this._useAuthoredNormals=t}getUseAuthoredNormals(){return this._useAuthoredNormals}toJson(){return this._toJson()}_toJson(){const t=[];for(const e of this._arcArray){const i=e.toJson();t.push(i)}return{text:this._textShape.getTextString(),textPos:this._textPos.toJson(),arcArray:t,firstPoint:this._firstPoint.toJson(),clickpointOriginal1:this._clickpointOriginal1.toJson(),secondPoint:this._secondPoint.toJson(),clickpointOriginal2:this._clickpointOriginal2.toJson(),intermediatePoint:this._intermediatePoint.toJson(),textAnchorPoint:this._textAnchorPoint.toJson(),measurementValue:this._measurementValue,className:this.getClassName()}}static fromJson(t,e){const i=t,n=new bh(e);for(const r of i.arcArray){const o=_.fromJson(r);n._arcArray.push(o)}return n._textShape.setTextString(i.text),n._textPos.assign(_.fromJson(i.textPos)),n._firstPoint.assign(_.fromJson(i.firstPoint)),n._clickpointOriginal1=_.fromJson(i.clickpointOriginal1),n._secondPoint.assign(_.fromJson(i.secondPoint)),n._clickpointOriginal2=_.fromJson(i.clickpointOriginal2),n._intermediatePoint.assign(_.fromJson(i.intermediatePoint)),n._textAnchorPoint.assign(_.fromJson(i.textAnchorPoint)),n._measurementValue=i.measurementValue,n._stage=3,n}getClassName(){return bh.className}};bh.className="Communicator.Markup.Measure.MeasureFaceFaceAngleMarkup";let Sl=bh;ss(Sl.className,Sl.fromJson);async function lg(s,t){if(t.getSelectionType()!==Pn.None){const e=t.getNodeId(),i=t.getFaceEntity();return await s.isFaceMeasurable(e,i.getCadFaceIndex())?(i.getCadFaceBits()&em.SelectionBitsFacePlanar)!==0:!1}return!1}class O_ extends Mi{constructor(t,e,i){super(t,e),this._moveSelectionAction=new no(!0),this._currentHighlight=null,this._markup=null,this._useAuthoredNormals=!0,this._measureManager=i}_unsetCurrentHighlight(){this._currentHighlight!==null&&(this._viewer.model.unsetNodeFaceColor(this._currentHighlight.getNodeId(),this._currentHighlight.getFaceEntity().getCadFaceIndex()),this._currentHighlight=null)}async _performMoveSelection(t){const e=this._view,i=this._viewer.model,n=await e.pickFromPoint(t,new yi);if(n.overlayIndex()!==0||!n.isFaceSelection())return;const r=n.getNodeId(),o=n.getFaceEntity();if(i.getNodeType(n.getNodeId())===Ne.BodyInstance){if(this._markup){const l=this._markup.getFirstSelection();if(r===l.getNodeId()){const h=l.getFaceEntity().getCadFaceIndex(),u=o.getCadFaceIndex();if(h===u)return}}this._currentHighlight!==null?n.equals(this._currentHighlight)?n.getSelectionType()===Pn.None&&this._unsetCurrentHighlight():(this._unsetCurrentHighlight(),await lg(i,n)&&(this._currentHighlight=n,i.setNodeFaceColor(r,o.getCadFaceIndex(),vt.yellow()))):this._currentHighlight===null&&await lg(i,n)&&(this._currentHighlight=n,i.setNodeFaceColor(r,o.getCadFaceIndex(),vt.yellow()))}}async _performUpSelection(t){const e=this._view,i=this._viewer.model,n=await e.pickFromPoint(t,new yi);if(n.overlayIndex())return;if(this._markup&&this._markup._getStage()>1){if(this._viewer.trigger("measurementBegin"),this._markup._nextStage(),this._markup._isFinalized()){const l=this._markup;this._markup=null,this._measureManager.finalizeMeasurement(l)}return}if(!n.isFaceSelection()||!(i.getNodeType(n.getNodeId())===Ne.BodyInstance&&(!this._markup||this._markup._getStage()<=1))||!await lg(i,n))return;const r=n.getFaceEntity();await i.getFaceProperty(n.getNodeId(),r.getCadFaceIndex())instanceof Wi&&(this._unsetCurrentHighlight(),this._markup===null?(this._markup=new Sl(this._viewer),this._markup.setUseAuthoredNormals(this._useAuthoredNormals),await this._markup.setFirstFace(n),this._measureManager.addMeasurement(this._markup)):await this._markup.setSecondFace(n)&&this._markup.adjust(t))}onMouseMove(t){super.onMouseMove(t);const e=t.getPosition();(!this._markup||this._markup._getStage()<=1)&&this._performMoveSelection(e),this._viewer.markupManager.refreshMarkup(this._viewer.view),this._markup!==null&&this._markup._getStage()>0&&this._markup.adjust(e)}_onMouseUpImpl(t){if(!this.isActive())return;const e=this._primaryTouchId!==null&&this._markup!==null&&this._markup._getStage()>1;if(!(this._dragCount<3||e))return;const i=t.getPosition();this._moveSelectionAction.set(()=>this._performUpSelection(i))}onMouseUp(t){this._onMouseUpImpl(t),super.onMouseUp(t)}setDraggingEnabled(t){this._dragging=t}onKeyUp(t){}onKeyDown(t){t.getKeyCode()===Je.Escape&&(this._markup!==null?(this._markup.cleanup(),this._measureManager.removeMeasurement(this._markup),this._markup=null):this._measureManager.removeLastMeasurement())}setHandled(){return this._markup!==null&&this._markup._getStage()>1}onDeactivate(){this._unsetCurrentHighlight(),this._markup!==null&&(this._measureManager.removeMeasurement(this._markup),this._markup.cleanup(),this._markup=null)}setUseAuthoredNormals(t){this._useAuthoredNormals=t}getUseAuthoredNormals(){return this._useAuthoredNormals}}const Ta=class Ta extends Dn{constructor(t){super(t),this._faceSelection=[],this._line1PreviewShape1=new ts,this._line1PreviewShape2=new ts,this._line2PreviewShape1=new ts,this._line2PreviewShape2=new ts,this._matrix1=new _t,this._matrix2=new _t,this._lineGeometryShape=new ya,this._parallelFaces=!1,this._triangulatedDistance=!0,this._pointsOnSameRay=!1,this._arrowsInvert=!1,this._faceData=[],this._distance=0,this._surfaceCenter=[_.zero(),_.zero()],this._surfaceAxis1=[_.zero(),_.zero()],this._surfaceAxis2=[_.zero(),_.zero()],this._cylinderAxisInfinite1=[_.zero(),_.zero()],this._cylinderAxisInfinite2=[_.zero(),_.zero()],this._secondPointInitial=_.zero(),this._firstPointHelper=_.zero(),this._secondPointHelper=_.zero(),this._secondPoint=_.zero(),this._firstPoint=_.zero(),this._textPos=_.zero(),this._name="MeasureFaceFaceDistance",this._lineGeometryShape.setStrokeWidth(2),this._lineGeometryShape.setStrokeColor(this._viewer.measureManager.getMeasurementColor()),this._textShape=new yl,this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(new vt(255,255,255));const i=this._viewer.measureManager.getMeasurementColor();for(let n=0;n<5;n++)this._lineShapes.push(new ts),this._lineShapes[n].setStrokeColor(i),this._lineShapes[n].setEndEndcapColor(i),this._lineShapes[n].setStartEndcapColor(i)}setUnitMultiplier(t){this._unitMultiplier=t}setFirstFace(t,e,i,n){const r=t.getNodeId(),o=t.getFaceEntity(),l=t.getPosition();if(this._matrix1=i.copy(),this._viewer.model.setNodeFaceColor(r,o.getCadFaceIndex(),new vt(255,0,0)),this._faceSelection[0]=t,this._firstPoint=l.copy(),this._faceData[0]=e,this._faceData[0]instanceof Wi){const h=this._faceData[0],u=new _(h.origin.x+h.normal.x,h.origin.y+h.normal.y,h.origin.z+h.normal.z);this._matrix1.transform(u,this._surfaceAxis1[0]),this._matrix1.transform(h.origin,this._surfaceCenter[0])}else this._faceData[0]instanceof Ni&&this.createCylinderData(this._faceData[0],i,n);this._stage++}getFirstSelection(){return this._faceSelection[0]||null}getFirstFaceData(){return this._faceData[0]||null}cleanup(){const t=this._viewer.model;this._stage>=2&&t.unsetNodeFaceColor(this._faceSelection[1].getNodeId(),this._faceSelection[1].getFaceEntity().getCadFaceIndex()),this._stage>=1&&t.unsetNodeFaceColor(this._faceSelection[0].getNodeId(),this._faceSelection[0].getFaceEntity().getCadFaceIndex())}createCylinderData(t,e,i){const r=_.subtract(i.max,i.min).length()/4,o=new _(t.origin.x+t.normal.x*1e4,t.origin.y+t.normal.y*1e4,t.origin.z+t.normal.z*1e4),l=new _(t.origin.x-t.normal.x*1e4,t.origin.y-t.normal.y*1e4,t.origin.z-t.normal.z*1e4),h=new _(0,0,0);kr(t.origin,o,l,h),this._surfaceCenter[this._stage]=new _(0,0,0),e.transform(h,this._surfaceCenter[this._stage]);const u=new _(h.x+t.normal.x,h.y+t.normal.y,h.z+t.normal.z);this._surfaceAxis1[this._stage]=new _(0,0,0),e.transform(u,this._surfaceAxis1[this._stage]),u.set(h.x-t.normal.x,h.y-t.normal.y,h.z-t.normal.z),this._surfaceAxis2[this._stage]=new _(0,0,0),e.transform(u,this._surfaceAxis2[this._stage]);let d=new _(0,0,0);d=this._surfaceAxis1[this._stage].copy(),d=_.subtract(d,this._surfaceCenter[this._stage]),d.normalize(),this._surfaceAxis1[this._stage].set(this._surfaceCenter[this._stage].x+d.x*r,this._surfaceCenter[this._stage].y+d.y*r,this._surfaceCenter[this._stage].z+d.z*r),this._surfaceAxis2[this._stage].set(this._surfaceCenter[this._stage].x-d.x*r,this._surfaceCenter[this._stage].y-d.y*r,this._surfaceCenter[this._stage].z-d.z*r),this._cylinderAxisInfinite1[this._stage]=new _(this._surfaceCenter[this._stage].x+d.x*r*1e3,this._surfaceCenter[this._stage].y+d.y*r*1e3,this._surfaceCenter[this._stage].z+d.z*r*1e3),this._cylinderAxisInfinite2[this._stage]=new _(this._surfaceCenter[this._stage].x-d.x*r*1e3,this._surfaceCenter[this._stage].y-d.y*r*1e3,this._surfaceCenter[this._stage].z-d.z*r*1e3)}async setSecondFace(t,e,i,n,r){const o=this._faceSelection[0],l=this._faceData[0];if(o===void 0||l===void 0)throw new ae("setSecondFace() called before setFirstFace()");if(i instanceof Wi){const u=l,d=new _(u.origin.x+u.normal.x,u.origin.y+u.normal.y,u.origin.z+u.normal.z);this._matrix1.transform(d,this._surfaceAxis1[0]),this._matrix1.transform(u.origin,this._surfaceCenter[0])}else if(i instanceof Ni)this.createCylinderData(i,n,r);else return;const h=await this._viewer.model.computeMinimumFaceFaceDistance(o.getNodeId(),o.getFaceEntity().getCadFaceIndex(),e.getNodeId(),e.getFaceEntity().getCadFaceIndex());if(h.distance!==0){if(this._matrix2=n.copy(),this._secondPoint=e.getPosition().copy(),this._secondPointInitial=new _(this._firstPoint.x,this._firstPoint.y,this._firstPoint.z),l instanceof Wi&&i instanceof Wi){const u=i,d=new _(u.origin.x+u.normal.x,u.origin.y+u.normal.y,u.origin.z+u.normal.z);this._matrix2.transform(d,this._surfaceAxis1[1]),this._matrix2.transform(u.origin,this._surfaceCenter[1]);const g=new _(this._surfaceAxis1[0].x-this._surfaceCenter[0].x,this._surfaceAxis1[0].y-this._surfaceCenter[0].y,this._surfaceAxis1[0].z-this._surfaceCenter[0].z),y=new _(this._surfaceAxis1[1].x-this._surfaceCenter[1].x,this._surfaceAxis1[1].y-this._surfaceCenter[1].y,this._surfaceAxis1[1].z-this._surfaceCenter[1].z);g.normalize(),y.normalize();const m=new _(-g.x,-g.y,-g.z);if(g.equalsWithTolerance(y,1e-5)||m.equalsWithTolerance(y,1e-5)){this._secondPointHelper=new _(this._secondPoint.x,this._secondPoint.y,this._secondPoint.z),this._firstPointHelper=new _(this._firstPoint.x,this._firstPoint.y,this._firstPoint.z);const I=new Ki;I.setFromPointAndNormal(this._surfaceCenter[0],g);const b=new Ki;b.setFromPointAndNormal(this._surfaceCenter[1],y);const x=new _(this._firstPoint.x+g.x,this._firstPoint.y+g.y,this._firstPoint.z+g.z);if(Zd(o.getPosition(),x,b,this._secondPoint),m.equalsWithTolerance(y,1e-5)){const V=new _(-g.x,-g.y,-g.z);I.setFromPointAndNormal(this._surfaceCenter[0],V)}const C=Math.abs(b.d-I.d)/I.normal.length();this._distance=C,this._setMeasurementValue(this._distance),this._parallelFaces=!0,this._triangulatedDistance=!1;const P=new _(0,1,0),k=_.subtract(this._secondPoint,this._firstPoint);let O=new _(0,0,0);O=_.subtract(this._secondPointHelper,this._firstPoint);const B=js(P,k),j=js(P,O);this._textPos.assign(this._secondPoint),B-j<.1&&B-j>-.1&&(this._pointsOnSameRay=!0)}else this._firstPoint.assign(h.pos1),this._secondPoint.assign(h.pos2),this._textPos.assign(h.pos2),this._distance=h.distance,this._setMeasurementValue(this._distance)}else if(l instanceof Ni&&i instanceof Ni){const u=new _(this._surfaceAxis1[0].x-this._surfaceCenter[0].x,this._surfaceAxis1[0].y-this._surfaceCenter[0].y,this._surfaceAxis1[0].z-this._surfaceCenter[0].z),d=new _(this._surfaceAxis1[1].x-this._surfaceCenter[1].x,this._surfaceAxis1[1].y-this._surfaceCenter[1].y,this._surfaceAxis1[1].z-this._surfaceCenter[1].z);u.normalize(),d.normalize();const g=new _(-u.x,-u.y,-u.z);if(u.equalsWithTolerance(d,1e-5)||g.equalsWithTolerance(d,1e-5)){const y=new _(0,0,0);kr(this._firstPoint,this._cylinderAxisInfinite1[0],this._cylinderAxisInfinite2[0],y),this._firstPoint=y.copy();let m=new _(this._firstPoint.x,this._firstPoint.y,this._firstPoint.z);m=_.subtract(m,this._surfaceCenter[0]),m.set(0,0,0),kr(this._firstPoint,this._cylinderAxisInfinite1[1],this._cylinderAxisInfinite2[1],y),this._secondPoint=y.copy();const I=_.subtract(this._secondPoint,this._firstPoint).length();if(I<1e-7)return;this._triangulatedDistance=!1,this._textPos.assign(this._secondPoint),this._setMeasurementValue(I)}else{if(this._distance=mp(this._cylinderAxisInfinite1[0],this._cylinderAxisInfinite2[0],this._cylinderAxisInfinite1[1],this._cylinderAxisInfinite2[1],this._firstPoint,this._secondPoint),this._distance<1e-7)return;this._textPos.assign(this._firstPoint),this._setMeasurementValue(this._distance)}}else if(l instanceof Ni&&i instanceof Wi){const u=new _(this._surfaceAxis1[0].x-this._surfaceCenter[0].x,this._surfaceAxis1[0].y-this._surfaceCenter[0].y,this._surfaceAxis1[0].z-this._surfaceCenter[0].z).normalize(),d=await this._viewer.model.computeMinimumFaceLineDistance(e.getNodeId(),e.getFaceEntity().getCadFaceIndex(),new Ws(this._surfaceCenter[0],u));if(this._distance=d.distance,this._distance<1e-7)return;this._firstPoint.assign(d.pos1),this._secondPoint.assign(d.pos2),this._textPos.assign(d.pos2),this._secondPointHelper=new _(this._secondPoint.x,this._secondPoint.y,this._secondPoint.z),this._firstPointHelper=new _(this._firstPoint.x,this._firstPoint.y,this._firstPoint.z),this._viewer.model.setNodeFaceColor(e.getNodeId(),e.getFaceEntity().getCadFaceIndex(),new vt(255,0,0)),this._faceData[1]=i,this._faceSelection[1]=e,this._stage++,this.adjust(t),this._setMeasurementValue(this._distance)}else if(l instanceof Wi&&i instanceof Ni){const u=new _(this._surfaceAxis1[1].x-this._surfaceCenter[1].x,this._surfaceAxis1[1].y-this._surfaceCenter[1].y,this._surfaceAxis1[1].z-this._surfaceCenter[1].z).normalize(),d=await this._viewer.model.computeMinimumFaceLineDistance(o.getNodeId(),o.getFaceEntity().getCadFaceIndex(),new Ws(this._surfaceCenter[1],u));if(this._distance=d.distance,this._distance<1e-7)return;this._firstPoint.assign(d.pos1),this._secondPoint.assign(d.pos2),this._textPos.assign(d.pos2),this._secondPointHelper=new _(this._secondPoint.x,this._secondPoint.y,this._secondPoint.z),this._firstPointHelper=new _(this._firstPoint.x,this._firstPoint.y,this._firstPoint.z),this._viewer.model.setNodeFaceColor(e.getNodeId(),e.getFaceEntity().getCadFaceIndex(),new vt(255,0,0)),this._faceData[1]=i,this._faceSelection[1]=e,this._stage++,this.adjust(t),this._setMeasurementValue(this._distance)}else{if(this._firstPoint.assign(h.pos1),this._secondPoint.assign(h.pos2),this._textPos.assign(h.pos2),this._distance=h.distance,this._distance<1e-7)return;this._setMeasurementValue(this._distance)}this._viewer.model.setNodeFaceColor(e.getNodeId(),e.getFaceEntity().getCadFaceIndex(),new vt(255,0,0)),this._faceData[1]=i,this._faceSelection[1]=e,this._stage++,this.adjust(t)}}adjust(t){if(super.adjust(t),this._stage<=1)return;const e=this._viewer.view.raycastFromPoint(t);if(e===null)return;const i=new _(e.origin.x+e.direction.x*1e6,e.origin.y+e.direction.y*1e6,e.origin.z+e.direction.z*1e6),n=Yd(e.direction);let r=new _(0,0,0);r=_.cross(e.direction,n),r.normalize();let o=new _((this._firstPoint.x+this._secondPoint.x)/2,(this._firstPoint.y+this._secondPoint.y)/2,(this._firstPoint.z+this._secondPoint.z)/2);o=this._textPos.copy(),n.set(o.x+n.x,o.y+n.y,o.z+n.z),r.set(o.x+r.x,o.y+r.y,o.z+r.z);const l=new _(0,0,0);if(Qr(e.origin,i,o,n,r,l),this._stage===2)kr(l,this._firstPoint,this._secondPoint,this._textPos);else if(this._parallelFaces||this._triangulatedDistance){const h=new _(0,0,0),u=this._faceData[0]instanceof Ni||this._faceData[1]instanceof Ni,d=this._faceData[0]instanceof Wi||this._faceData[1]instanceof Wi;if(!this._pointsOnSameRay){u&&d?kr(l,this._secondPoint,this._secondPointInitial,h):kr(l,this._secondPoint,this._secondPointHelper,h);let g=new _(0,0,0);g=_.subtract(h,this._secondPoint),this._secondPoint=h.copy(),this._firstPoint.set(this._firstPoint.x+g.x,this._firstPoint.y+g.y,this._firstPoint.z+g.z),this._textPos.set(this._textPos.x+g.x,this._textPos.y+g.y,this._textPos.z+g.z)}}else{const h=new _(0,0,0);kr(l,this._cylinderAxisInfinite1[1],this._cylinderAxisInfinite2[1],h);const u=_.subtract(h,this._secondPoint);this._secondPoint=h.copy(),this._firstPoint.set(this._firstPoint.x+u.x,this._firstPoint.y+u.y,this._firstPoint.z+u.z),this._textPos.set(this._textPos.x+u.x,this._textPos.y+u.y,this._textPos.z+u.z)}this._updateArrowsInverted(),this._viewer.markupManager.refreshMarkup(this._viewer.view)}_updateArrowsInverted(){const t=new _((this._firstPoint.x+this._secondPoint.x)/2,(this._firstPoint.y+this._secondPoint.y)/2,(this._firstPoint.z+this._secondPoint.z)/2),e=_.subtract(this._secondPoint,this._firstPoint);_.subtract(this._textPos,t).length()*2>e.length()?this._arrowsInvert=!0:this._arrowsInvert=!1}_nextStage(){this._stage++,(this._stage>3||this._stage>2&&this._triangulatedDistance)&&(this._finalized=!0,this.cleanup())}update(){super.update();const t=this._viewer.view;if(this._behindView=!1,this._stage===0)return;const e=new Array(10),i=[];for(let n=0;n<10;n++)i.push(new _(0,0,0));this._faceData[0]instanceof Ni&&(i[0]=t.projectPoint(this._surfaceCenter[0]),i[1]=t.projectPoint(this._surfaceAxis1[0]),i[2]=t.projectPoint(this._surfaceAxis2[0]),e[0]=K.fromPoint3(i[0]),e[1]=K.fromPoint3(i[1]),e[2]=K.fromPoint3(i[2]),this._line1PreviewShape1.set(e[0],e[1]),this._line1PreviewShape2.set(e[0],e[2])),this._stage>1&&this._faceData[1]instanceof Ni&&(i[0]=t.projectPoint(this._surfaceCenter[1]),i[1]=t.projectPoint(this._surfaceAxis1[1]),i[2]=t.projectPoint(this._surfaceAxis2[1]),e[0]=K.fromPoint3(i[0]),e[1]=K.fromPoint3(i[1]),e[2]=K.fromPoint3(i[2]),this._line2PreviewShape1.set(e[0],e[1]),this._line2PreviewShape2.set(e[0],e[2])),this._stage>1&&(i[0]=t.projectPoint(this._textPos),i[1]=t.projectPoint(this._firstPoint),i[2]=t.projectPoint(this._secondPoint),e[0]=K.fromPoint3(i[0]),e[1]=K.fromPoint3(i[1]),e[2]=K.fromPoint3(i[2]),this._textShape&&this._textShape.setPosition(e[0]),this._lineShapes[0].setEndcapType(gn.Arrowhead),this._lineShapes[0].setStartEndcapType(gn.Arrowhead),this._lineShapes[0].setEndcapsInverted(this._arrowsInvert),this._lineShapes[0].set(e[1],e[2]),i[3]=t.projectPoint(this._firstPointHelper),i[4]=t.projectPoint(this._secondPointHelper),e[3]=K.fromPoint3(i[3]),e[4]=K.fromPoint3(i[4]),this._lineShapes[1].set(e[2],e[4]),this._lineShapes[2].set(e[1],e[3]),this._lineShapes[3].set(e[1],e[0]));for(let n=0;n<6;n++)i[n].z<0&&(this._behindView=!0)}draw(){if(this._visibility&&this._viewer.explodeManager.getMagnitude()===0&&(this.update(),!this._behindView)){const t=this._faceData[0]instanceof Ni||this._faceData[1]instanceof Ni,e=this._faceData[0]instanceof Wi||this._faceData[1]instanceof Wi,i=this._viewer.markupManager.getRenderer();switch(this._stage){case 1:this._faceData[0]instanceof Ni&&(i.drawLine(this._line1PreviewShape1),i.drawLine(this._line1PreviewShape2));break;case 2:case 3:case 4:this._faceData[0]instanceof Ni&&(i.drawLine(this._line1PreviewShape1),i.drawLine(this._line1PreviewShape2)),this._faceData[1]instanceof Ni&&(i.drawLine(this._line2PreviewShape1),i.drawLine(this._line2PreviewShape2)),t&&e?(i.drawLine(this._lineShapes[0]),i.drawLine(this._lineShapes[1]),i.drawLine(this._lineShapes[2]),i.drawLine(this._lineShapes[3]),i.drawTextBox(this._textShape)):(i.drawLine(this._lineShapes[0]),this._parallelFaces&&(i.drawLine(this._lineShapes[1]),i.drawLine(this._lineShapes[2])),i.drawLine(this._lineShapes[3]),i.drawTextBox(this._textShape));break}}}static _serializeFaceProp(t){return t instanceof Ni?{type:"CylinderElement",origin:t.origin.toJson(),normal:t.normal.toJson(),radius:t.radius}:t instanceof Wi?{type:"PlaneElement",origin:t.origin.toJson(),normal:t.normal.toJson()}:null}static _constructFaceProp(t){if(t.type==="CylinderElement"){const e=_.fromJson(t.origin),i=_.fromJson(t.normal),n=t.radius;return new Ni(n,e,i)}else if(t.type==="PlaneElement"){const e=_.fromJson(t.origin),i=_.fromJson(t.normal);return new Wi(e,i)}else return null}toJson(){return this._toJson()}_toJson(){const t=[];for(const r of this._faceData)t.push(Ta._serializeFaceProp(r));const e=[];for(const r of this._surfaceCenter)e.push(r.toJson());const i=[];for(const r of this._surfaceAxis1)i.push(r.toJson());const n=[];for(const r of this._surfaceAxis2)n.push(r.toJson());return{text:this._textShape.getTextString(),textPos:this._textPos.toJson(),firstPoint:this._firstPoint.toJson(),secondPoint:this._secondPoint.toJson(),firstPointHelper:this._firstPointHelper.toJson(),secondPointHelper:this._secondPointHelper.toJson(),secondPointInitial:this._secondPointInitial.toJson(),measurementValue:this._measurementValue,unitMultiplier:this._unitMultiplier,parallelFaces:this._parallelFaces,faceData:t,surfaceCenter:e,surfaceAxis1:i,surfaceAxis2:n,name:this.getName(),className:this.getClassName()}}static fromJson(t,e){const i=t,n=new Ta(e);n.setName(i.name),n._textShape.setTextString(i.text),n._textPos.assign(_.fromJson(i.textPos)),n._firstPoint.assign(_.fromJson(i.firstPoint)),n._firstPointHelper.assign(_.fromJson(i.firstPointHelper)),n._secondPoint.assign(_.fromJson(i.secondPoint)),n._secondPointHelper.assign(_.fromJson(i.secondPointHelper)),i.secondPointInitial!==void 0&&n._secondPointInitial.assign(_.fromJson(i.secondPointInitial)),console.assert(Array.isArray(i.faceData));for(const r of i.faceData){const o=Ta._constructFaceProp(r);console.assert(o!==null),n._faceData.push(o)}return n._surfaceCenter[0].assign(i.surfaceCenter[0]),n._surfaceCenter[1].assign(i.surfaceCenter[1]),n._surfaceAxis1[0].assign(i.surfaceAxis1[0]),n._surfaceAxis1[1].assign(i.surfaceAxis1[1]),n._surfaceAxis2[0].assign(i.surfaceAxis2[0]),n._surfaceAxis2[1].assign(i.surfaceAxis2[1]),n._stage=4,n._parallelFaces=i.parallelFaces,n._measurementValue=i.measurementValue,n._unitMultiplier=i.unitMultiplier||1,n}getClassName(){return Ta.className}};Ta.className="Communicator.Markup.Measure.MeasureFaceFaceDistanceMarkup";let Pl=Ta;ss(Pl.className,Pl.fromJson);class R_ extends Mi{constructor(t,e,i){super(t,e),this._moveSelectionAction=new no(!0),this._currentHighlight=null,this._markup=null,this._measureManager=i}_unsetCurrentHighlight(){this._currentHighlight!==null&&(this._viewer.model.unsetNodeFaceColor(this._currentHighlight.getNodeId(),this._currentHighlight.getFaceEntity().getCadFaceIndex()),this._currentHighlight=null)}async _performMoveSelection(t){const e=this._view,i=this._viewer.model,n=await e.pickFromPoint(t,new yi);if(n.overlayIndex()!==0||!n.isFaceSelection())return;const r=n.getNodeId(),o=n.getFaceEntity();if(i.getNodeType(r)===Ne.BodyInstance){if(this._markup){const l=this._markup.getFirstSelection();if(l!==null&&r===l.getNodeId()&&o.getCadFaceIndex()===l.getFaceEntity().getCadFaceIndex())return}this._currentHighlight!==null?n.equals(this._currentHighlight)?n.getSelectionType()===Pn.None&&this._unsetCurrentHighlight():(this._unsetCurrentHighlight(),await i.isFaceMeasurable(r,o.getCadFaceIndex())&&(this._currentHighlight=n,i.setNodeFaceColor(r,o.getCadFaceIndex(),vt.yellow()))):await i.isFaceMeasurable(r,o.getCadFaceIndex())&&(this._currentHighlight=n,i.setNodeFaceColor(r,o.getCadFaceIndex(),vt.yellow()))}}async _performUpSelection(t){const e=this._view,i=this._viewer.model,n=await e.pickFromPoint(t,new yi);if(n.overlayIndex())return;if(this._markup&&this._markup._getStage()>1){if(this._viewer.trigger("measurementBegin"),this._markup._nextStage(),this._markup._isFinalized()){const d=this._markup;this._markup=null,this._measureManager.finalizeMeasurement(d)}return}if(!n.isFaceSelection())return;const r=n.getNodeId(),o=n.getFaceEntity();if(!await i.isFaceMeasurable(r,o.getCadFaceIndex())||!(i.getNodeType(r)===Ne.BodyInstance&&(!this._markup||this._markup._getStage()<=1)))return;const h=await i.getFaceProperty(r,o.getCadFaceIndex());if(!h)return;const u=i.getNodeNetMatrix(r);if(this._unsetCurrentHighlight(),h instanceof Wi||h instanceof Ni){const d=await i.getNodesBounding([r]);this._markup?await this._markup.setSecondFace(t,n,h,u,d):(this._markup=new Pl(this._viewer),this._markup.setUnitMultiplier(i.getNodeUnitMultiplier(r)),this._markup.setFirstFace(n,h,u,d),this._measureManager.addMeasurement(this._markup))}}onMouseMove(t){super.onMouseMove(t);const e=t.getPosition();(!this._markup||this._markup._getStage()<=1)&&this._moveSelectionAction.set(()=>this._performMoveSelection(e)),this._viewer.markupManager.refreshMarkup(this._viewer.view),this._markup!==null&&this._markup._getStage()>0&&this._markup.adjust(e)}async _onMouseUpImpl(t){if(!this.isActive())return;const e=this._primaryTouchId!==null&&this._markup!==null&&this._markup._getStage()>1;if(!(this._dragCount<3||e))return;const i=t.getPosition();await this._performUpSelection(i)}onMouseUp(t){this._onMouseUpImpl(t),super.onMouseUp(t)}setDraggingEnabled(t){this._dragging=t}onKeyUp(t){}onKeyDown(t){t.getKeyCode()===Je.Escape&&(this._markup!==null?(this._markup.cleanup(),this._measureManager.removeMeasurement(this._markup),this._markup=null):this._measureManager.removeLastMeasurement())}setHandled(){return this._markup!==null&&this._markup._getStage()>1}onDeactivate(){super.onDeactivate(),this._unsetCurrentHighlight(),this._markup!==null&&(this._measureManager.removeMeasurement(this._markup),this._markup.cleanup(),this._markup=null)}}const Ih=class Ih extends Dn{constructor(t){super(t),this._anchorLinePoint=null,this._firstLinePoint=null,this._secondLinePoint=null,this._selectionPosition=null,this._lineGeometryShape=new ya,this._viewer=t,this._name="MeasureLineLineAngle",this._lineGeometryShape.setStrokeWidth(2),this._lineGeometryShape.setStrokeColor(this._viewer.measureManager.getMeasurementColor()),this._lineGeometryShape.setEndcapType(gn.Arrowhead),this._lineGeometryShape.setStartEndcapType(gn.Arrowhead),this._lineGeometryShape.setEndEndcapSize(5),this._lineGeometryShape.setStartEndcapSize(5),this._lineGeometryShape.setEndEndcapColor(this._viewer.measureManager.getMeasurementColor()),this._lineGeometryShape.setStartEndcapColor(this._viewer.measureManager.getMeasurementColor()),this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(vt.white())}addPoint(t){if(this._finalized)return!1;if(this._anchorLinePoint===null)this._anchorLinePoint=t.copy(),this._stage=1;else if(this._firstLinePoint===null){if(t.equals(this._anchorLinePoint))return!1;this._firstLinePoint=t.copy(),this._stage=2}else{if(t.equals(this._anchorLinePoint)||t.equals(this._firstLinePoint))return!1;const e=_.subtract(this._firstLinePoint,this._anchorLinePoint),i=_.subtract(t,this._anchorLinePoint),n=js(e,i);if(n===0||n===180)return!1;this._secondLinePoint=t.copy(),this.setMeasurementText(`${n.toFixed(2)}°`),this._measurementValue=n,this._finalized=!0,this._stage=3}return this.draw(),!0}setSelectionPosition(t){this._selectionPosition=t}getLineGeometryShape(){return this._lineGeometryShape}_drawPreviewLine(t,e){const i=this._viewer.markupManager.getRenderer(),n=this._viewer.view,r=K.fromPoint3(n.projectPoint(t)),o=K.fromPoint3(n.projectPoint(e)),l=new ts(r,o);i.drawLine(l)}_drawAngleMarkup(t,e,i){const n=this._viewer.markupManager.getRenderer(),r=this._viewer.view,o=_.subtract(e,t),l=_.subtract(i,t),h=_.cross(o,l).normalize(),u=js(o,l);if(u!==0&&u!==180&&!isNaN(u)){const C=Jh(h,-u,t,l,30);this._lineGeometryShape.clearPoints();for(const P of C)this._lineGeometryShape.pushPoint(K.fromPoint3(r.projectPoint(P)));n.drawPolyline(this._lineGeometryShape)}const d=l.length(),g=_.add(t,o.copy().normalize().scale(d)),y=K.fromPoint3(r.projectPoint(t)),m=K.fromPoint3(r.projectPoint(g)),I=K.fromPoint3(r.projectPoint(i)),b=new ts(y,m);n.drawLine(b);const x=new ts(y,I);n.drawLine(x),this._textShape.setPosition(m),this._finalized?this._textShape.setTextString(this.getMeasurementText()):isNaN(u)?this._textShape.setTextString("0°"):this._textShape.setTextString(`${u.toFixed(2)}°`),n.drawTextBox(this._textShape)}draw(){if(!(!this._visibility||this._anchorLinePoint===null||this._viewer.view.projectPoint(this._anchorLinePoint).z<=0)){if(this._stage===1){if(this._selectionPosition===null)return;this._drawPreviewLine(this._anchorLinePoint,this._selectionPosition)}else if(this._stage===2){if(this._firstLinePoint===null||this._selectionPosition===null)return;this._drawAngleMarkup(this._anchorLinePoint,this._firstLinePoint,this._selectionPosition)}else if(this._stage===3){if(this._firstLinePoint==null||this._secondLinePoint==null)return;this._drawAngleMarkup(this._anchorLinePoint,this._firstLinePoint,this._secondLinePoint)}}}toJson(){return this._toJson()}_toJson(){return{name:this._name,anchorPoint:this._anchorLinePoint.copy(),firstPoint:this._firstLinePoint.copy(),secondPoint:this._secondLinePoint.copy(),measurementValue:this._measurementValue,measurementText:this.getMeasurementText(),className:this.getClassName()}}static fromJson(t,e){const i=t,n=new Ih(e);return n._name=i.name,n._anchorLinePoint=_.fromJson(i.anchorPoint),n._firstLinePoint=_.fromJson(i.firstPoint),n._secondLinePoint=_.fromJson(i.secondPoint),n._measurementValue=i.measurementValue,n.setMeasurementText(i.measurementText),n._finalized=!0,n._stage=3,n}getClassName(){return Ih.className}};Ih.className="Communicator.Markup.Measure.MeasureLineLineAngleMarkup";let kl=Ih;ss(kl.className,kl.fromJson);class cg extends Dn{constructor(t,e){super(t),this._cursorSprite=new Br,this._removed=!1,this._view=e,this._name="CursorMarkup";const i=t.measureManager.getMeasurementColor();this._cursorSprite.setFillColor(i),this._cursorSprite.setStrokeColor(i),this._cursorSprite.setRadius(0),this._markupId=t.markupManager.registerMarkup(this,e)}draw(){this._viewer.markupManager.getRenderer().drawCircle(this._cursorSprite)}enable(t){this._cursorSprite.setRadius(t?2.5:0)}isEnabled(){return this._cursorSprite.getRadius()>0}setPosition(t){this._cursorSprite.setCenter(t)}destroy(){this._removed||this._viewer.markupManager.unregisterMarkup(this._markupId,this._view)}remove(t){this._removed=!0}}class L_{constructor(t,e,i){this.worldPosition=t,this.screenPosition=e,this.selectionItem=i}}class oh{constructor(t,e){this._cursorMarkup=null,this._updateCursorSpriteAction=new no(!0),this._viewer=t,this._view=e,this.snappingConfig={enabled:!0,preferVertices:!0}}async getSelectionCursorPoints(t,e,i){const n=new yi(e?xe.All:xe.Face);e&&(n.enableProximityFaces=!0,n.restrictLinesAndPointsToSelectedFaceInstances=!1);const r=await this._view.pickFromPoint(t,n);if(r.overlayIndex()!==0)return null;let o=r.getPosition(),l=t;if(this.snappingConfig.enabled){const h=r.getLineEntity(),u=r.getPointEntity(),d=r.getFaceEntity();if(h||u||d){let g=null;h!==null?g=this._getLineSnapPoint(h,e,i):u!==null?g=u.getPosition():d!==null&&d.isProximityFace()&&(g=d.getPosition()),g!==null&&(o=g,l=nd(this._view,o))}}return new L_(o,l,r)}updateCursorSprite(t,e,i){this._updateCursorSpriteAction.set(()=>this._updateCursorSpriteImpl(t,e,i))}async _updateCursorSpriteImpl(t,e,i){if(this._cursorMarkup!==null)if(e){const n=await this.getSelectionCursorPoints(t,e,i);n!==null?(this._cursorMarkup.setPosition(n.screenPosition),this.activateCursorSprite(!0)):this.activateCursorSprite(!1)}else this._cursorMarkup.setPosition(t)}draw(){this._cursorMarkup!==null&&this._cursorMarkup.draw()}activateCursorSprite(t){this._cursorMarkup!==null&&this._cursorMarkup.enable(t)}_getLineSnapPoint(t,e,i){const n=this.snappingConfig.preferVertices?t.getBestVertex():null;if(n!==null)return n;const r=t.getPosition();if(!e||i==null)return r;const o=t.getPoints(),l=1e-10,h=(()=>{for(let C=0;C<o.length-1;C++)if(yp(o[C],o[C+1],r,l))return C;return 0})(),u=o[h],d=o[h+1];if(u===void 0||d===void 0)return r;const g=_p(u,d,i),y=nd(this._view,g),m=nd(this._view,r),I=K.subtract(y,m).squaredLength(),b=this._viewer.selectionManager.getPickTolerance(),x=b*b;return I<=x?g:r}_clearCursorMarkup(){this._cursorMarkup!==null&&(this._cursorMarkup.destroy(),this._cursorMarkup=null)}onOperatorActivate(){this._clearCursorMarkup(),this._cursorMarkup=new cg(this._viewer,this._view),this._viewer.sheetManager.isDrawingSheetActive()&&this._viewer.sheetManager.setBackgroundSelectionEnabled(!0)}onOperatorDeactivate(){this._clearCursorMarkup(),this._viewer.sheetManager.isDrawingSheetActive()&&this._viewer.sheetManager.setBackgroundSelectionEnabled(!1)}}class F_ extends Mi{constructor(t,e,i){super(t,e),this._markupItem=null,this._cameraInteractionActive=!1,this._measureManager=i,this._cursor=new oh(t,e),this._viewer.setCallbacks({beginInteraction:()=>{this._onBeginInteraction()},endInteraction:()=>{this._onEndInteraction()}})}_onBeginInteraction(){this._cameraInteractionActive=!0,this._cursor.activateCursorSprite(!1)}_onEndInteraction(){this._cameraInteractionActive=!1}_useSnapping(t){return this._cursor.snappingConfig.enabled&&!t.altDown()}async _addPoint(t,e){const i=await this._cursor.getSelectionCursorPoints(t,e,null);if(!(i===null||i.worldPosition===null)&&(this._markupItem===null&&(this._markupItem=new kl(this._viewer),this._measureManager.addMeasurement(this._markupItem),this._viewer.trigger("measurementBegin")),this._markupItem.addPoint(i.worldPosition),this._markupItem._isFinalized())){const n=this._markupItem;this._markupItem=null,this._measureManager.finalizeMeasurement(n)}}async _updateMarkupSelectionPosition(t,e){if(this._markupItem===null)return;const i=await this._cursor.getSelectionCursorPoints(t,e,null);i!==null&&this._markupItem.setSelectionPosition(i.worldPosition)}async onMouseMove(t){if(super.onMouseMove(t),this._cameraInteractionActive)return;const e=t.getPosition(),i=this._useSnapping(t);this._cursor.updateCursorSprite(e,i,null),await this._updateMarkupSelectionPosition(e,i),this._viewer.markupManager.refreshMarkup(this._viewer.view)}async onMouseUp(t){if(!this.isActive())return;const e=t.getPosition();this._ptFirst.equals(e)&&await this._addPoint(e,this._useSnapping(t)),super.onMouseUp(t)}onKeyDown(t){t.getKeyCode()===Je.Escape&&this._clearMeasurement()}_clearMeasurement(){this._markupItem!==null?(this._measureManager.removeMeasurement(this._markupItem),this._markupItem=null):this._measureManager.removeLastMeasurement()}setHandled(){return this._markupItem!==null&&this._markupItem._getStage()>1}onActivate(){this._cursor.onOperatorActivate()}onDeactivate(){this._cursor.onOperatorDeactivate(),this._markupItem!==null&&(this._measureManager.removeMeasurement(this._markupItem),this._markupItem=null)}}const xh=class xh extends Dn{constructor(t){super(t),this._firstPointShape=new Br,this._secondPointShape=new Br,this._arrowsInvert=!1,this._name="MeasurePointPointDistance",this._lineShapes=[];for(let e=0;e<6;e++)this._lineShapes.push(new ts),this._lineShapes[e].setStrokeColor(this._viewer.measureManager.getMeasurementColor()),this._lineShapes[e].setEndEndcapColor(this._viewer.measureManager.getMeasurementColor()),this._lineShapes[e].setStartEndcapColor(this._viewer.measureManager.getMeasurementColor());this._viewer=t,this.initCircle(this._firstPointShape),this.initCircle(this._secondPointShape),this._textShape=new yl,this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(new vt(255,255,255))}initCircle(t){t.setRadius(2.5),t.setFillColor(this._viewer.measureManager.getMeasurementColor())}setUnitMultiplier(t){this._unitMultiplier=t}setFirstPointPosition(t){this._stage=1,this._positions[0]=t.copy()}setSecondPointPosition(t){this._stage=2,this._positions[1]=t.copy(),this._positions[2]=t.copy(),this._setMeasurementValue(_.subtract(this._positions[1],this._positions[0]).length())}_getStage(){return this._stage}finalize(){this._stage++}getFirstPointPosition(){return this._positions[0]}getSecondPointPosition(){return this._positions[1]}adjust(t){super.adjust(t);const e=this._viewer.view.raycastFromPoint(t);if(e===null)return;const i=this._positions[0],n=this._positions[1];let r=new _(1,0,0);n.equals(i)||(r=_.subtract(n,i));const l=this._viewer.view.getCamera().getUp(),h=_.cross(e.direction,l).normalize(),u=new _((i.x+n.x)/2,(i.y+n.y)/2,(i.z+n.z)/2),d=new _(u.x+l.x,u.y+l.y,u.z+l.z),g=new _(u.x+h.x,u.y+h.y,u.z+h.z),y=new _(e.origin.x+e.direction.x*1e6,e.origin.y+e.direction.y*1e6,e.origin.z+e.direction.z*1e6);let m=new _(0,0,0);Qr(e.origin,y,u,d,g,m),this._positions[2].assign(m);let I=new _(0,0,0);Math.abs(r.x)<=Math.abs(r.y)&&Math.abs(r.x)<=Math.abs(r.z)?I=new _(1,0,0):Math.abs(r.y)<=Math.abs(r.x)&&Math.abs(r.y)<=Math.abs(r.z)?I=new _(0,1,0):I=new _(0,0,1);const b=_.cross(I,r),x=_.cross(b,r);b.set(i.x+b.x,i.y+b.y,i.z+b.z),x.set(i.x+x.x,i.y+x.y,i.z+x.z);const C=new _(m.x+r.x*1e4,m.y+r.y*1e4,m.z+r.z*1e4),P=new _(m.x-r.x*1e4,m.y-r.y*1e4,m.z-r.z*1e4),k=Qr(C,P,i,b,x,m),O=!isNaN(m.x)&&!isNaN(m.y)&&!isNaN(m.z);(!k||!O)&&(m=n.copy());const B=_.subtract(m,i);this._positions[3]=new _(i.x+B.x,i.y+B.y,i.z+B.z),this._positions[4]=new _(n.x+B.x,n.y+B.y,n.z+B.z),this._updateArrowsInverted(),this._viewer.markupManager.refreshMarkup(this._viewer.view)}_updateArrowsInverted(){const t=new _((this._positions[3].x+this._positions[4].x)/2,(this._positions[3].y+this._positions[4].y)/2,(this._positions[3].z+this._positions[4].z)/2),e=_.subtract(this._positions[4],this._positions[3]);_.subtract(this._positions[2],t).length()*2>e.length()?this._arrowsInvert=!0:this._arrowsInvert=!1}update(){super.update();const t=this._viewer.view,e=new Array(6);if(this._stage>0){this._behindView=!1;for(let i=0;i<this._positions.length;i++)t.projectPoint(this._positions[i]).z<=0&&(this._behindView=!0),e[i]=K.fromPoint3(t.projectPoint(this._positions[i]));this._firstPointShape.setCenter(e[0])}this._stage>1&&(this._textShape&&this._textShape.setPosition(e[2]),this._secondPointShape.setCenter(e[1]),this._lineShapes[0].set(e[0],e[1]),this._lineShapes[1].set(e[3],e[4]),this._lineShapes[2].set(e[0],e[3]),this._lineShapes[3].set(e[1],e[4]),this._lineShapes[4].set(e[3],e[2]),this._lineShapes[5].set(e[3],e[4]),this._lineShapes[5].setEndcapType(gn.Arrowhead),this._lineShapes[5].setStartEndcapType(gn.Arrowhead),this._lineShapes[5].setEndcapsInverted(this._arrowsInvert))}draw(){if(this._visibility&&this._viewer.explodeManager.getMagnitude()===0&&(this.update(),!this._behindView)){const t=this._viewer.markupManager.getRenderer();switch(this._stage){case 1:t.drawCircle(this._firstPointShape);break;case 2:case 3:t.drawCircle(this._firstPointShape),t.drawCircle(this._secondPointShape);for(const e of this._lineShapes)t.drawLine(e);t.drawTextBox(this._textShape);break}}}toJson(){return this._toJson()}_toJson(){return{name:this._name,measurePoint1:this._positions[0].copy(),measurePoint2:this._positions[1].copy(),leaderPoint1:this._positions[3].copy(),leaderPoint2:this._positions[4].copy(),textPoint:this._positions[2].copy(),text:this._textShape.getTextString(),measurementValue:this._measurementValue,unitMultiplier:this._unitMultiplier,className:this.getClassName()}}static fromJson(t,e){const i=t,n=new xh(e);return n._name=i.name,n._positions[0]=_.fromJson(i.measurePoint1),n._positions[1]=_.fromJson(i.measurePoint2),n._positions[2]=_.fromJson(i.textPoint),n._textShape.setTextString(i.text),n._positions[3]=_.fromJson(i.leaderPoint1),n._positions[4]=_.fromJson(i.leaderPoint2),n._measurementValue=i.measurementValue,n._unitMultiplier=i.unitMultiplier||1,n._updateArrowsInverted(),n._stage=2,n}getClassName(){return xh.className}isMarkupValid(){return this._positions.length>=5}};xh.className="Communicator.Markup.Measure.MeasurePointPointDistanceMarkup";let Ml=xh;ss(Ml.className,Ml.fromJson);class B_ extends Mi{constructor(t,e,i){super(t,e),this._measureMarkup=null,this._cameraInteractionActive=!1,this._viewer=t,this._measureManager=i,this._cursor=new oh(t,e),this._viewer.setCallbacks({beginInteraction:()=>{this._onBeginInteraction()},endInteraction:()=>{this._onEndInteraction()}})}_onBeginInteraction(){this._cameraInteractionActive=!0,this._cursor.activateCursorSprite(!1)}_onEndInteraction(){this._cameraInteractionActive=!1}_getStage(){return this._measureMarkup===null?Fs.NoPointsSelected:this._measureMarkup._getStage()}_draw(){let t=!1;this._getStage()<Fs.TwoPointsSelected&&(this._cursor.draw(),t=!0),this._measureMarkup!==null&&(this._measureMarkup.draw(),t=!0),t&&this._viewer.markupManager.refreshMarkup(this._viewer.view)}async _finalizeMeasurement(t,e){const i=this._measureMarkup;if(i===null){console.assert(!1);return}const n=new yi(e?xe.All:xe.Face);(await this._view.pickFromPoint(t,n)).overlayIndex()||(i.finalize(),this._measureMarkup=null,this._measureManager.finalizeMeasurement(i))}_getFirstPickPosition(){let t=null;return this._measureMarkup!==null&&this._getStage()>=Fs.OnePointSelected&&(t=this._measureMarkup.getFirstPointPosition()),t}async _updateMeasurementPoints(t,e){const i=this._getStage();console.assert(i<Fs.TwoPointsSelected),this._viewer.trigger("measurementBegin");const n=this._getFirstPickPosition(),r=await this._cursor.getSelectionCursorPoints(t,e,n);if(r===null||r.worldPosition===null){this._cursor.activateCursorSprite(!1);return}this._cursor.activateCursorSprite(!0),this._measureMarkup===null&&(this._measureMarkup=new Ml(this._viewer),this._measureManager.addMeasurement(this._measureMarkup));const o=r.worldPosition.copy();if(this._viewer.sheetManager.isDrawingSheetActive()&&(o.z=0),i===Fs.NoPointsSelected)this._measureMarkup.setFirstPointPosition(o),this._measureMarkup.setUnitMultiplier(r.selectionItem.isNodeSelection()?this._viewer.model.getNodeUnitMultiplier(r.selectionItem.getNodeId()):1);else if(i===Fs.OnePointSelected){const l=this._getFirstPickPosition();r.worldPosition.equalsWithTolerance(l,1e-7)||(this._measureMarkup.setSecondPointPosition(o),this._measureMarkup.adjust(r.screenPosition))}}_useSnapping(t){return this._cursor.snappingConfig.enabled&&!t.altDown()}onMouseMove(t){super.onMouseMove(t);const e=this._getStage();if(e<Fs.TwoPointsSelected){if(!this._cameraInteractionActive){const i=t.getPosition(),n=this._getFirstPickPosition();this._cursor.updateCursorSprite(i,this._useSnapping(t),n)}}else e===Fs.TwoPointsSelected&&(this._measureMarkup.adjust(t.getPosition()),t.setHandled(!0));this._draw()}async onMouseUp(t){if(this.isActive()){const e=this._getStage(),i=this._primaryTouchId!==null&&this._measureMarkup!==null&&e>Fs.OnePointSelected;if(this._dragCount<3||i){const n=this._useSnapping(t),r=t.getPosition();e<=Fs.OnePointSelected?await this._updateMeasurementPoints(r,n):await this._finalizeMeasurement(r,n)}}super.onMouseUp(t)}onKeyUp(t){}_clearMeasurement(){this._measureMarkup!==null?(this._measureManager.removeMeasurement(this._measureMarkup),this._measureMarkup=null):this._measureManager.removeLastMeasurement()}onKeyDown(t){t.getKeyCode()===Je.Escape&&this._clearMeasurement()}setHandled(){return this._getStage()>Fs.OnePointSelected}onActivate(){this._cursor.onOperatorActivate()}onDeactivate(){this._cursor.onOperatorDeactivate(),this._measureMarkup!==null&&(this._measureManager.removeMeasurement(this._measureMarkup),this._measureMarkup=null)}}const Ch=class Ch extends Dn{constructor(t){super(t),this._initialPoint=new Br,this._leaderLine=new ts,this._endpoints=new Uf,this._textboxCorners=[K.zero(),K.zero(),K.zero(),K.zero()],this._polygon=new u_,this._plane=null,this.textPosition=_.zero(),this.leaderPosition=_.zero(),this.pointRadius=2.5,this._viewer=t;const e=this._viewer.measureManager.getMeasurementColor();this._initialPoint.setFillColor(e),this._initialPoint.setStrokeColor(e),this._leaderLine.setStrokeColor(e),this._endpoints.setFillColor(e),this._endpoints.setStrokeColor(e),this._endpoints.setFillOpacity(1),this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(vt.white()),this._polygon.setFillColor(e),this._polygon.setFillOpacity(.4)}_calculateArea(){const t=this._positions.length;if(t<3)return 0;const e=new Float32Array(t*3);for(let u=0;u<t;u++){const d=this._positions[u];e[3*u]=d.x,e[3*u+1]=d.y,e[3*u+2]=d.z}const i=_.subtract(this._positions[1],this._positions[0]),n=_.subtract(this._positions[2],this._positions[0]),r=_.cross(i,n),o=this._viewer.model.triangulatePolygon(e,r);let l=0;const h=o.length/3/3;for(let u=0;u<h;u++){const d=u*3*3,g=[];for(let x=0;x<3;x++){const C=o[d+x*3],P=o[d+x*3+1],k=o[d+x*3+2];g[x]=new _(C,P,k)}const y=_.subtract(g[1],g[0]).length(),m=_.subtract(g[2],g[0]).length(),I=_.subtract(g[2],g[1]).length(),b=.25*Math.sqrt((y+m+I)*(-y+m+I)*(y-m+I)*(y+m-I));l+=b}return l}addPoint(t){if(this._positions.length>=3&&(this._plane===null&&(this._plane=Ki.createFromPoints(this._positions[0],this._positions[1],this._positions[2])),Math.abs(this._plane.distanceToPoint(t))>1e-4))return!1;this._positions.length===2&&(this._plane=Ki.createFromPoints(this._positions[0],this._positions[1],t)),this._positions.push(t.copy());const e=this._calculateArea(),i=this.getUnitMultiplier(),n=`${Ua(e,i)}²`;return this._setMeasurementValue(e),this.setMeasurementText(n),!0}getPoints(){return this._positions}getLast(){return this._positions.length===0?null:this._positions[this._positions.length-1].copy()}finalize(){if(this._positions.length>2){const t=this._calculateArea(),e=this.getUnitMultiplier(),i=`${Ua(t,e)}²`;this._setMeasurementValue(t),this.setMeasurementText(i)}this._finalized=!0}setUnitMultiplier(t){this._unitMultiplier=t}isValid(){return this._positions.length>2}getMeasurementText(){return this._textShape.getTextString()}_updateProjectedPoints(){const t=[];this._behindView=!1;for(const e of this._positions){const i=this._viewer.view.projectPoint(e);i.z<=0&&(this._behindView=!0),t.push(K.fromPoint3(i))}return t}_updateTextBoxCorners(){const t=this._viewer.markupManager.getRenderer().measureTextBox(this._textShape),e=this._textShape.getPosition();this._textboxCorners[0].assign(e),this._textboxCorners[1].set(e.x+t.x,e.y),this._textboxCorners[2].set(e.x+t.x,e.y+t.y),this._textboxCorners[3].set(e.x,e.y+t.y)}_calculateLeaderEndpoint(t){this._updateTextBoxCorners();const e=K.zero();let i=Number.MAX_VALUE;for(const n of this._textboxCorners){const r=K.distance(t,n);r<i&&(e.assign(n),i=r)}return e}draw(){if(!this._visibility)return;const t=this._updateProjectedPoints();if(this._behindView||t.length===0)return;const e=this._viewer.markupManager.getRenderer();if(t.length===1)this._initialPoint.set(t[0],this.pointRadius),e.drawCircle(this._initialPoint);else{this._polygon.clearPoints();for(const o of t)this._polygon.pushPoint(o);this._finalized&&this._polygon.pushPoint(t[0]);const i=K.fromPoint3(this._viewer.view.projectPoint(this.textPosition));this._textShape.setPosition(i),e.drawPolygon(this._polygon);const n=K.fromPoint3(this._viewer.view.projectPoint(this.leaderPosition)),r=this._calculateLeaderEndpoint(n);this._leaderLine.setP1(n),this._leaderLine.setP2(r),e.drawLine(this._leaderLine),e.drawTextBox(this._textShape),this._endpoints.clear(),this._endpoints.addCircle(t[0],this.pointRadius),this._endpoints.addCircle(t[t.length-1],this.pointRadius),e.drawCircles(this._endpoints)}}toJson(){return this._toJson()}_toJson(){const t=[];for(const e of this._positions)t.push(e.toJson());return{name:this._name,points:t,textPoint:this.textPosition.toJson(),leaderPoint:this.leaderPosition.toJson(),measurementValue:this._measurementValue,unitMultiplier:this._unitMultiplier,text:this._textShape.getTextString(),className:this.getClassName()}}static fromJson(t,e){const i=t,n=new Ch(e);return n._name=i.name,n._positions=Dn._constructPointArray(i.points),n.textPosition=_.fromJson(i.textPoint),n.leaderPosition=_.fromJson(i.leaderPoint),n._measurementValue=i.measurementValue,n._unitMultiplier=i.unitMultiplier||1,n._textShape.setTextString(i.text),n._finalized=!0,n}hit(t){const e=this._viewer.markupManager.getRenderer().measureTextBox(this._textShape),i=this._textShape.getPosition();return!(t.x<i.x||t.x>i.x+e.x||t.y<i.y||t.y>i.y+e.y)}getClassName(){return Ch.className}};Ch.className="Communicator.Markup.Measure.MeasurePolygonAreaMarkup";let El=Ch;ss(El.className,El.fromJson);class V_ extends Mi{constructor(t,e,i){super(t,e),this._markupItem=null,this._cameraInteractionActive=!1,this._textShapeOffset=new K(10,-25),this._anchor=bl.Last,this._dragPlane=null,this._measureManager=i,this._cursor=new oh(t,e),this._viewer.setCallbacks({beginInteraction:()=>{this._onBeginInteraction()},endInteraction:()=>{this._onEndInteraction()}})}getMarkupItem(){return this._markupItem}setAnchor(t){this._anchor=t}_useSnapping(t){return this._cursor.snappingConfig.enabled&&!t.altDown()}_getLastSelectedPoint(){return this._markupItem?this._markupItem.getLast():null}_createNewMarkupItem(t){this._markupItem=new El(this._viewer),this._markupItem.setUnitMultiplier(t.selectionItem.isNodeSelection()?this._viewer.model.getNodeUnitMultiplier(t.selectionItem.getNodeId()):1),this._markupItem.setName("MeasurePolygonAreaMarkup"),this._measureManager.addMeasurement(this._markupItem),this._markupItem.addPoint(t.worldPosition)}_updateMarkupItem(t,e){if(this._markupItem===null||e.worldPosition==null)return;const i=this._markupItem.getPoints(),n=K.fromPoint3(this._view.projectPoint(i[0]));K.distance(n,t)<this._markupItem.pointRadius?i.length>2&&this._finalizeMeasurement():this._markupItem.addPoint(e.worldPosition)&&this._updateAnchor(t,e.worldPosition)}async _updateMeasurementItem(t,e){const i=this._getLastSelectedPoint(),n=await this._cursor.getSelectionCursorPoints(t,e,i);if(n===null||n.worldPosition===null){this._cursor.activateCursorSprite(!1);return}else this._cursor.activateCursorSprite(!0);this._markupItem===null?this._createNewMarkupItem(n):this._updateMarkupItem(t,n)}_isDraggingText(){return this._dragPlane!==null}onMouseDown(t){if(super.onMouseDown(t),this._markupItem)return;const e=t.getPosition();this._pickExisting(e)&&(this._dragPlane=this._calculateSelectionPlane(this._markupItem.leaderPosition),t.setHandled(!0))}onMouseMove(t){if(super.onMouseMove(t),this._isDraggingText())this._dragMarkupText(t),t.setHandled(!0);else if(!this._cameraInteractionActive){const e=this._getLastSelectedPoint();this._cursor.updateCursorSprite(t.getPosition(),this._useSnapping(t),e),this._draw()}}async onMouseUp(t){if(!this.isActive())return;const e=t.getPosition();if(this._isDraggingText())this._markupItem=null,this._dragPlane=null;else if(this._ptFirst.equals(e)){const i=this._useSnapping(t),n=e;await this._updateMeasurementItem(n,i)}super.onMouseUp(t)}onDoubleClick(t){this._finalizeMeasurement()}_dragMarkupText(t){if(this._markupItem===null||this._dragPlane===null)return;const e=this._view.raycastFromPoint(t.getPosition());this._dragPlane.intersectsRay(e,this._markupItem.textPosition),this._draw()}_finalizeMeasurement(){if(this._markupItem)if(this._markupItem.isValid()){const t=this._markupItem;this._markupItem=null,t.finalize(),this._measureManager.finalizeMeasurement(t)}else this._clearMeasurement()}_updateAnchor(t,e){if(!this._markupItem)return;const i=this._markupItem.getPoints();if(i.length!==1)switch(this._anchor){case bl.Last:this._calculateAnchorPos(t,e);break;case bl.First:{if(i.length!==2)return;const n=this._view.projectPoint(i[0]);this._calculateAnchorPos(K.fromPoint3(n),i[0]);break}case bl.Midpoint:{let n;const r=this._markupItem.getMeasurementValue()/2;let o=0;for(let h=1;h<i.length;h++){const u=_.subtract(i[h],i[h-1]),d=u.length(),g=o+d;if(g>r){const m=(r-o)/d;u.scale(m),n=_.add(i[h-1],u);break}o=g}const l=this._view.projectPoint(n);this._calculateAnchorPos(K.fromPoint3(l),n);break}}}_calculateSelectionPlane(t){const e=this._view.getCamera(),i=_.subtract(e.getPosition(),t);return i.normalize(),Ki.createFromPointAndNormal(t,i)}_calculateAnchorPos(t,e){const i=this._view.getCamera();_.subtract(i.getPosition(),e).normalize();const r=this._calculateSelectionPlane(e),o=this._view.raycastFromPoint(K.add(t,this._textShapeOffset));o&&(r.intersectsRay(o,this._markupItem.textPosition),this._markupItem.leaderPosition.assign(e))}_clearMeasurement(){this._markupItem!==null?(this._measureManager.removeMeasurement(this._markupItem),this._markupItem=null):this._measureManager.removeLastMeasurement()}_draw(){this._viewer.markupManager.refreshMarkup(this._viewer.view)}_pickExisting(t){const e=this._viewer.markupManager.pickMarkupItem(t,this._viewer.view);return e&&e.getClassName()==="Communicator.MeasurePolygonAreaMarkup"?(this._markupItem=e,!0):!1}onActivate(){this._cursor.onOperatorActivate()}onDeactivate(){this._cursor.onOperatorDeactivate()}onKeyDown(t){t.getKeyCode()===Je.Escape&&this._clearMeasurement()}_onBeginInteraction(){this._cameraInteractionActive=!0,this._cursor.activateCursorSprite(!1)}_onEndInteraction(){this._cameraInteractionActive=!1}}const Sh=class Sh extends Dn{constructor(t){super(t),this._polyline=new ya,this._initialPoint=new Br,this._leaderLine=new ts,this._endpoints=new Uf,this._textboxCorners=[K.zero(),K.zero(),K.zero(),K.zero()],this.textPosition=_.zero(),this.leaderPosition=_.zero(),this.isLoop=!1,this.pointRadius=2.5,this._viewer=t;const e=this._viewer.measureManager.getMeasurementColor();this._initialPoint.setFillColor(e),this._initialPoint.setStrokeColor(e),this._polyline.setStrokeColor(e),this._polyline.setStrokeWidth(2),this._leaderLine.setStrokeColor(e),this._endpoints.setFillColor(e),this._endpoints.setStrokeColor(e),this._endpoints.setFillOpacity(1),this._textShape.getBoxPortion().setFillOpacity(1),this._textShape.getBoxPortion().setFillColor(vt.white())}addPoint(t){if(this._positions.push(t.copy()),this._positions.length>1){const e=_.subtract(this._positions[this._positions.length-1],this._positions[this._positions.length-2]).length();this._setMeasurementValue(this._measurementValue+e)}}getPoints(){return this._positions}getlast(){return this._positions.length===0?null:this._positions[this._positions.length-1].copy()}finalize(){if(this.isLoop&&this._positions.length>2){const t=_.subtract(this._positions[this._positions.length-1],this._positions[0]).length();this._setMeasurementValue(this._measurementValue+t)}this._finalized=!0}setUnitMultiplier(t){this._unitMultiplier=t}isValid(){return this._positions.length>1}getMeasurementText(){return this._textShape.getTextString()}_updateProjectedPoints(){const t=[];this._behindView=!1,this._behindView=!1;for(const e of this._positions){const i=this._viewer.view.projectPoint(e);i.z<=0&&(this._behindView=!0),t.push(K.fromPoint3(i))}return t}_updateTextBoxCorners(){const t=this._viewer.markupManager.getRenderer().measureTextBox(this._textShape),e=this._textShape.getPosition();this._textboxCorners[0].assign(e),this._textboxCorners[1].set(e.x+t.x,e.y),this._textboxCorners[2].set(e.x+t.x,e.y+t.y),this._textboxCorners[3].set(e.x,e.y+t.y)}_calculateLeaderEndpoint(t){this._updateTextBoxCorners();const e=K.zero();let i=Number.MAX_VALUE;for(const n of this._textboxCorners){const r=K.distance(t,n);r<i&&(e.assign(n),i=r)}return e}draw(){if(!this._visibility)return;const t=this._updateProjectedPoints();if(this._behindView||t.length===0)return;const e=this._viewer.markupManager.getRenderer();if(t.length===1)this._initialPoint.set(t[0],this.pointRadius),e.drawCircle(this._initialPoint);else{this._polyline.clearPoints();for(const o of t)this._polyline.pushPoint(o);this._finalized&&this.isLoop&&this._polyline.pushPoint(t[0]);const i=K.fromPoint3(this._viewer.view.projectPoint(this.textPosition));this._textShape.setPosition(i),e.drawPolyline(this._polyline);const n=K.fromPoint3(this._viewer.view.projectPoint(this.leaderPosition)),r=this._calculateLeaderEndpoint(n);this._leaderLine.setP1(n),this._leaderLine.setP2(r),e.drawLine(this._leaderLine),e.drawTextBox(this._textShape),this._endpoints.clear(),this.isLoop||(this._endpoints.addCircle(t[0],this.pointRadius),this._endpoints.addCircle(t[t.length-1],this.pointRadius),e.drawCircles(this._endpoints))}}toJson(){return this._toJson()}_toJson(){const t=[];for(const e of this._positions)t.push(e.toJson());return{name:this._name,points:t,textPoint:this.textPosition.toJson(),leaderPoint:this.leaderPosition.toJson(),measurementValue:this._measurementValue,unitMultiplier:this._unitMultiplier,isLoop:this.isLoop,text:this._textShape.getTextString(),className:this.getClassName()}}static fromJson(t,e){const i=t,n=new Sh(e);return n._name=i.name,n._positions=Dn._constructPointArray(i.points),n.textPosition=_.fromJson(i.textPoint),n.leaderPosition=_.fromJson(i.leaderPoint),n.isLoop=i.isLoop,n._measurementValue=i.measurementValue,n._unitMultiplier=i.unitMultiplier||1,n._textShape.setTextString(i.text),n._finalized=!0,n}hit(t){const e=this._viewer.markupManager.getRenderer().measureTextBox(this._textShape),i=this._textShape.getPosition();return!(t.x<i.x||t.x>i.x+e.x||t.y<i.y||t.y>i.y+e.y)}getClassName(){return Sh.className}};Sh.className="Communicator.Markup.Measure.MeasurePolylineDistanceMarkup";let Al=Sh;ss(Al.className,Al.fromJson);class z_ extends Mi{constructor(t,e,i){super(t,e),this._markupItem=null,this._cameraInteractionActive=!1,this._textShapeOffset=new K(10,-25),this._anchor=Il.Last,this._dragPlane=null,this._measureManager=i,this._cursor=new oh(t,e),this._viewer.setCallbacks({beginInteraction:()=>{this._onBeginInteraction()},endInteraction:()=>{this._onEndInteraction()}})}getMarkupItem(){return this._markupItem}setAnchor(t){this._anchor=t}_useSnapping(t){return this._cursor.snappingConfig.enabled&&!t.altDown()}_getLastSelectedPoint(){return this._markupItem?this._markupItem.getlast():null}_createNewMarkupItem(t){this._markupItem=new Al(this._viewer),this._markupItem.setUnitMultiplier(t.selectionItem.isNodeSelection()?this._viewer.model.getNodeUnitMultiplier(t.selectionItem.getNodeId()):1),this._markupItem.setName("MeasurePolylineDistanceMarkup"),this._measureManager.addMeasurement(this._markupItem),this._markupItem.addPoint(t.worldPosition)}_updateMarkupItem(t,e){if(this._markupItem===null||e.worldPosition==null)return;const i=this._markupItem.getPoints(),n=K.fromPoint3(this._view.projectPoint(i[0]));K.distance(n,t)<this._markupItem.pointRadius?i.length>2&&(this._markupItem.isLoop=!0,this._finalizeMeasurement()):(this._markupItem.addPoint(e.worldPosition),this._updateAnchor(t,e.worldPosition))}async _updateMeasurementItem(t,e){const i=this._getLastSelectedPoint(),n=await this._cursor.getSelectionCursorPoints(t,e,i);if(n===null||n.worldPosition===null){this._cursor.activateCursorSprite(!1);return}else this._cursor.activateCursorSprite(!0);this._markupItem===null?this._createNewMarkupItem(n):this._updateMarkupItem(t,n)}_isDraggingText(){return this._dragPlane!==null}onMouseDown(t){if(super.onMouseDown(t),this._markupItem)return;const e=t.getPosition();this._pickExisting(e)&&(this._dragPlane=this._calculateSelectionPlane(this._markupItem.leaderPosition),t.setHandled(!0))}onMouseMove(t){if(super.onMouseMove(t),this._isDraggingText())this._dragMarkupText(t),t.setHandled(!0);else if(!this._cameraInteractionActive){const e=this._getLastSelectedPoint();this._cursor.updateCursorSprite(t.getPosition(),this._useSnapping(t),e),this._draw()}}async onMouseUp(t){if(!this.isActive())return;const e=t.getPosition();if(this._isDraggingText())this._markupItem=null,this._dragPlane=null;else if(this._ptFirst.equals(e)){const i=this._useSnapping(t),n=e;await this._updateMeasurementItem(n,i)}super.onMouseUp(t)}onDoubleClick(t){this._finalizeMeasurement()}_dragMarkupText(t){if(this._markupItem===null||this._dragPlane===null)return;const e=this._view.raycastFromPoint(t.getPosition());this._dragPlane.intersectsRay(e,this._markupItem.textPosition),this._draw()}_finalizeMeasurement(){if(this._markupItem)if(this._markupItem.isValid()){const t=this._markupItem;this._markupItem=null,t.finalize(),this._measureManager.finalizeMeasurement(t)}else this._clearMeasurement()}_updateAnchor(t,e){if(!this._markupItem)return;const i=this._markupItem.getPoints();if(i.length!==1)switch(this._anchor){case Il.Last:this._calculateAnchorPos(t,e);break;case Il.First:{if(i.length!==2)return;const n=this._view.projectPoint(i[0]);this._calculateAnchorPos(K.fromPoint3(n),i[0]);break}case Il.Midpoint:{let n;const r=this._markupItem.getMeasurementValue()/2;let o=0;for(let h=1;h<i.length;h++){const u=_.subtract(i[h],i[h-1]),d=u.length(),g=o+d;if(g>r){const m=(r-o)/d;u.scale(m),n=_.add(i[h-1],u);break}o=g}const l=this._view.projectPoint(n);this._calculateAnchorPos(K.fromPoint3(l),n);break}}}_calculateSelectionPlane(t){const e=this._view.getCamera(),i=_.subtract(e.getPosition(),t);return i.normalize(),Ki.createFromPointAndNormal(t,i)}_calculateAnchorPos(t,e){const i=this._view.getCamera();_.subtract(i.getPosition(),e).normalize();const r=this._calculateSelectionPlane(e),o=this._view.raycastFromPoint(K.add(t,this._textShapeOffset));o&&(r.intersectsRay(o,this._markupItem.textPosition),this._markupItem.leaderPosition.assign(e))}_clearMeasurement(){this._markupItem!==null?(this._measureManager.removeMeasurement(this._markupItem),this._markupItem=null):this._measureManager.removeLastMeasurement()}_draw(){this._viewer.markupManager.refreshMarkup(this._viewer.view)}_pickExisting(t){const e=this._viewer.markupManager.pickMarkupItem(t,this._viewer.view);return e&&e.getClassName()==="Communicator.MeasurePolylineDistanceMarkup"?(this._markupItem=e,!0):!1}onActivate(){this._cursor.onOperatorActivate()}onDeactivate(){this._cursor.onOperatorDeactivate()}onKeyDown(t){t.getKeyCode()===Je.Escape&&this._clearMeasurement()}_onBeginInteraction(){this._cameraInteractionActive=!0,this._cursor.activateCursorSprite(!1)}_onEndInteraction(){this._cameraInteractionActive=!1}}const Bb=Object.freeze(Object.defineProperty({__proto__:null,MeasureBodyBodyDistanceOperator:T_,MeasureEdgeLengthOperator:N_,MeasureFaceFaceAngleOperator:O_,MeasureFaceFaceDistanceOperator:R_,MeasureLineLineAngleOperator:F_,MeasurePointPointDistanceOperator:B_,MeasurePolygonAreaAnchor:bl,MeasurePolygonAreaOperator:V_,MeasurePolylineDistanceAnchor:Il,MeasurePolylineDistanceOperator:z_,PointCursor:oh,SelectionPoints:L_,Stage:Fs,worldPointToScreenPoint:nd},Symbol.toStringTag,{value:"Module"})),Vb=Object.freeze(Object.defineProperty({__proto__:null,MeasureBodyBodyDistanceMarkup:xl,MeasureCircleEdgeLengthMarkup:Cl,MeasureFaceFaceAngleMarkup:Sl,MeasureFaceFaceDistanceMarkup:Pl,MeasureLengthMarkup:sh,MeasureLineLineAngleMarkup:kl,MeasureMarkup:Dn,MeasurePointPointDistanceMarkup:Ml,MeasurePolygonAreaMarkup:El,MeasurePolylineDistanceMarkup:Al,MeasureStraightEdgeLengthMarkup:rh},Symbol.toStringTag,{value:"Module"})),Vl=class Vl extends uo{constructor(t,e,i,n,r){super(),this._uniqueId=hs(),this._noteElementId=null,this._position=_.zero(),this._text="",this._color=vt.white(),this._sphereRadius=.03,this._deleted=!1,this._active=!1,this._callbacks=null,this._viewer=t,this._noteTextManager=e,this._selectionPosition=i,this._selectionNormal=n,this._partId=r,this._noteTextManager.addNote(this),this._init()}async _init(){const t=this._createPinTransformationMatrix(this._selectionPosition,this._selectionNormal),[e,i]=await Promise.all([this._createPinStemInstance(t),this._createPinSphereInstance(t)]);this._stemInstanceId=e,this._sphereInstanceId=i,await this._restore(!1),this._callbacks={visibilityChanged:()=>{this._matchPartVisibility()}},this._viewer.setCallbacks(this._callbacks),this._viewer.trigger("noteTextCreated",this)}_matchPartVisibility(){if(this._sphereInstanceId===void 0||this._stemInstanceId===void 0)return;const t=this._viewer.model,e=t.getNodeVisibility(this._partId),i=t.getNodeVisibility(this._sphereInstanceId);e!==i&&!this._noteTextManager.getExplodeActive()&&t.setNodesVisibility([this._stemInstanceId,this._sphereInstanceId],e);const n=this._noteTextManager.getActiveItem();n!==null&&n.getStemInstanceId()===this._stemInstanceId&&!e&&this.hide()}async updatePosition(){if(this._sphereInstanceId===void 0)return;const t=await this._viewer.model.getNodeRealBounding(this._sphereInstanceId);this._pinBoundingBox=t,this._position=this._pinBoundingBox.center(),this.setText(this._text)}async _restore(t){this._noteTextManager.setActiveItemHandle(this._viewer.markupManager.registerMarkup(this,this._viewer.view)),this._noteTextManager.setActiveItem(this),this._show(t),this._updateColor(),await this.draw()}async restore(){return this._restore(!0)}setText(t){this._text=t,this._noteTextManager.getNoteTextElement().setText(t)}saveTextValue(){this._text=this._noteTextManager.getNoteTextElement().getText()}async draw(){if(this._deleted||!this._active)return;this._behindView=!1,await this.updatePosition();const t=this._viewer.view.projectPoint(this._position);if(t.z<=0&&(this._behindView=!0),this._behindView)this._noteElementId!==null&&document.getElementById(this._noteElementId)!==null&&(this._viewer.markupManager.removeMarkupElement(this._noteElementId,this._viewer.view),this._noteElementId=null);else{const e=new K(t.x,t.y),i=this._noteTextManager.getNoteTextElement();i.setPosition(e),this._noteElementId===null&&(this._noteElementId=this._viewer.markupManager.addMarkupElement(i.getHtmlContainer(),this._viewer.view))}}hit(t,e){return this.hitWithTolerance(t,e,0)}hitWithTolerance(t,e,i){if(!this._active)return!1;const n=this._noteTextManager.getNoteTextElement(),r=n.getPosition(),o=n.getSize();return ef(t,r,o,i)}getClassName(){return Vl.className}getUniqueId(){return this._uniqueId}getSphereInstanceId(){return this._sphereInstanceId}getStemInstanceId(){return this._stemInstanceId}onSelect(){this._noteTextManager.getNoteTextElement().focus()}onDeselect(){this._noteTextManager.getNoteTextElement().blur()}hide(){const t=this._noteTextManager.getNoteTextElement();t.hide(),this.setText(t.getText()),this._noteTextManager.setActiveItem(null),this._active=!1,this._viewer.trigger("noteTextHidden",this)}_show(t){this._noteTextManager.getNoteTextElement().show(this),this._active=!0,t&&this._viewer.trigger("noteTextShown",this)}show(){this._show(!0)}async remove(t){if(this.getRemoved()===!0)return;this._callbacks!==null&&(this._viewer.unsetCallbacks(this._callbacks),this._callbacks=null);const e=this._viewer.model,i=[];this._stemInstanceId!==void 0&&i.push(e.deleteMeshInstances([this._stemInstanceId])),this._sphereInstanceId!==void 0&&i.push(e.deleteMeshInstances([this._sphereInstanceId])),this.hide(),this._noteTextManager.removeNote(this),this._deleted=!0,await Ue(i),super.remove(t)}getRemoved(){return this._deleted}setColor(t){return this._color=t,this._updateColor(),Promise.resolve()}getColor(){return this._color}getPartId(){return this._partId}_updateColor(){this._sphereInstanceId!==void 0&&this._viewer.model.setNodesFaceColor([this._sphereInstanceId],this._color)}_createPinTransformationMatrix(t,e){let i=0,n=e.x;Math.abs(e.y)<Math.abs(n)&&(n=e.y,i=1),Math.abs(e.z)<Math.abs(n)&&(i=2);const r=[0,0,0];r[i]=1;const o=_.createFromArray(r),l=_.cross(e,o).normalize(),h=_.cross(e,l);let u=new _t;return u.m=[e.x,e.y,e.z,0,l.x,l.y,l.z,0,h.x,h.y,h.z,0,0,0,0,1],u=_t.multiply(u,new _t().setScaleComponent(this._sphereRadius,this._sphereRadius,this._sphereRadius)),u.setTranslationComponent(t.x,t.y,t.z),u}async _createPinStemInstance(t){const e=this._noteTextManager.getPinStemMeshId();if(e===null)throw new ae("stem mesh hasn't been created yet");const i=new Ns(e,t,"pin-stem-instance",void 0,vt.black());i.setOpacity(1);const n=ie.SuppressCameraScale|ie.DoNotCut|ie.DoNotExplode|ie.DoNotXRay|ie.ExcludeBounding|ie.OverrideSceneVisibility|ie.AlwaysDraw;return i.setCreationFlags(n),this._viewer.model.createMeshInstance(i,void 0,!0,!0)}async _createPinSphereInstance(t){const e=this._noteTextManager.getPinSphereMeshId();if(e===null)throw new ae("sphere mesh hasn't been created yet");const i=new Ns(e,t,"pin-sphere-instance",vt.white(),void 0);i.setOpacity(1);const n=ie.SuppressCameraScale|ie.DoNotCut|ie.DoNotExplode|ie.DoNotXRay|ie.ExcludeBounding|ie.OverrideSceneVisibility|ie.AlwaysDraw;return i.setCreationFlags(n),this._viewer.model.createMeshInstance(i,void 0,!0,!0)}toJson(){return this._toJson()}_toJson(){return{uniqueId:this._uniqueId,className:this.getClassName(),selectionPosition:this._selectionPosition.toJson(),selectionNormal:this._selectionNormal.toJson(),text:this._text,color:this._color,partId:this._partId}}static _fromJson(t,e,i){const n=t;if(!i.findById(n.uniqueId)){const r=_.fromJson(n.selectionPosition),o=_.fromJson(n.selectionNormal),l=n.partId,h=new Vl(e,i,r,o,l);return h._uniqueId=n.uniqueId,h.setText(n.text),h.setColor(vt.fromJson(n.color)),h}return null}static async fromJson(t,e,i){return Vl._fromJson(t,e,i)}};Vl.className="Communicator.Markup.Note.NoteText";let Ia=Vl;ss(Ia.className,Ia.fromJson);class H_{constructor(){this._positionOffset=K.zero(),this._position=K.zero(),this._activeNoteText=null,this._createTextBox()}_createTextBox(){this._container=document.createElement("div"),this._container.className="noteTextElement",this._textArea=document.createElement("textarea"),this._textArea.oninput=()=>{this._activeNoteText!==null&&this._activeNoteText.saveTextValue()},this._container.appendChild(this._textArea);const t=["blue","red","green","white","black"];let e=7;t.forEach(n=>{const r=document.createElement("button");r.className=`noteButton color ${n}`,r.style.top=`${e}px`,e+=25,r.id=`${n}_button`;let o;switch(n){case"blue":o=vt.blue();break;case"red":o=vt.red();break;case"green":o=vt.green();break;case"white":o=vt.white();break;case"black":o=vt.black();break;default:o=vt.white();break}r.onmousedown=()=>{this._activeNoteText!==null&&this._activeNoteText.setColor(o)},this._container.appendChild(r)});const i=document.createElement("button");i.className="noteButton trash",i.style.top=`${e}px`,i.onmousedown=async()=>{this._activeNoteText!==null&&await this._activeNoteText.remove(null)},this._container.appendChild(i)}setPositionOffset(t){this._positionOffset=t}getPositionOffset(){return this._positionOffset.copy()}setPosition(t){this._position=K.add(t,this._positionOffset),this._container.style.left=`${this._position.x}px`,this._container.style.top=`${this._position.y}px`}getPosition(){return this._position.copy()}setText(t){const e=this._container.querySelector("textarea");e!==null&&(e.value=t)}getText(){const t=this._container.querySelector("textarea");return t!==null?t.value:""}setSize(t){this._container.style.width=`${t.x}px`,this._container.style.height=`${t.y}px`}getSize(){const t=this._container.getBoundingClientRect();return new K(t.width,t.height)}focus(){this._textArea.focus(),this._textArea.style.pointerEvents="auto"}blur(){this._container.blur()}hide(){this._container.style.visibility="hidden",this._activeNoteText=null}show(t){this._container.style.visibility="visible",this._activeNoteText=t}getHtmlContainer(){return this._container}setHtmlContainer(t){this._container=t}}class ah{exportMarkup(){return[]}loadData(t){return Promise.resolve([])}}const Hr=class Hr extends ah{constructor(t){super(),this._pinSphereMeshId=null,this._pinStemMeshId=null,this._noteTextList=[],this._activeItemHandle=null,this._activeItem=null,this._explodeActive=!1,this._isolateActive=!1,this._stemLength=2,this._sphereIterations=2,this._viewer=t,this._noteTextElement=new H_,this._noteTextElement.setPositionOffset(new K(12,-24));const e={sceneReady:async()=>{await this._init()},modelSwitched:async()=>{await this._init()}};this._viewer.setCallbacks(e)}async _init(){Hr._globalPinSphereMeshData===null&&(Hr._globalPinSphereMeshData=this._createPinSphereMeshData()),Hr._globalPinStemMeshData===null&&(Hr._globalPinStemMeshData=this._createPinStemMeshData());const t=this._viewer.model,e=t.createMesh(Hr._globalPinSphereMeshData),i=t.createMesh(Hr._globalPinStemMeshData),n=await Promise.all([e,i]);this._pinSphereMeshId=n[0],this._pinStemMeshId=n[1]}_createPinStemMeshData(){const t=new rs;return t.addPolyline([0,0,0,this._stemLength,0,0]),t}_createPinSphereMeshData(){const t=(1+Math.sqrt(5))/2,e=Math.sqrt(10+2*Math.sqrt(5))/(4*t),i=e/2,n=e/(2*t),r=[];r[0]=new _(-n,i,0),r[1]=new _(n,i,0),r[2]=new _(-n,-i,0),r[3]=new _(n,-i,0),r[4]=new _(0,-n,i),r[5]=new _(0,n,i),r[6]=new _(0,-n,-i),r[7]=new _(0,n,-i),r[8]=new _(i,0,-n),r[9]=new _(i,0,n),r[10]=new _(-i,0,-n),r[11]=new _(-i,0,n);for(const g of r)g.normalize();let o=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],l=12;for(let g=0;g<this._sphereIterations;g++){const y=[];o.map(m=>{const I=r[m[0]],b=r[m[1]],x=r[m[2]];r[l++]=new _(I.x+b.x,I.y+b.y,I.z+b.z).scale(.5).normalize(),r[l++]=new _(b.x+x.x,b.y+x.y,b.z+x.z).scale(.5).normalize(),r[l++]=new _(x.x+I.x,x.y+I.y,x.z+I.z).scale(.5).normalize(),y.push([m[0],l-3,l-1]),y.push([l-3,l-2,l-1]),y.push([l-3,m[1],l-2]),y.push([l-2,m[2],l-1])}),o=y}const h=[],u=[];for(const g of o)for(let y=0;y<3;y++){const m=g[y],I=r[m];h.push(I.x+this._stemLength+1),h.push(I.y),h.push(I.z);const b=I.normalize();u.push(b.x),u.push(b.y),u.push(b.z)}const d=new rs;return d.addFaces(h,u),d.setFaceWinding(Rs.CounterClockwise),d}getPinStemMeshId(){return this._pinStemMeshId}getPinSphereMeshId(){return this._pinSphereMeshId}getNoteTextElement(){return this._noteTextElement}setNoteTextElement(t){this._noteTextElement.hide(),this._noteTextElement=t}getNoteTextList(){return this._noteTextList}addNote(t){this._noteTextList.push(t),this._activeItem=t}removeNote(t){const e=this._noteTextList.indexOf(t);this._noteTextList.splice(e,1)}async updatePinVisibility(){if(this._noteTextList.length>0){const t=[];for(const i of this._noteTextList){const n=i.getSphereInstanceId(),r=i.getStemInstanceId();n!==void 0&&t.push(n),r!==void 0&&t.push(r)}const e=this._viewer.model.setNodesVisibility(t,!this._explodeActive);return this._explodeActive&&this._noteTextElement.hide(),e}}explode(t){return this._explodeActive=t>0,this.updatePinVisibility()}getExplodeActive(){return this._explodeActive}setIsolateActive(t){this._isolateActive=t}getIsolateActive(){return this._isolateActive}getActiveItem(){return this._activeItem}setActiveItem(t){this._activeItem=t}getActiveItemHandle(){return this._activeItemHandle}setActiveItemHandle(t){this._activeItemHandle=t}selectPin(t){this._activeItem&&this._activeItem.hide();const e=t.getNodeId();if(e!==null){const i=this._getNoteTextFromNodeId(e);if(i!==null)return i.restore(),!0}return!1}checkPinInstance(t){return this._getNoteTextFromNodeId(t)!==null}_getNoteTextFromNodeId(t){for(const e of this._noteTextList)if(e.getSphereInstanceId()===t||e.getStemInstanceId()===t)return e;return null}findById(t){for(const e of this._noteTextList)if(t===e.getUniqueId())return!0;return!1}loadData(t){const e=[];for(const i of t){const n=Ia.fromJson(i,this._viewer,this).then(r=>r!==null);e.push(n)}return Promise.all(e)}exportMarkup(){const t=[];for(const e of this._noteTextList)t.push(e.toJson());return t}};Hr._globalPinSphereMeshData=null,Hr._globalPinStemMeshData=null;let sd=Hr;const zb=Object.freeze(Object.defineProperty({__proto__:null,NoteText:Ia,NoteTextElement:H_,NoteTextManager:sd},Symbol.toStringTag,{value:"Module"}));class lh{constructor(t,e,i,n,r,o){this.vector=e,this.matrix=i,this.nodeId=n,this.position=t,this.handleType=r,this.translation=_.zero(),this.groupId=o}}class U_{constructor(){this.axis=null,this.plane=null,this.viewPlane=null,this.rotate=null}}const ue=class ue extends uo{constructor(t){super(),this._meshIds=new U_,this._scaleModifier=1,this._id=0,this._handleData=new Map,this._translationFromInitialHandlePosition=_.zero(),this._groupIdRotationMatrix=new Map,this._viewer=t,this._callbacks={camera:()=>{this._updateCamera()},_assemblyTreeReady:async()=>{this._updateViewport(),this._hideOverlay();const e=this._createMeshId(this._getAxisMeshData()).then(o=>{this._meshIds.axis=o}),i=this._createMeshId(this._getPlaneMeshData()).then(o=>{this._meshIds.plane=o}),n=this._createMeshId(this._getViewPlaneMeshData()).then(o=>{this._meshIds.viewPlane=o}),r=this._createMeshId(this._getRotateMeshData()).then(o=>{this._meshIds.rotate=o});await Promise.all([e,i,n,r])},modelSwitchStart:()=>{this.removeHandles()}},this._viewer.setCallbacks(this._callbacks)}remove(t){this._callbacks!==null&&(this._viewer.unsetCallbacks(this._callbacks),this._callbacks=null),super.remove(t)}_getAxisMeshData(){return ff(ue._cylinderRadius,ue._segmentCount,ue._cylinderHeight,ue._coneBaseRadius,ue._capHeight,ue._taperHeight)}_getPlaneMeshData(){const t=new _(ue._planeOffset,0,ue._planeOffset),e=new _(ue._planeOffset+ue._planeLength,0,ue._planeOffset),i=new _(ue._planeOffset+ue._planeLength,0,ue._planeOffset+ue._planeLength),n=new _(ue._planeOffset,0,ue._planeOffset+ue._planeLength),r=[t.x,t.y,t.z,e.x,e.y,e.z,i.x,i.y,i.z,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z],o=new _(0,-1,0),l=[o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z],h=new rs;return h.addFaces(r,l),h.setBackfacesEnabled(!0),h.addPolyline([t.x,t.y,t.z,e.x,e.y,e.z]),h.addPolyline([e.x,e.y,e.z,i.x,i.y,i.z]),h.addPolyline([i.x,i.y,i.z,n.x,n.y,n.z]),h.addPolyline([n.x,n.y,n.z,t.x,t.y,t.z]),h}_getViewPlaneMeshData(){return Zp()}_getRotateMeshData(t=35,e=12,i=.5){const n=t*Math.PI/180,r=.1,o=.5*n,l=[];for(let g=-o;g<=o;g+=r){const y=Math.sin(g)*e,m=Math.cos(g)*e;l.push(m),l.push(0),l.push(y)}const h=new _(0,0,1),d=tm(l,h,10,i);return d.setBackfacesEnabled(!0),d}async setAxisMeshData(t){if(this._meshIds.axis===null){const e=await this._createMeshId(t);this._meshIds.axis=e}else return this._viewer.model.replaceMesh(this._meshIds.axis,t)}async setPlaneMeshData(t){if(this._meshIds.plane===null){const e=await this._createMeshId(t);this._meshIds.plane=e}else return this._viewer.model.replaceMesh(this._meshIds.plane,t)}async setViewPlaneMeshData(t){if(this._meshIds.viewPlane===null){const e=await this._createMeshId(t);this._meshIds.viewPlane=e}else return this._viewer.model.replaceMesh(this._meshIds.viewPlane,t)}async setRotateMeshData(t){if(this._meshIds.rotate===null){const e=await this._createMeshId(t);this._meshIds.rotate=e}else return this._viewer.model.replaceMesh(this._meshIds.rotate,t)}getOverlayId(){return ye.Handles}_hideOverlay(){this._viewer.overlayManager.setVisibility(ye.Handles,!1)}hideOverlay(){return this._hideOverlay(),Promise.resolve()}_showOverlay(){this._viewer.overlayManager.setVisibility(ye.Handles,!0),this._updateCamera()}showOverlay(){return this._showOverlay(),Promise.resolve()}_updateViewport(){this._viewer.overlayManager.setViewport(ye.Handles,je.UpperLeftCorner,0,De.ProportionOfCanvas,0,De.ProportionOfCanvas,1,De.ProportionOfCanvas,1,De.ProportionOfCanvas)}updateViewport(){return this._updateViewport(),Promise.resolve()}async addHandles(t,e,i){this._scaleModifier=e,this._translationFromInitialHandlePosition.assign(_.zero()),await this.createDefaultHandles(t,i),this._showOverlay()}_updateCamera(){this._viewer.overlayManager.setCamera(ye.Handles,this._viewer.view.getCamera())}getVector(t){const e=this._handleData.get(t);if(e!==void 0){const i=e.vector;if(i!==null)return i.copy()}return null}getHandleType(t){const e=this._handleData.get(t);return e===void 0?null:e.handleType}getHandleGroupId(t){const e=this._handleData.get(t);return e===void 0?ue.defaultGroupId:e.groupId}getPosition(t){const e=this._handleData.get(t);if(e){const i=e.translation.copy();return e.position.copy().add(this._translationFromInitialHandlePosition).add(i)}else return null}getHandleNodeIds(t=null){let e=[];return this._handleData.forEach((i,n)=>{e.push([n,i])}),t!==null&&(e=e.filter(i=>i[1].groupId===t)),e.map(i=>i[0])}async removeHandles(t=null){const e=this.getHandleNodeIds(t);t===null?(this._handleData.clear(),this._groupIdRotationMatrix.clear()):(e.forEach(i=>{this._handleData.delete(i)}),this._groupIdRotationMatrix.delete(t)),this._handleData.size===0&&(this._id=0,this._hideOverlay()),await this._viewer.model.deleteMeshInstances(e)}isEmpty(){return this._handleData.size===0}async createDefaultHandles(t,e){const i=[];i.push(this.addViewPlaneHandle(t,ue._viewPlaneColor,e)),i.push(this.addAxisTranslationHandle(t,new _(1,0,0),ue._xColor,null,e)),i.push(this.addAxisTranslationHandle(t,new _(0,1,0),ue._yColor,null,e)),i.push(this.addAxisTranslationHandle(t,new _(0,0,1),ue._zColor,null,e)),i.push(this.addPlaneTranslationHandle(t,new _(1,0,0),ue._zColor,vt.black(),new _(0,-1,0),e)),i.push(this.addPlaneTranslationHandle(t,new _(0,1,0),ue._xColor,vt.black(),new _(0,0,-1),e)),i.push(this.addPlaneTranslationHandle(t,new _(0,0,1),ue._yColor,vt.black(),new _(-1,0,0),e)),i.push(this.addRotateHandle(t,new _(1,0,0),ue._zColor,new _(0,-1,0),e)),i.push(this.addRotateHandle(t,new _(0,1,0),ue._xColor,new _(0,0,-1),e)),i.push(this.addRotateHandle(t,new _(0,0,1),ue._yColor,new _(-1,0,0),e)),await Promise.all(i)}async _createMeshId(t){return await this._viewer.model.createMesh(t,{doNotDelete:!0})}async addAxisTranslationHandle(t,e,i,n,r){this._meshIds.axis===null&&(this._meshIds.axis=await this._createMeshId(this._getAxisMeshData()));const o=`handle-axis-translation-${this._id++}`,l=this._getRotationMatrixFromVector(e,n),h=await this._createMeshInstance(this._meshIds.axis,o,i,null,t.copy(),l.copy());return this._handleData.set(h,new lh(t.copy(),e.copy(),l.copy(),h,dr.Axis,r)),h}async addViewPlaneHandle(t,e,i){this._meshIds.viewPlane===null&&(this._meshIds.viewPlane=await this._createMeshId(this._getViewPlaneMeshData()));const n=await this._createMeshInstance(this._meshIds.viewPlane,"handle-sphere-instance",e,null,t,new _t);return this._handleData.set(n,new lh(t.copy(),null,new _t,n,dr.ViewPlane,i)),n}async addPlaneTranslationHandle(t,e,i,n,r,o){this._meshIds.plane===null&&(this._meshIds.plane=await this._createMeshId(this._getPlaneMeshData()));const l=`handle-plane-translation-${this._id++}`,h=this._getRotationMatrixFromVector(e,r),u=await this._createMeshInstance(this._meshIds.plane,l,i,n,t,h);return this._handleData.set(u,new lh(t.copy(),e.copy(),h.copy(),u,dr.Plane,o)),u}async addRotateHandle(t,e,i,n,r){this._meshIds.rotate===null&&(this._meshIds.rotate=await this._createMeshId(this._getRotateMeshData()));const o=`handle-rotate-${this._id++}`,l=this._getRotationMatrixFromVector(e,n),h=await this._createMeshInstance(this._meshIds.rotate,o,i,null,t,l);return this._handleData.set(h,new lh(t.copy(),e.copy(),l.copy(),h,dr.Rotate,r)),h}_getRotationMatrixFromVector(t,e){e||(e=new _(1,0,0),_.cross(e,t).squaredLength()<.001&&(e=new _(0,1,0)));const i=_.cross(e,t).normalize(),n=_.cross(i,t).normalize();t.normalize();const r=new _t;return r.m[0]=i.x,r.m[1]=i.y,r.m[2]=i.z,r.m[3]=0,r.m[4]=t.x,r.m[5]=t.y,r.m[6]=t.z,r.m[7]=0,r.m[8]=n.x,r.m[9]=n.y,r.m[10]=n.z,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1,r}async _createMeshInstance(t,e,i,n,r,o){let l=this._createTransformationMatrix(r,new _t);l=_t.multiply(o,l);const h=new Ns(t,l,e,i??void 0,n??void 0);return h.setOpacity(1),h.setCreationFlags(ie.SuppressCameraScale|ie.DoNotCut|ie.DoNotExplode|ie.ExcludeBounding|ie.DoNotXRay|ie.OverrideSceneVisibility|ie.AlwaysDraw),h.setOverlayIndex(ye.Handles),this._viewer.model.createMeshInstance(h,void 0,!1,!0)}_createTransformationMatrix(t,e){const i=ue._defaultScale*this._scaleModifier;let n=new _t().setScaleComponent(i,i,i);return n=_t.multiply(n,e),n.setTranslationComponent(t.x,t.y,t.z),n}_getHandlePosition(t){let e=null;return this._handleData.forEach(i=>{i.groupId===t&&(e=i.position.copy())}),e}getGroupIdRotationMatrix(t){const e=this._groupIdRotationMatrix.get(t);return e===void 0?new _t:e.copy()}async updatePosition(t,e,i,n,r){const o=this._viewer.model,l=[],h=new Map,u=this._getHandlePosition(n);u!==null&&(this._handleData.forEach((d,g)=>{const y=d.groupId,m=r.get(y)!==void 0;if(!(y===n)&&!m)return;const b=d.position.copy();b.add(t.copy());const x=d.translation.copy();b.add(x);const C=_t.multiply(this.getGroupIdRotationMatrix(y),e),P=_t.multiply(d.matrix,C);if(m){const O=_.subtract(b,u);e.transform(O,b),b.add(u)}const k=this._createTransformationMatrix(b,P);i&&(d.position.assign(b),h.set(y,_t.multiply(this.getGroupIdRotationMatrix(y),e))),l.push(o.setNodeMatrix(g,k))}),h.forEach((d,g)=>{this._groupIdRotationMatrix.set(g,d.copy())}),await Promise.all(l))}resetTranslation(){this._translationFromInitialHandlePosition&&(this._handleData.forEach(t=>{t.translation.add(this._translationFromInitialHandlePosition)}),this._translationFromInitialHandlePosition.assign(_.zero()))}getTranslation(){return this._translationFromInitialHandlePosition}};ue.className="Communicator.Markup.HandleMarkup",ue.defaultGroupId=-1,ue._defaultScale=.02,ue._cylinderRadius=.5,ue._coneBaseRadius=.9,ue._cylinderHeight=7,ue._capHeight=1.2,ue._taperHeight=.2,ue._segmentCount=20,ue._planeOffset=1,ue._planeLength=2.5,ue._xColor=new vt(168,56,59),ue._yColor=new vt(96,166,50),ue._zColor=new vt(41,81,185),ue._viewPlaneColor=vt.white();let ch=ue;const Hb=Object.freeze(Object.defineProperty({__proto__:null,CursorMarkup:cg,HandleData:lh,HandleMarkup:ch,HandleMeshIds:U_,Measure:Vb,Note:zb,Redline:pb},Symbol.toStringTag,{value:"Module"}));class hh extends Mi{constructor(t,e){super(t,e),this._activeRedlineItem=null,this._newRedlineItem=null,this._viewer=t}createRedlineItem(t){return null}updateRedlineItem(t){}finalizeRedlineItem(t){return null}onMouseDown(t){super.onMouseDown(t),this.isActive()&&((t.getButton()===Me.Left||this._primaryTouchId!==null)&&this._redlineOperatorStart(),t.setHandled(!0))}onMouseMove(t){super.onMouseMove(t),this.isActive()&&(this._redlineOperatorMove(),t.setHandled(!0))}onMouseUp(t){this.isActive()&&((t.getButton()===Me.Left||this._primaryTouchId!==null)&&this._redlineOperatorEnd(),t.setHandled(!0)),super.onMouseUp(t)}onMousewheel(t){t.setHandled(!0)}setDraggingEnabled(t){this._dragging=t}setHandled(){return!0}_isRedlineItem(t){return Object.getPrototypeOf(t)instanceof pl}onKeyUp(t){const e=t.getKeyCode();if(e===Je.Backspace||e===Je.Delete){const i=this._viewer.markupManager,n=i.getSelectedMarkup(),r=i.getActiveMarkupView(this._view);n!==null&&this._isRedlineItem(n)&&r!==null&&(r.removeMarkup(n),i.selectMarkup(null,this._view))}}_removeRedlineTextIfInvalid(t){const e=t;if(!e.isValid()){const i=this._viewer.markupManager.getActiveMarkupView(this._view);i!==null&&(i.removeMarkup(e),this._viewer.trigger("redlineDeleted",e)),e.remove(null)}}_redlineOperatorStart(){const t=this._viewer.markupManager,e=t.pickMarkupItem(this._ptFirst,this._view),i=t.getSelectedMarkup();if(!e)i!=null&&i.onDeselect(),t.selectMarkup(null,this._view),this._markupIsTextArea(i)?this._removeRedlineTextIfInvalid(i):this._newRedlineItem=this.createRedlineItem(this._ptFirst);else if(this._activeRedlineItem=e,this._dragging&&this._activeRedlineItem.onDragStart(this._ptFirst,this._view)){t.refreshMarkup(this._view);const n=this._viewer.markupManager.getActiveMarkupView(this._view);n&&this._viewer.markupManager.refreshMarkupView(n)}}_redlineOperatorMove(){if(this._activeRedlineItem){if(this._dragging&&this._activeRedlineItem.onDragMove(this._ptCurrent,this._view)){this._viewer.markupManager.refreshMarkup(this._view);const t=this._viewer.markupManager.getActiveMarkupView(this._view);t&&this._viewer.markupManager.refreshMarkupView(t)}}else this.updateRedlineItem(this._ptCurrent)}_redlineOperatorEnd(){const t=this._viewer.markupManager;if(this._activeRedlineItem){if(this._ptFirst.equals(this._ptCurrent))t.selectMarkup(this._activeRedlineItem,this._view);else if(this._viewer.trigger("redlineUpdated",this._activeRedlineItem),this._dragging&&this._activeRedlineItem.onDragEnd(this._ptCurrent,this._view)){t.refreshMarkup(this._view);const e=this._viewer.markupManager.getActiveMarkupView(this._view);e&&this._viewer.markupManager.refreshMarkupView(e)}}else if(this._newRedlineItem){const e=this.finalizeRedlineItem(this._ptCurrent);e&&this._attachNewMarkupToView(e)}this._activeRedlineItem=null,this._newRedlineItem=null}async _attachNewMarkupToView(t){const e=this._viewer,i=e.model,n=e.markupManager;let r=n.getActiveMarkupView(this._view),o=!1;if(r===null){const l=i.getAbsoluteRootNode(),h=await i.getVisibilityState(l),u=await i.getNodeColorMap(i.getAbsoluteRootNode(),Yt.Faces),d=n.createMarkupView(this._view,void 0,!1,h,u,null);r=n.getMarkupView(d),o=!0}r!==null&&(r.addMarkupItem(t),n.selectMarkup(t,this._view),n.refreshMarkupView(r)),o&&r!==null&&this._viewer.trigger("viewCreated",r),this._viewer.trigger("redlineCreated",t)}_markupIsTextArea(t){return t?t.getClassName()===Fo.className:!1}}class j_ extends hh{constructor(t,e){super(t,e),this._redlineCircle=null,this._previewHandle=null,this._centerSet=!1}createRedlineItem(t){const e=this._view;this._redlineCircle=new _a(this._viewer),this._previewHandle=this._viewer.markupManager.registerMarkup(this._redlineCircle,this._view);const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return i!==null&&(this._centerSet=!0,this._redlineCircle.setCenter(i),this._redlineCircle.setRadiusPoint(i)),this._redlineCircle}updateRedlineItem(t){const e=this._view;if(this._redlineCircle){const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);i!==null&&(this._centerSet||(this._centerSet=!0,this._redlineCircle.setCenter(i)),this._redlineCircle.setRadiusPoint(i),this._viewer.markupManager.refreshMarkup(this._view))}}finalizeRedlineItem(t){const e=this._viewer.markupManager;let i=null;return this._redlineCircle&&(this._redlineCircle.isValid()&&(i=this._redlineCircle),this._redlineCircle=null,this._previewHandle!==null&&(e.unregisterMarkup(this._previewHandle,this._view),this._previewHandle=null),e.refreshMarkup(this._view)),this._centerSet=!1,i}}class W_ extends hh{constructor(t,e){super(t,e),this._redlinePolyline=null,this._previewHandle=null}createRedlineItem(t){const e=this._view;this._redlinePolyline=new wa(this._viewer),this._previewHandle=this._viewer.markupManager.registerMarkup(this._redlinePolyline,this._view);const i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return i!==null&&this._redlinePolyline.addPoint(i),this._redlinePolyline}updateRedlineItem(t){if(this._redlinePolyline){const e=this._view,i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);i!==null&&(this._redlinePolyline.addPoint(i),this._viewer.markupManager.refreshMarkup(this._view))}}finalizeRedlineItem(t){const e=this._viewer.markupManager;let i=null;return this._redlinePolyline&&(this._redlinePolyline.isValid()&&(i=this._redlinePolyline),this._redlinePolyline=null,this._previewHandle!==null&&(e.unregisterMarkup(this._previewHandle,this._view),this._previewHandle=null),e.refreshMarkup(this._view)),i}}class G_ extends hh{constructor(t,e){super(t,e),this._redlineRectangle=null,this._previewHandle=null}createRedlineItem(t){const e=this._view,i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return this._redlineRectangle=new va(this._viewer),i!==null&&(this._redlineRectangle.setPoint1(i),this._redlineRectangle.setPoint2(i)),this._previewHandle=this._viewer.markupManager.registerMarkup(this._redlineRectangle,this._view),this._redlineRectangle}updateRedlineItem(t){if(this._redlineRectangle){const e=this._view,i=e.getCamera().getCameraPlaneIntersectionPoint(t,e);i!==null&&this._redlineRectangle.setPoint2(i),this._viewer.markupManager.refreshMarkup(this._view)}}finalizeRedlineItem(t){let e=null;if(this._redlineRectangle&&this._previewHandle){const i=this._viewer.markupManager;this._redlineRectangle.isValid()&&(e=this._redlineRectangle),i.unregisterMarkup(this._previewHandle,this._view),this._previewHandle=null,this._redlineRectangle=null,i.refreshMarkup(this._view)}return e}}class $_ extends hh{constructor(t,e){super(t,e),this._redlineText=null}createRedlineItem(t){return this._redlineText=new Fo(this._viewer),this._redlineText}finalizeRedlineItem(t){if(this._redlineText===null)return null;const e=this._view,i=this._redlineText,n=e.getCamera().getCameraPlaneIntersectionPoint(t,e);return n!==null&&i.setPosition(n),this._redlineText=null,i}}const Ub=Object.freeze(Object.defineProperty({__proto__:null,RedlineCircleOperator:j_,RedlineOperator:hh,RedlinePolylineOperator:W_,RedlineRectangleOperator:G_,RedlineTextOperator:$_},Symbol.toStringTag,{value:"Module"}));class q_ extends Mi{constructor(t,e){super(t,e),this._forceEffectiveSceneVisibilityMask=xe.None,this._rectangleMarkup=new ag(t,!1),this._incrementalSelection=nh.create("SelectionManager",t),t.setCallbacks({_resetAssemblyTreeBegin:async()=>(await this.clearSelection(),this.waitForIdle())})}getForceEffectiveSceneVisibilityMask(){return this._forceEffectiveSceneVisibilityMask}setForceEffectiveSceneVisibilityMask(t){this._forceEffectiveSceneVisibilityMask=t}hasActiveSelection(){return!this._incrementalSelection.isIdle()}async waitForIdle(){return this._incrementalSelection.waitForIdle()}async clearSelection(){return this._incrementalSelection.clearSelection()}_allowSelection(t,e){return!(t.x===e.x||t.y===e.y)}_createBeginConfig(t,e,i){const n=new Yc;return n.forceEffectiveSceneVisibilityMask=this._forceEffectiveSceneVisibilityMask,n.ignoreCuttingSections=!1,n.ignoreUnrequestedInstances=!0,i&&(n.mustBeFullyContained=!0),{pickConfig:n,areaCssMin:t,areaCssMax:e}}async _performSelection(t){const e=this._rectangleMarkup.min.copy(),i=this._rectangleMarkup.max.copy(),n=this._rectangleMarkup.initialPosition.x<this._rectangleMarkup.currentPosition.x;if(t&&await this.clearSelection(),!this._allowSelection(e,i))return;const r=this._createBeginConfig(e,i,n);try{return await this._incrementalSelection.performSelection(r)}catch(o){if(!(o instanceof Or))throw o}}setHandled(){return!0}onKeyUp(t){t.getKeyCode()===Je.Escape&&this.clearSelection()}onMouseDown(t){super.onMouseDown(t),this.isActive()&&(t.setHandled(!0),this._rectangleMarkup.isActive()&&this._rectangleMarkup.deactivate(),this._rectangleMarkup.activate(t.getPosition()))}onMouseMove(t){super.onMouseMove(t),this.isActive()&&this._rectangleMarkup.isActive()&&(t.setHandled(!0),this._rectangleMarkup.updateCurrentPosition(t.getPosition()),this._viewer.markupManager.refreshMarkup(this._view))}onMouseUp(t){if(this.isActive()&&this._rectangleMarkup.isActive()){t.setHandled(!0),this._rectangleMarkup.updateCurrentPosition(t.getPosition());const e=!t.controlDown();this._performSelection(e)}this._rectangleMarkup.isActive()&&this._rectangleMarkup.deactivate(),super.onMouseUp(t)}}class K_ extends Mi{constructor(t,e){super(t,e),this._axisTriad=e.getAxisTriad(),this._pickConfig=new yi(xe.Face),this._pickConfig.restrictToOverlays=!0}async onMouseUp(t){if(this._axisTriad.getEnabled()&&K.subtract(this._ptFirst,this._ptCurrent).squaredLength()<25&&this._axisTriad.insideOverlay(t.getPosition())){const e=await this._view.pickFromPoint(this._ptFirst,this._pickConfig);await this._axisTriad.onClickSelection(e)}super.onMouseUp(t)}}class X_{constructor(t,e,i,n,r){this.section=t,this.node=e,this.planeIndex=i,this.plane=n,this.selectionPosition=r,this.origPlaneD=n.d}}class J_ extends Mi{constructor(t,e,i){super(t,e),this._context=null,this._cuttingManager=i}async onMouseDown(t){super.onMouseDown(t),this._context===null&&this.isActive()&&this._cuttingManager.hasActiveCuttingSection()&&(await this._startSelection(t),t.setHandled(this._context!==null))}async onMouseMove(t){super.onMouseMove(t);const e=this._context;this.isActive()&&e!==null&&(t.setHandled(!0),await this._updatePlane(t.getPosition(),e,!1),this._viewer.trigger("cuttingPlaneDrag",e.section,e.planeIndex))}async _updatePlane(t,e,i){const n=e.selectionPosition,r=e.plane.normal.copy().add(e.selectionPosition),o=this._view.unprojectPoint(t,0),l=this._view.unprojectPoint(t,.5);if(o!==null&&l!==null){const h=Qd(n,r,o,l);if(h!==null){const u=_.subtract(h,e.selectionPosition),d=_.dot(u,e.plane.normal)<0?u.length():-u.length();e.plane.d=e.origPlaneD+d;const g=e.plane.normal.copy().scale(-d),y=new _t().setTranslationComponent(g.x,g.y,g.z);await e.section.updatePlane(e.planeIndex,e.plane,y,i,!1)}this._cuttingManager.delayCapping()}}async onMouseUp(t){const e=this._context;this.isActive()&&e!==null&&(t.setHandled(!0),await this._updatePlane(t.getPosition(),e,!0),this._viewer.trigger("cuttingPlaneDragEnd",e.section,e.planeIndex)),this._context=null,super.onMouseUp(t)}setHandled(){return this.isActive()&&this._context!==null}async _startSelection(t){this._context=null;const e=t.getPosition(),i=xe.Face|xe.Line,n=new yi(i);n.ignoreCappingGeometry=!0,n.forceEffectiveSceneVisibilityMask=xe.Face;const o=(await this._view.compositePickFromPoint(e,n)).fetchMostRelevant(i);if(o===null)return;const l=o.getNodeId(),h=this._cuttingManager.getCuttingSectionFromNodeId(l);if(h!==null){const u=h.getPlaneIndexByNodeId(l);this._context=new X_(h,l,u,h.getPlane(u),o.getPosition()),this._cuttingManager.delayCapping(),this._viewer.trigger("cuttingPlaneDragStart",h,u)}}}class Y_ extends Mi{constructor(t,e){super(t,e),this._draggingAvatar=!1,this._restrictToAvatar=!0,this._floorLocked=!1,this._manager=e.floorplanManager}async onMouseDown(t){if(super.onMouseDown(t),!this._manager.isActive())return;const e=t.getPosition();let i;if(!this._restrictToAvatar)i=this._manager.insideOverlay(e);else{const n=new yi;n.restrictToOverlays=!0,i=(await this._view.pickFromPoint(e,n)).getNodeId()===this._manager.getAvatarNodeId()}i&&(this._draggingAvatar=!0,this._floorLocked=this._manager.getFloorLock(),await this._manager.setFloorLock(!0),this._manager.snapAvatarToPoint(e),t.setHandled(!0))}async onMouseUp(t){super.onMouseUp(t),this._draggingAvatar&&await this._manager.setFloorLock(this._floorLocked),this._draggingAvatar=!1}onMouseMove(t){if(super.onMouseMove(t),!!this._manager.isActive()&&this._draggingAvatar){t.setHandled(!0);const e=t.getPosition();this._manager.insideOverlay(e)&&this._manager.snapAvatarToPoint(e)}}restrictToAvatar(t){this._restrictToAvatar=t}}class Z_ extends Mi{constructor(t,e){super(t,e),this._draggingHandle=!1,this._newRotationMatrix=new _t,this._translation=_.zero(),this._newTranslation=_.zero(),this._nodeIdGroupMap=new Map,this._groupIdCount=0,this._activeChildrenGroupIds=new Map,this._initialLocalNodeMatrices=[],this._newLocalNodeMatrices=[],this._trackedPoints=[],this._trackedPointsPositions=[],this._trackedPointCount=0,this._previousContextClick=!1,this._overlayIndex=null,this._activeHandleNodeId=null,this._handleEventType=ao.Translate,this._highlightedHandleId=null,this._handleSize=1,this._explodeActive=!1,this._measureActive=!1,this._settingMatrixInProgress=!1,this._handleMarkup=new ch(t),this._pickConfig=new yi(xe.Face),this._pickConfig.restrictToOverlays=!0,t.setCallbacks({explode:i=>{this._explodeActive=i>0,this._explodeActive&&this.removeHandles()},measurementBegin:()=>{this._measureActive=!0,this.removeHandles()},measurementCreated:()=>{this._measureActive=!1},measurementDeleted:()=>{this._measureActive=!1}})}setAxisMeshData(t){return this._handleMarkup.setAxisMeshData(t)}setPlaneMeshData(t){return this._handleMarkup.setPlaneMeshData(t)}setViewPlaneMeshData(t){return this._handleMarkup.setViewPlaneMeshData(t)}setRotateMeshData(t){return this._handleMarkup.setRotateMeshData(t)}addTrackedPoint(t){const e=this._trackedPointCount;return this._trackedPoints[e]=t.copy(),this._trackedPointsPositions[e]=t.copy(),++this._trackedPointCount,e}getTrackedPoints(){return this._trackedPointsPositions}clearTrackedPoints(){this._trackedPoints.length=0,this._trackedPointsPositions.length=0,this._trackedPointCount=0}isEnabled(){return!this._explodeActive&&!this._measureActive&&!this._viewer.sheetManager.isDrawingSheetActive()}_guardEnabled(){if(!this.isEnabled()){const t=this._explodeActive?"Handles are not enabled when the model is exploded":this._measureActive?"Handles are not enabled while a measurement is in progress.":this._viewer.sheetManager.isDrawingSheetActive()?"Handles are not enabled for 2d drawings.":"Handles are not enabled.";throw new ae(t)}}setHandleSize(t){this._handleSize=t}async addHandles(t,e=null,i=null){if(this._previousContextClick=!1,this._guardEnabled(),!e){const r=await this._viewer.model.getNodesBounding(t);return this.addHandles(t,r.center())}const n=this._findGroupId(t);return i===null&&(i=n!==null?n:this.generateGroupId()),this._nodeIdGroupMap.set(i,t),n!==null&&await this._handleMarkup.removeHandles(i),this._handleMarkup.addHandles(e,this._handleSize,i)}_findGroupId(t){let e=null;return this._nodeIdGroupMap.forEach((i,n)=>{i.length===t.length&&i.every(r=>t.indexOf(r)!==-1)&&(e=n)}),e}generateGroupId(){return this._groupIdCount++}_massageGroupId(t){return t??ch.defaultGroupId}async addAxisTranslationHandle(t,e,i,n=null,r=null){return this._previousContextClick=!1,this._guardEnabled(),this._handleMarkup.addAxisTranslationHandle(t,e,i,n,this._massageGroupId(r))}async addAxisRotationHandle(t,e,i,n=null,r=null){return this._previousContextClick=!1,this._guardEnabled(),this._handleMarkup.addRotateHandle(t,e,i,n,this._massageGroupId(r))}async addPlaneTranslationHandle(t,e,i,n,r=null,o=null){return this._previousContextClick=!1,this._guardEnabled(),this._handleMarkup.addPlaneTranslationHandle(t,e,i,n,r,this._massageGroupId(o))}async addViewPlaneTranslationHandle(t,e,i=null){return this._previousContextClick=!1,this._guardEnabled(),this._handleMarkup.addViewPlaneHandle(t,e,this._massageGroupId(i))}setNodeIds(t,e=null){this._nodeIdGroupMap.set(this._massageGroupId(e),t)}getNodeIds(t=null){const e=this._nodeIdGroupMap.get(this._massageGroupId(t));return e===void 0?[]:e.slice()}showHandles(){this._handleMarkup.showOverlay()}updatePosition(t,e,i,n=null){return this._handleMarkup.updatePosition(t,e,i,this._massageGroupId(n),this._activeChildrenGroupIds)}getPosition(){const t=this._handleMarkup.getHandleNodeIds();if(t.length>0){const e=this._handleMarkup.getPosition(t[0]);if(e!==null)return e.copy()}return null}removeHandles(){return this._newRotationMatrix=new _t,this._translation=_.zero(),this._highlightedHandleId=null,this._nodeIdGroupMap.clear(),this._groupIdCount=0,this._handleMarkup.removeHandles()}getTranslation(){return this._translation}_initLocalNodeMatrices(t){const e=this._viewer.model;this._initialLocalNodeMatrices=[];for(const i of t)this._initialLocalNodeMatrices.push(e.getNodeMatrix(i))}_getHandleEventType(t){return this._handleMarkup.getHandleType(t)===dr.Rotate?ao.Rotate:ao.Translate}async _rotate(t,e,i,n){if(!this._draggingHandle||this._settingMatrixInProgress)return;const r=this.getNodeIds(n);await this._genericTransform(t,e,_.zero(),i,r,n),this._viewer.trigger("handleEvent",ao.Rotate,r,this._initialLocalNodeMatrices,this._newLocalNodeMatrices)}async _translate(t,e,i){if(!this._draggingHandle||this._settingMatrixInProgress)return;const n=this.getNodeIds(i);await this._genericTransform(_.zero(),0,t,e,n,i),this._viewer.trigger("handleEvent",ao.Translate,n,this._initialLocalNodeMatrices,this._newLocalNodeMatrices)}async _genericTransform(t,e,i,n,r,o){this._settingMatrixInProgress=!0;const l=this._viewer.model;let h=new _t;this._newTranslation=i,t.squaredLength()>0&&(h=this._getRotationMatrix(t,_.zero(),e),this._newRotationMatrix=h.copy());const u=[];u.push(this.updatePosition(this._newTranslation,this._newRotationMatrix,!1,o)),this._newLocalNodeMatrices=[];for(let g=0;g<r.length;g++){const y=this._newTranslation.copy(),m=r[g];let I=this._initialLocalNodeMatrices[g].copy();const b=t.copy(),x=n.copy();let C;const P=l.getNodeParent(m);if(P!==null){C=l.getNodeNetMatrix(P);const k=_t.inverse(C);k!==null&&(k.transform(x,x),k.setTranslationComponent(0,0,0),k.transform(b,b),k.transform(y,y))}else C=null;t.squaredLength()>0&&(h=this._getRotationMatrix(b,x,C&&C.upperLeft3x3Determinant()<0?-e:e),I=_t.multiply(I,h)),I.setTranslationComponent(I.m[12]+y.x,I.m[13]+y.y,I.m[14]+y.z),u.push(l.setNodeMatrix(m,I)),this._newLocalNodeMatrices.push(I)}const d=this._newRotationMatrix.copy();d.setTranslationComponent(i.x,i.y,i.z);for(let g=0;g<this._trackedPoints.length;++g){const y=this._trackedPoints[g].copy(),m=_.subtract(y,n);d.transform(m,m);const I=_.add(m,n);this._trackedPointsPositions[g]=I}await Ue(u),this._settingMatrixInProgress=!1}async _testRotate(t,e,i=null){i=this._massageGroupId(i);const n=this._getActiveNodeIdByGroupId(i);if(n!==null){const r=this._handleMarkup.getPosition(n);if(r===null)return;this._startDragging(n,ao.Rotate),await this._rotate(t,e,r,i),await this._stopDragging()}}async _testTranslate(t,e=null){e=this._massageGroupId(e);const i=this._getActiveNodeIdByGroupId(e);i!==null&&(this._startDragging(i,ao.Translate),await this._translate(t,_.zero(),e),await this._stopDragging())}_getActiveNodeIdByGroupId(t){const e=this._handleMarkup.getHandleNodeIds();for(let i=0;i<e.length;++i){const n=e[i];if(this._handleMarkup.getHandleGroupId(n)===t)return n}return null}_startDragging(t,e){this._activeHandleNodeId=t,this._handleEventType=e;const i=this._handleMarkup.getHandleGroupId(t),n=this.getNodeIds(i),r=new Map;this._nodeIdGroupMap.forEach((o,l)=>{l!==i&&o.forEach(h=>{let u=this._viewer.model.getNodeParent(h);for(;u!==null;){if(n.indexOf(u)!==-1){r.set(l,h);break}u=this._viewer.model.getNodeParent(u)}})}),this._activeChildrenGroupIds=r,n.length>0&&(this._initLocalNodeMatrices(n),this._viewer.trigger("handleEventStart",this._handleEventType,n,this._initialLocalNodeMatrices),this._draggingHandle=!0)}async _stopDragging(){if(this._draggingHandle=!1,this._activeHandleNodeId!==null){const t=this._handleMarkup.getHandleGroupId(this._activeHandleNodeId);await this.updatePosition(this._newTranslation,this._newRotationMatrix,!0,t);const e=this.getNodeIds(t);this._activeHandleNodeId=null,this._activeChildrenGroupIds.clear(),this._viewer.trigger("handleEventEnd",this._handleEventType,e,this._initialLocalNodeMatrices,this._newLocalNodeMatrices),this._newRotationMatrix=new _t,this._handleMarkup.resetTranslation(),this._translation.add(this._newTranslation),this._newTranslation=_.zero(),this._trackedPoints=this._trackedPointsPositions.slice()}}async onMouseDown(t){super.onMouseDown(t),this._overlayIndex=null;const e=await this._view.pickFromPoint(t.getPosition(),this._pickConfig);if(e.isNodeEntitySelection()){const i=e.getNodeId(),n=this._viewer.model.getNodeName(i);if(n!==null&&n.slice(0,7)==="handle-"){t.setHandled(!0);const r=this._getHandleEventType(i);this._startDragging(i,r)}}}_onHandleDrag(){if(this._activeHandleNodeId===null)return;const e=this._view.getCamera();let i=0,n=_.zero(),r=_.zero();const o=this._handleMarkup.getHandleType(this._activeHandleNodeId),l=this._handleMarkup.getVector(this._activeHandleNodeId),h=this._handleMarkup.getPosition(this._activeHandleNodeId);if(o===null||h===null)return;const u=this._handleMarkup.getHandleGroupId(this._activeHandleNodeId);switch(o){case dr.Axis:l!==null&&(r=this._getTranslationComponent(h,l,0,u),this._translate(r,h,u));break;case dr.Plane:l!==null&&(r=this._getTranslationComponent(h,l,1,u),this._translate(r,h,u));break;case dr.ViewPlane:{const d=e.getTarget(),g=e.getPosition(),y=_.subtract(g,d).normalize();r=this._getTranslationComponent(h,y,2,u),this._translate(r,h,u)}break;case dr.Rotate:l!==null&&(n=l,this._handleMarkup.getGroupIdRotationMatrix(u).copy().setTranslationComponent(0,0,0).transform(n,n),i=this._getRotationAngle(h,n),this._rotate(n,i,h,u));break;default:Tr()}}async onMouseMove(t){if(super.onMouseMove(t),this._draggingHandle&&this._activeHandleNodeId!==null)this._onHandleDrag();else{const e=await this._view.pickFromPoint(t.getPosition(),this._pickConfig);await this._highlightHandle(e)}}onMouseUp(t){!this._draggingHandle&&this._dragCount<3&&t.getButton()!==Me.Right&&!this._previousContextClick&&!this._viewer.getContextMenuStatus()&&(this._overlayIndex===0||this._overlayIndex===null)&&this.removeHandles(),this._previousContextClick=t.getButton()===Me.Right||this._viewer.getContextMenuStatus(),this._draggingHandle&&this._stopDragging(),super.onMouseUp(t)}setHandled(){return this._draggingHandle}_getClosestPoint(t,e,i){const n=t.copy(),r=t.copy().add(e),o=this._view.unprojectPoint(i,0),l=this._view.unprojectPoint(i,.5);return o!==null&&l!==null?Qd(n,r,o,l):null}_getTranslationComponent(t,e,i,n){i!==2&&this._handleMarkup.getGroupIdRotationMatrix(n).copy().setTranslationComponent(0,0,0).transform(e,e);let r=null,o=null;return i===1||i===2?(r=this._getPlaneIntersectionPoint(t,e,this._ptFirst),r!==null&&(o=this._getPlaneIntersectionPoint(r,e,this._ptCurrent))):i===0&&(r=this._getClosestPoint(t,e,this._ptFirst),r!==null&&(o=this._getClosestPoint(r,e,this._ptCurrent))),o!==null&&r!==null?_.subtract(o,r):_.zero()}async _clearHighlightedHandle(){this._highlightedHandleId!==null&&(await this._viewer.model.unsetNodesFaceColor([this._highlightedHandleId]),this._highlightedHandleId=null)}async _highlightHandle(t){if(t.isNodeEntitySelection()&&t.overlayIndex()===ye.Handles){const e=this._viewer.model,i=e.getNodeName(t.getNodeId());if(i!==null&&i.slice(0,7)==="handle-"){const n=t.getNodeId();if(this._highlightedHandleId===n)return;await this._clearHighlightedHandle(),this._highlightedHandleId=n,e.setNodesFaceColor([this._highlightedHandleId],vt.green());return}}return this._clearHighlightedHandle()}_getPlaneIntersectionPoint(t,e,i){const n=this._view.unprojectPoint(i,0),r=this._view.unprojectPoint(i,.5);if(n===null||r===null)return null;const o=new Ws(n,r.copy().subtract(n)),l=Ki.createFromPointAndNormal(t,e),h=_.zero();return l.intersectsRay(o,h)?h:null}_getRotationAngle(t,e){console.assert(t!==null);const i=this._getPlaneIntersectionPoint(t,e,this._ptFirst),n=this._getPlaneIntersectionPoint(t,e,this._ptCurrent);if(i===null||n===null)return 0;const r=_.subtract(i,t).normalize(),o=_.subtract(n,t).normalize(),l=_.dot(r,o);let h=Math.acos(l)*180/Math.PI;return _.dot(_.cross(r,o),e)<0&&(h=-h),h}_getRotationMatrix(t,e,i){const n=new _t().setTranslationComponent(-e.x,-e.y,-e.z),r=_t.createFromOffAxisRotation(t,i),o=new _t().setTranslationComponent(e.x,e.y,e.z);return _t.multiply(_t.multiply(n,r),o)}}class Q_ extends Mi{constructor(t,e){super(t,e),this._navCube=e.getNavCube(),this._pickConfig=new yi(xe.Face),this._pickConfig.restrictToOverlays=!0}async onMouseMove(t){if(super.onMouseMove(t),!this._navCube.getEnabled()||this._dragging&&this._dragCount>1)return;const e=t.getPosition();if(this._navCube.insideOverlay(e)){const i=await this._view.pickFromPoint(e,this._pickConfig);this._navCube.onMoveSelection(i)}}async onMouseUp(t){if(this._navCube.getEnabled()&&K.subtract(this._ptFirst,this._ptCurrent).squaredLength()<25){const e=await this._view.pickFromPoint(this._ptFirst,this._pickConfig);await this._navCube.onClickSelection(e)}super.onMouseUp(t)}}class ty extends Mi{constructor(t,e,i){super(t,e),this._insertNoteButton=Me.Left,this._callbackFlag=!1,this._noteTextManager=i}onMouseDown(t){super.onMouseDown(t),this.isActive()&&(this._callbackFlag||(this._viewer.setCallbacks({explode:async e=>{await this._noteTextManager.explode(e)}}),this._callbackFlag=!0),this._dragging=!1)}onMouseUp(t){if(this.isActive()){const e=new yi(xe.Face);(this._ptFirst.equals(this._ptCurrent)&&t.getButton()===this._insertNoteButton||this._primaryTouchId!==null)&&this._view.pickFromPoint(t.getPosition(),e).then(i=>{if(!this._noteTextManager.selectPin(i)&&!this._noteTextManager.getExplodeActive()&&!this._noteTextManager.getIsolateActive()&&i.overlayIndex()===0){if(i.isFaceSelection())return new Ia(this._viewer,this._noteTextManager,i.getPosition(),i.getFaceEntity().getNormal(),i.getNodeId());t.setHandled(!0)}return null})}super.onMouseUp(t)}getNoteTextElement(){return this._noteTextManager.getNoteTextElement()}setNoteTextElement(t){this._noteTextManager.setNoteTextElement(t)}checkPinInstance(t){return this._noteTextManager.checkPinInstance(t)!==null}}class ey extends Mi{constructor(t,e){super(t,e),this._selectionButton=Me.Left,this._ignoreTransparency=!1,this._forceEffectiveSceneVisibilityMask=xe.None,this._incrementalSelection=nh.create("SelectionManager",t),t.setCallbacks({_resetAssemblyTreeBegin:async()=>(await this.clearSelection(),this.waitForIdle()),selectionArray:i=>{i.length===0&&this._incrementalSelection.stopSelection()}})}getForceEffectiveSceneVisibilityMask(){return this._forceEffectiveSceneVisibilityMask}setForceEffectiveSceneVisibilityMask(t){this._forceEffectiveSceneVisibilityMask=t}setIgnoreTransparency(t){this._ignoreTransparency=t}getIgnoreTransparency(){return this._ignoreTransparency}hasActiveSelection(){return!this._incrementalSelection.isIdle()}async waitForIdle(){return this._incrementalSelection.waitForIdle()}async clearSelection(){return this._incrementalSelection.clearSelection()}_createBeginConfig(t){const e=new Yc;return e.forceEffectiveSceneVisibilityMask=this._forceEffectiveSceneVisibilityMask,e.ignoreUnrequestedInstances=!0,{pickConfig:e,rayCssOrigin:t,rayCssBoxRadius:10}}async _selectionPredicate(t){const e=this._viewer.model,i=t.getNodeId();if(i===null)return!1;const[n]=await e.getNodesHaveTransparency([i]);return!n}async _performSelection(t){const e=this._createBeginConfig(t),i=this._ignoreTransparency?n=>this._selectionPredicate(n):null;return this._incrementalSelection.performSelection(e,i)}setHandled(){return!0}onKeyUp(t){t.getKeyCode()===Je.Escape&&this.clearSelection()}onMouseUp(t){this.isActive()&&(async()=>(t.getButton()===this._selectionButton||this._primaryTouchId!==null)&&K.subtract(this._ptFirst,this._ptCurrent).squaredLength()<25&&(t.controlDown()||await this.clearSelection(),await this._performSelection(t.getPosition())))(),super.onMouseUp(t)}}class iy extends Mi{constructor(t,e,i){super(t,e),this._selectionButton=Me.Left,this._pickConfig=new yi(xe.Face|xe.Line),this._forceEffectiveSceneVisibilityMask=null,this._doubleClickFitWorld=!0,this._noteTextManager=i}setPickConfig(t){this._pickConfig=t.copy()}getPickConfig(){return this._pickConfig.copy()}getSelectionButton(){return this._selectionButton}setSelectionButton(t){this._selectionButton=t}onKeyUp(t){t.getKeyCode()===Je.Escape&&this._viewer.selectionManager.clear()}onMouseUp(t){if(this.isActive()&&K.subtract(this._ptFirst,this._ptCurrent).length()<5&&(t.getButton()===this._selectionButton||this._primaryTouchId!==null)){const i=this._view;let n=this._pickConfig;this._forceEffectiveSceneVisibilityMask!==null&&(n=n.copy(),n.forceEffectiveSceneVisibilityMask=this._forceEffectiveSceneVisibilityMask),i.pickFromPoint(this._ptCurrent,n).then(r=>{const l=this._viewer.cuttingManager.getCuttingSectionFromNodeId(r.getNodeId())!==null,h=this._noteTextManager.selectPin(r),u=this._viewer.markupManager.pickMarkupItem(this._ptCurrent,this._view);u instanceof Fo&&this._viewer.markupManager.selectMarkup(u,i),!h&&!l&&u===null&&(r.isNodeSelection()?this._processSelectionClick(t,r):this._isDoubleClick||this._viewer.selectionManager.clear())})}super.onMouseUp(t)}async onDoubleClick(){if(this._doubleClickFitWorld)return this._view.fitWorld()}setDoubleClickFitWorldEnabled(t){this._doubleClickFitWorld=t}_getSelectionOrParentIfSelected(t){const e=this._viewer.selectionManager;if(!e.getSelectParentIfSelected())return t;const i=this._viewer.model,n=t.getNodeId();if(!i.isNodeLoaded(n)||i.getNodeType(n)===Ne.PmiBody)return t;const o=e.containsParent(t);if(o!==null){const l=wi.create(i.getNodeParent(o.getNodeId()));return l.isNodeSelection()?l:t}else if(e.contains(t)){const l=wi.create(i.getNodeParent(n));return l.isNodeSelection()?l:t}else return t}_processSelectionClick(t,e){const i=e.overlayIndex();if(i!==0&&i!==null)return;const n=this._viewer.selectionManager;if(t.controlDown()||t.commandDown())n.toggle(e);else{const r=this._getSelectionOrParentIfSelected(e);n.set(r)}}}window.eval(`/**
* @license 3DconnexionJS
*
* Copyright (c) 2013-2022 3Dconnexion. All rights reserved.
* License:
*   This file is licensed under the terms of the "3Dconnexion
*   Software Development Kit" license agreement:
*   http://www.3dconnexion.com/service/software-developer/licence-agreement.html
*   All rights not expressly granted by 3Dconnexion are reserved.
*
* $Revision$
*/
var when,CryptoJS,AUTOBAHNJS_VERSION,global;_3Dconnexion=function(n){"use strict";this.version="0.7.0";this.client=n;this.session=null;this.defport=8181;this.connected=!1;this.connexion=null;this._3dcontroller=null;this.viewport=null;this.host="127.51.68.120";this.nlRpcUri=null;this.nlResourceUri=null;this._EVENT_TYPEID_RPC=0;this.V3DK_FIT=31;this.V3DK_MENU=30;this.fnUpdate={motion:this.onMotion.bind(this),"events.keyPress":this.onKeyPress.bind(this),"events.keyRelease":this.onKeyRelease.bind(this)};this.clientFnRead={"view.affine":n.getViewMatrix,"view.constructionPlane":n.getConstructionPlane,"view.extents":n.getViewExtents,"view.fov":n.getFov,"view.frustum":n.getViewFrustum,"view.perspective":n.getPerspective,"view.target":n.getViewTarget,"view.rotatable":n.getViewRotatable,"model.extents":n.getModelExtents,"model.floorPlane":n.getFloorPlane,"model.unitsToMeters":n.getUnitsToMeters,"pivot.position":n.getPivotPosition,"hit.lookat":n.getLookAt,"selection.affine":n.getSelectionAffine,"selection.empty":n.getSelectionEmpty,"selection.extents":n.getSelectionExtents,"pointer.position":n.getPointerPosition,coordinateSystem:n.getCoordinateSystem,"views.front":n.getFrontView,"frame.timingSource":n.getFrameTimingSource,"frame.time":n.getFrameTime};this.clientFnUpdate={motion:n.setMoving,transaction:n.setTransaction,"view.affine":n.setViewMatrix,"view.extents":n.setViewExtents,"view.fov":n.setFov,"view.target":n.setTarget,"commands.activeCommand":n.setActiveCommand,"pivot.position":n.setPivotPosition,"pivot.visible":n.setPivotVisible,"hit.lookfrom":n.setLookFrom,"hit.direction":n.setLookDirection,"hit.aperture":n.setLookAperture,"hit.selectionOnly":n.setSelectionOnly,"selection.affine":n.setSelectionAffine,"events.keyPress":n.setKeyPress,"events.keyRelease":n.setKeyRelease,"settings.changed":n.setSettingsChanged};this.debug=!1;window.hasOwnProperty("_3DCONNEXION_DEBUG")&&(this.debug=window._3DCONNEXION_DEBUG);this.blur=this.blur.bind(this);this.focus=this.focus.bind(this)};typeof module=="object"&&(module.exports=_3Dconnexion);_3Dconnexion.prototype={constructor:_3Dconnexion};Object.freeze(_3Dconnexion.nlOptions={none:0,rowMajorOrder:2});_3Dconnexion.prototype.connect=function(){"use strict";var n=this,e=this.client,u=1,t=new XMLHttpRequest,f,r,i;if(!e.onConnect)throw"onConnect handler required!";i="https://"+n.host+":"+n.defport+"/3dconnexion/nlproxy";t.onreadystatechange=function(){if(t.readyState===4&&t.status===200){n.debug&&console.log(t.responseText);n.nlRpcUri="wss://"+n.host+"/3dconnexion#";n.nlResourceUri="wss://"+n.host+"/3dconnexion";try{f=JSON.parse(t.responseText).port;r="wss://"+n.host+":"+f;n.debug&&console.log("Connecting to "+r+" ...");window.hasOwnProperty("AUTOBAHN_DEBUG")&&window.AUTOBAHN_DEBUG&&window.ab.debug(!0,!0,!0);window.ab.connect(r,function(t){n.session=t;n.connected=!0;n.debug&&console.log("Connected!");t.prefix("3dx_rpc",n.nlRpcUri);t.prefix("3dconnexion",n.nlResourceUri);t.prefix("self",window.location.href);n.client.onConnect()},function(t,i){if(n.client.onDisconnect!==undefined)n.client.onDisconnect(i);n.delete3dmouse();n.connected=!1;n.session=null;n.debug&&console.log("Socket closed!",i)},{maxRetries:3,retryDelay:500})}catch(i){console.error(i)}}};t.onerror=function(){n.debug&&console.log("_3Dconnexion.connect: No response from local 3dmouse server "+i)};t.ontimeout=function(){n.debug&&console.log("_3Dconnexion.connect: Timeout querying local 3dmouse server "+i)};try{t.open("GET",i,!0);t.setRequestHeader("Accept","application/json; charset=utf-8");t.msCaching="disabled";t.timeout=0;t.send()}catch(o){u=0;console.error(o.toString())}return u};_3Dconnexion.prototype.create3dmouse=function(n,t,i){"use strict";i=typeof i!="undefined"?i:_3Dconnexion.nlOptions.none;var r=this;r.viewport=n;r.debug&&console.log("create3dmouse "+r.viewport.id);r.viewport.addEventListener("focus",r.focus);r.viewport.addEventListener("blur",r.blur);r.session.call("3dx_rpc:create","3dconnexion:3dmouse",r.version).then(function(n){r.connexion=n.connexion;var u={version:parseFloat(r.version),name:t,rowMajorOrder:(i&_3Dconnexion.nlOptions.rowMajorOrder)!=0};r.session.call("3dx_rpc:create","3dconnexion:3dcontroller",r.connexion,u).then(function(n){r._3dcontroller=n.instance;r.session.subscribe("3dconnexion:3dcontroller/"+r._3dcontroller,r.onEvent.bind(r));document.hasFocus()&&(document.activeElement===document.body||document.activeElement===null?(r.viewport.focus(),window===r.viewport&&r.focus()):r.viewport.contains(document.activeElement)&&(r.focus(),r.debug&&console.log("self.viewport has focus")));r.client.on3dmouseCreated&&r.client.on3dmouseCreated()},function(n){console.log("3dx_rpc:create 3dconnexion:3dcontroller "+n)})},function(n){console.log("3dx_rpc:create "+n)})};_3Dconnexion.prototype.blur=function(){"use strict";var n=this;n.debug&&console.log("blur on ");n.session&&n._3dcontroller&&n.update3dcontroller({focus:!1})};_3Dconnexion.prototype.focus=function(){"use strict";var n=this;n.debug&&console.log("focus on ");n.session&&n._3dcontroller&&n.update3dcontroller({focus:!0})};_3Dconnexion.prototype.onKeyPress=function(n){"use strict";var t=this;t.debug&&console.log("onKeyPress "+n)};_3Dconnexion.prototype.onKeyRelease=function(n){"use strict";var t=this;t.debug&&console.log("onKeyRelease "+n)};_3Dconnexion.prototype.onMotion=function(n){"use strict";var t=this;n===!0?t.client.onStartMotion!==undefined&&t.client.onStartMotion():t.client.onStopMotion!==undefined&&t.client.onStopMotion()};_3Dconnexion.prototype.onEvent=function(n,t){"use strict";var i=this,f=null,r=null,u=null;if(i.debug&&(console.log(n),console.log(t)),t[0]===window.ab._MESSAGE_TYPEID_CALL){if(t[2]==="self:read")if(r=i.clientFnRead[t[4]],r!==undefined)f=r.bind(i.client)();else{u=[window.ab._MESSAGE_TYPEID_CALL_ERROR,t[1],t[2]+"#generic",t[4]+" unknown property"];i.session._send(u);return}else if(t[2]==="self:update")if(r=i.fnUpdate[t[4]],r!==undefined)f=r(t[5]);else if(r=i.clientFnUpdate[t[4]],r!==undefined)f=r.bind(i.client)(t[5]);else{u=[window.ab._MESSAGE_TYPEID_CALL_ERROR,t[1],t[2]+"#generic",t[4]+" unknown property"];i.session._send(u);return}else{u=[window.ab._MESSAGE_TYPEID_CALL_ERROR,t[1],t[2]+"#generic","unknown procedure"];i.session._send(u);return}u=[window.ab._MESSAGE_TYPEID_CALL_RESULT,t[1],f];i.session._send(u)}};_3Dconnexion.prototype.read3dcontroller=function(n,t){"use strict";var i=this;i.debug&&console.log("read3dcontroller "+i._3dcontroller);try{i.session.call("3dx_rpc:read","3dconnexion:3dcontroller/"+i._3dcontroller,n).then(function(n){t&&t(n)},function(t){console.log("3dx_rpc:read 3dconnexion:3dcontroller/"+i._3dcontroller+" "+n+" "+t)})}catch(r){console.error(r)}};_3Dconnexion.prototype.update3dcontroller=function(n){"use strict";var t=this;t.debug&&console.log("update3dmouse "+t._3dcontroller);try{if(!t._3dcontroller)throw"exception 3dx_rpc:update: 3dcontroller not initialized";t.session.call("3dx_rpc:update","3dconnexion:3dcontroller/"+t._3dcontroller,n).then(function(){return},function(n){console.log("3dx_rpc:update 3dconnexion:3dcontroller/"+t._3dcontroller+" "+n)})}catch(i){console.error(i)}};_3Dconnexion.prototype.delete3dmouse=function(){"use strict";var n=this,t=n.connexion;n.debug&&console.log("delete3dmouse ");n.connexion=null;n._3dcontroller=null;n.viewport!==null&&(n.viewport.removeEventListener("focus",n.focus),n.viewport.removeEventListener("blur",n.blur));n.session&&n.session.call("3dx_rpc:delete","3dconnexion:3dmouse/"+t).then(function(){n.debug&&console.log("deleted connexion "+t)},function(n){console.log("3dx_rpc:delete "+t+" "+n)})};Object.freeze(_3Dconnexion.SiActionNodeType_t={SI_ACTIONSET_NODE:0,SI_CATEGORY_NODE:1,SI_ACTION_NODE:2});_3Dconnexion.ActionNode=function(n,t,i){return this.id=n,this.label=t||n,this.type=i,this};_3Dconnexion.ActionNode.prototype={constructor:_3Dconnexion.ActionNode,id:{value:null,enumerable:!0},label:{value:null,writable:!0,enumerable:!0},type:{value:null,enumerable:!0}};_3Dconnexion.Action=function(n,t,i){return _3Dconnexion.ActionNode.call(this,n,t,_3Dconnexion.SiActionNodeType_t.SI_ACTION_NODE),this.description=i||"",this};_3Dconnexion.Action.prototype=Object.create(_3Dconnexion.ActionNode.prototype,{constructor:{value:_3Dconnexion.Action},description:{value:"",writable:!0,enumerable:!0}});_3Dconnexion.ActionTreeNode=function(){return this.nodes=[],this};_3Dconnexion.ActionTreeNode.prototype=Object.create(_3Dconnexion.ActionNode.prototype,{constructor:{value:_3Dconnexion.ActionTreeNode},nodes:{value:null,writable:!0,enumerable:!0},push:{value:function(n){return this.nodes.push(n),n}}});_3Dconnexion.ActionSet=function(n,t){return _3Dconnexion.ActionNode.call(this,n,t,_3Dconnexion.SiActionNodeType_t.SI_ACTIONSET_NODE),_3Dconnexion.ActionTreeNode.call(this),this};_3Dconnexion.ActionSet.prototype=Object.create(_3Dconnexion.ActionTreeNode.prototype,{constructor:{value:_3Dconnexion.ActionSet}});_3Dconnexion.Category=function(n,t){return _3Dconnexion.ActionNode.call(this,n,t,_3Dconnexion.SiActionNodeType_t.SI_CATEGORY_NODE),_3Dconnexion.ActionTreeNode.call(this),this};_3Dconnexion.Category.prototype=Object.create(_3Dconnexion.ActionTreeNode.prototype,{constructor:{value:_3Dconnexion.Category}});_3Dconnexion.ActionTree=function(){return this.nodes=[],this};_3Dconnexion.ActionTree.prototype=Object.create(null,{constructor:{value:_3Dconnexion.ActionTree},nodes:{value:null,writable:!0,enumerable:!0},push:{value:function(n){return this.nodes.push(n),n}}});_3Dconnexion.ImageItem=function(){};Object.freeze(_3Dconnexion.SiImageType_t={e_none:0,e_image_file:1,e_resource_file:2,e_image:3});_3Dconnexion.ImageItem.prototype={constructor:_3Dconnexion.ImageItem,id:{value:"",writable:!0},type:{value:"e_none",enumerable:!0}};_3Dconnexion.ImageItem.fromImage=function(n,t){var i=new _3Dconnexion.ImageItem;return Object.defineProperties(i,{id:{value:t||"",writable:!0,enumerable:!0},type:{value:_3Dconnexion.SiImageType_t.e_image,enumerable:!0},index:{value:0,writable:!0,enumerable:!0},data:{value:_3Dconnexion.ImageItem.base64FromArrayBuffer(n),enumerable:!0},status:{value:200}})};_3Dconnexion.ImageItem.fromURL=function(n,t){var r=new _3Dconnexion.ImageItem,i;return Object.defineProperties(r,{id:{value:t||"",writable:!0,enumerable:!0},type:{value:_3Dconnexion.SiImageType_t.e_image,enumerable:!0},index:{value:0,writable:!0,enumerable:!0},buffer:{value:null,writable:!0},data:{get:function(){return this.buffer},set:function(n){r.buffer=n;r.onload()},enumerable:!0},status:{value:100,writable:!0},onload:{value:function(){},writable:!0}}),i=new XMLHttpRequest,i.overrideMimeType("text/plain; charset=x-user-defined"),i.open("GET",n,!0),i.responseType="arraybuffer",i.onload=function(){if(r.status=i.status,i.status===200&&i.response!==null){r.data=_3Dconnexion.ImageItem.base64FromArrayBuffer(i.response);return}r.status=404;r.data=null},i.onerror=function(){r.status=i.status;r.data=null},i.send(null),r};_3Dconnexion.ImageItem.base64FromArrayBuffer=function(n){for(var u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=new Uint8Array(n),e=t.length%3,f=t.length-e,i="",r=0;r<f;r+=3)i+=u[t[r]>>2],i+=u[(t[r]&3)<<4|t[r+1]>>4],i+=u[(t[r+1]&15)<<2|t[r+2]>>6],i+=u[t[r+2]&63];return e!==0&&(i+=u[t[f]>>2],e===2?(i+=u[(t[f]&3)<<4|t[f+1]>>4],i+=u[(t[f+1]&15)<<2],i+="="):(i+=u[(t[f]&3)<<4],i+="==")),i};_3Dconnexion.ImageCache=function(){this.images=[];this.outstanding_requests=0};_3Dconnexion.ImageCache.prototype={constructor:_3Dconnexion.ImageCache,images:{value:null,writable:!0,enumerable:!0},outstanding_requests:{value:0,writable:!0},push:function(n){var t=this;if(n.status===100)++t.outstanding_requests,n.onload=function(){var n=this,i;n.onload=function(){};n.status!==200&&(i=t.images.indexOf(n),i>-1&&t.images.splice(i,1));--t.outstanding_requests;t.outstanding_requests===0&&t.onload()}.bind(n);else if(n.data===null)return;t.images.push(n)},onload:function(){}};
/** @license AutobahnJS - http://autobahn.ws
 *
 * Copyright (C) 2011-2014 Tavendo GmbH.
 * Licensed under the MIT License.
 * See license text at http://www.opensource.org/licenses/mit-license.php
 *
 * AutobahnJS includes code from:
 *
 * when - http://cujojs.com
 *
 * (c) copyright B Cavalier & J Hann
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * Crypto-JS - http://code.google.com/p/crypto-js/
 *
 * (c) 2009-2012 by Jeff Mott. All rights reserved.
 * Licensed under the New BSD License at:
 * http://code.google.com/p/crypto-js/wiki/License
 * 
 * console-normalizer - https://github.com/Zenovations/console-normalizer
 *
 * (c) 2012 by Zenovations.
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 * 
 */
(function(n){n||(n=window.console={log:function(){},info:function(){},warn:function(){},error:function(){}});Function.prototype.bind||(Function.prototype.bind=function(n){var t=this,i=Array.prototype.slice.call(arguments,1);return function(){return t.apply(n,Array.prototype.concat.apply(i,arguments))}});typeof n.log=="object"&&(n.log=Function.prototype.call.bind(n.log,n),n.info=Function.prototype.call.bind(n.info,n),n.warn=Function.prototype.call.bind(n.warn,n),n.error=Function.prototype.call.bind(n.error,n));"group"in n||(n.group=function(t){n.info("\\n--- "+t+" ---\\n")});"groupEnd"in n||(n.groupEnd=function(){n.log("\\n")});"time"in n||function(){var t={};n.time=function(n){t[n]=(new Date).getTime()};n.timeEnd=function(i){var r=(new Date).getTime(),u=i in t?r-t[i]:0;n.info(i+": "+u+"ms")}}()})(window.console);
/** @license MIT License (c) copyright 2011-2013 original author or authors */
when=function(n){"use strict";function t(n,t,i,r){return at(n).then(t,i,r)}function e(n){return new f(n,h.PromiseStatus&&h.PromiseStatus())}function f(n,t){function c(){return f?f.inspect():ii()}function l(n,t,r,u,e){function o(i){i._when(n,t,r,u,e)}i?i.push(o):y(function(){o(f)})}function o(n){if(i){var r=i;i=u;y(function(){f=pt(e,n);t&&bt(f,t);w(r,f)})}}function s(n){o(new r(n))}function a(n){if(i){var t=i;y(function(){w(t,new b(n))})}}var e,f,i=[];e=this;this._status=t;this.inspect=c;this._when=l;try{n(o,s,a)}catch(h){s(h)}}function at(n){return n instanceof f?n:o(n)}function o(n){return e(function(t){t(n)})}function vt(n){return t(n,function(n){return new r(n)})}function yt(){function f(u,f,e){n.resolve=n.resolver.resolve=function(n){return t?o(n):(t=!0,u(n),i)};n.reject=n.resolver.reject=function(n){return t?o(new r(n)):(t=!0,f(n),i)};n.notify=n.resolver.notify=function(n){return e(n),n}}var n,i,t;return n={promise:u,resolve:u,reject:u,notify:u,resolver:{resolve:u,reject:u,notify:u}},n.promise=i=e(f),n}function w(n,t){for(var i=0;i<n.length;i++)n[i](t)}function pt(n,t){if(t===n)return new r(new TypeError);if(t instanceof f)return t;try{var i=t===Object(t)&&t.then;return typeof i=="function"?wt(i,t):new c(t)}catch(u){return new r(u)}}function wt(n,t){return e(function(i,r){d(n,t,i,r)})}function c(n){this.value=n}function r(n){this.value=n}function b(n){this.value=n}function bt(n,t){function i(){t.fulfilled()}function r(n){t.rejected(n)}n.then(i,r)}function rt(n){return n&&typeof n.then=="function"}function ut(n,i,r,u,f){return t(n,function(n){function o(r,u,f){function y(n){c(n)}function w(n){h(n)}var o,v,s,a,h,c,l,e;if(l=n.length>>>0,o=Math.max(0,Math.min(i,l)),s=[],v=l-o+1,a=[],o)for(c=function(n){a.push(n);--v||(h=c=p,u(a))},h=function(n){s.push(n);--o||(h=c=p,r(s))},e=0;e<l;++e)e in n&&t(n[e],w,y,f);else r(s)}return e(o).then(r,u,f)})}function kt(n,t,i,r){function u(n){return t?t(n[0]):n[0]}return ut(n,1,u,i,r)}function ft(n,t,i,r){return l(n,p).then(t,i,r)}function dt(){return l(arguments,p)}function gt(n){return l(n,et,ot)}function ni(n,t){return l(n,t)}function l(n,i,r){return t(n,function(n){function u(u,f,e){function l(n,o){t(n,i,r).then(function(n){s[o]=n;--h||u(s)},f,e)}var s,c,h,o;if(h=c=n.length>>>0,s=[],!h){u(s);return}for(o=0;o<c;o++)o in n?l(n[o],o):--h}return new f(u)})}function ti(n,i){var r=d(k,arguments,1);return t(n,function(n){var u;return u=n.length,r[0]=function(n,r,f){return t(n,function(n){return t(r,function(t){return i(n,t,f,u)})})},st.apply(n,r)})}function et(n){return{state:"fulfilled",value:n}}function ot(n){return{state:"rejected",reason:n}}function ii(){return{state:"pending"}}function y(n){v.push(n)===1&&s(lt)}function lt(){w(v);v=[]}function p(n){return n}function ri(n){typeof h.reportUnhandled=="function"?h.reportUnhandled():y(function(){throw n;});throw n;}t.promise=e;t.resolve=o;t.reject=vt;t.defer=yt;t.join=dt;t.all=ft;t.map=ni;t.reduce=ti;t.settle=gt;t.any=kt;t.some=ut;t.isPromise=rt;t.isPromiseLike=rt;i=f.prototype;i.then=function(n,t,i){var r=this;return new f(function(u,f,e){r._when(u,e,n,t,i)},this._status&&this._status.observed())};i["catch"]=i.otherwise=function(n){return this.then(u,n)};i["finally"]=i.ensure=function(n){function t(){return o(n())}return typeof n=="function"?this.then(t,t)["yield"](this):this};i.done=function(n,t){this.then(n,t)["catch"](ri)};i["yield"]=function(n){return this.then(function(){return n})};i.tap=function(n){return this.then(n)["yield"](this)};i.spread=function(n){return this.then(function(t){return ft(t,function(t){return n.apply(u,t)})})};i.always=function(n,t){return this.then(n,n,t)};a=Object.create||function(n){function t(){}return t.prototype=n,new t};c.prototype=a(i);c.prototype.inspect=function(){return et(this.value)};c.prototype._when=function(n,t,i){try{n(typeof i=="function"?i(this.value):this.value)}catch(u){n(new r(u))}};r.prototype=a(i);r.prototype.inspect=function(){return ot(this.value)};r.prototype._when=function(n,t,i,u){try{n(typeof u=="function"?u(this.value):this)}catch(f){n(new r(f))}};b.prototype=a(i);b.prototype._when=function(n,t,i,r,u){try{t(typeof u=="function"?u(this.value):this.value)}catch(f){t(f)}};var i,a,st,k,d,s,v,g,nt,tt,h,ht,it,ct,u;if(it=n,v=[],h=typeof console!="undefined"?console:t,typeof process=="object"&&process.nextTick)s=process.nextTick;else if(ct=typeof MutationObserver=="function"&&MutationObserver||typeof WebKitMutationObserver=="function"&&WebKitMutationObserver)s=function(n,t,i){var r=n.createElement("div");return new t(i).observe(r,{attributes:!0}),function(){r.setAttribute("x","x")}}(document,ct,lt);else try{s=it("vertx").runOnLoop||it("vertx").runOnContext}catch(ui){ht=setTimeout;s=function(n){ht(n,0)}}return g=Function.prototype,nt=g.call,d=g.bind?nt.bind(nt):function(n,t){return n.apply(t,k.call(arguments,2))},tt=[],k=tt.slice,st=tt.reduce||function(n){var i,u,r,f,t;if(t=0,i=Object(this),f=i.length>>>0,u=arguments,u.length<=1)for(;;){if(t in i){r=i[t++];break}if(++t>=f)throw new TypeError;}else r=u[1];for(;t<f;++t)t in i&&(r=n(r,i[t],t,i));return r},t}();CryptoJS=CryptoJS||function(n,t){var u={},f=u.lib={},i=f.Base=function(){function n(){}return{extend:function(t){n.prototype=this;var i=new n;return t&&i.mixIn(t),i.hasOwnProperty("init")||(i.init=function(){i.$super.init.apply(this,arguments)}),i.init.prototype=i,i.$super=this,i},create:function(){var n=this.extend();return n.init.apply(n,arguments),n},init:function(){},mixIn:function(n){for(var t in n)n.hasOwnProperty(t)&&(this[t]=n[t]);n.hasOwnProperty("toString")&&(this.toString=n.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),r=f.WordArray=i.extend({init:function(n,i){n=this.words=n||[];this.sigBytes=i!=t?i:n.length*4},toString:function(n){return(n||h).stringify(this)},concat:function(n){var i=this.words,r=n.words,u=this.sigBytes,f=n.sigBytes,e,t;if(this.clamp(),u%4)for(t=0;t<f;t++)e=r[t>>>2]>>>24-t%4*8&255,i[u+t>>>2]|=e<<24-(u+t)%4*8;else if(r.length>65535)for(t=0;t<f;t+=4)i[u+t>>>2]=r[t>>>2];else i.push.apply(i,r);return this.sigBytes+=f,this},clamp:function(){var i=this.words,t=this.sigBytes;i[t>>>2]&=4294967295<<32-t%4*8;i.length=n.ceil(t/4)},clone:function(){var n=i.clone.call(this);return n.words=this.words.slice(0),n},random:function(t){for(var i=[],u=0;u<t;u+=4)i.push(n.random()*4294967296|0);return new r.init(i,t)}}),e=u.enc={},h=e.Hex={stringify:function(n){for(var r,u=n.words,f=n.sigBytes,i=[],t=0;t<f;t++)r=u[t>>>2]>>>24-t%4*8&255,i.push((r>>>4).toString(16)),i.push((r&15).toString(16));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t+=2)u[t>>>3]|=parseInt(n.substr(t,2),16)<<24-t%8*4;return new r.init(u,i/2)}},o=e.Latin1={stringify:function(n){for(var r,u=n.words,f=n.sigBytes,i=[],t=0;t<f;t++)r=u[t>>>2]>>>24-t%4*8&255,i.push(String.fromCharCode(r));return i.join("")},parse:function(n){for(var i=n.length,u=[],t=0;t<i;t++)u[t>>>2]|=(n.charCodeAt(t)&255)<<24-t%4*8;return new r.init(u,i)}},c=e.Utf8={stringify:function(n){try{return decodeURIComponent(escape(o.stringify(n)))}catch(t){throw new Error("Malformed UTF-8 data");}},parse:function(n){return o.parse(unescape(encodeURIComponent(n)))}},s=f.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new r.init;this._nDataBytes=0},_append:function(n){typeof n=="string"&&(n=c.parse(n));this._data.concat(n);this._nDataBytes+=n.sigBytes},_process:function(t){var e=this._data,h=e.words,c=e.sigBytes,o=this.blockSize,a=o*4,u=c/a,i,s,f,l;if(u=t?n.ceil(u):n.max((u|0)-this._minBufferSize,0),i=u*o,s=n.min(i*4,c),i){for(f=0;f<i;f+=o)this._doProcessBlock(h,f);l=h.splice(0,i);e.sigBytes-=s}return new r.init(l,s)},clone:function(){var n=i.clone.call(this);return n._data=this._data.clone(),n},_minBufferSize:0}),a=f.Hasher=s.extend({cfg:i.extend(),init:function(n){this.cfg=this.cfg.extend(n);this.reset()},reset:function(){s.reset.call(this);this._doReset()},update:function(n){return this._append(n),this._process(),this},finalize:function(n){n&&this._append(n);return this._doFinalize()},blockSize:16,_createHelper:function(n){return function(t,i){return new n.init(i).finalize(t)}},_createHmacHelper:function(n){return function(t,i){return new l.HMAC.init(n,i).finalize(t)}}}),l=u.algo={};return u}(Math),function(){var n=CryptoJS,t=n.lib,i=t.WordArray,r=n.enc,u=r.Base64={stringify:function(n){var u=n.words,e=n.sigBytes,o=this._map,i,t,r,f;for(n.clamp(),i=[],t=0;t<e;t+=3){var s=u[t>>>2]>>>24-t%4*8&255,h=u[t+1>>>2]>>>24-(t+1)%4*8&255,c=u[t+2>>>2]>>>24-(t+2)%4*8&255,l=s<<16|h<<8|c;for(r=0;r<4&&t+r*.75<e;r++)i.push(o.charAt(l>>>6*(3-r)&63))}if(f=o.charAt(64),f)while(i.length%4)i.push(f);return i.join("")},parse:function(n){var o=n.length,u=this._map,s=u.charAt(64),f,e,r,t,h,c;for(s&&(f=n.indexOf(s),f!=-1&&(o=f)),e=[],r=0,t=0;t<o;t++)t%4&&(h=u.indexOf(n.charAt(t-1))<<t%4*2,c=u.indexOf(n.charAt(t))>>>6-t%4*2,e[r>>>2]|=(h|c)<<24-r%4*8,r++);return i.create(e,r)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(){var n=CryptoJS,t=n.lib,i=t.Base,r=n.enc,u=r.Utf8,f=n.algo,e=f.HMAC=i.extend({init:function(n,t){var r,f,i;n=this._hasher=new n.init;typeof t=="string"&&(t=u.parse(t));r=n.blockSize;f=r*4;t.sigBytes>f&&(t=n.finalize(t));t.clamp();var e=this._oKey=t.clone(),o=this._iKey=t.clone(),s=e.words,h=o.words;for(i=0;i<r;i++)s[i]^=1549556828,h[i]^=909522486;e.sigBytes=o.sigBytes=f;this.reset()},reset:function(){var n=this._hasher;n.reset();n.update(this._iKey)},update:function(n){return this._hasher.update(n),this},finalize:function(n){var t=this._hasher,i=t.finalize(n);return t.reset(),t.finalize(this._oKey.clone().concat(i))}})}(),function(n){var i=CryptoJS,f=i.lib,s=f.WordArray,r=f.Hasher,h=i.algo,e=[],o=[],t,u;(function(){function u(t){for(var r=n.sqrt(t),i=2;i<=r;i++)if(!(t%i))return!1;return!0}function r(n){return(n-(n|0))*4294967296|0}for(var i=2,t=0;t<64;)u(i)&&(t<8&&(e[t]=r(n.pow(i,1/2))),o[t]=r(n.pow(i,1/3)),t++),i++})();t=[];u=h.SHA256=r.extend({_doReset:function(){this._hash=new s.init(e.slice(0))},_doProcessBlock:function(n,i){for(var r=this._hash.words,f=r[0],s=r[1],h=r[2],y=r[3],e=r[4],a=r[5],v=r[6],p=r[7],u=0;u<64;u++){if(u<16)t[u]=n[i+u]|0;else{var c=t[u-15],b=(c<<25|c>>>7)^(c<<14|c>>>18)^c>>>3,l=t[u-2],k=(l<<15|l>>>17)^(l<<13|l>>>19)^l>>>10;t[u]=b+t[u-7]+k+t[u-16]}var d=e&a^~e&v,g=f&s^f&h^s&h,nt=(f<<30|f>>>2)^(f<<19|f>>>13)^(f<<10|f>>>22),tt=(e<<26|e>>>6)^(e<<21|e>>>11)^(e<<7|e>>>25),w=p+tt+d+o[u]+t[u],it=nt+g;p=v;v=a;a=e;e=y+w|0;y=h;h=s;s=f;f=w+it|0}r[0]=r[0]+f|0;r[1]=r[1]+s|0;r[2]=r[2]+h|0;r[3]=r[3]+y|0;r[4]=r[4]+e|0;r[5]=r[5]+a|0;r[6]=r[6]+v|0;r[7]=r[7]+p|0},_doFinalize:function(){var r=this._data,t=r.words,u=this._nDataBytes*8,i=r.sigBytes*8;return t[i>>>5]|=128<<24-i%32,t[(i+64>>>9<<4)+14]=n.floor(u/4294967296),t[(i+64>>>9<<4)+15]=u,r.sigBytes=t.length*4,this._process(),this._hash},clone:function(){var n=r.clone.call(this);return n._hash=this._hash.clone(),n}});i.SHA256=r._createHelper(u);i.HmacSHA256=r._createHmacHelper(u)}(Math),function(){var n=CryptoJS,i=n.lib,r=i.Base,u=i.WordArray,t=n.algo,f=t.SHA1,e=t.HMAC,o=t.PBKDF2=r.extend({cfg:r.extend({keySize:4,hasher:f,iterations:1}),init:function(n){this.cfg=this.cfg.extend(n)},compute:function(n,t){for(var s=this.cfg,r=e.create(s.hasher,n),f=u.create(),l=u.create([1]),p=f.words,w=l.words,a=s.keySize,b=s.iterations,o,c,y,i;p.length<a;){o=r.update(t).finalize(l);r.reset();var v=o.words,k=v.length,h=o;for(c=1;c<b;c++)for(h=r.finalize(h),r.reset(),y=h.words,i=0;i<k;i++)v[i]^=y[i];f.concat(o);w[0]++}return f.sigBytes=a*4,f}});n.PBKDF2=function(n,t,i){return o.create(i).compute(n,t)}}();
/** @license MIT License (c) 2011-2013 Copyright Tavendo GmbH. */
AUTOBAHNJS_VERSION="0.8.2.1";global=this,function(n,t){n.ab=t(n,n.when)}(global,function(n,t){"use strict";var i={};return i._version=AUTOBAHNJS_VERSION,function(){Array.prototype.indexOf||(Array.prototype.indexOf=function(n){var u,r,t,i;if(this===null)throw new TypeError;if((u=new Object(this),r=u.length>>>0,r===0)||(t=0,arguments.length>0&&(t=Number(arguments[1]),t!==t?t=0:t!==0&&t!==Infinity&&t!==-Infinity&&(t=(t>0||-1)*Math.floor(Math.abs(t)))),t>=r))return-1;for(i=t>=0?t:Math.max(r-Math.abs(t),0);i<r;i++)if(i in u&&u[i]===n)return i;return-1});Array.prototype.forEach||(Array.prototype.forEach=function(n,t){var u,i,r,f,e;if(this===null)throw new TypeError(" this is null or not defined");if(r=new Object(this),f=r.length>>>0,{}.toString.call(n)!=="[object Function]")throw new TypeError(n+" is not a function");for(t&&(u=t),i=0;i<f;)i in r&&(e=r[i],n.call(u,e,i,r)),i++})}(),i._sliceUserAgent=function(n,t,i){var s=[],r=navigator.userAgent,h=r.indexOf(n),f=r.indexOf(t,h),e,o,u;for(f<0&&(f=r.length),e=r.slice(h,f).split(i),o=e[1].split("."),u=0;u<o.length;++u)s.push(parseInt(o[u],10));return{name:e[0],version:s}},i.getBrowser=function(){var n=navigator.userAgent;return n.indexOf("Chrome")>-1?i._sliceUserAgent("Chrome"," ","/"):n.indexOf("Safari")>-1?i._sliceUserAgent("Safari"," ","/"):n.indexOf("Firefox")>-1?i._sliceUserAgent("Firefox"," ","/"):n.indexOf("MSIE")>-1?i._sliceUserAgent("MSIE",";"," "):null},i.getServerUrl=function(t,i){if(n.location.protocol==="file:")return i?i:"ws://127.0.0.1/ws";var r=n.location.protocol==="https:"?"wss://":"ws://",u=n.location.port!==""?":"+n.location.port:"",f=t?t:"ws";return r+n.location.hostname+u+"/"+f},i.browserNotSupportedMessage="Browser does not support WebSockets (RFC6455)",i.deriveKey=function(n,t){if(t&&t.salt){var i=t.salt,r=t.keylen||32,u=t.iterations||1e4,f=CryptoJS.PBKDF2(n,i,{keySize:r/4,iterations:u,hasher:CryptoJS.algo.SHA256});return f.toString(CryptoJS.enc.Base64)}return n},i._idchars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i._idlen=16,i._subprotocol="wamp",i._newid=function(){for(var n="",t=0;t<i._idlen;t+=1)n+=i._idchars.charAt(Math.floor(Math.random()*i._idchars.length));return n},i._newidFast=function(){return Math.random().toString(36)},i.log=function(){if(arguments.length>1){console.group("Log Item");for(var n=0;n<arguments.length;n+=1)console.log(arguments[n]);console.groupEnd()}else console.log(arguments[0])},i._debugrpc=!1,i._debugpubsub=!1,i._debugws=!1,i._debugconnect=!1,i.debug=function(t,r,u){if("console"in n)i._debugrpc=t,i._debugpubsub=t,i._debugws=r,i._debugconnect=u;else throw"browser does not support console object";},i.version=function(){return i._version},i.PrefixMap=function(){var n=this;n._index={};n._rindex={}},i.PrefixMap.prototype.get=function(n){var t=this;return t._index[n]},i.PrefixMap.prototype.set=function(n,t){var i=this;i._index[n]=t;i._rindex[t]=n},i.PrefixMap.prototype.setDefault=function(n){var t=this;t._index[""]=n;t._rindex[n]=""},i.PrefixMap.prototype.remove=function(n){var t=this,i=t._index[n];i&&(delete t._index[n],delete t._rindex[i])},i.PrefixMap.prototype.resolve=function(n,t){var u=this,i=n.indexOf(":"),r;return i>=0&&(r=n.substring(0,i),u._index[r])?u._index[r]+n.substring(i+1):t===!0?n:null},i.PrefixMap.prototype.shrink=function(n,t){for(var u,r,f=this,i=n.length;i>0;i-=1)if(u=n.substring(0,i),r=f._rindex[u],r)return r+":"+n.substring(i);return t===!0?n:null},i._MESSAGE_TYPEID_WELCOME=0,i._MESSAGE_TYPEID_PREFIX=1,i._MESSAGE_TYPEID_CALL=2,i._MESSAGE_TYPEID_CALL_RESULT=3,i._MESSAGE_TYPEID_CALL_ERROR=4,i._MESSAGE_TYPEID_SUBSCRIBE=5,i._MESSAGE_TYPEID_UNSUBSCRIBE=6,i._MESSAGE_TYPEID_PUBLISH=7,i._MESSAGE_TYPEID_EVENT=8,i.CONNECTION_CLOSED=0,i.CONNECTION_LOST=1,i.CONNECTION_RETRIES_EXCEEDED=2,i.CONNECTION_UNREACHABLE=3,i.CONNECTION_UNSUPPORTED=4,i.CONNECTION_UNREACHABLE_SCHEDULED_RECONNECT=5,i.CONNECTION_LOST_SCHEDULED_RECONNECT=6,i.Deferred=t.defer,i._construct=function(t,i){return"WebSocket"in n?i?new WebSocket(t,i):new WebSocket(t):"MozWebSocket"in n?i?new MozWebSocket(t,i):new MozWebSocket(t):null},i.Session=function(n,t,r,u){var f=this;if(f._wsuri=n,f._options=u,f._websocket_onopen=t,f._websocket_onclose=r,f._websocket=null,f._websocket_connected=!1,f._session_id=null,f._wamp_version=null,f._server=null,f._calls={},f._subscriptions={},f._prefixes=new i.PrefixMap,f._txcnt=0,f._rxcnt=0,f._websocket=f._options&&f._options.skipSubprotocolAnnounce?i._construct(f._wsuri):i._construct(f._wsuri,[i._subprotocol]),!f._websocket){if(r!==undefined){r(i.CONNECTION_UNSUPPORTED);return}throw i.browserNotSupportedMessage;}f._websocket.onmessage=function(n){var t,r,h,e,c,s,v,y,p,w;if(i._debugws&&(f._rxcnt+=1,console.group("WS Receive"),console.info(f._wsuri+"  ["+f._session_id+"]"),console.log(f._rxcnt),console.log(n.data),console.groupEnd()),t=JSON.parse(n.data),t[1]in f._calls){if(t[0]===i._MESSAGE_TYPEID_CALL_RESULT){if(r=f._calls[t[1]],h=t[2],i._debugrpc&&r._ab_callobj!==undefined){for(console.group("WAMP Call",r._ab_callobj[2]),console.timeEnd(r._ab_tid),console.group("Arguments"),e=3;e<r._ab_callobj.length;e+=1)if(c=r._ab_callobj[e],c!==undefined)console.log(c);else break;console.groupEnd();console.group("Result");console.log(h);console.groupEnd();console.groupEnd()}r.resolve(h)}else if(t[0]===i._MESSAGE_TYPEID_CALL_ERROR){var u=f._calls[t[1]],l=t[2],a=t[3],o=t[4];if(i._debugrpc&&u._ab_callobj!==undefined){for(console.group("WAMP Call",u._ab_callobj[2]),console.timeEnd(u._ab_tid),console.group("Arguments"),s=3;s<u._ab_callobj.length;s+=1)if(v=u._ab_callobj[s],v!==undefined)console.log(v);else break;console.groupEnd();console.group("Error");console.log(l);console.log(a);o!==undefined&&console.log(o);console.groupEnd();console.groupEnd()}o!==undefined?u.reject({uri:l,desc:a,detail:o}):u.reject({uri:l,desc:a})}delete f._calls[t[1]]}else if(t[0]===i._MESSAGE_TYPEID_EVENT)y=f._prefixes.resolve(t[1],!0),y in f._subscriptions&&(p=t[1],w=t[2],i._debugpubsub&&(console.group("WAMP Event"),console.info(f._wsuri+"  ["+f._session_id+"]"),console.log(p),console.log(w),console.groupEnd()),f._subscriptions[y].forEach(function(n){n(p,w)}));else if(t[0]===i._MESSAGE_TYPEID_WELCOME)if(f._session_id===null)f._session_id=t[1],f._wamp_version=t[2],f._server=t[3],(i._debugrpc||i._debugpubsub)&&(console.group("WAMP Welcome"),console.info(f._wsuri+"  ["+f._session_id+"]"),console.log(f._wamp_version),console.log(f._server),console.groupEnd()),f._websocket_onopen!==null&&f._websocket_onopen();else throw"protocol error (welcome message received more than once)";};f._websocket.onopen=function(){if(f._websocket.protocol!==i._subprotocol)if(typeof f._websocket.protocol=="undefined")i._debugws&&(console.group("WS Warning"),console.info(f._wsuri),console.log("WebSocket object has no protocol attribute: WAMP subprotocol check skipped!"),console.groupEnd());else if(f._options&&f._options.skipSubprotocolCheck)i._debugws&&(console.group("WS Warning"),console.info(f._wsuri),console.log("Server does not speak WAMP, but subprotocol check disabled by option!"),console.log(f._websocket.protocol),console.groupEnd());else{f._websocket.close(1e3,"server does not speak WAMP");throw"server does not speak WAMP (but '"+f._websocket.protocol+"' !)";}i._debugws&&(console.group("WAMP Connect"),console.info(f._wsuri),console.log(f._websocket.protocol),console.groupEnd());f._websocket_connected=!0};f._websocket.onerror=function(){};f._websocket.onclose=function(n){i._debugws&&(f._websocket_connected?console.log("Autobahn connection to "+f._wsuri+" lost (code "+n.code+", reason '"+n.reason+"', wasClean "+n.wasClean+")."):console.log("Autobahn could not connect to "+f._wsuri+" (code "+n.code+", reason '"+n.reason+"', wasClean "+n.wasClean+")."));f._websocket_onclose!==undefined&&(f._websocket_connected?n.wasClean?f._websocket_onclose(i.CONNECTION_CLOSED,"WS-"+n.code+": "+n.reason):f._websocket_onclose(i.CONNECTION_LOST):f._websocket_onclose(i.CONNECTION_UNREACHABLE));f._websocket_connected=!1;f._wsuri=null;f._websocket_onopen=null;f._websocket_onclose=null;f._websocket=null};f.log=function(){f._options&&"sessionIdent"in f._options?console.group("WAMP Session '"+f._options.sessionIdent+"' ["+f._session_id+"]"):console.group("WAMP Session ["+f._session_id+"]");for(var n=0;n<arguments.length;++n)console.log(arguments[n]);console.groupEnd()}},i.Session.prototype._send=function(t){var r=this,u;if(!r._websocket_connected)throw"Autobahn not connected";switch(!0){case n.Prototype&&typeof top.root.__prototype_deleted=="undefined":case typeof t.toJSON=="function":u=t.toJSON();break;default:u=JSON.stringify(t)}r._websocket.send(u);r._txcnt+=1;i._debugws&&(console.group("WS Send"),console.info(r._wsuri+"  ["+r._session_id+"]"),console.log(r._txcnt),console.log(u),console.groupEnd())},i.Session.prototype.close=function(){var n=this;n._websocket_connected&&n._websocket.close()},i.Session.prototype.sessionid=function(){var n=this;return n._session_id},i.Session.prototype.wsuri=function(){var n=this;return n._wsuri},i.Session.prototype.shrink=function(n,t){var i=this;return t===undefined&&(t=!0),i._prefixes.shrink(n,t)},i.Session.prototype.resolve=function(n,t){var i=this;return t===undefined&&(t=!0),i._prefixes.resolve(n,t)},i.Session.prototype.prefix=function(n,t){var r=this,u;r._prefixes.set(n,t);(i._debugrpc||i._debugpubsub)&&(console.group("WAMP Prefix"),console.info(r._wsuri+"  ["+r._session_id+"]"),console.log(n),console.log(t),console.groupEnd());u=[i._MESSAGE_TYPEID_PREFIX,n,t];r._send(u)},i.Session.prototype.call=function(){for(var t=this,n=new i.Deferred,r,e,u,f;;)if(r=i._newidFast(),!(r in t._calls))break;for(t._calls[r]=n,e=t._prefixes.shrink(arguments[0],!0),u=[i._MESSAGE_TYPEID_CALL,r,e],f=1;f<arguments.length;f+=1)u.push(arguments[f]);return t._send(u),i._debugrpc&&(n._ab_callobj=u,n._ab_tid=t._wsuri+"  ["+t._session_id+"]["+r+"]",console.time(n._ab_tid),console.info()),n.promise.then?n.promise:n},i.Session.prototype.subscribe=function(n,t){var r=this,u=r._prefixes.resolve(n,!0),f,e;if(u in r._subscriptions||(i._debugpubsub&&(console.group("WAMP Subscribe"),console.info(r._wsuri+"  ["+r._session_id+"]"),console.log(n),console.log(t),console.groupEnd()),f=[i._MESSAGE_TYPEID_SUBSCRIBE,n],r._send(f),r._subscriptions[u]=[]),e=r._subscriptions[u].indexOf(t),e===-1)r._subscriptions[u].push(t);else throw"callback "+t+" already subscribed for topic "+u;},i.Session.prototype.unsubscribe=function(n,t){var r=this,u=r._prefixes.resolve(n,!0),f,e,o;if(u in r._subscriptions){if(t!==undefined)if(e=r._subscriptions[u].indexOf(t),e!==-1)f=t,r._subscriptions[u].splice(e,1);else throw"no callback "+t+" subscribed on topic "+u;else f=r._subscriptions[u].slice(),r._subscriptions[u]=[];r._subscriptions[u].length===0&&(delete r._subscriptions[u],i._debugpubsub&&(console.group("WAMP Unsubscribe"),console.info(r._wsuri+"  ["+r._session_id+"]"),console.log(n),console.log(f),console.groupEnd()),o=[i._MESSAGE_TYPEID_UNSUBSCRIBE,n],r._send(o))}else throw"not subscribed to topic "+u;},i.Session.prototype.publish=function(){var o=this,t=arguments[0],r=arguments[1],f=null,n=null,e=null,u=null;if(arguments.length>3){if(!(arguments[2]instanceof Array))throw"invalid argument type(s)";if(!(arguments[3]instanceof Array))throw"invalid argument type(s)";n=arguments[2];e=arguments[3];u=[i._MESSAGE_TYPEID_PUBLISH,t,r,n,e]}else if(arguments.length>2)if(typeof arguments[2]=="boolean")f=arguments[2],u=[i._MESSAGE_TYPEID_PUBLISH,t,r,f];else if(arguments[2]instanceof Array)n=arguments[2],u=[i._MESSAGE_TYPEID_PUBLISH,t,r,n];else throw"invalid argument type(s)";else u=[i._MESSAGE_TYPEID_PUBLISH,t,r];i._debugpubsub&&(console.group("WAMP Publish"),console.info(o._wsuri+"  ["+o._session_id+"]"),console.log(t),console.log(r),f!==null?console.log(f):n!==null&&(console.log(n),e!==null&&console.log(e)),console.groupEnd());o._send(u)},i.Session.prototype.authreq=function(n,t){return this.call("http://api.wamp.ws/procedure#authreq",n,t)},i.Session.prototype.authsign=function(n,t){return t||(t=""),CryptoJS.HmacSHA256(n,t).toString(CryptoJS.enc.Base64)},i.Session.prototype.auth=function(n){return this.call("http://api.wamp.ws/procedure#auth",n)},i._connect=function(t){var r=new i.Session(t.wsuri,function(){t.connects+=1;t.retryCount=0;t.onConnect(r)},function(r,u){var f=null;switch(r){case i.CONNECTION_CLOSED:t.onHangup(r,"Connection was closed properly ["+u+"]");break;case i.CONNECTION_UNSUPPORTED:t.onHangup(r,"Browser does not support WebSocket.");break;case i.CONNECTION_UNREACHABLE:if(t.retryCount+=1,t.connects===0)t.onHangup(r,"Connection could not be established.");else if(t.retryCount<=t.options.maxRetries)if(f=t.onHangup(i.CONNECTION_UNREACHABLE_SCHEDULED_RECONNECT,"Connection unreachable - scheduled reconnect to occur in "+t.options.retryDelay/1e3+" second(s) - attempt "+t.retryCount+" of "+t.options.maxRetries+".",{delay:t.options.retryDelay,retries:t.retryCount,maxretries:t.options.maxRetries}),f){i._debugconnect&&console.log("Connection unreachable - retrying stopped by app");t.onHangup(i.CONNECTION_RETRIES_EXCEEDED,"Number of connection retries exceeded.")}else i._debugconnect&&console.log("Connection unreachable - retrying ("+t.retryCount+") .."),n.setTimeout(function(){i._connect(t)},t.options.retryDelay);else t.onHangup(i.CONNECTION_RETRIES_EXCEEDED,"Number of connection retries exceeded.");break;case i.CONNECTION_LOST:if(t.retryCount+=1,t.retryCount<=t.options.maxRetries)if(f=t.onHangup(i.CONNECTION_LOST_SCHEDULED_RECONNECT,"Connection lost - scheduled "+t.retryCount+"th reconnect to occur in "+t.options.retryDelay/1e3+" second(s).",{delay:t.options.retryDelay,retries:t.retryCount,maxretries:t.options.maxRetries}),f){i._debugconnect&&console.log("Connection lost - retrying stopped by app");t.onHangup(i.CONNECTION_RETRIES_EXCEEDED,"Connection lost.")}else i._debugconnect&&console.log("Connection lost - retrying ("+t.retryCount+") .."),n.setTimeout(function(){i._connect(t)},t.options.retryDelay);else t.onHangup(i.CONNECTION_RETRIES_EXCEEDED,"Connection lost.");break;default:throw"unhandled close code in ab._connect";}},t.options)},i.connect=function(n,t,r,u){var f={};if(f.wsuri=n,f.options=u?u:{},f.options.retryDelay===undefined&&(f.options.retryDelay=5e3),f.options.maxRetries===undefined&&(f.options.maxRetries=10),f.options.skipSubprotocolCheck===undefined&&(f.options.skipSubprotocolCheck=!1),f.options.skipSubprotocolAnnounce===undefined&&(f.options.skipSubprotocolAnnounce=!1),t)f.onConnect=t;else throw"onConnect handler required!";f.onHangup=r?r:function(n,t,r){i._debugconnect&&console.log(n,t,r)};f.connects=0;f.retryCount=0;i._connect(f)},i.launch=function(n,t,r){i.connect(n.wsuri,function(r){n.appkey&&n.appkey!==""?r.authreq(n.appkey,n.appextra).then(function(u){var f=null,e;typeof n.appsecret=="function"?f=n.appsecret(u):(e=i.deriveKey(n.appsecret,JSON.parse(u).authextra),f=r.authsign(u,e));r.auth(f).then(function(){t?t(r):i._debugconnect&&r.log("Session opened.")},r.log)},r.log):r.authreq().then(function(){r.auth().then(function(){t?t(r):i._debugconnect&&r.log("Session opened.")},r.log)},r.log)},function(n,t,u){r?r(n,t,u):i._debugconnect&&i.log("Session closed.",n,t,u)},n.sessionConfig)},i});ab._UA_FIREFOX=new RegExp(".*Firefox/([0-9+]*).*");ab._UA_CHROME=new RegExp(".*Chrome/([0-9+]*).*");ab._UA_CHROMEFRAME=new RegExp(".*chromeframe/([0-9]*).*");ab._UA_WEBKIT=new RegExp(".*AppleWebKit/([0-9+.]*)w*.*");ab._UA_WEBOS=new RegExp(".*webOS/([0-9+.]*)w*.*");ab._matchRegex=function(n,t){var i=t.exec(n);return i?i[1]:i};ab.lookupWsSupport=function(){var n=navigator.userAgent,t;return n.indexOf("MSIE")>-1?n.indexOf("MSIE 10")>-1?[!0,!0,!0]:n.indexOf("chromeframe")>-1?(t=parseInt(ab._matchRegex(n,ab._UA_CHROMEFRAME)),t>=14)?[!0,!1,!0]:[!1,!1,!1]:n.indexOf("MSIE 8")>-1||n.indexOf("MSIE 9")>-1?[!0,!0,!0]:[!1,!1,!1]:n.indexOf("Firefox")>-1?(t=parseInt(ab._matchRegex(n,ab._UA_FIREFOX)),t)?t>=7?[!0,!1,!0]:t>=3?[!0,!0,!0]:[!1,!1,!0]:[!1,!1,!0]:n.indexOf("Safari")>-1&&n.indexOf("Chrome")==-1?(t=ab._matchRegex(n,ab._UA_WEBKIT),t)?n.indexOf("Windows")>-1&&t=="534+"?[!0,!1,!0]:n.indexOf("Macintosh")>-1&&(t=t.replace("+","").split("."),parseInt(t[0])==535&&parseInt(t[1])>=24||parseInt(t[0])>535)?[!0,!1,!0]:n.indexOf("webOS")>-1?(t=ab._matchRegex(n,ab._UA_WEBOS).split("."),parseInt(t[0])==2)?[!1,!0,!0]:[!1,!1,!1]:[!0,!0,!0]:[!1,!1,!1]:n.indexOf("Chrome")>-1?(t=parseInt(ab._matchRegex(n,ab._UA_CHROME)),t)?t>=14?[!0,!1,!0]:t>=4?[!0,!0,!0]:[!1,!1,!0]:[!1,!1,!1]:n.indexOf("Android")>-1?n.indexOf("Firefox")>-1?[!0,!1,!0]:n.indexOf("CrMo")>-1?[!0,!1,!0]:n.indexOf("Opera")>-1?[!1,!1,!0]:n.indexOf("CrMo")>-1?[!0,!0,!0]:[!1,!1,!1]:n.indexOf("iPhone")>-1||n.indexOf("iPad")>-1||n.indexOf("iPod")>-1?[!1,!1,!0]:[!1,!1,!1]};`);class ny extends Mi{constructor(t,e){super(t,e),this._modelBounding=new on,this._selectionBounding=new on,this._pivot=_.zero(),this._hitRayOrigin=null,this._hitRayDirection=null,this._hitRayAperture=0,this._hitRaySelectionOnly=!1,this._hitRaySelectionItem=null,this._client={onConnect:()=>{if(this._connexion===null)return;const i=this._viewer.getViewElement();i.addEventListener("focusin",()=>{this._connexion!==null&&this._connexion.update3dcontroller({focus:!0})}),i.addEventListener("focusout",()=>{this._connexion!==null&&this._connexion.update3dcontroller({focus:!1})}),this._connexion.create3dmouse(i,"WebViewer")},on3dmouseCreated:()=>{this._3dMouseInitialized=!0,this._connexion!==null&&(this._updateModelBounding(),this._connexion.update3dcontroller({focus:!0}))},onDisconnect:i=>{console.log(`3Dconnexion NL-Server disconnected ${i}`)},getCoordinateSystem:()=>[1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1],getConstructionPlane:()=>{const i=this._viewer.model.getViewAxes().upVector;return[i.x,i.y,i.z,0]},getFov:()=>{const i=this._view.getCamera(),n=i.getHeight()/i.getWidth(),r=i.getWidth()/(2*_.subtract(i.getTarget(),i.getPosition()).length());return 2*Math.atan(r/n)},setFov:i=>{const n=this._view.getCamera(),r=Math.tan(i/2),l=_.subtract(n.getTarget(),n.getPosition()).length()*r,h=n.getHeight()/n.getWidth();n.setWidth(l),n.setHeight(l*h),this._view.setCamera(n)},getPerspective:()=>this._view.getCamera().getProjection()===ti.Perspective,getViewExtents:()=>{const i=this._view.getCamera(),n=i.getPosition(),r=i.getTarget(),o=i.getWidth()/2,l=i.getHeight()/2,h=_.subtract(n,r),u=i.getNearLimit(),d=h.z/u;return[-o,-l,-d,o,l,-u]},setViewExtents:i=>{const n=new K(i[0],i[4]),r=new K(i[3],i[4]),o=new K(i[3],i[1]),l=K.distance(n,r),h=K.distance(r,o),u=this._view.getCamera();u.setWidth(l),u.setHeight(h),this._view.setCamera(u)},getViewFrustum:()=>{const i=this._view.getCamera(),n=i.getHeight(),r=_.subtract(i.getTarget(),i.getPosition()).length(),o=2*Math.atan(n/(2*r)),l=this._view.getCanvasSize().x/this._view.getCanvasSize().y,h=i.getNearLimit(),u=Math.tan(o*.5)*h,d=-u,g=l*d,y=l*u,m=_.distance(i.getPosition(),i.getTarget())/h;return[g,y,d,u,h,m]},getViewMatrix:()=>{const i=this._view.getCamera(),n=i.getUp().normalize(),r=_.subtract(i.getTarget(),i.getPosition()).normalize(),o=_.cross(r,n).normalize(),l=i.getPosition();return[o.x,o.y,o.z,0,n.x,n.y,n.z,0,-r.x,-r.y,-r.z,0,l.x,l.y,l.z,1]},setViewMatrix:i=>{const n=this._view.getCamera(),r=new _(i[4],i[5],i[6]),o=new _(-i[8],-i[9],-i[10]),l=new _(i[12],i[13],i[14]),h=_.subtract(n.getPosition(),n.getTarget()).length(),u=l.copy().add(o.copy().scale(h));n.setTarget(u),n.setPosition(l),n.setUp(r),this._view.setCamera(n)},getViewRotatable:()=>!this._viewer.model.isDrawing(),getFrontView:()=>[0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,1],getPivotPosition:()=>[this._pivot.x,this._pivot.y,this._pivot.z],setPivotPosition:i=>{this._pivot=_.createFromArray(i)},setPivotVisible:i=>{if(this._pivotMarkup.enable(i),i){const n=this._view.projectPoint(this._pivot),r=new K(n.x,n.y);this._pivotMarkup.setPosition(r)}this._viewer.markupManager.refreshMarkup(this._view)},getPointerPosition:()=>{const i=this._view.unprojectPoint(this._ptCurrent,0);return i===null?[0,0,0]:[i.x,i.y,i.z]},getModelExtents:()=>[this._modelBounding.min.x,this._modelBounding.min.y,this._modelBounding.min.z,this._modelBounding.max.x,this._modelBounding.max.y,this._modelBounding.max.z],getFloorPlane:()=>{const i=this._viewer.model.getViewAxes().upVector,n=this._modelBounding.min,r=new _(n.x*i.x,n.y*i.y,n.z*i.z);return[i.x,i.y,i.z,-r.length()]},getUnitsToMeters:()=>.001,setTransaction:i=>{i===0&&this._viewer.redraw()},setLookFrom:i=>{this._hitRayOrigin=_.createFromArray(i),this._updateHitTest()},setLookDirection:i=>{this._hitRayDirection=_.createFromArray(i)},setLookAperture:i=>{this._hitRayAperture=i},setSelectionOnly:i=>{this._hitRaySelectionOnly=i,this._updateHitTest()},getLookAt:()=>{if(this._hitRaySelectionItem===null)return null;const i=this._hitRaySelectionItem.getPosition();return i===null?null:[i.x,i.y,i.z]},getSelectionEmpty:()=>this._viewer.selectionManager.getFirst()===null,getSelectionExtents:()=>[this._selectionBounding.min.x,this._selectionBounding.min.y,this._selectionBounding.min.z,this._selectionBounding.max.x,this._selectionBounding.max.y,this._selectionBounding.max.z]},this._connexion=null,this._3dMouseInitialized=!1,this._pivotMarkup=new cg(t,e),this._viewer.setCallbacks({modelStructureReady:()=>{this._updateModelBounding()},subtreeLoaded:()=>{this._updateModelBounding()},subtreeDeleted:()=>{this._updateModelBounding()},selectionArray:()=>{this._updateSelectionBounding()},frameDrawn:()=>{const i=this._view.projectPoint(this._pivot),n=new K(i.x,i.y);this._pivotMarkup.setPosition(n),this._pivotMarkup.draw()}})}async _updateModelBounding(){if(this._connexion===null||!this._3dMouseInitialized)return;this._modelBounding=await this._viewer.model.getModelBounding(!0,!0);const t=this._modelBounding.center();this._pivot=t,this._connexion.update3dcontroller({model:{extents:[this._modelBounding.min.x,this._modelBounding.min.y,this._modelBounding.min.z,this._modelBounding.max.x,this._modelBounding.max.y,this._modelBounding.max.z]}})}async _updateSelectionBounding(){if(this._connexion===null||!this._3dMouseInitialized)return;const t=this._viewer.selectionManager.getResults().map(e=>e.getNodeId());if(t.length===0){this._selectionBounding=new on;return}this._selectionBounding=await this._viewer.model.getNodesBounding(t)}async _updateHitTest(){this._hitRayAperture;const t=this._viewer;if(this._hitRayOrigin===null||this._hitRayDirection===null)return;const e=new Ws(this._hitRayOrigin,this._hitRayDirection),i=new yi,n=await this._view.pickFromRay(e,i),r=n.getNodeId();if(r===ku){this._hitRaySelectionItem=null;return}if(this._hitRaySelectionOnly&&!t.selectionManager.isNodeSelected(r)){this._hitRaySelectionItem=null;return}this._hitRaySelectionItem=n}connect(){this._connexion=new _3Dconnexion(this._client),this._connexion.connect()}}const jb=Object.freeze(Object.defineProperty({__proto__:null,AreaSelectionOperator:q_,AxisTriadOperator:K_,ButtonModifier:ng,Camera:Fb,CuttingPlaneOperator:J_,CuttingPlaneOperatorContext:X_,FloorplanOperator:Y_,HandleOperator:Z_,Markup:Hb,Measure:Bb,NavCubeOperator:Q_,NoteOperator:ty,OperatorBase:Mi,RayDrillSelectionOperator:ey,Redline:Ub,SelectionOperator:iy,SelectionRectangleMarkup:ag,SpaceMouseOperator:ny},Symbol.toStringTag,{value:"Module"}));var rd=(s=>(s[s.Cutoff=476837158203125e-21]="Cutoff",s))(rd||{});class hg{constructor(){this.plane=new Ki,this.referenceGeometry=null,this.meshId=null,this.instanceNodeId=null,this.color=vt.createFromFloat(.65,.65,.65),this.lineColor=vt.black(),this.opacity=.35,this.matrix=new _t}toJson(){return{plane:{normal:this.plane.normal,d:this.plane.d},referenceGeometry:this.referenceGeometry}}fromJson(t){const e=lc(t),i=e.plane;this.plane=new Ki;const n=i.normal;this.plane.normal=new _(n.x,n.y,n.z),this.plane.d=i.d;const r=e.referenceGeometry;if(Array.isArray(r))for(let o=0;o<r.length;++o)r[o]=_.fromJson(r[o]);this.referenceGeometry=r}getMatrix(){return this.matrix.copy()}setMatrix(t){this.matrix=t.copy()}setReferenceGeometry(t){if(t){this.referenceGeometry=[];for(const e of t)this.referenceGeometry.push(e.copy())}else this.referenceGeometry=null}getReferenceGeometry(){if(this.referenceGeometry){const t=[];for(const e of this.referenceGeometry)t.push(e.copy());return t}else return null}createMeshData(){const t=this.referenceGeometry;if(t===null)return null;const e=new rs,i=[],n=[];i.push(t[0].x,t[0].y,t[0].z),i.push(t[1].x,t[1].y,t[1].z),i.push(t[3].x,t[3].y,t[3].z),i.push(t[1].x,t[1].y,t[1].z),i.push(t[2].x,t[2].y,t[2].z),i.push(t[3].x,t[3].y,t[3].z);const o=Ki.createFromPoints(t[0],t[1],t[2]).normal;for(let l=0;l<6;l++)n.push(o.x,o.y,o.z);return e.addFaces(i,n),e.addPolyline([t[0].x,t[0].y,t[0].z,t[1].x,t[1].y,t[1].z]),e.addPolyline([t[1].x,t[1].y,t[1].z,t[2].x,t[2].y,t[2].z]),e.addPolyline([t[2].x,t[2].y,t[2].z,t[3].x,t[3].y,t[3].z]),e.addPolyline([t[3].x,t[3].y,t[3].z,t[0].x,t[0].y,t[0].z]),e}}class sy{constructor(t,e,i,n,r){this._cuttingPlanes=[],this._isActive=!1,this._viewer=t,this._model=e,this._callbackManager=i,this._cuttingManager=n,this._engine=r}async addPlane(t,e=null){const i=this._engine.getCuttingSectionLimits();if(this._cuttingPlanes.length>=i.maxCuttingPlanesPerSection)return!1;const n=new hg;return n.plane=t.copy(),n.setReferenceGeometry(e),this._cuttingPlanes.push(n),this._isActive&&(await this._resetCuttingPlane(n),await this._engine.updateCuttingSection(this)),!0}async setPlane(t,e,i=null){const n=this._cuttingPlanes[t];if(n!==void 0&&(n.plane=e.copy(),n.setReferenceGeometry(i),this._isActive))return await this._resetCuttingPlane(n),this._engine.updateCuttingSection(this)}async updatePlane(t,e,i=new _t,n=!1,r=!1){const o=this._cuttingPlanes[t];if(o!==void 0&&(o.plane=e.copy(),this._isActive))if(o.instanceNodeId!==null){this._engine.pauseAllRendering();let l=o.getMatrix();r&&(l=new _t);const h=_t.multiply(l,i);n&&o.setMatrix(h),await Promise.all([this._model.setNodeMatrix(o.instanceNodeId,h),this._engine.updateCuttingSection(this)]),this._engine.resumeAllRendering()}else return this._engine.updateCuttingSection(this)}removePlane(t){const e=[],i=this._cuttingPlanes[t];return i!==void 0&&(i.meshId!==null&&i.instanceNodeId!==null&&e.push(this._destroyMeshes([i.meshId],[i.instanceNodeId])),this._cuttingPlanes.splice(t,1)),this._isActive&&e.push(this._engine.updateCuttingSection(this)),Ue(e)}getPlane(t){const e=this._cuttingPlanes[t];return e!==void 0?e.plane.copy():null}getNodeId(t){const e=this._cuttingPlanes[t];return e!==void 0?e.instanceNodeId:null}getReferenceGeometry(t){const e=this._cuttingPlanes[t];return e!==void 0?e.getReferenceGeometry():null}getPlaneIndexByNodeId(t){for(let e=0;e<this._cuttingPlanes.length;e++)if(this._cuttingPlanes[e].instanceNodeId===t)return e;return null}getPlaneOpacity(t){const e=this._cuttingPlanes[t];if(e)return e.opacity}setPlaneOpacity(t,e){this.applyPlaneOpacity(t,e)}applyPlaneOpacity(t,e){const i=this._cuttingPlanes[t];i!==void 0&&(e&&(i.opacity=e),i.instanceNodeId!==null&&this._model.setNodesOpacity([i.instanceNodeId],i.opacity))}resetPlanesOpacity(){this._cuttingPlanes.forEach((t,e)=>{this.applyPlaneOpacity(e)})}setColor(t){const e=[];for(const i of this._cuttingPlanes)i.color.assign(t),i.instanceNodeId!==null&&e.push(i.instanceNodeId);return this._model.setNodesFaceColor(e,t),Promise.resolve()}setOpacity(t){const e=[];for(const i of this._cuttingPlanes)i.opacity=t,i.instanceNodeId!==null&&e.push(i.instanceNodeId);this._model.setNodesOpacity(e,t)}getCount(){return this._cuttingPlanes.length}async clear(){await this.deactivate(),this._cuttingPlanes.length=0}async activate(){if(!this._isActive){if(this._isActive=!0,this._cuttingPlanes.length>0){if(!this._cuttingManager.hasActiveCuttingSection())for(const i of this._viewer.views)this._engine.setDefaultDepthRange(i.id,0,1-rd.Cutoff);const t=[],e=[];for(const i of this._cuttingPlanes)t.push(this._createCuttingPlaneGeometry(i).then(n=>{n!==null&&e.push(n)}));await Ue(t),this._initCuttingPlanesByNodeId(e)}return this._engine.addCuttingSection(this)}}async deactivate(){if(this._isActive){this._isActive=!1;const t=[];if(t.push(this._destroyGeometry()),t.push(this._engine.removeCuttingSection(this)),!this._cuttingManager.hasActiveCuttingSection())for(const e of this._viewer.views)this._engine.setDefaultDepthRange(e.id,0,1);return Ue(t)}}isActive(){return this._isActive}toJson(){return this._toJson()}_toJson(){const t=[];for(let e=0;e<this._cuttingPlanes.length;e++)t[e]=this._cuttingPlanes[e].toJson();return{planes:t}}async fromJson(t){await this.clear();const i=lc(t).planes;for(const n of i){const r=new hg;r.fromJson(n),this._cuttingPlanes.push(r)}return this.activate()}_initCuttingPlanesByNodeId(t){this._model.setInstanceModifier($i.DoNotCut,t,!0),this._model.setInstanceModifier($i.DoNotExplode,t,!0),this._cuttingManager.getStandinGeometryPickable()||this._model.setInstanceModifier($i.DoNotSelect,t,!0)}_destroyGeometry(){const t=[],e=[];for(const i of this._cuttingPlanes)i.meshId!==null&&t.push(i.meshId),i.instanceNodeId!==null&&e.push(i.instanceNodeId),i.meshId=null,i.instanceNodeId=null;return this._destroyMeshes(t,e)}_getInstanceNodeIds(){const t=[];for(const e of this._cuttingPlanes){const i=e.instanceNodeId;i!==null&&t.push(i)}return t}async _resetCuttingPlane(t){if(t.meshId!==null&&t.instanceNodeId!==null){const e=this._destroyMeshes([t.meshId],[t.instanceNodeId]);return t.meshId=null,t.instanceNodeId=null,await e,this._createInstanceGeometry(t)}else if(t.referenceGeometry!==null)return this._createInstanceGeometry(t)}async _createInstanceGeometry(t){const e=[],i=await this._createCuttingPlaneGeometry(t);i!==null&&e.push(i),this._initCuttingPlanesByNodeId(e)}async _destroyMeshes(t,e){const i=[];i.push(this._model.deleteMeshInstances(e)),i.push(this._model.deleteMeshes(t)),await Ue(i);for(const n of e)this._viewer.selectionManager._incrementalBlacklistedInstanceNodes.delete(n)}async _createCuttingPlaneGeometry(t){const e=t.createMeshData();if(e===null)return null;e.setBackfacesEnabled(!0);const i=await this._model.createMesh(e);t.meshId=i;const n=ie.OverrideSceneVisibility|ie.ExcludeBounding|ie.DoNotXRay,r=t.plane.copy(),o=r.normal.copy().scale(-r.d),l=new _t().setTranslationComponent(o.x,o.y,o.z);t.setMatrix(l.copy());const h=new Ns(i,l,null,t.color,null,null,n);h.setLineColor(t.lineColor),this._engine.pauseAllRendering();const u=await this._model.createMeshInstance(h,void 0,!0,!0);return t.instanceNodeId=u,this._viewer.selectionManager._incrementalBlacklistedInstanceNodes.add(u),this._model.setDepthRange([u],rd.Cutoff,1),this._model.setNodesOpacity([u],t.opacity),this._engine.resumeAllRendering(),u}}const Zi=class Zi{constructor(t,e){this._position=new Vo(0,De.Pixels,0,De.Pixels),this._viewportSize=new Vo(.2,De.MinimumProportionOfCanvas,.2,De.MinimumProportionOfCanvas),this._anchor=je.LowerLeftCorner,this._instanceKeys=[],this._enabled=!1,this._sceneReady=mi(),this._assemblyTreeReady=mi(),this._axisTriadReadyToInit=[this._sceneReady,this._assemblyTreeReady],this._geometryCreated=!1,this._viewer=t,this._view=e,this._viewer.getSceneReady()&&this._sceneReady.resolve(),this._viewer.getModelReady()&&this._assemblyTreeReady.resolve(),this._viewer.setCallbacks({sceneReady:async()=>{this._sceneReady.resolve()},_assemblyTreeReady:async()=>{this._assemblyTreeReady.resolve()},_firstAttachment:async()=>{await this._onCameraUpdate(),this._updateVisibility()},overlayViewportSet:(i,n)=>{var r;n.id===((r=this._view)==null?void 0:r.id)&&i===ye.AxisTriad&&this._onViewportSet()},_drawContextDestroyed:i=>{this._view!==void 0&&i===this._view.id&&delete this._view}}),Promise.all(this._axisTriadReadyToInit).then(async()=>{this._createViewport(),this._updateVisibility(),await this._createGeometry();const i=this._viewer.model;for(const n of this._instanceKeys){const r=i._getNodeFromInstanceInc(!0,ki.Local,n,!0);i._preventNodeDeletion(r)}})}async setAxisColor(t,e){await this._sceneReady;let i,n;switch(t){case Xe.X:i=this._instanceKeys[0],n=this._instanceKeys[3];break;case Xe.Y:i=this._instanceKeys[1],n=this._instanceKeys[4];break;case Xe.Z:i=this._instanceKeys[2],n=this._instanceKeys[5];break;default:return}const r=this._getScEngine();r.setPartColor([ki.Local,i],Yt.Faces,e),r.setPartColor([ki.Local,n],Yt.Lines,e)}async setAnchor(t){return this._anchor=t,await this._sceneReady,this._updateViewport()}getAnchor(){return this._anchor}enable(){return this._enabled=!0,this._updateVisibility(),Promise.resolve()}disable(){return this._enabled=!1,this._updateVisibility(),Promise.resolve()}_updateVisibility(){this._enabled?this._showOverlay():this._hideOverlay()}_hideOverlay(){this._view&&this._view.overlayManager.setVisibility(ye.AxisTriad,!1)}_showOverlay(){this._view&&this._view.overlayManager.setVisibility(ye.AxisTriad,!0)}getEnabled(){return this._enabled}getOverlayId(){return ye.AxisTriad}_updateViewport(){if(!this._view)return;this._view.overlayManager.setViewport(ye.AxisTriad,this._anchor,this._position.x,De.Pixels,this._position.y,De.Pixels,this._viewportSize.x,this._viewportSize.xUnit,this._viewportSize.y,this._viewportSize.yUnit)}_createViewport(){if(!this._view)return;const t=this._view.overlayManager;this._updateViewport();const e=new dn;e.setPosition(new _(0,0,10)),e.setTarget(_.zero()),e.setUp(new _(0,1,0)),e.setWidth(Zi._fieldSize),e.setHeight(Zi._fieldSize),e.setProjection(ti.Orthographic),t.setCamera(ye.AxisTriad,e)}_onViewportSet(){if(!this._view)return;const t=this._view.overlayManager,e=t._getViewportPosition(ye.AxisTriad),i=t._getViewportSize(ye.AxisTriad),n=t.getViewportAnchor(ye.AxisTriad);e===null||i===null||n===null||(this._position=e,this._viewportSize=i,this._anchor=n)}async _createGeometry(){if(this._geometryCreated)return;const t=[this._createAxis(Zi._xRotMatrix,0,Zi._xColor),this._createAxis(Zi._yRotMatrix,1,Zi._yColor),this._createAxis(Zi._zRotMatrix,2,Zi._zColor),this._createAxisLabel(Xe.X,Zi._xColor,3),this._createAxisLabel(Xe.Y,Zi._yColor,4),this._createAxisLabel(Xe.Z,Zi._zColor,5)],e=await Promise.all(t);this._onCameraUpdate();const i=[];for(const r of e)i.push(ki.Local,r);this._getScEngine().setPartVisibility(i,!0,!0),this._createGeomCallbacks(),this._geometryCreated=!0}_createGeomCallbacks(){this._viewer.setCallbacks({camera:(t,e)=>{this._view!==void 0&&e.id===this._view.id&&this._onCameraUpdate()}})}_geometryHasBeenCreated(){return this._geometryCreated}insideOverlay(t){if(!this._view)return!1;const e=this._view.overlayManager._toPixelPoint(this._viewportSize),i=this._getOverlayOffset();return t.x>=i.x&&t.y>=i.y&&t.x<=i.x+e.x&&t.y<=i.y+e.y}_getOverlayOffset(){if(!this._view)return K.zero();const t=this._view.overlayManager._toPixelPoint(this._viewportSize);return this._view.overlayManager._getOverlayOffset(this._anchor,t)}_getViewportSize(){return this._viewportSize}_getViewportPixelSize(){return this._view?this._view.overlayManager._toPixelPoint(this._viewportSize):K.zero()}getSelectionAxis(t){if(console.assert(this._enabled),t===null||!t.isFaceSelection()||t.overlayIndex()!==ye.AxisTriad)return null;const e=this._viewer.model,i=t.getNodeId(),n=e._gatherInstanceIncsFromNodeIds([i],jt.BodyInstance);if(n.length!==2||n[0]!==ki.Local)return null;const r=n[1];for(let o=0;o<this._instanceKeys.length;++o)if(this._instanceKeys[o]===r)switch(o%3){case 0:return Xe.X;case 1:return Xe.Y;case 2:return Xe.Z}return null}async onClickSelection(t){if(this._view===void 0)return;const e=this.getSelectionAxis(t);if(e===null)return;const i=this._viewer.model,n=this._view;let r;switch(e){case Xe.X:r=Pc.EyeX_UpY;break;case Xe.Y:r=Pc.EyeY_UpZ;break;case Xe.Z:r=Pc.EyeZ_UpX;break}const o=await i.getModelBounding(!0,!1),l=n.getCamera();let h=this._alignedFitBounding(r,!1,!1,o);l.equals(h)&&(h=this._alignedFitBounding(r,!0,!1,o)),await n._setCameraPromise(h,Yn);const u=this._viewer.model.getAbsoluteRootNode();if(this._viewer.model.getNodeChildren(u).length===0)return this._viewer._getScEngine().markCameraAsEmpty(this._view.id)}_getScEngine(){return this._viewer._getScEngine()}async _createInstance(t,e,i,n,r,o){const l=await this._viewer.model.createMesh(t),h=new Ns(l);if(h.setCreationFlags(o|ie.DoNotCut|ie.DoNotExplode|ie.ExcludeBounding|ie.Invisible),!this._view)throw Error("Impossible to create a axis triad without an associated view");h.overlayId={viewKey:this._view.id,overayIndex:ye.AxisTriad},h.setFaceColor(i),h.setLineColor(n),h.setMatrix(r);const g=(await this._getScEngine().createMeshInstance(h))[1];return this._instanceKeys[e]=g,g}_createAxis(t,e,i){const n=ff(Gs.CylinderRadius,Gs.SegmentCount,Gs.StemHeight,Gs.ConeBaseRadius,Gs.CapHeight,Gs.TaperHeight);return this._createInstance(n,e,i,vt.black(),t,ie.None)}_createAxisLabel(t,e,i){const n=new rs;n.setFaceWinding(Rs.Clockwise);const r=.5*Gs.LetterWidth,o=.5*Gs.LetterHeight,l=Gs.StemHeight+Gs.CapHeight+Gs.LetterOffsetPos,h=new _t;return t===Xe.X?(n.addPolyline([r,o,0,-r,-o,0]),n.addPolyline([-r,o,0,r,-o,0]),h.setTranslationComponent(l,0,0)):t===Xe.Y?(n.addPolyline([-r,o,0,0,0,0]),n.addPolyline([0,0,0,r,o,0]),n.addPolyline([0,0,0,0,-1.25*o,0]),h.setTranslationComponent(0,l,0)):t===Xe.Z&&(n.addPolyline([-r,o,0,r,o,0]),n.addPolyline([r,o,0,-r,-o,0]),n.addPolyline([-r,-o,0,r,-o,0]),h.setTranslationComponent(0,0,l)),this._createInstance(n,i,vt.black(),e,h,ie.ScreenOriented)}_onCameraUpdate(){if(this._view===void 0)return;const t=new dn,e=this._view.getCamera();t.setPosition(e.getPosition().subtract(e.getTarget()).normalize()),t.setTarget(_.zero()),t.setUp(e.getUp()),t.setProjection(ti.Orthographic),t.setWidth(Zi._fieldSize),t.setHeight(Zi._fieldSize),this._view.overlayManager.setCamera(ye.AxisTriad,t)}_alignedFitBounding(t,e,i,n){if(this._view===void 0)return;const r=_.subtract(n.max,n.min).length(),o=_.add(_.scale(n.min,.5),_.scale(n.max,.5)),l=new _(o.x,o.y,o.z+r),h=_.subtract(o,l);let u=-h.length();const d=i?-1:1;let g,y;t===Pc.None?(g=h,y=new _(0,d,0),e&&g.negate()):(e&&(u=-u),t&_u.X?g=new _(u,0,0):t&_u.Y?g=new _(0,u,0):(console.assert((t&_u.Z)!==0),g=new _(0,0,u)),t&yu.X?y=new _(d,0,0):t&yu.Y?y=new _(0,d,0):(console.assert((t&yu.Z)!==0),y=new _(0,0,d)));const m=_.subtract(o,g),I=this._view.getCamera();return dn.create(m,o,y,I.getProjection(),r,r,I.getNearLimit())}};Zi._xRotMatrix=_t.createFromOffAxisRotation(new _(0,0,1),-90),Zi._yRotMatrix=new _t,Zi._zRotMatrix=_t.createFromOffAxisRotation(new _(1,0,0),90),Zi._xColor=new vt(168,56,59),Zi._yColor=new vt(96,166,50),Zi._zColor=new vt(41,81,185),Zi._fieldSize=8;let od=Zi;class ry{constructor(t,e,i,n){this._cuttingSections=[],this._isInit=!1,this._standinGeometryPickable=!0,this._cappingFaceColor=vt.createFromFloat(.5,.5,.5),this._cappingLineColor=vt.createFromFloat(.5,.5,.5),this._cappingIdleCallbackEnabled=!1,this._cappingIdlePromise=null,this._conservativeIsCappingIdle=!1,this._viewer=t,this._model=e,this._callbackManager=i,this._engine=n,t.setCallbacks({cappingIdle:r=>{this._conservativeIsCappingIdle=r,r&&this._cappingIdlePromise!==null&&(this._cappingIdlePromise.resolve(),this._cappingIdlePromise=null)},_resetAssemblyTreeBegin:()=>(this._cappingIdlePromise!==null&&(this._cappingIdlePromise.reject(new ae("Model became reset.")),this._cappingIdlePromise=null),Promise.resolve()),_resetOpacity:()=>{this._cuttingSections.forEach(r=>r.resetPlanesOpacity())}})}createReferenceGeometryFromAxis(t,e){const i=[];switch(t){case Xe.X:i.push(new _(0,e.max.y,e.min.z)),i.push(new _(0,e.max.y,e.max.z)),i.push(new _(0,e.min.y,e.max.z)),i.push(new _(0,e.min.y,e.min.z));break;case Xe.Y:i.push(new _(e.min.x,0,e.min.z)),i.push(new _(e.max.x,0,e.min.z)),i.push(new _(e.max.x,0,e.max.z)),i.push(new _(e.min.x,0,e.max.z));break;case Xe.Z:i.push(new _(e.min.x,e.max.y,0)),i.push(new _(e.max.x,e.max.y,0)),i.push(new _(e.max.x,e.min.y,0)),i.push(new _(e.min.x,e.min.y,0));break}return i}createReferenceGeometryFromFaceNormal(t,e,i){const n=[],r=new Ki().setFromPointAndNormal(e,t).d,o=e.copy().add(_.scale(t,r)),l=i.center(),h=_.add(l,_.scale(t,_.dot(t,_.subtract(o,l)))),u=i.extents().length()/2,d=_.subtract(h,o),g=_.cross(t,d),y=d.copy().scale(-1),m=g.copy().scale(-1),I=_.add(d,g).normalize().scale(u).add(h),b=_.add(y,g).normalize().scale(u).add(h),x=_.add(y,m).normalize().scale(u).add(h),C=_.add(d,m).normalize().scale(u).add(h);return n.push(I),n.push(b),n.push(x),n.push(C),n}activateCuttingSections(){const t=[];for(const e of this._cuttingSections)t.push(e.activate());return Ue(t)}deactivateAllCuttingSections(){const t=[];for(const e of this._cuttingSections)t.push(e.deactivate());return Ue(t)}clearAllCuttingSections(){const t=[];for(const e of this._cuttingSections)t.push(e.clear());return Ue(t)}setCuttingPlaneColor(t){for(const e of this._cuttingSections)e.setColor(t);return Promise.resolve()}setCappingFaceColor(t){return this._cappingFaceColor=t?t.copy():null,this._engine.setCappingFaceColor(this._cappingFaceColor),Promise.resolve()}getCappingFaceColor(){return this._cappingFaceColor?this._cappingFaceColor.copy():null}setCappingLineColor(t){return this._cappingLineColor=t?t.copy():null,this._engine.setCappingLineColor(this._cappingLineColor),Promise.resolve()}getCappingLineColor(){return this._cappingLineColor?this._cappingLineColor.copy():null}getCuttingSection(t){return this._isInit&&t<this._cuttingSections.length?this._cuttingSections[t]:null}getCuttingSectionCapacity(){return this._cuttingLimits!==void 0?this._cuttingLimits.maxCuttingPlanesPerSection:0}getCuttingSectionCount(){return this._cuttingLimits!==void 0?this._cuttingLimits.maxCuttingSections:0}getCuttingSectionFromNodeId(t){if(t!==null){for(const e of this._cuttingSections)if(e._getInstanceNodeIds().indexOf(t)>=0)return e}return null}async getNodesWithCapping(){const t=await this._engine.getCappedInstances(),e=[];for(let i=0;i<t.length-1;i+=2){const n=this._model._getNodeFromInstanceInc(!1,t[i],t[i+1],!1);e.push(n)}return e}setStandinGeometryPickable(t){this._standinGeometryPickable=t;const e=this._gatherStandinGeometryIds();return this._model.setInstanceModifier($i.DoNotSelect,e,!t),Promise.resolve()}getStandinGeometryPickable(){return this._standinGeometryPickable}_setStandinGeometryVisible(t){const e=this._gatherStandinGeometryIds(),i=this._model._gatherInstanceIncsFromNodeIds(e);this._engine.pauseAllRendering(()=>{this._engine.setPartVisibility(i,t,!1)})}setCappingDelay(t){this._engine.setCappingDelay(t)}delayCapping(){this._engine.delayCapping()}enableCappingIdleCallback(t){return t!==this._cappingIdleCallbackEnabled&&(this._cappingIdleCallbackEnabled=t,this._conservativeIsCappingIdle=!1,!t&&this._cappingIdlePromise!==null&&(this._cappingIdlePromise.reject(new ae("Capping idle callback became disabled.")),this._cappingIdlePromise=null)),this._engine.enableCappingIdleCallback(t)}async waitForCappingIdle(){if(!this._cappingIdleCallbackEnabled)throw console.assert(this._cappingIdlePromise===null),new ae("Capping idle callback is not enabled.");if(!this._conservativeIsCappingIdle)return this._cappingIdlePromise===null&&(this._cappingIdlePromise=mi()),this._cappingIdlePromise}setCappingGeometryVisibility(t){for(const e of this._viewer.views)this._engine.setCappingGeometryVisibility(e.id,t);return Promise.resolve()}getCappingGeometryVisibility(){return this._engine.getCappingGeometryVisibility()}getActiveCuttingSectionCount(){let t=0;if(this._cuttingLimits)for(let e=0;e<this._cuttingLimits.maxCuttingSections;e++){const i=this.getCuttingSection(e);i!=null&&i.isActive()&&(t+=i.getCount())}return t}_init(){if(!this._isInit){this._cuttingLimits=this._engine.getCuttingSectionLimits();for(let t=0;t<this._cuttingLimits.maxCuttingSections;t++){const e=new sy(this._viewer,this._model,this._callbackManager,this,this._engine);this._cuttingSections.push(e)}this._isInit=!0}}_isInitialized(){return this._isInit}refreshPlaneGeometry(){const t=[];for(const e of this._cuttingSections)for(let i=0;i<e.getCount();i++){const n=e.getPlane(i);n!==null&&t.push(e.updatePlane(i,n,new _t,!1,!1))}return Ue(t)}hasActiveCuttingSection(){if(this._cuttingLimits)for(let t=0;t<this._cuttingLimits.maxCuttingSections;t++){const e=this.getCuttingSection(t);if(e!==null&&e.isActive())return!0}return!1}toJson(){return this._toJson()}_toJson(){const t=[];for(let e=0;e<this._cuttingSections.length;e++)t[e]=this._cuttingSections[e].toJson();return{cuttingSections:t,cappingGeometryVisibility:this.getCappingGeometryVisibility(),cappingFaceColor:this.getCappingFaceColor(),cappingLineColor:this.getCappingLineColor(),pickable:this.getStandinGeometryPickable()}}async fromJson(t){const e=lc(t),i=[],n=e.cuttingSections;for(let r=0;r<n.length;r++){const o=n[r],l=this._cuttingSections[r];i.push(l.fromJson(o))}this.setStandinGeometryPickable(e.pickable),i.push(this.setCappingGeometryVisibility(e.cappingGeometryVisibility)),i.push(this.setCappingFaceColor(vt.fromJson(e.cappingFaceColor))),i.push(this.setCappingLineColor(vt.fromJson(e.cappingLineColor))),await Promise.all(i),this._callbackManager.trigger("cuttingSectionsLoaded")}_gatherStandinGeometryIds(){const t=[];for(const e of this._cuttingSections){const i=e._getInstanceNodeIds();for(const n of i)t.push(n)}return t}}class oy{constructor(t,e,i){this._explodeActive=!1,this._explodeMagnitude=0,this._model=t,this._engine=e,i.bind({_modelSwitched:async()=>{this.stop()}})}start(t,e){return this.getActive()?(this.stop(),this._doExplode(t,e)):this._doExplode(t,e)}async setMagnitude(t){if(t>0&&!this._explodeActive?await this.start():t===0&&this._explodeActive&&this.stop(),this._explodeActive)return this._explodeMagnitude=t,this._engine.setExplodeMagnitude(t)}stop(){return this._engine.stopExplode(),this._explodeMagnitude=0,this._explodeActive=!1,this._engine.setExplodeMagnitude(0),Promise.resolve()}getMagnitude(){return this._explodeMagnitude}getActive(){return this._explodeActive}async _doExplode(t,e){this._explodeActive=!0;let i;if(t!==void 0&&t.length>0?i=this._model._gatherInstanceIncsFromNodeIds(t):i=[],e)this._engine.startExplode(i,e);else{const n=await this._model.getModelBounding(!0,!1);this._engine.startExplode(i,n.center())}}}class ug{constructor(t,e,i,n){this.type=t,this.space=e,this.position=i,this.color=n}}class ay extends ug{constructor(t,e,i,n){super(t,e,i,n)}}class ly extends ug{constructor(t,e,i,n,r,o){super(t,e,i,n),this.power=r,this.decay=o}}class cy extends ah{constructor(t,e){super(),this._markupArray=[],this._viewer=t,this._callbackManager=e,this._callbackManager.bind({modelSwitched:()=>{this.removeAllLines()}})}async addLine(t){this._markupArray.push(t),await t.updateLine(),this._callbackManager.trigger("lineCreated",t)}async removeLine(t){for(let e=0;e<this._markupArray.length;e++)this._markupArray[e].getId()===t.getId()&&(await t.removeLine(),this._markupArray.splice(e,1),this._callbackManager.trigger("lineDeleted",t))}removeAllLines(){const t=[];for(let e=this._markupArray.length-1;e>=0;e--){const i=this._markupArray[e];t.push(i.removeLine().then(()=>{this._callbackManager.trigger("lineDeleted",i)})),this._markupArray.splice(e,1)}return Ue(t)}getAllLines(){return this._markupArray.slice(0)}async removeLastLine(){this._markupArray.length>0&&await this.removeLine(this._markupArray[this._markupArray.length-1])}getLineByNodeId(t){for(const e of this._markupArray){const i=e.getNodeId();if(i!==null&&i===t)return e}return null}exportMarkup(){const t=[];for(const e of this._markupArray)t.push(e.toJson());return t}async _handleLoadLine(t){return t instanceof ba?(await this.addLine(t),this._callbackManager.trigger("lineLoaded",t),!0):!1}loadData(t){const e=[];for(const i of t){if(!i.hasOwnProperty("className"))continue;const n=hf(i.className);if(n){const r=n(i,this._viewer);r instanceof Promise?e.push(r.then(o=>this._handleLoadLine(o))):e.push(this._handleLoadLine(r))}}return Promise.all(e)}}class Wb extends ah{constructor(t,e,i,n,r,o){super(),this._markupViews=new Map,this._defaultViewCounter=1,this._markupItemManager=e,this._callbackManager=i,this._explodeManager=n,this._cuttingManager=r,this._viewer=t,this._sheetManager=o,this._initEvents()}_initEvents(){this._callbackManager.bind({modelSwitchStart:()=>{this._markupItemManager.shutdown()}})}getView(t){const e=this._markupViews.get(t);return e!==void 0?e:null}getViewKeys(){const t=[];return this._markupViews.forEach((e,i)=>{t.push(i)}),t}async loadData(t){const e=[];for(const i of t){const n=ih._fromJson(i,this._viewer).then(r=>{if(!r.itemResults.every(Boolean))return!1;const o=r.markupView,l=o.getUniqueId();return this._markupViews.has(l)?!1:(this._markupViews.set(l,o),this._callbackManager.trigger("viewLoaded",o),!0)});e.push(n)}return Promise.all(e)}exportMarkup(){const t=[];return this._markupViews.forEach(e=>{t.push(e.toJson())}),t}createView(t=this._createDefaultViewName(),e,i=!0,n=null,r=null,o=null,l=null){const h=hs(),u=new ih(h,t,e.getCamera(),this._explodeManager.getMagnitude(),this._cuttingManager.toJson(),n);return this._markupViews.set(h,u),u.setLineVisibility(e.getLineVisibility()),u.setFaceVisibility(e.getFaceVisibility()),r!==null&&(u.setDefaultVisibility(r.defaultVisibility),u.setVisibilityExceptions(r.visibilityExceptions)),o!==null&&u.setColorMap(o),l!==null&&u.setSnapshotImage(l),this._markupItemManager.setActiveView(e,u),i&&this._callbackManager.trigger("viewCreated",u),u}async _activateSheet(t){if(t!==null)return this._sheetManager.setActiveSheetId(t,!0,!1)}async _activateViewImpl(t,e,i){await this._activateSheet(t.getSheetId()),e.setFaceVisibility(t.getFaceVisibility()),e.setLineVisibility(t.getLineVisibility()),i>0?(await this._markupItemManager.setActiveView(e,null),await e._setCameraPromise(t.getCamera(),i)):e.setCamera(t.getCamera()),await this._setActiveView(t,e)}_activateView(t,e,i){const n=this._markupViews.get(t);if(n!==void 0){const r=this._activateViewImpl(n,e,i);return Po(!0,r)}else return Po(!1,Promise.resolve())}async activateView(t,e,i=Yn){return this._activateView(t,e,i)}async _setActiveView(t,e){if(this._viewer.model.isDrawing())if(t.getSheetId()===null)await this._viewer.sheetManager.deactivateSheets(!0,!0);else{const i=t.getVisibilityExceptions(),n=t.getDefaultVisibility();if(i.size>0&&n){const r=[];i.forEach(o=>{r.push(o)}),await this._viewer.model.setNodesVisibility(r,!1)}}else{const i=t.getDefaultVisibility(),n=t.getVisibilityExceptions();await this._viewer.model.setBodyNodesVisibility(this._viewer.model.getAbsoluteRootNode(),r=>n.has(r)?!i:i)}await this._markupItemManager.setActiveView(e,t),await this._cuttingManager.fromJson(t.getCuttingPlaneData()),await this._viewer.model.setNodesColors(t.getColorMap()),await this._explodeManager.setMagnitude(t.getExplodeMagnitude())}deleteView(t){const e=this._markupViews.get(t);return e!==void 0?(this._callbackManager.trigger("viewDeleted",e),this._markupItemManager.markupViewDeleted(e),this._markupViews.delete(t),!0):!1}_createDefaultViewName(){return`View ${this._defaultViewCounter++}`}toJson(){return this.exportMarkup()}}class hy{constructor(t,e,i,n,r,o){this._markupTypeMap=new Map,this._callbackManager=i,this._viewer=o,this._sheetManager=n,this._sheetManager.setMarkupManager(this),this._noteTextManager=r,this._renderer=new f_,this._itemManager=new l_(this._callbackManager,this._renderer),this._viewManager=new Wb(this._viewer,this._itemManager,this._callbackManager,o.explodeManager,o.cuttingManager,this._sheetManager),this._measurementManager=t,this._lineManager=e}registerMarkupTypeManager(t,e){this._markupTypeMap.set(t,e)}registerMarkupFactory(t,e){ss(t,e)}createMarkupView(t,e,i=!0,n=null,r=null,o=null){const l=this._viewer.sheetManager.getActiveSheetId();return this._viewManager.createView(e,t,i,l,n,r,o).getUniqueId()}getMarkupView(t){return this._viewManager.getView(t)}getMarkupViewKeys(){return this._viewManager.getViewKeys()}async activateMarkupViewWithPromise(t,e,i=Yn){return this._viewManager.activateView(t,e,i)}getActiveMarkupView(t){return this._itemManager.getActiveView(t)}deleteMarkupView(t){return this._viewManager.deleteView(t)}registerMarkup(t,e){const i=this._itemManager.registerMarkupItem(t,e);return this.updateLater(e),i}unregisterMarkup(t,e){this._itemManager.unregisterMarkupItem(t,e),this.updateLater(e)}addMarkupElement(t,e){const i=hs();return t.id=i,e.domElements.getRedlineElement().appendChild(t),i}removeMarkupElement(t,e){const i=e.domElements.getRedlineElement();for(let n=0;n<i.children.length;n++){const r=i.children.item(n);r!==null&&r.id===t&&i.removeChild(r)}}refreshMarkup(t){this.updateLater(t)}refreshMarkupView(t){const e=this._itemManager.getViews(t);for(let i of e)this.refreshMarkup(i)}updateLater(t){this._itemManager.updateLater(t)}pickMarkupItem(t,e){return this._itemManager.pick(t,e)}getPickTolerance(){return this._itemManager.getPickTolerance()}setPickTolerance(t){return this._itemManager.setPickTolerance(t)}selectMarkup(t,e){this._itemManager.select(t,e)}getSelectedMarkup(){return this._itemManager.getSelected()}exportMarkup(){const t={views:this._viewManager.exportMarkup(),notes:this._noteTextManager.exportMarkup(),measurement:this._measurementManager.exportMarkup(),lines:this._lineManager.exportMarkup()};return this._markupTypeMap.forEach((e,i)=>{t[i]=e.exportMarkup()}),t}async loadMarkupData(t){return typeof t=="string"&&(t=JSON.parse(t)),this._loadMarkupData(t)}async _loadMarkupData(t){const e=[];if(t.hasOwnProperty("views")){const i=this._viewManager.loadData(t.views).then(n=>n.every(Boolean));e.push(i)}if(t.hasOwnProperty("notes")){const i=this._noteTextManager.loadData(t.notes).then(n=>n.every(Boolean));e.push(i)}if(t.hasOwnProperty("measurement")){const i=this._measurementManager.loadData(t.measurement).then(n=>n.every(Boolean));e.push(i)}if(t.hasOwnProperty("lines")){const i=this._lineManager.loadData(t.lines).then(n=>n.every(Boolean));e.push(i)}return this._markupTypeMap.forEach((i,n)=>{if(t.hasOwnProperty(n)){const r=i.loadData(t[n]).then(o=>o.every(Boolean));e.push(r)}}),Promise.all(e).then(i=>i.every(Boolean))}getRenderer(){return this._renderer}_shutdown(){this._itemManager.shutdown(),this._renderer._clear()}_update(){this._itemManager.update()}async _setActiveMarkupView(t,e){return this._itemManager.setActiveView(t,e)}_getItemManager(){return this._itemManager}_viewDeleted(t){this._itemManager.viewDeleted(t)}}class uy extends ah{constructor(t,e){super(),this._markupArray=[],this._color=new vt(0,0,0),this._edgeColor=new vt(0,0,0),this._viewer=t,this._callbackManager=e,this._callbackManager.bind({modelSwitched:()=>{this.removeAllMeasurements()}})}addMeasurement(t){this._markupArray.push(t);const e=this._viewer.markupManager.registerMarkup(t,this._viewer.view);return t._setId(e),e}finalizeMeasurement(t){this._callbackManager.trigger("measurementCreated",t)}removeMeasurement(t){for(let e=0;e<this._markupArray.length;e++)if(this._markupArray[e]._getId()===t._getId()){this._markupArray.splice(e,1),this._viewer.markupManager.unregisterMarkup(t._getId(),this._viewer.view),this._callbackManager.trigger("measurementDeleted",t);break}}removeAllMeasurements(){for(let t=this._markupArray.length-1;t>=0;t--){const e=this._markupArray[t];this._viewer.markupManager.unregisterMarkup(e._getId(),this._viewer.view),this._markupArray.splice(t,1),this._callbackManager.trigger("measurementDeleted",e)}}getAllMeasurements(){return this._markupArray.slice(0)}removeLastMeasurement(){this._markupArray.length>0&&this.removeMeasurement(this._markupArray[this._markupArray.length-1])}setMeasurementColor(t){this._color.assign(t)}getMeasurementColor(){return this._color.copy()}setMeasurementEdgeColor(t){this._edgeColor.assign(t)}getMeasurementEdgeColor(){return this._edgeColor.copy()}exportMarkup(){const t=[];for(const e of this._markupArray)e!=null&&e.isMarkupValid()&&t.push(e.toJson());return t}_handleLoadMeasurement(t){return t instanceof Dn?(this.addMeasurement(t),this._callbackManager.trigger("measurementLoaded",t),!0):!1}loadData(t){const e=[];for(const i of t){if(!i.hasOwnProperty("className"))continue;const n=hf(i.className);if(n){const r=n(i,this._viewer);r instanceof Promise?e.push(r.then(o=>this._handleLoadMeasurement(o))):e.push(Promise.resolve(this._handleLoadMeasurement(r)))}}return Promise.all(e)}}const Ph=class Ph{constructor(t,e){this._position=new Vo(0,De.Pixels,0,De.Pixels),this._viewportSize=new Vo(.2,De.MinimumProportionOfCanvas,.2,De.MinimumProportionOfCanvas),this._anchor=je.UpperRightCorner,this._dimension=3,this._fieldSize=8,this._instanceKeys=[],this._enabled=!1,this._textImageId=null,this._selectionFaceColor=new vt(76,186,240),this._outlineColor=new vt(17,94,133),this._lastSelectedNodes=[],this._nodeIds=[],this._adjacentFaces=[],this._preserveModelUp=!0,this._cameraRotation=0,this._lastOrientation=null,this._lastCamera=null,this._lastFaceIndex=null,this._textWidths=[],this._sceneReady=mi(),this._assemblyTreeReady=mi(),this._navcubeReadyToInit=[this._sceneReady,this._assemblyTreeReady],this._texturesReady=!1,this._geometryCreated=!1,this._viewer=t,this._view=e,this._fontSize=25,this._fontInfo=`${this._fontSize}px Arial`,this._textureSize=512,this._viewer.getSceneReady()&&this._sceneReady.resolve(),this._viewer.getModelReady()&&this._assemblyTreeReady.resolve(),this._viewer.setCallbacks({sceneReady:()=>{this._sceneReady.resolve()},_assemblyTreeReady:async()=>{this._assemblyTreeReady.resolve()},_firstAttachment:async()=>{this._onCameraUpdate(),this._updateVisibility()},camera:(i,n)=>{var r;n.id===((r=this._view)==null?void 0:r.id)&&this._onCameraUpdate()},overlayViewportSet:(i,n)=>{var r;n.id===((r=this._view)==null?void 0:r.id)&&i===ye.NavCube&&this._onViewportSet()},transitionEnd:i=>{var n;i.id===((n=this._view)==null?void 0:n.id)&&this._onCameraUpdate()},viewAxes:()=>{this._updateOrientationMatrices()},_resetOpacity:()=>{this._viewer.model.setNodesOpacity(this._nodeIds.slice(1),0)},viewOrientation:(i,n)=>{var r;this._view!==void 0&&n.id===((r=this._view)==null?void 0:r.id)&&(this._lastOrientation=i,this._cameraRotation=0,this._lastCamera=this._view.getCamera())},_drawContextDestroyed:i=>{this._view!==void 0&&i===this._view.id&&delete this._view}}),Promise.all(this._navcubeReadyToInit).then(async()=>{this._createViewport(),this._updateVisibility(),await this._createGeometry(),this._setTextures()})}async setAnchor(t){return this._anchor=t,await this._sceneReady,this._updateViewport()}getAnchor(){return this._anchor}enable(){return this._enabled=!0,this._updateVisibility(),Promise.resolve()}disable(){return this._enabled=!1,this._updateVisibility(),Promise.resolve()}setPreserveModelUp(t){this._preserveModelUp=t}getPreserveModelUp(){return this._preserveModelUp}_updateVisibility(){this._enabled&&this._texturesReady?this._showOverlay():this._hideOverlay()}_hideOverlay(){this._view&&this._view.overlayManager.setVisibility(ye.NavCube,!1)}_showOverlay(){this._view&&this._view.overlayManager.setVisibility(ye.NavCube,!0)}getEnabled(){return this._enabled}getOverlayId(){return ye.NavCube}async _setTextures(){if(!this._textImageId||this._nodeIds.length>0||this._instanceKeys.length<=0)return;const t=this._viewer.model;for(const e of this._instanceKeys){const i=t._getNodeFromInstanceInc(!0,ki.Local,e,!0);this._nodeIds.push(i),t._preventNodeDeletion(i)}t.setNodesOpacity(this._nodeIds.slice(1),0),await t.setNodesTexture([this._nodeIds[0]],{imageId:this._textImageId}),this._texturesReady=!0,this._updateVisibility()}_updateViewport(){if(!this._view)return;this._view.overlayManager.setViewport(ye.NavCube,this._anchor,this._position.x,De.Pixels,this._position.y,De.Pixels,this._viewportSize.x,this._viewportSize.xUnit,this._viewportSize.y,this._viewportSize.yUnit)}_createViewport(){if(!this._view)return;const t=this._view.overlayManager;this._updateViewport();const e=new dn;e.setPosition(new _(0,0,10)),e.setTarget(_.zero()),e.setUp(new _(0,1,0)),e.setWidth(this._fieldSize),e.setHeight(this._fieldSize),e.setProjection(ti.Orthographic),t.setCamera(ye.NavCube,e)}_onViewportSet(){if(!this._view)return;const t=this._view.overlayManager,e=t._getViewportPosition(ye.NavCube),i=t._getViewportSize(ye.NavCube),n=t.getViewportAnchor(ye.NavCube);e===null||i===null||n===null||(this._position=e,this._viewportSize=i,this._anchor=n)}async _createGeometry(){if(this._geometryCreated)return;const t=this._initializeTextures();let e=0;const i=[];i.push(this._createCube(e++,this._dimension));const n=[];n.push(this._makeRotationMatrixX(-.5*Math.PI)),n.push(this._makeRotationMatrixX(.5*Math.PI)),n.push(this._makeRotationMatrixY(.5*Math.PI)),n.push(this._makeRotationMatrixY(-.5*Math.PI)),n.push(this._makeRotationMatrixZ(.5*Math.PI)),n.push(this._makeRotationMatrixZ(-.5*Math.PI));const r=this._dimension/4,o=this._dimension/2,l=-.01,h=[],u=new _(0,0,0);let d=new _(0,0,0),g=new _(0,0,0);for(let x=0;x<n.length;x++){const C=this._dimension,P=n[x];let k=!1;x===n.length-1&&(k=!0,u.z+=this._dimension+.02),d=new _(.5*C-r,-.5*C+r,-.5*C+l),g=new _(d.x+r,d.y-r,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(-.5*C,-.5*C+r,-.5*C+l),g=new _(d.x+r,d.y-r,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(-.5*C,.5*C,-.5*C+l),g=new _(d.x+r,d.y-r,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(.5*C-r,.5*C,-.5*C+l),g=new _(d.x+r,d.y-r,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(-.5*C+r,.5*C,-.5*C+l),g=new _(d.x+o,d.y-r,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(-.5*C+r,-.5*C+r,-.5*C+l),g=new _(d.x+o,d.y-r,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(-.5*C,.5*C-r,-.5*C+l),g=new _(d.x+r,d.y-o,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(.5*C-r,.5*C-r,-.5*C+l),g=new _(d.x+r,d.y-o,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h)),d=new _(-.5*C+r,.5*C-r,-.5*C+l),g=new _(d.x+o,d.y-o,d.z),i.push(this._createSelectionFace(e++,d,g,P,k,u,h))}const y=9;for(let x=0;x<h.length;x++){const C=Math.floor(x/y),P=[],k=h[x];for(let O=0;O<k.length;O+=2){const B=k[O],j=k[O+1];for(let V=0;V<h.length;V++){if(Math.floor(V/y)===C)continue;const q=h[V];for(let st=0;st<q.length;st+=2){const ft=q[st],U=q[st+1];this._isSameEdge(B,j,ft,U)&&P.push(V)}}}this._adjacentFaces.push(P)}const m=await Promise.all(i);this._updateOrientationMatrices(),this._onCameraUpdate();const I=[];for(const x of m)I.push(ki.Local,x);return this._getScEngine().setPartVisibility(I,!0,!0),this._geometryCreated=!0,t}_createTexture(t,e){const n=t.getImageData(0,0,e,e).data,r=new ArrayBuffer(e*e*3),o=new Uint8Array(r);let l=0;for(let u=0;u<n.length;u+=4)o[l]=n[u],o[l+1]=n[u],o[l+2]=n[u],l+=3;return this._viewer.model.createImage({format:cs.Rgb24,data:o,width:this._textureSize,height:this._textureSize})}_geometryHasBeenCreated(){return this._geometryCreated}insideOverlay(t){if(!this._view)return!1;const e=this._view.overlayManager._toPixelPoint(this._viewportSize),i=this._getOverlayOffset();return t.x>=i.x&&t.y>=i.y&&t.x<=i.x+e.x&&t.y<=i.y+e.y}_getOverlayOffset(){if(!this._view)return K.zero();const t=this._view.overlayManager._toPixelPoint(this._viewportSize);return this._view.overlayManager._getOverlayOffset(this._anchor,t)}_getViewportSize(){return this._viewportSize}_getViewportPixelSize(){return this._view?this._view.overlayManager._toPixelPoint(this._viewportSize):K.zero()}_onNoSelection(){this._enabled&&this._lastSelectedNodes.length>0&&(this._viewer.model.setNodesOpacity(this._lastSelectedNodes,0),this._lastSelectedNodes.length=0)}async onClickSelection(t){if(console.assert(this._enabled),t===null||!t.isFaceSelection()||t.overlayIndex()!==ye.NavCube){this._onNoSelection();return}const e=this._getFaceIndexFromNodeId(t.getNodeId());e<this._nodeIds.length&&e>0&&await this._setViewOrientation(e)}onMoveSelection(t){if(console.assert(this._enabled),t===null||!t.isFaceSelection()||t.overlayIndex()!==ye.NavCube){this._onNoSelection();return}const e=t.getNodeId(),i=this._getFaceIndexFromNodeId(e)-1;i>=0&&e!==this._nodeIds[0]&&this._viewer.pauseRendering(()=>{const n=this._viewer.model;n.setNodesOpacity(this._lastSelectedNodes,0),this._lastSelectedNodes.length=0,this._lastSelectedNodes.push(e),console.assert(i<this._adjacentFaces.length);const r=this._adjacentFaces[i];for(const o of r){const l=o+1,h=this._getNodeIdFromFaceIndex(l);this._lastSelectedNodes.push(h)}n.setNodesOpacity(this._lastSelectedNodes,1)})}_getViewOrientationFromFaceIndex(t){let e=Ct.Front;switch(t){case 1:e=Ct.LeftBottomBack;break;case 2:e=Ct.LeftBottomFront;break;case 3:e=Ct.LeftTopFront;break;case 4:e=Ct.LeftTopBack;break;case 5:e=Ct.LeftTop;break;case 6:e=Ct.LeftBottom;break;case 7:e=Ct.LeftFront;break;case 8:e=Ct.LeftBack;break;case 9:e=Ct.Left;break;case 10:e=Ct.RightTopBack;break;case 11:e=Ct.RightTopFront;break;case 12:e=Ct.RightBottomFront;break;case 13:e=Ct.RightBottomBack;break;case 14:e=Ct.RightBottom;break;case 15:e=Ct.RightTop;break;case 16:e=Ct.RightFront;break;case 17:e=Ct.RightBack;break;case 18:e=Ct.Right;break;case 19:e=Ct.BackTopRight;break;case 20:e=Ct.BackBottomRight;break;case 21:e=Ct.BackBottomLeft;break;case 22:e=Ct.BackTopLeft;break;case 23:e=Ct.BackLeft;break;case 24:e=Ct.BackRight;break;case 25:e=Ct.BackBottom;break;case 26:e=Ct.BackTop;break;case 27:e=Ct.Back;break;case 28:e=Ct.FrontBottomRight;break;case 29:e=Ct.FrontTopRight;break;case 30:e=Ct.FrontTopLeft;break;case 31:e=Ct.FrontBottomLeft;break;case 32:e=Ct.FrontLeft;break;case 33:e=Ct.FrontRight;break;case 34:e=Ct.FrontTop;break;case 35:e=Ct.FrontBottom;break;case 36:e=Ct.Front;break;case 37:e=Ct.BottomRightFront;break;case 38:e=Ct.BottomLeftFront;break;case 39:e=Ct.BottomLeftBack;break;case 40:e=Ct.BottomRightBack;break;case 41:e=Ct.BottomBack;break;case 42:e=Ct.BottomFront;break;case 43:e=Ct.BottomLeft;break;case 44:e=Ct.BottomRight;break;case 45:e=Ct.Bottom;break;case 46:e=Ct.TopLeftBack;break;case 47:e=Ct.TopRightBack;break;case 48:e=Ct.TopRightFront;break;case 49:e=Ct.TopLeftFront;break;case 50:e=Ct.TopFront;break;case 51:e=Ct.TopBack;break;case 52:e=Ct.TopRight;break;case 53:e=Ct.TopLeft;break;case 54:e=Ct.Top;break;default:e=Ct.Front}return e}async _setViewOrientation(t){const e=this._view;if(e===void 0)return;const i=this._getViewOrientationFromFaceIndex(t),n=await e.getViewOrientationCamera(i,void 0,this._preserveModelUp);let r=!1;console.assert(t-1>=0),console.assert(t-1<this._adjacentFaces.length);const o=this._adjacentFaces[t-1];for(const d of o)if(d+1===this._lastFaceIndex){r=!0;break}this._lastFaceIndex=t;const l=this._lastCamera!==null&&this._lastCamera.equals(e.getCamera());if((this._lastOrientation===i||r)&&l?this._cameraRotation=this._preserveModelUp?(this._cameraRotation+90)%360:90:this._cameraRotation=0,this._lastOrientation=i,this._cameraRotation>0){const d=_.subtract(n.getPosition(),n.getTarget()).normalize(),g=_t.createFromOffAxisRotation(d,this._cameraRotation),y=n.getUp();g.transform(y,y),n.setUp(y)}await e.fitWorld(Yn,n);const u=this._viewer.model.getAbsoluteRootNode();if(this._viewer.model.getNodeChildren(u).length===0)return this._getScEngine().markCameraAsEmpty(e.id);this._lastCamera=e.getCamera()}_getScEngine(){return this._viewer._getScEngine()}async _createInstance(t,e){var h;const i=await this._viewer.model.createMesh(t),n=new Ns(i);if(n.setCreationFlags(ie.DoNotCut|ie.DoNotExplode|ie.ExcludeBounding|ie.DoNotLight|ie.Invisible),!this._view)throw Error("Impossible to create a navcube without an associated view");n.overlayId={viewKey:(h=this._view)==null?void 0:h.id,overayIndex:ye.NavCube};const l=(await this._getScEngine().createMeshInstance(n))[1];return this._instanceKeys[e]=l,l}_createCube(t,e){const i=[],n=[],r=[],o=[];let l=this._textWidths[0];for(const O of this._textWidths)O>l&&(l=O);l+=10,i.push(new _(.5*e,.5*e,.5*e)),i.push(new _(-.5*e,.5*e,-.5*e)),i.push(new _(-.5*e,.5*e,.5*e)),i.push(new _(.5*e,.5*e,-.5*e)),i.push(new _(-.5*e,.5*e,-.5*e)),i.push(new _(.5*e,.5*e,.5*e)),n.push(new _(0,1,0)),n.push(new _(0,1,0)),n.push(new _(0,1,0)),n.push(new _(0,1,0)),n.push(new _(0,1,0)),n.push(new _(0,1,0));const h=60;let u=22/this._textureSize,d=(22+h)/this._textureSize;u=1-u,d=1-d;let g=(l-this._textWidths[0])/2,y=-(g/this._textureSize),m=(this._textWidths[0]+g)/this._textureSize;r.push(new K(y,u)),r.push(new K(m,d)),r.push(new K(m,u)),r.push(new K(y,d)),r.push(new K(m,d)),r.push(new K(y,u)),o.push(new _(-.5*e,.5*e,-.5*e)),o.push(new _(.5*e,.5*e,-.5*e)),o.push(new _(.5*e,.5*e,-.5*e)),o.push(new _(.5*e,.5*e,.5*e)),o.push(new _(.5*e,.5*e,.5*e)),o.push(new _(-.5*e,.5*e,.5*e)),o.push(new _(-.5*e,.5*e,.5*e)),o.push(new _(-.5*e,.5*e,-.5*e)),i.push(new _(-.5*e,-.5*e,.5*e)),i.push(new _(-.5*e,-.5*e,-.5*e)),i.push(new _(.5*e,-.5*e,.5*e)),i.push(new _(.5*e,-.5*e,.5*e)),i.push(new _(-.5*e,-.5*e,-.5*e)),i.push(new _(.5*e,-.5*e,-.5*e)),n.push(new _(0,-1,0)),n.push(new _(0,-1,0)),n.push(new _(0,-1,0)),n.push(new _(0,-1,0)),n.push(new _(0,-1,0)),n.push(new _(0,-1,0)),u-=h/this._textureSize,d-=h/this._textureSize,g=(l-this._textWidths[1])/2,y=-(g/this._textureSize),m=(this._textWidths[1]+g)/this._textureSize,r.push(new K(y,u)),r.push(new K(y,d)),r.push(new K(m,u)),r.push(new K(m,u)),r.push(new K(y,d)),r.push(new K(m,d)),o.push(new _(-.5*e,-.5*e,-.5*e)),o.push(new _(.5*e,-.5*e,-.5*e)),o.push(new _(.5*e,-.5*e,-.5*e)),o.push(new _(.5*e,-.5*e,.5*e)),o.push(new _(.5*e,-.5*e,.5*e)),o.push(new _(-.5*e,-.5*e,.5*e)),o.push(new _(-.5*e,-.5*e,.5*e)),o.push(new _(-.5*e,-.5*e,-.5*e)),i.push(new _(-.5*e,.5*e,.5*e)),i.push(new _(-.5*e,.5*e,-.5*e)),i.push(new _(-.5*e,-.5*e,-.5*e)),i.push(new _(-.5*e,.5*e,.5*e)),i.push(new _(-.5*e,-.5*e,-.5*e)),i.push(new _(-.5*e,-.5*e,.5*e)),n.push(new _(-1,0,0)),n.push(new _(-1,0,0)),n.push(new _(-1,0,0)),n.push(new _(-1,0,0)),n.push(new _(-1,0,0)),n.push(new _(-1,0,0)),u-=h/this._textureSize,d-=h/this._textureSize,g=(l-this._textWidths[2])/2,y=-(g/this._textureSize),m=(this._textWidths[2]+g)/this._textureSize,r.push(new K(y,u)),r.push(new K(y,d)),r.push(new K(m,d)),r.push(new K(y,u)),r.push(new K(m,d)),r.push(new K(m,u)),o.push(new _(-.5*e,.5*e,-.5*e)),o.push(new _(-.5*e,.5*e,.5*e)),o.push(new _(-.5*e,.5*e,.5*e)),o.push(new _(-.5*e,-.5*e,.5*e)),o.push(new _(-.5*e,-.5*e,.5*e)),o.push(new _(-.5*e,-.5*e,-.5*e)),o.push(new _(-.5*e,-.5*e,-.5*e)),o.push(new _(-.5*e,.5*e,-.5*e)),i.push(new _(.5*e,.5*e,.5*e)),i.push(new _(.5*e,-.5*e,-.5*e)),i.push(new _(.5*e,.5*e,-.5*e)),i.push(new _(.5*e,.5*e,.5*e)),i.push(new _(.5*e,-.5*e,.5*e)),i.push(new _(.5*e,-.5*e,-.5*e)),n.push(new _(1,0,0)),n.push(new _(1,0,0)),n.push(new _(1,0,0)),n.push(new _(1,0,0)),n.push(new _(1,0,0)),n.push(new _(1,0,0)),u-=h/this._textureSize,d-=h/this._textureSize,g=(l-this._textWidths[3])/2,y=-(g/this._textureSize),m=(this._textWidths[3]+g)/this._textureSize,r.push(new K(m,u)),r.push(new K(y,d)),r.push(new K(m,d)),r.push(new K(m,u)),r.push(new K(y,u)),r.push(new K(y,d)),o.push(new _(.5*e,.5*e,-.5*e)),o.push(new _(.5*e,.5*e,.5*e)),o.push(new _(.5*e,.5*e,.5*e)),o.push(new _(.5*e,-.5*e,.5*e)),o.push(new _(.5*e,-.5*e,.5*e)),o.push(new _(.5*e,-.5*e,-.5*e)),o.push(new _(.5*e,-.5*e,-.5*e)),o.push(new _(.5*e,.5*e,-.5*e)),i.push(new _(.5*e,-.5*e,-.5*e)),i.push(new _(-.5*e,-.5*e,-.5*e)),i.push(new _(-.5*e,.5*e,-.5*e)),i.push(new _(.5*e,.5*e,-.5*e)),i.push(new _(.5*e,-.5*e,-.5*e)),i.push(new _(-.5*e,.5*e,-.5*e)),n.push(new _(0,0,-1)),n.push(new _(0,0,-1)),n.push(new _(0,0,-1)),n.push(new _(0,0,-1)),n.push(new _(0,0,-1)),n.push(new _(0,0,-1)),u-=h/this._textureSize,d-=h/this._textureSize,g=(l-this._textWidths[4])/2,y=-(g/this._textureSize),m=(this._textWidths[4]+g)/this._textureSize,r.push(new K(y,u)),r.push(new K(y,d)),r.push(new K(m,d)),r.push(new K(m,u)),r.push(new K(y,u)),r.push(new K(m,d)),i.push(new _(-.5*e,.5*e,.5*e)),i.push(new _(-.5*e,-.5*e,.5*e)),i.push(new _(.5*e,-.5*e,.5*e)),i.push(new _(-.5*e,.5*e,.5*e)),i.push(new _(.5*e,-.5*e,.5*e)),i.push(new _(.5*e,.5*e,.5*e)),n.push(new _(0,0,1)),n.push(new _(0,0,1)),n.push(new _(0,0,1)),n.push(new _(0,0,1)),n.push(new _(0,0,1)),n.push(new _(0,0,1)),u-=h/this._textureSize,d-=h/this._textureSize,g=(l-this._textWidths[5])/2,y=-(g/this._textureSize),m=(this._textWidths[5]+g)/this._textureSize,r.push(new K(y,d)),r.push(new K(m,d)),r.push(new K(m,u)),r.push(new K(y,d)),r.push(new K(m,u)),r.push(new K(y,u));const I=new rs;I.setFaceWinding(Rs.CounterClockwise);let b=[],x=[],C=[],P=0;for(let O=0;O<i.length;O++){const B=i[O];b.push(B.x),b.push(B.y),b.push(B.z);const j=n[O];x.push(j.x),x.push(j.y),x.push(j.z);const V=r[O];if(C.push(V.x),C.push(V.y),b.length>=18){const q=[[0,255,0,255],[0,255,0,255],[255,0,0,255],[255,0,0,255],[0,0,255,255],[0,0,255,255]][P],st=[];for(let ft=0;ft<6;ft++)st.push(q[0]),st.push(q[1]),st.push(q[2]),st.push(q[3]);I.addFaces(b,x,new Uint8Array(st),C),b=[],x=[],C=[],++P}}b=[];const k=new Uint8Array(4*o.length);for(let O=0;O<o.length;O++){const B=o[O];b.push(B.x),b.push(B.y),b.push(B.z);const j=4*O;k[j]=this._outlineColor.r,k[j+1]=this._outlineColor.g,k[j+2]=this._outlineColor.b,k[j+3]=255}return I.addPolyline(b,k),this._createInstance(I,t)}_onCameraUpdate(){if(this._view===void 0)return;const t=new dn,e=this._view.getCamera();t.setPosition(e.getPosition().subtract(e.getTarget()).normalize()),t.setTarget(_.zero()),t.setUp(e.getUp()),t.setProjection(ti.Orthographic),t.setWidth(this._fieldSize),t.setHeight(this._fieldSize),this._view.overlayManager.setCamera(ye.NavCube,t)}_updateOrientationMatrices(){const e=this._viewer.model.getViewAxes(),i=e.upVector.copy(),n=e.frontVector.copy(),r=_.cross(i,n.copy().scale(-1)),o=new _t;o.m[0]=-n.x,o.m[1]=-n.y,o.m[2]=-n.z,o.m[4]=r.x,o.m[5]=r.y,o.m[6]=r.z,o.m[8]=i.x,o.m[9]=i.y,o.m[10]=i.z;const l=this._getScEngine(),h=[];for(const u of this._instanceKeys)h.push(ki.Local,u);l.setInstancesMatrix(h,o)}_createSelectionFace(t,e,i,n,r,o,l){const h=new rs;h.setFaceWinding(Rs.CounterClockwise);const u=[];this._createQuad(e,i,u,n,o,r);let d=[],g=[],y=[];for(const x of u)d.push(x.x),d.push(x.y),d.push(x.z),g.push(0),g.push(0),g.push(-1),y.push(this._selectionFaceColor.r),y.push(this._selectionFaceColor.g),y.push(this._selectionFaceColor.b),y.push(128);const m=[],I=[this._outlineColor.r,this._outlineColor.g,this._outlineColor.b,255,this._outlineColor.r,this._outlineColor.g,this._outlineColor.b,255];h.addFaces(d,g,new Uint8Array(y)),d=[],g=[],y=[];let b=[];return r?(b.push(u[4].x,u[4].y,u[4].z),b.push(u[5].x,u[5].y,u[5].z)):(b.push(u[0].x,u[0].y,u[0].z),b.push(u[1].x,u[1].y,u[1].z)),h.addPolyline(b,new Uint8Array(I)),m.push(new _(b[0],b[1],b[2]),new _(b[3],b[4],b[5])),b=[],b.push(u[1].x,u[1].y,u[1].z),b.push(u[2].x,u[2].y,u[2].z),h.addPolyline(b,new Uint8Array(I)),m.push(new _(b[0],b[1],b[2]),new _(b[3],b[4],b[5])),b=[],b.push(u[3].x,u[3].y,u[3].z),b.push(u[4].x,u[4].y,u[4].z),h.addPolyline(b,new Uint8Array(I)),m.push(new _(b[0],b[1],b[2]),new _(b[3],b[4],b[5])),b=[],r?(b.push(u[3].x,u[3].y,u[3].z),b.push(u[2].x,u[2].y,u[2].z)):(b.push(u[5].x,u[5].y,u[5].z),b.push(u[3].x,u[3].y,u[3].z)),h.addPolyline(b,new Uint8Array(I)),m.push(new _(b[0],b[1],b[2]),new _(b[3],b[4],b[5])),b=[],l.push(m),this._createInstance(h,t)}_createQuad(t,e,i,n,r,o=!1){const l=new _(t.x,t.y,t.z),h=new _(e.x,e.y,e.z);r&&(l.x+=r.x,l.y+=r.y,l.z+=r.z,h.x+=r.x,h.y+=r.y,h.z+=r.z);const u=i.length;let d=new _(h.x,h.y,l.z),g=n.transform(d);if(i.push(g),d=new _(l.x,h.y,l.z),g=n.transform(d),i.push(g),d=new _(l.x,l.y,l.z),g=n.transform(d),i.push(g),d=new _(h.x,l.y,l.z),g=n.transform(d),i.push(g),d=new _(h.x,h.y,l.z),g=n.transform(d),i.push(g),d=new _(l.x,l.y,l.z),g=n.transform(d),i.push(g),o)for(let y=0;y<3;y++){const m=u+y,I=i[u+y],b=new _(I.x,I.y,I.z),x=u+(6-y-1);i[m].x=i[x].x,i[m].y=i[x].y,i[m].z=i[x].z,i[x].x=b.x,i[x].y=b.y,i[x].z=b.z}}_makeRotationMatrixX(t){const e=Math.cos(t),i=Math.sin(t),n=new _t;return n.m[5]=e,n.m[6]=-i,n.m[9]=i,n.m[10]=e,n}_makeRotationMatrixY(t){const e=Math.cos(t),i=Math.sin(t),n=new _t;return n.m[0]=e,n.m[2]=i,n.m[8]=-i,n.m[10]=e,n}_makeRotationMatrixZ(t){const e=Math.cos(t),i=Math.sin(t),n=new _t;return n.m[0]=e,n.m[1]=-i,n.m[4]=i,n.m[5]=e,n}_getFaceIndexFromNodeId(t){for(let e=0;e<this._nodeIds.length;e++)if(this._nodeIds[e]===t)return e;return-1}_getNodeIdFromFaceIndex(t){return this._nodeIds[t]}_isSameEdge(t,e,i,n){const r=_.subtract(t,i).squaredLength()+_.subtract(e,n).squaredLength(),o=_.subtract(e,i).squaredLength()+_.subtract(t,n).squaredLength();return Math.min(r,o)<.03}async _initializeTextures(){const t=document.createElement("canvas");t.width=this._textureSize,t.height=this._textureSize;const e=t.getContext("2d"),i=2*(this._fontSize+5);e.beginPath(),e.rect(0,0,this._textureSize,this._textureSize),e.fillStyle="gray",e.fill(),e.fillStyle="black",e.font=this._fontInfo;for(let r=0;r<Ph._faceTexts.length;r++){const o=Ph._faceTexts[r];e.fillText(o,0,i*(r+1));const l=e.measureText(o);this._textWidths.push(l.width)}const n=await this._createTexture(e,this._textureSize);this._textImageId=n}};Ph._faceTexts=["LEFT","RIGHT","FRONT","BACK","BOTTOM","TOP"];let ad=Ph;class dy{constructor(t){this._operatorStack=[],this._operators=new Map,this._customOperatorIdCount=0,this._customOperatorIdIndex=1e4,this._mergeableEvents=[le.MouseMove,le.Mousewheel,le.TouchMove,le.KeyUp,le.KeyDown],this._eventSequencePromise=Promise.resolve(),this._events=[],this._viewer=t,this._viewer.setCallbacks({_resetAssemblyTreeBegin:async()=>{const e=[];return this._operators.forEach((i,n)=>{let r;r=this._deactivateOperator(n),r!==void 0&&e.push(r),r=this._activateOperator(n),r!==void 0&&e.push(r)}),Ue(e)}})}_shutdown(){for(;this.pop()!==void 0;);}_registerOperator(t,e){this._operators.set(t,e)}registerCustomOperator(t){const e=this._customOperatorIdIndex+this._customOperatorIdCount++;return this._operators.set(e,t),e}unregisterCustomOperator(t){t>=this._customOperatorIdIndex&&this._operators.delete(t)}replaceOperator(t,e){const i=this.getOperator(e);return i!==null?(this._operators.set(t,i),!0):!1}indexOf(t){for(let e=this.size()-1;e>=0;e--)if(this._operatorStack[e]===t)return e;return-1}push(t){return this._isValid(t)&&!this._contains(t)?(this._operatorStack.push(t),this._activateOperator(t),!0):!1}set(t,e){const i=this._operatorStack[e];return t===i?!1:this._isValid(t)&&!this._contains(t)?(this._deactivateOperator(i),this._activateOperator(t),this._operatorStack[e]=t,!0):!1}pop(){const t=this._operatorStack.pop();return t!==void 0&&this._deactivateOperator(t),t}remove(t){const e=this.indexOf(t);e!==-1&&(this._operatorStack.splice(e,1),this._deactivateOperator(t))}peek(){return this.size()>0?this._operatorStack[this.size()-1]:_e.Invalid}get(t){return t<0||t>=this._operatorStack.length?_e.Invalid:this._operatorStack[t]}clear(){for(let t=this.size()-1;t>=0;t--)this.pop()}size(){return this._operatorStack.length}getOperator(t){return this._operators.get(t)??null}async _injectEvent(t,e){for(let i=this.size()-1;i>=0;i--){const n=this._operators.get(this._operatorStack[i]);if(n!==void 0)try{switch(e){case le.KeyDown:n.onKeyDown&&await n.onKeyDown(t);break;case le.KeyUp:n.onKeyUp&&await n.onKeyUp(t);break;case le.MouseDown:n.onMouseDown&&await n.onMouseDown(t);break;case le.MouseMove:n.onMouseMove&&await n.onMouseMove(t);break;case le.MouseUp:n.onMouseUp&&await n.onMouseUp(t);break;case le.Mousewheel:n.onMousewheel&&await n.onMousewheel(t);break;case le.TouchStart:n.onTouchStart&&await n.onTouchStart(t);break;case le.TouchMove:n.onTouchMove&&await n.onTouchMove(t);break;case le.TouchEnd:n.onTouchEnd&&await n.onTouchEnd(t);break;case le.ViewOrientationChange:n.onViewOrientationChange&&await n.onViewOrientationChange();break;default:Tr(e)}}catch(r){r instanceof ho||console.log(r)}if(t.getHandled()){(e===le.MouseUp||e===le.TouchEnd)&&await this._stopInteraction();break}}}async injectEvent(t,e){return this._addOrMergeEventToQueue(t,e,t.viewKey),this._eventSequencePromise=this._eventSequencePromise.then(async()=>{await this._injectNextEvent()}),this._eventSequencePromise}_addOrMergeEventToQueue(t,e,i){let n=!1;if(this._mergeableEvents.indexOf(e)!==-1)for(let r=0;r<this._events.length;r++){const o=this._events[r];if(!(e!==o.eventType||i!==o.event.viewKey)&&!((e===le.KeyDown||e===le.KeyUp)&&t.getKeyCode()!==o.event.getKeyCode())&&!(e===le.TouchMove&&t.getId()!==o.event.getId())){o.event=t,n=!0;break}}n||this._events.push({event:t,eventType:e})}async _injectNextEvent(){const t=this._events.shift();t!==void 0&&await this._injectEvent(t.event,t.eventType)}async _stopInteraction(){const t=[];for(let e=this.size()-1;e>=0;e--){const i=this._operators.get(this._operatorStack[e]);if(i!=null&&i.stopInteraction){const n=i.stopInteraction();n!==void 0&&t.push(n)}}return Ue(t)}_injectViewOrientationChangeEvent(){for(let t=this.size()-1;t>=0;t--){const e=this._operators.get(this._operatorStack[t]);e!=null&&e.onViewOrientationChange&&e.onViewOrientationChange()}}_isValid(t){return this._operators.has(t)||t===_e.None}_contains(t){return this.indexOf(t)!==-1}_activateOperator(t){const e=this._operators.get(t);if(e!=null&&e.onActivate)return e.onActivate()}_deactivateOperator(t){const e=this._operators.get(t);if(e!=null&&e.onDeactivate)return e.onDeactivate()}}class fy{constructor(t,e,i,n){this._activeSheetId=null,this._backgroundSheetMeshId=null,this._sheetIds=[null,null,null],this._backgroundSheetEnabled=!1,this._backgroundSelectionEnabled=!1,this._backgroundColor=new vt(180,180,180),this._sheetColor=vt.white(),this._sheetShadowColor=new vt(75,75,75),this._viewer=t,this._engine=e,this._callbackManager=i;const r=async()=>{if(!this._viewer.model.isDrawing())return;const o=this._viewer.sheetManager.getActiveSheetId();if(o==null){await this.deactivateSheets(!1);const l=this.getSheetIds();this.get3DNodes().length===0&&l.length>0&&await this.setActiveSheetId(l[0],!0,!0)}else await this._activateSheetId(o,!0,!0)};this._viewer.setCallbacks({_modelStructureHeaderParsed:async()=>{if(this._viewer.model.isDrawing()&&!n)return this.setBackgroundSheetEnabled(!0)},_firstModelLoaded:async()=>{await r()},_resetAssemblyTreeBegin:async()=>{await this.setBackgroundSheetEnabled(!1),await this.setBackgroundSelectionEnabled(!1),this._activeSheetId=null,this._backgroundSheetMeshId=null;const o=this._viewer.view,l=o.getBackgroundColor();o.setBackgroundColor(l.top,l.bottom)},_resetDrawing:async()=>{await r()}})}getSheetIds(){const t=this._viewer.model,e=n=>{let r=[];const o=t.getNodeChildren(n);for(const l of o)r=r.concat(e(l));return t.getNodeType(n)===Ne.DrawingSheet&&r.push(n),r},i=t.getAbsoluteRootNode();return e(i)}get3DNodes(){const t=this._viewer.model,e=t.getAbsoluteRootNode(),i=t.getNodeChildren(e),n=t.getNodeChildren(i[0]),r=t.getNodeChildren(n[0]),o=[];for(const l of r)t.getNodeType(l)!==Ne.DrawingSheet&&o.push(l);return o}async deactivateSheets(t=!0,e=!1){this._activeSheetId=null,this._viewer.pauseRendering();const i=this.get3DNodes(),n=e?!1:i.length>0;await this._viewer.view.isolateNodes(i,0,n),await this._refreshBackgroundSheets();const r=this._viewer.view,o=r.getBackgroundColor();r.setBackgroundColor(o.top,o.bottom),this._viewer.resumeRendering(),t&&this._callbackManager.trigger("sheetDeactivated")}async setActiveSheetId(t,e=!0,i=!0){this._activeSheetId!==t&&(this._activeSheetId=t,await this._activateSheetId(t,e,i))}async _activateSheetId(t,e,i){await this._markupManager._setActiveMarkupView(this._viewer.view,null),e&&(this._viewer.pauseRendering(),await this._viewer.view.isolateNodes([t],0,i),await this._refreshBackgroundSheets(),this._viewer.resumeRendering()),this._callbackManager.trigger("sheetActivated",this._activeSheetId)}getActiveSheetId(){return this._activeSheetId}isDrawingSheetActive(){return this._viewer.model.isDrawing()&&this._activeSheetId!==null}setMarkupManager(t){this._markupManager=t}async _createBackgroundSheetMesh(){const t=[0,0,0,1,0,0,0,1,0,0,1,0,1,0,0,1,1,0],e=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],i=new rs;return i.addFaces(t,e),i.setBackfacesEnabled(!0),this._viewer.model.createMesh(i)}_createBackgroundSheetMatrix(t,e){const i=t.min,n=t.max,r=this._viewer.view.getCamera(),o=r.getPosition(),l=r.getTarget(),h=_.subtract(l,o);let u=n.x-i.x,d=n.y-i.y;const g=Math.max(.1*u,.1*(n.z-i.z)),y=i.x+.5*u,m=i.y+.5*d,I=.05,b=Math.max(u*I,d*I);u+=b,d+=b;let x=y-.5*u,C=m-.5*d,P=h.z>0?n.z+g:i.z-g;if(e){const O=r.getUp();let B=.3*b;x+=B,O.y>0&&(B=-B),C+=B,P+=h.z>0?g:-g}const k=new _t;return k.setTranslationComponent(x,C,P),k.setScaleComponent(u,d,1),k}async _createBackgroundSheetInstance(t,e,i,n,r,o){let l=ie.DoNotExplode|ie.DoNotCut|ie.OverrideSceneVisibility|ie.DoNotLight|ie.DoNotOutlineHighlight|ie.AlwaysDraw|ie.ExcludeBounding;o||(l|=ie.DoNotSelect);const h=new Ns(t,i,e,n,null,null,l),u=await this._viewer.model.createMeshInstance(h,null,!1,!0);return this._viewer.model.setNodesOpacity([u],r),u}async _deleteBackgroundSheetInstances(t=[0,2,1]){const e=[];for(const i of t){const n=this._sheetIds[i];n!==null&&(this._sheetIds[i]=null,e.push(n))}if(e.length>0)return this._viewer.model.deleteMeshInstances(e)}async _createOrUpdateSheet(t,e,i,n,r,o){const l=this._viewer.model;if(this._sheetIds[t]===null)return this._sheetIds[t]=await this._createBackgroundSheetInstance(this._backgroundSheetMeshId,e,i,n,r,o),Promise.resolve();{const h=this._sheetIds[t];return l.setNodesFaceColor([h],n),l.setNodesOpacity([h],r),o!==null&&l.setInstanceModifier($i.DoNotSelect,[h],!o),l.setNodeMatrix(h,i,!0)}}async _refreshBackgroundSheets(){const t=this._viewer.model;if(!this.isDrawingSheetActive())return this._backgroundSelectionEnabled=!1,this._deleteBackgroundSheetInstances();this._backgroundSheetMeshId===null&&(this._backgroundSheetMeshId=await this._createBackgroundSheetMesh());const e=await t.getModelBounding(!0,!1),i=this._createBackgroundSheetMatrix(e,!1),n=[];this._backgroundSelectionEnabled?await this._createOrUpdateSheet(2,"2d_drawing_background_selection_sheet",i,vt.black(),0,!0):n.push(2);for(const r of this._viewer.views)this._engine.setBackgroundGradient(r.id,this._backgroundColor,this._backgroundColor);if(this._backgroundSheetEnabled){const r=this._createBackgroundSheetMatrix(e,!0);await this._createOrUpdateSheet(0,"2d_drawing_background_sheet",i,this._sheetColor,1,!1),await this._createOrUpdateSheet(1,"2d_drawing_background_shadow_sheet",r,this._sheetShadowColor,1,!1)}else n.push(0,1);if(n.length>0)return this._deleteBackgroundSheetInstances(n)}setSheetColors(t,e,i){return this._backgroundColor=t.copy(),this._sheetColor=e.copy(),this._sheetShadowColor=i.copy(),this._refreshBackgroundSheets()}getSheetBackgroundColor(){return this._backgroundColor}getSheetColor(){return this._sheetColor}getSheetShadowColor(){return this._sheetShadowColor}async setBackgroundSheetEnabled(t){t!==this._backgroundSheetEnabled&&(this._backgroundSheetEnabled=t,this._viewer.pauseRendering(),await this._refreshBackgroundSheets(),this._viewer.resumeRendering())}getBackgroundSheetEnabled(){return this._backgroundSheetEnabled}async setBackgroundSelectionEnabled(t){this.isDrawingSheetActive()||(t=!1),t!==this._backgroundSelectionEnabled&&(this._backgroundSelectionEnabled=t,this._viewer.pauseRendering(),await this._refreshBackgroundSheets(),this._viewer.resumeRendering())}getBackgroundSelectionEnabled(){return this._backgroundSelectionEnabled}async startComparison(t,e,i){const n=this._viewer.view;n.startComparison([t],[e],i),await this.setActiveSheetId(t,!1,!1),await n.isolateNodes([t,e],0,!0),await this._refreshBackgroundSheets()}async endComparison(){this._activeSheetId!==null&&(await this.setActiveSheetId(this._activeSheetId,!0,!1),this._viewer.view.endComparison())}}class gy{constructor(t=0,e=0,i=gl.All,n=ke.Default){this.viewKey=n,this.width=t,this.height=e,this.layers=i}}class dg{constructor(){this.svgXmlPrologEnabled=!0,this.svgBackgroundCssColor="",this.silhouettesEnabled=!0,this.linesDrawModelLinesEnabled=!0,this.linesStrokeWidth=20,this.linesCssColor="#000000",this.linesClipProximityToPlane=5.5,this.linesClipZNudgeFactor=5.5,this.polygonsForceDrawCssColor="",this.logProgress=!1,this.logDiagnostics=!1}}class fg{constructor(t,e){this.top=t,this.bottom=e}}class Gb{constructor(t,e){this._callbackManager=t,this._operatorManager=e,this._contextEventChecker=new $b(this._callbackManager)}injectMouseDownEvent(t,e,i,n,r,o){const l=new Vr(t,e,i,n,r,Xs.Down,o),h=le.MouseDown;this._callbackManager.trigger("_inputInteraction",l,h),this._operatorManager.injectEvent(l,h),this._contextEventChecker.onMouseDownEvent(l)}injectMouseMoveEvent(t,e,i,n,r,o){const l=new Vr(t,e,i,n,r,Xs.Move,o),h=le.MouseMove;this._callbackManager.trigger("_inputInteraction",l,h),this._operatorManager.injectEvent(l,h)}injectMouseUpEvent(t,e,i,n,r,o){const l=new Vr(t,e,i,n,r,Xs.Up,o),h=le.MouseUp;this._callbackManager.trigger("_inputInteraction",l,h),this._operatorManager.injectEvent(l,h),this._contextEventChecker.onMouseUpEvent(l)}injectMousewheelEvent(t,e,i,n,r,o){const l=new r_(t,e,i,n,r,Xs.Wheel,o),h=le.Mousewheel;this._callbackManager.trigger("_inputInteraction",l,h),this._operatorManager.injectEvent(l,h)}injectKeyDownEvent(t,e,i){const n=new Gf(t,e,Eu.Down,i),r=le.KeyDown;this._callbackManager.trigger("_inputInteraction",n,r),this._operatorManager.injectEvent(n,r)}injectKeyUpEvent(t,e,i){const n=new Gf(t,e,Eu.Up,i),r=le.KeyUp;this._callbackManager.trigger("_inputInteraction",n,r),this._operatorManager.injectEvent(n,r)}injectTouchStartEvent(t,e,i,n,r){const o=new td(t,e,i,n,jc.Start,r),l=le.TouchStart;this._callbackManager.trigger("_inputInteraction",o,l),this._operatorManager.injectEvent(o,l),this._contextEventChecker.onTouchStartEvent(o)}injectTouchMoveEvent(t,e,i,n,r){const o=new td(t,e,i,n,jc.Start,r),l=le.TouchMove;this._callbackManager.trigger("_inputInteraction",o,l),this._operatorManager.injectEvent(o,l),this._contextEventChecker.onTouchMoveEvent(o)}injectTouchEndEvent(t,e,i,n,r){const o=new td(t,e,i,n,jc.End,r),l=le.TouchEnd;this._callbackManager.trigger("_inputInteraction",o,l),this._operatorManager.injectEvent(o,l),this._contextEventChecker.onTouchEndEvent(o)}injectViewOrientationChangeEvent(t){this._operatorManager._injectViewOrientationChangeEvent()}}class $b{constructor(t){this._contextMenuMouseButton=Me.Right,this._contextMenuPositionStart=K.zero(),this._touchTimer=new Mo,this._activeTouchCount=0,this._initialPosition=K.zero(),this._callbackManager=t}onMouseDownEvent(t){t.getHandled()||this._contextMenuPositionStart.assign(t.getPosition())}onMouseUpEvent(t){if(!t.getHandled()){const e=t.getPosition();t.getButton()===this._contextMenuMouseButton&&this._contextMenuPositionStart.equals(e)&&this._callbackManager.trigger("contextMenu",e,t.getModifiers())}}onTouchStartEvent(t){const e=t.getPosition().copy();this._activeTouchCount===0&&(this._initialPosition=e),++this._activeTouchCount,t.getHandled()||this._touchTimer.set(600,()=>{this._callbackManager.trigger("contextMenu",e,_i.None)})}onTouchMoveEvent(t){if(!this._touchTimer.isIdle(Tn.BeforeAction)){const e=K.subtract(this._initialPosition,t.getPosition()),i=Math.abs(e.squaredLength()),n=window.outerHeight*.02,r=n*n;i>r&&this._touchTimer.clear()}}onTouchEndEvent(t){this._activeTouchCount>0&&--this._activeTouchCount,this._touchTimer.clear()}}class qb{static calculate(t,e,i,n){let r;const o=2/(e+2*i+n);return t<=e?r=this._PA(t,o,e):t>=e&&t<=e+i?r=this._PA(t,o,e):r=this._PC(t,o,e,i,n),r=Math.min(r,1),r}static _PA(t,e,i){return t*t*.5*e/i}static _PB(t,e,i){return this._PA(i,e,i)+(t-i)*e}static _PC(t,e,i,n,r){return this._PB(i+n,e,i)+(t-(i+n))*e*(1-.5*(t-(i+n))/r)}}class Kb{constructor(t,e,i,n,r){this._completeCallback=null,this._startTime=null,this._progress=0,this._positionMoveDelta=null,this._targetMoveDelta=null,this._interpolationUsesRotation=!1,this._beginQuaternion=null,this._endQuaternion=null,this._viewVectorLength=0,this._viewVectorLengthDelta=0,this._fieldWidthDelta=0,this._fieldHeightDelta=0,this._beginCam=t.copy(),this._endCam=e.copy();const o=_.subtract(this._endCam.getTarget(),this._endCam.getPosition()).normalize(),l=this._endCam.getUp().normalize(),h=_.cross(l,o),u=_.cross(o,h);this._endCam.setUp(u.normalize()),this._completeCallback=n,this._duration=i,this._view=r}isComplete(){return this._progress>=1}getCallback(){return this._completeCallback}stop(){}start(){this._startTime=Date.now(),this._progress=0,this._init(),this._view.getProjectionMode()!==this._endCam.getProjection()&&this._view.setProjectionMode(this._endCam.getProjection())}update(){if(this._startTime===null)return;let e=(Date.now()-this._startTime)/this._duration;e=Math.min(e,1),e=Math.max(e,0),e=qb.calculate(e,.49,.02,.49),e=Math.min(e,1),e=Math.max(e,0);const i=_.scale(this._positionMoveDelta,e),n=_.scale(this._targetMoveDelta,e),r=this._beginCam.getUp();let o=_.add(this._beginCam.getPosition(),i);const l=_.add(this._beginCam.getTarget(),n),h=this._beginCam.getWidth()+e*this._fieldWidthDelta,u=this._beginCam.getHeight()+e*this._fieldHeightDelta;if(this._interpolationUsesRotation){const g=this._viewVectorLength+this._viewVectorLengthDelta*e,y=Bn.interpolate(this._beginQuaternion,this._endQuaternion,e),m=Bn.toMatrix(y);o=new _(l.x-m.m[8]*g,l.y-m.m[9]*g,l.z-m.m[10]*g),r.set(m.m[4],m.m[5],m.m[6])}const d=dn.create(o,l,r,this._endCam.getProjection(),h,u,this._endCam.getNearLimit());this._view.setCamera(d),this._progress=e,this._progress>=1&&this._view.setCamera(this._endCam)}getMatrixFromCamera(t){const e=_.subtract(t.getTarget(),t.getPosition()).normalize(),i=t.getUp().normalize(),n=_.cross(i,e),r=_.cross(e,n);return _t.createFromBasis(n,r,e)}_init(){const t=_.subtract(this._beginCam.getTarget(),this._beginCam.getPosition()),e=_.subtract(this._endCam.getTarget(),this._endCam.getPosition()),i=t.length(),n=e.length()-i;t.normalize(),e.normalize();const r=_.subtract(t,e),o=_.subtract(this._endCam.getUp(),this._beginCam.getUp());let l=!0;r.length()<1e-4&&o.length()<1e-4&&(l=!1);let h=null,u=null;if(l){const d=this.getMatrixFromCamera(this._beginCam),g=this.getMatrixFromCamera(this._endCam);h=Bn.createFromMatrix(d),u=Bn.createFromMatrix(g);const y=Bn.subtract(h,u).magnitudeSquared();Bn.add(h,u).magnitudeSquared()<y&&u.negate()}this._interpolationUsesRotation=l,this._beginQuaternion=h,this._endQuaternion=u,this._viewVectorLength=i,this._viewVectorLengthDelta=n,this._positionMoveDelta=_.subtract(this._endCam.getPosition(),this._beginCam.getPosition()),this._targetMoveDelta=_.subtract(this._endCam.getTarget(),this._beginCam.getTarget()),this._fieldWidthDelta=this._endCam.getWidth()-this._beginCam.getWidth(),this._fieldHeightDelta=this._endCam.getHeight()-this._beginCam.getHeight()}}class Xb{constructor(){this._obscuredLineColor=vt.black(),this._obscuredLineOpacity=.2,this._visibleLineColor=vt.black(),this._visibleLineOpacity=1,this._backgroundColorTop=vt.white(),this._backgroundColorBottom=vt.white()}getObscuredLineColor(){return this._obscuredLineColor.copy()}setObscuredLineColor(t){this._obscuredLineColor.assign(t)}getObscuredLineOpacity(){return this._obscuredLineOpacity}setObscuredLineOpacity(t){0<=t&&t<=1&&(this._obscuredLineOpacity=t)}getVisibleLineColor(){return this._visibleLineColor.copy()}setVisibleLineColor(t){this._visibleLineColor.assign(t)}getVisibleLineOpacity(){return this._visibleLineOpacity}setVisibleLineOpacity(t){0<=t&&t<=1&&(this._visibleLineOpacity=t)}getBackgroundColor(){const t=this._backgroundColorTop!==null?this._backgroundColorTop.copy():null,e=this._backgroundColorBottom!==null?this._backgroundColorBottom.copy():null;return new fg(t,e)}setBackgroundColor(t=null,e=null){this._backgroundColorTop=t!==null?t.copy():null,this._backgroundColorBottom=e!==null?e.copy():null}}class Jb extends uo{constructor(t){super(),this._position=new K(10,10),this._nextItemPosition=K.zero(),this._statItemOffset=new K(5,5),this._maxStatWidth=0,this._viewer=t,this._backgroundPanel=new Wu(this._position,new K(300,100)),this._backgroundPanel.setFillColor(vt.white()),this._backgroundPanel.setStrokeWidth(0),this._statsText=new d_}draw(){this._updateBackgroundSize();const t=this._viewer.markupManager.getRenderer();t.drawRectangle(this._backgroundPanel),t.drawTexts(this._statsText)}clearStatsText(){this._statsText.clear(),this._nextItemPosition.assign(this._position)}setPosition(t){this._position.assign(t),this._backgroundPanel.setPosition(this._position)}addStatistic(t,e){const i=K.add(this._nextItemPosition,this._statItemOffset),n=`${t}: ${e}`;this._statsText.addString(n,i),this._nextItemPosition.y+=this._statsText.getFontSize()}_updateBackgroundSize(){const t=this._viewer.markupManager.getRenderer(),e=this._statsText.getStrings(),i=this._statsText.getFontSize();for(const o of e){const l=t.measureText(o.text,this._statsText);this._maxStatWidth=Math.max(this._maxStatWidth,l.x)}const n=2*this._statItemOffset.x+this._maxStatWidth,r=e.length*(i+this._statItemOffset.y);this._backgroundPanel.setSize(new K(n,r))}}class py{constructor(){this.total_element_count=0,this.total_triangle_count=0}}class Yb{constructor(t,e){this._statisticsDisplayHandle=null,this._statistics=new py,this._viewer=e,this._callbackManager=t,this._callbackManager.bind({frameDrawn:async()=>{await this.update()}}),this._statisticsDisplay=new Jb(this._viewer)}async update(){const t=await this._viewer.getStatistics();this._statistics=t,this._statisticsDisplay.clearStatsText();const e=Object.keys(this._statistics);for(const i of e){const n=i,r=this._statistics[n];this._statisticsDisplay.addStatistic(n,r.toString())}}isShown(){return this._statisticsDisplayHandle!==null}getStatistics(){return this._statistics}async showDisplay(){this.isShown()||(await this.update(),this._statisticsDisplayHandle=this._viewer.markupManager.registerMarkup(this._statisticsDisplay,this._viewer.view))}hideDisplay(){this.isShown()&&(this._viewer.markupManager.unregisterMarkup(this._statisticsDisplayHandle,this._viewer.view),this._statisticsDisplayHandle=null)}}class Zb{constructor(){this.left=0,this.top=0}}const Ui=class Ui{constructor(t,e,i){this._isIE=!1,this._isFirefox=!1,this._canvas=null,this._canvasEventFunctions=new Map,this._documentEventFunctions=new Map,this._pointerEventsEnabled=!0,this._processInput=!1,this._eventsBound=!1,this._dragStarted=!1,this._captureInput=!1,this._elementOffset=new Zb,this._pointerUp=!1,this._buttons=ls.None,this._viewKey=t,this._eventDispatcher=e,this._timeoutMonitor=i,this._document=document;const n=navigator.userAgent.toLowerCase();this._isIE=n.indexOf("trident")>=0||n.indexOf("edge")>=0,this._isFirefox=n.indexOf("firefox")>-1}_tryLockEventDispatcher(){return!Ui._activeEventDispatcherLocked||Ui._activeEventDispatcher===this._eventDispatcher?(this._calculateElementOffset(),Ui._activeEventDispatcher=this._eventDispatcher,Ui._activeOffset=this._elementOffset,Ui._activeEventDispatcherLocked=!0,!0):!1}_unlockEventDispatcher(){Ui._activeEventDispatcherLocked=!1}shutdown(){this.unbindEvents()}setDocument(t){this._unbindDocumentEvents(),this._document=t,this._initDocumentEvents()}setOptions(t){t.hasOwnProperty("usePointerEvents")&&this.setPointerEventsEnabled(!!t.usePointerEvents)}elementResize(){this._calculateElementOffset()}setPointerEventsEnabled(t){this._pointerEventsEnabled=t}getPointerEventsEnabled(){return this._pointerEventsEnabled}_browserSupportsPointerEvents(){return window.hasOwnProperty("PointerEvent")}_usePointerEvents(){return this._browserSupportsPointerEvents()&&this._pointerEventsEnabled&&this._isIE}_calculateElementOffset(){if(this._canvas!==null){const t=this._canvas.getBoundingClientRect();this._elementOffset.left=t.left,this._elementOffset.top=t.top}}_initDocumentEvents(){this._usePointerEvents()?(this._bindDocumentEvent("pointermove",t=>{this._processDocumentPointerMove(t)}),this._bindDocumentEvent("pointerup",t=>{this._processDocumentPointerUp(t)})):(this._bindDocumentEvent("mousemove",t=>{this._processDocumentMouseMove(t)}),this._bindDocumentEvent("mouseup",t=>{this._processDocumentMouseUp(t)}))}_initCanvasEvents(){this._usePointerEvents()?(this._bindCanvasEvent("pointerdown",t=>{this._processPointerDown(t)}),this._bindCanvasEvent("pointermove",t=>{this._processPointerMove(t)}),this._bindCanvasEvent("pointerup",t=>{this._processPointerUp(t)}),this._bindCanvasEvent("pointerenter",t=>{this._processPointerEnter(t)}),this._bindCanvasEvent("pointerleave",t=>{this._processPointerLeave(t)})):(this._bindCanvasEvent("mousedown",t=>{this._processMouseDown(t)}),this._bindCanvasEvent("mousemove",t=>{this._processMouseMove(t)}),this._bindCanvasEvent("mouseup",t=>{this._processMouseUp(t)}),this._bindCanvasEvent("mouseenter",t=>{this._processMouseEnter(t)}),this._bindCanvasEvent("mouseleave",t=>{this._processMouseLeave(t)}),this._bindCanvasEvent("touchstart",t=>{this._processTouchStart(t)}),this._bindCanvasEvent("touchmove",t=>{this._processTouchMove(t)}),this._bindCanvasEvent("touchend",t=>{this._processTouchEnd(t)}),this._bindCanvasEvent("touchcancel",t=>{this._processTouchEnd(t)})),this._isFirefox?this._bindCanvasEvent("DOMMouseScroll",t=>{this._processMousewheel(t)}):this._bindCanvasEvent("mousewheel",t=>{this._processMousewheel(t)}),this._bindCanvasEvent("keydown",t=>{this._processKeyDownEvent(t)}),this._bindCanvasEvent("keyup",t=>{this._processKeyUpEvent(t)})}bindEvents(t){this._eventsBound||(this._canvas=t,this.elementResize(),this._processInput=!0,this._initCanvasEvents(),this._initDocumentEvents(),this._eventsBound=!0)}_bindDocumentEvent(t,e){if(this._document===null)return;const i=this._documentEventFunctions.get(t);i!==void 0&&this._document.removeEventListener(t,i),this._documentEventFunctions.set(t,e),this._document.addEventListener(t,e)}_bindCanvasEvent(t,e){if(this._canvas===null)return;const i=this._canvasEventFunctions.get(t);i!==void 0&&this._canvas.removeEventListener(t,i),this._canvasEventFunctions.set(t,e),this._canvas.addEventListener(t,e)}_unbindDocumentEvents(){this._documentEventFunctions.forEach((t,e)=>{this._document.removeEventListener(e,t)}),this._documentEventFunctions.clear()}_unbindCanvasEvents(){this._canvas!==null&&(this._canvasEventFunctions.forEach((t,e)=>{this._canvas.removeEventListener(e,t)}),this._canvasEventFunctions.clear()),console.assert(this._canvasEventFunctions.size===0)}unbindEvents(){this._unbindCanvasEvents(),this._unbindDocumentEvents(),this._processInput=!1,this._eventsBound=!1,Ui._activeEventDispatcher===this._eventDispatcher&&this._unlockEventDispatcher()}_convertEventCoordsToTargetCoords(t,e,i=!0){let n;return i&&Ui._activeOffset!==null?n=Ui._activeOffset:n=this._elementOffset,new K(t-n.left,e-n.top)}focusInput(t){this._canvas!==null&&(t?this._canvas.focus():this._canvas.blur())}_setButtons(t){t.buttons&&(this._buttons=t.buttons)}_processMouseDown(t){if(this._tryLockEventDispatcher()){switch(t.button){case 0:this._buttons|=ls.Left;break;case 1:this._buttons|=ls.Middle;break;case 2:this._buttons|=ls.Right;break}if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput){const e=this._convertEventCoordsToTargetCoords(t.clientX,t.clientY),i=this._getEventModifiers(t);Ui._activeEventDispatcher.injectMouseDownEvent(e.x,e.y,t.button,this._buttons,i,this._viewKey),this._dragStarted=!0}}}_processMouseMove(t,e=!1){if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),!(!e&&!this._tryLockEventDispatcher())&&this._processInput){const i=this._convertEventCoordsToTargetCoords(t.clientX,t.clientY),n=this._getEventModifiers(t);Ui._activeEventDispatcher!==null&&Ui._activeEventDispatcher.injectMouseMoveEvent(i.x,i.y,Me.None,this._buttons,n,this._viewKey)}}_processMouseUp(t,e=!1){switch(t.button){case 0:this._buttons&=~ls.Left;break;case 1:this._buttons&=~ls.Middle;break;case 2:this._buttons&=~ls.Right;break}if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),!!this._tryLockEventDispatcher()&&(t.stopPropagation(),this._processInput)){const i=this._convertEventCoordsToTargetCoords(t.clientX,t.clientY),n=this._getEventModifiers(t);Ui._activeEventDispatcher.injectMouseUpEvent(i.x,i.y,t.button,this._buttons,n,this._viewKey),this._buttons===ls.None&&(this._dragStarted=!1,this._captureInput=!1,e&&this._unlockEventDispatcher())}}_processMousewheel(t){if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput){let e;const i=this._convertEventCoordsToTargetCoords(t.clientX,t.clientY),n=this._getEventModifiers(t);this._isFirefox?e=t.detail>0?-1:1:e=t.wheelDelta>0?1:-1,this._eventDispatcher.injectMousewheelEvent(i.x,i.y,e,this._buttons,n,this._viewKey)}}_processDocumentMouseMove(t){this._dragStarted&&this._captureInput&&this._processMouseMove(t,!0)}_processDocumentMouseUp(t){this._dragStarted&&this._captureInput&&this._processMouseUp(t,!0)}_processMouseLeave(t){if(this._dragStarted){this._captureInput=!0;return}this._unlockEventDispatcher()}_processMouseEnter(t){this._tryLockEventDispatcher()&&this._dragStarted&&(this._captureInput=!1)}_isFunctionKey(t){return 112<=t.which&&t.which<=123}_processKeyDownEvent(t){if(this._isFunctionKey(t)||t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput){const e=this._getEventModifiers(t);this._eventDispatcher.injectKeyDownEvent(t.which,e,this._viewKey)}}_processKeyUpEvent(t){if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput){const e=this._getEventModifiers(t);this._eventDispatcher.injectKeyUpEvent(t.which,e,this._viewKey)}}_processTouchStart(t){if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches.item(e),n=this._convertEventCoordsToTargetCoords(i.clientX,i.clientY,!1);this._eventDispatcher.injectTouchStartEvent(i.identifier,n.x,n.y,this._buttons,this._viewKey)}}_processTouchMove(t){if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches.item(e),n=this._convertEventCoordsToTargetCoords(i.clientX,i.clientY,!1);this._eventDispatcher.injectTouchMoveEvent(i.identifier,n.x,n.y,this._buttons,this._viewKey)}}_processTouchEnd(t){if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput)for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches.item(e),n=this._convertEventCoordsToTargetCoords(i.clientX,i.clientY,!1);this._eventDispatcher.injectTouchEndEvent(i.identifier,n.x,n.y,this._buttons,this._viewKey)}}_processPointerDown(t){if(this._tryLockEventDispatcher()&&(this._setButtons(t),t.preventDefault(),this._timeoutMonitor.resetTimeout(),this._processInput)){const e=this._convertEventCoordsToTargetCoords(t.clientX,t.clientY),i=this._getEventModifiers(t);t.pointerType==="mouse"?Ui._activeEventDispatcher.injectMouseDownEvent(e.x,e.y,t.button,this._buttons,i,this._viewKey):t.pointerType==="touch"&&Ui._activeEventDispatcher.injectTouchStartEvent(t.pointerId,e.x,e.y,this._buttons,this._viewKey),this._pointerUp=!1}}_processPointerMove(t,e=!1){if(t.preventDefault(),this._timeoutMonitor.resetTimeout(),!(!e&&!this._tryLockEventDispatcher())&&(this._setButtons(t),this._processInput)){const i=this._convertEventCoordsToTargetCoords(t.clientX,t.clientY),n=this._getEventModifiers(t);Ui._activeEventDispatcher!==null&&(t.pointerType==="mouse"?Ui._activeEventDispatcher.injectMouseMoveEvent(i.x,i.y,t.button,this._buttons,n,this._viewKey):t.pointerType==="touch"&&Ui._activeEventDispatcher.injectTouchMoveEvent(t.pointerId,i.x,i.y,this._buttons,this._viewKey))}}_processPointerUp(t,e=!1){if(this._setButtons(t),t.preventDefault(),this._timeoutMonitor.resetTimeout(),!!this._tryLockEventDispatcher()&&this._processInput){const i=this._convertEventCoordsToTargetCoords(t.clientX,t.clientY),n=this._getEventModifiers(t);t.pointerType==="mouse"&&!this._pointerUp?Ui._activeEventDispatcher.injectMouseUpEvent(i.x,i.y,t.button,this._buttons,n,this._viewKey):t.pointerType==="touch"&&this._eventDispatcher.injectTouchEndEvent(t.pointerId,i.x,i.y,this._buttons,this._viewKey),this._buttons===ls.None&&(this._dragStarted=!1,this._captureInput=!1,this._pointerUp=!0,e&&this._unlockEventDispatcher())}}_processPointerEnter(t){this._tryLockEventDispatcher()&&(this._pointerUp||(this._captureInput=!1))}_processPointerLeave(t){if(!this._pointerUp){this._captureInput=!0;return}this._unlockEventDispatcher()}_processDocumentPointerMove(t){!this._pointerUp&&this._captureInput&&this._processPointerMove(t,!0)}_processDocumentPointerUp(t){!this._pointerUp&&this._captureInput&&this._processPointerUp(t,!0)}_getEventModifiers(t){let e=_i.None;return t.altKey&&(e|=_i.Alt),t.ctrlKey&&(e|=_i.Control),t.shiftKey&&(e|=_i.Shift),t.metaKey&&(e|=_i.Command),e}};Ui._activeEventDispatcher=null,Ui._activeEventDispatcherLocked=!1,Ui._activeOffset=null;let gg=Ui;class pg{constructor(t,e,i,n,r,o){this._backfacesVisible=!1,this._initialCamera=null,this._lineVisibility=!0,this._faceVisibility=!0,this._boundingCalculationIgnoresInvisible=!0,this._backgroundColorTop=null,this._backgroundColorBottom=null,this._drawMode=Js.WireframeOnShaded,this._ambientOcclusionEnabled=!1,this._ambientOcclusionRadius=.03,this._antiAliasingMode=Au.SMAA,this._lightingEnabled=!0,this._ambientLightColor=vt.black(),this._massageExtremeCameras=!0,this._bloomEnabled=!1,this._bloomThreshold=0,this._bloomThresholdRampWidth=0,this._bloomIntensityScale=0,this._bloomLayers=[],this._simpleShadowEnabled=!1,this._simpleReflectionEnabled=!1,this._silhouetteEnabled=!1,this._hardEdgesEnabled=!1,this._imageBasedLightingEnabled=!0,this._lineJitterEnabled=!1,this._hiddenLineSettings=new Xb,this._projectionMode=ti.Orthographic,this._drawStrategy=Ff.FixedFramerate,this._id=o.id,this._viewer=t,this._engine=e,this._callbackManager=i,this._interpolationManager=r,this.operatorManager=new dy(t),this._eventDispatcher=new Gb(this._callbackManager,this.operatorManager),this._model=t.model,this._statistics=new Yb(i,t),this._navCube=new ad(t,this),this._axisTriad=new od(t,this),this.overlayManager=new s_(this,t.model,i,this._engine),this._inputMonitor=new gg(o.id,this._eventDispatcher,n),this._inputMonitor.setOptions(t.config),this._determineInitialAxes=Xa(t.config.calculateDefaultViewAxes,!0);const l=new Jc;Xa(t.config.disableAutomaticFloorplanOverlay,!1)&&(l.autoActivate=Bo.Never),this.floorplanManager=new Ju(t,t.model,this.overlayManager,this._engine,l),this._initEvents(),this._initEventDispatcher(),this.domElements=o.domElements}get id(){return this._id}get inputMonitor(){return this._inputMonitor}_initEvents(){this._callbackManager.bind({_resetAssemblyTreeBegin:async()=>{this._initialCamera=null},_firstAttachment:async t=>{if(t===ps.Direct)return this._massageInitialCamera(!1)},_firstModelLoaded:(t,e)=>e?Promise.resolve():this._massageInitialCamera(!1),_modelSwitched:async t=>{if(!t)return await this._massageInitialCamera(!1),this._setInitialView(0)},hwfParseComplete:()=>this._massageInitialCamera(!0),_modelStructureHeaderParsed:async()=>{if(this._viewer.sheetManager.isDrawingSheetActive())return this._model.setViewAxes(new _(0,0,1),new _(0,1,0)),this.setViewOrientation(Ct.Front,0)},_sessionStarted:async()=>{this._initEffects()},_drawContextCreated:t=>{t==this._id&&this._initEffects()},viewAxes:(t,e)=>{this._updateGroundPlane(t,e),this._updateImageBasedLightingOrientation(t,e)}})}_initEffects(){this.setBloomIntensityScale(1),this.setBloomThreshold(.65),this.setBloomThresholdRampWidth(.1),this.setBloomLayers([{intensity:.5,blurSamples:5,blurInterval:[.0025,Ls.ProportionOfHeight]},{intensity:.5,blurSamples:5,blurInterval:[.005,Ls.ProportionOfHeight]},{intensity:.5,blurSamples:9,blurInterval:[.01,Ls.ProportionOfHeight]},{intensity:1,blurSamples:9,blurInterval:[.02,Ls.ProportionOfHeight]},{intensity:2,blurSamples:11,blurInterval:[.04,Ls.ProportionOfHeight]}]),this.setGroundPlane({normal:new _(0,0,1),followViewAxes:!0}),this.setSimpleShadowColor(vt.black()),this.setSimpleShadowOpacity(.65),this.setSimpleShadowResolution(512),this.setSimpleShadowBlurSamples(5),this.setSimpleShadowBlurInterval(1),this.setSimpleShadowInteractiveUpdateEnabled(),this.setSimpleReflectionOpacity(.65),this.setSimpleReflectionFadeAngle(10),this.setSimpleReflectionBlurSamples(9),this.setSimpleReflectionBlurInterval(1,Ls.Pixels),this.setSimpleReflectionAttenuation(0,1,Du.ProportionOfBoundingHeight),this.setSilhouetteColor(vt.black()),this.setSilhouetteOpacity(1),this.setSilhouetteThreshold(.05),this.setSilhouetteThresholdRampWidth(.025),this.setHardEdgeColor(vt.black()),this.setHardEdgeOpacity(1),this.setHardEdgeThreshold(30),this.setHardEdgeThresholdRampWidth(20),this.setImageBasedLightingIntensity(1),this.setImageBasedLightingOrientation({matrix:new _t,followViewAxes:!0}),this.setGoochBlue(.55),this.setGoochYellow(.3),this.setGoochBaseColorProminence(.25),this.setGoochLuminanceShiftStrength(.5),this.setLineJitterInstanceCount(4),this.setLineJitterFrequency(5),this.setLineJitterRadius(.005),this.setToonShadingBandCount(3),this.setToonShadingSpecularFactor(1)}_initEventDispatcher(){const t=new og(this._viewer,this),e=new S_(this._viewer,this),i=new A_(this._viewer,this),n=new E_(this._viewer,this),r=new C_(this._viewer,this,t,e,i),o=new M_(this._viewer,this),l=new id(this._viewer,this),h=new k_(this._viewer,o,l),u=new P_(this._viewer,this),d=new iy(this._viewer,this,this._viewer.noteTextManager),g=new q_(this._viewer,this),y=new ey(this._viewer,this),m=new j_(this._viewer,this),I=new $_(this._viewer,this),b=new G_(this._viewer,this),x=new W_(this._viewer,this),C=new N_(this._viewer,this,this._viewer.measureManager),P=new R_(this._viewer,this,this._viewer.measureManager),k=new F_(this._viewer,this,this._viewer.measureManager),O=new B_(this._viewer,this,this._viewer.measureManager),B=new T_(this._viewer,this,this._viewer.measureManager),j=new O_(this._viewer,this,this._viewer.measureManager),V=new z_(this._viewer,this,this._viewer.measureManager),Y=new V_(this._viewer,this,this._viewer.measureManager),q=new ty(this._viewer,this,this._viewer.noteTextManager),st=new J_(this._viewer,this,this._viewer.cuttingManager),ft=new Z_(this._viewer,this),U=new Q_(this._viewer,this),J=new K_(this._viewer,this),A=new Y_(this._viewer,this),R=new ny(this._viewer,this);this.operatorManager._registerOperator(_e.Navigate,r),this.operatorManager._registerOperator(_e.Orbit,t),this.operatorManager._registerOperator(_e.Pan,e),this.operatorManager._registerOperator(_e.Zoom,i),this.operatorManager._registerOperator(_e.WindowZoom,n),this.operatorManager._registerOperator(_e.Walk,o),this.operatorManager._registerOperator(_e.KeyboardWalk,l),this.operatorManager._registerOperator(_e.WalkMode,h),this.operatorManager._registerOperator(_e.Turntable,u),this.operatorManager._registerOperator(_e.Select,d),this.operatorManager._registerOperator(_e.AreaSelect,g),this.operatorManager._registerOperator(_e.RayDrillSelect,y),this.operatorManager._registerOperator(_e.RedlineCircle,m),this.operatorManager._registerOperator(_e.RedlineText,I),this.operatorManager._registerOperator(_e.RedlineRectangle,b),this.operatorManager._registerOperator(_e.RedlinePolyline,x),this.operatorManager._registerOperator(_e.MeasureEdgeLength,C),this.operatorManager._registerOperator(_e.MeasureFaceFaceDistance,P),this.operatorManager._registerOperator(_e.MeasureLineLineAngle,k),this.operatorManager._registerOperator(_e.MeasurePointPointDistance,O),this.operatorManager._registerOperator(_e.MeasureBodyBodyDistance,B),this.operatorManager._registerOperator(_e.MeasureFaceFaceAngle,j),this.operatorManager._registerOperator(_e.MeasurePolylineDistance,V),this.operatorManager._registerOperator(_e.MeasurePolygonArea,Y),this.operatorManager._registerOperator(_e.Note,q),this.operatorManager._registerOperator(_e.Cutting,st),this.operatorManager._registerOperator(_e.Handle,ft),this.operatorManager._registerOperator(_e.NavCube,U),this.operatorManager._registerOperator(_e.AxisTriad,J),this.operatorManager._registerOperator(_e.Floorplan,A),this.operatorManager._registerOperator(_e.SpaceMouse,R),r.setBimNavigationEnabled(!1),C.addMapping(Me.Left),P.addMapping(Me.Left),O.addMapping(Me.Left),O.addMapping(Me.Left,_i.Alt),j.addMapping(Me.Left),n.addMapping(Me.Left),st.addMapping(Me.Left),g.addMapping(Me.Left),g.addMapping(Me.Left,_i.Control),this.operatorManager.set(_e.Navigate,0),this.operatorManager.set(_e.Select,1),this.operatorManager.push(_e.Cutting),this.operatorManager.push(_e.Handle),this.operatorManager.push(_e.NavCube),this.operatorManager.push(_e.AxisTriad),this.operatorManager.push(_e.Floorplan),this.operatorManager.push(_e.SpaceMouse)}injectViewOrientationChangeEvent(){this._eventDispatcher.injectViewOrientationChangeEvent(this._id)}async _massageInitialCamera(t){this._initialCamera===null&&(this._initialCamera=await this._engine.getCameraPromise(this._id),this._projectionMode=this._initialCamera.getProjection(),this._determineInitialAxes&&!this._viewer.sheetManager.isDrawingSheetActive()&&!this._model.viewAxesHaveBeenSet()&&this._determineViewAxes(this._initialCamera),t&&(await this.fitWorld(),this._initialCamera=this.getCamera()))}setLineVisibility(t){return this._setLineVisibility(t),Promise.resolve()}_setLineVisibility(t){t!==this._lineVisibility&&(this._lineVisibility=t,this._engine.setLineVisibility(this._id,t))}getLineVisibility(){return this._lineVisibility}setFaceVisibility(t){return this._setFaceVisibility(t),Promise.resolve()}_setFaceVisibility(t){return t!==this._faceVisibility&&(this._faceVisibility=t,this._engine.setFaceVisibility(this._id,t)),Promise.resolve()}getFaceVisibility(){return this._faceVisibility}setProjectionMode(t){this._projectionMode!==t&&(this._projectionMode=t,this._engine.isInit()&&this._engine.setProjection(this._id,t),this._eventDispatcher.injectViewOrientationChangeEvent(this._id))}getProjectionMode(){return this._projectionMode}getDrawStrategy(){return this._drawStrategy}getViewMatrix(){const t=this.getCamera();return this._engine.getViewMatrix(t)}getProjectionMatrix(){const t=this.getCamera();return this._engine.getProjectionMatrix(t,this.id)}getFullCameraMatrix(){const t=this.getCamera();return this._engine.getFullCameraMatrix(t,this.id)}raycastFromPoint(t){const e=this.getCanvasSize(),i=this.getCamera(),n=this._engine.getViewMatrix(i),r=this._engine.getProjectionMatrix(i,this.id),o=new _(t.x,e.y-t.y,0),l=this._unproject(o,r,n,e);if(l===null)return null;o.z=.5;const h=this._unproject(o,r,n,e);if(h===null)return null;const u=_.subtract(h,l).normalize();return new Ws(l,u)}_unproject(t,e,i,n){const r=_t.multiply(i,e),o=_t.inverse(r);if(o===null)return null;const l=new rr(t.x,t.y,t.z,1);l.x=l.x/n.x,l.y=l.y/n.y,l.x=l.x*2-1,l.y=l.y*2-1,l.z=l.z*2-1;const h=o.transform4(l);return h.w===0?null:(h.scale(1/h.w),new _(h.x,h.y,h.z))}_rectifySelectionItem(t){const e=t.getInclusionKey(),i=t.getNodeId(),n=this._model._getNodeFromInstanceInc(!1,e,i,!0);t._setNodeId(n)}isOutsideCanvasArea(t){const e=this.getCanvasSize();return t.x<0||t.y<0||t.x>=e.x||t.y>=e.y}async pickFromPoint(t,e){if(this.isOutsideCanvasArea(t))throw new ho;const i=await this._engine.pickFromScreen(this._id,t,e,this._viewer.sheetManager.isDrawingSheetActive());return i?(this._rectifySelectionItem(i),i):wi.create()}async pickAllFromPoint(t,e){if(this.isOutsideCanvasArea(t))throw new ho;const i=await this._engine.pickAllFromScreen(this._id,t,e,this._viewer.sheetManager.isDrawingSheetActive());for(const n of i)this._rectifySelectionItem(n);return i}async compositePickFromPoint(t,e){if(this.isOutsideCanvasArea(t))throw new ho;const{faceItem:i,lineItem:n,pointItem:r}=await this._engine.compositePickFromScreen(this._id,t,e,this._viewer.sheetManager.isDrawingSheetActive()),o=new Zu(i,n,r);return o.faceItem!==null&&this._rectifySelectionItem(o.faceItem),o.lineItem!==null&&this._rectifySelectionItem(o.lineItem),o.pointItem!==null&&this._rectifySelectionItem(o.pointItem),new Zu(o.faceItem,o.lineItem,o.pointItem)}async pickFromRay(t,e){const i=await this._engine.pickFromRay(t,e);return i?(this._rectifySelectionItem(i),i):wi.create()}async pickAllFromRay(t,e){const i=await this._engine.pickAllFromRay(t,e);for(const n of i)this._rectifySelectionItem(n);return i}async beginScreenSelectByArea(t,e,i){if(this.isOutsideCanvasArea(t)||this.isOutsideCanvasArea(e))throw new ho;return this._engine.beginScreenAreaSelection(this._id,t,e,i)}async beginRayDrillSelection(t,e,i){if(this.isOutsideCanvasArea(t))throw new ho;return this._engine.beginRayDrillSelection(this._id,t,e,i)}async beginConvexPolyhedronSelection(t,e,i){return this._engine.beginConvexPolyhedronSelection(t,e,i)}async beginSphereSelection(t,e,i){const n=ol(t);return this._engine.beginSphereSelection(n,e,i)}endIncrementalSelection(t){return this._endIncrementalSelection(t),Promise.resolve()}_endIncrementalSelection(t){this._engine.endIncrementalSelection(t)}async advanceIncrementalSelection(t){try{const e=await this._engine.advanceIncrementalSelection(t);if(e===null)return null;const i=this._viewer.selectionManager,n=[];for(const r of e){this._rectifySelectionItem(r);const o=r,l=o.getNodeId();if(!l)continue;i._incrementalBlacklistedInstanceNodes.has(l)||n.push(o)}return n}catch(e){throw e.scFunction==="advanceVolumeSelection"?new Or:e}}projectPoint(t,e){let i,n;e===void 0&&(e=this.getCamera()),i=e.getProjectionMatrix(this._viewer,this),n=e.getViewMatrix(this._viewer);const r=this.getCanvasSize(),o=this._project(t,i,n,r);return o.y=r.y-o.y,o}_project(t,e,i,n){const r=new rr(t.x,t.y,t.z,1);i.transform4(r,r),e.transform4(r,r);const o=r.w<=0,l=r.w;return r.w<=0&&(r.w=.001),r.scale(1/r.w),r.x=r.x*.5+.5,r.y=r.y*.5+.5,r.z=r.z*.5+.5,r.x=r.x*n.x,r.y=r.y*n.y,o&&(r.z=l),new _(r.x,r.y,r.z)}unprojectPoint(t,e){const i=this.getCanvasSize(),n=this.getProjectionMatrix(),r=this.getViewMatrix(),o=new _(t.x,i.y-t.y,e);return this._unproject(o,n,r,i)}pointToWindowPosition(t){const e=this._engine.getCanvasSize(this.id);return new K(t.x/e.x*2-1,1-t.y/e.y*2)}setInitialCamera(t){this._initialCamera=t.copy()}setCamera(t,e=0){return t===null?!1:this._setCameraImpl(t,e).unsafeValue}_setCameraPromise(t,e){return this._setCameraImpl(t,e).readyPromise}_setCameraImpl(t,e){if(e>0)return this._interpolateCamera(t,e);if(this._engine.isInit()){const i=t.getProjection();this._projectionMode!==i&&this.setProjectionMode(i),this._engine.setCamera(this._id,t);let n=this._viewer.markupManager._setActiveMarkupView(this,null);return this._callbackManager.trigger("camera",t,this),Po(!0,n)}else return Po(!1,Promise.resolve())}_interpolateCamera(t,e){if(this._engine.isInit()){const i=this.getCamera();if(i.equals(t))return this._viewer.markupManager&&this._viewer.markupManager._update(),Po(!1,Promise.resolve());{this._callbackManager.trigger("transitionBegin",e,this);const n=mi(),r=()=>{this._eventDispatcher.injectViewOrientationChangeEvent(this._id),this._callbackManager.trigger("transitionEnd",this),n.resolve()};return this._interpolationManager.start(new Kb(i,t,e,r,this)),Po(!0,n)}}else return Po(!1,Promise.resolve())}updateCamera(t){return t=this._engine.updateCamera(this._id,t),this._callbackManager.trigger("camera",t,this),t}resetCamera(t=Yn){return this._setInitialView(t)}unsetDefaultCamera(){this._engine.markCameraAsEmpty(this._id)}getCamera(){if(this._engine.isInit())return this._engine.getCamera(this._id);throw new ae("getCamera() called before sceneReady")}async getViewOrientationCamera(t,e,i=!0){const n=this.getCamera(),r=n.getUp().copy().normalize(),o=this._model.getViewAxes(),l=o.upVector.copy(),h=o.frontVector.copy();e===void 0?e=await this._model.getModelBounding(this._boundingCalculationIgnoresInvisible,!1):this._fitCameraToBounding(n,e);const u=e.center();let d=u.copy();const g=u.copy(),y=_.subtract(n.getPosition(),n.getTarget()).length(),m=_.subtract(n.getPosition(),u).length();let I=new _(0,0,1),b=new _(-1,0,0);l!==null&&(I=l.copy()),h!==null&&(b=h.copy());const x=b.copy().scale(-1),C=b.copy(),P=I.copy(),k=I.copy().scale(-1),O=_.cross(P,x),B=O.copy().scale(-1),j=st=>{const ft=_.subtract(g,st);let U=I;const J=js(ft,I);(J===0||J===180)&&(U=b);const A=_.cross(ft,U),R=A.copy().negate(),bt=_.cross(ft,A),z=bt.copy().negate(),Pt=[A,R,bt,z];let X=1/0,Tt=A;for(const lt of Pt){const at=js(r,lt);at<=X&&(X=at,Tt=lt)}return Tt.normalize()};let V=null;switch(t){case Ct.Front:d=_.add(g,C);break;case Ct.Back:d=_.add(g,x);break;case Ct.Left:d=_.add(g,O);break;case Ct.Right:d=_.add(g,B);break;case Ct.Bottom:d=_.add(g,k),V=x.copy();break;case Ct.Top:d=_.add(g,P),V=x.copy();break;case Ct.FrontTop:case Ct.TopFront:d=_.add(g,_.add(C,P)),V=_.add(x,P).normalize();break;case Ct.FrontTopLeft:case Ct.LeftTopFront:case Ct.TopLeftFront:d=_.add(g,_.add(C,_.add(O,P))),V=_.add(x,_.add(B,P)).normalize();break;case Ct.Iso:case Ct.FrontTopRight:case Ct.RightTopFront:case Ct.TopRightFront:d=_.add(g,_.add(C,_.add(B,P))),V=_.add(x,_.add(O,P)).normalize();break;case Ct.FrontLeft:case Ct.LeftFront:d=_.add(g,_.add(C,O));break;case Ct.FrontRight:case Ct.RightFront:d=_.add(g,_.add(C,B));break;case Ct.FrontBottom:case Ct.BottomFront:d=_.add(g,_.add(C,k)),V=_.add(C,P).normalize();break;case Ct.FrontBottomLeft:case Ct.LeftBottomFront:case Ct.BottomLeftFront:d=_.add(g,_.add(C,_.add(O,k))),V=_.add(C,_.add(O,P)).normalize();break;case Ct.FrontBottomRight:case Ct.RightBottomFront:case Ct.BottomRightFront:d=_.add(g,_.add(C,_.add(B,k))),V=_.add(C,_.add(B,P)).normalize();break;case Ct.BackTop:case Ct.TopBack:d=_.add(g,_.add(x,P)),V=_.add(C,P).normalize();break;case Ct.BackTopLeft:case Ct.LeftTopBack:case Ct.TopLeftBack:d=_.add(g,_.add(x,_.add(O,P))),V=_.add(C,_.add(B,P)).normalize();break;case Ct.BackTopRight:case Ct.RightTopBack:case Ct.TopRightBack:d=_.add(g,_.add(x,_.add(B,P))),V=_.add(C,_.add(O,P)).normalize();break;case Ct.BackLeft:case Ct.LeftBack:d=_.add(g,_.add(x,O));break;case Ct.BackRight:case Ct.RightBack:d=_.add(g,_.add(x,B));break;case Ct.BackBottom:case Ct.BottomBack:d=_.add(g,_.add(x,k)),V=_.add(x,P).normalize();break;case Ct.BackBottomLeft:case Ct.LeftBottomBack:case Ct.BottomLeftBack:d=_.add(g,_.add(x,_.add(O,k))),V=_.add(x,_.add(O,P)).normalize();break;case Ct.BackBottomRight:case Ct.RightBottomBack:case Ct.BottomRightBack:d=_.add(g,_.add(x,_.add(B,k))),V=_.add(x,_.add(B,P)).normalize();break;case Ct.LeftBottom:case Ct.BottomLeft:d=_.add(g,_.add(O,k)),V=_.add(O,P).normalize();break;case Ct.LeftTop:case Ct.TopLeft:d=_.add(g,_.add(O,P)),V=_.add(B,P).normalize();break;case Ct.RightBottom:case Ct.BottomRight:d=_.add(g,_.add(B,k)),V=_.add(B,P).normalize();break;case Ct.RightTop:case Ct.TopRight:d=_.add(g,_.add(B,P)),V=_.add(O,P).normalize();break;default:Tr()}i||(V=j(d)),V===null&&(V=I);const Y=_.add(_.subtract(d,u).normalize().scale(m),u),q=_.add(_.subtract(d,u).normalize().scale(m-y),u);return n.setPosition(Y),n.setTarget(q),n.setUp(V),n}async setViewOrientation(t,e=Yn,i,n=!0){const r=await this.getViewOrientationCamera(t,i,n);i===void 0?await this.fitWorld(e,r):await this.fitBounding(i,e,r),this._callbackManager.trigger("viewOrientation",t,this)}async centerCameraOnNode(t,e=0,i=this.getCamera()){const r=(await this._model.getNodesBounding([t])).center(),o=i.getPosition(),l=i.getTarget(),h=_.subtract(l,r);if(o.subtract(h),i.setPosition(o),i.setTarget(r),e>0)return this._setCameraPromise(i,e);this.setCamera(i)}async _setInitialView(t){if(!this._initialCamera)return this.fitWorld(t);if(t>0)return this._setCameraPromise(this._initialCamera,t);this.setCamera(this._initialCamera),this._eventDispatcher.injectViewOrientationChangeEvent(this._id)}getCanvasSize(){return this._engine.getCanvasSize(this.id)}async setStatisticsDisplayVisibility(t){t?await this._statistics.showDisplay():this._statistics.hideDisplay()}getBackgroundColor(){var i,n;const t=((i=this._backgroundColorTop)==null?void 0:i.copy())??null,e=((n=this._backgroundColorBottom)==null?void 0:n.copy())??null;return new fg(t,e)}setBackgroundColor(t=null,e=null){return this._backgroundColorTop=t!==null?t.copy():null,this._backgroundColorBottom=e!==null?e.copy():null,this._drawMode!==Js.HiddenLine&&!this._viewer.sheetManager.isDrawingSheetActive()&&this._engine.setBackgroundGradient(this._id,this._backgroundColorTop,this._backgroundColorBottom),Promise.resolve()}async isolateNodes(t,e=Yn,i=!0,n=null){const r=this._model.getAbsoluteRootNode(),o=new Map;o.set(r,!1);for(const l of t)o.set(l,!0);if(await this._model.setNodesVisibilities(o,n),i)return this.fitNodes(t,e)}async fitNodes(t,e=Yn){const i=await this._model.getNodesBounding(t);return this.fitBounding(i,e)}async fitWorld(t=0,e){e||(e=this.getCamera());const i=await this._model.getModelBounding(this._boundingCalculationIgnoresInvisible,!1);await this.fitBounding(i,t,e)}_fitCameraToBounding(t,e){if(this._viewer.sheetManager.isDrawingSheetActive()){const i=e.extents(),n=e.center(),r=new _(n.x,n.y,e.min.z+i.length());t.setProjection(ti.Orthographic),t.setPosition(r),t.setTarget(n),t.setWidth(i.x*1.25),t.setHeight(i.y*1.25)}else{const n=e.extents().length();if(n!==0){const r=t.getWidth(),o=_.subtract(t.getPosition(),t.getTarget()),l=o.length(),h=n*l/r,u=e.center(),d=_.add(u,o.normalize().scale(h));t.setTarget(u),t.setPosition(d),t.setWidth(n),t.setHeight(n)}else{const r=_.subtract(t.getPosition(),t.getTarget()),o=e.center(),l=_.add(o,r);t.setTarget(o),t.setPosition(l)}}}async fitBounding(t,e=Yn,i=this.getCamera()){if(t){if(t.isDegenerate()||this._fitCameraToBounding(i,t),e>0)return this._setCameraPromise(i,e);this.setCamera(i)}}setBackfacesVisible(t){return this._backfacesVisible=t,this._engine.setBackFacesVisible(this._id,t),Promise.resolve()}getBackfacesVisible(){return this._backfacesVisible}setDrawMode(t){return this._setDrawMode(t),Promise.resolve()}_setDrawMode(t){switch(this._drawMode=t,this._drawMode!==Js.HiddenLine&&this.setBackgroundColor(this._backgroundColorTop,this._backgroundColorBottom),t){case Js.Wireframe:this._engine.setDrawMode(this._id,ar.Highlight),this._setLineVisibility(!0),this._setFaceVisibility(!1);break;case Js.Shaded:this._engine.setDrawMode(this._id,ar.Highlight),this._setLineVisibility(!1),this._setFaceVisibility(!0);break;case Js.WireframeOnShaded:this._engine.setDrawMode(this._id,ar.Highlight),this._setLineVisibility(!0),this._setFaceVisibility(!0);break;case Js.HiddenLine:{const e=this._hiddenLineSettings.getBackgroundColor();this._setLineVisibility(!0),this._setFaceVisibility(!0),this._engine.enableHiddenLineRendering(this._id,this._hiddenLineSettings),this._engine.setBackgroundGradient(this._id,e.top,e.bottom)}break;case Js.XRay:this._engine.setDrawMode(this._id,ar.XRay),this._setLineVisibility(!0),this._setFaceVisibility(!0);break;case Js.Gooch:this._engine.setDrawMode(this._id,ar.Gooch);break;case Js.Toon:this._setLineVisibility(!1),this._engine.setDrawMode(this._id,ar.Toon)}}getDrawMode(){return this._drawMode}setAntiAliasingMode(t){return this._setAntiAliasingMode(t),Promise.resolve()}_setAntiAliasingMode(t){this._antiAliasingMode=t,this._engine.setAntiAliasingMode(this._id,t)}getAntiAliasingMode(){return this._antiAliasingMode}getHiddenLineSettings(){return this._hiddenLineSettings}setAmbientOcclusionEnabled(t=!0){return this._setAmbientOcclusionEnabled(t),Promise.resolve()}_setAmbientOcclusionEnabled(t=!0){this._ambientOcclusionEnabled=t,this._engine.setAmbientOcclusionEnabled(this._id,t)}getAmbientOcclusionEnabled(){return this._ambientOcclusionEnabled}setAmbientOcclusionRadius(t){return this._setAmbientOcclusionRadius(t),Promise.resolve()}_setAmbientOcclusionRadius(t){this._ambientOcclusionRadius=t,this._engine.setAmbientOcclusionRadius(this._id,t)}getAmbientOcclusionRadius(){return this._ambientOcclusionRadius}setLightingEnabled(t=!0){return this._setLightingEnabled(t),Promise.resolve()}_setLightingEnabled(t=!0){this._lightingEnabled=t,this._engine.setLightingEnabled(this._id,t)}getLightingEnabled(){return this._lightingEnabled}setTransparencyMode(t){this._engine.setTransparencyMode(this._id,t)}setXRayOpacity(t,e){return this._setXRayOpacity(t,e),Promise.resolve()}_setXRayOpacity(t,e){this._engine.setXRayOpacity(this._id,t,e)}setXRayTransparencyMode(t){return this._setXRayTransparencyMode(t),Promise.resolve()}_setXRayTransparencyMode(t){this._engine.setXRayTransparencyMode(this._id,t)}setXRayColor(t,e,i=dl.Selected){return this._engine.setXRayColor(this._id,i,t,e),Promise.resolve()}unsetXRayColor(t,e=dl.Selected){return this._engine.unsetXRayColor(this._id,e,t)}setGoochBlue(t){this._goochBlue=t,this._engine.setGoochBlue(this._id,t)}getGoochBlue(){return this._goochBlue}setGoochBaseColorProminence(t){this._goochBaseColorProminence=t,this._engine.setGoochBaseColorProminence(this._id,t)}getGoochBaseColorProminence(){return this._goochBaseColorProminence}setGoochYellow(t){this._goochYellow=t,this._engine.setGoochYellow(this._id,t)}getGoochYellow(){return this._goochYellow}setToonShadingBandCount(t){this._toonBandCount=t,this._engine.setToonShadingBandCount(this._id,t)}getToonShadingBandCount(){return this._toonBandCount}setToonShadingSpecularFactor(t){this._toonSpecularFactor=t,this._engine.setToonShadingSpecularFactor(this._id,t)}getToonShadingSpecularFactor(){return this._toonSpecularFactor}setGoochLuminanceShiftStrength(t){this._goochLuminanceShiftStrength=t,this._engine.setGoochLuminanceShiftStrength(this._id,t)}getGoochLuminanceShiftStrength(){return this._goochLuminanceShiftStrength}setPointSize(t,e){return this._setPointSize(t,e),Promise.resolve()}_setPointSize(t,e){this._engine.setPointSize(this._id,t,e)}getPointSize(){return this._engine.getPointSize(this._id)}setPointShape(t){return this._setPointShape(t),Promise.resolve()}_setPointShape(t){this._engine.setPointShape(this._id,t)}getPointShape(){return this._engine.getPointShape(this._id)}setEyeDomeLightingEnabled(t=!0){return this._setEyeDomeLightingEnabled(t),Promise.resolve()}_setEyeDomeLightingEnabled(t=!0){this._engine.setEyeDomeLightingEnabled(this._id,t)}getEyeDomeLightingEnabled(){return this._engine.getEyeDomeLightingEnabled(this._id)}setEyeDomeLightingBlurSamples(t){return this._setEyeDomeLightingBlurSamples(t),Promise.resolve()}_setEyeDomeLightingBlurSamples(t){this._engine.setEyeDomeLightingBlurSamples(this._id,t)}getEyeDomeLightingBlurSamples(){return this._engine.getEyeDomeLightingBlurSamples(this._id)}setEyeDomeLightingBlurInterval(t){return this._setEyeDomeLightingBlurInterval(t),Promise.resolve()}_setEyeDomeLightingBlurInterval(t){this._engine.setEyeDomeLightingBlurInterval(this._id,t)}getEyeDomeLightingBlurInterval(){return this._engine.getEyeDomeLightingBlurInterval(this._id)}setEyeDomeLightingBlurEdgeDistance(t){return this._setEyeDomeLightingBlurEdgeDistance(t),Promise.resolve()}_setEyeDomeLightingBlurEdgeDistance(t){this._engine.setEyeDomeLightingBlurEdgeDistance(this._id,t)}getEyeDomeLightingBlurEdgeDistance(){return this._engine.getEyeDomeLightingBlurEdgeDistance(this._id)}setEyeDomeLightingShadingEdgeDistance(t){return this._setEyeDomeLightingShadingEdgeDistance(t),Promise.resolve()}_setEyeDomeLightingShadingEdgeDistance(t){this._engine.setEyeDomeLightingShadingEdgeDistance(this._id,t)}getEyeDomeLightingShadingEdgeDistance(){return this._engine.getEyeDomeLightingShadingEdgeDistance(this._id)}setEyeDomeLightingOpacity(t){return this._setEyeDomeLightingOpacity(t),Promise.resolve()}_setEyeDomeLightingOpacity(t){this._engine.setEyeDomeLightingOpacity(this._id,t)}getEyeDomeLightingOpacity(){return this._engine.getEyeDomeLightingOpacity(this._id)}setBoundingCalculationIgnoresInvisible(t){this._boundingCalculationIgnoresInvisible=t}getBoundingCalculationIgnoresInvisible(){return this._boundingCalculationIgnoresInvisible}setDisplayIncompleteFrames(t){return this._setDisplayIncompleteFrames(t),Promise.resolve()}_setDisplayIncompleteFrames(t){this._engine.setDisplayIncompleteFrames(t,this.id)}setMassageExtremeCameras(t){this._massageExtremeCameras=t}getMassageExtremeCameras(){return this._massageExtremeCameras}setInteractiveDrawDelay(t){return this._setInteractiveDrawDelay(t),Promise.resolve()}_setInteractiveDrawDelay(t){this._engine.setInteractiveDrawDelay(t,this.id)}setInteractiveDrawLimitIncreaseEnabled(t){this._engine.setInteractiveDrawLimitIncreaseEnabled(t,this.id)}getInteractiveDrawLimitIncreaseEnabled(){return this._engine.getInteractiveDrawLimitIncreaseEnabled(this.id)}setMinimumFramerate(t){this._engine.setMinimumFramerate(this.id,t)}redraw(t){if(t){const e=i=>{i===this.id&&(this._callbackManager.unbind({_drawComplete:e}),t())};this._callbackManager.bind({_drawComplete:e})}this._engine.redraw(this.id)}getNavCube(){return this._navCube}get navCube(){return this._navCube}getAxisTriad(){return this._axisTriad}get axisTriad(){return this._axisTriad}_determineViewAxes(t){const e=t.getUp().normalize(),i=_.subtract(t.getTarget(),t.getPosition()).normalize();let n=zp(e),r=zp(i);n===null&&r===null?(n=new _(0,1,0),r=new _(0,0,1)):n===null?r.y===0?n=new _(0,1,0):n=new _(0,0,1):r===null&&(n.z===0?r=new _(0,0,1):r=new _(0,1,0));try{this._model.setViewAxes(r,n)}catch{}}setAmbientLightColor(t){this._ambientLightColor=t,this._engine.setAmbientLightColor(this._id,t)}getAmbientLightColor(){return this._ambientLightColor}getLightKeys(){return this._engine.getLightKeys(this._id)}getLight(t){return this._engine.getLight(this._id,t)}clearLights(){this._engine.clearLights(this._id)}addLight(t){return this._engine.addLight(this._id,t)}removeLight(t){this._engine.removeLight(this._id,t)}updateLight(t,e){this._engine.updateLight(this._id,t,e)}setBloomEnabled(t=!0){this._engine.setBloomEnabled(this._id,t),this._bloomEnabled=t}getBloomEnabled(){return this._bloomEnabled}setBloomThreshold(t){this._engine.setBloomThreshold(this._id,t),this._bloomThreshold=t}getBloomThreshold(){return this._bloomThreshold}setBloomThresholdRampWidth(t){this._engine.setBloomThresholdRampWidth(this._id,t),this._bloomThresholdRampWidth=t}getBloomThresholdRampWidth(){return this._bloomThresholdRampWidth}setBloomIntensityScale(t){this._engine.setBloomIntensityScale(this._id,t),this._bloomIntensityScale=t}getBloomIntensityScale(){return this._bloomIntensityScale}setBloomLayers(t){const e=lc(t);for(const i of e)i.intensity===void 0&&(i.intensity=1),i.blurSamples===void 0&&(i.blurSamples=9),i.blurInterval===void 0&&(i.blurInterval=[1,Ls.Pixels]);this._engine.setBloomLayers(this._id,e),this._bloomLayers=e}getBloomLayers(){return lc(this._bloomLayers)}startComparison(t,e,i){const n=this._model._getModelStructure(),r=n.gatherInstanceIncsFromNodeIds(t,jt.All,zt.None),o=n.gatherInstanceIncsFromNodeIds(e,jt.All,zt.None);this._engine.startComparison(this._id,r,o,i)}endComparison(){this._engine.endComparison(this._id)}setSimpleShadowEnabled(t=!0){this._simpleShadowEnabled=t,this._engine.setSimpleShadowEnabled(this._id,t)}getSimpleShadowEnabled(){return this._simpleShadowEnabled}setSimpleShadowColor(t){this._simpleShadowColor=t.copy(),this._engine.setSimpleShadowColor(this._id,t)}getSimpleShadowColor(){return this._simpleShadowColor.copy()}setSimpleShadowOpacity(t){this._simpleShadowOpacity=t,this._engine.setSimpleShadowOpacity(this._id,t)}getSimpleShadowOpacity(){return this._simpleShadowOpacity}setGroundPlane(t){this._groundPlane={...t},this._updateGroundPlane()}_updateGroundPlane(t,e){if(!(this._groundPlane.followViewAxes&&(t!==void 0&&e!==void 0||this._model.viewAxesHaveBeenSet()))){this._engine.setGroundPlane(this._id,this._groundPlane.normal,this._groundPlane.position);return}if(t===void 0||e===void 0){const h=this._model.getViewAxes();t=h.frontVector,e=h.upVector}const i=t.copy().negate(),n=e,r=_.cross(n,i),o=_t.createFromBasis(i,r,n),l=new _(0,0,0);o.transform(this._groundPlane.normal,l),this._engine.setGroundPlane(this._id,l,this._groundPlane.position)}getGroundPlane(){return{...this._groundPlane}}setSimpleShadowResolution(t){this._simpleShadowResolution=t,this._engine.setSimpleShadowResolution(this._id,t)}getSimpleShadowResolution(){return this._simpleShadowResolution}setSimpleShadowBlurSamples(t){this._simpleShadowBlurSamples=t,this._engine.setSimpleShadowBlurSamples(this._id,t)}getSimpleShadowBlurSamples(){return this._simpleShadowBlurSamples}setSimpleShadowBlurInterval(t){this._simpleShadowBlurInterval=t,this._engine.setSimpleShadowBlurInterval(this._id,t)}getSimpleShadowBlurInterval(){return this._simpleShadowBlurInterval}setSimpleShadowInteractiveUpdateEnabled(t=!0){this._simpleShadowInteractiveUpdateEnabled=t,this._engine.setSimpleShadowInteractiveUpdateEnabled(this._id,t)}getSimpleShadowInteractiveUpdateEnabled(){return this._simpleShadowInteractiveUpdateEnabled}setSilhouetteEnabled(t=!0){this._silhouetteEnabled=t,this._engine.setSilhouetteEnabled(this._id,t)}getSilhouetteEnabled(){return this._silhouetteEnabled}setSilhouetteColor(t){this._silhouetteColor=t.copy(),this._engine.setSilhouetteColor(this._id,t)}getSilhouetteColor(){return this._silhouetteColor.copy()}setSilhouetteOpacity(t){this._silhouetteOpacity=t,this._engine.setSilhouetteOpacity(this._id,t)}getSilhouetteOpacity(){return this._silhouetteOpacity}setSilhouetteThreshold(t){this._silhouetteThreshold=t,this._engine.setSilhouetteThreshold(this._id,t)}getSilhouetteThreshold(){return this._silhouetteThreshold}setSilhouetteThresholdRampWidth(t){this._silhouetteThresholdRampWidth=t,this._engine.setSilhouetteThresholdRampWidth(this._id,t)}getSilhouetteThresholdRampWidth(){return this._silhouetteThresholdRampWidth}setHardEdgesEnabled(t=!0){this._hardEdgesEnabled=t,this._engine.setHardEdgesEnabled(this._id,t)}getHardEdgesEnabled(){return this._hardEdgesEnabled}setHardEdgeColor(t){this._hardEdgeColor=t.copy(),this._engine.setHardEdgeColor(this._id,t)}getHardEdgeColor(){return this._hardEdgeColor.copy()}setHardEdgeOpacity(t){this._hardEdgeOpacity=t,this._engine.setHardEdgeOpacity(this._id,t)}getHardEdgeOpacity(){return this._hardEdgeOpacity}setHardEdgeThreshold(t){this._hardEdgeThreshold=t,this._engine.setHardEdgeThreshold(this._id,t)}getHardEdgeThreshold(){return this._hardEdgeThreshold}setHardEdgeThresholdRampWidth(t){this._hardEdgeThresholdRampWidth=t,this._engine.setHardEdgeThresholdRampWidth(this._id,t)}getHardEdgeThresholdRampWidth(){return this._hardEdgeThresholdRampWidth}setSimpleReflectionEnabled(t=!0){this._simpleReflectionEnabled=t,this._engine.setSimpleReflectionEnabled(this._id,t)}getSimpleReflectionEnabled(){return this._simpleReflectionEnabled}setSimpleReflectionBlurInterval(t,e=Ls.Pixels){this._simpleReflectionBlurInterval=[t,e],this._engine.setSimpleReflectionBlurInterval(this._id,t,e)}getSimpleReflectionBlurInterval(){return[this._simpleReflectionBlurInterval[0],this._simpleReflectionBlurInterval[1]]}setSimpleReflectionBlurSamples(t){this._simpleReflectionBlurSamples=t,this._engine.setSimpleReflectionBlurSamples(this._id,t)}getSimpleReflectionBlurSamples(){return this._simpleReflectionBlurSamples}setSimpleReflectionFadeAngle(t){this._simpleReflectionFadeAngle=t,this._engine.setSimpleReflectionFadeAngle(this._id,t)}getSimpleReflectionFadeAngle(){return this._simpleReflectionFadeAngle}setSimpleReflectionOpacity(t){this._simpleReflectionOpacity=t,this._engine.setSimpleReflectionOpacity(this._id,t)}getSimpleReflectionOpacity(){return this._simpleReflectionOpacity}setSimpleReflectionAttenuation(t,e,i=Du.World){this._simpleReflectionAttenuation={nearDistance:t,farDistance:e,unit:i},this._engine.setSimpleReflectionAttenuation(t,e,i)}getSimpleReflectionAttenuation(){return{...this._simpleReflectionAttenuation}}testPointVisibility(t){return this._engine.testPointVisibility(this._id,t)}setPointVisibilityTest(t){this._engine.setPointVisibilityTest(this._id,t)}setImageBasedLightingEnabled(t){this._engine.setImageBasedLightingEnabled(this._id,t),this._imageBasedLightingEnabled=t}getImageBasedLightingEnabled(){return this._imageBasedLightingEnabled}setImageBasedLightingIntensity(t){this._engine.setImageBasedLightingIntensity(this._id,t),this._imageBasedLightingIntensity=t}getImageBasedLightingIntensity(){return this._imageBasedLightingIntensity}_copyImageBasedLightingOrientation(t){return{...t,matrix:t.matrix.copy()}}setImageBasedLightingOrientation(t){this._imageBasedLightingOrientation=this._copyImageBasedLightingOrientation(t),this._updateImageBasedLightingOrientation()}getImageBasedLightingOrientation(){return this._copyImageBasedLightingOrientation(this._imageBasedLightingOrientation)}_updateImageBasedLightingOrientation(t,e){let i;if(this._imageBasedLightingOrientation.followViewAxes){if(t===void 0||e===void 0)if(this._model.viewAxesHaveBeenSet()){const r=this._model.getViewAxes();t=r.frontVector,e=r.upVector}else t=new _(0,0,1),e=new _(0,1,0);const n=_t.createFromBasis(_.cross(e,t),e,t);i=_t.multiply(this._imageBasedLightingOrientation.matrix,n)}else i=this._imageBasedLightingOrientation.matrix;this._engine.setImageBasedLightingMatrix(this._id,i)}setImageBasedLightingEnvironment(t){t!=null?this._engine.setImageBasedLightingEnvironment(this._id,t):this._engine.setImageBasedLightingEnvironmentToDefault(this._id)}setLineJitterEnabled(t=!0){this._engine.setLineJitterEnabled(this._id,t),this._lineJitterEnabled=t}getLineJitterEnabled(){return this._lineJitterEnabled}setLineJitterInstanceCount(t){this._engine.setLineJitterInstanceCount(this._id,t),this._lineJitterInstanceCount=t}getLineJitterInstanceCount(){return this._lineJitterInstanceCount}setLineJitterRadius(t){this._engine.setLineJitterRadius(this._id,t),this._lineJitterRadius=t}getLineJitterRadius(){return this._lineJitterRadius}setLineJitterFrequency(t){this._engine.setLineJitterFrequency(this._id,t),this._lineJitterFrequency=t}getLineJitterFrequency(){return this._lineJitterFrequency}}class Tl{constructor(){this._remappedModelKeys=new Map,this._remappedInclusionKeys=new Map}remapModel(t,e){this._remappedModelKeys.set(e,t),this._remappedInclusionKeys.has(t)||this._remappedInclusionKeys.set(t,new Map)}remapInclusion(t,e,i){const n=this._remappedInclusionKeys.get(t);console.assert(n!==void 0),n.set(i,e)}getEffectiveModelKey(t){const e=this._remappedModelKeys.get(t);return e!==void 0?e:t}getEffectiveInclusionKey(t,e){const i=this._remappedInclusionKeys.get(e);if(i!==void 0){const n=i.get(t);if(n!==void 0)return n}return t}}async function Qb(s){const t=[],i={enterProductOccurrence:n=>{n.hasPendingExternalModels()&&t.push(n)}};return await Nn.walk(i,s,zt.None),t}class tI{constructor(){this._currentTime=0,this._stopTime=0}stop(){this._stopTime=this._currentTime}isTicking(){return this._refreshCurrentTime(),this._remainingDuration()>0}tickFor(t){this._refreshCurrentTime(),!(this._remainingDuration()>=t)&&(this._stopTime=this._currentTime+t)}_remainingDuration(){return this._stopTime-this._currentTime}_refreshCurrentTime(){this._currentTime=Date.now()}}const eI=4294967296;class iI{constructor(){this.prototypes=new Map,this.partDefinitions=new Map}}class nI{constructor(){this.bodies=new Map,this.contexts=[]}}class sI{constructor(t,e,i,n,r){this._centralQueueClock=new tI,this._productOccurrences=new Map,this._pmis=new Map,this._cadViews=new Map,this._bodyInstances=new Map,this._pmiBodies=new Map,this._viewFrames=new Map,this._partDefinitions=new Map,this._representationItems=new Map,this._partToInstance=new Map,this._filters=[],this._layers=new Map,this._layersIds=new Map,this._nextLayerId=0,this._genericTypeToNodes=new Map,this._genericIdToNodes=new Map,this._cadConfigurations=new Set,this._modelContents=new Map,this._inclusionContents=new Map,this._nodeDeletionBlackList=new Set,this._meshDeletionBlackList=new Set,this._dynamicNodeIdSeed=Ts,this._currentNodeIdOffset=0,this._initialEmptyNodeIdOffsetObtained=!1,this._activeCadView=null,this._activeCadConfiguration=null,this._defaultCadConfiguration=null,this._defaultCadViewsByConfiguration=new Map,this._firstProductOccurrenceWithView=null,this._containsDrawings=!1,this._isMeasurable=!1,this._automaticMeasurementUnitScaling=!0,this._initiallyHiddenStayHidden=!0,this._nextLoadId=0,this._activeLoadIds=new Set,this._requestedNodes=new Map,this._unnamedProductCount=0,this._unnamedGroupCount=0,this._unnamedDrawingSheetCount=0,this._unnamedDrawingViewCount=0,this._isInitialized=!1,this._seenExternalModel=!1,this._config={...t},this._engine=e,this._callbackManager=i,this._cuttingManager=n,this._model=r,this._isScs=this._engine.getSessionType()===Xi.Scs,console.assert(!this._isScs||this._engine.getRendererType()===ll.Client)}initialize(t){console.assert(this._rootLoadContext===void 0),console.assert(this._rootNode===void 0),console.assert(!this._isInitialized),this._isInitialized=!0,console.assert(this._centralQueue===void 0),this._centralQueue=new No(t.maxConcurrentAttachments(),!1),this._callbackManager.bind({_inputInteraction:(n,r)=>{this._onUserInteraction(n,r)}}),this._rootLoadContext=new Os(null,Oo,null);const e=new Sn(new Tl,ta.OfInitialEmptyModel,!1,Er.Local,this._rootLoadContext);this._rootLoadContext.addAttachContext(e);const i=new Hn(this,e,ki.Local,fs.Local);e.addInclusionContext(i),this._rootNode=me.createDynamic(this,i,"Models",null,null,!0),i.addProductOccurrence(this._rootNode),console.assert(this._rootNode.isAbsoluteRoot()),this.preventNodeDeletion(this._rootLoadContext),this.preventNodeDeletion(e),this.preventNodeDeletion(i),this.preventNodeDeletion(this._rootNode),this._rootNode.markLoaded()}isInitialized(){return this._isInitialized}getRootNode(){return this._rootNode}getAbstractScEngine(){return this._engine}generateDynamicNodeId(){return--this._dynamicNodeIdSeed}newNodeIdOffset(){if(!this._initialEmptyNodeIdOffsetObtained)return this._initialEmptyNodeIdOffsetObtained=!0,console.assert(this._currentNodeIdOffset===0),0;const t=this._currentNodeIdOffset;return this._currentNodeIdOffset+=eI,t}getLowestAvailableNodeId(){return this._currentNodeIdOffset}tryParseHeader(t){const e=qs.parseBinary(t);return e===null?null:(this._containsDrawings=this._containsDrawings||e.isDrawing,this._isMeasurable=this._isMeasurable||e.isMeasurable,this._callbackManager.promiseTrigger("_modelStructureHeaderParsed",null,e).then(()=>(this._callbackManager.trigger("modelStructureHeaderParsed",e.originalFileName,e.originalFileType),e)))}_isRegistered(t){return this._productOccurrences.has(t)||this._pmis.has(t)||this._cadViews.has(t)||this._bodyInstances.has(t)||this._pmiBodies.has(t)||this._viewFrames.has(t)||this._partDefinitions.has(t)||this._representationItems.has(t)}registerProductOccurrence(t){if(!t.isMissing()){const e=t.getRuntimeId();console.assert(!this._isRegistered(e)),this._productOccurrences.set(e,t);const i=Hc(t);i!==null&&this.registerGenericType(t,i);const n=t.getGenericId();n!==null&&this.registerGenericGlobalId(t,n),t.isAConfigurationNode()&&this._registerCadConfiguration(t),(t.isADrawingSheetNode()||t.isADrawingViewNode())&&(this._containsDrawings=!0)}}lookupProductOccurrence(t){const e=this._productOccurrences.get(t);return e!==void 0?e:null}registerPmi(t){const e=t.getRuntimeId();console.assert(!this._isRegistered(e)),this._pmis.set(e,t)}lookupPmi(t){const e=this._pmis.get(t);return e!==void 0?e:null}registerCadView(t){this._firstProductOccurrenceWithView===null&&(this._firstProductOccurrenceWithView=t.getParent());const e=t.getRuntimeId();console.assert(!this._isRegistered(e)),this._cadViews.set(e,t),t.isDefaultView()&&this._defaultCadViewsByConfiguration.set(this._firstProductOccurrenceWithView,t)}getFirstProductOccurrenceWithView(){return this._firstProductOccurrenceWithView}lookupCadView(t){const e=this._cadViews.get(t);return e!==void 0?e:null}registerBodyInstance(t,e){const i=t.getRuntimeId();console.assert(!this._isRegistered(i)),this._bodyInstances.set(i,t),this._registerAnyBodyByInstanceInc(t,e)}lookupBodyInstance(t){const e=this._bodyInstances.get(t);return e!==void 0?e:null}registerPmiBody(t,e){const i=t.getRuntimeId();console.assert(!this._isRegistered(i)),this._pmiBodies.set(i,t),this._registerAnyBodyByInstanceInc(t,e)}lookupPmiBody(t){const e=this._pmiBodies.get(t);return e!==void 0?e:null}registerViewFrame(t,e){const i=t.getRuntimeId();console.assert(!this._isRegistered(i)),this._viewFrames.set(i,t),this._registerAnyBodyByInstanceInc(t,e)}lookupViewFrame(t){const e=this._viewFrames.get(t);return e!==void 0?e:null}registerPartDefinition(t){if(!t.isMissing()){const e=t.getRuntimeId();console.assert(!this._isRegistered(e)),this._partDefinitions.set(e,t)}}lookupPartDefinition(t){const e=this._partDefinitions.get(t);return e!==void 0?e:null}registerRepresentationItem(t){const e=t.getRuntimeId();console.assert(!this._isRegistered(e)),this._representationItems.set(e,t)}lookupRepresentationItem(t){const e=this._representationItems.get(t);return e!==void 0?e:null}lookupAnyBody(t){return this.lookupBodyInstance(t)||this.lookupPmiBody(t)||this.lookupViewFrame(t)}lookupAnyTreeNode(t){return this.lookupProductOccurrence(t)||this.lookupPmi(t)||this.lookupCadView(t)||this.lookupAnyBody(t)}lookupAnyNonTreeNode(t){return this.lookupRepresentationItem(t)||this.lookupPartDefinition(t)}lookupAnyNode(t){return this.lookupAnyTreeNode(t)||this.lookupAnyNonTreeNode(t)}_registerCadConfiguration(t){console.assert(t.isAConfigurationNode()),console.assert(!this._cadConfigurations.has(t)),this._cadConfigurations.add(t),t.isADefaultNode()&&this._defaultCadConfiguration===null&&(this._defaultCadConfiguration=t)}getInstanceCountByInclusion(t){return this._getInclusionContent(t).bodies.size}lookupAnyBodyByInstanceInc(t,e){const n=this._getInclusionContent(t).bodies.get(e);return n!==void 0?n:null}_registerAnyBodyByInstanceInc(t,e){const i=t.getInstanceInc(),n=this._getInclusionContent(e),r=n.bodies.get(i[1]);if(r!==void 0)if(console.assert(t.hasAuthoredId()),r.hasAuthoredId()){console.assert(r.constructor===t.constructor);return}else{const o=r;console.assert(o.constructor===zi);const l=o.getRuntimeId();o.getParent().removeBodyInstance(o),t instanceof zi?this._bodyInstances.set(l,t):t instanceof Ds?this._pmiBodies.set(l,t):this._viewFrames.set(l,t)}n.bodies.set(i[1],t)}_getInclusionContent(t){console.assert(t!==ki.Invalid);let e=this._inclusionContents.get(t);return e===void 0&&(e=new nI,this._inclusionContents.set(t,e)),e}_getModelContent(t,e){console.assert(e!==fs.Invalid);let i=this._modelContents.get(t);i===void 0&&(i=new Map,this._modelContents.set(t,i));let n=i.get(e);return n===void 0&&(n=new iI,i.set(e,n)),n}registerPrototypeByDataId(t,e,i,n){const r=this._getModelContent(t,e);console.assert(!r.prototypes.has(i)),r.prototypes.set(i,n)}registerPartDefinitionByDataId(t,e,i,n){const r=this._getModelContent(t,e);console.assert(!r.partDefinitions.has(i)),r.partDefinitions.set(i,n)}lookupPrototypeByDataId(t,e,i){const r=this._getModelContent(t,e).prototypes.get(i);return r!==void 0?r:null}lookupPartDefinitionByDataId(t,e,i){const r=this._getModelContent(t,e).partDefinitions.get(i);return r!==void 0?r:null}registerInclusionContext(t){const e=t.getInclusionKey();this._getInclusionContent(e).contexts.push(t)}getInclusionContexts(t){return this._getInclusionContent(t).contexts}_createLayer(t,e,i,n){const r=new so(t,e,i,n);return console.assert(!this._layers.has(t)),this._layers.set(t,r),e!==null&&this._updateNameToLayersMap(e,t),r}_updateNameToLayersMap(t,e){const i=this._layersIds.get(t);i!==void 0?i.push(e):this._layersIds.set(t,[e])}createLayer(t,e,i){const n=this._nextLayerId++,r=this._createLayer(n,e,[],[]);return i.addLayerIdToMap(n,t),r}updateLayerName(t,e){const i=this._layers.get(t);i!==void 0&&(i.name=e,this._updateNameToLayersMap(e,t))}_registerNodeInLayer(t,e,i){const n=Ks(t);let r=n.getRuntimeLayerId(e);e===so.NoLayerId&&r===null?r=this.createLayer(so.NoLayerId,"No layer",n).id:r===null&&(r=this._nextLayerId++,this._createLayer(r,null,[],[]),n.addLayerIdToMap(r,e));const o=this._layers.get(r);o!==void 0?i(o).push(t):(console.assert(!1,"Layer has mapping in LoadContext but not represented in AssemblyTree"),this._createLayer(r,null,[t],[]),n.addLayerIdToMap(r,e))}registerNodeInLayer(t,e){return this._registerNodeInLayer(t,e,i=>i.nodes)}registerTreeNodeInLayer(t,e){return this._registerNodeInLayer(t,e,i=>i.treeNodes)}addFilter(t,e){this._filters.push({filter:t,loadContext:e})}getFilters(){const t=new Map;for(let e=0;e<this._filters.length;e++){const i=this.getFilterName(e)||"";t.set(e,i)}return t}getFilterName(t){if(t<this._filters.length){const{filter:e}=this._filters[t];return e.name||""}return null}getFiltersWithNode(t){const e=t.getAuthoredId(),i=this._filters,n=[];for(let r=0;r<i.length;r++){const{filter:o,loadContext:l}=i[r];if(o.layers!==null)for(const h of o.layers.authoredIds){const u=l.getRuntimeLayerId(h);if(u===null)continue;const d=this.getNodesFromLayer(u);if(d!==null)for(const g of d)t===g&&n.push(r)}if(o.entities!==null)for(const h of o.entities.ids)e===h&&n.push(r)}return n}getNodesFromFilterIds(t){const e=new Set,i=new Set;let n=null;for(const r of t){const{filter:o,loadContext:l}=this._filters[r],h=o.layers;if(h!==null){const d=h.isInclusive;n===null&&(n=d);for(const g of h.authoredIds){const y=l.getRuntimeLayerId(g);if(y===null)continue;const m=this._layers.get(y);if(m&&m.nodes!==null)for(const I of m.nodes){const b=I.getRuntimeId();d?(e.add(b),i.delete(b)):(e.delete(b),i.add(b))}}}const u=o.entities;if(u!==null){const d=u.isInclusive;n===null&&(n=d);for(const g of u.ids)d?(e.add(g),i.delete(g)):(e.delete(g),i.add(g))}}return n===null?null:n?new Rf(!0,e):new Rf(!1,i)}getLayers(){const t=new Map;return this._layers.forEach((e,i)=>{const n=e.name||"";t.set(i,n)}),t}getUniqueLayerNames(){const t=new Set,e=[];return this._layers.forEach(i=>{const n=i.name;n!==null&&(t.has(n)||(t.add(n),e.push(n)))}),e}getLayerName(t){const e=this._layers.get(t);return e!==void 0?e.name||"":null}getLayersIdFromName(t){const e=this._layersIds.get(t);return e!==void 0?e:null}getNodesFromLayer(t,e){const i=this._layers.get(t);return i!==void 0?e?i.treeNodes:i.nodes:null}getNodesFromLayers(t,e){const i=[];for(const n of t){const r=this.getNodesFromLayer(n,e);if(r!==null)for(const o of r)i.push(o)}return i}getNodesFromLayerName(t,e){const i=this._layersIds.get(t);return i!==void 0?this.getNodesFromLayers(i,e):null}generateProductName(){return`Product ${this._unnamedProductCount++}`}generateGroupName(){return`Product ${this._unnamedGroupCount++}`}generateDrawingSheetName(){return`Product ${this._unnamedDrawingSheetCount++}`}generateDrawingViewName(){return`Product ${this._unnamedDrawingViewCount++}`}forEachCadView(t){this._cadViews.forEach(t)}forEachPmi(t){this._pmis.forEach(t)}forEachCadConfiguration(t){this._cadConfigurations.forEach(t)}hasActiveCadView(){return this._activeCadView!==null}activateCadView(t,e,i,n){return console.assert(this._activeCadView===null),this._activeCadView=e,e.activate(this,this._engine,this._callbackManager,this._cuttingManager,t,i,n,this._activeCadConfiguration)}async deactivateActiveCadView(){this._activeCadView!==null&&(await this._activeCadView.deactivate(this._cuttingManager),console.assert(this._activeCadView!==null),this._activeCadView=null)}getDefaultCadView(t){let e;return t===null?this._defaultCadViewsByConfiguration.size===1&&(e=this._defaultCadViewsByConfiguration.values().next().value):e=this._defaultCadViewsByConfiguration.get(t),e!==void 0?e:null}getCadViewPmis(t){const e=[];return this._pmis.forEach(i=>{t.hasPmi(i)&&e.push(i)}),e}isMeasurable(){return this._isMeasurable}containsDrawings(){return this._containsDrawings}getCadConfigurations(){const t=[];return this._cadConfigurations.forEach(e=>{t.push(e)}),t}getDefaultCadConfiguration(){return this._defaultCadConfiguration}getActiveCadConfiguration(){return this._activeCadConfiguration}activateCadConfiguration(t){console.assert(t.isAConfigurationNode()),this._activeCadConfiguration=t}massageAuthoredUserId(t,e){if(e===null)return this.generateDynamicNodeId();{const i=t.toRuntimeId(e);return this.lookupAnyNode(i)!==null?this.generateDynamicNodeId():e}}createNode(t,e,i,n,r,o=null){const l=me.createDynamic(this,t,e,i,n,r,!1,o);return t.addProductOccurrence(l),l.markLoaded(),l}createPart(t){const e=os.createDynamic(this,t,null);return e.markLoaded(),e}setPart(t,e){e.addReferrer(t);let i=this._partToInstance.get(e);if(i===void 0){const n=Gi(this._rootNode),r=()=>{const l={},h=To.create(()=>(console.assert(l.node!==void 0),new vf(zn.create(l.node))));return l.instance=new sl(h,n),l.node=me.createDynamic(this,l.instance,null,null,null,!0),l.node.setPartDefinition(e),l.node.markLoaded(),l},{instance:o}=r();i=o}t.setPrototype(i)}_createCadView(t,e,i,n,r,o,l,h){const u=as.createDynamic(this,t,e,i,n,r,o,l,h);return t.addCadView(u),u.markLoaded(),u}async _createCadViewInstance(t,e,i){if(i!==null){const[n,r]=await t.createMeshInstance(i),h={nodeInfo:{nodeId:this.generateDynamicNodeId(),bits:Vi.IsShownSpecified|Vi.IsShown,name:null,localTransform:null,attributes:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null},inclusionKey:n,instanceKey:r,bits:0,modifierbits:0},d=Di(e).getMasterModelKey();console.assert(e.isLoaded());const g=ro.reify(this,d,e,h);e.setViewFrame(g),g.markLoaded()}}createCadView(t,e,i,n,r,o,l,h,u,d){const g=this._createCadView(e,i,n,r,o,l,h,u);return d!==null&&this._createCadViewInstance(t,g,d),g}createMeshInstance(t,e,i,n,r,o,l,h,u,d){let g=0;u&&(g|=Vi.InitiallyShown);let y=0;l&&(y|=Mr.PreventFromResetting),h&&(y|=Mr.OutOfHierarchy),d&&(y|=Mr.ImplicitBody);const m=zi.createDynamic(this,e,i,n,r,o,g,y);return o.addBodyInstance(m),t&&m.markLoaded(),m}createPmiInstance(t,e,i,n,r,o,l,h){const u=Gi(r),y={nodeInfo:{nodeId:this.massageAuthoredUserId(u,i),bits:Vi.InitiallyShown,name:n,localTransform:null,attributes:[],header:qs.dynamic,exchangeId:null,layerId:null,genericTypeId:null,genericId:null,userDatas:null},inclusionKey:t,instanceKey:e,bits:0,modifierbits:0},m=Cn.createDynamic(this,u,r,n,o,l,[y],h);return r.addPmi(m),m.markLoaded(),m}getRelationshipsOfItem(t,e){const i=new Map;let n=[];const r=this.lookupAnyTreeNode(t);if(r===null)return i;n=Gi(r).getRelationships();for(const l of n)if(l.relating!==null&&l.relating.relationElt.id===e)ha.addFromRelatingElt(l,i);else{const h=l.related;let u=-1;h!==null&&(u=ha.findIndexInRelated(e,h.relationships)),u>=0&&ha.addFromRelatedElt(l,i)}return i}getAutomaticMeasurementUnitScaling(){return this._automaticMeasurementUnitScaling}setAutomaticMeasurementUnitScaling(t){this._automaticMeasurementUnitScaling=t}getInitiallyHiddenStayHidden(){return this._initiallyHiddenStayHidden}setInitiallyHiddenStayHidden(t){this._initiallyHiddenStayHidden=t}async _removeIdMappingsRecursive(t){const e=h=>{const u=h.getGenericId();if(u!==null){const g=this._genericIdToNodes.get(u);g!==void 0&&g.delete(h)}const d=Hc(h);if(d!==null){const g=this._genericTypeToNodes.get(d);g!==void 0&&g.delete(h)}},i=h=>{const u=new Map;for(const d of h){const g=d.getAuthoredLayerId();if(g===null)continue;const m=Ks(d).getRuntimeLayerId(g);if(m===null)continue;const I=u.get(m);I===void 0?u.set(m,[d]):I.push(d)}u.forEach((d,g)=>{const y=this._layers.get(g);y.nodes=y.nodes.filter(m=>d.indexOf(m)===-1),y.treeNodes=y.treeNodes.filter(m=>d.indexOf(m)===-1)})},n=h=>{const u=new Set;h.forEach(d=>{const g=d.getInstanceInc();u.add(g[0])}),u.forEach(d=>{const g=this._inclusionContents.get(d);if(g!==void 0)for(const y of h){const m=y.getInstanceInc();m[0]===d&&g.bodies.delete(m[1])}})},r=[],o=[],l={enterProductOccurrence:h=>{e(h),this._productOccurrences.delete(h.getRuntimeId()),r.push(h)},enterAnyBody:h=>{e(h);const u=h.getRuntimeId();h instanceof zi?this._bodyInstances.delete(u):h instanceof Ds?this._pmiBodies.delete(u):this._viewFrames.delete(u),r.push(h),o.push(h)},enterCadView:h=>{this._cadViews.delete(h.getRuntimeId())},enterPmi:h=>{this._pmis.delete(h.getRuntimeId())}};await Nn.walk(l,t,zt.None),i(r),n(o)}async deleteNode(t){if(!this._canDeleteNode(t)){const i=t.getRuntimeId();throw new ae(`Cannot delete node (${i})`)}const e=Lc(t,jt.All,!0,new Set,zt.None);if(this._engine.setPartVisibility(e,!1,!1),this._engine.setInstanceModifier($i.DoNotSelect,e,!0),t instanceof me){this._cadConfigurations.delete(t)&&(t===this._activeCadConfiguration&&(this._activeCadConfiguration=null),t===this._defaultCadConfiguration&&(this._defaultCadConfiguration=null));const i=t.getParent(),n=Ks(i);if(console.assert(i!==null),i!==null){let r;if(i instanceof sl)r=i.removeReferrer(t);else if(i instanceof Hn&&i.getChildren().length===1){const o=i.getInclusionKey();this._inclusionContents.delete(o);const l=i.getModelKey(),h=this._modelContents.get(n);h!==void 0&&(h.delete(l),h.size===0&&this._modelContents.delete(n)),r=i.removeProductOccurrence(t)}else r=i.removeProductOccurrence(t);console.assert(r)}return this._productOccurrences.delete(t.getRuntimeId()),await this._removeIdMappingsRecursive(t),n.getChildren().length===0?n.purgeContents():t.purgeContents()}else if(t instanceof Cn)t.getParent().removePmi(t),this._pmis.delete(t.getRuntimeId());else{t.getParent().removeBodyInstance(t);const n=t.getInstanceInc();this._getInclusionContent(n[0]).bodies.delete(n[1]),this._bodyInstances.delete(t.getRuntimeId())}}_canDeleteNode(t){return!this._nodeDeletionBlackList.has(t)}allowNodeDeletion(t){this._nodeDeletionBlackList.delete(t)}preventNodeDeletion(t){const e=t.getParent();if(e instanceof sl)throw new ei;if(e!==null){if(console.assert(e===null||this._nodeDeletionBlackList.has(e)),t instanceof me)console.assert(!t.hasAuthoredId()),console.assert(!t.isOutOfHierarchy());else if(t instanceof zi){const i=t.getInstanceInc();console.assert(!t.hasAuthoredId()),console.assert(i[0]===ki.Local),console.assert(t.isOutOfHierarchy())}}this._nodeDeletionBlackList.add(t)}preventMeshDeletion(t){this._meshDeletionBlackList.add(t)}async _resetContents(){if(this.hasActiveCadView())return await this.deactivateActiveCadView(),this._resetContents();await this._rootLoadContext.purgeContents(),this._productOccurrences.clear(),this._pmis.clear(),this._cadViews.clear(),this._bodyInstances.clear(),this._pmiBodies.clear(),this._viewFrames.clear(),this._partDefinitions.clear(),this._representationItems.clear(),this._partToInstance.clear(),this._filters.length=0,this._layers.clear(),this._layersIds.clear(),this._genericTypeToNodes.clear(),this._genericIdToNodes.clear(),this._cadConfigurations.clear(),this._modelContents.clear(),this._inclusionContents.clear(),this._currentNodeIdOffset=0,this._activeCadView=null,this._activeCadConfiguration=null,this._defaultCadConfiguration=null,this._firstProductOccurrenceWithView=null,this._containsDrawings=!1,this._isMeasurable=!1,this._requestedNodes.clear(),this._unnamedProductCount=0,this._unnamedGroupCount=0,this._unnamedDrawingSheetCount=0,this._unnamedDrawingViewCount=0,this._seenExternalModel=!1,this._rootNode.unsetMeasurementUnit(),this._nodeDeletionBlackList.forEach(t=>{if(t instanceof me){const e=t.getRuntimeId();this._productOccurrences.set(e,t);const i=t.getParent();i instanceof sl?console.assert(!1):i.addProductOccurrence(t),t.setVisibility(!0),t.unsetMeasurementUnit(),t.hasLocalTransformOverride()&&t.removeLocalTransformOverride()}else if(t instanceof zi){const e=t.getRuntimeId();this._bodyInstances.set(e,t);const i=t.getInstanceInc(),n=i[0];console.assert(n===ki.Local),this._getInclusionContent(n).bodies.set(i[1],t),t.getParent().addBodyInstance(t)}else if(t instanceof Cn){const e=t.getRuntimeId();this._pmis.set(e,t),t.getParent().addPmi(t)}else if(t instanceof Os){const e=t.getParent();e!==null&&e.addLoadContext(t)}else if(t instanceof Sn){const e=t.getParent();e instanceof me,e.addAttachContext(t)}else{const e=t.getInclusionKey();console.assert(e===ki.Local),this._getInclusionContent(e).contexts.push(t),t.getParent().addInclusionContext(t)}})}async reset(){await this._callbackManager.promiseTrigger("_resetAssemblyTreeBegin",null),await this._resetContents();const t=[];this._nodeDeletionBlackList.forEach(i=>{if(i instanceof zi){const n=i.getInstanceInc();console.assert(n[0]===ki.Local),t.push(n[1])}});const e=[];this._meshDeletionBlackList.forEach(i=>{e.push(i)}),await this._engine.resetToEmpty(t,e),await this._resetContents()}setViewAxes(t,e){this._model.setViewAxes(t,e)}async _requestIncsOfNodes(t){if(this._config.streamingMode!==lo.OnDemand)return;const e=new Set,i=[],n=[];for(const l of t){const h=mm(l,jt.All,!1,e).then(u=>{for(const d of u)i.push(d)});n.push(h)}await Ue(n);const r=[],o=[];e.forEach(l=>{if(!l.isRequested()){l.setRequested();const h=l.isInitiallyShown();h!==l.isVisible()&&(h?(l.setVisibility(!0),r.push(l.getRuntimeId())):(l.setVisibility(!1),o.push(l.getRuntimeId())))}}),r.length+o.length>0&&this._callbackManager.trigger("visibilityChanged",r,o),this._engine.requestMeshInstances(i)}async _requestExternalModelsLocal(t,e,i){const n=await e.loadPendingExternalModels(t);return n.length!==0&&(await ua(n),await this._requestNodes(t,[e],i)),n}async _requestExternalModelsNonLocal(t,e,i){const n=await Qb(e);if(n.length===0)return[];const r=[];for(const l of n){const h=this._requestExternalModelsLocal(t,l,i);r.push(h)}return(await Promise.all(r)).flat()}async _requestExternalModelsOfNodes(t,e,i){const n=[];for(const o of e){const l=this._requestExternalModelsNonLocal(t,o,i);n.push(l)}return(await Promise.all(n)).flat()}async _requestNodes(t,e,i){if(!i){const h=this._activeLoadIds.size!==0,u=[];h&&this._activeLoadIds.forEach(d=>{u.push(d)});for(const d of e)h&&this._requestedNodes.set(d,u),d instanceof me&&t.notifyDirectRequest(d)}const n=this._requestIncsOfNodes(e),r=this._requestExternalModelsOfNodes(t,e,i),o=[n,r];return(await Promise.all(o))[1]}async requestNodes(t,e,i){const n=await this._requestNodes(t,e,i),r=[];for(const o of n){const l=o.getChildren();r.push(...l)}if(r.length>0){const o=r.map(l=>l.getRuntimeId());await this._callbackManager.promiseTrigger("_subtreeLoaded","subtreeLoaded",o,Dr.LoadModel)}}isBeingRequested(t){let e=t;const i=!1;do if(e instanceof Jn){if(this._requestedNodes.has(e))return!0;e=e.getParent()}else if(e instanceof Sn)e=e.getParent();else if(e instanceof Hn)e=e.getParent();else if(e instanceof Os){const n=e.getParent();if(n===null)return!1;e=n}else return console.assert(!1),!1;while(!i);return!1}onDemandRequestsActive(){return this._requestedNodes.size!==0}onLoadBegin(){const t=this._nextLoadId++;return this._activeLoadIds.add(t),t}onLoadEnd(t){this._activeLoadIds.delete(t);const e=[];this._requestedNodes.forEach((i,n)=>{let r=!0;for(const o of i)if(this._activeLoadIds.has(o)){r=!1;break}r&&e.push(n)});for(const i of e)this._requestedNodes.delete(i)}markSeenExternalModel(){this._seenExternalModel=!0}seenExternalModel(){return this._seenExternalModel}getNodesByGenericId(t){return this._genericIdToNodes.get(t)||null}getNodesByGenericType(t){return this._genericTypeToNodes.get(t)||null}genericTypeToNodes(){return this._genericTypeToNodes}registerGenericGlobalId(t,e){let i=this._genericIdToNodes.get(e);i===void 0&&(i=new Set),i.add(t),this._genericIdToNodes.set(e,i)}registerGenericType(t,e){let i=this._genericTypeToNodes.get(e);i===void 0&&(i=new Set),i.add(t),this._genericTypeToNodes.set(e,i)}disableAutomaticFitWorld(){return this._config.disableAutomaticFitWorld}markImplicitNodesOutOfHierarchy(){return this._config.markImplicitNodesOutOfHierarchy}async _throttleLoad(){this._engine.throttleLoad(200,200),await this._engine.sleep(20)}enqueue(t){const e=typeof t=="function"?gs.create(t):t;return this._centralQueue.push(async()=>{const i=this._isScs&&this._centralQueueClock.isTicking();i&&await this._throttleLoad();const n=await e.get();return i&&await this._throttleLoad(),n})}_onUserInteraction(t,e){if(!this._isScs)return;let i=!1;switch(e){case le.MouseDown:case le.MouseUp:case le.Mousewheel:case le.TouchStart:case le.TouchMove:case le.TouchEnd:case le.KeyDown:case le.KeyUp:case le.ViewOrientationChange:i=!0;break;case le.MouseMove:i=t.getButtons()!==ls.None;break;default:Tr()}i&&this._centralQueueClock.tickFor(1e3)}}class my{constructor(t,e){this._inclusionsOf=new Map,this._masterModelKey=Er.Invalid,this._prototypeInstanceCount=-1,this._attachScope=t,this._attachedInvisibly=e}getAttachScope(){return this._attachScope}getMasterModelKey(){return console.assert(this._masterModelKey!==Er.Invalid),this._masterModelKey}getModelKeys(){const t=[];return this._inclusionsOf.forEach((e,i)=>{t.push(i)}),t}hasInclusions(){return this._inclusionsOf.size>0}getAllInclusions(){const t=[];return this._inclusionsOf.forEach((e,i)=>{for(const n of e)t.push(n,i)}),t}getInclusionsOf(t){t=t;const e=this._inclusionsOf.get(t);if(e===void 0)return[];const i=[];for(const n of e)i.push(n,t);return i}hasModelIncluded(t){return this._inclusionsOf.has(t)}attachedInvisibly(){return this._attachedInvisibly}prototypeInstanceCount(){return console.assert(this._prototypeInstanceCount>=0),this._prototypeInstanceCount}registerInclusion(t,e){const i=this._inclusionsOf.get(e);i===void 0?this._inclusionsOf.set(e,[t]):i.push(t)}registerMasterModelKey(t){console.assert(this._masterModelKey===Er.Invalid),this._masterModelKey=t}registerPrototypeInstanceCount(t){console.assert(this._prototypeInstanceCount===-1),this._prototypeInstanceCount=t}}class rI{constructor(){this._calculatedCutoff=0,this._requireBoundingInfo=!1,this._prevPriorityValue=1,this._priorityProxies=new Map}getPriorityCompareValue(t){if(typeof t=="number")return t;{const e=this._priorityProxies.get(t);return e.worldBounding!==null&&console.assert(e.priorityHeuristic<=1),e.priorityHeuristic}}setRequireBoundingInfo(t){this._requireBoundingInfo=t}comparePriority(t,e){const i=this.getPriorityCompareValue(t),n=this.getPriorityCompareValue(e);return i<n}_updateHeuristicInfo(t,e){var i;if(e.worldBounding!==null){const n=ol(e.worldBounding.center()),r=ol(e.worldBounding.extents()),o=t.calculateAttachHeuristic(r,n);e.priorityHeuristic=o}if((i=e.xmlAttachInfo)!=null&&i.directlyRequested){e.worldBounding===null&&(e.priorityHeuristic=0);const n=-1e6;e.priorityHeuristic+=n}}createPriority(t,e,i){if(i===null)return++this._prevPriorityValue;const n=Object.create(null);let r,o;if(i.bounding!==null)r=e.transformBox(i.bounding),o=0;else{if(this._requireBoundingInfo)throw new Error("WorldBounding must be specified when streamCutoff is enabled");r=null,o=++this._prevPriorityValue}const l={xmlAttachInfo:i,worldBounding:r,priorityHeuristic:o};return this._updateHeuristicInfo(t,l),this._priorityProxies.set(n,l),n}destroyPriority(t){typeof t=="object"&&this._priorityProxies.delete(t)}onViewChange(t,e,i){this._calculateCutoff(i.getProjectionMatrix(e.getCamera(),e.id)),this._priorityProxies.forEach(n=>{this._updateHeuristicInfo(t,n)})}reset(){this._priorityProxies.clear()}_calculateCutoff(t){let i=.98;t.m[11]!==0&&(i=(1-t.m[15])/t.m[11]*t.m[10]+t.m[14]);const n=_t.inverse(t);if(!n)throw new Error;const r=Af(n.transform4(new rr(0,0,i,1))),o=Af(n.transform4(new rr(.0125,0,i,1))),l=Af(n.transform4(new rr(0,.0125,i,1)));Tf(1/r[3],r),Tf(1/o[3],o),Tf(1/l[3],l),this._calculatedCutoff=Math.min(Mm(Mf(o,r)),Mm(Mf(l,r)))}getCalculatedCutoff(){return this._calculatedCutoff}}class ld{constructor(t){this._planes=[],this._absPlanes=[],this._signs=[],this._distanceScale=[];const e=t.length;for(const i of t)this._planes.push(i.slice());for(let i=0;i<e;++i){this._planes[i][3]=-this._planes[i][3],this._absPlanes[i]=Y0(this._planes[i]),this._signs[i]=[0,0,0];for(let n=0;n<3;++n)this._signs[i][n]=this._planes[i][n]>=0?1:-1}for(let i=0;i<e;++i){const n=Ef(this._planes[i]);this._distanceScale[i]=n===0?0:1/n}}static fromPlaneCoefficients(t){const e=[];for(const i of t){const n=[i.x,i.y,i.z,i.w];e.push(n)}return new ld(e)}static createFrustumFromMatrix(t){const e=[];for(let i=0;i<3;++i)e[i]=Mf(Uc(t,3),Uc(t,i));for(let i=0;i<3;++i)e[i+3]=eb(Uc(t,3),Uc(t,i));return new ld(e)}testAxisAlignedBox(t,e){const i=this._planes.length;let n=bu.FullyInside;for(let r=0;r<i;++r){const o=oo(this._planes[r],t),l=oo(this._absPlanes[r],e);if(o+l<=this._planes[r][3])return bu.Outside;o-l<this._planes[r][3]&&(n=bu.PartiallyInside)}return n}axisAlignedBoxNotOutside(t,e){const i=this._planes.length;for(let n=0;n<i;++n)if(oo(this._planes[n],Q0(t,Z0(e,this._signs[n])))<=this._planes[n][3])return!1;return!0}sphereNotOutside(t,e){const i=this._planes.length;for(let n=0;n<i;++n){const r=oo(this._planes[n],t)-this._planes[n][3];if(r<0&&r*r*this._distanceScale[n]>=e)return!1}return!0}sphereFullyInside(t,e){const i=this._planes.length;for(let n=0;n<i;++n){const r=oo(this._planes[n],t)-this._planes[n][3];if(r<0||r*r*this._distanceScale[n]<e)return!1}return!0}pointInside(t){const e=this._planes.length;for(let i=0;i<e;++i)if(oo(this._planes[i],t)-this._planes[i][3]<0)return!1;return!0}}function oI(s){return 1/(1+Math.exp(s))}class _y{constructor(t){const e=t.getCamera(),i=e.getPosition(),n=e.getTarget(),r=_.subtract(n,i);let o=r.length();o<1e-7&&(o=1e-7),this._eyeDistanceInverse=1/o,r.scale(this._eyeDistanceInverse);const l=t.getFullCameraMatrix();this._frustum=ld.createFrustumFromMatrix(l),this._viewProjectionW=Uc(l,3),this._cameraIsOrtho=e.getProjection()===rc.Orthographic,this._position=ol(i),this._eye=ol(r)}calculateAttachHeuristic(t,e){let i=0;if(this._frustum.axisAlignedBoxNotOutside(e,t)){const n=Ef(t),r=nb(e,n,this._viewProjectionW);if(r>0){let o=tb(e,this._position);const h=1/(oo(this._eye,o)*this._eyeDistanceInverse+1e-5);o=ib(1/km(o),o);const u=oo(this._eye,o);let d=Math.pow(h,6);this._cameraIsOrtho||(d*=Math.pow(u,10)*5),d<1e-5&&(d=1e-5),i=r*d}return console.assert(0<=i),-i-1}return i=oI(km(t)),console.assert(0<=i&&i<1),i}}const wd=class wd{static isSupported(){return wd._enabled&&typeof fetch=="function"&&typeof ReadableStream=="function"}static async request(t){const e=await fetch(t);if(e.status===200)return e;throw new pr(`Failed to fetch "${t}" with status ${e.status}.`)}};wd._enabled=!0;let xa=wd;const aI=13;class cd{constructor(t,e,i,n){this._cameraTimeoutId=null,this._isFirstAttachment=!0,this._attachScope=0,n===null&&(n=aI),console.assert(n>0),this._engine=t,this._view=e,this._callbackManager=i,this._parentToXmlAttachInfos=new Map,this._viewInfo=new _y(this._view),this._attachPriorityManager=new rI,this._comparePriority=(r,o)=>this._attachPriorityManager.comparePriority(r,o),this._attachQueue=this._createAttachQueue(n),this._prefetchScsQueue=this._createPrefetchScsQueue(n),this._registerCameraListener()}static async createWithEmptyModel(t,e,i,n){return await t.loadEmpty(),new cd(t,e,i,n)}setPrefetchScsCutoffScale(t){this._prefetchScsQueue.setCutoffScale(t),this._attachPriorityManager.setRequireBoundingInfo(this._prefetchScsQueue.cutoffEnabled())}_createAttachQueue(t){return new fm(t,this._comparePriority,!1)}_createPrefetchScsQueue(t){const e=t+15;return new u0(0,this._attachPriorityManager,e,(i,n)=>this._comparePriority(i,n),!1)}_reprioritizeAttachments(){this._viewInfo=new _y(this._view),this._attachPriorityManager.onViewChange(this._viewInfo,this._view,this._engine),this._attachQueue.markDirty(),this._prefetchScsQueue.update()}_registerCameraListener(){const t=()=>{this._onCameraChange()};this._callbackManager.bind({camera:t,_shutdownBegin:()=>{this._cameraTimeoutId!==null&&(clearTimeout(this._cameraTimeoutId),this._cameraTimeoutId=null),this._callbackManager.unbind({camera:t})}})}reprioritizeAttachmentsNow(){this._cameraTimeoutId!==null&&(clearTimeout(this._cameraTimeoutId),this._cameraTimeoutId=null),this._reprioritizeAttachments()}_onCameraChange(){this._cameraTimeoutId!==null&&clearTimeout(this._cameraTimeoutId),this._cameraTimeoutId=this._engine.setTimeout(()=>{this._cameraTimeoutId=null,this._reprioritizeAttachments()},500)}_awaitAttachInfo(t,e,i,n,r){const o=n===null,l=new my(e,i);let h=!1;const u=[],d=mi(),g=mi();let y=!1;const m=()=>{console.assert(!y),y=!0,this._cleanupAttachLowLevel(),this._callbackManager.unbind(b)};let I=null;const b={_priorityMetaDataSent:(x,C)=>{x===e&&(l.registerPrototypeInstanceCount(C),d.resolve())},_announceModel:(x,C)=>{x===e&&(h=!0,l.registerMasterModelKey(C))},_inclusion:(x,C,P)=>{x===e&&(l.registerInclusion(C,P),u.push(P))},_remapModel:(x,C,P)=>{x===e&&t.remapModel(C,P)},_remapInclusion:(x,C,P,k)=>{x===e&&t.remapInclusion(C,P,k)},_missingModel:(x,C)=>{x===e&&(I=C)},_attached:x=>{if(x!==e)return;if(!h){if(I!==null&&(o||r)){console.assert(u.length===0),g.reject(new Gc(I));return}if(u.length!==1){g.reject(new pr("Bad model: Could not find master model key."));return}const k=u[0];l.registerMasterModelKey(k)}const C=[d],P=this._isFirstAttachment;if(P){this._isFirstAttachment=!1;const k=o?ps.Direct:ps.Indirect,O=this._callbackManager.promiseTrigger("_firstAttachment",null,k);C.push(O)}Ue(C).catch(k=>{throw console.assert(!1),k}).then(async()=>{P&&this._engine.getSessionType()===Xi.Network&&await this._callbackManager.promiseTrigger("_firstBoundingReady",null),m(),g.resolve(l)})}};return this._callbackManager.bind(b),g.catch(x=>{throw m(),x})}_createPriority(t,e){return this._attachPriorityManager.createPriority(this._viewInfo,t,e)}_cleanupAttachLowLevel(){}async _cleanupAttachHighLevel(t,e,i){try{return await t}finally{i!==null&&this._forgetXmlAttachment(i),this._attachPriorityManager.destroyPriority(e)}}newAttachScope(){return++this._attachScope}_attachByStream(t,e,i,n,r,o,l,h){const u=_t.toMatrix12(n.m),d=this._createPriority(n,l),g=this._attachQueue.push(async()=>{const y=this.newAttachScope(),m=this._awaitAttachInfo(e,y,o.get(),l,h);try{return await t.enqueue(()=>this._engine.attachModel(y,i,u,r,o.get())),await m}catch(I){throw this._cleanupAttachLowLevel(),I}},d);return this._cleanupAttachHighLevel(g,d,l)}static _getAllModelKeys(t){const e=t.getMasterModelKey(),i=t.getAllInclusions();if(i[1]!==e){for(let r=2;r<i.length;r+=2)if(i[r+1]===e){const l=i[r];i[r]=i[0],i[r+1]=i[1],i[0]=l,i[1]=e;break}}const n=[];for(let r=0,o=1;o<i.length;++r,o+=2)n[r]=i[o];return n}async attachByNamedScsBuffer(t,e,i,n,r,o,l,h,u){t.getAutomaticMeasurementUnitScaling()||(o=As);const d=Ks(h.parent),g=_t.toMatrix12(r.m),y=this._createPriority(r,h);if(typeof y=="number")throw new ei;const m=async b=>{const x=await(async()=>{const O=d.getScsModelKeysOf(e);return O===null?(d.initializeScsModelKeysOf(e),b):O})(),C=d.getScsModelKeysOf(e);if(C===null)throw new ei;const P=this.newAttachScope();let k;if(x instanceof Uint8Array||xa.isSupported()&&x instanceof Response){const B=this._awaitAttachInfo(i,P,l.get(),h,!1);try{await t.enqueue(()=>{const j=this._engine.attachScsBuffer(P,x instanceof Uint8Array?x:null,g,o,l.get(),!0,u);return x instanceof Uint8Array||this.streamScsData(P,x),j}),k=await B}catch(j){throw this._cleanupAttachLowLevel(),j}if(C.state===Nr.Pending){const j=cd._getAllModelKeys(k);C.resolve(j)}}else if(x===null)k=null,C.state===Nr.Pending&&C.resolve(null);else if(x instanceof Array){console.assert(C.state!==Nr.Pending);const O=new my(P,l.get());O.registerPrototypeInstanceCount(0);for(let B=0;B<x.length;++B){const j=x[B],V=this._engine.attachScsModelByKey(P,j,g,o,l.get());O.registerInclusion(V,j),B===0&&O.registerMasterModelKey(j)}k=O}else throw new ei;return k},I=(async()=>{const b=await this._prefetchScsQueue.push(async()=>d.toScsBuffer(e,n),y);return h.directlyRequested=!0,this._attachQueue.push(()=>m(b),y)})();return this._cleanupAttachHighLevel(I,y,h)}streamScsData(t,e){this._callbackManager.trigger("_fetchBegin",e.url,t);const i=e.body.getReader(),n=async()=>{for(;;){const{done:r,value:o}=await i.read();if(r){this._engine.feedScsBuffer(t,null),this._callbackManager.trigger("_fetchEnd",e.url,t);return}this._engine.feedScsBuffer(t,o)}};this._engine.setTimeout(n,0)}_attachByScsBuffer(t,e,i,n,r,o,l){const u=_t.toMatrix12(n.m),d=this._createPriority(n,null),g=this._attachQueue.push(async()=>{const y=this.newAttachScope(),m=this._awaitAttachInfo(e,y,o.get(),null,!1);try{return await t.enqueue(()=>{const b=this._engine.attachScsBuffer(y,i instanceof Uint8Array?i:null,u,r,o.get(),!1,l);return i instanceof Uint8Array||this.streamScsData(y,i),b}),await m}catch(I){throw this._cleanupAttachLowLevel(),I}},d);return this._cleanupAttachHighLevel(g,d,null)}simpleAttach(t,e,i,n,r,o,l,h){if(t.getAutomaticMeasurementUnitScaling()||(r=As),typeof i=="string")return this._attachByStream(t,e,i,n,r,o,l,h);if(l===null)return this._attachByScsBuffer(t,e,i,n,r,o,!1);throw new ei}reset(){return this._isFirstAttachment=!0,this._attachScope=0,this._parentToXmlAttachInfos.clear(),this._attachPriorityManager.reset(),this.clearAttachQueues()}async clearAttachQueues(){return this._prefetchScsQueue.killDeferred(),this._attachQueue.killDeferred(),await this._prefetchScsQueue.waitForIdle(),this._attachQueue.waitForIdle()}isIdle(){return this._attachQueue.isIdle()}notifyDirectRequest(t){const e=this._parentToXmlAttachInfos.get(t);if(e!==void 0){let i=!1;for(const n of e)n.directlyRequested||(n.directlyRequested=!0,i=!0);i&&this._reprioritizeAttachments()}}registerXmlAttachInfo(t){const e=t.parent;let i=this._parentToXmlAttachInfos.get(e);i===void 0&&(i=[],this._parentToXmlAttachInfos.set(e,i)),i.push(t)}_forgetXmlAttachment(t){const e=t.parent,i=this._parentToXmlAttachInfos.get(e);if(i.length===1)console.assert(i[0]===t),this._parentToXmlAttachInfos.delete(e);else{console.assert(i.length>1);const n=i.indexOf(t);console.assert(n>=0),i.splice(n,1)}}maxConcurrentAttachments(){return this._attachQueue.maxActivePromises()}}function mg(s,t){return new Promise((e,i)=>{const n=new XMLHttpRequest;n.open("GET",s,!0),t&&(n.responseType=t),n.onload=function(r){if(n.readyState===im.Done)if(n.status===nm.Ok)e(n);else{const o=new pr(`XMLHttpRequest failed to GET "${s}" with status ${n.status}.`);i(o)}},n.onerror=function(r){i(r)},n.send()})}async function yy(s){const t=await mg(s,"arraybuffer");return new Uint8Array(t.response)}class lI{constructor(){this._cache=new Map}clear(){this._cache.clear()}async load(t,e){const i=this._cache.get(t);return i!==void 0?i:(this._cache.set(t,e),e)}}const wy="Missing";function vy(s){return new DOMParser().parseFromString(s,"application/xml")}async function cI(s){const t=await mg(s);let e=t.responseXML;return e===null&&(e=vy(t.responseText)),e}function hI(s){if(!s.hasChildNodes)return null;const t=s.firstChild;if(!(t instanceof Comment))return null;const e=t.data.split(" ");if(e.length!==2||e[0]!=="HC")return null;const i=e[1].split(".");if(i.length<2)return null;const n=[];for(const r of i){if(!sm(r))return null;n.push(parseInt(r,10))}return n}function uI(s){return cc(Cf,s)}function dI(s){const t=s.getElementsByTagName("parsererror");if(t.length>0)throw new ii(t[0].textContent||"unknown error")}function fI(s){const t=s.getParent();return t instanceof Sn&&t.getParent()instanceof Os}function gI(s,t,e,i,n,r){const o=new Sn(t,n,r,Er.Local,e);switch(i){case 0:return o;case 1:{const l=new Hn(s,o,ki.Local,fs.Local);o.addInclusionContext(l);const h=me.createDynamic(s,l,wy,null,null,!r);return l.addProductOccurrence(h),o}default:return Tr()}}function pI(s,t,e,i){return{getAttachScope(){return s},getMasterModelKey(){return i},getModelKeys(){return[i]},hasInclusions(){return!0},getAllInclusions(){return[e,i]},getInclusionsOf(n){return n===i?[e,i]:[]},hasModelIncluded(n){return n===i},attachedInvisibly(){return t},prototypeInstanceCount(){return 0}}}class _g{constructor(t,e,i,n,r){this._loadQueue=new No(1024,!1),this._activeLoadCount=0,this._activeLoadGeneration=0,this._isFirstLoad=!0,this._firstAssemblyDataHeader=null,console.assert(t.isInitialized()),this._assemblyTree=t,this._scAttacher=e,this._engine=i,this._view=n,this._callbackManager=r,this._isScsSession=this._engine.getSessionType()===Xi.Scs,this._nodesUntilNextSleep=2e3}_resolveMeasurementUnits(t,e,i,n){if(!this._assemblyTree.getAutomaticMeasurementUnitScaling())return;const r=ur(t.getParent());if(r===null)throw new ei;const o=r.getMeasurementUnit(),l=t.getMeasurementUnit();let h=t.getLocalTransform();if(h===null&&(h=Vn.getIdentity()),o!==l){const u=l/o;h[0]*=u,h[5]*=u,h[10]*=u}this._applyScalePatchIfNeeded(h,e,i,n,l),t.setLocalTransformAsInitial(h)}_applyScalePatchIfNeeded(t,e,i,n,r){const o=n===Ga.Inventor,l=n===Ga.Se,h=o&&cc(i,[9,0,0])||l&&cc(i,[23,0,0]),g=o?10:1e3;if(e&&h&&r!==g){const y=r/g;t[0]*=y,t[5]*=y,t[10]*=y}}async _patchImplicitNodesByModelInc(t,e,i,n,r){let o=0;if(n.length===0)return;let l;const h=gs.create(()=>{const u=t.get(),d=Di(u),g=d.getAttachScope();l=d.attachedInvisibly();const y=d.split(g,l,u);u.addAttachContext(y);const m=new Hn(this._assemblyTree,y,e,i);y.addInclusionContext(m);const I=me.createDynamic(this._assemblyTree,m,`Of Inclusion (${e})`,null,null,!l,r);return m.addProductOccurrence(I),I});for(const u of n){let d=this._assemblyTree.lookupAnyBodyByInstanceInc(e,u);if(d===null){const g=h.get(),y=`Implicit Body ${++o}`,m=await this._engine.getPartsBounding([e,u],!0,!1),I=m.max!==m.min&&!m.isDegenerate();d=this._assemblyTree.createMeshInstance(!0,e,u,null,y,g,!1,!1,I,!0),l&&d.setVisibility(!1)}}}_getPrototypeInstanceCountByAttachment(t){const e=new Set;let i=0;const n=t.getAllInclusions();for(let r=0;r<n.length;r+=2){const o=n[r],l=n[r+1];e.has(l)||(e.add(l),i+=this._assemblyTree.getInstanceCountByInclusion(o))}return i}async _patchImplicitNodesByAttachment(t,e,i){console.assert(t.isLoaded());let n=null;const r=gs.create(()=>{const d=new Tl,g=e.getMasterModelKey();n=new Sn(d,e.getAttachScope(),e.attachedInvisibly(),g,t);const y=new Hn(this._assemblyTree,n,ki.Local,fs.Local);n.addInclusionContext(y);const m=me.createDynamic(this._assemblyTree,y,"Implicit Bodies",null,null,!e.attachedInvisibly(),i);return y.addProductOccurrence(m),m});let o=e.prototypeInstanceCount();o===0&&([o]=await this._engine.instanceKeyInfo(e.getAttachScope(),wu.Attachment,vu.KeyCountOnly));let l=this._getPrototypeInstanceCountByAttachment(e);if(l===o)return;const h=await this._engine.instanceKeyInfo(e.getAttachScope(),wu.Attachment,vu.AllKeys),u=e.getAllInclusions();for(let d=0;d<u.length;d+=2){const g=u[d],y=u[d+1],m=h.get(y);m!==void 0&&await this._patchImplicitNodesByModelInc(r,g,y,m,i)}if(l=this._getPrototypeInstanceCountByAttachment(e),l<o)throw new ei;n!==null&&(await ua([n]),t instanceof Os,t.addAttachContext(n))}async _updateOnDemandRequests(t){if(!this._assemblyTree.onDemandRequestsActive())return;const e=t.getChildren(),i=[];for(const n of e)this._assemblyTree.isBeingRequested(n)&&i.push(n);return this._assemblyTree.requestNodes(this,i,!0)}async _populateAttachment(t,e,i,n,r,o){console.assert(r===ps.Indirect==(o!==null));const l=await this._parseRootNodes(t,e,i,n,o);return await this._postProcessAttachContext(e,n,r,l),l}async _postProcessAttachContext(t,e,i,n){await Nn.forceLazyPromises(n),await this._assemblyTree.enqueue(()=>l0(this._engine,n));let r=this._assemblyTree.markImplicitNodesOutOfHierarchy();r&&(r=n.getChildren().length>0||i===ps.Indirect),await this._patchImplicitNodesByAttachment(t,e,r),await this._updateOnDemandRequests(n);const l=n.getChildren().map(h=>h.getRuntimeId());this._callbackManager.trigger("_attachmentPopulated",l)}async _parseRootNodes(t,e,i,n,r){const o=n.getMasterModelKey(),l=n.getInclusionsOf(o);o===Er.Invalid&&(console.assert(l.length===0),l.push(ki.Invalid,fs.Invalid));const h=new Sn(i,n.getAttachScope(),n.attachedInvisibly(),o,e);r!==null&&h.setReservedNodeIdOffset(r);const u=new No(1,!0),d=await this._assemblyTree.enqueue(()=>h.getRootNodeMetaData(this._assemblyTree));for(let g=0;g<l.length;g+=2)u.push(()=>{const y=l[g],m=l[g+1];return this._parseRootNode(t,h,d,y,m)});return await u.waitForIdle(),h}async _parseRootNode(t,e,i,n,r){console.assert(n!==ki.Local);const o=await this._populateInclusion(t,e,i,n,r);if(o.hasAuthoredId()){console.assert(!o.isLoaded());const l=Gi(o);fI(l)&&this._setupRootNode(o,!1)}else o.getName()===null&&(e.removeProductOccurrence(o)||console.assert(!1))}_setupRootNode(t,e,i=!1,n=[],r=Ga.Unknown){console.assert(!t.isAbsoluteRoot()),e&&t.markIsExternalModelRoot(this._assemblyTree),this._resolveMeasurementUnits(t,i,n,r)}async _populateInclusion(t,e,i,n,r){console.assert(n!==ki.Local);const o=new Hn(this._assemblyTree,e,n,r);e.addInclusionContext(o);const l=await(async()=>{if(i===null||i.bytes.length===0){let d=null;return i===null&&(d=wy),me.createDynamic(this._assemblyTree,o,d,null,null,!e.attachedInvisibly())}const h=new Vc(i),u=me.parseBinary(t,this._assemblyTree,o,h);return me.reify(t,this,this._assemblyTree,o,u,o)})();return o.addProductOccurrence(l),l}async _rectifyLateVisibilityChange(t,e){const i=Di(e.getParent()),n=ur(e.getParent());if(console.assert(n===ur(i)),t.attachInvisibly||n===null||!n.isLoaded())return;const r=n.isVisible();if(i.attachedInvisibly()===!r)return;const o=r?to.Initial:to.Hide;return o0({assemblyTree:this._assemblyTree,engine:this._engine,attachContext:i,setVisibility:o})}_loadCleanup(t,e,i){console.assert(this._activeLoadCount>0),t.onLoadComplete(),e!==null&&this._callbackManager.unbind(e),--this._activeLoadCount,this._assemblyTree.onLoadEnd(i),this._callbackManager.trigger("visibilityChanged",[],[])}_wrap(t,e,i,n){const r=this._activeLoadGeneration;return this._loadQueue.push(async()=>{const o=this._assemblyTree.onLoadBegin();let l=null;if(r!==this._activeLoadGeneration)throw this._loadCleanup(e,l,o),new Wc;this._firstAssemblyDataHeader===null&&(l={_modelStructureHeaderParsed:async y=>{l!==null&&(this._firstAssemblyDataHeader===null&&(this._firstAssemblyDataHeader=y),this._callbackManager.unbind(l),l=null)}},this._callbackManager.bind(l,!0));try{await i}catch(y){throw await e.purgeContents(),this._loadCleanup(e,l,o),y}const h=e.getParent();if(h===null)throw this._loadCleanup(e,l,o),new ei;n===ps.Direct&&(e.hasChildren()?h.addLoadContext(e):await e.purgeContents()),this._loadCleanup(e,l,o);const d=e.getChildren(),g=[];for(const y of d){const m=this._rectifyLateVisibilityChange(t,y);g.push(m)}if(await Ue(g),this._isFirstLoad){this._isFirstLoad=!1,e.markAsFirstLoad();const y=d.map(I=>I.getRuntimeId()),m=!1;try{await this._callbackManager.promiseTrigger("_firstModelLoaded","firstModelLoaded",y,m,n,t)}catch(I){throw console.assert(!1),I}}return e})}_initLoad(t,e,i){++this._activeLoadCount;const n=this._isScsSession&&i?new lI:null;return new Os(t,e,n)}static _getNetMatrix(t,e){let i=_t.createFromArray(zc(t));return e!==null&&(i=_t.multiply(e,i)),i}_lazyAttachInvisibly(t,e){return gs.create(()=>e.attachInvisibly||!t.isVisible())}_loadBySingleAttach(t,e,i,n){const r=this._initLoad(e,n,!1),o=zn.create(async()=>{const l=await i,h=new Tl,u=_g._getNetMatrix(e,t.additionalMatrix),d=e.getMeasurementUnit(),g=this._lazyAttachInvisibly(e,t),y=await this._scAttacher.simpleAttach(this._assemblyTree,h,l,u,d,g,null,!1),m=await this._populateAttachment(t,r,h,y,ps.Direct,null);return await ua([r,m]),m.hasChildren()&&r.addAttachContext(m),{}});return this._wrap(t,r,o,ps.Direct)}async _populateFromXml(t,e,i,n){let o=i.documentElement.firstElementChild,l=null,h=null;for(;o!==null;){if(o.localName==="ModelFile"&&(console.assert(l===null),l=Pf.parseXml(t,this._assemblyTree,e,o,n)),o.localName==="DefaultCamera"&&(h=gi.parseCamera(o),!h))throw new ii(`"DefaultCamera" element exists but couldn't be parsed`);o=o.nextElementSibling}if(l===null)throw new ii('Expected "ModelFile" element.');let u=!1;if(this._isFirstLoad){let g=As;if(this._assemblyTree.getAutomaticMeasurementUnitScaling()&&(g=ur(e).getMeasurementUnit()),h!=null)u=!0,await this._view._setCameraPromise(h,0);else{const y=Pf.parseBounding(l,g);!y.isDegenerate()&&h===null&&(u=!0,await this._view.setViewOrientation(Ct.Iso,0,y))}}const d=await Pf.reify(t,this._callbackManager,this,this._assemblyTree,e,l);for(const g of d)this._setupRootNode(g,!1);this._isFirstLoad&&!u&&await this._view.setViewOrientation(Ct.Iso,0)}_loadByXml(t,e,i,n,r){const o=this._initLoad(e,r,!0),l=zn.create(async()=>{const h=await i;dI(h);const u=hI(h);if(u===null||!uI(u))throw new ii("Bad version.");const d=C=>n(C,u);this._scAttacher.reprioritizeAttachmentsNow(),e.addLoadContext(o);const g=Gi(e),y=Di(g),m=this._scAttacher.newAttachScope(),I=this._lazyAttachInvisibly(e,t),b=y.split(m,I.get(),o);o.addAttachContext(b);const x=g.split(this._assemblyTree,b);return b.addInclusionContext(x),await this._populateFromXml(t,x,h,d),await ua([o,b]),{}});return this._wrap(t,o,l,ps.Indirect)}async _attachExternalModelByInc(t,e){console.assert(t.inclusionKey!==ki.Local);const i=Di(e).getAttachScope(),n=t.modelKey,r=this._lazyAttachInvisibly(e,t.config),o=new Tl,l=new Sn(o,i,r.get(),n,e),h=await l.getRootNodeMetaData(this._assemblyTree);return await this._populateInclusion(t.config,l,h,t.inclusionKey,t.modelKey),l}async _attachExternalModelInfoByName(t,e,i){const n=new Tl,r=this._lazyAttachInvisibly(e,t.config),o=e.getMeasurementUnit(),l=(()=>{const d=_t.createFromArray(zc(e));if(o<=0||!this._assemblyTree.getAutomaticMeasurementUnitScaling())return d;const g=(()=>{const I=i.getAttachContext().getParent();if(I===null)return As;const b=I.getParent();return b===null?As:b.getMeasurementUnit()})(),y=g===As?1:o/g;return y===1?d:_t.multiply(d,new _t().setScaleComponent(y,y,y))})(),h={bounding:t.bounding,parent:e,directlyRequested:!1};let u;if(this._isScsSession)this._scAttacher.registerXmlAttachInfo(h),u=await this._scAttacher.attachByNamedScsBuffer(this._assemblyTree,t.modelName,n,t.toAttachData,l,o,r,h,t.cancelUnitScale)||0;else try{const d=await t.toAttachData(t.modelName);if(d===null||d===Oo)u=0;else{if(typeof d!="string")throw new ei;this._scAttacher.registerXmlAttachInfo(h),u=await this._scAttacher.simpleAttach(this._assemblyTree,n,d,l,o,r,h,t.config.allowMissingExternalModels)}}catch(d){if(t.config.allowMissingExternalModels&&d instanceof Gc)u=1;else throw d}if(typeof u=="number"){const d=this._scAttacher.newAttachScope(),g=!r.get();return gI(this._assemblyTree,n,e,u,d,g)}else return this._populateAttachment(t.config,e,n,u,ps.Indirect,t.reservedNodeIdOffset)}setPrefetchScsCutoffScale(t){this._scAttacher.setPrefetchScsCutoffScale(t)}isIdle(){return this._activeLoadCount===0?(console.assert(this._scAttacher.isIdle()),!0):!1}waitOnCurrentLoads(){return this._loadQueue.waitForIdle()}cancelPendingLoads(){return++this._activeLoadGeneration,this.waitOnCurrentLoads()}async cancelActiveAttachmentProcess(){return this._scAttacher.clearAttachQueues()}loadByStream(t,e,i){if(i===Oo){const n=new Os(e,Oo,null);return Promise.resolve(n)}return this._loadBySingleAttach(t,e,Promise.resolve(i),i)}loadByScsBuffer(t,e,i){return this._loadBySingleAttach(t,e,Promise.resolve(i),"*SCS Buffer*")}async loadByScsFile(t,e,i){if(xa.isSupported())return this._loadBySingleAttach(t,e,xa.request(i),i);{const n=yy(i);return this._loadBySingleAttach(t,e,n,i)}}loadByXmlDoc(t,e,i,n){let r;return typeof i=="string"?r=vy(i):r=i,this._loadByXml(t,e,Promise.resolve(r),n,"*XML Document*")}loadByXmlFile(t,e,i,n){const r=cI(i);return this._loadByXml(t,e,r,n,i)}async attachByExternalModelInfo(t,e,i){let n,r=!1;Bc(t)?(r=t.cancelUnitScale,n=await this._attachExternalModelInfoByName(t,e,i)):n=await this._attachExternalModelByInc(t,e);const o=[],l=n.getChildren(),h=n.getAssemblyDataVersion(),u=n.getOriginalFileType();for(const d of l){this._setupRootNode(d,!0,r,h,u);const g=this._rectifyLateVisibilityChange(t.config,d);o.push(g)}return await Ue(o),n}async loadByAssemblyData(t,e,i,n){const r=ps.Direct,[o,l]=i,h=this._scAttacher.newAttachScope(),u=!e.isVisible(),d=pI(h,u,o,l),g=this._initLoad(e,"*Assembly Data*",!1),y=zn.create(async()=>{const m=new Tl,I=d.getMasterModelKey(),b=new Sn(m,h,d.attachedInvisibly(),I,g);return await this._parseRootNode(t,b,n,o,l),await this._postProcessAttachContext(g,d,r,b),await ua([g,b]),b.hasChildren()&&g.addAttachContext(b),{}});return this._wrap(t,g,y,r)}reset(){return this._isFirstLoad=!0,this._firstAssemblyDataHeader=null,this._scAttacher.reset()}notifyDirectRequest(t){this._scAttacher.notifyDirectRequest(t)}onLoadChildProductOccurrence(){if(this._nodesUntilNextSleep===0)return this._nodesUntilNextSleep=2e3,this._engine.sleep(10);--this._nodesUntilNextSleep}firstAssemblyDataHeader(){return this._firstAssemblyDataHeader}}function mI(s,t,e,i,n){const r=[],o=g=>{g.getInclusionContexts().forEach(m=>{r.push(m.getInclusionKey())})},l=g=>{g.getAttachContexts().forEach(o)},u={enterProductOccurrence:g=>{if(i.has(g)||(i.add(g),g.isOutOfHierarchy()&&!e))return;g.getChildContexts().forEach(m=>{m instanceof Os?l(m):o(m)})}},d=s.walk(u,t,n);return d?d.then(()=>r):r}function _I(s,t,e,i){return mI(Rc,s,t,e,i)}function yI(s,t,e){const i=[],n=new Set;for(const r of t){const o=s.lookupAnyTreeNode(r);if(o===null)throw new _s(r);const l=Do(o),h=_I(o,l,n,e);for(const u of h)i.push(u)}return i}async function wI(s){let t=!1;const e=n=>{n.hasLocalTransformOverride()&&(n.removeLocalTransformOverride(),t=!0)},i={enterProductOccurrence:e,enterPmi:e,enterCadView:e,enterAnyBody:n=>{n.preventFromResetting()||e(n)}};return await Nn.walk(i,s,zt.None),t}function vI(s,t,e){const i=[],n=new Set,r=l=>n.has(l)?!1:(n.add(l),!0),o={followProductOccurrence:r,followPmi:r,followCadView:r,followAnyBody:r,enterAnyBody:l=>{if(!l.isOutOfHierarchy()){const h=l.getInstanceInc();i.push(h[0],h[1])}}};for(const l of t)Rc.walk(o,l,zt.None);s.setMeshLevel(i,e)}function bI(s){return s instanceof Ni||s instanceof Wi||s instanceof ra||s instanceof oa||s instanceof aa||s instanceof gc||s instanceof pc||s instanceof mc||s instanceof _c||s instanceof yc||s instanceof wc||s instanceof vc||s instanceof bc||s instanceof Ic||s instanceof xc||s instanceof Cc||s instanceof Sc||s instanceof fc}function II(s){return s instanceof dc||s instanceof Ya||s instanceof So}function by(s){return async(t,e)=>{const i=cc(e,[7,3])?`${t}.scs`:t,n=await s(i);return typeof n=="string"?xa.isSupported()?xa.request(n):yy(n):n}}class xI{constructor(t,e,i,n,r){this._clearQueue=new No(1,!1),this._clearInProgress=!1,this._cadConfigurationsEnabled=!0,this._engine=e,this._callbackManager=i,this._cuttingManager=n,this._model=r,this._assemblyTree=new sI(t,this._engine,this._callbackManager,this._cuttingManager,this._model),this._readyPromise=gu()}async init(t,e){const i=await cd.createWithEmptyModel(this._engine,t,this._callbackManager,e);this._assemblyTree.initialize(i);const n=new _g(this._assemblyTree,i,this._engine,t,this._callbackManager);console.assert(this._treeLoader===void 0),this._treeLoader=n,this._readyPromise.resolve()}async _loadSubtreePrologue(t,e,i){if(this._engine.getSessionType()!==t)throw new pr("Incompatible load types.");if(i&&await this._clearQueue.waitOnLatest(),this._clearInProgress)throw new Wc;const n=this._assemblyTree.lookupProductOccurrence(e);if(n===null)throw new Zn(e,In.ProductOccurrence);return n}async _loadSubtreeEpilogue(t,e){t.isFirstLoad()&&this._engine.getSessionType()===Xi.Scs&&await this._callbackManager.promiseTrigger("_firstBoundingReady",null);const n=t.getChildren().map(r=>r.getRuntimeId());return e&&await this._callbackManager.promiseTrigger("_subtreeLoaded","subtreeLoaded",n,Dr.LoadModel),n}async loadSubtreeFromXmlFile(t,e,i,n){await this._disableCadConfigurations();const r=Xi.Network,o=await this._loadSubtreePrologue(r,t,!0),l=await this._treeLoader.loadByXmlFile(n,o,e,i);return this._loadSubtreeEpilogue(l,!1)}async loadSubtreeFromXmlDoc(t,e,i,n){await this._disableCadConfigurations();const r=Xi.Network,o=await this._loadSubtreePrologue(r,t,!0),l=await this._treeLoader.loadByXmlDoc(n,o,e,i);return this._loadSubtreeEpilogue(l,!1)}async loadSubtreeFromScsXmlFile(t,e,i,n){await this._disableCadConfigurations();const r=Xi.Scs,o=await this._loadSubtreePrologue(r,t,!0),l=by(i),h=await this._treeLoader.loadByXmlFile(n,o,e,l);return this._loadSubtreeEpilogue(h,!1)}async loadSubtreeFromScsXmlDoc(t,e,i,n){await this._disableCadConfigurations();const r=Xi.Scs,o=await this._loadSubtreePrologue(r,t,!0),l=by(i),h=await this._treeLoader.loadByXmlDoc(n,o,e,l);return this._loadSubtreeEpilogue(h,!1)}async _loadSubtreeFromStream(t,e,i,n){const r=Xi.Network,o=await this._loadSubtreePrologue(r,t,i),l=await this._treeLoader.loadByStream(n,o,e);return this._loadSubtreeEpilogue(l,n._allowSubtreeLoadedCallback)}async loadSubtreeFromStream(t,e,i){return this._loadSubtreeFromStream(t,e,!0,i)}async loadSubtreeFromScsFile(t,e,i){const n=Xi.Scs,r=await this._loadSubtreePrologue(n,t,!0),o=await this._treeLoader.loadByScsFile(i,r,e);return this._loadSubtreeEpilogue(o,i._allowSubtreeLoadedCallback)}async loadSubtreeFromScsBuffer(t,e,i){const n=Xi.Scs,r=await this._loadSubtreePrologue(n,t,!0),o=await this._treeLoader.loadByScsBuffer(i,r,e);return this._loadSubtreeEpilogue(o,i._allowSubtreeLoadedCallback)}async loadSubtreeFromAssemblyData(t,e,i,n){const r=Xi.Network,o=await this._loadSubtreePrologue(r,t,!0),l=await this._treeLoader.loadByAssemblyData(n,o,e,i);return this._loadSubtreeEpilogue(l,n._allowSubtreeLoadedCallback)}async loadMeasurementFromJson(t){const e=Object.keys(t);for(const i of e){const n=parseInt(i,10);if(isNaN(n))continue;const r=t[n],o=parseInt(r.instance_id,10);if(isNaN(o))continue;const l=await this._getNodeOrRepItemFromId(o);if(!(l instanceof Ji))continue;const h=r.edge_properties;for(let d=0;d<h.length;d++){const g=h[d],y=g.id,m=g.data;let I=null;switch(g.type){case"circle":I=Ya.fromJson(m);break;case"line":I=dc.fromJson(m);break;case"unknown_edge":I=So.fromJson(m);break}I!==null&&l.setEdgeMeasurementProperty(y,I)}const u=r.face_properties;for(let d=0;d<u.length;d++){const g=u[d],y=g.id,m=g.data;let I=null;switch(g.type){case"cylinder":I=Ni.fromJson(m);break;case"plane":I=Wi.fromJson(m);break;case"cone":I=ra.fromJson(m);break;case"sphere":I=oa.fromJson(m);break;case"torus":I=aa.fromJson(m);break}I!==null&&l.setFaceMeasurementProperty(y,I)}}}async loadMeasurementFromString(t){const e=JSON.parse(t);return this.loadMeasurementFromJson(e)}async loadMeasurementFromFile(t){const e=await mg(t,"blob");if(e.status!==200)throw new Error(`Cannot pull measurement file '${t}': ${e.response}`);const n=(await Vf.loadAsync(e.response)).file("measurement.json");if(!n)throw new Error(`Cannot pull measurement data from '${t}'`);const r=await n.async("string");return this.loadMeasurementFromString(r)}async _clearImpl(){console.assert(!this._clearInProgress),this._clearInProgress=!0;try{await this._treeLoader.cancelActiveAttachmentProcess(),await this._treeLoader.cancelPendingLoads(),console.assert(this._treeLoader.isIdle()),console.assert(this._clearInProgress),await this._treeLoader.reset(),console.assert(this._treeLoader.isIdle()),console.assert(this._clearInProgress),await this._assemblyTree.reset(),console.assert(this._treeLoader.isIdle()),console.assert(this._clearInProgress),this._clearInProgress=!1}catch(t){throw console.assert(this._clearInProgress),this._clearInProgress=!1,t}}clear(){return this._clearQueue.push(async()=>(this._callbackManager.trigger("modelSwitchStart",!0),await this._clearImpl(),this._callbackManager.promiseTrigger("_modelSwitched","modelSwitched",!0,[],ps.Direct)))}switchToModel(t){const e=t===Oo;return this._clearQueue.push(async()=>{this._callbackManager.trigger("modelSwitchStart",!1),await this._clearImpl();let i;return e?i=[]:i=await this._loadSubtreeFromStream(this.getAbsoluteRootNodeId(),t,!1,new Ro),await this._callbackManager.promiseTrigger("_modelSwitched","modelSwitched",e,i,ps.Direct),i})}getAbsoluteRootNodeId(){return this._assemblyTree.getRootNode().getRuntimeId()}isIdValid(t){return this._assemblyTree.lookupAnyNode(t)!==null}_getNodeChildren(t,e){let i=t.getChildrenSync();e||(i=i.filter(o=>!o.isOutOfHierarchy()));const n=t.getBodyInstances();for(const o of n)(!o.isOutOfHierarchy()||e)&&i.push(o);const r=t.getPmis();for(const o of r)i.push(o);return i}getChildIds(t,e){const i=this._assemblyTree.lookupProductOccurrence(t);if(i===null)return[];const n=this._getNodeChildren(i,e),r=[];for(const o of n)r.push(o.getRuntimeId());return r}isOutOfHierarchy(t){const e=this._assemblyTree.lookupAnyTreeNode(t);return e!==null&&Do(e)}getParentId(t){const e=this._assemblyTree.lookupAnyTreeNode(t);if(e===null)return null;const i=Sm(e.getParent());return i===null?null:i.getRuntimeId()}async getPartReferrers(t){const e=this._assemblyTree.lookupProductOccurrence(t);if(e===null)return null;const i=this._assemblyTree.getRootNode();await wf(i),await p0(i);const n=e.getPartDefinitionSync();if(n===null)return null;const r=n.getReferrers(),o=new Set;for(const l of r){const u=l.getParent().getReferrers();for(const d of u)o.add(d.getRuntimeId())}return Array.from(o)}async getAttributes(t){const e=await this._getNodeOrRepItemFromId(t);return e===null?[]:e.getAttributes()}async getProperties(t,e){const i=await this._getNodeOrRepItemFromId(t);if(i===null)return null;const n=await this._getNodeAttributes(i),r={};if(i instanceof Ji){const o=i.getPhysicalProperties();o!==null&&Object.assign(n,this._handlePhysicalProperties(t,o))}else if(i instanceof me){await Fc(i);const o=await i.getPhysicalProperties(e);o!==null&&Object.assign(n,this._handlePhysicalProperties(t,o));const l=await i.getPartDefinition();l!==null&&Object.assign(r,await this._getPartDefAttributes(await l.value))}return{...r,...n}}addProperty(t,e,i,n){const r=this._assemblyTree.lookupAnyNode(t);if(r===null)return!1;const o=new hr(gr.String,e,null,i,n);return r.addAttribute(o),!0}setPhysicalProperties(t,e,i,n){const r=this._assemblyTree.lookupRepresentationItem(t);if(r===null)return!1;const o=new ca(i,n,e);return r.setPhysicalProperties(o),!0}getUserDataIndices(t){const e=this._assemblyTree.lookupAnyTreeNode(t);if(e===null)throw new _s(t);return e.getUserDataIndices()}getUserData(t,e){const i=this._assemblyTree.lookupAnyTreeNode(t);if(i===null)throw new _s(t);return i.getUserData(e)}getInstanceIncs(t,e){const i=this._assemblyTree.lookupAnyTreeNode(t);if(i===null)return console.assert(!1),[];const n=Do(i);return Lc(i,e,n,new Set,zt.None)}getNodeFromInstanceInc(t,e,i,n){let r=this._assemblyTree.lookupAnyBodyByInstanceInc(e,i);if(r===null){const o=t?this._rectifyParent(e,null):this._assemblyTree.getRootNode();r=this._assemblyTree.createMeshInstance(t,e,i,null,null,o,!1,n,!0,!1)}else r instanceof Ds&&(r=r.getParent());return r.getRuntimeId()}_getAssociatedModelKey(t){return t instanceof os?t.getModelKey():this._getAssociatedModelKey(t.getParent())}getAssociatedModelKey(t){let e=this._assemblyTree.lookupAnyTreeNode(t);return e===null?(e=this._assemblyTree.lookupAnyNonTreeNode(t),e===null?null:this._getAssociatedModelKey(e)):Di(e).getMasterModelKey()}getMatrix(t){const e=this._assemblyTree.lookupAnyNode(t);if(e===null)return new _t;const i=e.getLocalTransform();return i===null?new _t:_t.createFromArray(i)}async setMatrix(t,e,i){const n=this._assemblyTree.lookupAnyTreeNode(t);if(n===null)return;i?n.setLocalTransformAsInitial(e.m):n.overrideLocalTransform(e.m);const r=Do(n);return Oc(this._engine,this._callbackManager,[n],r)}setMatrices(t,e,i){const n=[];let r=!1;for(let o=0;o<t.length;o++){const l=this._assemblyTree.lookupAnyTreeNode(t[o]),h=e[o];l!==null&&(i?l.setLocalTransformAsInitial(h.m):l.overrideLocalTransform(h.m),r=r||Do(l),n.push(l))}return Oc(this._engine,this._callbackManager,n,r)}async resetToInitialMatrix(t){const e=this._assemblyTree.lookupAnyTreeNode(t);if(e!==null&&e.hasLocalTransformOverride()){e.removeLocalTransformOverride();const i=Do(e);return Oc(this._engine,this._callbackManager,[e],i)}}getNetMatrix(t){const e=this._assemblyTree.lookupAnyNode(t);return e===null?Vn.getIdentity():zc(e)}_getBodyInstanceIndexFrom(t,e,i){i===void 0&&(i={});const n=t.getBodyInstances();for(const l of n)if(i.value!==void 0?i.value++:i.value=0,l===e)return i.value;let r;const o=t.getChildrenSync();for(const l of o)if(r=this._getBodyInstanceIndexFrom(l,e,i),r!==void 0)return r}async getNodeOrRepItem(t){if(t instanceof zi){const e=t.getParent();let i,n=e;for(;;){if(!(n instanceof me))return null;await Fc(n);const l=await n.getPartDefinition();if(l!==null){i=await l.value;break}n=n.getParent()}const r=this._getBodyInstanceIndexFrom(n,t),o=i.getRepresentationItems();return r!==void 0&&r<o.length?o[r]:null}else if(t instanceof me||t instanceof Cn||t instanceof as||t instanceof os||t instanceof Ji)return t;return null}async _getNodeOrRepItemFromId(t){const e=this._assemblyTree.lookupAnyNode(t);return e===null?null:this.getNodeOrRepItem(e)}async getPointAttributes(t,e){const i=await this._getNodeOrRepItemFromId(t);if(i instanceof Ji){const n=i.getPointAttributes(e);if(n!==null)return n.copy()}return null}async getEdgeCount(t){const e=await this._getNodeOrRepItemFromId(t);return e instanceof Ji?e.getEdgeCount():0}async getEdgeAttributes(t,e){const i=await this._getNodeOrRepItemFromId(t);if(i instanceof Ji){const n=i.getEdgeAttributes(e);if(n!==null)return n.copy()}return null}async getEdgeProperty(t,e){const i=await this._getNodeOrRepItemFromId(t);if(i instanceof Ji){const n=i.getEdgeMeasurementProperty(e);if(n!==null)return n.copy()}return null}async getFaceCount(t){const e=await this._getNodeOrRepItemFromId(t);return e instanceof Ji?e.getFaceCount():0}async getFaceAttributes(t,e){const i=await this._getNodeOrRepItemFromId(t);if(i instanceof Ji){const n=i.getFaceAttributes(e);if(n!=null)return n.copy()}return null}async getFaceProperty(t,e){const i=await this._getNodeOrRepItemFromId(t);if(i instanceof Ji){const n=i.getFaceMeasurementProperty(e);if(n!==null)return n.copy()}return null}setEdgeProperty(t,e,i){const n=this._assemblyTree.lookupRepresentationItem(t);n!==null&&II(i)&&n.setEdgeMeasurementProperty(e,i)}setFaceProperty(t,e,i){const n=this._assemblyTree.lookupRepresentationItem(t);n!==null&&bI(i)&&n.setFaceMeasurementProperty(e,i)}getName(t){const e=this._assemblyTree.lookupAnyNode(t);return e!==null?e.getName():null}getNodeExchangeId(t){const e=this._assemblyTree.lookupAnyNode(t);return e!==null?e.getExchangeId():null}getFilters(){return this._assemblyTree.getFilters()}getFilterName(t){return this._assemblyTree.getFilterName(t)}getFiltersWithNode(t){const e=this._assemblyTree.lookupAnyTreeNode(t);return e===null?[]:this._assemblyTree.getFiltersWithNode(e)}getNodesFromFilterIds(t){return this._assemblyTree.getNodesFromFilterIds(t)}getLayers(){return this._assemblyTree.getLayers()}getUniqueLayerNames(){return this._assemblyTree.getUniqueLayerNames()}getLayerName(t){return this._assemblyTree.getLayerName(t)}getLayerIdsFromName(t){return this._assemblyTree.getLayersIdFromName(t)}getNodeLayerId(t){const e=this._assemblyTree.lookupAnyTreeNode(t);if(e===null)return null;const i=e.getAuthoredLayerId();return i===null?null:Ks(e).getRuntimeLayerId(i)}getAuthoredNodesFromLayer(t,e){const i=this._assemblyTree.getNodesFromLayer(t,e);return i===null?null:i.map(n=>n.getAuthoredId())}getAuthoredNodesFromLayers(t,e){const i=this._assemblyTree.getNodesFromLayers(t,e);return i===null?null:i.map(n=>n.getAuthoredId())}getRuntimeNodesFromLayer(t,e){const i=this._assemblyTree.getNodesFromLayer(t,e);return i===null?null:i.map(n=>n.getRuntimeId())}getRuntimeNodesFromLayers(t,e){const i=this._assemblyTree.getNodesFromLayers(t,e);return i===null?null:i.map(n=>n.getRuntimeId())}getRuntimeNodesFromLayerName(t,e){const i=this._assemblyTree.getNodesFromLayerName(t,e);return i===null?null:i.map(n=>n.getRuntimeId())}createCadView(t,e,i,n,r,o,l,h,u){if(this._assemblyTree.lookupProductOccurrence(t)===null)return null;const g=this._assemblyTree.lookupProductOccurrence(t);if(g===null)return null;let y=null;if(n!=null){y=[];for(const b of n){const x=this._assemblyTree.lookupPmi(b);x!==null&&y.push(x)}}const m=new Map;for(const[b,x]of l)m.set(b,x.m);return this._assemblyTree.createCadView(this._engine,g,e,i,y,r,o,m,h,u).getRuntimeId()}getCadViewMap(){const t=this._assemblyTree.getFirstProductOccurrenceWithView(),e=new Map;return this._assemblyTree.forEachCadView(i=>{const n=i.getRuntimeId(),r=i.getParent();let o;r===t?o=i.getName()||"(null)":o=`${r.getName()} - ${i.getName()}`,e.set(n,o)}),e}async activateCadView(t,e,i,n){if(this.applyFilters(this.getFiltersFromView(e)),this._assemblyTree.hasActiveCadView())return await this._assemblyTree.deactivateActiveCadView(),this.activateCadView(t,e,i,n);const r=this._assemblyTree.lookupCadView(e);if(r!==null)return this._assemblyTree.activateCadView(t,r,i,n)}getCadViewPmis(t){const e=this._assemblyTree.lookupCadView(t);if(e===null)return[];const i=[],n=this._assemblyTree.getCadViewPmis(e);for(const r of n)i.push(r.getRuntimeId());return i}async _disableCadConfigurations(){this._cadConfigurationsEnabled=!1,await this._assemblyTree.deactivateActiveCadView()}async cadConfigurationsEnabled(){return this._cadConfigurationsEnabled&&this._assemblyTree.seenExternalModel()&&await this._disableCadConfigurations(),this._cadConfigurationsEnabled}getCadConfigurations(){const t={};return this._assemblyTree.forEachCadConfiguration(e=>{const i=e.getRuntimeId(),n=e.getName()||"(null)";t[i]=n}),t}getDefaultCadConfiguration(){const t=this._assemblyTree.getDefaultCadConfiguration();return t!==null?t.getRuntimeId():null}getActiveCadConfiguration(){const t=this._assemblyTree.getActiveCadConfiguration();return t!==null?t.getRuntimeId():null}getCadViewConfiguration(t){const e=this._assemblyTree.lookupCadView(t);if(e===null)return null;const i=e.getParent();return i!==null&&i.isAConfigurationNode()?i.getRuntimeId():null}async _activateCadConfiguration(t,e,i){this._assemblyTree.activateCadConfiguration(e);const n=e.getRuntimeId(),r=this._assemblyTree.getCadConfigurations().filter(u=>u!==e).map(u=>u.getRuntimeId()),o=new Map;o.set(n,!0),r.forEach(u=>{o.set(u,!1)}),await this.setVisibilitiesByMap(o);const l=await mm(e,jt.All,!0,new Set);i&&l!==null&&l.length>0&&await t.fitNodes([n],Yn),this._callbackManager.trigger("configurationActivated",n)}async activateCadConfiguration(t,e,i){const n=this._assemblyTree.lookupProductOccurrence(e);if(n!==null)return this._activateCadConfiguration(t,n,i)}async activateDefaultCadConfiguration(t,e){const i=this._assemblyTree.getDefaultCadConfiguration();i!==null&&await this._activateCadConfiguration(t,i,e)}getDefaultCadView(){const t=this._assemblyTree.getDefaultCadConfiguration(),e=this._assemblyTree.getDefaultCadView(t);return e!==null?e.getRuntimeId():null}async activateDefaultCadView(t,e,i){const n=this.getDefaultCadView();n!==null&&await this.activateCadView(t,n,e,i)}getPmis(){const t={};return this._assemblyTree.forEachPmi(e=>{const i=e.getRuntimeId(),n=e.getName()||"(null)";t[i]=n}),t}getPmiType(t){const e=this._assemblyTree.lookupPmi(t);return e===null?Nf.Unknown:e.getPmiType()}getPmiSubType(t){const e=this._assemblyTree.lookupPmi(t);return e===null?Df.Unknown:e.getPmiSubType()}getUnit(t){const e=this._assemblyTree.lookupAnyNode(t);return e instanceof me?e.getMeasurementUnit():e instanceof zi?e.getParent().getMeasurementUnit():1}_rectifyParent(t,e){if(e!==null){const n=this._assemblyTree.lookupProductOccurrence(e);if(n!==null)return n;console.assert(!1)}const i=this._assemblyTree.getInclusionContexts(t);if(i.length>0){const r=i[0].getChildren();return console.assert(r.length>0),r[0]}return this._assemblyTree.getRootNode()}createMeshInstance(t,e,i,n,r,o,l){const h=this._rectifyParent(t,n);return this._assemblyTree.createMeshInstance(!0,t,e,null,i,h,r,o,!0,l).getRuntimeId()}createPmiInstance(t,e,i,n,r,o,l){const h=this._rectifyParent(t,l);return this._assemblyTree.createPmiInstance(t,e,null,o,h,i,n,r).getRuntimeId()}setVisibilitiesByMap(t,e){const i=new Map;t.forEach((l,h)=>{const u=this._assemblyTree.lookupAnyTreeNode(h);u!==null&&i.set(u,l)});let n=null;const r=this.getActiveCadConfiguration();r!==null&&(n=this._assemblyTree.lookupProductOccurrence(r));const o=this._assemblyTree.getRootNode();return mf({assemblyTree:this._assemblyTree,engine:this._engine,startNode:o,visibilityFormatter:l=>i.get(l),resetNonAffectedToDefault:!1,configurationNode:n!==null?n:void 0,callbackManager:this._callbackManager,initiallyHiddenStayHidden:e})}setBodyNodesVisibility(t,e){const i=typeof e=="boolean"?n=>e:e;return a0({assemblyTree:this._assemblyTree,engine:this._engine,startNode:t,visibilityFormatter:i,resetNonAffectedToDefault:!1,callbackManager:this._callbackManager,initiallyHiddenStayHidden:!1})}setVisibilitiesByValue(t,e,i){const n=new Map;for(const r of t)n.set(r,e);return this.setVisibilitiesByMap(n,i!==null?i:void 0)}resetAllVisibilities(){const t=this._assemblyTree.getRootNode(),e=this._assemblyTree.getActiveCadConfiguration();return mf({assemblyTree:this._assemblyTree,engine:this._engine,startNode:t,visibilityFormatter:()=>{},resetNonAffectedToDefault:!0,configurationNode:e!==null?e:void 0,callbackManager:this._callbackManager})}async resetAllTransforms(){const t=this._assemblyTree.getRootNode();if(await wI(t))return Oc(this._engine,this._callbackManager,[t],!1)}async reset(){if(this._cadConfigurationsEnabled=!0,this.isACadDrawing())return this._callbackManager.promiseTrigger("_resetDrawing",null);this._assemblyTree.hasActiveCadView()&&await this._assemblyTree.deactivateActiveCadView();const t=[this.resetAllVisibilities(),this.resetAllTransforms()];await Ue(t)}setPmiColor(t,e){e===void 0&&(e=this.getAbsoluteRootNodeId());const i=this.getInstanceIncs(e,jt.PmiBody|jt.ViewFrame);i.length>0&&(this._engine.setPartColor(i,Yt.Faces,t),this._engine.setPartColor(i,Yt.Lines,t))}resetPmiColor(t){t===void 0&&(t=this.getAbsoluteRootNodeId());const e=this.getInstanceIncs(t,jt.PmiBody|jt.ViewFrame);e.length>0&&(this._engine.unsetPartColor(e,Yt.Faces),this._engine.unsetPartColor(e,Yt.Lines))}getPmiTopologyReferences(t){const e=this._assemblyTree.lookupPmi(t);return e===null?null:e.getPmiTopologyReferences(this._assemblyTree)}createNode(t,e,i,n=null,r=!0,o=null){let l=null;t!==null&&(l=this._assemblyTree.lookupProductOccurrence(t)),l===null&&(l=this._assemblyTree.getRootNode()),i!==null&&!Ja(i)&&(i=null);const h=(()=>{if(o){const g=o/l.getMeasurementUnit(),y=new _t().setScaleComponent(g,g,g);return n?_t.multiply(n,y):y}else return n})(),u=h===null?null:h.m;return this._assemblyTree.createNode(l,e,i,u,r,o).getRuntimeId()}async deleteNode(t){const e=this._assemblyTree.lookupAnyTreeNode(t);if(e!==null){if(e instanceof me||e instanceof zi||e instanceof Cn)return this._assemblyTree.deleteNode(e);throw new Zn(t,In.ProductOccurrence,In.BodyInstance)}}createPart(t){return this._assemblyTree.createPart(t).getRuntimeId()}setPart(t,e){const i=this._assemblyTree.lookupProductOccurrence(t);if(i===null)return!1;const n=this._assemblyTree.lookupPartDefinition(e);return n===null?!1:(this._assemblyTree.setPart(i,n),!0)}createAndAddRepItem(t,e){const i=this._assemblyTree.lookupPartDefinition(t);return i===null?null:i.createRepItem(this._assemblyTree,e).getRuntimeId()}getLowestAvailableNodeId(){return this._assemblyTree.getLowestAvailableNodeId()}getType(t){const e=this._assemblyTree.lookupAnyNode(t);return e===null?Ne.Unknown:E0(e)}isVisible(t){const e=this._assemblyTree.lookupAnyNode(t);return e!==null?e.isVisible():!1}getBranchVisibility(t){const e=this._assemblyTree.lookupAnyTreeNode(t);return e!==null?M0(e):he.Hidden}setMeshLevel(t,e){const i=[];for(const n of t){const r=this._assemblyTree.lookupAnyTreeNode(n);r!==null&&i.push(r)}return vI(this._engine,i,e)}setEnableAutomaticUnitScaling(t){this._assemblyTree.setAutomaticMeasurementUnitScaling(t)}setBehaviorInitiallyHidden(t){this._assemblyTree.setInitiallyHiddenStayHidden(t)}isACadDrawing(){return this._assemblyTree.containsDrawings()}isMeasurable(){return this._assemblyTree.isMeasurable()}async isLineMeasurable(t,e){const i=await this._getNodeOrRepItemFromId(t);return i instanceof Ji?i.getEdgeMeasurementProperty(e)!==null:!1}async isFaceMeasurable(t,e){const i=await this._getNodeOrRepItemFromId(t);return i instanceof Ji?i.getFaceMeasurementProperty(e)!==null:!1}getModelFileNameFromNode(t){const e=this._assemblyTree.lookupAnyTreeNode(t);return e!==null?Di(e).getOriginalFileName():null}getModelFileTypeFromNode(t){const e=this._assemblyTree.lookupAnyTreeNode(t);return e!==null?Di(e).getOriginalFileType():null}isAnnotationView(t){const e=this._assemblyTree.lookupCadView(t);if(e!==null)return e.isAnnotationView();throw new Zn(t,In.CadView)}isCombineStateView(t){const e=this._assemblyTree.lookupCadView(t);if(e)return e.isCombineStateView();throw new Zn(t,In.CadView)}allowNodeDeletion(t){const e=this._assemblyTree.lookupBodyInstance(t);if(e===null)throw new ei;this._assemblyTree.allowNodeDeletion(e)}preventNodeDeletion(t){const e=this._assemblyTree.lookupBodyInstance(t);if(e===null)throw new ei;this._assemblyTree.preventNodeDeletion(e)}preventMeshDeletion(t){this._assemblyTree.preventMeshDeletion(t)}getBounding(t,e,i,n){return ym(this._assemblyTree,this._engine,t,e,i,n)}getIdOffset(t){const e=this._assemblyTree.lookupAnyNode(t);if(e!==null){let i;return e instanceof os?i=e.getInclusionContextForNodeId():e instanceof Ji?i=e.getParent().getInclusionContextForNodeId():i=Gi(e),i.getIdOffset()}return 0}isNodeLoaded(t){const e=this._assemblyTree.lookupAnyNode(t);if(e===null)throw new _s(t);return e.isLoaded()}shutdown(){this._treeLoader&&this._treeLoader.cancelPendingLoads()}isReady(){return console.assert(this._readyPromise.state!==Nr.Rejected),this._readyPromise.state!==Nr.Pending}waitForReady(){return this._readyPromise}lookupAnyTreeNode(t){return this._assemblyTree.lookupAnyTreeNode(t)}lookupAnyBody(t){return this._assemblyTree.lookupAnyBody(t)}lookupBodyInstance(t){return this._assemblyTree.lookupBodyInstance(t)}gatherInstanceIncsFromNodeIds(t,e,i){return _m(this._assemblyTree,t,e,i)}gatherInclusionKeysFromNodeIds(t){return yI(this._assemblyTree,t,zt.None)}async requestNodes(t){const e=[];for(const i of t){const n=this._assemblyTree.lookupAnyTreeNode(i);n!==null&&e.push(n)}return this._assemblyTree.requestNodes(this._treeLoader,e,!1)}isWithinExternalModel(t){const e=this._assemblyTree.lookupAnyTreeNode(t);if(e===null)return!1;let i=ur(e);for(;i!==null;){if(i.isExternalModelRoot())return!0;i=ur(i.getParent())}return!1}getNodeGenericType(t){const e=this._assemblyTree.lookupAnyTreeNode(t);return e!==null?Hc(e):null}getNodeGenericId(t){const e=this._assemblyTree.lookupAnyTreeNode(t);return e!==null?e.getGenericId():null}getNodesByGenericId(t){const e=this._assemblyTree.getNodesByGenericId(t);if(e!==null){const i=new Set;return e.forEach(n=>{i.add(n.getRuntimeId())}),i}return null}getNodesByGenericType(t){const e=this._assemblyTree.getNodesByGenericType(t);if(e!==null){const i=new Set;return e.forEach(n=>{i.add(n.getRuntimeId())}),i}return null}getGenericTypes(){const t=[];return this._assemblyTree.genericTypeToNodes().forEach((i,n)=>{t.push(n)}),t}getGenericTypeIdMap(){const t=new Map;return this._assemblyTree.genericTypeToNodes().forEach((i,n)=>{const r=new Set;i.forEach(o=>{r.add(o.getRuntimeId())}),t.set(n,r)}),t}hasEffectiveGenericType(t,e){const i=this.lookupAnyTreeNode(t);if(i===null)throw new _s(t);return j0(i,e)}registerGenericId(t,e){return this._assemblyTree.registerGenericGlobalId(t,e)}registerGenericType(t,e){return this._assemblyTree.registerGenericType(t,e)}hasRelationships(t){const e=this.lookupAnyTreeNode(t);if(e===null)throw new _s(t);return Gi(e).getRelationships().length>0}getBimIdFromNode(t){const e=this.lookupAnyTreeNode(t);return e===null||!e.hasAuthoredId()?null:e.getAuthoredId().toString()}getRuntimeNodeFromBimId(t,e){const i=this.lookupAnyTreeNode(t);return i===null?null:Gi(i).getRuntimeNodeFromBimId(e)}getRelationsByTypeFromNode(t,e){return this._assemblyTree.getRelationshipsOfItem(t,e)}firstAssemblyDataHeader(){return this._treeLoader.firstAssemblyDataHeader()}setPrefetchScsCutoffScale(t){this._treeLoader.setPrefetchScsCutoffScale(t)}getAllRelationships(t){const e=this.lookupAnyTreeNode(t);return e===null?[]:Gi(e).getRelationships()}getAllBimInfos(t){const e=this.lookupAnyTreeNode(t);return e===null?[]:Gi(e).getBimInfos()}getInfoOfBimId(t,e){const i=this.getAllBimInfos(t);for(const n of i)if(n.id===e){let r=n.name,o=!1;if(n.category===Eo.Connected){const l=this.getRuntimeNodeFromBimId(t,e);l!==null&&this.getName(l)!==null&&(r=this.getName(l),o=!0)}return{name:r,connected:o}}return{name:"",connected:!1}}getBimIdRelationshipTypes(t,e){var h,u;const i=this.lookupAnyTreeNode(t);if(i===null)return[];const r=Gi(i).getRelationships(),o=new Map;for(const d of r){const g=o.has(d.type)?o.get(d.type):{relateds:new Set,relatings:[]};((h=d.relating)==null?void 0:h.relationElt.id)===e?(u=d.related)==null||u.relationships.forEach(y=>g.relateds.add(y.id)):d.related!==null&&d.relating!==null&&d.related.relationships.filter(y=>y.id===e).forEach(()=>g.relatings.push(d.relating.relationElt.id)),o.set(d.type,g)}return Array.from(o.entries()).map(d=>({type:d[0],relateds:Array.from(d[1].relateds),relatings:Array.from(d[1].relatings)}))}getFiltersFromView(t){var e;return((e=this._assemblyTree.lookupCadView(t))==null?void 0:e.getFilters())??[]}applyFilters(t){const e=this.getNodesFromFilterIds(t);if(!e)return;const i=[...e.nodeIds];this._applyFiltersAsync(e.isInclusive,i).catch(n=>{console.error("Unhandled error in _applyFiltersAsync:",n)})}async _applyFiltersAsync(t,e){try{await this._engine.pauseAllRendering(),await this.reset(),t&&await this.setVisibilitiesByValue([this.getAbsoluteRootNodeId()],!1,!1),await this.setVisibilitiesByValue(e,t,!1),await this._engine.resumeAllRendering()}catch(i){console.error("Error resetting model:",i)}}async _getNodeAttributes(t){return(await t.getAttributes()).reduce((i,n)=>{const r=n.getValueName(),o=r?`${n.getTitle()??""}/${r}`:n.getTitle()??"";return i[o]=`${n.getValue()}${n.getUnit()}`,i},{})}_handlePhysicalProperties(t,e){const i={},n=this.getNetMatrix(t),r=new _(n[0],n[1],n[2]),o=this.getUnit(t),l=r.length()/o,h=e.surfaceArea*l*l,u=e.volume*l*l*l;i["Surface Area"]=`${Ua(h,o)}${lv}`,i.Volume=`${Ua(u,o)}${cv}`;const d=_.scale(_t.createFromArray(n).transform(e.centerOfGravity),1/o);return i.COG=`x:${d.x.toLocaleString()} y:${d.y.toLocaleString()} z:${d.z.toLocaleString()}`,i}async _getPartDefAttributes(t){const e={},i=await t.getAttributes();for(const n of i){const r=n.getValueName();let o=n.getTitle();r!==null&&(o=o?`${o}/${r}`:r);const h=`${n.getValue()}${n.getUnit()}`;e[o]=h}return e}}class CI{constructor(t){this._engine=t}getIdentityInc(){return this._identityInc}async init(){const t=await this._engine.createIdentityMatrix();this._identityInc=t}}function SI(s,t){const e=[];for(let i=0;i<s.length;i+=t)e.push(s.slice(i,i+t));return e}function yg(s,t,e){if(s.selectionMask===xe.None)throw new ae("selectionMask is None");return{...s,cullSuboptimalEntities:t,enableOcclusionChecks:t,restrictLinesAndPointsToSelectedFaceInstances:e?!1:s.restrictLinesAndPointsToSelectedFaceInstances}}function e1(s){return s}function i1(s){return s}function PI(s){let t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=null;for(const n of s)if(n.length>0){const r=n[0];r.radialMetric<t?(t=r.radialMetric,e=r.zMetric,i=n):r.radialMetric===t&&r.zMetric<e&&(e=r.zMetric,i=n)}return i}function kI(s,t,e,i){const n=t!==null?t.entities:[],r=e!==null?e.entities:[],o=i!==null?i.entities:[],l=[n,r,o];for(;;){const h=PI(l);if(h===null){console.assert(n.length===0),console.assert(r.length===0),console.assert(o.length===0);return}console.assert(h.length>0);let u;if(h===n){const d=n.pop();u=wg(d)}else if(h===r){const d=r.pop();u=vg(d)}else{console.assert(h===o);const d=o.pop();u=Nl(d,!0)}s.push(u)}}function Nl(s,t){const e=_.createFromArray(s.rayPoint),i=_.createFromArray(s.normal),n=new _(s.bounding.min[0],s.bounding.min[1],s.bounding.min[2]),r=new _(s.bounding.max[0],s.bounding.max[1],s.bounding.max[2]),o=new on(n,r),l=new Zc(e,i,s.elementIndex,s.overlayIndex,s.elementBits,o,t),h=s.instanceInc;return wi.create(h[1],h[0],l,null,null)}function wg(s){const t=new _(s.bounding.min[0],s.bounding.min[1],s.bounding.min[2]),e=new _(s.bounding.max[0],s.bounding.max[1],s.bounding.max[2]),i=new on(t,e),n=new th(s.elementIndex,_.createFromArray(s.point),s.lineSegmentVertices,s.bestLineSegmentVertexIndex,i,s.overlayIndex,s.elementBits),r=s.instanceInc;return wi.create(r[1],r[0],null,n,null)}function vg(s){const t=new eh(_.createFromArray(s.point),s.elementIndex,s.overlayIndex,s.elementBits),e=s.instanceInc;return wi.create(e[1],e[0],null,null,t)}function Iy(s){if(s.point!==null){const t=s.point.entities[0];return vg(t)}if(s.line!==null){const t=s.line.entities[0];return wg(t)}if(s.face!==null){const t=s.face.entities[0];return Nl(t,!1)}if(s.proximityFace!==null){const t=s.proximityFace.entities[0];return Nl(t,!0)}return null}function xy(s){let t=null;if(s.face!==null){const n=s.face.entities[0];t=Nl(n,!1)}else if(s.proximityFace!==null){const n=s.proximityFace.entities[0];t=Nl(n,!0)}let e=null;if(s.line!==null){const n=s.line.entities[0];e=wg(n)}let i=null;if(s.point!==null){const n=s.point.entities[0];i=vg(n)}return new Zu(t,e,i)}function Cy(s){const t=[];if(s.face!==null)for(const e of s.face.entities){const i=Nl(e,!1);t.push(i)}return kI(t,s.line,s.point,s.proximityFace),t}class MI{constructor(t){this._pickTolerance=20,this._incrementalChunkedItems=new Map,this._sc=t}setPickTolerance(t){this._pickTolerance=t}getPickTolerance(){return this._pickTolerance}async beginScreenAreaSelection(t,e,i,n){const r=n;let o;try{o=await this._sc.beginScreenAreaSelection(t,e.x,e.y,i.x,i.y,r)}catch(l){throw ea(l)&&l.scFunction==="beginScreenAreaSelection"?new Or:l}return new Qc(o)}async beginRayDrillSelection(t,e,i,n){const r=n;let o;try{o=await this._sc.beginRayDrillSelection(t,e.x,e.y,i,r)}catch(l){throw ea(l)&&l.scFunction==="beginRayDrillSelection"?new Or:l}return new Qc(o)}async beginConvexPolyhedronSelection(t,e,i){const n=i,r=[];for(const h of t)r.push(h.getCoefficients());const o=[e.x,e.y,e.z];let l;try{l=await this._sc.beginConvexPolyhedronSelection(r,o,n,ke.Default)}catch(h){throw ea(h)&&h.scFunction==="beginConvexPolyhedronSelection"?new Or:h}return new Qc(l)}async beginSphereSelection(t,e,i){const n=i;let r;try{r=await this._sc.beginSphereSelection(ke.Default,t,e,n)}catch(o){throw ea(o)&&o.scFunction==="beginSphereSelection"?new Or:o}return new Qc(r)}endIncrementalSelection(t){this._incrementalChunkedItems.delete(t._handle),this._sc.endVolumeSelection(t._handle)}async advanceIncrementalSelection(t,e){const i=this._incrementalChunkedItems.get(t._handle);if(i&&i.length!==0)return i.pop();let n;try{n=await this._sc.advanceVolumeSelection(t._handle,5e3)}catch(l){throw ea(l)&&l.scFunction==="advanceVolumeSelection"?new Or:l}if(n.length===2&&n[1]===of.Invalid)return e?(await this._sc.setStreamIdleMarker(),this.advanceIncrementalSelection(t,!1)):null;const r=[];for(let l=0;l<n.length;l+=2){const h=n[l],u=n[l+1];r.push(wi.create(u,h))}if(r.length<=500)return r;const o=SI(r,500).reverse();return this._incrementalChunkedItems.set(t._handle,o),o.pop()}async _screenSelectByRay(t,e,i,n,r){const o=yg(i,n,r),l=i.selectionMask,u=i.selectionMask!==xe.Face||i.enableProximityFaces?this._pickTolerance:-1;return this._sc.screenSelectByRay(t,l,e.x,e.y,u,o)}async _worldSelectByRay(t,e,i){const n=yg(e,i,!1),r=uu(t);return this._sc.worldSelectByRay(ke.Default,r,n)}async pickFromScreen(t,e,i,n){const r=await this._screenSelectByRay(t,e,i,!0,n);return Iy(r)}async pickAllFromScreen(t,e,i,n){const r=await this._screenSelectByRay(t,e,i,!1,n);return Cy(r)}async compositePickFromScreen(t,e,i,n){const r=await this._screenSelectByRay(t,e,i,!0,n);return xy(r)}async pickFromRay(t,e){const i=await this._worldSelectByRay(t,e,!0);return Iy(i)}async pickAllFromRay(t,e){const i=await this._worldSelectByRay(t,e,!1);return Cy(i)}async pickCompositeFromRay(t,e){const i=yg(e,!0,!1),n=uu(t),r=await this._sc.worldSelectByRay(ke.Default,n,i);return xy(r)}}class EI{constructor(t,e){this._viewIndices=new Set([ke.Default]),this._windowSizes=new Map,this._engineReadyPromise=mi(),this._sessionStartedPromise=mi(),this._connectionlessEmpty=!1,this._uri="ws://localhost:9999",this._streamingMode=lo.Default,this._rendererType=ll.Client,this._meshLevel=0,this._memoryLimit=0,this._boundingPreviewMode=co.All,this._streamCutoffScale=1,this._loadFinished=!1,this._statistics=new py,this._cachedTriangleCount=null,this._cachedElementCount=null,this._cuttingSectionToKeyMap=new Map,this._cappingQuantizationGranularity=-1e4,this._cappingFaceColor=vt.createFromFloat(.5,.5,.5),this._cappingLineColor=vt.createFromFloat(.5,.5,.5),this._cappingGeometryVisibility=!0,this._cappingNeedsUpdate=!0,this._cappingDelayTimeoutId=null,this._cappingDelay=500,this._requestBatchCountByType=[],this._pendingRequestsByType=[],this._callbackManager=t,this._applyOptions(e);for(let i=0;i<Mc.Count;++i)this._requestBatchCountByType.push(0),this._pendingRequestsByType.push([])}async addView(t){const e=await this._sc.addDrawContext();eo.setupNewView(this._sc,e,t),this._viewIndices.add(e),this._canvasContainers.set(e,t);const i=document.createElement("canvas");this._canvases.set(e,i);const n=i.getContext("2d");if(!n)throw new Error("Unable to create 2d context for canvas");return this._canvas2dContexts.set(e,n),i.setAttribute("style","position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 0; margin: 0; border: 0;"),i.style.display="",t.appendChild(i),this.resize(e),e}removeView(t){this._viewIndices.delete(t),this._sc.removeDrawContext(t)}getNetworkModelName(){if(console.assert(this._sessionType===Xi.Network),this._model!==void 0)return this._model;throw new ei}logMessage(t){console.log(t)}setTimeout(t,e){return setTimeout(t,e)}sleep(t){return mu(t)}getScsInfo(){return console.assert(this._sessionType===Xi.Scs),this._buffer!==void 0?this._buffer:/^wss?:\/\//i.test(this._uri)?null:this._uri}_applyOptions(t){t.empty!==void 0&&(this._connectionlessEmpty=t.empty),t.endpointUri!==void 0&&(this._uri=t.endpointUri),t.model&&(this._model=t.model),t.sessionToken!==void 0&&(this._sessionToken=t.sessionToken),t.buffer!==void 0&&(this._buffer=t.buffer),t.streamingMode!==void 0&&(this._streamingMode=t.streamingMode),t.rendererType!==void 0&&(this._rendererType=t.rendererType),t.defaultMeshLevel!==void 0&&(this._meshLevel=t.defaultMeshLevel),t.memoryLimit!==void 0&&(this._memoryLimit=t.memoryLimit),t.boundingPreviewMode!==void 0&&(this._boundingPreviewMode=t.boundingPreviewMode),t.streamCutoffScale!==void 0&&this._setStreamCutoffScale(t.streamCutoffScale)}start(t,e){this._canvasContainers=new Map,this._canvasContainers.set(ke.Default,t),this._initOptions=e;const i=document.createElement("canvas");this._canvases=new Map,this._canvases.set(ke.Default,i);const n=i.getContext("2d");if(!n)throw new Error("Unable to create 2d context for canvas");return this._canvas2dContexts=new Map,this._canvas2dContexts.set(ke.Default,n),i.setAttribute("style","position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 0; margin: 0; border: 0;"),i.style.display="",eo.createInstance({container:t,onReady:r=>{t.appendChild(i),this._onEngineReady(r)},onError:r=>{this._callbackManager.trigger("modelLoadFailure",this._model||"",`failed to load engine: ${r}`)},enginePath:e.enginePath}),!0}setPickTolerance(t){this._scSelectionManager.setPickTolerance(t)}getPickTolerance(){return this._scSelectionManager.getPickTolerance()}_onEngineReady(t){this._sc=t,this._sessionType=Xi.Uninitialized,this._matrixCache=new CI(this),this._scSelectionManager=new MI(this._sc),this._callbackManager.bind({_firstBoundingReady:async()=>{for(const e of this._viewIndices)this._regenerateCapping(e)},_drawContextCreated:e=>{this._sc.setDrawMode(e,ar.Highlight),this._sc.setHighlightedInstanceFilter(e,Ar.Colorize),this._sc.setUnhighlightedFilter(e,Ar.None),this._sc.setHighlightMode(e,nu.VisibleWithFullOutline),this._sc.setAntiAliasingMode(e,qa.SMAA)}}),this._sc.setEventHandler("session_started",()=>{const e=()=>(this._callbackManager.unbind(i),this._sessionStartedPromise),i={_sessionStarted:()=>this._onSessionStarted(),_assemblyTreeReady:e,_modelSwitched:e};this._callbackManager.bind(i),this._sessionStartedPromise.resolve(this._callbackManager.promiseTrigger("_sessionStarted",null))}),this._sc.setEventHandler("announce_model",(e,i,n)=>{this._callbackManager.trigger("_announceModel",i,n)}),this._sc.setEventHandler("first_instance",()=>{this._callbackManager.trigger("_firstInstance")}),this._sc.setEventHandler("inclusion",(e,i,n,r)=>{this._callbackManager.trigger("_inclusion",i,n,r)}),this._sc.setEventHandler("remap_model",(e,i,n,r)=>{this._callbackManager.trigger("_remapModel",i,n,r)}),this._sc.setEventHandler("remap_inclusion",(e,i,n,r,o)=>{this._callbackManager.trigger("_remapInclusion",i,n,r,o)}),this._sc.setEventHandler("capping_idle",(e,i,n)=>{this._callbackManager.trigger("cappingIdle",i,n)}),this._sc.setEventHandler("stream_active",this._initOptions.streamingActivated),this._sc.setEventHandler("stream_idle",this._initOptions.streamingDeactivated),this._sc.setEventHandler("open_model_failed",(e,i)=>{let n;switch(i.reason){case"UNKNOWN_MODEL":n="Unknown model";break;case"BAD_NETWORK_VERSION":n="Client/Server network version mismatch";break;case"BAD_STREAM_VERSION":case"BAD_STORE_VERSION":n="Unsupported file version";break;default:n="Internal Error"}this._callbackManager.trigger("modelLoadFailure",this._model||"",n)}),this._sc.setEventHandler("missing_model",(e,i,n)=>{this._callbackManager.trigger("_missingModel",i,n),this._callbackManager.trigger("missingModel",n)}),this._sc.setEventHandler("bad_data",(e,i)=>{let n;switch(i.type){case"TRUNCATED_BLOCK":n="Failed to parse truncated data block.";break;case"ZFRAME_DECOMPRESS_FAILED":n="Failed to decompress data.";break;case"UNMATCHED_CODE":n="Unknown opcode.";break;case"STORE_VERSION_MISMATCHED":n="Store version mismatched.",n+=` Expected='${i.expected}'.`,n+=` Actual='${i.actual}'.`;break;case"STREAM_VERSION_MISMATCHED":n="Stream version mismatched.",n+=` Expected='${i.expected}'.`,n+=` Actual='${i.actual}'.`;break;case"PARSE_BOUNDING_TREE_FAILED":n="Failed to parse bounding ";break;default:n="Unknown error."}this._callbackManager.trigger("modelLoadFailure",this._model||"",n)}),this._sc.setEventHandler("socket_open_failed",()=>{this._callbackManager.trigger("modelLoadFailure",this._model||"","WebSocket connection failed.")}),this._sc.setEventHandler("post_draw",(e,i,n,r,o)=>{const l=this._canvases.get(i),h=this._canvas2dContexts.get(i);h.clearRect(0,0,l.width,l.height);const u=this._sc.canvas.height-l.height,d=l.width,g=l.height;h.drawImage(this._sc.canvas,0,u,d,g,0,0,d,g),this._statistics=n,this._initOptions.renderComplete(),this._fillStatTotalCounts();const y=this._fromScCamera(r);this._callbackManager.trigger("frameDrawn",y,o,i)}),this._sc.setEventHandler("priority_meta_data_sent",(e,i,n)=>{this._initOptions.priorityMetaDataSent(i,n)}),this._sc.setEventHandler("meta_data",(e,i,n,r)=>{i<0&&(i+=4294967296),this._callbackManager.trigger("_metaData",i,n,r)}),this._sc.setEventHandler("draw_complete",(e,i)=>{this._callbackManager.trigger("_drawComplete",i)}),this._sc.setEventHandler("webgl_context_lost",()=>{this._callbackManager.trigger("webGlContextLost")}),this._sc.setEventHandler("websocket_connection_closed",()=>{this._callbackManager.trigger("websocketConnectionClosed")}),this._initOptions.engineReady(this._sessionStartedPromise),this._engineReadyPromise.resolve()}loadFinished(){return this._loadFinished}resetCachedStatistics(){this._cachedElementCount=null,this._cachedTriangleCount=null}setAmbientOcclusionEnabled(t,e){this._sc.setAmbientOcclusionEnabled(t,e)}setAmbientOcclusionRadius(t,e){this._sc.setAmbientOcclusionRadius(t,e)}setLightingEnabled(t,e){this._sc.setLightingEnabled(t,e)}_fillStatTotalCounts(){this._cachedElementCount!==null&&this._cachedTriangleCount!==null&&(this._statistics.total_element_count=this._cachedElementCount,this._statistics.total_triangle_count=this._cachedTriangleCount)}async _updateCachedStats(){const t=this._sc.getElementCount(),e=this._sc.getTriangleCount(),i=await Promise.all([t,e]);this._cachedElementCount=i[0],this._cachedTriangleCount=i[1],this._fillStatTotalCounts()}_toVector3(t){return t.toArray()}startExplode(t,e){this.delayCapping(),this._sc.startExplode(t,this._toVector3(e))}setExplodeMagnitude(t){this._callbackManager.trigger("explode",t),this.delayCapping(),this._sc.explode(t)}stopExplode(){this.delayCapping(),this._sc.resetExplode()}async getStatistics(t=!1){return t&&!this.loadFinished()?(await this._updateCachedStats(),this._fillStatTotalCounts(),this._statistics):this.loadFinished()&&this._cachedTriangleCount===null?(await this._updateCachedStats(),this._fillStatTotalCounts(),this._statistics):(this._fillStatTotalCounts(),this._statistics)}setStreamIdleMarker(){return this._sc.setStreamIdleMarker()}hasDepthRange(t){return this._sc.MeshInstance.hasDepthRange(t)}setDepthRange(t,e,i){this._sc.MeshInstance.setDepthRange(t,e,i)}unsetDepthRange(t){this._sc.MeshInstance.unsetDepthRange(t)}setDefaultDepthRange(t,e,i){this._sc.setDefaultDepthRange(t,e,i)}_getScPlaneArray(t){const e=[];for(let i=0;i<t.getCount();i++){const n=t.getPlane(i);if(n===null)continue;const r=[];n.normal.toArray(r),r[3]=n.d,e.push(r)}return e}getCuttingSectionLimits(){return this._sc.cuttingSectionLimits()}async _addCuttingSection(t,e){let i=$a.Invalid;const n=this._getScPlaneArray(t);if(n.length>0&&(i=await this._sc.addCuttingSection(n),i===$a.Invalid)){const r=e===kc.Add?"add":"update";throw new ae(`Failed to ${r} cutting section.`)}this._cuttingSectionToKeyMap.set(t,i),e===kc.Add&&this._callbackManager.trigger("addCuttingSection",t)}addCuttingSection(t){return this._addCuttingSection(t,kc.Add)}async removeCuttingSection(t){const e=this._cuttingSectionToKeyMap.get(t);if(e===void 0){console.assert(!1);return}if(this._cuttingSectionToKeyMap.delete(t),this._callbackManager.trigger("removeCuttingSection"),e!==$a.Invalid)return this._sc.removeCuttingSections([e])}removeAllCuttingSections(){return this._cuttingSectionToKeyMap.clear(),this._callbackManager.trigger("removeCuttingSection"),this._sc.removeAllCuttingSections()}async updateCuttingSection(t){const e=this._cuttingSectionToKeyMap.get(t);if(e===void 0){console.assert(!1);return}if(e===$a.Invalid)return this._addCuttingSection(t,kc.Update);const i=this._getScPlaneArray(t);return this._sc.replaceCuttingSection(i,e)}setCappingDelay(t){this._cappingDelay=t}enableCappingIdleCallback(t){return this._sc.setCappingIdleHookEnabled(t)}getCappedInstances(){return this._sc.getCappedInstances()}delayCapping(){this._cappingDelayTimeoutId===null?this._sc.pauseCapping():clearTimeout(this._cappingDelayTimeoutId),this._cappingDelayTimeoutId=setTimeout(()=>{this._cappingDelayTimeoutId=null,this._sc.resumeCapping()},this._cappingDelay)}setCappingGeometryVisibility(t,e){if(!(this._cappingGeometryVisibility===e&&!this._cappingNeedsUpdate))if(this._cappingDelayTimeoutId!==null&&(clearTimeout(this._cappingDelayTimeoutId),this._cappingDelayTimeoutId=null),this._cappingNeedsUpdate=!1,this._cappingGeometryVisibility=e,e){const i=this._cappingLineColor!==null?this._toRgba(this._cappingLineColor,1):[-1,-1,-1,-1],n=this._cappingFaceColor!==null?this._toRgba(this._cappingFaceColor,1):[-1,-1,-1,-1];this._sc.enableCapping(t,i,n,this._cappingQuantizationGranularity)}else this._sc.disableCapping(t)}_regenerateCapping(t){this._cappingNeedsUpdate=!0,this.setCappingGeometryVisibility(t,this._cappingGeometryVisibility)}getCappingGeometryVisibility(){return this._cappingGeometryVisibility}_toRgb(t){return t.toFloatArray()}_toRgba(t,e){return t.toFloatArray([0,0,0,e])}setCappingFaceColor(t){if(!(t===null&&this._cappingFaceColor===null||t!==null&&this._cappingFaceColor!==null&&t.equals(this._cappingFaceColor))){t!==null?this._cappingFaceColor=t.copy():this._cappingFaceColor=null;for(const e of this._viewIndices)this._regenerateCapping(e)}}setCappingLineColor(t){if(!(t===null&&this._cappingLineColor===null||t!==null&&this._cappingLineColor!==null&&t.equals(this._cappingLineColor))){t!==null?this._cappingLineColor=t.copy():this._cappingLineColor=null;for(const e of this._viewIndices)this._regenerateCapping(e)}}async _onSessionStarted(){this.setAllowHighDpi(!0),this._sc.suspendDrawing(ke.Default),this._sc.setDrawMode(ke.Default,ar.Highlight),this._sc.setHighlightedInstanceFilter(ke.Default,Ar.Colorize),this._sc.setUnhighlightedFilter(ke.Default,Ar.None),this._sc.setHighlightMode(ke.Default,nu.VisibleWithFullOutline),this._sc.setAntiAliasingMode(ke.Default,qa.SMAA);const t=[];t.push(this._matrixCache.init()),this._regenerateCapping(ke.Default),await Promise.all(t),this._initOptions.sceneReady(),this._sc.resumeDrawing(ke.Default)}isInit(){return this._sc!==void 0}setRemoteEndpoint(t,e){this._uri=t,this._model=e}getSessionType(){return this._sessionType}_awaitEmptyLoad(){const t=mi(),e={_attached:i=>{this._callbackManager.unbind(e),i===ta.OfInitialEmptyModel?t.resolve():t.reject(new ei)}};return this._callbackManager.bind(e),t}async loadEmpty(){await this._engineReadyPromise;try{if(this._sessionType!==Xi.Uninitialized)throw new pr("Incompatible load types.");const t=this._awaitEmptyLoad();return this._connectionlessEmpty||this._buffer!==void 0||this._model===void 0?this._sessionType=this._loadEmptyScs():this._sessionType=this._loadEmptyNetwork(),t}catch(t){throw this._callbackManager.trigger("modelLoadFailure",this._model||"",t.message),t}}_loadEmpty(t){return console.assert(t.XHRonprogress===void 0),console.assert(t.XHRonerror===void 0),console.assert(t.XHRonloadend===void 0),t.XHRonprogress=e=>{this._callbackManager.trigger("XHRonprogress",e)},t.XHRonerror=e=>{this._callbackManager.trigger("XHRonerror",e)},t.XHRonloadend=(e,i,n)=>{this._callbackManager.trigger("XHRonloadend",e,i,n)},this._sc.load(t)}_loadEmptyScs(){console.assert(this._model===void 0);const t={empty:!0};return this._streamingMode===lo.OnDemand&&(t.streamInstancesOnDemand=!0),this._loadEmpty(t)}_loadEmptyNetwork(){console.assert(this._model!==void 0);const t={model:Oo,uri:this._uri,serverSideRendering:this._rendererType===ll.Server,meshLevel:this._meshLevel,streamCutoffScale:this._streamCutoffScale};switch(this._sessionToken!==void 0&&(t.sessionToken=this._sessionToken),this._memoryLimit>0&&(t.limitMiB=this._memoryLimit),(this._boundingPreviewMode&co.Model)===co.Model&&(t.streamModelBoundingPreviews=!0),(this._boundingPreviewMode&co.Instance)===co.Instance&&(t.streamInstanceBoundingPreviews=!0),(this._boundingPreviewMode&co.Ejected)===co.Ejected&&(t.streamEjectedBoundingPreviews=!0),this._streamingMode){case lo.OnDemand:t.streamInstancesOnDemand=!0;break;case lo.All:t.streamCulled=!0,t.streamMetaDataOnIdle=!0;break}return this._loadEmpty(t)}setProjection(t,e){const i=this.getCamera(t);i.getProjection()!==e&&(i.setProjection(e),this.setCamera(t,i))}getViewMatrix(t){const e=this._toCamera(ke.Default,t);return _t.createFromArray(e.viewMatrix())}getProjectionMatrix(t,e){const i=this._toCamera(e,t),n=this._windowSizes.get(e);if(n===void 0)throw new ae("Getting projection matrix of non-existent view");return _t.createFromArray(i.projectionMatrix(n.x,n.y))}getFullCameraMatrix(t,e){const i=this._toCamera(e,t),n=this._windowSizes.get(e);if(n===void 0)throw new ae("Getting full matrix of non-existent view");return _t.createFromArray(i.fullMatrix(n.x,n.y))}getPrimaryModelKey(){return this._sc.primaryModelKey()}getPartsBounding(t,e,i){return this.getBounding(t,e,!1,i)}async getDrawnPartsBounding(t,e){const i=await this._sc.MeshInstance.getDrawnWorldSpaceBounding(t,e),n=new on;return n.min.fromArray(i.min),n.max.fromArray(i.max),n}async getBounding(t,e,i,n){const r=await this._sc.MeshInstance.getWorldSpaceBounding(t,e,i,n),o=new on;return o.min.fromArray(r.min),o.max.fromArray(r.max),o}async getLooseBounding(){const t=await this._sc.getLooseBounding(),e=new on;return e.min.fromArray(t.min),e.max.fromArray(t.max),e}getClientDimensions(t){const e=this._sc.containers.get(t);return[e.clientWidth,e.clientHeight]}async getModelBounding(t,e,i){return this.getBounding([],t,e,i)}async pickFromScreen(t,e,i,n){return this._scSelectionManager.pickFromScreen(t,e,i,n)}async pickAllFromScreen(t,e,i,n){return this._scSelectionManager.pickAllFromScreen(t,e,i,n)}async compositePickFromScreen(t,e,i,n){return this._scSelectionManager.compositePickFromScreen(t,e,i,n)}async beginScreenAreaSelection(t,e,i,n){return this._scSelectionManager.beginScreenAreaSelection(t,e,i,n)}async beginRayDrillSelection(t,e,i,n){return this._scSelectionManager.beginRayDrillSelection(t,e,i,n)}async beginConvexPolyhedronSelection(t,e,i){return this._scSelectionManager.beginConvexPolyhedronSelection(t,e,i)}async beginSphereSelection(t,e,i){return this._scSelectionManager.beginSphereSelection(t,e,i)}endIncrementalSelection(t){this._scSelectionManager.endIncrementalSelection(t)}async advanceIncrementalSelection(t){return this._scSelectionManager.advanceIncrementalSelection(t,!1)}flushMetaDataCache(){this._sc.flushMetaDataCache()}async safeGetMetaDatas(t,e){const i=[];for(const n of e)i.push(t,n);try{return await this.getDataFromIds(i)}catch{return null}}async safeGetMetaData(t,e){const i=await this.safeGetMetaDatas(t,[e]);return i!==null?i[0]:null}async safeLoadMetaDatas(t){await this.getDataFromIds(t)}getDataFromIds(t){if(this._requestBatchCountByType[Mc.MetaData]===0)return this._getDataFromIds(t);const e=new fv(t);return this._pendingRequestsByType[Mc.MetaData].push(e),e.promise}_getDataFromIds(t){return this._sc.getMetaData(t)}pickFromRay(t,e){return this._scSelectionManager.pickFromRay(t,e)}pickAllFromRay(t,e){return this._scSelectionManager.pickAllFromRay(t,e)}updateCamera(t,e){const i=e._getFlags(),n=this._sc.getCamera(t);return(i&Kn.Position)===Kn.Position&&n.setPosition(this._toVector3(e.getPosition())),(i&Kn.Target)===Kn.Target&&n.setTarget(this._toVector3(e.getTarget())),(i&Kn.Up)===Kn.Up&&n.setUpVector(this._toVector3(e.getUp())),this._setCamera(t,n),this.getCamera(t)}_toProjection(t){switch(t){default:case ti.Orthographic:return rc.Orthographic;case ti.Perspective:return rc.Perspective}}_toCamera(t,e){const i=this._sc.getCamera(t);return i.reset(this._toProjection(e.getProjection()),this._toVector3(e.getPosition()),this._toVector3(e.getTarget()),this._toVector3(e.getUp()),e.getWidth(),e.getHeight()),i.setNearLimit(e.getNearLimit()),i}setCamera(t,e){const i=this._toCamera(t,e);this._setCamera(t,i)}_setCamera(t,e){this.delayCapping(),this._sc.setCamera(t,e)}markCameraAsEmpty(t){this._sc.markCameraAsEmpty(t)}setInstancesMatrix(t,e){this._sc.MeshInstance.setAnonymousMatrix(t,e.m)}setMatrices(t,e){const i=[];for(let n=0;n<e.length;n++)i.push(...e[n].m);this._sc.MeshInstance.setAnonymousMatrices(t,i)}highlightParts(t,e){this._sc.MeshInstance.setHighlighted(t,e),this._sc.MeshInstance.setXRay(t,e)}highlightElements(t,e,i,n,r){const o=this._toElementType(e);this._sc.MeshInstance.setElementHighlighted(t,o,i,n,r),this._sc.MeshInstance.setElementXRay(t,o,i,n,r)}getPartHighlighted(t){return this._sc.MeshInstance.getHighlighted(t)}getElementHighlighted(t,e,i){return this._sc.MeshInstance.getElementHighlighted(t,this._toElementType(e),i)}setNodeHighlightColor(t,e,i){let n;e?(this._sc.setHighlightedInstanceFilter(t,Ar.Colorize),n=this._toRgba(e,1),this._sc.setHiddenLineHighlightedInstanceFillColor(t,n),this._sc.setHighlightedInstanceColor(t,n)):this._sc.setHighlightedInstanceFilter(t,Ar.None),i?n=this._toRgba(i,1):n=[0,0,0,0],this._sc.setHiddenLineHighlightedInstanceOutlineColor(t,n),this._sc.setHighlightedInstanceOutlineColor(t,n)}setElementHighlightColor(t,e,i){let n;e?(this._sc.setHighlightedElementFilter(t,Ar.Colorize),n=this._toRgba(e,1),this._sc.setHighlightedElementColor(t,n),this._sc.setHiddenLineHighlightedElementFillColor(t,n)):this._sc.setHighlightedElementFilter(t,Ar.None),i?n=this._toRgba(i,1):n=[0,0,0,0],this._sc.setHighlightedElementOutlineColor(t,n),this._sc.setHiddenLineHighlightedElementOutlineColor(t,n)}setHighlightColorizeCompression(t,e){this._sc.setHighlightColorizeCompression(t,e)}async computeMinimumBodyBodyDistance(t,e){if(t.length!==2||e.length!==2)throw new ae("Invalid instance inc.");const i=await this._sc.MeshInstance.computeMinimalBodyBodyDistance(ke.Default,t,e);return du(i)}async computeMininimumFaceFaceDistance(t,e,i,n){if(t.length!==2||i.length!==2)throw new ae("Invalid instance inc.");const r=await this._sc.MeshInstance.computeMinimalFaceFaceDistance(ke.Default,t,e,i,n);return du(r)}async computeMinimumFaceRayDistance(t,e,i){if(t.length!==2)throw new ae("Invalid instance inc.");const n=uu(i),r=await this._sc.MeshInstance.computeMinimalFaceRayDistance(ke.Default,t,e,n);return du(r)}async computeMinimumFaceLineDistance(t,e,i){if(t.length!==2)throw new ae("Invalid instance inc.");const n=uu(i),r=await this._sc.MeshInstance.computeMinimalFaceLineDistance(ke.Default,t,e,n);return du(r)}pauseRendering(t,e){if(this._sc.suspendDrawing(t),typeof e=="function")try{e()}finally{this._sc.resumeDrawing(t)}}pauseAllRendering(t){for(const e of this._viewIndices)this._sc.suspendDrawing(e);if(typeof t=="function")try{t()}finally{for(const e of this._viewIndices)this._sc.resumeDrawing(e)}}resumeRendering(t){this._sc.resumeDrawing(t)}resumeAllRendering(){for(const t of this._viewIndices)this._sc.resumeDrawing(t)}beginRequestBatch(t){++this._requestBatchCountByType[t]}endRequestBatch(t){this._requestBatchCountByType[t]>0&&--this._requestBatchCountByType[t],this._flushBatchedRequests(t)}_flushBatchedRequests(t){const e=this._pendingRequestsByType[t];this._pendingRequestsByType[t]=[];const i=[];for(const n of e)for(const r of n.ids)i.push(r);switch(t){case Mc.MetaData:return this._flushBatchedMetaDataRequests(e,i);default:return console.assert(!1),Promise.resolve()}}async _flushBatchedMetaDataRequests(t,e){const i=await this._getDataFromIds(e);let n=0;for(const r of t){const o=[],l=r.ids.length/2;for(let h=0;h<l;++h){const u=i[n++];o.push(u)}r.promise.resolve(o)}console.assert(n===i.length)}clearHighlight(){this._sc.unsetAllHighlighted(),this._sc.unsetAllXRay()}resetColors(){this._sc.unsetAllColors()}resetOpacity(){this._sc.unsetAllOpacity()}setPartOpacity(t,e){this.pauseAllRendering(()=>{this._sc.MeshInstance.setOpacity(t,an.Faces,e),this._sc.MeshInstance.setOpacity(t,an.Lines,e),this._sc.MeshInstance.setOpacity(t,an.Points,e)})}unsetPartOpacity(t){this.pauseAllRendering(()=>{this._sc.MeshInstance.unsetOpacity(t,an.Faces),this._sc.MeshInstance.unsetOpacity(t,an.Lines),this._sc.MeshInstance.unsetOpacity(t,an.Points)})}getPartOpacity(t){return this._sc.MeshInstance.getOpacity(t,an.Faces)}getEffectivePartOpacity(t,e){return this._sc.MeshInstance.getEffectiveOpacity(t,this._toElementType(e))}async getPartHasTransparency(t){const e=[];e.push(this._sc.MeshInstance.hasTransparency(t,an.Faces)),e.push(this._sc.MeshInstance.hasTransparency(t,an.Lines)),e.push(this._sc.MeshInstance.hasTransparency(t,an.Points));const[i,n,r]=await Promise.all(e);for(let o=0;o<i.length;++o)i[o]||(i[o]=n[o]||r[o]);return i}setPartColor(t,e,i){this._sc.MeshInstance.setColor(t,this._toElementType(e),An.Base,i.getFloatArray())}unsetPartColor(t,e){this._sc.MeshInstance.unsetColor(t,this._toElementType(e),An.Base)}getPartColor(t,e){return this._sc.MeshInstance.getColor(t,this._toElementType(e),An.Base).then(i=>i.map(n=>n?vt.createFromFloatArray(n):null))}async getEffectivePartColor(t,e){const i=this._toElementType(e);return(await this._sc.MeshInstance.getEffectiveColor(t,i,An.Base)).map(vt.createFromFloatArray)}setPartAmbientColor(t,e,i){this._sc.MeshInstance.setColor(t,this._toElementType(e),An.Ambient,i.getFloatArray())}unsetPartAmbientColor(t,e){this._sc.MeshInstance.unsetColor(t,this._toElementType(e),An.Ambient)}getPartAmbientColor(t,e){return this._sc.MeshInstance.getColor(t,this._toElementType(e),An.Ambient).then(i=>i.map(n=>n?vt.createFromFloatArray(n):null))}getPartEffectiveAmbientColor(t,e){return this._sc.MeshInstance.getEffectiveColor(t,this._toElementType(e),An.Ambient).then(i=>i.map(n=>vt.createFromFloatArray(n)))}setPartAmbientMix(t,e,i){this._sc.MeshInstance.setAmbientMix(t,this._toElementType(e),i)}setPartEmissiveColor(t,e,i){this._sc.MeshInstance.setColor(t,this._toElementType(e),An.Emissive,i.getFloatArray())}getPartEmissiveColor(t,e){return this._sc.MeshInstance.getColor(t,this._toElementType(e),An.Emissive).then(i=>i.map(n=>n?vt.createFromFloatArray(n):null))}getPartEffectiveEmissiveColor(t,e){return this._sc.MeshInstance.getEffectiveColor(t,this._toElementType(e),An.Emissive).then(i=>i.map(n=>vt.createFromFloatArray(n)))}unsetPartEmissiveColor(t,e){this._sc.MeshInstance.unsetColor(t,this._toElementType(e),An.Emissive)}setPartSpecularColor(t,e,i){this._sc.MeshInstance.setColor(t,this._toElementType(e),An.Specular,i.getFloatArray())}getPartSpecularColor(t,e){return this._sc.MeshInstance.getColor(t,this._toElementType(e),An.Specular).then(i=>i.map(n=>n?vt.createFromFloatArray(n):null))}getPartEffectiveSpecularColor(t,e){return this._sc.MeshInstance.getEffectiveColor(t,this._toElementType(e),An.Specular).then(i=>i.map(n=>vt.createFromFloatArray(n)))}unsetPartSpecularColor(t,e){this._sc.MeshInstance.unsetColor(t,this._toElementType(e),An.Specular)}setPartSpecularIntensity(t,e,i){this._sc.MeshInstance.setSpecularIntensity(t,this._toElementType(e),i)}unsetPartSpecularIntensity(t,e){this._sc.MeshInstance.unsetSpecularIntensity(t,this._toElementType(e))}setElementColor(t,e,i,n,r){this._sc.MeshInstance.setElementColor(t,this._toElementType(e),i,n,r.getFloatArray())}unsetElementColor(t,e,i,n){this._sc.MeshInstance.unsetElementColor(t,this._toElementType(e),i,n)}getElementColor(t,e,i){return this._sc.MeshInstance.getElementColor(t,this._toElementType(e),i).then(n=>n.map(r=>r?vt.createFromFloatArray(r):null))}async getEffectiveElementColor(t,e,i,n){const r=this._toElementType(e);return(await this._sc.MeshInstance.getEffectiveElementColor(t,n,r,i)).map(vt.createFromFloatArray)}synchronizeVisibilities(t,e){t.length>0&&this._sc.MeshInstance.synchronizeVisibilities(t,e)}setPartVisibility(t,e,i){t.length>0&&this._sc.MeshInstance.setVisible(t,e,i)}setElementVisibility(t,e,i,n,r){t.length>0&&this._sc.MeshInstance.setElementVisible(t,this._toElementType(e),i,n,r)}clearElementVisibility(t,e){t.length>0&&this._sc.MeshInstance.clearElementVisible(t,this._toElementType(e))}setVisibilityByAttachment(t,e){this._sc.setVisibilityByAttachment(t,e)}requestMeshInstances(t){this._sc.demandMeshInstances(t)}getRendererType(){return this._rendererType}_toMeshDataBuilder(t){const e=t._getFaceData(),i=t._getPointData(),n=t._getPolylineData(),r=new this._sc.MeshDataBuilder;for(const d of e)r.addFace(d.vertexData,{normals:d.normalData,rgba32s:d.rgba32data,uvs:d.uvData,bits:d.bits});for(const d of i)r.addPoints(d.vertexData,{rgba32s:d.rgba32data,bits:d.bits});for(const d of n)r.addPolyline(d.vertexData,{rgba32s:d.rgba32data,bits:d.bits});let o;(d=>{d[d.None=0]="None",d[d.ClockwiseWinding=1]="ClockwiseWinding",d[d.CounterClockwiseWinding=2]="CounterClockwiseWinding",d[d.TwoSided=4]="TwoSided",d[d.Manifold=65536]="Manifold"})(o||(o={}));let l=0;switch(t.getFaceWinding()){case Rs.Clockwise:l=1;break;case Rs.CounterClockwise:l=2;break;case Rs.Unknown:default:l=0;break}const h=t.getBackfacesEnabled()?4:0,u=t.isManifold()?65536:0;return r.formatBits|=l|h|u,r}createMesh(t){const e=this._toMeshDataBuilder(t);return this._sc.MeshData.create(e)}replaceMesh(t,e){const i=this._toMeshDataBuilder(e);return this._sc.MeshData.replace(t,i)}destroyMeshes(t){return this._sc.MeshData.destroy(t)}_toImageFormat(t){switch(t){case cs.Gray8:return xo.Gray8;case cs.GrayAlpha16:return xo.GrayAlpha16;case cs.Rgb24:return xo.Rgb24;case cs.Rgba32:return xo.Rgba32;case cs.Jpeg:return xo.Jpeg;case cs.Png:return xo.Png}}_validateImage(t){if(t.format===void 0)throw new ys("missing 'format' property");if(t.data===void 0)throw new ys("missing 'data' property");if((t.format===cs.Gray8||t.format===cs.GrayAlpha16||t.format===cs.Rgb24||t.format===cs.Rgba32)&&(t.width===void 0||t.width<=0||t.height===void 0||t.height<=0))throw new ys("uncompressed format requested but missing width or height")}async _pngImageHasAlpha(t){let e;try{e=await new Promise((l,h)=>{const u=new Image;u.onload=()=>{l(u)},u.onerror=()=>{h()},u.src=`data:image/png;base64, ${rv(t)}`})}catch{return console.warn("Unable to read PNG image to check alpha component. Will be considered with alpha."),!0}const i=document.createElement("canvas"),n=i.getContext("2d");if(n===null)return console.warn("Unable to create 2d context to check alpha component. Will be considered with alpha."),!0;i.width=e.width,i.height=e.height,n.drawImage(e,0,0);const o=n.getImageData(0,0,e.width,e.height).data;for(let l=0;l<o.length;l+=4)if(o[l+3]<255)return!0;return!1}async createImage(t,e){this._validateImage(t);let i=!1;if(t.format===cs.Png&&(i=await this._pngImageHasAlpha(t.data)),e!==void 0){this._validateImage(e);let n=!1;return e.format===cs.Png&&(n=await this._pngImageHasAlpha(e.data)),this._sc.Image.create(this._toImageFormat(t.format),t.data,i,t.width,t.height,this._toImageFormat(e.format),e.data,n,e.width,e.height)}else return this._sc.Image.create(this._toImageFormat(t.format),t.data,i,t.width,t.height)}destroyImages(t){return this._sc.Image.destroy(t)}_toTextureTiling(t){switch(t){default:case Ou.Repeat:return au.Repeat;case Ou.Clamp:return au.Clamp}}_toTextureInterpolation(t){return t===!1?su.Off:su.On}_toTextureMipMapping(t){return t===!1?ru.Off:ru.On}_toTextureParameterization(t){switch(t){default:case ou.UV:return ou.UV}}_toTextureModifier(t){switch(t){default:case 0:return oc.None;case oc.Decal:return oc.Decal}}async setTexture(t,e){if(e.imageId===void 0)throw new ys("missing 'imageId' property");return this._sc.MeshInstance.setTexture(t,an.Faces,e.imageId,e.matrix!==void 0?e.matrix.m:new _t().m,this._toTextureTiling(e.tiling),this._toTextureInterpolation(e.interpolation),this._toTextureMipMapping(e.mipMapping),this._toTextureParameterization(e.parameterization),this._toTextureModifier(e.modifiers))}unsetTexture(t){this._sc.MeshInstance.unsetTexture(t,an.Faces)}createMatrix(t){return this._sc.Matrix.create(t)}createIdentityMatrix(){return this._sc.Matrix.create()}async createMeshInstance(t){const e=t.getMeshId();if(e===null)throw new ae("MeshId is not set");let i=this._matrixCache.getIdentityInc();const n=[],r=t.getMatrix();if(r){const g=this.createMatrix(r.m).then(y=>{i=y});n.push(g)}const o=new vt(255,0,0),l=this._toRgba(t.getFaceColor()||o,t.getOpacity()),h=this._toRgba(t.getLineColor()||o,t.getLineOpacity()),u=this._toRgba(t.getPointColor()||o,t.getPointOpacity());await Promise.all(n);const d=await this._sc.MeshInstance.create(e,i,l,h,u,t.getCreationFlags(),t.overlayId.overayIndex,t.overlayId.viewKey);return this._callbackManager.trigger("_geometryCreated",d),d}destroyLocalInstances(t){return this._sc.MeshInstance.destroy(t)}_fromScCamera(t){let e=ti.Orthographic;return t.projection()===ti.Perspective&&(e=ti.Perspective),dn.create(_.createFromArray(t.position()),_.createFromArray(t.target()),_.createFromArray(t.upVector()),e,t.fieldWidth(),t.fieldHeight(),t.nearLimit())}async getCameraPromise(t){const e=await this._sc.getCameraPromise(t);return this._fromScCamera(e)}getCamera(t){const e=this._sc.getCamera(t);return this._fromScCamera(e)}resize(t){t===void 0&&(t=ke.Default);let e=1;this.getAllowHighDpi()&&(e=window.devicePixelRatio||1);const i=this._canvases.get(t),n=this._canvasContainers.get(t);i.width=n.clientWidth*e,i.height=n.clientHeight*e;const r=this._windowSizes.get(t);r===void 0?this._windowSizes.set(t,new K(n.offsetWidth,n.offsetHeight)):r.set(n.offsetWidth,n.offsetHeight),this._resizeRenderCanvas(),this._sc.onResize(t)}_resizeRenderCanvas(){const t=this._sc.canvas;let e=0,i=0;this._canvases.forEach(n=>{e=Math.max(e,n.width),i=Math.max(i,n.height)}),t.width=e,t.height=i}setFaceVisibility(t,e){this._sc.setFacesVisible(t,e)}setLineVisibility(t,e){this._sc.setLinesVisible(t,e)}getCanvasSize(t){const e=this._windowSizes.get(t);return e===void 0?K.zero():e.copy()}setBackgroundGradient(t,e,i){this._sc.setBackgroundGradient(t,e?this._toRgba(e,1):[0,0,0,0],i?this._toRgba(i,1):[0,0,0,0])}setBoundingPreviewUnderDrawColor(t,e){this._sc.setBoundingPreviewUnderdrawColor(e,this._toRgba(t,.7))}setBoundingPreviewTestedColor(t,e){this._sc.setBoundingPreviewTestedColor(e,this._toRgba(t,.7))}setBoundingPreviewEjectedColor(t,e){this._sc.setBoundingPreviewEjectedColor(e,this._toRgba(t,.7))}setBoundingPreviewUnderDraw(t,e){this._sc.setBoundingPreviewUnderdraw(t.reduce((i,n)=>(i.push(this._toVector3(n.min),this._toVector3(n.max)),i),[]),e)}setBoundingDebugLevel(t,e){this._sc.setBoundingDebugLevel(e,t)}setBoundingPreviewTested(t,e){this._sc.setBoundingPreviewTested(t.reduce((i,n)=>(i.push(this._toVector3(n.min),this._toVector3(n.max)),i),[]),e)}setBoundingPreviewEjected(t,e){this._sc.setBoundingPreviewEjected(t.reduce((i,n)=>(i.push(this._toVector3(n.min),this._toVector3(n.max)),i),[]),e)}setServerRenderQuality(t,e,i,n){this._sc.setSsrQuality({jpegQualityLow:t,jpegQualityHigh:e,scaleLow:i,scaleHigh:n})}setMinimumFramerate(t,e){this._sc.setMinFrameRate(t,e)}getMinimumFramerate(t){return this._sc.getMinFrameRate(t)}setBackFacesVisible(t,e){this._sc.setBackFacesVisible(t,e)}setDrawMode(t,e){this._sc.setDrawMode(t,e)}enableHiddenLineRendering(t,e){this.setDrawMode(t,ar.HiddenLine),this._sc.setHiddenLineVisibleLineColor(t,this._toRgba(e.getVisibleLineColor(),e.getVisibleLineOpacity())),this._sc.setHiddenLineHiddenLineColor(t,this._toRgba(e.getObscuredLineColor(),e.getObscuredLineOpacity()))}setAntiAliasingMode(t,e){const i=e==Au.SMAA?qa.SMAA:qa.None;this._sc.setAntiAliasingMode(t,i)}setInstanceModifier(t,e,i){switch(t){case $i.DoNotCut:this._sc.MeshInstance.setDoNotCut(e,i);break;case $i.DoNotExplode:this._sc.MeshInstance.setDoNotExplode(e,i);break;case $i.DoNotSelect:this._sc.MeshInstance.setDoNotSelect(e,i);break;case $i.SuppressCameraScale:this._sc.MeshInstance.setSuppressCameraScale(e,i);break;case $i.OverrideSceneVisibility:this._sc.MeshInstance.setOverrideSceneVisibility(e,i);break;case $i.DoNotLight:this._sc.MeshInstance.setDoNotLight(e,i);break;case $i.DoNotOutlineHighlight:this._sc.MeshInstance.setDoNotOutlineHighlight(e,i);break;case $i.ExcludeBounding:this._sc.MeshInstance.setExcludeBounding(e,i);break;case $i.DoNotUseVertexColors:this._sc.MeshInstance.setDoNotUseVertexColors(e,i);break;case $i.AlwaysDraw:this._sc.MeshInstance.setAlwaysDraw(e,i);break;case $i.DoNotXRay:this._sc.MeshInstance.setDoNotXRay(e,i);break;case $i.ScreenOriented:this._sc.MeshInstance.setScreenOriented(e,i);break;case $i.ScreenSpace:this._sc.MeshInstance.setScreenSpace(e,i);break;case $i.ScreenSpaceStretched:this._sc.MeshInstance.setScreenSpaceStretched(e,i);break}}attachModel(t,e,i,n,r){const o=[e,i];return this._attachModels(t,[o],n,r)}attachScsModelByKey(t,e,i,n,r){return console.assert(this._sessionType===Xi.Scs),this._sc.attachScsModelByKey(t,i,e,n,r)}async _attachModels(t,e,i,n){await this._sc.attachModels(t,e,i,n),this._callbackManager.trigger("_attached",t)}async attachScsBuffer(t,e,i,n,r,o,l){await this._sc.attachScsBuffer(t,e,i,n,r,o,l),this._callbackManager.trigger("_attached",t)}feedScsBuffer(t,e){this._sc.feedScsBuffer(t,e)}_parseKeyInfo(t,e,i){if(t||e)return i;const n=new Map;for(let r=0;r<i.length;++r){const o=i[r++],l=[];for(;r<i.length&&i[r]!==fs.Invalid;++r)l.push(i[r]);n.set(o,l)}return n}async instanceKeyInfo(t,e,i){const n=e===wu.Model,r=i===vu.KeyCountOnly,o=await this._sc.meshInstanceKeyInfo(t,n,r);return this._parseKeyInfo(n,r,o)}async metaDataKeyInfo(t,e,i){const n=await this._sc.metaDataKeyInfo(t,e,i);return this._parseKeyInfo(e,i,n)}modelKeysFromInclusionKeys(t){return this._sc.modelKeysFromInclusionKeys(t)}detachInclusions(t){return this._sc.detachInclusions(t)}async resetToEmpty(t,e){for(let i=0;i<this._requestBatchCountByType.length;++i){this._requestBatchCountByType[i]=0;for(const n of this._pendingRequestsByType[i])n.promise.reject(n.ids);this._pendingRequestsByType[i].length=0}await this._sc.resetToEmpty(t,e),this.flushMetaDataCache()}setDrawStrategy(t,e){console.warn("This API has been deactivated for lack of stability it is recommended not to use it"),this._sc.setDrawStrategy(t,e)}redraw(t){this._sc.queueRedraw(t)}disconnectNetwork(){this._sc.disconnectNetwork()}shutdown(){this._cappingDelayTimeoutId!==null&&(clearTimeout(this._cappingDelayTimeoutId),this._cappingDelayTimeoutId=null),this._sessionType=Xi.Uninitialized,this._sc.shutDown()}getVersionString(){return this._sc.getStreamVersion().toString()}setAllowHighDpi(t){this._sc.allowHighDpi=t,this.resize()}getAllowHighDpi(){return this._sc.allowHighDpi}setMeshLevel(t,e){this._sc.MeshInstance.setMeshLevel(t,e)}setMetallicRoughness(t,e,i){this._sc.MeshInstance.setMetallicRoughness(t,e,i)}setMetallicRoughnessMaterialOverride(t,e){this._sc.setMetallicRoughnessMaterialOverride(t,e)}async getMetallicRoughness(t){const e=await this._sc.MeshInstance.getMetallicRoughness(t),i=[];for(let n=0;n<e.length;n+=2){if(e[n]<0||e[n+1]<0){i.push(null);continue}i.push({metallic:e[n],roughness:e[n+1]})}return i}unsetMetallicRoughness(t){this._sc.MeshInstance.unsetMetallicRoughness(t)}setOverlayVisibility(t,e,i){this._sc.Overlay.setVisible(i,t,e)}setOverlayCamera(t,e,i){const n=this._toCamera(i,e);this._sc.Overlay.setCamera(i,t,n)}destroyOverlay(t,e){this._sc.Overlay.destroy(e,t)}_overlayUnit(t){switch(t){case De.ProportionOfCanvas:return Ka.ProportionOfScreen;case De.MinimumProportionOfCanvas:return Ka.MinimumProportionOfScreen;case De.ProportionOfOtherDimension:return Ka.ProportionOfOtherDimension;default:return Ka.Pixels}}getMaxOverlayIndex(){return this._sc.Overlay.maxIndex()}_overlayAnchor(t){switch(t){case je.BottomCenter:return lr.BottomCenter;case je.Center:return lr.Center;case je.LeftCenter:return lr.LeftCenter;case je.LowerLeftCorner:return lr.LowerLeftCorner;case je.LowerRightCorner:return lr.LowerRightCorner;case je.RightCenter:return lr.RightCenter;case je.TopCenter:return lr.TopCenter;case je.UpperRightCorner:return lr.UpperRightCorner;default:return lr.UpperLeftCorner}}setOverlayViewport(t,e,i,n,r,o,l,h,u,d,g){this._sc.Overlay.setViewport(g,t,this._overlayAnchor(e),i,this._overlayUnit(n),r,this._overlayUnit(o),l,this._overlayUnit(h),u,this._overlayUnit(d))}addNodesToOverlay(t,e,i){this._sc.MeshInstance.setOverlayId(t,e,i)}getInstancesMeshData(t){return this._sc.MeshInstance.getMeshData(t)}getInstancesCappingMeshData(t){return this._sc.MeshInstance.getCappingMeshData(t)}getMeshData(t){return this._sc.MeshData.getData(t)}_toElementType(t){switch(t){case Yt.Faces:return an.Faces;case Yt.Lines:return an.Lines;case Yt.Points:return an.Points}}_toXRayGroup(t){switch(t){case dl.Selected:return lu.Selected;case dl.Unselected:return lu.Unselected}}setXRayColor(t,e,i,n){this._sc.setXRayMaterial(t,this._toXRayGroup(e),this._toElementType(i),this._toRgba(n,1))}unsetXRayColor(t,e,i){return this._sc.unsetXRayMaterial(t,this._toXRayGroup(e),this._toElementType(i))}setXRayOpacity(t,e,i){i!==void 0?this._sc.setXRayOpacity(t,this._toElementType(i),e):(this._sc.setXRayOpacity(t,an.Faces,e),this._sc.setXRayOpacity(t,an.Lines,e),this._sc.setXRayOpacity(t,an.Points,e))}setXRayTransparencyMode(t,e){this._sc.setXRayTransparencyMode(t,e)}setGoochBlue(t,e){this._sc.setGoochBlue(t,e)}setGoochBaseColorProminence(t,e){this._sc.setGoochBaseColorProminence(t,e)}setGoochYellow(t,e){this._sc.setGoochYellow(t,e)}setGoochLuminanceShiftStrength(t,e){this._sc.setGoochLuminanceShiftStrength(t,e)}setToonShadingBandCount(t,e){this._sc.setToonBandCount(t,e)}setToonShadingSpecularFactor(t,e){this._sc.setToonSpecularFactor(t,e)}setTransparencyMode(t,e){this._sc.setTransparencyMode(t,e)}setPointSize(t,e,i){this._sc.setPointSize(t,e,i)}async getPointSize(t){const e=await Promise.all([this._sc.getPointSize(t),this._sc.getPointSizeUnit(t)]);return[e[0],e[1]]}setPointShape(t,e){this._sc.setPointShape(t,e)}async getPointShape(t){return await this._sc.getPointShape(t)}setEyeDomeLightingEnabled(t,e){this._sc.setEyeDomeLightingEnabled(t,e)}getEyeDomeLightingEnabled(t){return this._sc.getEyeDomeLightingEnabled(t)}setEyeDomeLightingBlurSamples(t,e){this._sc.setEyeDomeLightingBlurSamples(t,e)}getEyeDomeLightingBlurSamples(t){return this._sc.getEyeDomeLightingBlurSamples(t)}setEyeDomeLightingBlurInterval(t,e){this._sc.setEyeDomeLightingBlurInterval(t,e)}getEyeDomeLightingBlurInterval(t){return this._sc.getEyeDomeLightingBlurInterval(t)}setEyeDomeLightingBlurEdgeDistance(t,e){this._sc.setEyeDomeLightingBlurEdgeDistance(t,e)}getEyeDomeLightingBlurEdgeDistance(t){return this._sc.getEyeDomeLightingBlurEdgeDistance(t)}setEyeDomeLightingShadingEdgeDistance(t,e){this._sc.setEyeDomeLightingShadingEdgeDistance(t,e)}getEyeDomeLightingShadingEdgeDistance(t){return this._sc.getEyeDomeLightingShadingEdgeDistance(t)}setEyeDomeLightingOpacity(t,e){this._sc.setEyeDomeLightingOpacity(t,e)}getEyeDomeLightingOpacity(t){return this._sc.getEyeDomeLightingOpacity(t)}setDisplayIncompleteFrames(t,e){this._sc.setDisplayIncompleteFrames(e,t)}setInteractiveDrawDelay(t,e){this._sc.setPostInputDelay(e,t)}setInteractiveDrawLimitIncreaseEnabled(t,e){this._sc.setInteractiveDrawLimitIncreaseEnabled(e,t)}getInteractiveDrawLimitIncreaseEnabled(t){return this._sc.getInteractiveDrawLimitIncreaseEnabled(t)}setCullingVector(t,e,i,n){this._sc.MeshInstance.setCullingVector(t,e,[i.x,i.y,i.z],n)}unsetCullingVector(t){this._sc.MeshInstance.unsetCullingVector(t)}async getCullingVector(t){const e=await this._sc.MeshInstance.getCullingVector(t),i=[];for(const n of e)n.vector[0]===0&&n.vector[1]===0&&n.vector[2]===0?i.push(null):i.push({space:n.space,vector:_.createFromArray(n.vector),toleranceDegrees:n.toleranceDegrees});return i}_setStreamCutoffScale(t){this._streamCutoffScale=Math.max(0,Math.min(t,2))}setStreamCutoffScale(t){this._setStreamCutoffScale(t),this._sc.setStreamCutoffScale(this._streamCutoffScale)}getStreamCutoffScale(){return this._streamCutoffScale}loseWebGlContext(){return this._sc._loseWebGlContext()}triangulatePolygon(t,e){const i=this._sc.triangulatePolygon(t,e);return new Float32Array(i)}debug_log(t){return this._sc.debug_log(t)}debug_stateFailure(t){return this._sc.debug_stateFailure(t)}debug_sync(){return this._sc.debug_sync()}setLinePattern(t,e,i,n){this._sc.MeshInstance.setLinePattern(t,e,i,n)}unsetLinePattern(t){this._sc.MeshInstance.unsetLinePattern(t)}async createFloorplanMesh(t){return this._sc.createFloorplanMesh(t)}async exportToSvg(t){return(await this._sc.exportToSvg(t)).map(n=>String.fromCharCode(n)).join("")}async beginExportToSvg(t){return this._sc.beginExportToSvg(t)}async advanceExportToSvg(){const t=await this._sc.advanceExportToSvg();if(t.length!==0)return t.reduce((e,i)=>{const n=String.fromCharCode(i);switch(n){case`
`:return e;case"'":return`${e}"`;default:return`${e}${n}`}},"")}waitForImageDecoding(){return this._sc.waitForImageDecoding()}registerBimInstances(t,e){return this._sc.registerBimInstances(t,e)}setAmbientLightColor(t,e){this._sc.setAmbientLightColor(t,this._toRgb(e))}getLightKeys(t){return this._sc.getLightKeys(t)}async getLight(t,e){try{const i=await this._sc.getLight(t,e);switch(i.type.value){case iu.Point:const r=i;return new ly(i.type.value,i.space.value,new _(...i.position),vt.createFromFloatArray(i.color),r.power,r.decay);case iu.Directional:return new ay(i.type.value,i.space.value,new _(...i.position),vt.createFromFloatArray(i.color));default:console.error(`No light of type ${i.type} could be instanciated.`);return}}catch{return}}clearLights(t){this._sc.clearLights(t)}addLight(t,e){return this._sc.addLight(t,e.type,e.space,this._toVector3(e.position),this._toRgb(e.color))}async addPointLight(t,e){const i=await this._sc.addLight(t,e.type,e.space,this._toVector3(e.position),this._toRgb(e.color));return this._sc.setLightPower(t,i,e.power),this._sc.setLightDecay(t,i,e.decay),i}removeLight(t,e){this._sc.removeLight(t,e)}updateLight(t,e,i){this._sc.updateLight(t,e,i.type,i.space,this._toVector3(i.position),this._toRgb(i.color))}setBloomEnabled(t,e){this._sc.setBloomEnabled(t,e)}setBloomThreshold(t,e){this._sc.setBloomThreshold(t,e)}setBloomThresholdRampWidth(t,e){this._sc.setBloomThresholdRampWidth(t,e)}setBloomIntensityScale(t,e){this._sc.setBloomIntensityScale(t,e)}_toBlurIntervalUnit(t){switch(t){default:case Ls.Pixels:return sc.Pixels;case Ls.ProportionOfWidth:return sc.ProportionOfWidth;case Ls.ProportionOfHeight:return sc.ProportionOfHeight}}setBloomLayers(t,e){for(const i of e)if(i.blurInterval!==void 0&&i.blurInterval.length!==2)throw new ae("'blurInterval' must be an array containing a number followed by a BlurIntervalUnit");this._sc.suspendDrawing(t),this._sc.setBloomLayerCount(t,e.length);for(let i=0;i<e.length;++i){const n=e[i];n.intensity!==void 0&&this._sc.setBloomIntensity(t,i,n.intensity),n.blurSamples!==void 0&&this._sc.setBloomBlurSamples(t,i,n.blurSamples),n.blurInterval!==void 0&&this._sc.setBloomBlurInterval(t,i,n.blurInterval[0],this._toBlurIntervalUnit(n.blurInterval[1]))}this._sc.resumeDrawing(t)}startComparison(t,e,i,n){const r=n!=null&&n.sameColor?this._toRgb(n.sameColor):[0,0,0],o=n!=null&&n.only1Color?this._toRgb(n.only1Color):[1,0,0],l=n!=null&&n.only2Color?this._toRgb(n.only2Color):[0,1,0];this._sc.setComparisonColors(t,r,o,l),this._sc.startComparison(t,e,i)}endComparison(t){this._sc.endComparison(t)}setSimpleShadowColor(t,e){this._sc.setSimpleShadowColor(t,this._toRgb(e))}setSimpleShadowEnabled(t,e){this._sc.setSimpleShadowEnabled(t,e)}setSimpleShadowOpacity(t,e){this._sc.setSimpleShadowOpacity(t,e)}setGroundPlane(t,e,i){i!==void 0?this._sc.setGroundPlaneWithPosition(t,this._toVector3(e),this._toVector3(i)):this._sc.setGroundPlane(t,this._toVector3(e))}setSimpleShadowResolution(t,e){this._sc.setSimpleShadowResolution(t,e)}setSimpleShadowBlurSamples(t,e){this._sc.setSimpleShadowBlurSamples(t,e)}setSimpleShadowBlurInterval(t,e){this._sc.setSimpleShadowBlurInterval(t,e)}setSimpleShadowInteractiveUpdateEnabled(t,e=!0){this._sc.setSimpleShadowInteractiveUpdateEnabled(t,e)}setSilhouetteColor(t,e){this._sc.setSilhouetteColor(t,this._toRgb(e))}setSilhouetteEnabled(t,e=!0){this._sc.setSilhouetteEnabled(t,e)}setSilhouetteOpacity(t,e){this._sc.setSilhouetteOpacity(t,e)}setSilhouetteThreshold(t,e){this._sc.setSilhouetteThreshold(t,e)}setSilhouetteThresholdRampWidth(t,e){this._sc.setSilhouetteThresholdRampWidth(t,e)}setHardEdgeColor(t,e){this._sc.setHardEdgeColor(t,this._toRgb(e))}setHardEdgesEnabled(t,e=!0){this._sc.setHardEdgesEnabled(t,e)}setHardEdgeOpacity(t,e){this._sc.setHardEdgeOpacity(t,e)}setHardEdgeThreshold(t,e){this._sc.setHardEdgeThreshold(t,e)}setHardEdgeThresholdRampWidth(t,e){this._sc.setHardEdgeThresholdRampWidth(t,e)}setSimpleReflectionEnabled(t,e=!0){this._sc.setSimpleReflectionEnabled(t,e)}setSimpleReflectionBlurInterval(t,e,i){this._sc.setSimpleReflectionBlurInterval(t,e,this._toBlurIntervalUnit(i))}setSimpleReflectionBlurSamples(t,e){this._sc.setSimpleReflectionBlurSamples(t,e)}setSimpleReflectionFadeAngle(t,e){this._sc.setSimpleReflectionFadeAngle(t,e)}setSimpleReflectionOpacity(t,e){this._sc.setSimpleReflectionOpacity(t,e)}setSimpleReflectionAttenuation(t,e,i,n=af.World){this._sc.setSimpleReflectionAttenuation(t,e,i,n)}throttleLoad(t,e){this._sc.throttleLoad(t,e)}_toVector3Array(t){const e=[];for(const i of t)e.push([i.x,i.y,i.z]);return e}testPointVisibility(t,e){return this._sc.testPointVisibility(this._toVector3Array(e),t)}setPointVisibilityTest(t,e){this._sc.setPointVisibilityTest(this._toVector3Array(e),t)}setImageBasedLightingEnabled(t,e){this._sc.setImageBasedLightingEnabled(t,e)}setImageBasedLightingIntensity(t,e){this._sc.setImageBasedLightingIntensity(t,e)}_toMatrix9(t){return[t.m[0],t.m[1],t.m[2],t.m[4],t.m[5],t.m[6],t.m[8],t.m[9],t.m[10]]}setImageBasedLightingMatrix(t,e){this._sc.setImageBasedLightingMatrix(t,this._toMatrix9(e))}setImageBasedLightingEnvironment(t,e){this._sc.setImageBasedLightingEnvironment(t,e)}setImageBasedLightingEnvironmentToDefault(t){this._sc.setImageBasedLightingEnvironmentToDefault(t)}setLineJitterEnabled(t,e){this._sc.setLineJitterEnabled(t,e)}setLineJitterInstanceCount(t,e){this._sc.setLineJitterInstanceCount(t,e)}setLineJitterRadius(t,e){this._sc.setLineJitterRadius(t,e)}setLineJitterFrequency(t,e){this._sc.setLineJitterFrequency(t,e)}}const AI=()=>new window.XMLHttpRequest;function TI(s,t){let e,i,n,r;t||(t={}),typeof t=="function"?(r=t,t={}):typeof t.callback=="function"&&(r=t.callback),!r&&typeof Promise<"u"?e=new Promise(function(o,l){i=o,n=l}):(i=function(o){r(null,o)},n=function(o){r(o,null)});try{const o=AI();if(o.open("GET",s,!0),"responseType"in o&&(o.responseType="arraybuffer"),o.overrideMimeType&&o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(o.readyState===4)if(o.status===200||o.status===0)try{i(o.response??o.responseText)}catch(l){n(l)}else n(new Error("Ajax error for "+s+" : "+this.status+" "+this.statusText))},t.progress){const l=t.progress;o.onprogress=function(h){l({path:s,originalEvent:h,percent:h.loaded/h.total*100,loaded:h.loaded,total:h.total})}}o.send()}catch(o){n(o,null)}return e}class NI{constructor(t){this._id=0,this._bcfMap=new Map,this._viewer=t}_getId(){return++this._id}getBCFMap(){return this._bcfMap}getBCFData(t){return this._bcfMap.get(t)||null}removeBCFData(t){this._bcfMap.delete(t),this._viewer.trigger("bcfRemoved",t)}createBCFData(t){const e=this._getId(),i=new Uu(t,e);return this._bcfMap.set(e,i),this._viewer.trigger("bcfLoaded",i.getId(),i.getFilename()),i}async addBCFFromFile(t){const e=this._getId(),i=new Uu(t,e);this._bcfMap.set(e,i);const n=await new Km.external.Promise((r,o)=>{TI(t,(l,h)=>{l?o(l):r(h)})});await this._loadBCFData(n,i)}async addBCFFromBuffer(t,e){const i=this._getId(),n=new Uu(e,i);this._bcfMap.set(i,n),await this._loadBCFData(t,n)}async _getVersion(t){const e=t.file("bcf.version");if(e===null)return Ys.v1_0;{const r=(await this._getDocument(e)).documentElement.firstElementChild;if(r!=null&&r.textContent)switch(r.textContent){case"2.0 RC":return Ys.v2_0;case"2.1":return Ys.v2_1}return Ys.Unknown}}async _loadBCFData(t,e){const i=this._viewer.model,n=await i.getModelBounding(!0,!1),r=i.getNodeUnitMultiplier(i.getAbsoluteRootNode()),o=e.getId(),l=e.getFilename(),h=await Vf.loadAsync(t);e.setVersion(await this._getVersion(h));const u=[];h.forEach(async d=>{const g=mi();u.push(g);const y=this._getFileType(d);if(y===Qn.Markup||y===Qn.Snapshot||y===Qn.Viewpoint){const m=d.split("/"),I=m[0],b=m[1];let x=e.getTopic(I);if(x===null&&(x=new $u(o,l,I,this._viewer),e.addTopic(I,x)),b.length){const C=h.file(d);if(C!==null)switch(y){case Qn.Markup:x.addMarkup(b,await this._getDocument(C));break;case Qn.Viewpoint:x.addViewpoint(b,await this._getDocument(C),e.getVersion(),n,r);break;case Qn.Snapshot:x.addSnapshot(b,await C.async("uint8array"));break}}}g.resolve()}),await Ue(u),this._viewer.trigger("bcfLoaded",o,l)}async _getDocument(t){return new DOMParser().parseFromString(await t.async("text"),"application/xml")}_getFileType(t){if(t.slice(-1)==="/")return Qn.TopicFolder;const e=t.split(".");switch(console.assert(e.length===2),e[1]){case"bcf":return Qn.Markup;case"bcfv":return Qn.Viewpoint;case"png":return Qn.Snapshot;case"version":return Qn.Version;case"xsd":return Qn.Schema;case"bcfp":return Qn.Project}return Qn.Unknown}}class DI{constructor(){this._activeInterpolation=null,this._updateTimer=new Mo,this._updateInterval=16}stop(){this._activeInterpolation&&this._activeInterpolation.stop(),this._activeInterpolation=null,this._updateTimer.clear()}start(t,e=!0){return this._activeInterpolation&&!e?!1:(this.stop(),this._activeInterpolation=t,this._activeInterpolation.start(),this.update(),!0)}update(){if(this._activeInterpolation)if(this._activeInterpolation.update(),this._activeInterpolation.isComplete()){const t=this._activeInterpolation.getCallback();t!==null&&t()}else this._updateTimer.isIdle(Tn.BeforeAction)&&this._updateTimer.set(this._updateInterval,()=>{this.update()})}}var hd={exports:{}},uh={exports:{}};(function(){var s,t,e,i,n,r;typeof performance<"u"&&performance!==null&&performance.now?uh.exports=function(){return performance.now()}:typeof process<"u"&&process!==null&&process.hrtime?(uh.exports=function(){return(s()-n)/1e6},t=process.hrtime,s=function(){var o;return o=t(),o[0]*1e9+o[1]},i=s(),r=process.uptime()*1e9,n=i-r):Date.now?(uh.exports=function(){return Date.now()-e},e=Date.now()):(uh.exports=function(){return new Date().getTime()-e},e=new Date().getTime())}).call(ia);for(var OI=uh.exports,RI=OI,go=typeof window>"u"?ia:window,ud=["moz","webkit"],Dl="AnimationFrame",Ol=go["request"+Dl],dh=go["cancel"+Dl]||go["cancelRequest"+Dl],fh=0;!Ol&&fh<ud.length;fh++)Ol=go[ud[fh]+"Request"+Dl],dh=go[ud[fh]+"Cancel"+Dl]||go[ud[fh]+"CancelRequest"+Dl];if(!Ol||!dh){var bg=0,Sy=0,Ca=[],LI=1e3/60;Ol=function(s){if(Ca.length===0){var t=RI(),e=Math.max(0,LI-(t-bg));bg=e+t,setTimeout(function(){var i=Ca.slice(0);Ca.length=0;for(var n=0;n<i.length;n++)if(!i[n].cancelled)try{i[n].callback(bg)}catch(r){setTimeout(function(){throw r},0)}},Math.round(e))}return Ca.push({handle:++Sy,callback:s,cancelled:!1}),Sy},dh=function(s){for(var t=0;t<Ca.length;t++)Ca[t].handle===s&&(Ca[t].cancelled=!0)}}hd.exports=function(s){return Ol.call(go,s)},hd.exports.cancel=function(){dh.apply(go,arguments)},hd.exports.polyfill=function(s){s||(s=go),s.requestAnimationFrame=Ol,s.cancelAnimationFrame=dh};var FI=hd.exports;const Ig=cu(FI);var BI=function(s){this.ok=!1,this.alpha=1,s.charAt(0)=="#"&&(s=s.substr(1,6)),s=s.replace(/ /g,""),s=s.toLowerCase();var t={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};s=t[s]||s;for(var e=[{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*((?:\d?\.)?\d)\)$/,example:["rgba(123, 234, 45, 0.8)","rgba(255,234,245,1.0)"],process:function(h){return[parseInt(h[1]),parseInt(h[2]),parseInt(h[3]),parseFloat(h[4])]}},{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(h){return[parseInt(h[1]),parseInt(h[2]),parseInt(h[3])]}},{re:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,example:["#00ff00","336699"],process:function(h){return[parseInt(h[1],16),parseInt(h[2],16),parseInt(h[3],16)]}},{re:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,example:["#fb0","f0f"],process:function(h){return[parseInt(h[1]+h[1],16),parseInt(h[2]+h[2],16),parseInt(h[3]+h[3],16)]}}],i=0;i<e.length;i++){var n=e[i].re,r=e[i].process,o=n.exec(s);if(o){var l=r(o);this.r=l[0],this.g=l[1],this.b=l[2],l.length>3&&(this.alpha=l[3]),this.ok=!0}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.alpha=this.alpha<0?0:this.alpha>1||isNaN(this.alpha)?1:this.alpha,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toRGBA=function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.alpha+")"},this.toHex=function(){var h=this.r.toString(16),u=this.g.toString(16),d=this.b.toString(16);return h.length==1&&(h="0"+h),u.length==1&&(u="0"+u),d.length==1&&(d="0"+d),"#"+h+u+d},this.getHelpXML=function(){for(var h=new Array,u=0;u<e.length;u++)for(var d=e[u].example,g=0;g<d.length;g++)h[h.length]=d[g];for(var y in t)h[h.length]=y;var m=document.createElement("ul");m.setAttribute("id","rgbcolor-examples");for(var u=0;u<h.length;u++)try{var I=document.createElement("li"),b=new RGBColor(h[u]),x=document.createElement("div");x.style.cssText="margin: 3px; border: 1px solid black; background:"+b.toHex()+"; color:"+b.toHex(),x.appendChild(document.createTextNode("test"));var C=document.createTextNode(" "+h[u]+" -> "+b.toRGB()+" -> "+b.toHex());I.appendChild(x),I.appendChild(C),m.appendChild(I)}catch{}return m}};const xg=cu(BI);/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */var Py=function(s,t){return(Py=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])})(s,t)};function ky(s,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function e(){this.constructor=s}Py(s,t),s.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function VI(s){var t="";Array.isArray(s)||(s=[s]);for(var e=0;e<s.length;e++){var i=s[e];if(i.type===At.CLOSE_PATH)t+="z";else if(i.type===At.HORIZ_LINE_TO)t+=(i.relative?"h":"H")+i.x;else if(i.type===At.VERT_LINE_TO)t+=(i.relative?"v":"V")+i.y;else if(i.type===At.MOVE_TO)t+=(i.relative?"m":"M")+i.x+" "+i.y;else if(i.type===At.LINE_TO)t+=(i.relative?"l":"L")+i.x+" "+i.y;else if(i.type===At.CURVE_TO)t+=(i.relative?"c":"C")+i.x1+" "+i.y1+" "+i.x2+" "+i.y2+" "+i.x+" "+i.y;else if(i.type===At.SMOOTH_CURVE_TO)t+=(i.relative?"s":"S")+i.x2+" "+i.y2+" "+i.x+" "+i.y;else if(i.type===At.QUAD_TO)t+=(i.relative?"q":"Q")+i.x1+" "+i.y1+" "+i.x+" "+i.y;else if(i.type===At.SMOOTH_QUAD_TO)t+=(i.relative?"t":"T")+i.x+" "+i.y;else{if(i.type!==At.ARC)throw new Error('Unexpected command type "'+i.type+'" at index '+e+".");t+=(i.relative?"a":"A")+i.rX+" "+i.rY+" "+i.xRot+" "+ +i.lArcFlag+" "+ +i.sweepFlag+" "+i.x+" "+i.y}}return t}function Cg(s,t){var e=s[0],i=s[1];return[e*Math.cos(t)-i*Math.sin(t),e*Math.sin(t)+i*Math.cos(t)]}function _r(){for(var s=[],t=0;t<arguments.length;t++)s[t]=arguments[t];for(var e=0;e<s.length;e++)if(typeof s[e]!="number")throw new Error("assertNumbers arguments["+e+"] is not a number. "+typeof s[e]+" == typeof "+s[e]);return!0}var zo=Math.PI;function Sg(s,t,e){s.lArcFlag=s.lArcFlag===0?0:1,s.sweepFlag=s.sweepFlag===0?0:1;var i=s.rX,n=s.rY,r=s.x,o=s.y;i=Math.abs(s.rX),n=Math.abs(s.rY);var l=Cg([(t-r)/2,(e-o)/2],-s.xRot/180*zo),h=l[0],u=l[1],d=Math.pow(h,2)/Math.pow(i,2)+Math.pow(u,2)/Math.pow(n,2);1<d&&(i*=Math.sqrt(d),n*=Math.sqrt(d)),s.rX=i,s.rY=n;var g=Math.pow(i,2)*Math.pow(u,2)+Math.pow(n,2)*Math.pow(h,2),y=(s.lArcFlag!==s.sweepFlag?1:-1)*Math.sqrt(Math.max(0,(Math.pow(i,2)*Math.pow(n,2)-g)/g)),m=i*u/n*y,I=-n*h/i*y,b=Cg([m,I],s.xRot/180*zo);s.cX=b[0]+(t+r)/2,s.cY=b[1]+(e+o)/2,s.phi1=Math.atan2((u-I)/n,(h-m)/i),s.phi2=Math.atan2((-u-I)/n,(-h-m)/i),s.sweepFlag===0&&s.phi2>s.phi1&&(s.phi2-=2*zo),s.sweepFlag===1&&s.phi2<s.phi1&&(s.phi2+=2*zo),s.phi1*=180/zo,s.phi2*=180/zo}function My(s,t,e){_r(s,t,e);var i=s*s+t*t-e*e;if(0>i)return[];if(i===0)return[[s*e/(s*s+t*t),t*e/(s*s+t*t)]];var n=Math.sqrt(i);return[[(s*e+t*n)/(s*s+t*t),(t*e-s*n)/(s*s+t*t)],[(s*e-t*n)/(s*s+t*t),(t*e+s*n)/(s*s+t*t)]]}var pn,po=Math.PI/180;function Ey(s,t,e){return(1-e)*s+e*t}function Ay(s,t,e,i){return s+Math.cos(i/180*zo)*t+Math.sin(i/180*zo)*e}function Ty(s,t,e,i){var n=1e-6,r=t-s,o=e-t,l=3*r+3*(i-e)-6*o,h=6*(o-r),u=3*r;return Math.abs(l)<n?[-u/h]:function(d,g,y){var m=d*d/4-g;if(m<-y)return[];if(m<=y)return[-d/2];var I=Math.sqrt(m);return[-d/2-I,-d/2+I]}(h/l,u/l,n)}function Ny(s,t,e,i,n){var r=1-n;return s*(r*r*r)+t*(3*r*r*n)+e*(3*r*n*n)+i*(n*n*n)}(function(s){function t(){return n(function(l,h,u){return l.relative&&(l.x1!==void 0&&(l.x1+=h),l.y1!==void 0&&(l.y1+=u),l.x2!==void 0&&(l.x2+=h),l.y2!==void 0&&(l.y2+=u),l.x!==void 0&&(l.x+=h),l.y!==void 0&&(l.y+=u),l.relative=!1),l})}function e(){var l=NaN,h=NaN,u=NaN,d=NaN;return n(function(g,y,m){return g.type&At.SMOOTH_CURVE_TO&&(g.type=At.CURVE_TO,l=isNaN(l)?y:l,h=isNaN(h)?m:h,g.x1=g.relative?y-l:2*y-l,g.y1=g.relative?m-h:2*m-h),g.type&At.CURVE_TO?(l=g.relative?y+g.x2:g.x2,h=g.relative?m+g.y2:g.y2):(l=NaN,h=NaN),g.type&At.SMOOTH_QUAD_TO&&(g.type=At.QUAD_TO,u=isNaN(u)?y:u,d=isNaN(d)?m:d,g.x1=g.relative?y-u:2*y-u,g.y1=g.relative?m-d:2*m-d),g.type&At.QUAD_TO?(u=g.relative?y+g.x1:g.x1,d=g.relative?m+g.y1:g.y1):(u=NaN,d=NaN),g})}function i(){var l=NaN,h=NaN;return n(function(u,d,g){if(u.type&At.SMOOTH_QUAD_TO&&(u.type=At.QUAD_TO,l=isNaN(l)?d:l,h=isNaN(h)?g:h,u.x1=u.relative?d-l:2*d-l,u.y1=u.relative?g-h:2*g-h),u.type&At.QUAD_TO){l=u.relative?d+u.x1:u.x1,h=u.relative?g+u.y1:u.y1;var y=u.x1,m=u.y1;u.type=At.CURVE_TO,u.x1=((u.relative?0:d)+2*y)/3,u.y1=((u.relative?0:g)+2*m)/3,u.x2=(u.x+2*y)/3,u.y2=(u.y+2*m)/3}else l=NaN,h=NaN;return u})}function n(l){var h=0,u=0,d=NaN,g=NaN;return function(y){if(isNaN(d)&&!(y.type&At.MOVE_TO))throw new Error("path must start with moveto");var m=l(y,h,u,d,g);return y.type&At.CLOSE_PATH&&(h=d,u=g),y.x!==void 0&&(h=y.relative?h+y.x:y.x),y.y!==void 0&&(u=y.relative?u+y.y:y.y),y.type&At.MOVE_TO&&(d=h,g=u),m}}function r(l,h,u,d,g,y){return _r(l,h,u,d,g,y),n(function(m,I,b,x){var C=m.x1,P=m.x2,k=m.relative&&!isNaN(x),O=m.x!==void 0?m.x:k?0:I,B=m.y!==void 0?m.y:k?0:b;function j(at){return at*at}m.type&At.HORIZ_LINE_TO&&h!==0&&(m.type=At.LINE_TO,m.y=m.relative?0:b),m.type&At.VERT_LINE_TO&&u!==0&&(m.type=At.LINE_TO,m.x=m.relative?0:I),m.x!==void 0&&(m.x=m.x*l+B*u+(k?0:g)),m.y!==void 0&&(m.y=O*h+m.y*d+(k?0:y)),m.x1!==void 0&&(m.x1=m.x1*l+m.y1*u+(k?0:g)),m.y1!==void 0&&(m.y1=C*h+m.y1*d+(k?0:y)),m.x2!==void 0&&(m.x2=m.x2*l+m.y2*u+(k?0:g)),m.y2!==void 0&&(m.y2=P*h+m.y2*d+(k?0:y));var V=l*d-h*u;if(m.xRot!==void 0&&(l!==1||h!==0||u!==0||d!==1))if(V===0)delete m.rX,delete m.rY,delete m.xRot,delete m.lArcFlag,delete m.sweepFlag,m.type=At.LINE_TO;else{var Y=m.xRot*Math.PI/180,q=Math.sin(Y),st=Math.cos(Y),ft=1/j(m.rX),U=1/j(m.rY),J=j(st)*ft+j(q)*U,A=2*q*st*(ft-U),R=j(q)*ft+j(st)*U,bt=J*d*d-A*h*d+R*h*h,z=A*(l*d+h*u)-2*(J*u*d+R*l*h),Pt=J*u*u-A*l*u+R*l*l,X=(Math.atan2(z,bt-Pt)+Math.PI)%Math.PI/2,Tt=Math.sin(X),lt=Math.cos(X);m.rX=Math.abs(V)/Math.sqrt(bt*j(lt)+z*Tt*lt+Pt*j(Tt)),m.rY=Math.abs(V)/Math.sqrt(bt*j(Tt)-z*Tt*lt+Pt*j(lt)),m.xRot=180*X/Math.PI}return m.sweepFlag!==void 0&&0>V&&(m.sweepFlag=+!m.sweepFlag),m})}function o(){return function(l){var h={};for(var u in l)h[u]=l[u];return h}}s.ROUND=function(l){function h(u){return Math.round(u*l)/l}return l===void 0&&(l=1e13),_r(l),function(u){return u.x1!==void 0&&(u.x1=h(u.x1)),u.y1!==void 0&&(u.y1=h(u.y1)),u.x2!==void 0&&(u.x2=h(u.x2)),u.y2!==void 0&&(u.y2=h(u.y2)),u.x!==void 0&&(u.x=h(u.x)),u.y!==void 0&&(u.y=h(u.y)),u.rX!==void 0&&(u.rX=h(u.rX)),u.rY!==void 0&&(u.rY=h(u.rY)),u}},s.TO_ABS=t,s.TO_REL=function(){return n(function(l,h,u){return l.relative||(l.x1!==void 0&&(l.x1-=h),l.y1!==void 0&&(l.y1-=u),l.x2!==void 0&&(l.x2-=h),l.y2!==void 0&&(l.y2-=u),l.x!==void 0&&(l.x-=h),l.y!==void 0&&(l.y-=u),l.relative=!0),l})},s.NORMALIZE_HVZ=function(l,h,u){return l===void 0&&(l=!0),h===void 0&&(h=!0),u===void 0&&(u=!0),n(function(d,g,y,m,I){if(isNaN(m)&&!(d.type&At.MOVE_TO))throw new Error("path must start with moveto");return h&&d.type&At.HORIZ_LINE_TO&&(d.type=At.LINE_TO,d.y=d.relative?0:y),u&&d.type&At.VERT_LINE_TO&&(d.type=At.LINE_TO,d.x=d.relative?0:g),l&&d.type&At.CLOSE_PATH&&(d.type=At.LINE_TO,d.x=d.relative?m-g:m,d.y=d.relative?I-y:I),d.type&At.ARC&&(d.rX===0||d.rY===0)&&(d.type=At.LINE_TO,delete d.rX,delete d.rY,delete d.xRot,delete d.lArcFlag,delete d.sweepFlag),d})},s.NORMALIZE_ST=e,s.QT_TO_C=i,s.INFO=n,s.SANITIZE=function(l){l===void 0&&(l=0),_r(l);var h=NaN,u=NaN,d=NaN,g=NaN;return n(function(y,m,I,b,x){var C=Math.abs,P=!1,k=0,O=0;if(y.type&At.SMOOTH_CURVE_TO&&(k=isNaN(h)?0:m-h,O=isNaN(u)?0:I-u),y.type&(At.CURVE_TO|At.SMOOTH_CURVE_TO)?(h=y.relative?m+y.x2:y.x2,u=y.relative?I+y.y2:y.y2):(h=NaN,u=NaN),y.type&At.SMOOTH_QUAD_TO?(d=isNaN(d)?m:2*m-d,g=isNaN(g)?I:2*I-g):y.type&At.QUAD_TO?(d=y.relative?m+y.x1:y.x1,g=y.relative?I+y.y1:y.y2):(d=NaN,g=NaN),y.type&At.LINE_COMMANDS||y.type&At.ARC&&(y.rX===0||y.rY===0||!y.lArcFlag)||y.type&At.CURVE_TO||y.type&At.SMOOTH_CURVE_TO||y.type&At.QUAD_TO||y.type&At.SMOOTH_QUAD_TO){var B=y.x===void 0?0:y.relative?y.x:y.x-m,j=y.y===void 0?0:y.relative?y.y:y.y-I;k=isNaN(d)?y.x1===void 0?k:y.relative?y.x:y.x1-m:d-m,O=isNaN(g)?y.y1===void 0?O:y.relative?y.y:y.y1-I:g-I;var V=y.x2===void 0?0:y.relative?y.x:y.x2-m,Y=y.y2===void 0?0:y.relative?y.y:y.y2-I;C(B)<=l&&C(j)<=l&&C(k)<=l&&C(O)<=l&&C(V)<=l&&C(Y)<=l&&(P=!0)}return y.type&At.CLOSE_PATH&&C(m-b)<=l&&C(I-x)<=l&&(P=!0),P?[]:y})},s.MATRIX=r,s.ROTATE=function(l,h,u){h===void 0&&(h=0),u===void 0&&(u=0),_r(l,h,u);var d=Math.sin(l),g=Math.cos(l);return r(g,d,-d,g,h-h*g+u*d,u-h*d-u*g)},s.TRANSLATE=function(l,h){return h===void 0&&(h=0),_r(l,h),r(1,0,0,1,l,h)},s.SCALE=function(l,h){return h===void 0&&(h=l),_r(l,h),r(l,0,0,h,0,0)},s.SKEW_X=function(l){return _r(l),r(1,0,Math.atan(l),1,0,0)},s.SKEW_Y=function(l){return _r(l),r(1,Math.atan(l),0,1,0,0)},s.X_AXIS_SYMMETRY=function(l){return l===void 0&&(l=0),_r(l),r(-1,0,0,1,l,0)},s.Y_AXIS_SYMMETRY=function(l){return l===void 0&&(l=0),_r(l),r(1,0,0,-1,0,l)},s.A_TO_C=function(){return n(function(l,h,u){return At.ARC===l.type?function(d,g,y){var m,I,b,x;d.cX||Sg(d,g,y);for(var C=Math.min(d.phi1,d.phi2),P=Math.max(d.phi1,d.phi2)-C,k=Math.ceil(P/90),O=new Array(k),B=g,j=y,V=0;V<k;V++){var Y=Ey(d.phi1,d.phi2,V/k),q=Ey(d.phi1,d.phi2,(V+1)/k),st=q-Y,ft=4/3*Math.tan(st*po/4),U=[Math.cos(Y*po)-ft*Math.sin(Y*po),Math.sin(Y*po)+ft*Math.cos(Y*po)],J=U[0],A=U[1],R=[Math.cos(q*po),Math.sin(q*po)],bt=R[0],z=R[1],Pt=[bt+ft*Math.sin(q*po),z-ft*Math.cos(q*po)],X=Pt[0],Tt=Pt[1];O[V]={relative:d.relative,type:At.CURVE_TO};var lt=function(at,Gt){var kt=Cg([at*d.rX,Gt*d.rY],d.xRot),Ft=kt[0],ni=kt[1];return[d.cX+Ft,d.cY+ni]};m=lt(J,A),O[V].x1=m[0],O[V].y1=m[1],I=lt(X,Tt),O[V].x2=I[0],O[V].y2=I[1],b=lt(bt,z),O[V].x=b[0],O[V].y=b[1],d.relative&&(O[V].x1-=B,O[V].y1-=j,O[V].x2-=B,O[V].y2-=j,O[V].x-=B,O[V].y-=j),B=(x=[O[V].x,O[V].y])[0],j=x[1]}return O}(l,l.relative?0:h,l.relative?0:u):l})},s.ANNOTATE_ARCS=function(){return n(function(l,h,u){return l.relative&&(h=0,u=0),At.ARC===l.type&&Sg(l,h,u),l})},s.CLONE=o,s.CALCULATE_BOUNDS=function(){var l=function(y){var m={};for(var I in y)m[I]=y[I];return m},h=t(),u=i(),d=e(),g=n(function(y,m,I){var b=d(u(h(l(y))));function x(Tt){Tt>g.maxX&&(g.maxX=Tt),Tt<g.minX&&(g.minX=Tt)}function C(Tt){Tt>g.maxY&&(g.maxY=Tt),Tt<g.minY&&(g.minY=Tt)}if(b.type&At.DRAWING_COMMANDS&&(x(m),C(I)),b.type&At.HORIZ_LINE_TO&&x(b.x),b.type&At.VERT_LINE_TO&&C(b.y),b.type&At.LINE_TO&&(x(b.x),C(b.y)),b.type&At.CURVE_TO){x(b.x),C(b.y);for(var P=0,k=Ty(m,b.x1,b.x2,b.x);P<k.length;P++)0<(X=k[P])&&1>X&&x(Ny(m,b.x1,b.x2,b.x,X));for(var O=0,B=Ty(I,b.y1,b.y2,b.y);O<B.length;O++)0<(X=B[O])&&1>X&&C(Ny(I,b.y1,b.y2,b.y,X))}if(b.type&At.ARC){x(b.x),C(b.y),Sg(b,m,I);for(var j=b.xRot/180*Math.PI,V=Math.cos(j)*b.rX,Y=Math.sin(j)*b.rX,q=-Math.sin(j)*b.rY,st=Math.cos(j)*b.rY,ft=b.phi1<b.phi2?[b.phi1,b.phi2]:-180>b.phi2?[b.phi2+360,b.phi1+360]:[b.phi2,b.phi1],U=ft[0],J=ft[1],A=function(Tt){var lt=Tt[0],at=Tt[1],Gt=180*Math.atan2(at,lt)/Math.PI;return Gt<U?Gt+360:Gt},R=0,bt=My(q,-V,0).map(A);R<bt.length;R++)(X=bt[R])>U&&X<J&&x(Ay(b.cX,V,q,X));for(var z=0,Pt=My(st,-Y,0).map(A);z<Pt.length;z++){var X;(X=Pt[z])>U&&X<J&&C(Ay(b.cY,Y,st,X))}}return y});return g.minX=1/0,g.maxX=-1/0,g.minY=1/0,g.maxY=-1/0,g}})(pn||(pn={}));var yr,Dy=function(){function s(){}return s.prototype.round=function(t){return this.transform(pn.ROUND(t))},s.prototype.toAbs=function(){return this.transform(pn.TO_ABS())},s.prototype.toRel=function(){return this.transform(pn.TO_REL())},s.prototype.normalizeHVZ=function(t,e,i){return this.transform(pn.NORMALIZE_HVZ(t,e,i))},s.prototype.normalizeST=function(){return this.transform(pn.NORMALIZE_ST())},s.prototype.qtToC=function(){return this.transform(pn.QT_TO_C())},s.prototype.aToC=function(){return this.transform(pn.A_TO_C())},s.prototype.sanitize=function(t){return this.transform(pn.SANITIZE(t))},s.prototype.translate=function(t,e){return this.transform(pn.TRANSLATE(t,e))},s.prototype.scale=function(t,e){return this.transform(pn.SCALE(t,e))},s.prototype.rotate=function(t,e,i){return this.transform(pn.ROTATE(t,e,i))},s.prototype.matrix=function(t,e,i,n,r,o){return this.transform(pn.MATRIX(t,e,i,n,r,o))},s.prototype.skewX=function(t){return this.transform(pn.SKEW_X(t))},s.prototype.skewY=function(t){return this.transform(pn.SKEW_Y(t))},s.prototype.xSymmetry=function(t){return this.transform(pn.X_AXIS_SYMMETRY(t))},s.prototype.ySymmetry=function(t){return this.transform(pn.Y_AXIS_SYMMETRY(t))},s.prototype.annotateArcs=function(){return this.transform(pn.ANNOTATE_ARCS())},s}(),zI=function(s){return s===" "||s==="	"||s==="\r"||s===`
`},Oy=function(s){return 48<=s.charCodeAt(0)&&s.charCodeAt(0)<=57},HI=function(s){function t(){var e=s.call(this)||this;return e.curNumber="",e.curCommandType=-1,e.curCommandRelative=!1,e.canParseCommandOrComma=!0,e.curNumberHasExp=!1,e.curNumberHasExpDigits=!1,e.curNumberHasDecimal=!1,e.curArgs=[],e}return ky(t,s),t.prototype.finish=function(e){if(e===void 0&&(e=[]),this.parse(" ",e),this.curArgs.length!==0||!this.canParseCommandOrComma)throw new SyntaxError("Unterminated command at the path end.");return e},t.prototype.parse=function(e,i){var n=this;i===void 0&&(i=[]);for(var r=function(g){i.push(g),n.curArgs.length=0,n.canParseCommandOrComma=!0},o=0;o<e.length;o++){var l=e[o],h=!(this.curCommandType!==At.ARC||this.curArgs.length!==3&&this.curArgs.length!==4||this.curNumber.length!==1||this.curNumber!=="0"&&this.curNumber!=="1"),u=Oy(l)&&(this.curNumber==="0"&&l==="0"||h);if(!Oy(l)||u)if(l!=="e"&&l!=="E")if(l!=="-"&&l!=="+"||!this.curNumberHasExp||this.curNumberHasExpDigits)if(l!=="."||this.curNumberHasExp||this.curNumberHasDecimal||h){if(this.curNumber&&this.curCommandType!==-1){var d=Number(this.curNumber);if(isNaN(d))throw new SyntaxError("Invalid number ending at "+o);if(this.curCommandType===At.ARC){if(this.curArgs.length===0||this.curArgs.length===1){if(0>d)throw new SyntaxError('Expected positive number, got "'+d+'" at index "'+o+'"')}else if((this.curArgs.length===3||this.curArgs.length===4)&&this.curNumber!=="0"&&this.curNumber!=="1")throw new SyntaxError('Expected a flag, got "'+this.curNumber+'" at index "'+o+'"')}this.curArgs.push(d),this.curArgs.length===UI[this.curCommandType]&&(At.HORIZ_LINE_TO===this.curCommandType?r({type:At.HORIZ_LINE_TO,relative:this.curCommandRelative,x:d}):At.VERT_LINE_TO===this.curCommandType?r({type:At.VERT_LINE_TO,relative:this.curCommandRelative,y:d}):this.curCommandType===At.MOVE_TO||this.curCommandType===At.LINE_TO||this.curCommandType===At.SMOOTH_QUAD_TO?(r({type:this.curCommandType,relative:this.curCommandRelative,x:this.curArgs[0],y:this.curArgs[1]}),At.MOVE_TO===this.curCommandType&&(this.curCommandType=At.LINE_TO)):this.curCommandType===At.CURVE_TO?r({type:At.CURVE_TO,relative:this.curCommandRelative,x1:this.curArgs[0],y1:this.curArgs[1],x2:this.curArgs[2],y2:this.curArgs[3],x:this.curArgs[4],y:this.curArgs[5]}):this.curCommandType===At.SMOOTH_CURVE_TO?r({type:At.SMOOTH_CURVE_TO,relative:this.curCommandRelative,x2:this.curArgs[0],y2:this.curArgs[1],x:this.curArgs[2],y:this.curArgs[3]}):this.curCommandType===At.QUAD_TO?r({type:At.QUAD_TO,relative:this.curCommandRelative,x1:this.curArgs[0],y1:this.curArgs[1],x:this.curArgs[2],y:this.curArgs[3]}):this.curCommandType===At.ARC&&r({type:At.ARC,relative:this.curCommandRelative,rX:this.curArgs[0],rY:this.curArgs[1],xRot:this.curArgs[2],lArcFlag:this.curArgs[3],sweepFlag:this.curArgs[4],x:this.curArgs[5],y:this.curArgs[6]})),this.curNumber="",this.curNumberHasExpDigits=!1,this.curNumberHasExp=!1,this.curNumberHasDecimal=!1,this.canParseCommandOrComma=!0}if(!zI(l))if(l===","&&this.canParseCommandOrComma)this.canParseCommandOrComma=!1;else if(l!=="+"&&l!=="-"&&l!==".")if(u)this.curNumber=l,this.curNumberHasDecimal=!1;else{if(this.curArgs.length!==0)throw new SyntaxError("Unterminated command at index "+o+".");if(!this.canParseCommandOrComma)throw new SyntaxError('Unexpected character "'+l+'" at index '+o+". Command cannot follow comma");if(this.canParseCommandOrComma=!1,l!=="z"&&l!=="Z")if(l==="h"||l==="H")this.curCommandType=At.HORIZ_LINE_TO,this.curCommandRelative=l==="h";else if(l==="v"||l==="V")this.curCommandType=At.VERT_LINE_TO,this.curCommandRelative=l==="v";else if(l==="m"||l==="M")this.curCommandType=At.MOVE_TO,this.curCommandRelative=l==="m";else if(l==="l"||l==="L")this.curCommandType=At.LINE_TO,this.curCommandRelative=l==="l";else if(l==="c"||l==="C")this.curCommandType=At.CURVE_TO,this.curCommandRelative=l==="c";else if(l==="s"||l==="S")this.curCommandType=At.SMOOTH_CURVE_TO,this.curCommandRelative=l==="s";else if(l==="q"||l==="Q")this.curCommandType=At.QUAD_TO,this.curCommandRelative=l==="q";else if(l==="t"||l==="T")this.curCommandType=At.SMOOTH_QUAD_TO,this.curCommandRelative=l==="t";else{if(l!=="a"&&l!=="A")throw new SyntaxError('Unexpected character "'+l+'" at index '+o+".");this.curCommandType=At.ARC,this.curCommandRelative=l==="a"}else i.push({type:At.CLOSE_PATH}),this.canParseCommandOrComma=!0,this.curCommandType=-1}else this.curNumber=l,this.curNumberHasDecimal=l==="."}else this.curNumber+=l,this.curNumberHasDecimal=!0;else this.curNumber+=l;else this.curNumber+=l,this.curNumberHasExp=!0;else this.curNumber+=l,this.curNumberHasExpDigits=this.curNumberHasExp}return i},t.prototype.transform=function(e){return Object.create(this,{parse:{value:function(i,n){n===void 0&&(n=[]);for(var r=0,o=Object.getPrototypeOf(this).parse.call(this,i);r<o.length;r++){var l=o[r],h=e(l);Array.isArray(h)?n.push.apply(n,h):n.push(h)}return n}}})},t}(Dy),At=function(s){function t(e){var i=s.call(this)||this;return i.commands=typeof e=="string"?t.parse(e):e,i}return ky(t,s),t.prototype.encode=function(){return t.encode(this.commands)},t.prototype.getBounds=function(){var e=pn.CALCULATE_BOUNDS();return this.transform(e),e},t.prototype.transform=function(e){for(var i=[],n=0,r=this.commands;n<r.length;n++){var o=e(r[n]);Array.isArray(o)?i.push.apply(i,o):i.push(o)}return this.commands=i,this},t.encode=function(e){return VI(e)},t.parse=function(e){var i=new HI,n=[];return i.parse(e,n),i.finish(n),n},t.CLOSE_PATH=1,t.MOVE_TO=2,t.HORIZ_LINE_TO=4,t.VERT_LINE_TO=8,t.LINE_TO=16,t.CURVE_TO=32,t.SMOOTH_CURVE_TO=64,t.QUAD_TO=128,t.SMOOTH_QUAD_TO=256,t.ARC=512,t.LINE_COMMANDS=t.LINE_TO|t.HORIZ_LINE_TO|t.VERT_LINE_TO,t.DRAWING_COMMANDS=t.HORIZ_LINE_TO|t.VERT_LINE_TO|t.LINE_TO|t.CURVE_TO|t.SMOOTH_CURVE_TO|t.QUAD_TO|t.SMOOTH_QUAD_TO|t.ARC,t}(Dy),UI=((yr={})[At.MOVE_TO]=2,yr[At.LINE_TO]=2,yr[At.HORIZ_LINE_TO]=1,yr[At.VERT_LINE_TO]=1,yr[At.CLOSE_PATH]=0,yr[At.QUAD_TO]=4,yr[At.SMOOTH_QUAD_TO]=2,yr[At.CURVE_TO]=6,yr[At.SMOOTH_CURVE_TO]=4,yr[At.ARC]=7,yr);function dd(s){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?dd=function(t){return typeof t}:dd=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},dd(s)}function jI(s,t){if(!(s instanceof t))throw new TypeError("Cannot call a class as a function")}var WI=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],GI=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function $I(s,t,e,i,n){if(typeof s=="string"&&(s=document.getElementById(s)),!s||dd(s)!=="object"||!("getContext"in s))throw new TypeError("Expecting canvas with `getContext` method in processCanvasRGB(A) calls!");var r=s.getContext("2d");try{return r.getImageData(t,e,i,n)}catch(o){throw new Error("unable to access image data: "+o)}}function qI(s,t,e,i,n,r){if(!(isNaN(r)||r<1)){r|=0;var o=$I(s,t,e,i,n);o=KI(o,t,e,i,n,r),s.getContext("2d").putImageData(o,t,e)}}function KI(s,t,e,i,n,r){for(var o=s.data,l=2*r+1,h=i-1,u=n-1,d=r+1,g=d*(d+1)/2,y=new Ry,m=y,I,b=1;b<l;b++)m=m.next=new Ry,b===d&&(I=m);m.next=y;for(var x=null,C=null,P=0,k=0,O=WI[r],B=GI[r],j=0;j<n;j++){m=y;for(var V=o[k],Y=o[k+1],q=o[k+2],st=o[k+3],ft=0;ft<d;ft++)m.r=V,m.g=Y,m.b=q,m.a=st,m=m.next;for(var U=0,J=0,A=0,R=0,bt=d*V,z=d*Y,Pt=d*q,X=d*st,Tt=g*V,lt=g*Y,at=g*q,Gt=g*st,kt=1;kt<d;kt++){var Ft=k+((h<kt?h:kt)<<2),ni=o[Ft],ji=o[Ft+1],oe=o[Ft+2],Se=o[Ft+3],We=d-kt;Tt+=(m.r=ni)*We,lt+=(m.g=ji)*We,at+=(m.b=oe)*We,Gt+=(m.a=Se)*We,U+=ni,J+=ji,A+=oe,R+=Se,m=m.next}x=y,C=I;for(var Ve=0;Ve<i;Ve++){var Le=Gt*O>>>B;if(o[k+3]=Le,Le!==0){var yn=255/Le;o[k]=(Tt*O>>>B)*yn,o[k+1]=(lt*O>>>B)*yn,o[k+2]=(at*O>>>B)*yn}else o[k]=o[k+1]=o[k+2]=0;Tt-=bt,lt-=z,at-=Pt,Gt-=X,bt-=x.r,z-=x.g,Pt-=x.b,X-=x.a;var T=Ve+r+1;T=P+(T<h?T:h)<<2,U+=x.r=o[T],J+=x.g=o[T+1],A+=x.b=o[T+2],R+=x.a=o[T+3],Tt+=U,lt+=J,at+=A,Gt+=R,x=x.next;var yt=C,gt=yt.r,$=yt.g,W=yt.b,nt=yt.a;bt+=gt,z+=$,Pt+=W,X+=nt,U-=gt,J-=$,A-=W,R-=nt,C=C.next,k+=4}P+=i}for(var It=0;It<i;It++){k=It<<2;var St=o[k],ot=o[k+1],xt=o[k+2],Lt=o[k+3],Ot=d*St,Ut=d*ot,Ge=d*xt,we=d*Lt,hn=g*St,Rn=g*ot,Qi=g*xt,ds=g*Lt;m=y;for(var ui=0;ui<d;ui++)m.r=St,m.g=ot,m.b=xt,m.a=Lt,m=m.next;for(var Qs=i,tr=0,Un=0,te=0,jn=0,Wn=1;Wn<=r;Wn++){k=Qs+It<<2;var vs=d-Wn;hn+=(m.r=St=o[k])*vs,Rn+=(m.g=ot=o[k+1])*vs,Qi+=(m.b=xt=o[k+2])*vs,ds+=(m.a=Lt=o[k+3])*vs,jn+=St,tr+=ot,Un+=xt,te+=Lt,m=m.next,Wn<u&&(Qs+=i)}k=It,x=y,C=I;for(var tn=0;tn<n;tn++){var Oi=k<<2;o[Oi+3]=Lt=ds*O>>>B,Lt>0?(Lt=255/Lt,o[Oi]=(hn*O>>>B)*Lt,o[Oi+1]=(Rn*O>>>B)*Lt,o[Oi+2]=(Qi*O>>>B)*Lt):o[Oi]=o[Oi+1]=o[Oi+2]=0,hn-=Ot,Rn-=Ut,Qi-=Ge,ds-=we,Ot-=x.r,Ut-=x.g,Ge-=x.b,we-=x.a,Oi=It+((Oi=tn+d)<u?Oi:u)*i<<2,hn+=jn+=x.r=o[Oi],Rn+=tr+=x.g=o[Oi+1],Qi+=Un+=x.b=o[Oi+2],ds+=te+=x.a=o[Oi+3],x=x.next,Ot+=St=C.r,Ut+=ot=C.g,Ge+=xt=C.b,we+=Lt=C.a,jn-=St,tr-=ot,Un-=xt,te-=Lt,C=C.next,k+=i}}return s}var Ry=function s(){jI(this,s),this.r=0,this.g=0,this.b=0,this.a=0,this.next=null};function Rl(s){return s.replace(/(?!\u3000)\s+/gm," ")}function XI(s){return s.replace(/^[\n \t]+/,"")}function JI(s){return s.replace(/[\n \t]+$/,"")}function Bs(s){const t=s.match(/-?(\d+(?:\.\d*(?:[eE][+-]?\d+)?)?|\.\d+)(?=\D|$)/gm);return t?t.map(parseFloat):[]}function YI(s){const t=Bs(s);return[t[0]||0,t[1]||0,t[2]||0,t[3]||0,t[4]||0,t[5]||0]}const ZI=/^[A-Z-]+$/;function QI(s){return ZI.test(s)?s.toLowerCase():s}function Ly(s){const t=/url\(('([^']+)'|"([^"]+)"|([^'")]+))\)/.exec(s);return t&&(t[2]||t[3]||t[4])||""}function tx(s){if(!s.startsWith("rgb"))return s;let t=3;return s.replace(/\d+(\.\d+)?/g,(i,n)=>t--&&n?String(Math.round(parseFloat(i))):i)}const ex=/(\[[^\]]+\])/g,ix=/(#[^\s+>~.[:]+)/g,nx=/(\.[^\s+>~.[:]+)/g,sx=/(::[^\s+>~.[:]+|:first-line|:first-letter|:before|:after)/gi,rx=/(:[\w-]+\([^)]*\))/gi,ox=/(:[^\s+>~.[:]+)/g,ax=/([^\s+>~.[:]+)/g;function Sa(s,t){const e=t.exec(s);return e?[s.replace(t," "),e.length]:[s,0]}function lx(s){const t=[0,0,0];let e=s.replace(/:not\(([^)]*)\)/g,"     $1 ").replace(/{[\s\S]*/gm," "),i=0;return[e,i]=Sa(e,ex),t[1]+=i,[e,i]=Sa(e,ix),t[0]+=i,[e,i]=Sa(e,nx),t[1]+=i,[e,i]=Sa(e,sx),t[2]+=i,[e,i]=Sa(e,rx),t[1]+=i,[e,i]=Sa(e,ox),t[1]+=i,e=e.replace(/[*\s+>~]/g," ").replace(/[#.]/g," "),[e,i]=Sa(e,ax),t[2]+=i,t.join("")}const Ll=1e-8;function Fy(s){return Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2))}function Pg(s,t){return(s[0]*t[0]+s[1]*t[1])/(Fy(s)*Fy(t))}function By(s,t){return(s[0]*t[1]<s[1]*t[0]?-1:1)*Math.acos(Pg(s,t))}function Vy(s){return s*s*s}function zy(s){return 3*s*s*(1-s)}function Hy(s){return 3*s*(1-s)*(1-s)}function Uy(s){return(1-s)*(1-s)*(1-s)}function jy(s){return s*s}function Wy(s){return 2*s*(1-s)}function Gy(s){return(1-s)*(1-s)}class se{static empty(t){return new se(t,"EMPTY","")}split(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:" ";const{document:e,name:i}=this;return Rl(this.getString()).trim().split(t).map(n=>new se(e,i,n))}hasValue(t){const e=this.value;return e!==null&&e!==""&&(t||e!==0)&&typeof e<"u"}isString(t){const{value:e}=this,i=typeof e=="string";return!i||!t?i:t.test(e)}isUrlDefinition(){return this.isString(/^url\(/)}isPixels(){if(!this.hasValue())return!1;const t=this.getString();switch(!0){case t.endsWith("px"):case/^[0-9]+$/.test(t):return!0;default:return!1}}setValue(t){return this.value=t,this}getValue(t){return typeof t>"u"||this.hasValue()?this.value:t}getNumber(t){if(!this.hasValue())return typeof t>"u"?0:parseFloat(t);const{value:e}=this;let i=parseFloat(e);return this.isString(/%$/)&&(i/=100),i}getString(t){return typeof t>"u"||this.hasValue()?typeof this.value>"u"?"":String(this.value):String(t)}getColor(t){let e=this.getString(t);return this.isNormalizedColor||(this.isNormalizedColor=!0,e=tx(e),this.value=e),e}getDpi(){return 96}getRem(){return this.document.rootEmSize}getEm(){return this.document.emSize}getUnits(){return this.getString().replace(/[0-9.-]/g,"")}getPixels(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!this.hasValue())return 0;const[i,n]=typeof t=="boolean"?[void 0,t]:[t],{viewPort:r}=this.document.screen;switch(!0){case this.isString(/vmin$/):return this.getNumber()/100*Math.min(r.computeSize("x"),r.computeSize("y"));case this.isString(/vmax$/):return this.getNumber()/100*Math.max(r.computeSize("x"),r.computeSize("y"));case this.isString(/vw$/):return this.getNumber()/100*r.computeSize("x");case this.isString(/vh$/):return this.getNumber()/100*r.computeSize("y");case this.isString(/rem$/):return this.getNumber()*this.getRem();case this.isString(/em$/):return this.getNumber()*this.getEm();case this.isString(/ex$/):return this.getNumber()*this.getEm()/2;case this.isString(/px$/):return this.getNumber();case this.isString(/pt$/):return this.getNumber()*this.getDpi()*.013888888888888888;case this.isString(/pc$/):return this.getNumber()*15;case this.isString(/cm$/):return this.getNumber()*this.getDpi()/2.54;case this.isString(/mm$/):return this.getNumber()*this.getDpi()/25.4;case this.isString(/in$/):return this.getNumber()*this.getDpi();case(this.isString(/%$/)&&n):return this.getNumber()*this.getEm();case this.isString(/%$/):return this.getNumber()*r.computeSize(i);default:{const o=this.getNumber();return e&&o<1?o*r.computeSize(i):o}}}getMilliseconds(){return this.hasValue()?this.isString(/ms$/)?this.getNumber():this.getNumber()*1e3:0}getRadians(){if(!this.hasValue())return 0;switch(!0){case this.isString(/deg$/):return this.getNumber()*(Math.PI/180);case this.isString(/grad$/):return this.getNumber()*(Math.PI/200);case this.isString(/rad$/):return this.getNumber();default:return this.getNumber()*(Math.PI/180)}}getDefinition(){const t=this.getString(),e=/#([^)'"]+)/.exec(t),i=(e==null?void 0:e[1])||t;return this.document.definitions[i]}getFillStyleDefinition(t,e){let i=this.getDefinition();if(!i)return null;if(typeof i.createGradient=="function"&&"getBoundingBox"in t)return i.createGradient(this.document.ctx,t,e);if(typeof i.createPattern=="function"){if(i.getHrefAttribute().hasValue()){const n=i.getAttribute("patternTransform");i=i.getHrefAttribute().getDefinition(),i&&n.hasValue()&&i.getAttribute("patternTransform",!0).setValue(n.value)}if(i)return i.createPattern(this.document.ctx,t,e)}return null}getTextBaseline(){if(!this.hasValue())return null;const t=this.getString();return se.textBaselineMapping[t]||null}addOpacity(t){let e=this.getColor();const i=e.length;let n=0;for(let r=0;r<i&&(e[r]===","&&n++,n!==3);r++);if(t.hasValue()&&this.isString()&&n!==3){const r=new xg(e);r.ok&&(r.alpha=t.getNumber(),e=r.toRGBA())}return new se(this.document,this.name,e)}constructor(t,e,i){this.document=t,this.name=e,this.value=i,this.isNormalizedColor=!1}}se.textBaselineMapping={baseline:"alphabetic","before-edge":"top","text-before-edge":"top",middle:"middle",central:"middle","after-edge":"bottom","text-after-edge":"bottom",ideographic:"ideographic",alphabetic:"alphabetic",hanging:"hanging",mathematical:"alphabetic"};class gh{clear(){this.viewPorts=[]}setCurrent(t,e){this.viewPorts.push({width:t,height:e})}removeCurrent(){this.viewPorts.pop()}getRoot(){const[t]=this.viewPorts;return t||$y()}getCurrent(){const{viewPorts:t}=this,e=t[t.length-1];return e||$y()}get width(){return this.getCurrent().width}get height(){return this.getCurrent().height}computeSize(t){return typeof t=="number"?t:t==="x"?this.width:t==="y"?this.height:Math.sqrt(Math.pow(this.width,2)+Math.pow(this.height,2))/Math.sqrt(2)}constructor(){this.viewPorts=[]}}gh.DEFAULT_VIEWPORT_WIDTH=800,gh.DEFAULT_VIEWPORT_HEIGHT=600;function $y(){return{width:gh.DEFAULT_VIEWPORT_WIDTH,height:gh.DEFAULT_VIEWPORT_HEIGHT}}class Hi{static parse(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;const[i=e,n=e]=Bs(t);return new Hi(i,n)}static parseScale(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const[i=e,n=i]=Bs(t);return new Hi(i,n)}static parsePath(t){const e=Bs(t),i=e.length,n=[];for(let r=0;r<i;r+=2)n.push(new Hi(e[r],e[r+1]));return n}angleTo(t){return Math.atan2(t.y-this.y,t.x-this.x)}applyTransform(t){const{x:e,y:i}=this,n=e*t[0]+i*t[2]+t[4],r=e*t[1]+i*t[3]+t[5];this.x=n,this.y=r}constructor(t,e){this.x=t,this.y=e}}class cx{isWorking(){return this.working}start(){if(this.working)return;const{screen:t,onClick:e,onMouseMove:i}=this,n=t.ctx.canvas;n.onclick=e,n.onmousemove=i,this.working=!0}stop(){if(!this.working)return;const t=this.screen.ctx.canvas;this.working=!1,t.onclick=null,t.onmousemove=null}hasEvents(){return this.working&&this.events.length>0}runEvents(){if(!this.working)return;const{screen:t,events:e,eventElements:i}=this,{style:n}=t.ctx.canvas;let r;n&&(n.cursor=""),e.forEach((o,l)=>{let{run:h}=o;for(r=i[l];r;)h(r),r=r.parent}),this.events=[],this.eventElements=[]}checkPath(t,e){if(!this.working||!e)return;const{events:i,eventElements:n}=this;i.forEach((r,o)=>{let{x:l,y:h}=r;!n[o]&&e.isPointInPath&&e.isPointInPath(l,h)&&(n[o]=t)})}checkBoundingBox(t,e){if(!this.working||!e)return;const{events:i,eventElements:n}=this;i.forEach((r,o)=>{let{x:l,y:h}=r;!n[o]&&e.isPointInBox(l,h)&&(n[o]=t)})}mapXY(t,e){const{window:i,ctx:n}=this.screen,r=new Hi(t,e);let o=n.canvas;for(;o;)r.x-=o.offsetLeft,r.y-=o.offsetTop,o=o.offsetParent;return i!=null&&i.scrollX&&(r.x+=i.scrollX),i!=null&&i.scrollY&&(r.y+=i.scrollY),r}onClick(t){const{x:e,y:i}=this.mapXY(t.clientX,t.clientY);this.events.push({type:"onclick",x:e,y:i,run(n){n.onClick&&n.onClick()}})}onMouseMove(t){const{x:e,y:i}=this.mapXY(t.clientX,t.clientY);this.events.push({type:"onmousemove",x:e,y:i,run(n){n.onMouseMove&&n.onMouseMove()}})}constructor(t){this.screen=t,this.working=!1,this.events=[],this.eventElements=[],this.onClick=this.onClick.bind(this),this.onMouseMove=this.onMouseMove.bind(this)}}const qy=typeof window<"u"?window:null,Ky=typeof fetch<"u"?fetch.bind(void 0):void 0;class mo{wait(t){this.waits.push(t)}ready(){return this.readyPromise?this.readyPromise:Promise.resolve()}isReady(){if(this.isReadyLock)return!0;const t=this.waits.every(e=>e());return t&&(this.waits=[],this.resolveReady&&this.resolveReady()),this.isReadyLock=t,t}setDefaults(t){t.strokeStyle="rgba(0,0,0,0)",t.lineCap="butt",t.lineJoin="miter",t.miterLimit=4}setViewBox(t){let{document:e,ctx:i,aspectRatio:n,width:r,desiredWidth:o,height:l,desiredHeight:h,minX:u=0,minY:d=0,refX:g,refY:y,clip:m=!1,clipX:I=0,clipY:b=0}=t;const x=Rl(n).replace(/^defer\s/,""),[C,P]=x.split(" "),k=C||"xMidYMid",O=P||"meet",B=r/o,j=l/h,V=Math.min(B,j),Y=Math.max(B,j);let q=o,st=h;O==="meet"&&(q*=V,st*=V),O==="slice"&&(q*=Y,st*=Y);const ft=new se(e,"refX",g),U=new se(e,"refY",y),J=ft.hasValue()&&U.hasValue();if(J&&i.translate(-V*ft.getPixels("x"),-V*U.getPixels("y")),m){const A=V*I,R=V*b;i.beginPath(),i.moveTo(A,R),i.lineTo(r,R),i.lineTo(r,l),i.lineTo(A,l),i.closePath(),i.clip()}if(!J){const A=O==="meet"&&V===j,R=O==="slice"&&Y===j,bt=O==="meet"&&V===B,z=O==="slice"&&Y===B;k.startsWith("xMid")&&(A||R)&&i.translate(r/2-q/2,0),k.endsWith("YMid")&&(bt||z)&&i.translate(0,l/2-st/2),k.startsWith("xMax")&&(A||R)&&i.translate(r-q,0),k.endsWith("YMax")&&(bt||z)&&i.translate(0,l-st)}switch(!0){case k==="none":i.scale(B,j);break;case O==="meet":i.scale(V,V);break;case O==="slice":i.scale(Y,Y);break}i.translate(-u,-d)}start(t){let{enableRedraw:e=!1,ignoreMouse:i=!1,ignoreAnimation:n=!1,ignoreDimensions:r=!1,ignoreClear:o=!1,forceRedraw:l,scaleWidth:h,scaleHeight:u,offsetX:d,offsetY:g}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{mouse:y}=this,m=1e3/mo.FRAMERATE;if(this.isReadyLock=!1,this.frameDuration=m,this.readyPromise=new Promise(P=>{this.resolveReady=P}),this.isReady()&&this.render(t,r,o,h,u,d,g),!e)return;let I=Date.now(),b=I,x=0;const C=()=>{I=Date.now(),x=I-b,x>=m&&(b=I-x%m,this.shouldUpdate(n,l)&&(this.render(t,r,o,h,u,d,g),y.runEvents())),this.intervalId=Ig(C)};i||y.start(),this.intervalId=Ig(C)}stop(){this.intervalId&&(Ig.cancel(this.intervalId),this.intervalId=null),this.mouse.stop()}shouldUpdate(t,e){if(!t){const{frameDuration:i}=this;if(this.animations.reduce((r,o)=>o.update(i)||r,!1))return!0}return!!(typeof e=="function"&&e()||!this.isReadyLock&&this.isReady()||this.mouse.hasEvents())}render(t,e,i,n,r,o,l){const{viewPort:h,ctx:u,isFirstRender:d}=this,g=u.canvas;h.clear(),g.width&&g.height&&h.setCurrent(g.width,g.height);const y=t.getStyle("width"),m=t.getStyle("height");!e&&(d||typeof n!="number"&&typeof r!="number")&&(y.hasValue()&&(g.width=y.getPixels("x"),g.style&&(g.style.width="".concat(g.width,"px"))),m.hasValue()&&(g.height=m.getPixels("y"),g.style&&(g.style.height="".concat(g.height,"px"))));let I=g.clientWidth||g.width,b=g.clientHeight||g.height;if(e&&y.hasValue()&&m.hasValue()&&(I=y.getPixels("x"),b=m.getPixels("y")),h.setCurrent(I,b),typeof o=="number"&&t.getAttribute("x",!0).setValue(o),typeof l=="number"&&t.getAttribute("y",!0).setValue(l),typeof n=="number"||typeof r=="number"){const x=Bs(t.getAttribute("viewBox").getString());let C=0,P=0;if(typeof n=="number"){const O=t.getStyle("width");O.hasValue()?C=O.getPixels("x")/n:x[2]&&!isNaN(x[2])&&(C=x[2]/n)}if(typeof r=="number"){const O=t.getStyle("height");O.hasValue()?P=O.getPixels("y")/r:x[3]&&!isNaN(x[3])&&(P=x[3]/r)}C||(C=P),P||(P=C),t.getAttribute("width",!0).setValue(n),t.getAttribute("height",!0).setValue(r);const k=t.getStyle("transform",!0,!0);k.setValue("".concat(k.getString()," scale(").concat(1/C,", ").concat(1/P,")"))}i||u.clearRect(0,0,I,b),t.render(u),d&&(this.isFirstRender=!1)}constructor(t,{fetch:e=Ky,window:i=qy}={}){if(this.ctx=t,this.viewPort=new gh,this.mouse=new cx(this),this.animations=[],this.waits=[],this.frameDuration=0,this.isReadyLock=!1,this.isFirstRender=!0,this.intervalId=null,this.window=i,!e)throw new Error("Can't find 'fetch' in 'globalThis', please provide it via options");this.fetch=e}}mo.defaultWindow=qy,mo.defaultFetch=Ky,mo.FRAMERATE=30,mo.MAX_VIRTUAL_PIXELS=3e4;const{defaultFetch:hx}=mo,ux=typeof DOMParser<"u"?DOMParser:void 0;class kg{async parse(t){return t.startsWith("<")?this.parseFromString(t):this.load(t)}parseFromString(t){const e=new this.DOMParser;try{return this.checkDocument(e.parseFromString(t,"image/svg+xml"))}catch{return this.checkDocument(e.parseFromString(t,"text/xml"))}}checkDocument(t){const e=t.getElementsByTagName("parsererror")[0];if(e)throw new Error(e.textContent||"Unknown parse error");return t}async load(t){const i=await(await this.fetch(t)).text();return this.parseFromString(i)}constructor({fetch:t=hx,DOMParser:e=ux}={}){if(!t)throw new Error("Can't find 'fetch' in 'globalThis', please provide it via options");if(!e)throw new Error("Can't find 'DOMParser' in 'globalThis', please provide it via options");this.fetch=t,this.DOMParser=e}}class dx{apply(t){const{x:e,y:i}=this.point;t.translate(e||0,i||0)}unapply(t){const{x:e,y:i}=this.point;t.translate(-1*e||0,-1*i||0)}applyToPoint(t){const{x:e,y:i}=this.point;t.applyTransform([1,0,0,1,e||0,i||0])}constructor(t,e){this.type="translate",this.point=Hi.parse(e)}}class fx{apply(t){const{cx:e,cy:i,originX:n,originY:r,angle:o}=this,l=e+n.getPixels("x"),h=i+r.getPixels("y");t.translate(l,h),t.rotate(o.getRadians()),t.translate(-l,-h)}unapply(t){const{cx:e,cy:i,originX:n,originY:r,angle:o}=this,l=e+n.getPixels("x"),h=i+r.getPixels("y");t.translate(l,h),t.rotate(-1*o.getRadians()),t.translate(-l,-h)}applyToPoint(t){const{cx:e,cy:i,angle:n}=this,r=n.getRadians();t.applyTransform([1,0,0,1,e||0,i||0]),t.applyTransform([Math.cos(r),Math.sin(r),-Math.sin(r),Math.cos(r),0,0]),t.applyTransform([1,0,0,1,-e||0,-i||0])}constructor(t,e,i){this.type="rotate";const n=Bs(e);this.angle=new se(t,"angle",n[0]),this.originX=i[0],this.originY=i[1],this.cx=n[1]||0,this.cy=n[2]||0}}class gx{apply(t){const{scale:{x:e,y:i},originX:n,originY:r}=this,o=n.getPixels("x"),l=r.getPixels("y");t.translate(o,l),t.scale(e,i||e),t.translate(-o,-l)}unapply(t){const{scale:{x:e,y:i},originX:n,originY:r}=this,o=n.getPixels("x"),l=r.getPixels("y");t.translate(o,l),t.scale(1/e,1/i||e),t.translate(-o,-l)}applyToPoint(t){const{x:e,y:i}=this.scale;t.applyTransform([e||0,0,0,i||0,0,0])}constructor(t,e,i){this.type="scale";const n=Hi.parseScale(e);(n.x===0||n.y===0)&&(n.x=Ll,n.y=Ll),this.scale=n,this.originX=i[0],this.originY=i[1]}}class Xy{apply(t){const{originX:e,originY:i,matrix:n}=this,r=e.getPixels("x"),o=i.getPixels("y");t.translate(r,o),t.transform(n[0],n[1],n[2],n[3],n[4],n[5]),t.translate(-r,-o)}unapply(t){const{originX:e,originY:i,matrix:n}=this,r=n[0],o=n[2],l=n[4],h=n[1],u=n[3],d=n[5],g=0,y=0,m=1,I=1/(r*(u*m-d*y)-o*(h*m-d*g)+l*(h*y-u*g)),b=e.getPixels("x"),x=i.getPixels("y");t.translate(b,x),t.transform(I*(u*m-d*y),I*(d*g-h*m),I*(l*y-o*m),I*(r*m-l*g),I*(o*d-l*u),I*(l*h-r*d)),t.translate(-b,-x)}applyToPoint(t){t.applyTransform(this.matrix)}constructor(t,e,i){this.type="matrix",this.matrix=YI(e),this.originX=i[0],this.originY=i[1]}}class Jy extends Xy{constructor(t,e,i){super(t,e,i),this.type="skew",this.angle=new se(t,"angle",e)}}class px extends Jy{constructor(t,e,i){super(t,e,i),this.type="skewX",this.matrix=[1,0,Math.tan(this.angle.getRadians()),1,0,0]}}class mx extends Jy{constructor(t,e,i){super(t,e,i),this.type="skewY",this.matrix=[1,Math.tan(this.angle.getRadians()),0,1,0,0]}}function _x(s){return Rl(s).trim().replace(/\)([a-zA-Z])/g,") $1").replace(/\)(\s?,\s?)/g,") ").split(/\s(?=[a-z])/)}function yx(s){const[t="",e=""]=s.split("(");return[t.trim(),e.trim().replace(")","")]}class Pa{static fromElement(t,e){const i=e.getStyle("transform",!1,!0);if(i.hasValue()){const[n,r=n]=e.getStyle("transform-origin",!1,!0).split();if(n&&r){const o=[n,r];return new Pa(t,i.getString(),o)}}return null}apply(t){this.transforms.forEach(e=>e.apply(t))}unapply(t){this.transforms.forEach(e=>e.unapply(t))}applyToPoint(t){this.transforms.forEach(e=>e.applyToPoint(t))}constructor(t,e,i){this.document=t,this.transforms=[],_x(e).forEach(r=>{if(r==="none")return;const[o,l]=yx(r),h=Pa.transformTypes[o];h&&this.transforms.push(new h(this.document,l,i))})}}Pa.transformTypes={translate:dx,rotate:fx,scale:gx,matrix:Xy,skewX:px,skewY:mx};let Yi=class up{getAttribute(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;const i=this.attributes[t];if(!i&&e){const n=new se(this.document,t,"");return this.attributes[t]=n,n}return i||se.empty(this.document)}getHrefAttribute(){let t;for(const e in this.attributes)if(e==="href"||e.endsWith(":href")){t=this.attributes[e];break}return t||se.empty(this.document)}getStyle(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;const n=this.styles[t];if(n)return n;const r=this.getAttribute(t);if(r.hasValue())return this.styles[t]=r,r;if(!i){const{parent:o}=this;if(o){const l=o.getStyle(t);if(l.hasValue())return l}}if(e){const o=new se(this.document,t,"");return this.styles[t]=o,o}return se.empty(this.document)}render(t){if(!(this.getStyle("display").getString()==="none"||this.getStyle("visibility").getString()==="hidden")){if(t.save(),this.getStyle("mask").hasValue()){const e=this.getStyle("mask").getDefinition();e&&(this.applyEffects(t),e.apply(t,this))}else if(this.getStyle("filter").getValue("none")!=="none"){const e=this.getStyle("filter").getDefinition();e&&(this.applyEffects(t),e.apply(t,this))}else this.setContext(t),this.renderChildren(t),this.clearContext(t);t.restore()}}setContext(t){}applyEffects(t){const e=Pa.fromElement(this.document,this);e&&e.apply(t);const i=this.getStyle("clip-path",!1,!0);if(i.hasValue()){const n=i.getDefinition();n&&n.apply(t)}}clearContext(t){}renderChildren(t){this.children.forEach(e=>{e.render(t)})}addChild(t){const e=t instanceof up?t:this.document.createElement(t);e.parent=this,up.ignoreChildTypes.includes(e.type)||this.children.push(e)}matchesSelector(t){var e;const{node:i}=this;if(typeof i.matches=="function")return i.matches(t);const n=(e=i.getAttribute)===null||e===void 0?void 0:e.call(i,"class");return!n||n===""?!1:n.split(" ").some(r=>".".concat(r)===t)}addStylesFromStyleDefinition(){const{styles:t,stylesSpecificity:e}=this.document;let i;for(const n in t)if(!n.startsWith("@")&&this.matchesSelector(n)){const r=t[n],o=e[n];if(r)for(const l in r){let h=this.stylesSpecificity[l];typeof h>"u"&&(h="000"),o&&o>=h&&(i=r[l],i&&(this.styles[l]=i),this.stylesSpecificity[l]=o)}}}removeStyles(t,e){return e.reduce((n,r)=>{const o=t.getStyle(r);if(!o.hasValue())return n;const l=o.getString();return o.setValue(""),[...n,[r,l]]},[])}restoreStyles(t,e){e.forEach(i=>{let[n,r]=i;t.getStyle(n,!0).setValue(r)})}isFirstChild(){var t;return((t=this.parent)===null||t===void 0?void 0:t.children.indexOf(this))===0}constructor(t,e,i=!1){if(this.document=t,this.node=e,this.captureTextNodes=i,this.type="",this.attributes={},this.styles={},this.stylesSpecificity={},this.animationFrozen=!1,this.animationFrozenValue="",this.parent=null,this.children=[],!e||e.nodeType!==1)return;Array.from(e.attributes).forEach(o=>{const l=QI(o.nodeName);this.attributes[l]=new se(t,l,o.value)}),this.addStylesFromStyleDefinition(),this.getAttribute("style").hasValue()&&this.getAttribute("style").getString().split(";").map(l=>l.trim()).forEach(l=>{if(!l)return;const[h,u]=l.split(":").map(d=>d.trim());h&&(this.styles[h]=new se(t,h,u))});const{definitions:n}=t,r=this.getAttribute("id");r.hasValue()&&(n[r.getString()]||(n[r.getString()]=this)),Array.from(e.childNodes).forEach(o=>{if(o.nodeType===1)this.addChild(o);else if(i&&(o.nodeType===3||o.nodeType===4)){const l=t.createTextNode(o);l.getText().length>0&&this.addChild(l)}})}};Yi.ignoreChildTypes=["title"];class wx extends Yi{constructor(t,e,i){super(t,e,i)}}function vx(s){const t=s.trim();return/^('|")/.test(t)?t:'"'.concat(t,'"')}function bx(s){return typeof process>"u"?s:s.trim().split(",").map(vx).join(",")}function Ix(s){if(!s)return"";const t=s.trim().toLowerCase();switch(t){case"normal":case"italic":case"oblique":case"inherit":case"initial":case"unset":return t;default:return/^oblique\s+(-|)\d+deg$/.test(t)?t:""}}function xx(s){if(!s)return"";const t=s.trim().toLowerCase();switch(t){case"normal":case"bold":case"lighter":case"bolder":case"inherit":case"initial":case"unset":return t;default:return/^[\d.]+$/.test(t)?t:""}}class us{static parse(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",e=arguments.length>1?arguments[1]:void 0,i="",n="",r="",o="",l="";const h=Rl(t).trim().split(" "),u={fontSize:!1,fontStyle:!1,fontWeight:!1,fontVariant:!1};return h.forEach(d=>{switch(!0){case(!u.fontStyle&&us.styles.includes(d)):d!=="inherit"&&(i=d),u.fontStyle=!0;break;case(!u.fontVariant&&us.variants.includes(d)):d!=="inherit"&&(n=d),u.fontStyle=!0,u.fontVariant=!0;break;case(!u.fontWeight&&us.weights.includes(d)):d!=="inherit"&&(r=d),u.fontStyle=!0,u.fontVariant=!0,u.fontWeight=!0;break;case!u.fontSize:d!=="inherit"&&(o=d.split("/")[0]||""),u.fontStyle=!0,u.fontVariant=!0,u.fontWeight=!0,u.fontSize=!0;break;default:d!=="inherit"&&(l+=d)}}),new us(i,n,r,o,l,e)}toString(){return[Ix(this.fontStyle),this.fontVariant,xx(this.fontWeight),this.fontSize,bx(this.fontFamily)].join(" ").trim()}constructor(t,e,i,n,r,o){const l=o?typeof o=="string"?us.parse(o):o:{};this.fontFamily=r||l.fontFamily,this.fontSize=n||l.fontSize,this.fontStyle=t||l.fontStyle,this.fontWeight=i||l.fontWeight,this.fontVariant=e||l.fontVariant}}us.styles="normal|italic|oblique|inherit",us.variants="normal|small-caps|inherit",us.weights="normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900|inherit";class wr{get x(){return this.x1}get y(){return this.y1}get width(){return this.x2-this.x1}get height(){return this.y2-this.y1}addPoint(t,e){typeof t<"u"&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=t,this.x2=t),t<this.x1&&(this.x1=t),t>this.x2&&(this.x2=t)),typeof e<"u"&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=e,this.y2=e),e<this.y1&&(this.y1=e),e>this.y2&&(this.y2=e))}addX(t){this.addPoint(t,0)}addY(t){this.addPoint(0,t)}addBoundingBox(t){if(!t)return;const{x1:e,y1:i,x2:n,y2:r}=t;this.addPoint(e,i),this.addPoint(n,r)}sumCubic(t,e,i,n,r){return Math.pow(1-t,3)*e+3*Math.pow(1-t,2)*t*i+3*(1-t)*Math.pow(t,2)*n+Math.pow(t,3)*r}bezierCurveAdd(t,e,i,n,r){const o=6*e-12*i+6*n,l=-3*e+9*i-9*n+3*r,h=3*i-3*e;if(l===0){if(o===0)return;const y=-h/o;0<y&&y<1&&(t?this.addX(this.sumCubic(y,e,i,n,r)):this.addY(this.sumCubic(y,e,i,n,r)));return}const u=Math.pow(o,2)-4*h*l;if(u<0)return;const d=(-o+Math.sqrt(u))/(2*l);0<d&&d<1&&(t?this.addX(this.sumCubic(d,e,i,n,r)):this.addY(this.sumCubic(d,e,i,n,r)));const g=(-o-Math.sqrt(u))/(2*l);0<g&&g<1&&(t?this.addX(this.sumCubic(g,e,i,n,r)):this.addY(this.sumCubic(g,e,i,n,r)))}addBezierCurve(t,e,i,n,r,o,l,h){this.addPoint(t,e),this.addPoint(l,h),this.bezierCurveAdd(!0,t,i,r,l),this.bezierCurveAdd(!1,e,n,o,h)}addQuadraticCurve(t,e,i,n,r,o){const l=t+.6666666666666666*(i-t),h=e+2/3*(n-e),u=l+1/3*(r-t),d=h+1/3*(o-e);this.addBezierCurve(t,e,l,u,h,d,r,o)}isPointInBox(t,e){const{x1:i,y1:n,x2:r,y2:o}=this;return i<=t&&t<=r&&n<=e&&e<=o}constructor(t=Number.NaN,e=Number.NaN,i=Number.NaN,n=Number.NaN){this.x1=t,this.y1=e,this.x2=i,this.y2=n,this.addPoint(t,e),this.addPoint(i,n)}}class ka extends Yi{calculateOpacity(){let t=1,e=this;for(;e;){const i=e.getStyle("opacity",!1,!0);i.hasValue(!0)&&(t*=i.getNumber()),e=e.parent}return t}setContext(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e){const i=this.getStyle("fill"),n=this.getStyle("fill-opacity"),r=this.getStyle("stroke"),o=this.getStyle("stroke-opacity");if(i.isUrlDefinition()){const m=i.getFillStyleDefinition(this,n);m&&(t.fillStyle=m)}else if(i.hasValue()){i.getString()==="currentColor"&&i.setValue(this.getStyle("color").getColor());const m=i.getColor();m!=="inherit"&&(t.fillStyle=m==="none"?"rgba(0,0,0,0)":m)}if(n.hasValue()){const m=new se(this.document,"fill",t.fillStyle).addOpacity(n).getColor();t.fillStyle=m}if(r.isUrlDefinition()){const m=r.getFillStyleDefinition(this,o);m&&(t.strokeStyle=m)}else if(r.hasValue()){r.getString()==="currentColor"&&r.setValue(this.getStyle("color").getColor());const m=r.getString();m!=="inherit"&&(t.strokeStyle=m==="none"?"rgba(0,0,0,0)":m)}if(o.hasValue()){const m=new se(this.document,"stroke",t.strokeStyle).addOpacity(o).getString();t.strokeStyle=m}const l=this.getStyle("stroke-width");if(l.hasValue()){const m=l.getPixels();t.lineWidth=m||Ll}const h=this.getStyle("stroke-linecap"),u=this.getStyle("stroke-linejoin"),d=this.getStyle("stroke-miterlimit"),g=this.getStyle("stroke-dasharray"),y=this.getStyle("stroke-dashoffset");if(h.hasValue()&&(t.lineCap=h.getString()),u.hasValue()&&(t.lineJoin=u.getString()),d.hasValue()&&(t.miterLimit=d.getNumber()),g.hasValue()&&g.getString()!=="none"){const m=Bs(g.getString());typeof t.setLineDash<"u"?t.setLineDash(m):typeof t.webkitLineDash<"u"?t.webkitLineDash=m:typeof t.mozDash<"u"&&!(m.length===1&&m[0]===0)&&(t.mozDash=m);const I=y.getPixels();typeof t.lineDashOffset<"u"?t.lineDashOffset=I:typeof t.webkitLineDashOffset<"u"?t.webkitLineDashOffset=I:typeof t.mozDashOffset<"u"&&(t.mozDashOffset=I)}}if(this.modifiedEmSizeStack=!1,typeof t.font<"u"){const i=this.getStyle("font"),n=this.getStyle("font-style"),r=this.getStyle("font-variant"),o=this.getStyle("font-weight"),l=this.getStyle("font-size"),h=this.getStyle("font-family"),u=new us(n.getString(),r.getString(),o.getString(),l.hasValue()?"".concat(l.getPixels(!0),"px"):"",h.getString(),us.parse(i.getString(),t.font));n.setValue(u.fontStyle),r.setValue(u.fontVariant),o.setValue(u.fontWeight),l.setValue(u.fontSize),h.setValue(u.fontFamily),t.font=u.toString(),l.isPixels()&&(this.document.emSize=l.getPixels(),this.modifiedEmSizeStack=!0)}e||(this.applyEffects(t),t.globalAlpha=this.calculateOpacity())}clearContext(t){super.clearContext(t),this.modifiedEmSizeStack&&this.document.popEmSize()}constructor(...t){super(...t),this.modifiedEmSizeStack=!1}}class Ho extends ka{setContext(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;super.setContext(t,e);const i=this.getStyle("dominant-baseline").getTextBaseline()||this.getStyle("alignment-baseline").getTextBaseline();i&&(t.textBaseline=i)}initializeCoordinates(){this.x=0,this.y=0,this.leafTexts=[],this.textChunkStart=0,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY}getBoundingBox(t){if(this.type!=="text")return this.getTElementBoundingBox(t);this.initializeCoordinates(),this.adjustChildCoordinatesRecursive(t);let e=null;return this.children.forEach((i,n)=>{const r=this.getChildBoundingBox(t,this,this,n);e?e.addBoundingBox(r):e=r}),e}getFontSize(){const{document:t,parent:e}=this,i=us.parse(t.ctx.font).fontSize;return e.getStyle("font-size").getNumber(i)}getTElementBoundingBox(t){const e=this.getFontSize();return new wr(this.x,this.y-e,this.x+this.measureText(t),this.y)}getGlyph(t,e,i){const n=e[i];let r;if(t.isArabic){var o;const l=e.length,h=e[i-1],u=e[i+1];let d="isolated";(i===0||h===" ")&&i<l-1&&u!==" "&&(d="terminal"),i>0&&h!==" "&&i<l-1&&u!==" "&&(d="medial"),i>0&&h!==" "&&(i===l-1||u===" ")&&(d="initial"),r=((o=t.arabicGlyphs[n])===null||o===void 0?void 0:o[d])||t.glyphs[n]}else r=t.glyphs[n];return r||(r=t.missingGlyph),r}getText(){return""}getTextFromNode(t){const e=t||this.node,i=Array.from(e.parentNode.childNodes),n=i.indexOf(e),r=i.length-1;let o=Rl(e.textContent||"");return n===0&&(o=XI(o)),n===r&&(o=JI(o)),o}renderChildren(t){if(this.type!=="text"){this.renderTElementChildren(t);return}this.initializeCoordinates(),this.adjustChildCoordinatesRecursive(t),this.children.forEach((i,n)=>{this.renderChild(t,this,this,n)});const{mouse:e}=this.document.screen;e.isWorking()&&e.checkBoundingBox(this,this.getBoundingBox(t))}renderTElementChildren(t){const{document:e,parent:i}=this,n=this.getText(),r=i.getStyle("font-family").getDefinition();if(r){const{unitsPerEm:h}=r.fontFace,u=us.parse(e.ctx.font),d=i.getStyle("font-size").getNumber(u.fontSize),g=i.getStyle("font-style").getString(u.fontStyle),y=d/h,m=r.isRTL?n.split("").reverse().join(""):n,I=Bs(i.getAttribute("dx").getString()),b=m.length;for(let x=0;x<b;x++){const C=this.getGlyph(r,m,x);t.translate(this.x,this.y),t.scale(y,-y);const P=t.lineWidth;t.lineWidth=t.lineWidth*h/d,g==="italic"&&t.transform(1,0,.4,1,0,0),C.render(t),g==="italic"&&t.transform(1,0,-.4,1,0,0),t.lineWidth=P,t.scale(1/y,-1/y),t.translate(-this.x,-this.y),this.x+=d*(C.horizAdvX||r.horizAdvX)/h,typeof I[x]<"u"&&!isNaN(I[x])&&(this.x+=I[x])}return}const{x:o,y:l}=this;t.fillStyle&&t.fillText(n,o,l),t.strokeStyle&&t.strokeText(n,o,l)}applyAnchoring(){if(this.textChunkStart>=this.leafTexts.length)return;const t=this.leafTexts[this.textChunkStart],e=t.getStyle("text-anchor").getString("start"),i=!1;let n=0;e==="start"&&!i||e==="end"&&i?n=t.x-this.minX:e==="end"&&!i||e==="start"&&i?n=t.x-this.maxX:n=t.x-(this.minX+this.maxX)/2;for(let r=this.textChunkStart;r<this.leafTexts.length;r++)this.leafTexts[r].x+=n;this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.textChunkStart=this.leafTexts.length}adjustChildCoordinatesRecursive(t){this.children.forEach((e,i)=>{this.adjustChildCoordinatesRecursiveCore(t,this,this,i)}),this.applyAnchoring()}adjustChildCoordinatesRecursiveCore(t,e,i,n){const r=i.children[n];r.children.length>0?r.children.forEach((o,l)=>{e.adjustChildCoordinatesRecursiveCore(t,e,r,l)}):this.adjustChildCoordinates(t,e,i,n)}adjustChildCoordinates(t,e,i,n){const r=i.children[n];if(typeof r.measureText!="function")return r;t.save(),r.setContext(t,!0);const o=r.getAttribute("x"),l=r.getAttribute("y"),h=r.getAttribute("dx"),u=r.getAttribute("dy"),d=r.getStyle("font-family").getDefinition(),g=!!(d!=null&&d.isRTL);n===0&&(o.hasValue()||o.setValue(r.getInheritedAttribute("x")),l.hasValue()||l.setValue(r.getInheritedAttribute("y")),h.hasValue()||h.setValue(r.getInheritedAttribute("dx")),u.hasValue()||u.setValue(r.getInheritedAttribute("dy")));const y=r.measureText(t);return g&&(e.x-=y),o.hasValue()?(e.applyAnchoring(),r.x=o.getPixels("x"),h.hasValue()&&(r.x+=h.getPixels("x"))):(h.hasValue()&&(e.x+=h.getPixels("x")),r.x=e.x),e.x=r.x,g||(e.x+=y),l.hasValue()?(r.y=l.getPixels("y"),u.hasValue()&&(r.y+=u.getPixels("y"))):(u.hasValue()&&(e.y+=u.getPixels("y")),r.y=e.y),e.y=r.y,e.leafTexts.push(r),e.minX=Math.min(e.minX,r.x,r.x+y),e.maxX=Math.max(e.maxX,r.x,r.x+y),r.clearContext(t),t.restore(),r}getChildBoundingBox(t,e,i,n){const r=i.children[n];if(typeof r.getBoundingBox!="function")return null;const o=r.getBoundingBox(t);return o&&r.children.forEach((l,h)=>{const u=e.getChildBoundingBox(t,e,r,h);o.addBoundingBox(u)}),o}renderChild(t,e,i,n){const r=i.children[n];r.render(t),r.children.forEach((o,l)=>{e.renderChild(t,e,r,l)})}measureText(t){const{measureCache:e}=this;if(~e)return e;const i=this.getText(),n=this.measureTargetText(t,i);return this.measureCache=n,n}measureTargetText(t,e){if(!e.length)return 0;const{parent:i}=this,n=i.getStyle("font-family").getDefinition();if(n){const o=this.getFontSize(),l=n.isRTL?e.split("").reverse().join(""):e,h=Bs(i.getAttribute("dx").getString()),u=l.length;let d=0;for(let g=0;g<u;g++){const y=this.getGlyph(n,l,g);d+=(y.horizAdvX||n.horizAdvX)*o/n.fontFace.unitsPerEm,typeof h[g]<"u"&&!isNaN(h[g])&&(d+=h[g])}return d}if(!t.measureText)return e.length*10;t.save(),this.setContext(t,!0);const{width:r}=t.measureText(e);return this.clearContext(t),t.restore(),r}getInheritedAttribute(t){let e=this;for(;e instanceof Ho&&e.isFirstChild()&&e.parent;){const i=e.parent.getAttribute(t);if(i.hasValue(!0))return i.getString("0");e=e.parent}return null}constructor(t,e,i){super(t,e,new.target===Ho?!0:i),this.type="text",this.x=0,this.y=0,this.leafTexts=[],this.textChunkStart=0,this.minX=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.measureCache=-1}}class fd extends Ho{getText(){return this.text}constructor(t,e,i){super(t,e,new.target===fd?!0:i),this.type="tspan",this.text=this.children.length>0?"":this.getTextFromNode()}}class Cx extends fd{constructor(...t){super(...t),this.type="textNode"}}class Ce extends At{reset(){this.i=-1,this.command=null,this.previousCommand=null,this.start=new Hi(0,0),this.control=new Hi(0,0),this.current=new Hi(0,0),this.points=[],this.angles=[]}isEnd(){const{i:t,commands:e}=this;return t>=e.length-1}next(){const t=this.commands[++this.i];return this.previousCommand=this.command,this.command=t,t}getPoint(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"x",e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"y";const i=new Hi(this.command[t],this.command[e]);return this.makeAbsolute(i)}getAsControlPoint(t,e){const i=this.getPoint(t,e);return this.control=i,i}getAsCurrentPoint(t,e){const i=this.getPoint(t,e);return this.current=i,i}getReflectedControlPoint(){const t=this.previousCommand.type;if(t!==At.CURVE_TO&&t!==At.SMOOTH_CURVE_TO&&t!==At.QUAD_TO&&t!==At.SMOOTH_QUAD_TO)return this.current;const{current:{x:e,y:i},control:{x:n,y:r}}=this;return new Hi(2*e-n,2*i-r)}makeAbsolute(t){if(this.command.relative){const{x:e,y:i}=this.current;t.x+=e,t.y+=i}return t}addMarker(t,e,i){const{points:n,angles:r}=this;i&&r.length>0&&!r[r.length-1]&&(r[r.length-1]=n[n.length-1].angleTo(i)),this.addMarkerAngle(t,e?e.angleTo(t):null)}addMarkerAngle(t,e){this.points.push(t),this.angles.push(e)}getMarkerPoints(){return this.points}getMarkerAngles(){const{angles:t}=this,e=t.length;for(let i=0;i<e;i++)if(!t[i]){for(let n=i+1;n<e;n++)if(t[n]){t[i]=t[n];break}}return t}constructor(t){super(t.replace(/([+\-.])\s+/gm,"$1").replace(/[^MmZzLlHhVvCcSsQqTtAae\d\s.,+-].*/g,"")),this.control=new Hi(0,0),this.start=new Hi(0,0),this.current=new Hi(0,0),this.command=null,this.commands=this.commands,this.i=-1,this.previousCommand=null,this.points=[],this.angles=[]}}class vi extends ka{path(t){const{pathParser:e}=this,i=new wr;for(e.reset(),t&&t.beginPath();!e.isEnd();)switch(e.next().type){case Ce.MOVE_TO:this.pathM(t,i);break;case Ce.LINE_TO:this.pathL(t,i);break;case Ce.HORIZ_LINE_TO:this.pathH(t,i);break;case Ce.VERT_LINE_TO:this.pathV(t,i);break;case Ce.CURVE_TO:this.pathC(t,i);break;case Ce.SMOOTH_CURVE_TO:this.pathS(t,i);break;case Ce.QUAD_TO:this.pathQ(t,i);break;case Ce.SMOOTH_QUAD_TO:this.pathT(t,i);break;case Ce.ARC:this.pathA(t,i);break;case Ce.CLOSE_PATH:this.pathZ(t,i);break}return i}getBoundingBox(t){return this.path()}getMarkers(){const{pathParser:t}=this,e=t.getMarkerPoints(),i=t.getMarkerAngles();return e.map((r,o)=>[r,i[o]])}renderChildren(t){this.path(t),this.document.screen.mouse.checkPath(this,t);const e=this.getStyle("fill-rule");t.fillStyle!==""&&(e.getString("inherit")!=="inherit"?t.fill(e.getString()):t.fill()),t.strokeStyle!==""&&(this.getAttribute("vector-effect").getString()==="non-scaling-stroke"?(t.save(),t.setTransform(1,0,0,1,0,0),t.stroke(),t.restore()):t.stroke());const i=this.getMarkers();if(i){const n=i.length-1,r=this.getStyle("marker-start"),o=this.getStyle("marker-mid"),l=this.getStyle("marker-end");if(r.isUrlDefinition()){const h=r.getDefinition(),[u,d]=i[0];h.render(t,u,d)}if(o.isUrlDefinition()){const h=o.getDefinition();for(let u=1;u<n;u++){const[d,g]=i[u];h.render(t,d,g)}}if(l.isUrlDefinition()){const h=l.getDefinition(),[u,d]=i[n];h.render(t,u,d)}}}static pathM(t){const e=t.getAsCurrentPoint();return t.start=t.current,{point:e}}pathM(t,e){const{pathParser:i}=this,{point:n}=vi.pathM(i),{x:r,y:o}=n;i.addMarker(n),e.addPoint(r,o),t&&t.moveTo(r,o)}static pathL(t){const{current:e}=t,i=t.getAsCurrentPoint();return{current:e,point:i}}pathL(t,e){const{pathParser:i}=this,{current:n,point:r}=vi.pathL(i),{x:o,y:l}=r;i.addMarker(r,n),e.addPoint(o,l),t&&t.lineTo(o,l)}static pathH(t){const{current:e,command:i}=t,n=new Hi((i.relative?e.x:0)+i.x,e.y);return t.current=n,{current:e,point:n}}pathH(t,e){const{pathParser:i}=this,{current:n,point:r}=vi.pathH(i),{x:o,y:l}=r;i.addMarker(r,n),e.addPoint(o,l),t&&t.lineTo(o,l)}static pathV(t){const{current:e,command:i}=t,n=new Hi(e.x,(i.relative?e.y:0)+i.y);return t.current=n,{current:e,point:n}}pathV(t,e){const{pathParser:i}=this,{current:n,point:r}=vi.pathV(i),{x:o,y:l}=r;i.addMarker(r,n),e.addPoint(o,l),t&&t.lineTo(o,l)}static pathC(t){const{current:e}=t,i=t.getPoint("x1","y1"),n=t.getAsControlPoint("x2","y2"),r=t.getAsCurrentPoint();return{current:e,point:i,controlPoint:n,currentPoint:r}}pathC(t,e){const{pathParser:i}=this,{current:n,point:r,controlPoint:o,currentPoint:l}=vi.pathC(i);i.addMarker(l,o,r),e.addBezierCurve(n.x,n.y,r.x,r.y,o.x,o.y,l.x,l.y),t&&t.bezierCurveTo(r.x,r.y,o.x,o.y,l.x,l.y)}static pathS(t){const{current:e}=t,i=t.getReflectedControlPoint(),n=t.getAsControlPoint("x2","y2"),r=t.getAsCurrentPoint();return{current:e,point:i,controlPoint:n,currentPoint:r}}pathS(t,e){const{pathParser:i}=this,{current:n,point:r,controlPoint:o,currentPoint:l}=vi.pathS(i);i.addMarker(l,o,r),e.addBezierCurve(n.x,n.y,r.x,r.y,o.x,o.y,l.x,l.y),t&&t.bezierCurveTo(r.x,r.y,o.x,o.y,l.x,l.y)}static pathQ(t){const{current:e}=t,i=t.getAsControlPoint("x1","y1"),n=t.getAsCurrentPoint();return{current:e,controlPoint:i,currentPoint:n}}pathQ(t,e){const{pathParser:i}=this,{current:n,controlPoint:r,currentPoint:o}=vi.pathQ(i);i.addMarker(o,r,r),e.addQuadraticCurve(n.x,n.y,r.x,r.y,o.x,o.y),t&&t.quadraticCurveTo(r.x,r.y,o.x,o.y)}static pathT(t){const{current:e}=t,i=t.getReflectedControlPoint();t.control=i;const n=t.getAsCurrentPoint();return{current:e,controlPoint:i,currentPoint:n}}pathT(t,e){const{pathParser:i}=this,{current:n,controlPoint:r,currentPoint:o}=vi.pathT(i);i.addMarker(o,r,r),e.addQuadraticCurve(n.x,n.y,r.x,r.y,o.x,o.y),t&&t.quadraticCurveTo(r.x,r.y,o.x,o.y)}static pathA(t){const{current:e,command:i}=t;let{rX:n,rY:r,xRot:o,lArcFlag:l,sweepFlag:h}=i;const u=o*(Math.PI/180),d=t.getAsCurrentPoint(),g=new Hi(Math.cos(u)*(e.x-d.x)/2+Math.sin(u)*(e.y-d.y)/2,-Math.sin(u)*(e.x-d.x)/2+Math.cos(u)*(e.y-d.y)/2),y=Math.pow(g.x,2)/Math.pow(n,2)+Math.pow(g.y,2)/Math.pow(r,2);y>1&&(n*=Math.sqrt(y),r*=Math.sqrt(y));let m=(l===h?-1:1)*Math.sqrt((Math.pow(n,2)*Math.pow(r,2)-Math.pow(n,2)*Math.pow(g.y,2)-Math.pow(r,2)*Math.pow(g.x,2))/(Math.pow(n,2)*Math.pow(g.y,2)+Math.pow(r,2)*Math.pow(g.x,2)));isNaN(m)&&(m=0);const I=new Hi(m*n*g.y/r,m*-r*g.x/n),b=new Hi((e.x+d.x)/2+Math.cos(u)*I.x-Math.sin(u)*I.y,(e.y+d.y)/2+Math.sin(u)*I.x+Math.cos(u)*I.y),x=By([1,0],[(g.x-I.x)/n,(g.y-I.y)/r]),C=[(g.x-I.x)/n,(g.y-I.y)/r],P=[(-g.x-I.x)/n,(-g.y-I.y)/r];let k=By(C,P);return Pg(C,P)<=-1&&(k=Math.PI),Pg(C,P)>=1&&(k=0),{currentPoint:d,rX:n,rY:r,sweepFlag:h,xAxisRotation:u,centp:b,a1:x,ad:k}}pathA(t,e){const{pathParser:i}=this,{currentPoint:n,rX:r,rY:o,sweepFlag:l,xAxisRotation:h,centp:u,a1:d,ad:g}=vi.pathA(i),y=1-l?1:-1,m=d+y*(g/2),I=new Hi(u.x+r*Math.cos(m),u.y+o*Math.sin(m));if(i.addMarkerAngle(I,m-y*Math.PI/2),i.addMarkerAngle(n,m-y*Math.PI),e.addPoint(n.x,n.y),t&&!isNaN(d)&&!isNaN(g)){const b=r>o?r:o,x=r>o?1:r/o,C=r>o?o/r:1;t.translate(u.x,u.y),t.rotate(h),t.scale(x,C),t.arc(0,0,b,d,d+g,!!(1-l)),t.scale(1/x,1/C),t.rotate(-h),t.translate(-u.x,-u.y)}}static pathZ(t){t.current=t.start}pathZ(t,e){vi.pathZ(this.pathParser),t&&e.x1!==e.x2&&e.y1!==e.y2&&t.closePath()}constructor(t,e,i){super(t,e,i),this.type="path",this.pathParser=new Ce(this.getAttribute("d").getString())}}class ph extends ka{setContext(t){var e;const{document:i}=this,{screen:n,window:r}=i,o=t.canvas;if(n.setDefaults(t),"style"in o&&typeof t.font<"u"&&r&&typeof r.getComputedStyle<"u"){t.font=r.getComputedStyle(o).getPropertyValue("font");const P=new se(i,"fontSize",us.parse(t.font).fontSize);P.hasValue()&&(i.rootEmSize=P.getPixels("y"),i.emSize=i.rootEmSize)}this.getAttribute("x").hasValue()||this.getAttribute("x",!0).setValue(0),this.getAttribute("y").hasValue()||this.getAttribute("y",!0).setValue(0);let{width:l,height:h}=n.viewPort;this.getStyle("width").hasValue()||this.getStyle("width",!0).setValue("100%"),this.getStyle("height").hasValue()||this.getStyle("height",!0).setValue("100%"),this.getStyle("color").hasValue()||this.getStyle("color",!0).setValue("black");const u=this.getAttribute("refX"),d=this.getAttribute("refY"),g=this.getAttribute("viewBox"),y=g.hasValue()?Bs(g.getString()):null,m=!this.root&&this.getStyle("overflow").getValue("hidden")!=="visible";let I=0,b=0,x=0,C=0;y&&(I=y[0],b=y[1]),this.root||(l=this.getStyle("width").getPixels("x"),h=this.getStyle("height").getPixels("y"),this.type==="marker"&&(x=I,C=b,I=0,b=0)),n.viewPort.setCurrent(l,h),this.node&&(!this.parent||((e=this.node.parentNode)===null||e===void 0?void 0:e.nodeName)==="foreignObject")&&this.getStyle("transform",!1,!0).hasValue()&&!this.getStyle("transform-origin",!1,!0).hasValue()&&this.getStyle("transform-origin",!0,!0).setValue("50% 50%"),super.setContext(t),t.translate(this.getAttribute("x").getPixels("x"),this.getAttribute("y").getPixels("y")),y&&(l=y[2],h=y[3]),i.setViewBox({ctx:t,aspectRatio:this.getAttribute("preserveAspectRatio").getString(),width:n.viewPort.width,desiredWidth:l,height:n.viewPort.height,desiredHeight:h,minX:I,minY:b,refX:u.getValue(),refY:d.getValue(),clip:m,clipX:x,clipY:C}),y&&(n.viewPort.removeCurrent(),n.viewPort.setCurrent(l,h))}clearContext(t){super.clearContext(t),this.document.screen.viewPort.removeCurrent()}resize(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:t,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;const n=this.getAttribute("width",!0),r=this.getAttribute("height",!0),o=this.getAttribute("viewBox"),l=this.getAttribute("style"),h=n.getNumber(0),u=r.getNumber(0);if(i)if(typeof i=="string")this.getAttribute("preserveAspectRatio",!0).setValue(i);else{const d=this.getAttribute("preserveAspectRatio");d.hasValue()&&d.setValue(d.getString().replace(/^\s*(\S.*\S)\s*$/,"$1"))}if(n.setValue(t),r.setValue(e),o.hasValue()||o.setValue("0 0 ".concat(h||t," ").concat(u||e)),l.hasValue()){const d=this.getStyle("width"),g=this.getStyle("height");d.hasValue()&&d.setValue("".concat(t,"px")),g.hasValue()&&g.setValue("".concat(e,"px"))}}constructor(...t){super(...t),this.type="svg",this.root=!1}}class Yy extends vi{path(t){const e=this.getAttribute("x").getPixels("x"),i=this.getAttribute("y").getPixels("y"),n=this.getStyle("width",!1,!0).getPixels("x"),r=this.getStyle("height",!1,!0).getPixels("y"),o=this.getAttribute("rx"),l=this.getAttribute("ry");let h=o.getPixels("x"),u=l.getPixels("y");if(o.hasValue()&&!l.hasValue()&&(u=h),l.hasValue()&&!o.hasValue()&&(h=u),h=Math.min(h,n/2),u=Math.min(u,r/2),t){const d=4*((Math.sqrt(2)-1)/3);t.beginPath(),r>0&&n>0&&(t.moveTo(e+h,i),t.lineTo(e+n-h,i),t.bezierCurveTo(e+n-h+d*h,i,e+n,i+u-d*u,e+n,i+u),t.lineTo(e+n,i+r-u),t.bezierCurveTo(e+n,i+r-u+d*u,e+n-h+d*h,i+r,e+n-h,i+r),t.lineTo(e+h,i+r),t.bezierCurveTo(e+h-d*h,i+r,e,i+r-u+d*u,e,i+r-u),t.lineTo(e,i+u),t.bezierCurveTo(e,i+u-d*u,e+h-d*h,i,e+h,i),t.closePath())}return new wr(e,i,e+n,i+r)}getMarkers(){return null}constructor(...t){super(...t),this.type="rect"}}class Sx extends vi{path(t){const e=this.getAttribute("cx").getPixels("x"),i=this.getAttribute("cy").getPixels("y"),n=this.getAttribute("r").getPixels();return t&&n>0&&(t.beginPath(),t.arc(e,i,n,0,Math.PI*2,!1),t.closePath()),new wr(e-n,i-n,e+n,i+n)}getMarkers(){return null}constructor(...t){super(...t),this.type="circle"}}class Px extends vi{path(t){const e=4*((Math.sqrt(2)-1)/3),i=this.getAttribute("rx").getPixels("x"),n=this.getAttribute("ry").getPixels("y"),r=this.getAttribute("cx").getPixels("x"),o=this.getAttribute("cy").getPixels("y");return t&&i>0&&n>0&&(t.beginPath(),t.moveTo(r+i,o),t.bezierCurveTo(r+i,o+e*n,r+e*i,o+n,r,o+n),t.bezierCurveTo(r-e*i,o+n,r-i,o+e*n,r-i,o),t.bezierCurveTo(r-i,o-e*n,r-e*i,o-n,r,o-n),t.bezierCurveTo(r+e*i,o-n,r+i,o-e*n,r+i,o),t.closePath()),new wr(r-i,o-n,r+i,o+n)}getMarkers(){return null}constructor(...t){super(...t),this.type="ellipse"}}class kx extends vi{getPoints(){return[new Hi(this.getAttribute("x1").getPixels("x"),this.getAttribute("y1").getPixels("y")),new Hi(this.getAttribute("x2").getPixels("x"),this.getAttribute("y2").getPixels("y"))]}path(t){const[{x:e,y:i},{x:n,y:r}]=this.getPoints();return t&&(t.beginPath(),t.moveTo(e,i),t.lineTo(n,r)),new wr(e,i,n,r)}getMarkers(){const[t,e]=this.getPoints(),i=t.angleTo(e);return[[t,i],[e,i]]}constructor(...t){super(...t),this.type="line"}}class Zy extends vi{path(t){const{points:e}=this,[{x:i,y:n}]=e,r=new wr(i,n);return t&&(t.beginPath(),t.moveTo(i,n)),e.forEach(o=>{let{x:l,y:h}=o;r.addPoint(l,h),t&&t.lineTo(l,h)}),r}getMarkers(){const{points:t}=this,e=t.length-1,i=[];return t.forEach((n,r)=>{r!==e&&i.push([n,n.angleTo(t[r+1])])}),i.length>0&&i.push([t[t.length-1],i[i.length-1][1]]),i}constructor(t,e,i){super(t,e,i),this.type="polyline",this.points=[],this.points=Hi.parsePath(this.getAttribute("points").getString())}}class Mx extends Zy{path(t){const e=super.path(t),[{x:i,y:n}]=this.points;return t&&(t.lineTo(i,n),t.closePath()),e}constructor(...t){super(...t),this.type="polygon"}}class Ex extends Yi{createPattern(t,e,i){const n=this.getStyle("width").getPixels("x",!0),r=this.getStyle("height").getPixels("y",!0),o=new ph(this.document,null);o.attributes.viewBox=new se(this.document,"viewBox",this.getAttribute("viewBox").getValue()),o.attributes.width=new se(this.document,"width","".concat(n,"px")),o.attributes.height=new se(this.document,"height","".concat(r,"px")),o.attributes.transform=new se(this.document,"transform",this.getAttribute("patternTransform").getValue()),o.children=this.children;const l=this.document.createCanvas(n,r),h=l.getContext("2d"),u=this.getAttribute("x"),d=this.getAttribute("y");u.hasValue()&&d.hasValue()&&h.translate(u.getPixels("x",!0),d.getPixels("y",!0)),i.hasValue()?this.styles["fill-opacity"]=i:Reflect.deleteProperty(this.styles,"fill-opacity");for(let y=-1;y<=1;y++)for(let m=-1;m<=1;m++)h.save(),o.attributes.x=new se(this.document,"x",y*l.width),o.attributes.y=new se(this.document,"y",m*l.height),o.render(h),h.restore();return t.createPattern(l,"repeat")}constructor(...t){super(...t),this.type="pattern"}}class Ax extends Yi{render(t,e,i){if(!e)return;const{x:n,y:r}=e,o=this.getAttribute("orient").getString("auto"),l=this.getAttribute("markerUnits").getString("strokeWidth");t.translate(n,r),o==="auto"&&t.rotate(i),l==="strokeWidth"&&t.scale(t.lineWidth,t.lineWidth),t.save();const h=new ph(this.document);h.type=this.type,h.attributes.viewBox=new se(this.document,"viewBox",this.getAttribute("viewBox").getValue()),h.attributes.refX=new se(this.document,"refX",this.getAttribute("refX").getValue()),h.attributes.refY=new se(this.document,"refY",this.getAttribute("refY").getValue()),h.attributes.width=new se(this.document,"width",this.getAttribute("markerWidth").getValue()),h.attributes.height=new se(this.document,"height",this.getAttribute("markerHeight").getValue()),h.attributes.overflow=new se(this.document,"overflow",this.getAttribute("overflow").getValue()),h.attributes.fill=new se(this.document,"fill",this.getAttribute("fill").getColor("black")),h.attributes.stroke=new se(this.document,"stroke",this.getAttribute("stroke").getValue("none")),h.children=this.children,h.render(t),t.restore(),l==="strokeWidth"&&t.scale(1/t.lineWidth,1/t.lineWidth),o==="auto"&&t.rotate(-i),t.translate(-n,-r)}constructor(...t){super(...t),this.type="marker"}}class Tx extends Yi{render(){}constructor(...t){super(...t),this.type="defs"}}class Mg extends ka{getBoundingBox(t){const e=new wr;return this.children.forEach(i=>{e.addBoundingBox(i.getBoundingBox(t))}),e}constructor(...t){super(...t),this.type="g"}}class Qy extends Yi{getGradientUnits(){return this.getAttribute("gradientUnits").getString("objectBoundingBox")}createGradient(t,e,i){let n=this;this.getHrefAttribute().hasValue()&&(n=this.getHrefAttribute().getDefinition(),this.inheritStopContainer(n));const{stops:r}=n,o=this.getGradient(t,e);if(!o)return this.addParentOpacity(i,r[r.length-1].color);if(r.forEach(l=>{o.addColorStop(l.offset,this.addParentOpacity(i,l.color))}),this.getAttribute("gradientTransform").hasValue()){const{document:l}=this,{MAX_VIRTUAL_PIXELS:h}=mo,{viewPort:u}=l.screen,d=u.getRoot(),g=new Yy(l);g.attributes.x=new se(l,"x",-h/3),g.attributes.y=new se(l,"y",-h/3),g.attributes.width=new se(l,"width",h),g.attributes.height=new se(l,"height",h);const y=new Mg(l);y.attributes.transform=new se(l,"transform",this.getAttribute("gradientTransform").getValue()),y.children=[g];const m=new ph(l);m.attributes.x=new se(l,"x",0),m.attributes.y=new se(l,"y",0),m.attributes.width=new se(l,"width",d.width),m.attributes.height=new se(l,"height",d.height),m.children=[y];const I=l.createCanvas(d.width,d.height),b=I.getContext("2d");return b.fillStyle=o,m.render(b),b.createPattern(I,"no-repeat")}return o}inheritStopContainer(t){this.attributesToInherit.forEach(e=>{!this.getAttribute(e).hasValue()&&t.getAttribute(e).hasValue()&&this.getAttribute(e,!0).setValue(t.getAttribute(e).getValue())})}addParentOpacity(t,e){return t.hasValue()?new se(this.document,"color",e).addOpacity(t).getColor():e}constructor(t,e,i){super(t,e,i),this.attributesToInherit=["gradientUnits"],this.stops=[];const{stops:n,children:r}=this;r.forEach(o=>{o.type==="stop"&&n.push(o)})}}class Nx extends Qy{getGradient(t,e){const i=this.getGradientUnits()==="objectBoundingBox",n=i?e.getBoundingBox(t):null;if(i&&!n)return null;!this.getAttribute("x1").hasValue()&&!this.getAttribute("y1").hasValue()&&!this.getAttribute("x2").hasValue()&&!this.getAttribute("y2").hasValue()&&(this.getAttribute("x1",!0).setValue(0),this.getAttribute("y1",!0).setValue(0),this.getAttribute("x2",!0).setValue(1),this.getAttribute("y2",!0).setValue(0));const r=i?n.x+n.width*this.getAttribute("x1").getNumber():this.getAttribute("x1").getPixels("x"),o=i?n.y+n.height*this.getAttribute("y1").getNumber():this.getAttribute("y1").getPixels("y"),l=i?n.x+n.width*this.getAttribute("x2").getNumber():this.getAttribute("x2").getPixels("x"),h=i?n.y+n.height*this.getAttribute("y2").getNumber():this.getAttribute("y2").getPixels("y");return r===l&&o===h?null:t.createLinearGradient(r,o,l,h)}constructor(t,e,i){super(t,e,i),this.type="linearGradient",this.attributesToInherit.push("x1","y1","x2","y2")}}class Dx extends Qy{getGradient(t,e){const i=this.getGradientUnits()==="objectBoundingBox",n=e.getBoundingBox(t);if(i&&!n)return null;this.getAttribute("cx").hasValue()||this.getAttribute("cx",!0).setValue("50%"),this.getAttribute("cy").hasValue()||this.getAttribute("cy",!0).setValue("50%"),this.getAttribute("r").hasValue()||this.getAttribute("r",!0).setValue("50%");const r=i?n.x+n.width*this.getAttribute("cx").getNumber():this.getAttribute("cx").getPixels("x"),o=i?n.y+n.height*this.getAttribute("cy").getNumber():this.getAttribute("cy").getPixels("y");let l=r,h=o;this.getAttribute("fx").hasValue()&&(l=i?n.x+n.width*this.getAttribute("fx").getNumber():this.getAttribute("fx").getPixels("x")),this.getAttribute("fy").hasValue()&&(h=i?n.y+n.height*this.getAttribute("fy").getNumber():this.getAttribute("fy").getPixels("y"));const u=i?(n.width+n.height)/2*this.getAttribute("r").getNumber():this.getAttribute("r").getPixels(),d=this.getAttribute("fr").getPixels();return t.createRadialGradient(l,h,d,r,o,u)}constructor(t,e,i){super(t,e,i),this.type="radialGradient",this.attributesToInherit.push("cx","cy","r","fx","fy","fr")}}class Ox extends Yi{constructor(t,e,i){super(t,e,i),this.type="stop";const n=Math.max(0,Math.min(1,this.getAttribute("offset").getNumber())),r=this.getStyle("stop-opacity");let o=this.getStyle("stop-color",!0);o.getString()===""&&o.setValue("#000"),r.hasValue()&&(o=o.addOpacity(r)),this.offset=n,this.color=o.getColor()}}class Eg extends Yi{getProperty(){const t=this.getAttribute("attributeType").getString(),e=this.getAttribute("attributeName").getString();return t==="CSS"?this.parent.getStyle(e,!0):this.parent.getAttribute(e,!0)}calcValue(){const{initialUnits:t}=this,{progress:e,from:i,to:n}=this.getProgress();let r=i.getNumber()+(n.getNumber()-i.getNumber())*e;return t==="%"&&(r*=100),"".concat(r).concat(t)}update(t){const{parent:e}=this,i=this.getProperty();if(this.initialValue||(this.initialValue=i.getString(),this.initialUnits=i.getUnits()),this.duration>this.maxDuration){const r=this.getAttribute("fill").getString("remove");if(this.getAttribute("repeatCount").getString()==="indefinite"||this.getAttribute("repeatDur").getString()==="indefinite")this.duration=0;else if(r==="freeze"&&!this.frozen)this.frozen=!0,e&&i&&(e.animationFrozen=!0,e.animationFrozenValue=i.getString());else if(r==="remove"&&!this.removed)return this.removed=!0,e&&i&&i.setValue(e.animationFrozen?e.animationFrozenValue:this.initialValue),!0;return!1}this.duration+=t;let n=!1;if(this.begin<this.duration){let r=this.calcValue();const o=this.getAttribute("type");if(o.hasValue()){const l=o.getString();r="".concat(l,"(").concat(r,")")}i.setValue(r),n=!0}return n}getProgress(){const{document:t,values:e}=this;let i=(this.duration-this.begin)/(this.maxDuration-this.begin),n,r;if(e.hasValue()){const o=i*(e.getValue().length-1),l=Math.floor(o),h=Math.ceil(o);let u;u=e.getValue()[l],n=new se(t,"from",u?parseFloat(u):0),u=e.getValue()[h],r=new se(t,"to",u?parseFloat(u):0),i=(o-l)/(h-l)}else n=this.from,r=this.to;return{progress:i,from:n,to:r}}constructor(t,e,i){super(t,e,i),this.type="animate",this.duration=0,this.initialUnits="",this.removed=!1,this.frozen=!1,t.screen.animations.push(this),this.begin=this.getAttribute("begin").getMilliseconds(),this.maxDuration=this.begin+this.getAttribute("dur").getMilliseconds(),this.from=this.getAttribute("from"),this.to=this.getAttribute("to"),this.values=new se(t,"values",null);const n=this.getAttribute("values");n.hasValue()&&this.values.setValue(n.getString().split(";"))}}class Rx extends Eg{calcValue(){const{progress:t,from:e,to:i}=this.getProgress(),n=new xg(e.getColor()),r=new xg(i.getColor());if(n.ok&&r.ok){const o=n.r+(r.r-n.r)*t,l=n.g+(r.g-n.g)*t,h=n.b+(r.b-n.b)*t;return"rgb(".concat(Math.floor(o),", ").concat(Math.floor(l),", ").concat(Math.floor(h),")")}return this.getAttribute("from").getColor()}constructor(...t){super(...t),this.type="animateColor"}}class Lx extends Eg{calcValue(){const{progress:t,from:e,to:i}=this.getProgress(),n=Bs(e.getString()),r=Bs(i.getString());return n.map((l,h)=>{const u=r[h];return l+(u-l)*t}).join(" ")}constructor(...t){super(...t),this.type="animateTransform"}}class tw extends Yi{constructor(t,e,i){super(t,e,i),this.type="font-face",this.ascent=this.getAttribute("ascent").getNumber(),this.descent=this.getAttribute("descent").getNumber(),this.unitsPerEm=this.getAttribute("units-per-em").getNumber()}}class Ag extends vi{constructor(t,e,i){super(t,e,i),this.type="glyph",this.horizAdvX=this.getAttribute("horiz-adv-x").getNumber(),this.unicode=this.getAttribute("unicode").getString(),this.arabicForm=this.getAttribute("arabic-form").getString()}}class ew extends Ag{constructor(...t){super(...t),this.type="missing-glyph",this.horizAdvX=0}}class Fx extends Yi{render(){}constructor(t,e,i){super(t,e,i),this.type="font",this.isArabic=!1,this.glyphs={},this.arabicGlyphs={},this.isRTL=!1,this.horizAdvX=this.getAttribute("horiz-adv-x").getNumber();const{definitions:n}=t,{children:r}=this;for(const o of r)if(o instanceof tw){this.fontFace=o;const l=o.getStyle("font-family");l.hasValue()&&(n[l.getString()]=this)}else if(o instanceof ew)this.missingGlyph=o;else if(o instanceof Ag)if(o.arabicForm){this.isRTL=!0,this.isArabic=!0;const l=this.arabicGlyphs[o.unicode];typeof l>"u"?this.arabicGlyphs[o.unicode]={[o.arabicForm]:o}:l[o.arabicForm]=o}else this.glyphs[o.unicode]=o}}class Bx extends Ho{getText(){const t=this.getHrefAttribute().getDefinition();if(t){const e=t.children[0];if(e)return e.getText()}return""}constructor(...t){super(...t),this.type="tref"}}class Vx extends Ho{getText(){return this.text}renderChildren(t){if(this.hasText){super.renderChildren(t);const{document:e,x:i,y:n}=this,{mouse:r}=e.screen,o=new se(e,"fontSize",us.parse(e.ctx.font).fontSize);r.isWorking()&&r.checkBoundingBox(this,new wr(i,n-o.getPixels("y"),i+this.measureText(t),n))}else if(this.children.length>0){const e=new Mg(this.document);e.children=this.children,e.parent=this,e.render(t)}}onClick(){const{window:t}=this.document;t&&t.open(this.getHrefAttribute().getString())}onMouseMove(){const t=this.document.ctx;t.canvas.style.cursor="pointer"}constructor(t,e,i){super(t,e,i),this.type="a";const{childNodes:n}=e,r=n[0],o=n.length>0&&Array.from(n).every(l=>l.nodeType===3);this.hasText=o,this.text=o?this.getTextFromNode(r):""}}class zx extends Ho{getText(){return this.text}path(t){const{dataArray:e}=this;t&&t.beginPath(),e.forEach(i=>{let{type:n,points:r}=i;switch(n){case Ce.LINE_TO:t&&t.lineTo(r[0],r[1]);break;case Ce.MOVE_TO:t&&t.moveTo(r[0],r[1]);break;case Ce.CURVE_TO:t&&t.bezierCurveTo(r[0],r[1],r[2],r[3],r[4],r[5]);break;case Ce.QUAD_TO:t&&t.quadraticCurveTo(r[0],r[1],r[2],r[3]);break;case Ce.ARC:{const[o,l,h,u,d,g,y,m]=r,I=h>u?h:u,b=h>u?1:h/u,x=h>u?u/h:1;t&&(t.translate(o,l),t.rotate(y),t.scale(b,x),t.arc(0,0,I,d,d+g,!!(1-m)),t.scale(1/b,1/x),t.rotate(-y),t.translate(-o,-l));break}case Ce.CLOSE_PATH:t&&t.closePath();break}})}renderChildren(t){this.setTextData(t),t.save();const e=this.parent.getStyle("text-decoration").getString(),i=this.getFontSize(),{glyphInfo:n}=this,r=t.fillStyle;e==="underline"&&t.beginPath(),n.forEach((o,l)=>{const{p0:h,p1:u,rotation:d,text:g}=o;t.save(),t.translate(h.x,h.y),t.rotate(d),t.fillStyle&&t.fillText(g,0,0),t.strokeStyle&&t.strokeText(g,0,0),t.restore(),e==="underline"&&(l===0&&t.moveTo(h.x,h.y+i/8),t.lineTo(u.x,u.y+i/5))}),e==="underline"&&(t.lineWidth=i/20,t.strokeStyle=r,t.stroke(),t.closePath()),t.restore()}getLetterSpacingAt(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.letterSpacingCache[t]||0}findSegmentToFitChar(t,e,i,n,r,o,l,h,u){let d=o,g=this.measureText(t,h);h===" "&&e==="justify"&&i<n&&(g+=(n-i)/r),u>-1&&(d+=this.getLetterSpacingAt(u));const y=this.textHeight/20,m=this.getEquidistantPointOnPath(d,y,0),I=this.getEquidistantPointOnPath(d+g,y,0),b={p0:m,p1:I},x=m&&I?Math.atan2(I.y-m.y,I.x-m.x):0;if(l){const C=Math.cos(Math.PI/2+x)*l,P=Math.cos(-x)*l;b.p0={...m,x:m.x+C,y:m.y+P},b.p1={...I,x:I.x+C,y:I.y+P}}return d+=g,{offset:d,segment:b,rotation:x}}measureText(t,e){const{measuresCache:i}=this,n=e||this.getText();if(i.has(n))return i.get(n);const r=this.measureTargetText(t,n);return i.set(n,r),r}setTextData(t){if(this.glyphInfo)return;const e=this.getText(),i=e.split(""),n=e.split(" ").length-1,r=this.parent.getAttribute("dx").split().map(k=>k.getPixels("x")),o=this.parent.getAttribute("dy").getPixels("y"),l=this.parent.getStyle("text-anchor").getString("start"),h=this.getStyle("letter-spacing"),u=this.parent.getStyle("letter-spacing");let d=0;!h.hasValue()||h.getValue()==="inherit"?d=u.getPixels():h.hasValue()&&h.getValue()!=="initial"&&h.getValue()!=="unset"&&(d=h.getPixels());const g=[],y=e.length;this.letterSpacingCache=g;for(let k=0;k<y;k++)g.push(typeof r[k]<"u"?r[k]:d);const m=g.reduce((k,O,B)=>B===0?0:k+O||0,0),I=this.measureText(t),b=Math.max(I+m,0);this.textWidth=I,this.textHeight=this.getFontSize(),this.glyphInfo=[];const x=this.getPathLength(),C=this.getStyle("startOffset").getNumber(0)*x;let P=0;(l==="middle"||l==="center")&&(P=-b/2),(l==="end"||l==="right")&&(P=-b),P+=C,i.forEach((k,O)=>{const{offset:B,segment:j,rotation:V}=this.findSegmentToFitChar(t,l,b,x,n,P,o,k,O);P=B,!(!j.p0||!j.p1)&&this.glyphInfo.push({text:i[O],p0:j.p0,p1:j.p1,rotation:V})})}parsePathData(t){if(this.pathLength=-1,!t)return[];const e=[],{pathParser:i}=t;for(i.reset();!i.isEnd();){const{current:n}=i,r=n?n.x:0,o=n?n.y:0,l=i.next();let h=l.type,u=[];switch(l.type){case Ce.MOVE_TO:this.pathM(i,u);break;case Ce.LINE_TO:h=this.pathL(i,u);break;case Ce.HORIZ_LINE_TO:h=this.pathH(i,u);break;case Ce.VERT_LINE_TO:h=this.pathV(i,u);break;case Ce.CURVE_TO:this.pathC(i,u);break;case Ce.SMOOTH_CURVE_TO:h=this.pathS(i,u);break;case Ce.QUAD_TO:this.pathQ(i,u);break;case Ce.SMOOTH_QUAD_TO:h=this.pathT(i,u);break;case Ce.ARC:u=this.pathA(i);break;case Ce.CLOSE_PATH:vi.pathZ(i);break}l.type!==Ce.CLOSE_PATH?e.push({type:h,points:u,start:{x:r,y:o},pathLength:this.calcLength(r,o,h,u)}):e.push({type:Ce.CLOSE_PATH,points:[],pathLength:0})}return e}pathM(t,e){const{x:i,y:n}=vi.pathM(t).point;e.push(i,n)}pathL(t,e){const{x:i,y:n}=vi.pathL(t).point;return e.push(i,n),Ce.LINE_TO}pathH(t,e){const{x:i,y:n}=vi.pathH(t).point;return e.push(i,n),Ce.LINE_TO}pathV(t,e){const{x:i,y:n}=vi.pathV(t).point;return e.push(i,n),Ce.LINE_TO}pathC(t,e){const{point:i,controlPoint:n,currentPoint:r}=vi.pathC(t);e.push(i.x,i.y,n.x,n.y,r.x,r.y)}pathS(t,e){const{point:i,controlPoint:n,currentPoint:r}=vi.pathS(t);return e.push(i.x,i.y,n.x,n.y,r.x,r.y),Ce.CURVE_TO}pathQ(t,e){const{controlPoint:i,currentPoint:n}=vi.pathQ(t);e.push(i.x,i.y,n.x,n.y)}pathT(t,e){const{controlPoint:i,currentPoint:n}=vi.pathT(t);return e.push(i.x,i.y,n.x,n.y),Ce.QUAD_TO}pathA(t){let{rX:e,rY:i,sweepFlag:n,xAxisRotation:r,centp:o,a1:l,ad:h}=vi.pathA(t);return n===0&&h>0&&(h-=2*Math.PI),n===1&&h<0&&(h+=2*Math.PI),[o.x,o.y,e,i,l,h,r,n]}calcLength(t,e,i,n){let r=0,o=null,l=null,h=0;switch(i){case Ce.LINE_TO:return this.getLineLength(t,e,n[0],n[1]);case Ce.CURVE_TO:for(r=0,o=this.getPointOnCubicBezier(0,t,e,n[0],n[1],n[2],n[3],n[4],n[5]),h=.01;h<=1;h+=.01)l=this.getPointOnCubicBezier(h,t,e,n[0],n[1],n[2],n[3],n[4],n[5]),r+=this.getLineLength(o.x,o.y,l.x,l.y),o=l;return r;case Ce.QUAD_TO:for(r=0,o=this.getPointOnQuadraticBezier(0,t,e,n[0],n[1],n[2],n[3]),h=.01;h<=1;h+=.01)l=this.getPointOnQuadraticBezier(h,t,e,n[0],n[1],n[2],n[3]),r+=this.getLineLength(o.x,o.y,l.x,l.y),o=l;return r;case Ce.ARC:{r=0;const u=n[4],d=n[5],g=n[4]+d;let y=Math.PI/180;if(Math.abs(u-g)<y&&(y=Math.abs(u-g)),o=this.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],u,0),d<0)for(h=u-y;h>g;h-=y)l=this.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],h,0),r+=this.getLineLength(o.x,o.y,l.x,l.y),o=l;else for(h=u+y;h<g;h+=y)l=this.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],h,0),r+=this.getLineLength(o.x,o.y,l.x,l.y),o=l;return l=this.getPointOnEllipticalArc(n[0],n[1],n[2],n[3],g,0),r+=this.getLineLength(o.x,o.y,l.x,l.y),r}}return 0}getPointOnLine(t,e,i,n,r){let o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:e,l=arguments.length>6&&arguments[6]!==void 0?arguments[6]:i;const h=(r-i)/(n-e+Ll);let u=Math.sqrt(t*t/(1+h*h));n<e&&(u*=-1);let d=h*u,g=null;if(n===e)g={x:o,y:l+d};else if((l-i)/(o-e+Ll)===h)g={x:o+u,y:l+d};else{let y=0,m=0;const I=this.getLineLength(e,i,n,r);if(I<Ll)return null;let b=(o-e)*(n-e)+(l-i)*(r-i);b/=I*I,y=e+b*(n-e),m=i+b*(r-i);const x=this.getLineLength(o,l,y,m),C=Math.sqrt(t*t-x*x);u=Math.sqrt(C*C/(1+h*h)),n<e&&(u*=-1),d=h*u,g={x:y+u,y:m+d}}return g}getPointOnPath(t){const e=this.getPathLength();let i=0,n=null;if(t<-5e-5||t-5e-5>e)return null;const{dataArray:r}=this;for(const o of r){if(o&&(o.pathLength<5e-5||i+o.pathLength+5e-5<t)){i+=o.pathLength;continue}const l=t-i;let h=0;switch(o.type){case Ce.LINE_TO:n=this.getPointOnLine(l,o.start.x,o.start.y,o.points[0],o.points[1],o.start.x,o.start.y);break;case Ce.ARC:{const u=o.points[4],d=o.points[5],g=o.points[4]+d;if(h=u+l/o.pathLength*d,d<0&&h<g||d>=0&&h>g)break;n=this.getPointOnEllipticalArc(o.points[0],o.points[1],o.points[2],o.points[3],h,o.points[6]);break}case Ce.CURVE_TO:h=l/o.pathLength,h>1&&(h=1),n=this.getPointOnCubicBezier(h,o.start.x,o.start.y,o.points[0],o.points[1],o.points[2],o.points[3],o.points[4],o.points[5]);break;case Ce.QUAD_TO:h=l/o.pathLength,h>1&&(h=1),n=this.getPointOnQuadraticBezier(h,o.start.x,o.start.y,o.points[0],o.points[1],o.points[2],o.points[3]);break}if(n)return n;break}return null}getLineLength(t,e,i,n){return Math.sqrt((i-t)*(i-t)+(n-e)*(n-e))}getPathLength(){return this.pathLength===-1&&(this.pathLength=this.dataArray.reduce((t,e)=>e.pathLength>0?t+e.pathLength:t,0)),this.pathLength}getPointOnCubicBezier(t,e,i,n,r,o,l,h,u){const d=h*Vy(t)+o*zy(t)+n*Hy(t)+e*Uy(t),g=u*Vy(t)+l*zy(t)+r*Hy(t)+i*Uy(t);return{x:d,y:g}}getPointOnQuadraticBezier(t,e,i,n,r,o,l){const h=o*jy(t)+n*Wy(t)+e*Gy(t),u=l*jy(t)+r*Wy(t)+i*Gy(t);return{x:h,y:u}}getPointOnEllipticalArc(t,e,i,n,r,o){const l=Math.cos(o),h=Math.sin(o),u={x:i*Math.cos(r),y:n*Math.sin(r)};return{x:t+(u.x*l-u.y*h),y:e+(u.x*h+u.y*l)}}buildEquidistantCache(t,e){const i=this.getPathLength(),n=e||.25,r=t||i/100;if(!this.equidistantCache||this.equidistantCache.step!==r||this.equidistantCache.precision!==n){this.equidistantCache={step:r,precision:n,points:[]};let o=0;for(let l=0;l<=i;l+=n){const h=this.getPointOnPath(l),u=this.getPointOnPath(l+n);!h||!u||(o+=this.getLineLength(h.x,h.y,u.x,u.y),o>=r&&(this.equidistantCache.points.push({x:h.x,y:h.y,distance:l}),o-=r))}}}getEquidistantPointOnPath(t,e,i){if(this.buildEquidistantCache(e,i),t<0||t-this.getPathLength()>5e-5)return null;const n=Math.round(t/this.getPathLength()*(this.equidistantCache.points.length-1));return this.equidistantCache.points[n]||null}constructor(t,e,i){super(t,e,i),this.type="textPath",this.textWidth=0,this.textHeight=0,this.pathLength=-1,this.glyphInfo=null,this.letterSpacingCache=[],this.measuresCache=new Map([["",0]]);const n=this.getHrefAttribute().getDefinition();this.text=this.getTextFromNode(),this.dataArray=this.parsePathData(n)}}const Hx=/^\s*data:(([^/,;]+\/[^/,;]+)(?:;([^,;=]+=[^,;=]+))?)?(?:;(base64))?,(.*)$/i;class Ux extends ka{async loadImage(t){try{const e=await this.document.createImage(t);this.image=e}catch(e){console.error('Error while loading image "'.concat(t,'":'),e)}this.loaded=!0}async loadSvg(t){const e=Hx.exec(t);if(e){const i=e[5];i&&(e[4]==="base64"?this.image=atob(i):this.image=decodeURIComponent(i))}else try{const n=await(await this.document.fetch(t)).text();this.image=n}catch(i){console.error('Error while loading image "'.concat(t,'":'),i)}this.loaded=!0}renderChildren(t){const{document:e,image:i,loaded:n}=this,r=this.getAttribute("x").getPixels("x"),o=this.getAttribute("y").getPixels("y"),l=this.getStyle("width").getPixels("x"),h=this.getStyle("height").getPixels("y");if(!(!n||!i||!l||!h)){if(t.save(),t.translate(r,o),typeof i=="string"){const u=e.canvg.forkString(t,i,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:0,offsetY:0,scaleWidth:l,scaleHeight:h}),{documentElement:d}=u.document;d&&(d.parent=this),u.render()}else e.setViewBox({ctx:t,aspectRatio:this.getAttribute("preserveAspectRatio").getString(),width:l,desiredWidth:i.width,height:h,desiredHeight:i.height}),this.loaded&&(!("complete"in i)||i.complete)&&t.drawImage(i,0,0);t.restore()}}getBoundingBox(){const t=this.getAttribute("x").getPixels("x"),e=this.getAttribute("y").getPixels("y"),i=this.getStyle("width").getPixels("x"),n=this.getStyle("height").getPixels("y");return new wr(t,e,t+i,e+n)}constructor(t,e,i){super(t,e,i),this.type="image",this.loaded=!1;const n=this.getHrefAttribute().getString();if(!n)return;const r=n.endsWith(".svg")||/^\s*data:image\/svg\+xml/i.test(n);t.images.push(this),r?this.loadSvg(n):this.loadImage(n)}}class jx extends ka{render(t){}constructor(...t){super(...t),this.type="symbol"}}class Wx{async load(t,e){try{const{document:i}=this,r=(await i.canvg.parser.load(e)).getElementsByTagName("font");Array.from(r).forEach(o=>{const l=i.createElement(o);i.definitions[t]=l})}catch(i){console.error('Error while loading font "'.concat(e,'":'),i)}this.loaded=!0}constructor(t){this.document=t,this.loaded=!1,t.fonts.push(this)}}class iw extends Yi{constructor(t,e,i){super(t,e,i),this.type="style",Rl(Array.from(e.childNodes).map(o=>o.textContent).join("").replace(/(\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\/)|(^[\s]*\/\/.*)/gm,"").replace(/@import.*;/g,"")).split("}").forEach(o=>{const l=o.trim();if(!l)return;const h=l.split("{"),u=h[0].split(","),d=h[1].split(";");u.forEach(g=>{const y=g.trim();if(!y)return;const m=t.styles[y]||{};if(d.forEach(I=>{const b=I.indexOf(":"),x=I.substr(0,b).trim(),C=I.substr(b+1,I.length-b).trim();x&&C&&(m[x]=new se(t,x,C))}),t.styles[y]=m,t.stylesSpecificity[y]=lx(y),y==="@font-face"){const I=m["font-family"].getString().replace(/"|'/g,"");m.src.getString().split(",").forEach(x=>{if(x.indexOf('format("svg")')>0){const C=Ly(x);C&&new Wx(t).load(I,C)}})}})})}}iw.parseExternalUrl=Ly;class Gx extends ka{setContext(t){super.setContext(t);const e=this.getAttribute("x"),i=this.getAttribute("y");e.hasValue()&&t.translate(e.getPixels("x"),0),i.hasValue()&&t.translate(0,i.getPixels("y"))}path(t){const{element:e}=this;e&&e.path(t)}renderChildren(t){const{document:e,element:i}=this;if(i){let n=i;if(i.type==="symbol"&&(n=new ph(e),n.attributes.viewBox=new se(e,"viewBox",i.getAttribute("viewBox").getString()),n.attributes.preserveAspectRatio=new se(e,"preserveAspectRatio",i.getAttribute("preserveAspectRatio").getString()),n.attributes.overflow=new se(e,"overflow",i.getAttribute("overflow").getString()),n.children=i.children,i.styles.opacity=new se(e,"opacity",this.calculateOpacity())),n.type==="svg"){const o=this.getStyle("width",!1,!0),l=this.getStyle("height",!1,!0);o.hasValue()&&(n.attributes.width=new se(e,"width",o.getString())),l.hasValue()&&(n.attributes.height=new se(e,"height",l.getString()))}const r=n.parent;n.parent=this,n.render(t),n.parent=r}}getBoundingBox(t){const{element:e}=this;return e?e.getBoundingBox(t):null}elementTransform(){const{document:t,element:e}=this;return e?Pa.fromElement(t,e):null}get element(){return this.cachedElement||(this.cachedElement=this.getHrefAttribute().getDefinition()),this.cachedElement}constructor(...t){super(...t),this.type="use"}}function gd(s,t,e,i,n,r){return s[e*i*4+t*4+r]}function pd(s,t,e,i,n,r,o){s[e*i*4+t*4+r]=o}function mn(s,t,e){return s[t]*e}function _o(s,t,e,i){return t+Math.cos(s)*e+Math.sin(s)*i}class nw extends Yi{apply(t,e,i,n,r){const{includeOpacity:o,matrix:l}=this,h=t.getImageData(0,0,n,r);for(let u=0;u<r;u++)for(let d=0;d<n;d++){const g=gd(h.data,d,u,n,r,0),y=gd(h.data,d,u,n,r,1),m=gd(h.data,d,u,n,r,2),I=gd(h.data,d,u,n,r,3);let b=mn(l,0,g)+mn(l,1,y)+mn(l,2,m)+mn(l,3,I)+mn(l,4,1),x=mn(l,5,g)+mn(l,6,y)+mn(l,7,m)+mn(l,8,I)+mn(l,9,1),C=mn(l,10,g)+mn(l,11,y)+mn(l,12,m)+mn(l,13,I)+mn(l,14,1),P=mn(l,15,g)+mn(l,16,y)+mn(l,17,m)+mn(l,18,I)+mn(l,19,1);o&&(b=0,x=0,C=0,P*=I/255),pd(h.data,d,u,n,r,0,b),pd(h.data,d,u,n,r,1,x),pd(h.data,d,u,n,r,2,C),pd(h.data,d,u,n,r,3,P)}t.clearRect(0,0,n,r),t.putImageData(h,0,0)}constructor(t,e,i){super(t,e,i),this.type="feColorMatrix";let n=Bs(this.getAttribute("values").getString());switch(this.getAttribute("type").getString("matrix")){case"saturate":{const r=n[0];n=[.213+.787*r,.715-.715*r,.072-.072*r,0,0,.213-.213*r,.715+.285*r,.072-.072*r,0,0,.213-.213*r,.715-.715*r,.072+.928*r,0,0,0,0,0,1,0,0,0,0,0,1];break}case"hueRotate":{const r=n[0]*Math.PI/180;n=[_o(r,.213,.787,-.213),_o(r,.715,-.715,-.715),_o(r,.072,-.072,.928),0,0,_o(r,.213,-.213,.143),_o(r,.715,.285,.14),_o(r,.072,-.072,-.283),0,0,_o(r,.213,-.213,-.787),_o(r,.715,-.715,.715),_o(r,.072,.928,.072),0,0,0,0,0,1,0,0,0,0,0,1];break}case"luminanceToAlpha":n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2125,.7154,.0721,0,0,0,0,0,0,1];break}this.matrix=n,this.includeOpacity=this.getAttribute("includeOpacity").hasValue()}}class md extends Yi{apply(t,e){const{document:i}=this;let n=this.getAttribute("x").getPixels("x"),r=this.getAttribute("y").getPixels("y"),o=this.getStyle("width").getPixels("x"),l=this.getStyle("height").getPixels("y");if(!o&&!l){const m=new wr;this.children.forEach(I=>{m.addBoundingBox(I.getBoundingBox(t))}),n=Math.floor(m.x1),r=Math.floor(m.y1),o=Math.floor(m.width),l=Math.floor(m.height)}const h=this.removeStyles(e,md.ignoreStyles),u=i.createCanvas(n+o,r+l),d=u.getContext("2d");i.screen.setDefaults(d),this.renderChildren(d),new nw(i,{nodeType:1,childNodes:[],attributes:[{nodeName:"type",value:"luminanceToAlpha"},{nodeName:"includeOpacity",value:"true"}]}).apply(d,0,0,n+o,r+l);const g=i.createCanvas(n+o,r+l),y=g.getContext("2d");i.screen.setDefaults(y),e.render(y),y.globalCompositeOperation="destination-in",y.fillStyle=d.createPattern(u,"no-repeat"),y.fillRect(0,0,n+o,r+l),t.fillStyle=y.createPattern(g,"no-repeat"),t.fillRect(0,0,n+o,r+l),this.restoreStyles(e,h)}render(t){}constructor(...t){super(...t),this.type="mask"}}md.ignoreStyles=["mask","transform","clip-path"];const sw=()=>{};class $x extends Yi{apply(t){const{document:e}=this,i=Reflect.getPrototypeOf(t),{beginPath:n,closePath:r}=t;i&&(i.beginPath=sw,i.closePath=sw),Reflect.apply(n,t,[]),this.children.forEach(o=>{if(!("path"in o))return;let l="elementTransform"in o?o.elementTransform():null;l||(l=Pa.fromElement(e,o)),l&&l.apply(t),o.path(t),i&&(i.closePath=r),l&&l.unapply(t)}),Reflect.apply(r,t,[]),t.clip(),i&&(i.beginPath=n,i.closePath=r)}render(t){}constructor(...t){super(...t),this.type="clipPath"}}class _d extends Yi{apply(t,e){const{document:i,children:n}=this,r="getBoundingBox"in e?e.getBoundingBox(t):null;if(!r)return;let o=0,l=0;n.forEach(C=>{const P=C.extraFilterDistance||0;o=Math.max(o,P),l=Math.max(l,P)});const h=Math.floor(r.width),u=Math.floor(r.height),d=h+2*o,g=u+2*l;if(d<1||g<1)return;const y=Math.floor(r.x),m=Math.floor(r.y),I=this.removeStyles(e,_d.ignoreStyles),b=i.createCanvas(d,g),x=b.getContext("2d");i.screen.setDefaults(x),x.translate(-y+o,-m+l),e.render(x),n.forEach(C=>{typeof C.apply=="function"&&C.apply(x,0,0,d,g)}),t.drawImage(b,0,0,d,g,y-o,m-l,d,g),this.restoreStyles(e,I)}render(t){}constructor(...t){super(...t),this.type="filter"}}_d.ignoreStyles=["filter","transform","clip-path"];class qx extends Yi{apply(t,e,i,n,r){}constructor(t,e,i){super(t,e,i),this.type="feDropShadow",this.addStylesFromStyleDefinition()}}class Kx extends Yi{apply(t,e,i,n,r){}constructor(...t){super(...t),this.type="feMorphology"}}class Xx extends Yi{apply(t,e,i,n,r){}constructor(...t){super(...t),this.type="feComposite"}}class Jx extends Yi{apply(t,e,i,n,r){const{document:o,blurRadius:l}=this,h=o.window?o.window.document.body:null,u=t.canvas;u.id=o.getUniqueId(),h&&(u.style.display="none",h.appendChild(u)),qI(u,e,i,n,r,l),h&&h.removeChild(u)}constructor(t,e,i){super(t,e,i),this.type="feGaussianBlur",this.blurRadius=Math.floor(this.getAttribute("stdDeviation").getNumber()),this.extraFilterDistance=this.blurRadius}}class Yx extends Yi{constructor(...t){super(...t),this.type="title"}}class Zx extends Yi{constructor(...t){super(...t),this.type="desc"}}const Qx={svg:ph,rect:Yy,circle:Sx,ellipse:Px,line:kx,polyline:Zy,polygon:Mx,path:vi,pattern:Ex,marker:Ax,defs:Tx,linearGradient:Nx,radialGradient:Dx,stop:Ox,animate:Eg,animateColor:Rx,animateTransform:Lx,font:Fx,"font-face":tw,"missing-glyph":ew,glyph:Ag,text:Ho,tspan:fd,tref:Bx,a:Vx,textPath:zx,image:Ux,g:Mg,symbol:jx,style:iw,use:Gx,mask:md,clipPath:$x,filter:_d,feDropShadow:qx,feMorphology:Kx,feComposite:Xx,feColorMatrix:nw,feGaussianBlur:Jx,title:Yx,desc:Zx};function tC(s,t){const e=document.createElement("canvas");return e.width=s,e.height=t,e}async function eC(s){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;const e=document.createElement("img");return t&&(e.crossOrigin="Anonymous"),new Promise((i,n)=>{e.onload=()=>{i(e)},e.onerror=(r,o,l,h,u)=>{n(u)},e.src=s})}const Tg=12;class Uo{bindCreateImage(t,e){return typeof e=="boolean"?(i,n)=>t(i,typeof n=="boolean"?n:e):t}get window(){return this.screen.window}get fetch(){return this.screen.fetch}get ctx(){return this.screen.ctx}get emSize(){const{emSizeStack:t}=this;return t[t.length-1]||Tg}set emSize(t){const{emSizeStack:e}=this;e.push(t)}popEmSize(){const{emSizeStack:t}=this;t.pop()}getUniqueId(){return"canvg".concat(++this.uniqueId)}isImagesLoaded(){return this.images.every(t=>t.loaded)}isFontsLoaded(){return this.fonts.every(t=>t.loaded)}createDocumentElement(t){const e=this.createElement(t.documentElement);return e.root=!0,e.addStylesFromStyleDefinition(),this.documentElement=e,e}createElement(t){const e=t.nodeName.replace(/^[^:]+:/,""),i=Uo.elementTypes[e];return i?new i(this,t):new wx(this,t)}createTextNode(t){return new Cx(this,t)}setViewBox(t){this.screen.setViewBox({document:this,...t})}constructor(t,{rootEmSize:e=Tg,emSize:i=Tg,createCanvas:n=Uo.createCanvas,createImage:r=Uo.createImage,anonymousCrossOrigin:o}={}){this.canvg=t,this.definitions={},this.styles={},this.stylesSpecificity={},this.images=[],this.fonts=[],this.emSizeStack=[],this.uniqueId=0,this.screen=t.screen,this.rootEmSize=e,this.emSize=i,this.createCanvas=n,this.createImage=this.bindCreateImage(r,o),this.screen.wait(()=>this.isImagesLoaded()),this.screen.wait(()=>this.isFontsLoaded())}}Uo.createCanvas=tC,Uo.createImage=eC,Uo.elementTypes=Qx;class Ma{static async from(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const r=await new kg(i).parse(e);return new Ma(t,r,i)}static fromString(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const r=new kg(i).parseFromString(e);return new Ma(t,r,i)}fork(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return Ma.from(t,e,{...this.options,...i})}forkString(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return Ma.fromString(t,e,{...this.options,...i})}ready(){return this.screen.ready()}isReady(){return this.screen.isReady()}async render(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.start({enableRedraw:!0,ignoreAnimation:!0,ignoreMouse:!0,...t}),await this.ready(),this.stop()}start(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{documentElement:e,screen:i,options:n}=this;i.start(e,{enableRedraw:!0,...n,...t})}stop(){this.screen.stop()}resize(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:t,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.documentElement.resize(t,e,i)}constructor(t,e,i={}){this.parser=new kg(i),this.screen=new mo(t,i),this.options=i;const n=new Uo(this,i),r=n.createDocumentElement(e);this.document=n,this.documentElement=r}}(function(s,t,e,i,n,r){function o(w,S,E,F,Z){return m(w,w,E,F,S,w.defaultView.pageXOffset,w.defaultView.pageYOffset).then(function(it){R("Document cloned");var Et="data-html2canvas-node"+Z,mt="["+Et+"='"+Z+"']";w.querySelector(mt).removeAttribute(Et);var Et=it.contentWindow,Ht=Et.document.querySelector(mt);return(typeof S.onclone=="function"?Promise.resolve(S.onclone(Et.document)):Promise.resolve(!0)).then(function(){return l(Ht,it,S,E,F)})})}function l(w,S,E,F,Z){var it=S.contentWindow,mt=new vs(it.document),Et=new J(E,mt),Ht=at(w);F=E.type==="view"?F:u(it.document),Z=E.type==="view"?Z:d(it.document);var ve=new E.renderer(F,Z,Et,E,t);return new kt(w,ve,mt,Et,E).ready.then(function(){R("Finished rendering");var oi;return oi=E.type==="view"?h(ve.canvas,{width:ve.canvas.width,height:ve.canvas.height,top:0,left:0,x:0,y:0}):w===it.document.body||w===it.document.documentElement||E.canvas!=null?ve.canvas:h(ve.canvas,{width:E.width!=null?E.width:Ht.width,height:E.height!=null?E.height:Ht.height,top:Ht.top,left:Ht.left,x:it.pageXOffset,y:it.pageYOffset}),E.removeContainer&&(S.parentNode.removeChild(S),R("Cleaned up container")),oi})}function h(w,S){var E=t.createElement("canvas"),F=Math.min(w.width-1,Math.max(0,S.left)),Z=Math.min(w.width,Math.max(1,S.left+S.width)),it=Math.min(w.height-1,Math.max(0,S.top)),mt=Math.min(w.height,Math.max(1,S.top+S.height));return E.width=S.width,E.height=S.height,R("Cropping canvas at:","left:",S.left,"top:",S.top,"width:",Z-F,"height:",mt-it),R("Resulting crop with width",S.width,"and height",S.height," with x",F,"and y",it),E.getContext("2d").drawImage(w,F,it,Z-F,mt-it,S.x,S.y,Z-F,mt-it),E}function u(w){return Math.max(Math.max(w.body.scrollWidth,w.documentElement.scrollWidth),Math.max(w.body.offsetWidth,w.documentElement.offsetWidth),Math.max(w.body.clientWidth,w.documentElement.clientWidth))}function d(w){return Math.max(Math.max(w.body.scrollHeight,w.documentElement.scrollHeight),Math.max(w.body.offsetHeight,w.documentElement.offsetHeight),Math.max(w.body.clientHeight,w.documentElement.clientHeight))}function g(){return"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"}function y(w,S){for(var E=w.nodeType===3?t.createTextNode(w.nodeValue):w.cloneNode(!1),F=w.firstChild;F;)S!==!0&&F.nodeType===1&&F.nodeName==="SCRIPT"||E.appendChild(y(F,S)),F=F.nextSibling;return E}function m(w,S,E,F,Z,it,mt){C(w);var Et=t.documentMode&&9>=t.documentMode?y(w.documentElement,Z.javascriptEnabled):w.documentElement.cloneNode(!0),Ht=S.createElement("iframe");return Ht.className="html2canvas-container",Ht.style.visibility="hidden",Ht.style.position="fixed",Ht.style.left="-10000px",Ht.style.top="0px",Ht.style.border="0",Ht.width=E,Ht.height=F,Ht.scrolling="no",S.body.appendChild(Ht),new Promise(function(ve){var oi=Ht.contentWindow.document;I(w.documentElement,Et,"textarea"),I(w.documentElement,Et,"select"),Ht.contentWindow.onload=Ht.onload=function(){var en=setInterval(function(){0<oi.body.childNodes.length&&(P(w,oi),clearInterval(en),Z.type==="view"&&Ht.contentWindow.scrollTo(it,mt),ve(Ht))},50)},oi.open(),oi.write("<!DOCTYPE html><html></html>"),!w.defaultView||it===w.defaultView.pageXOffset&&mt===w.defaultView.pageYOffset||w.defaultView.scrollTo(it,mt),oi.replaceChild(Z.javascriptEnabled===!0?oi.adoptNode(Et):k(oi.adoptNode(Et)),oi.documentElement),oi.close()})}function I(w,S,E){w=w.getElementsByTagName(E),S=S.getElementsByTagName(E),E=w.length;for(var F=0;F<E;F++)S[F].value=w[F].value}function b(w,S,E,F,Z,it){return new Qi(w,S,s.document).then(x(w)).then(function(mt){return m(mt,E,F,Z,it,0,0)})}function x(w){return function(S){var E=new DOMParser,F;try{F=E.parseFromString(S,"text/html")}catch{R("DOMParser not supported, falling back to createHTMLDocument"),F=t.implementation.createHTMLDocument("");try{F.open(),F.write(S),F.close()}catch{R("createHTMLDocument write not supported, falling back to document.body.innerHTML"),F.body.innerHTML=S}}return S=F.querySelector("base"),S&&S.href.host||(S=F.createElement("base"),S.href=w,F.head.insertBefore(S,F.head.firstChild)),F}}function C(w){[].slice.call(w.querySelectorAll("canvas"),0).forEach(function(S){S.setAttribute("data-html2canvas-canvas-clone","canvas-"+Go++)})}function P(w,S){[].slice.call(w.querySelectorAll("[data-html2canvas-canvas-clone]"),0).forEach(function(E){try{var F=S.querySelector('[data-html2canvas-canvas-clone="'+E.getAttribute("data-html2canvas-canvas-clone")+'"]');F&&(F.width=E.width,F.height=E.height,F.getContext("2d").putImageData(E.getContext("2d").getImageData(0,0,E.width,E.height),0,0))}catch(Z){R("Unable to copy canvas content from",E,Z)}E.removeAttribute("data-html2canvas-canvas-clone")})}function k(w){return[].slice.call(w.childNodes,0).filter(O).forEach(function(S){S.tagName==="SCRIPT"?w.removeChild(S):k(S)}),w}function O(w){return w.nodeType===Node.ELEMENT_NODE}function B(w){var S=t.createElement("a");return S.href=w,S.href=S.href,S}function j(w){this.b=this.g=this.r=0,this.a=null,this.fromArray(w)||this.namedColor(w)||this.rgb(w)||this.rgba(w)||this.hex6(w)||this.hex3(w)}function V(w){if(this.src=w,R("DummyImageContainer for",w),!this.promise||!this.image){R("Initiating DummyImageContainer"),V.prototype.image=new Image;var S=this.image;V.prototype.promise=new Promise(function(E,F){S.onload=E,S.onerror=F,S.src=g(),S.complete===!0&&E(S)})}}function Y(w,S){var E=t.createElement("div"),F=t.createElement("img"),Z=t.createElement("span"),it;E.style.visibility="hidden",E.style.fontFamily=w,E.style.fontSize=S,E.style.margin=0,E.style.padding=0,t.body.appendChild(E),F.src=g(),F.width=1,F.height=1,F.style.margin=0,F.style.padding=0,F.style.verticalAlign="baseline",Z.style.fontFamily=w,Z.style.fontSize=S,Z.style.margin=0,Z.style.padding=0,Z.appendChild(t.createTextNode("Hidden Text")),E.appendChild(Z),E.appendChild(F),it=F.offsetTop-Z.offsetTop+1,E.removeChild(Z),E.appendChild(t.createTextNode("Hidden Text")),E.style.lineHeight="normal",F.style.verticalAlign="super",F=F.offsetTop-E.offsetTop+1,t.body.removeChild(E),this.baseline=it,this.lineWidth=1,this.middle=F}function q(){this.data={}}function st(w,S,E){this.image=null,this.src=w;var F=this,Z=at(w);this.promise=(S?new Promise(function(it){w.contentWindow.document.URL==="about:blank"||w.contentWindow.document.documentElement==null?w.contentWindow.onload=w.onload=function(){it(w)}:it(w)}):this.proxyLoad(E.proxy,Z,E)).then(function(it){return html2canvas(it.contentWindow.document.documentElement,{type:"view",width:it.width,height:it.height,proxy:E.proxy,javascriptEnabled:E.javascriptEnabled,removeContainer:E.removeContainer,allowTaint:E.allowTaint,imageTimeout:E.imageTimeout/2})}).then(function(it){return F.image=it})}function ft(w){this.src=w.value,this.colorStops=[],this.type=null,this.y1=this.x1=this.y0=this.x0=.5,this.promise=Promise.resolve(!0)}function U(w,S){this.src=w,this.image=new Image;var E=this;this.tainted=null,this.promise=new Promise(function(F,Z){E.image.onload=F,E.image.onerror=Z,S&&(E.image.crossOrigin="anonymous"),E.image.src=w,E.image.complete===!0&&F(E.image)})}function J(w,S){this.link=null,this.options=w,this.support=S,this.origin=this.getOrigin(s.location.href)}function A(w){ft.apply(this,arguments),this.type=this.TYPES.LINEAR;var S=w.args[0].match(this.stepRegExp)===null;S?w.args[0].split(" ").reverse().forEach(function(E){switch(E){case"left":this.x0=0,this.x1=1;break;case"top":this.y0=0,this.y1=1;break;case"right":this.x0=1,this.x1=0;break;case"bottom":this.y0=1,this.y1=0;break;case"to":E=this.y0;var F=this.x0;this.y0=this.y1,this.x0=this.x1,this.x1=F,this.y1=E}},this):(this.y0=0,this.y1=1),this.colorStops=w.args.slice(S?1:0).map(function(E){return E=E.match(this.stepRegExp),{color:new j(E[1]),stop:E[3]==="%"?E[2]/100:null}},this),this.colorStops[0].stop===null&&(this.colorStops[0].stop=0),this.colorStops[this.colorStops.length-1].stop===null&&(this.colorStops[this.colorStops.length-1].stop=1),this.colorStops.forEach(function(E,F){E.stop===null&&this.colorStops.slice(F).some(function(Z,it){return Z.stop!==null?(E.stop=(Z.stop-this.colorStops[F-1].stop)/(it+1)+this.colorStops[F-1].stop,!0):!1},this)},this)}function R(){s.html2canvas.logging&&s.console&&s.console.log&&Function.prototype.bind.call(s.console.log,s.console).apply(s.console,[Date.now()-s.html2canvas.start+"ms","html2canvas:"].concat([].slice.call(arguments,0)))}function bt(w,S){this.node=w,this.parent=S,this.borders=this.bounds=this.stack=null,this.clip=[],this.backgroundClip=[],this.computedStyles=this.visible=this.offsetBounds=null,this.colors={},this.styles={},this.transformMatrix=this.transformData=this.backgroundImages=null,this.isPseudoElement=!1,this.opacity=null}function z(w){if(w&&w[1]==="matrix")return w[2].split(",").map(function(S){return parseFloat(S.trim())})}function Pt(w){return w.toString().indexOf("%")!==-1}function X(w){var S,E,F,Z,it,mt=[],Et=0,Ht=0,ve,oi,en=function(){S&&(E.substr(0,1)==='"'&&(E=E.substr(1,E.length-2)),E&&oi.push(E),S.substr(0,1)==="-"&&0<(Z=S.indexOf("-",1)+1)&&(F=S.substr(0,Z),S=S.substr(Z)),mt.push({prefix:F,method:S.toLowerCase(),value:it,args:oi,image:null})),oi=[],S=F=E=it=""};return oi=[],S=F=E=it="",w.split("").forEach(function(Si){if(!(Et===0&&-1<` \r
	`.indexOf(Si))){switch(Si){case'"':ve?ve===Si&&(ve=null):ve=Si;break;case"(":if(!ve){if(Et===0){Et=1,it+=Si;return}Ht++}break;case")":if(!ve&&Et===1){if(Ht===0){Et=0,it+=Si,en();return}Ht--}break;case",":if(!ve){if(Et===0){en();return}if(Et===1&&Ht===0&&!S.match(/^url$/i)){oi.push(E),E="",it+=Si;return}}}it+=Si,Et===0?S+=Si:E+=Si}}),en(),mt}function Tt(w){return w.replace("px","")}function lt(w){return parseFloat(w)}function at(w){if(w.getBoundingClientRect){var S=w.getBoundingClientRect(),E=w.offsetWidth==null?S.width:w.offsetWidth;return{top:S.top,bottom:S.bottom||S.top+S.height,right:S.left+E,left:S.left,width:E,height:w.offsetHeight==null?S.height:w.offsetHeight}}return{}}function Gt(w){var S=w.offsetParent?Gt(w.offsetParent):{top:0,left:0};return{top:w.offsetTop+S.top,bottom:w.offsetTop+w.offsetHeight+S.top,right:w.offsetLeft+S.left+w.offsetWidth,left:w.offsetLeft+S.left,width:w.offsetWidth,height:w.offsetHeight}}function kt(w,S,E,F,Z){if(R("Starting NodeParser"),this.renderer=S,this.options=Z,this.range=null,this.support=E,this.renderQueue=[],this.stack=new Wn(!0,1,w.ownerDocument,null),E=new bt(w,null),Z.background&&S.rectangle(0,0,S.width,S.height,new j(Z.background)),w===w.ownerDocument.documentElement){var it=new bt(E.color("backgroundColor").isTransparent()?w.ownerDocument.body:w.ownerDocument.documentElement,null);S.rectangle(0,0,S.width,S.height,it.color("backgroundColor"))}E.visibile=E.isElementVisible(),this.createPseudoHideStyles(w.ownerDocument),this.disableAnimations(w.ownerDocument),this.nodes=[].concat.apply([],[E].concat(this.getChildren(E)).filter(function(mt){return mt.visible=mt.isElementVisible()}).map(this.getPseudoElements,this)),this.fontMetrics=new q,R("Fetched nodes, total:",this.nodes.length),R("Calculate overflow clips"),this.calculateOverflowClips(),R("Start fetching images"),this.images=F.fetch(this.nodes.filter(xt)),this.ready=this.images.ready.then(Ut(function(){return R("Images loaded, starting parsing"),R("Creating stacking contexts"),this.createStackingContexts(),R("Sorting stacking contexts"),this.sortStackingContexts(this.stack),this.parse(this.stack),R("Render queue created with "+this.renderQueue.length+" items"),new Promise(Ut(function(mt){Z.async?typeof Z.async=="function"?Z.async.call(this,this.renderQueue,mt):0<this.renderQueue.length?(this.renderIndex=0,this.asyncRenderer(this.renderQueue,mt)):mt():(this.renderQueue.forEach(this.paint,this),mt())},this))},this))}function Ft(w){return w.replace(/(\-[a-z])/g,function(S){return S.toUpperCase().replace("-","")})}function ni(){}function ji(w,S,E,F){return w.map(function(Z,it){if(0<Z.width){var mt=S.left,Et=S.top,Ht=S.width,ve=S.height-w[2].width;switch(it){case 0:ve=w[0].width,Z.args=Ve({c1:[mt,Et],c2:[mt+Ht,Et],c3:[mt+Ht-w[1].width,Et+ve],c4:[mt+w[3].width,Et+ve]},F[0],F[1],E.topLeftOuter,E.topLeftInner,E.topRightOuter,E.topRightInner);break;case 1:mt=S.left+S.width-w[1].width,Ht=w[1].width,Z.args=Ve({c1:[mt+Ht,Et],c2:[mt+Ht,Et+ve+w[2].width],c3:[mt,Et+ve],c4:[mt,Et+w[0].width]},F[1],F[2],E.topRightOuter,E.topRightInner,E.bottomRightOuter,E.bottomRightInner);break;case 2:Et=Et+S.height-w[2].width,ve=w[2].width,Z.args=Ve({c1:[mt+Ht,Et+ve],c2:[mt,Et+ve],c3:[mt+w[3].width,Et],c4:[mt+Ht-w[3].width,Et]},F[2],F[3],E.bottomRightOuter,E.bottomRightInner,E.bottomLeftOuter,E.bottomLeftInner);break;case 3:Ht=w[3].width,Z.args=Ve({c1:[mt,Et+ve+w[2].width],c2:[mt,Et],c3:[mt+Ht,Et+w[0].width],c4:[mt+Ht,Et+ve]},F[3],F[0],E.bottomLeftOuter,E.bottomLeftInner,E.topLeftOuter,E.topLeftInner)}}return Z})}function oe(w,S,E,F){var it=(Math.sqrt(2)-1)/3*4,Z=E*it,it=F*it;return E=w+E,F=S+F,{topLeft:We({x:w,y:F},{x:w,y:F-it},{x:E-Z,y:S},{x:E,y:S}),topRight:We({x:w,y:S},{x:w+Z,y:S},{x:E,y:F-it},{x:E,y:F}),bottomRight:We({x:E,y:S},{x:E,y:S+it},{x:w+Z,y:F},{x:w,y:F}),bottomLeft:We({x:E,y:F},{x:E-Z,y:F},{x:w,y:S+it},{x:w,y:S})}}function Se(w,S,E){var F=w.left,Z=w.top,it=w.width;w=w.height;var mt=S[0][0],Et=S[0][1],Ht=S[1][0],ve=S[1][1],oi=S[2][0],en=S[2][1],Si=S[3][0];S=S[3][1];var Ri=it-Ht,qi=w-en,bs=it-oi,Mn=w-S;return{topLeftOuter:oe(F,Z,mt,Et).topLeft.subdivide(.5),topLeftInner:oe(F+E[3].width,Z+E[0].width,Math.max(0,mt-E[3].width),Math.max(0,Et-E[0].width)).topLeft.subdivide(.5),topRightOuter:oe(F+Ri,Z,Ht,ve).topRight.subdivide(.5),topRightInner:oe(F+Math.min(Ri,it+E[3].width),Z+E[0].width,Ri>it+E[3].width?0:Ht-E[3].width,ve-E[0].width).topRight.subdivide(.5),bottomRightOuter:oe(F+bs,Z+qi,oi,en).bottomRight.subdivide(.5),bottomRightInner:oe(F+Math.min(bs,it-E[3].width),Z+Math.min(qi,w+E[0].width),Math.max(0,oi-E[1].width),en-E[2].width).bottomRight.subdivide(.5),bottomLeftOuter:oe(F,Z+Mn,Si,S).bottomLeft.subdivide(.5),bottomLeftInner:oe(F+E[3].width,Z+Mn,Math.max(0,Si-E[3].width),S-E[2].width).bottomLeft.subdivide(.5)}}function We(w,S,E,F){var Z=function(it,mt,Et){return{x:it.x+(mt.x-it.x)*Et,y:it.y+(mt.y-it.y)*Et}};return{start:w,startControl:S,endControl:E,end:F,subdivide:function(it){var mt=Z(w,S,it),ve=Z(S,E,it),Et=Z(E,F,it),Ht=Z(mt,ve,it),ve=Z(ve,Et,it);return it=Z(Ht,ve,it),[We(w,mt,Ht,it),We(it,ve,Et,F)]},curveTo:function(it){it.push(["bezierCurve",S.x,S.y,E.x,E.y,F.x,F.y])},curveToReversed:function(it){it.push(["bezierCurve",E.x,E.y,S.x,S.y,w.x,w.y])}}}function Ve(w,S,E,F,Z,it,mt){var Et=[];return 0<S[0]||0<S[1]?(Et.push(["line",F[1].start.x,F[1].start.y]),F[1].curveTo(Et)):Et.push(["line",w.c1[0],w.c1[1]]),0<E[0]||0<E[1]?(Et.push(["line",it[0].start.x,it[0].start.y]),it[0].curveTo(Et),Et.push(["line",mt[0].end.x,mt[0].end.y]),mt[0].curveToReversed(Et)):(Et.push(["line",w.c2[0],w.c2[1]]),Et.push(["line",w.c3[0],w.c3[1]])),0<S[0]||0<S[1]?(Et.push(["line",Z[1].end.x,Z[1].end.y]),Z[1].curveToReversed(Et)):Et.push(["line",w.c4[0],w.c4[1]]),Et}function Le(w,S,E,F,Z,it,mt){0<S[0]||0<S[1]?(w.push(["line",F[0].start.x,F[0].start.y]),F[0].curveTo(w),F[1].curveTo(w)):w.push(["line",it,mt]),(0<E[0]||0<E[1])&&w.push(["line",Z[0].start.x,Z[0].start.y])}function yn(w){return 0>w.cssInt("zIndex")}function T(w){return 0<w.cssInt("zIndex")}function yt(w){return w.cssInt("zIndex")===0}function gt(w){return["inline","inline-block","inline-table"].indexOf(w.css("display"))!==-1}function $(w){return 0<w.node.data.trim().length}function W(w){return["TopLeft","TopRight","BottomRight","BottomLeft"].map(function(S){return S=w.css("border"+S+"Radius").split(" "),1>=S.length&&(S[1]=S[0]),S.map(Ge)})}function nt(w){return w.nodeType===Node.TEXT_NODE||w.nodeType===Node.ELEMENT_NODE}function It(w){return w.css("position")!=="static"}function St(w){return w.css("float")!=="none"}function ot(w){var S=this;return function(){return!w.apply(S,arguments)}}function xt(w){return w.node.nodeType===Node.ELEMENT_NODE}function Lt(w){return w.node.nodeType===Node.TEXT_NODE}function Ot(w){return function(S,E){return S.cssInt("zIndex")+w.indexOf(S)/w.length-(E.cssInt("zIndex")+w.indexOf(E)/w.length)}}function Ut(w,S){return function(){return w.apply(S,arguments)}}function Ge(w){return parseInt(w,10)}function we(w){return w.width}function hn(w){return w.node.nodeType!==Node.ELEMENT_NODE||"SCRIPT HEAD TITLE OBJECT BR OPTION".split(" ").indexOf(w.node.nodeName)===-1}function Rn(w){for(var S=[],E=0,F=!1,Z;w.length;)[32,13,10,9,45].indexOf(w[E])!==-1===F?(Z=w.splice(0,E),Z.length&&S.push(s.html2canvas.punycode.ucs2.encode(Z)),F=!F,E=0):E++,E>=w.length&&(Z=w.splice(0,E),Z.length&&S.push(s.html2canvas.punycode.ucs2.encode(Z)));return S}function Qi(w,S,E){if(!S)return Promise.reject("No proxy configured");var F=Qs(Hl);return w=tr(S,w,F),Hl?er(w):ui(E,w,F).then(function(Z){return Oi(Z.content)})}function ds(w,S,E){var F=Qs(Eh);return w=tr(S,w,F),Eh?Promise.resolve(w):ui(E,w,F).then(function(Z){return"data:"+Z.type+";base64,"+Z.content})}function ui(w,S,E){return new Promise(function(F,Z){var it=w.createElement("script"),mt=function(){delete s.html2canvas.proxy[E],w.body.removeChild(it)};s.html2canvas.proxy[E]=function(Et){mt(),F(Et)},it.src=S,it.onerror=function(Et){mt(),Z(Et)},w.body.appendChild(it)})}function Qs(w){var S=new Uint32Array(1);return(window.crypto||window.msCrypto).getRandomValues(S),w?"":"html2canvas_"+Date.now()+"_"+ ++Fg+"_"+Math.round(1e5*(S[0]/4294967295))}function tr(w,S,E){return w+"?url="+encodeURIComponent(S)+(E.length?"&callback=html2canvas.proxy."+E:"")}function Un(w,S){t.createElement("script");var E=t.createElement("a");E.href=w,this.src=w=E.href,this.image=new Image;var F=this;this.promise=new Promise(function(Z,it){F.image.crossOrigin="Anonymous",F.image.onload=Z,F.image.onerror=it,new ds(w,S,t).then(function(mt){F.image.src=mt}).catch(it)})}function te(w,S,E){bt.call(this,w,S),this.isPseudoElement=!0,this.before=E===":before"}function jn(w,S,E,F,Z){this.width=w,this.height=S,this.images=E,this.options=F,this.document=Z}function Wn(w,S,E,F){bt.call(this,E,F),this.ownStacking=w,this.contexts=[],this.children=[],this.opacity=(this.parent?this.parent.stack.opacity:1)*S}function vs(w){this.rangeBounds=this.testRangeBounds(w),this.cors=this.testCORS(),this.svg=this.testSVG()}function tn(w){this.src=w,this.image=null;var S=this;this.promise=this.hasFabric().then(function(){return S.isInline(w)?Promise.resolve(S.inlineFormatting(w)):er(w)}).then(function(E){return new Promise(function(F){html2canvas.fabric.loadSVGFromString(E,S.createCanvas.call(S,F))})})}function Oi(w){var S=w.length,E,F,Z,it,mt,Et,Ht="";for(E=0;E<S;E+=4)F="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(w[E]),Z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(w[E+1]),it="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(w[E+2]),mt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(w[E+3]),F=F<<2|Z>>4,Z=(Z&15)<<4|it>>2,Et=(it&3)<<6|mt,Ht=it===64?Ht+String.fromCharCode(F):mt===64||mt===-1?Ht+String.fromCharCode(F,Z):Ht+String.fromCharCode(F,Z,Et);return Ht}function es(w,S){this.src=w,this.image=null;var E=this;this.promise=S?new Promise(function(F,Z){E.image=new Image,E.image.onload=F,E.image.onerror=Z,E.image.src="data:image/svg+xml,"+new XMLSerializer().serializeToString(w),E.image.complete===!0&&F(E.image)}):this.hasFabric().then(function(){return new Promise(function(F){html2canvas.fabric.parseSVGDocument(w,E.createCanvas.call(E,F))})})}function yo(w,S){bt.call(this,w,S)}function Bt(w,S,E){if(0<w.length)return S+E.toUpperCase()}function zl(w){ft.apply(this,arguments),this.type=w.args[0]==="linear"?this.TYPES.LINEAR:this.TYPES.RADIAL}function er(w){return new Promise(function(S,E){var F=new XMLHttpRequest;F.open("GET",w),F.onload=function(){F.status===200?S(F.responseText):E(Error(F.statusText))},F.onerror=function(){E(Error("Network Error"))},F.send()})}function pi(w,S){jn.apply(this,arguments),this.canvas=this.options.canvas||this.document.createElement("canvas"),this.options.canvas||(this.canvas.width=w,this.canvas.height=S),this.ctx=this.canvas.getContext("2d"),this.taintCtx=this.document.createElement("canvas").getContext("2d"),this.ctx.textBaseline="bottom",this.variables={},R("Initialized CanvasRenderer with size",w,"x",S)}function kh(w){return 0<w.length}if((function(){function w(dt,Rt){Li[de]=dt,Li[de+1]=Rt,de+=2,de===2&&Ei()}function S(dt){return typeof dt=="function"}function E(){return function(){process.nextTick(mt)}}function F(){var dt=0,Rt=new Oe(mt),$t=t.createTextNode("");return Rt.observe($t,{characterData:!0}),function(){$t.data=dt=++dt%2}}function Z(){var dt=new MessageChannel;return dt.port1.onmessage=mt,function(){dt.port2.postMessage(0)}}function it(){return function(){setTimeout(mt,1)}}function mt(){for(var dt=0;dt<de;dt+=2)(0,Li[dt])(Li[dt+1]),Li[dt]=void 0,Li[dt+1]=void 0;de=0}function Et(){}function Ht(dt,Rt,$t,fe){try{dt.call(Rt,$t,fe)}catch(si){return si}}function ve(dt,Rt,$t){w(function(fe){var si=!1,di=Ht($t,Rt,function(Ii){si||(si=!0,Rt!==Ii?en(fe,Ii):Ri(fe,Ii))},function(Ii){si||(si=!0,qi(fe,Ii))});!si&&di&&(si=!0,qi(fe,di))},dt)}function oi(dt,Rt){Rt.a===1?Ri(dt,Rt.b):dt.a===2?qi(dt,Rt.b):bs(Rt,void 0,function($t){en(dt,$t)},function($t){qi(dt,$t)})}function en(dt,Rt){if(dt===Rt)qi(dt,new TypeError("You cannot resolve a promise with itself"));else if(typeof Rt=="function"||typeof Rt=="object"&&Rt!==null)if(Rt.constructor===dt.constructor)oi(dt,Rt);else{var $t;try{$t=Rt.then}catch(fe){Ke.error=fe,$t=Ke}$t===Ke?qi(dt,Ke.error):$t===void 0?Ri(dt,Rt):S($t)?ve(dt,Rt,$t):Ri(dt,Rt)}else Ri(dt,Rt)}function Si(dt){dt.f&&dt.f(dt.b),Mn(dt)}function Ri(dt,Rt){dt.a===void 0&&(dt.b=Rt,dt.a=1,dt.e.length!==0&&w(Mn,dt))}function qi(dt,Rt){dt.a===void 0&&(dt.a=2,dt.b=Rt,w(Si,dt))}function bs(dt,Rt,$t,fe){var si=dt.e,di=si.length;dt.f=null,si[di]=Rt,si[di+1]=$t,si[di+2]=fe,di===0&&dt.a&&w(Mn,dt)}function Mn(dt){var Rt=dt.e,$t=dt.a;if(Rt.length!==0){for(var fe,si,di=dt.b,Ii=0;Ii<Rt.length;Ii+=3)fe=Rt[Ii],si=Rt[Ii+$t],fe?is($t,fe,si,di):si(di);dt.e.length=0}}function $o(){this.error=null}function is(dt,Rt,$t,fe){var si=S($t),di,Ii,ir,Da;if(si){try{di=$t(fe)}catch(xd){bi.error=xd,di=bi}if(di===bi?(Da=!0,Ii=di.error,di=null):ir=!0,Rt===di){qi(Rt,new TypeError("A promises callback cannot return that same promise."));return}}else di=fe,ir=!0;Rt.a===void 0&&(si&&ir?en(Rt,di):Da?qi(Rt,Ii):dt===1?Ri(Rt,di):dt===2&&qi(Rt,di))}function Ur(dt,Rt){try{Rt(function($t){en(dt,$t)},function($t){qi(dt,$t)})}catch($t){qi(dt,$t)}}function nn(dt,Rt,$t,fe){this.n=dt,this.c=new dt(Et,fe),this.i=$t,this.o(Rt)?(this.m=Rt,this.d=this.length=Rt.length,this.l(),this.length===0?Ri(this.c,this.b):(this.length=this.length||0,this.k(),this.d===0&&Ri(this.c,this.b))):qi(this.c,this.p())}function ee(dt){if(this.b=this.a=void 0,this.e=[],Et!==dt){if(!S(dt))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof ee))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");Ur(this,dt)}}var ce=Array.isArray?Array.isArray:function(dt){return Object.prototype.toString.call(dt)==="[object Array]"},de=0,ai=typeof s<"u"?s:{},Oe=ai.MutationObserver||ai.WebKitMutationObserver,ai=typeof Uint8ClampedArray<"u"&&typeof importScripts<"u"&&typeof MessageChannel<"u",Li=Array(1e3),Ei;Ei=typeof process<"u"&&{}.toString.call(process)==="[object process]"?E():Oe?F():ai?Z():it();var Ke=new $o,bi=new $o;nn.prototype.o=function(dt){return ce(dt)},nn.prototype.p=function(){return Error("Array Methods must be provided an Array")},nn.prototype.l=function(){this.b=Array(this.length)},nn.prototype.k=function(){for(var dt=this.length,Rt=this.c,$t=this.m,fe=0;Rt.a===void 0&&fe<dt;fe++)this.j($t[fe],fe)},nn.prototype.j=function(dt,Rt){var $t=this.n;typeof dt=="object"&&dt!==null?dt.constructor===$t&&dt.a!==void 0?(dt.f=null,this.g(dt.a,Rt,dt.b)):this.q($t.resolve(dt),Rt):(this.d--,this.b[Rt]=this.h(dt))},nn.prototype.g=function(dt,Rt,$t){var fe=this.c;fe.a===void 0&&(this.d--,this.i&&dt===2?qi(fe,$t):this.b[Rt]=this.h($t)),this.d===0&&Ri(fe,this.b)},nn.prototype.h=function(dt){return dt},nn.prototype.q=function(dt,Rt){var $t=this;bs(dt,void 0,function(fe){$t.g(1,Rt,fe)},function(fe){$t.g(2,Rt,fe)})},ee.all=function(dt,Rt){return new nn(this,dt,!0,Rt).c},ee.race=function(dt,Rt){function $t(ir){en(si,ir)}function fe(ir){qi(si,ir)}var si=new this(Et,Rt);if(!ce(dt))return qi(si,new TypeError("You must pass an array to race.")),si;for(var di=dt.length,Ii=0;si.a===void 0&&Ii<di;Ii++)bs(this.resolve(dt[Ii]),void 0,$t,fe);return si},ee.resolve=function(dt,Rt){if(dt&&typeof dt=="object"&&dt.constructor===this)return dt;var $t=new this(Et,Rt);return en($t,dt),$t},ee.reject=function(dt,Rt){var $t=new this(Et,Rt);return qi($t,dt),$t},ee.prototype={constructor:ee,then:function(dt,Rt){var $t=this.a;if($t===1&&!dt||$t===2&&!Rt)return this;var fe=new this.constructor(Et),si=this.b;if($t){var di=arguments[$t-1];w(function(){is($t,fe,di,si)})}else bs(this,fe,dt,Rt);return fe},catch:function(dt){return this.then(null,dt)}};var Ye={Promise:ee,polyfill:function(){var dt;dt=typeof i<"u"?i:typeof s<"u"&&s.document?s:self,"Promise"in dt&&"resolve"in dt.Promise&&"reject"in dt.Promise&&"all"in dt.Promise&&"race"in dt.Promise&&function(){var Rt;return new dt.Promise(function($t){Rt=$t}),S(Rt)}()||(dt.Promise=ee)}};typeof n=="function"&&n.amd?n(function(){return Ye}):typeof module<"u"&&module.exports?module.exports=Ye:typeof this<"u"&&(this.ES6Promise=Ye)}).call(s),s&&s.ES6Promise&&s.ES6Promise.polyfill(),typeof t>"u"||typeof Object.create!="function"||typeof t.createElement("canvas").getContext!="function")(s||module.exports).html2canvas=function(){return Promise.reject("No canvas support")};else{(function(w){function S(ee){throw RangeError($o[ee])}function E(ee,ce){for(var de=ee.length,Oe=[];de--;)Oe[de]=ce(ee[de]);return Oe}function F(ee,ce){var de=ee.split("@"),Oe="";return 1<de.length&&(Oe=de[0]+"@",ee=de[1]),de=ee.split(Mn),de=E(de,ce).join("."),Oe+de}function Z(ee){for(var ce=[],de=0,Oe=ee.length,ai,Li;de<Oe;)ai=ee.charCodeAt(de++),55296<=ai&&56319>=ai&&de<Oe?(Li=ee.charCodeAt(de++),(Li&64512)==56320?ce.push(((ai&1023)<<10)+(Li&1023)+65536):(ce.push(ai),de--)):ce.push(ai);return ce}function it(ee){return E(ee,function(ce){var de="";return 65535<ce&&(ce-=65536,de+=Ur(ce>>>10&1023|55296),ce=56320|ce&1023),de+=Ur(ce)}).join("")}function mt(ee,ce){return ee+22+75*(26>ee)-((ce!=0)<<5)}function Et(ee,ce,de){var Oe=0;for(ee=de?is(ee/700):ee>>1,ee+=is(ee/ce);455<ee;Oe+=36)ee=is(ee/35);return is(Oe+36*ee/(ee+38))}function Ht(ee){var ce=[],de=ee.length,Oe,ai=0,Li=128,Ei=72,Ke,bi,Ye,dt,Rt;for(Ke=ee.lastIndexOf("-"),0>Ke&&(Ke=0),bi=0;bi<Ke;++bi)128<=ee.charCodeAt(bi)&&S("not-basic"),ce.push(ee.charCodeAt(bi));for(Ke=0<Ke?Ke+1:0;Ke<de;){for(bi=ai,Oe=1,Ye=36;Ke>=de&&S("invalid-input"),dt=ee.charCodeAt(Ke++),dt=10>dt-48?dt-22:26>dt-65?dt-65:26>dt-97?dt-97:36,(36<=dt||dt>is((2147483647-ai)/Oe))&&S("overflow"),ai+=dt*Oe,Rt=Ye<=Ei?1:Ye>=Ei+26?26:Ye-Ei,!(dt<Rt);Ye+=36)dt=36-Rt,Oe>is(2147483647/dt)&&S("overflow"),Oe*=dt;Oe=ce.length+1,Ei=Et(ai-bi,Oe,bi==0),is(ai/Oe)>2147483647-Li&&S("overflow"),Li+=is(ai/Oe),ai%=Oe,ce.splice(ai++,0,Li)}return it(ce)}function ve(ee){var ce,de,Oe,ai,Li,Ei,Ke,bi,Ye,dt=[],Rt,$t,fe;for(ee=Z(ee),Rt=ee.length,ce=128,de=0,Li=72,Ei=0;Ei<Rt;++Ei)Ye=ee[Ei],128>Ye&&dt.push(Ur(Ye));for((Oe=ai=dt.length)&&dt.push("-");Oe<Rt;){for(Ke=2147483647,Ei=0;Ei<Rt;++Ei)Ye=ee[Ei],Ye>=ce&&Ye<Ke&&(Ke=Ye);for($t=Oe+1,Ke-ce>is((2147483647-de)/$t)&&S("overflow"),de+=(Ke-ce)*$t,ce=Ke,Ei=0;Ei<Rt;++Ei)if(Ye=ee[Ei],Ye<ce&&2147483647<++de&&S("overflow"),Ye==ce){for(bi=de,Ke=36;Ye=Ke<=Li?1:Ke>=Li+26?26:Ke-Li,!(bi<Ye);Ke+=36)fe=bi-Ye,bi=36-Ye,dt.push(Ur(mt(Ye+fe%bi,0))),bi=is(fe/bi);dt.push(Ur(mt(bi,0))),Li=Et(de,$t,Oe==ai),de=0,++Oe}++de,++ce}return dt.join("")}var oi=typeof e=="object"&&e&&!e.nodeType&&e,en=typeof module=="object"&&module&&!module.nodeType&&module,Si=typeof i=="object"&&i;(Si.global===Si||Si.window===Si||Si.self===Si)&&(w=Si);var Ri,qi=/^xn--/,bs=/[^\x20-\x7E]/,Mn=/[\x2E\u3002\uFF0E\uFF61]/g,$o={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},is=Math.floor,Ur=String.fromCharCode,nn;if(Ri={version:"1.3.1",ucs2:{decode:Z,encode:it},decode:Ht,encode:ve,toASCII:function(ee){return F(ee,function(ce){return bs.test(ce)?"xn--"+ve(ce):ce})},toUnicode:function(ee){return F(ee,function(ce){return qi.test(ce)?Ht(ce.slice(4).toLowerCase()):ce})}},typeof n=="function"&&typeof n.amd=="object"&&n.amd)n("punycode",function(){return Ri});else if(oi&&en)if(module.exports==oi)en.exports=Ri;else for(nn in Ri)Ri.hasOwnProperty(nn)&&(oi[nn]=Ri[nn]);else w.punycode=Ri})(this);var Go=0,vd=0;s.html2canvas=function(w,S){var E=vd++;if(S=S||{},S.logging&&(s.html2canvas.logging=!0,s.html2canvas.start=Date.now()),S.async=typeof S.async>"u"?!0:S.async,S.allowTaint=typeof S.allowTaint>"u"?!1:S.allowTaint,S.removeContainer=typeof S.removeContainer>"u"?!0:S.removeContainer,S.javascriptEnabled=typeof S.javascriptEnabled>"u"?!1:S.javascriptEnabled,S.imageTimeout=typeof S.imageTimeout>"u"?1e4:S.imageTimeout,S.renderer=typeof S.renderer=="function"?S.renderer:pi,S.strict=!!S.strict,typeof w=="string"){if(typeof S.proxy!="string")return Promise.reject("Proxy must be used when rendering url");var F=S.width!=null?S.width:s.innerWidth,Z=S.height!=null?S.height:s.innerHeight;return b(B(w),S.proxy,t,F,Z,S).then(function(mt){return l(mt.contentWindow.document.documentElement,mt,S,F,Z)})}var it=(w===r?[t.documentElement]:w.length?w:[w])[0];return it.setAttribute("data-html2canvas-node"+E,E),o(it.ownerDocument,S,it.ownerDocument.defaultView.innerWidth,it.ownerDocument.defaultView.innerHeight,E).then(function(mt){return typeof S.onrendered=="function"&&(R("options.onrendered is deprecated, html2canvas returns a Promise containing the canvas"),S.onrendered(mt)),mt})},s.html2canvas.punycode=this.punycode,s.html2canvas.proxy={},j.prototype.darken=function(w){return w=1-w,new j([Math.round(this.r*w),Math.round(this.g*w),Math.round(this.b*w),this.a])},j.prototype.isTransparent=function(){return this.a===0},j.prototype.isBlack=function(){return this.r===0&&this.g===0&&this.b===0},j.prototype.fromArray=function(w){return Array.isArray(w)&&(this.r=Math.min(w[0],255),this.g=Math.min(w[1],255),this.b=Math.min(w[2],255),3<w.length&&(this.a=w[3])),Array.isArray(w)};var Rg=/^#([a-f0-9]{3})$/i;j.prototype.hex3=function(w){return(w=w.match(Rg))!==null&&(this.r=parseInt(w[1][0]+w[1][0],16),this.g=parseInt(w[1][1]+w[1][1],16),this.b=parseInt(w[1][2]+w[1][2],16)),w!==null};var bd=/^#([a-f0-9]{6})$/i;j.prototype.hex6=function(w){return(w=w.match(bd))!==null&&(this.r=parseInt(w[1].substring(0,2),16),this.g=parseInt(w[1].substring(2,4),16),this.b=parseInt(w[1].substring(4,6),16)),w!==null};var Na=/^rgb\((\d{1,3}) *, *(\d{1,3}) *, *(\d{1,3})\)$/;j.prototype.rgb=function(w){return(w=w.match(Na))!==null&&(this.r=Number(w[1]),this.g=Number(w[2]),this.b=Number(w[3])),w!==null};var Id=/^rgba\((\d{1,3}) *, *(\d{1,3}) *, *(\d{1,3}) *, *(\d+\.?\d*)\)$/;j.prototype.rgba=function(w){return(w=w.match(Id))!==null&&(this.r=Number(w[1]),this.g=Number(w[2]),this.b=Number(w[3]),this.a=Number(w[4])),w!==null},j.prototype.toString=function(){return this.a!==null&&this.a!==1?"rgba("+[this.r,this.g,this.b,this.a].join()+")":"rgb("+[this.r,this.g,this.b].join()+")"},j.prototype.namedColor=function(w){var S=Lg[w.toLowerCase()];if(S)this.r=S[0],this.g=S[1],this.b=S[2];else if(w.toLowerCase()==="transparent")return this.r=this.g=this.b=this.a=0,!0;return!!S},j.prototype.isColor=!0;var Lg={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};q.prototype.getMetrics=function(w,S){return this.data[w+"-"+S]===r&&(this.data[w+"-"+S]=new Y(w,S)),this.data[w+"-"+S]},st.prototype.proxyLoad=function(w,S,E){var F=this.src;return b(F.src,w,F.ownerDocument,S.width,S.height,E)},ft.prototype.TYPES={LINEAR:1,RADIAL:2},J.prototype.findImages=function(w){var S=[];return w.reduce(function(E,F){switch(F.node.nodeName){case"IMG":return E.concat([{args:[F.node.src],method:"url"}]);case"svg":case"IFRAME":return E.concat([{args:[F.node],method:F.node.nodeName}])}return E},[]).forEach(this.addImage(S,this.loadImage),this),S},J.prototype.findBackgroundImage=function(w,S){return S.parseBackgroundImages().filter(this.hasImageBackground).forEach(this.addImage(w,this.loadImage),this),w},J.prototype.addImage=function(w,S){return function(E){E.args.forEach(function(F){this.imageExists(w,F)||(w.splice(0,0,S.call(this,E)),R("Added image #"+w.length,typeof F=="string"?F.substring(0,100):F))},this)}},J.prototype.hasImageBackground=function(w){return w.method!=="none"},J.prototype.loadImage=function(w){return w.method==="url"?(w=w.args[0],!this.isSVG(w)||this.support.svg||this.options.allowTaint?w.match(/data:image\/.*;base64,/i)?new U(w.replace(/url\(['"]{0,}|['"]{0,}\)$/gi,""),!1):this.isSameOrigin(w)||this.options.allowTaint===!0||this.isSVG(w)?new U(w,!1):this.support.cors&&!this.options.allowTaint&&this.options.useCORS?new U(w,!0):this.options.proxy?new Un(w,this.options.proxy):new V(w):new tn(w)):w.method==="linear-gradient"?new A(w):w.method==="gradient"?new zl(w):w.method==="svg"?new es(w.args[0],this.support.svg):w.method==="IFRAME"?new st(w.args[0],this.isSameOrigin(w.args[0].src),this.options):new V(w)},J.prototype.isSVG=function(w){return w.substring(w.length-3).toLowerCase()==="svg"||tn.prototype.isInline(w)},J.prototype.imageExists=function(w,S){return w.some(function(E){return E.src===S})},J.prototype.isSameOrigin=function(w){return this.getOrigin(w)===this.origin},J.prototype.getOrigin=function(w){var S=this.link||(this.link=t.createElement("a"));return S.href=w,S.href=S.href,S.protocol+S.hostname+S.port},J.prototype.getPromise=function(w){return this.timeout(w,this.options.imageTimeout).catch(function(){return new V(w.src).promise.then(function(S){w.image=S})})},J.prototype.get=function(w){var S=null;return this.images.some(function(E){return(S=E).src===w})?S:null},J.prototype.fetch=function(w){return this.images=w.reduce(Ut(this.findBackgroundImage,this),this.findImages(w)),this.images.forEach(function(S,E){S.promise.then(function(){R("Succesfully loaded image #"+(E+1),S)},function(F){R("Failed loading image #"+(E+1),S,F)})}),this.ready=Promise.all(this.images.map(this.getPromise,this)),R("Finished searching images"),this},J.prototype.timeout=function(w,S){var E,F=Promise.race([w.promise,new Promise(function(Z,it){E=setTimeout(function(){R("Timed out loading image",w),it(w)},S)})]).then(function(Z){return clearTimeout(E),Z});return F.catch(function(){clearTimeout(E)}),F},A.prototype=Object.create(ft.prototype),A.prototype.stepRegExp=/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/,bt.prototype.cloneTo=function(w){w.visible=this.visible,w.borders=this.borders,w.bounds=this.bounds,w.clip=this.clip,w.backgroundClip=this.backgroundClip,w.computedStyles=this.computedStyles,w.styles=this.styles,w.backgroundImages=this.backgroundImages,w.opacity=this.opacity},bt.prototype.getOpacity=function(){return this.opacity===null?this.opacity=this.cssFloat("opacity"):this.opacity},bt.prototype.assignStack=function(w){this.stack=w,w.children.push(this)},bt.prototype.isElementVisible=function(){return this.node.nodeType===Node.TEXT_NODE?this.parent.visible:this.css("display")!=="none"&&this.css("visibility")!=="hidden"&&!this.node.hasAttribute("data-html2canvas-ignore")&&(this.node.nodeName!=="INPUT"||this.node.getAttribute("type")!=="hidden")},bt.prototype.css=function(w){return this.computedStyles||(this.computedStyles=this.isPseudoElement?this.parent.computedStyle(this.before?":before":":after"):this.computedStyle(null)),this.styles[w]||(this.styles[w]=this.computedStyles[w])},bt.prototype.prefixedCss=function(w){var S=["webkit","moz","ms","o"],E=this.css(w);return E===r&&S.some(function(F){return E=this.css(F+w.substr(0,1).toUpperCase()+w.substr(1)),E!==r},this),E===r?null:E},bt.prototype.computedStyle=function(w){return this.node.ownerDocument.defaultView.getComputedStyle(this.node,w)},bt.prototype.cssInt=function(w){return w=parseInt(this.css(w),10),isNaN(w)?0:w},bt.prototype.color=function(w){return this.colors[w]||(this.colors[w]=new j(this.css(w)))},bt.prototype.cssFloat=function(w){return w=parseFloat(this.css(w)),isNaN(w)?0:w},bt.prototype.fontWeight=function(){var w=this.css("fontWeight");switch(parseInt(w,10)){case 401:w="bold";break;case 400:w="normal"}return w},bt.prototype.parseClip=function(){var w=this.css("clip").match(this.CLIP);return w?{top:parseInt(w[1],10),right:parseInt(w[2],10),bottom:parseInt(w[3],10),left:parseInt(w[4],10)}:null},bt.prototype.parseBackgroundImages=function(){return this.backgroundImages||(this.backgroundImages=X(this.css("backgroundImage")))},bt.prototype.cssList=function(w,S){var E=(this.css(w)||"").split(","),E=E[S||0]||E[0]||"auto",E=E.trim().split(" ");return E.length===1&&(E=[E[0],E[0]]),E},bt.prototype.parseBackgroundSize=function(w,S,E){E=this.cssList("backgroundSize",E);var F;if(Pt(E[0]))F=w.width*parseFloat(E[0])/100;else{if(/contain|cover/.test(E[0]))return S=S.width/S.height,w.width/w.height<S^E[0]==="contain"?{width:w.height*S,height:w.height}:{width:w.width,height:w.width/S};F=parseInt(E[0],10)}return w=E[0]==="auto"&&E[1]==="auto"?S.height:E[1]==="auto"?F/S.width*S.height:Pt(E[1])?w.height*parseFloat(E[1])/100:parseInt(E[1],10),E[0]==="auto"&&(F=w/S.height*S.width),{width:F,height:w}},bt.prototype.parseBackgroundPosition=function(w,S,E,F){E=this.cssList("backgroundPosition",E);var Z;return Z=Pt(E[0])?(w.width-(F||S).width)*(parseFloat(E[0])/100):parseInt(E[0],10),w=E[1]==="auto"?Z/S.width*S.height:Pt(E[1])?(w.height-(F||S).height)*parseFloat(E[1])/100:parseInt(E[1],10),E[0]==="auto"&&(Z=w/S.height*S.width),{left:Z,top:w}},bt.prototype.parseBackgroundRepeat=function(w){return this.cssList("backgroundRepeat",w)[0]},bt.prototype.parseTextShadows=function(){var w=this.css("textShadow"),S=[];if(w&&w!=="none")for(var w=w.match(this.TEXT_SHADOW_PROPERTY),E=0;w&&E<w.length;E++){var F=w[E].match(this.TEXT_SHADOW_VALUES);S.push({color:new j(F[0]),offsetX:F[1]?parseFloat(F[1].replace("px","")):0,offsetY:F[2]?parseFloat(F[2].replace("px","")):0,blur:F[3]?F[3].replace("px",""):0})}return S},bt.prototype.parseTransform=function(){if(!this.transformData)if(this.hasTransform()){var w=this.parseBounds(),S=this.prefixedCss("transformOrigin").split(" ").map(Tt).map(lt);S[0]+=w.left,S[1]+=w.top,this.transformData={origin:S,matrix:this.parseTransformMatrix()}}else this.transformData={origin:[0,0],matrix:[1,0,0,1,0,0]};return this.transformData},bt.prototype.parseTransformMatrix=function(){if(!this.transformMatrix){var w=this.prefixedCss("transform");this.transformMatrix=(w=w?z(w.match(this.MATRIX_PROPERTY)):null)?w:[1,0,0,1,0,0]}return this.transformMatrix},bt.prototype.parseBounds=function(){return this.bounds||(this.bounds=this.hasTransform()?Gt(this.node):at(this.node))},bt.prototype.hasTransform=function(){return this.parseTransformMatrix().join(",")!=="1,0,0,1,0,0"||this.parent&&this.parent.hasTransform()},bt.prototype.getValue=function(){var w=this.node.value||"";return this.node.tagName==="SELECT"?(w=this.node,w=(w=w.options[w.selectedIndex||0])&&w.text||""):this.node.type==="password"&&(w=Array(w.length+1).join("•")),w.length===0?this.node.placeholder||"":w},bt.prototype.MATRIX_PROPERTY=/(matrix)\((.+)\)/,bt.prototype.TEXT_SHADOW_PROPERTY=/((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g,bt.prototype.TEXT_SHADOW_VALUES=/(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g,bt.prototype.CLIP=/^rect\((\d+)px,? (\d+)px,? (\d+)px,? (\d+)px\)$/,kt.prototype.calculateOverflowClips=function(){this.nodes.forEach(function(w){if(xt(w)){w.isPseudoElement===!0&&w.appendToDOM(),w.borders=this.parseBorders(w);var S=w.css("overflow")==="hidden"?[w.borders.clip]:[],E=w.parseClip();E&&["absolute","fixed"].indexOf(w.css("position"))!==-1&&S.push([["rect",w.bounds.left+E.left,w.bounds.top+E.top,E.right-E.left,E.bottom-E.top]]),w.clip=w.parent&&w.parent.clip.length?w.parent.clip.concat(S):S,w.backgroundClip=w.css("overflow")!=="hidden"?w.clip.concat([w.borders.clip]):w.clip,w.isPseudoElement===!0&&w.cleanDOM()}else Lt(w)&&(w.clip=w.parent&&w.parent.clip.length?w.parent.clip:[]);w.isPseudoElement!==!0&&(w.bounds=null)},this)},kt.prototype.asyncRenderer=function(w,S,E){E=E||Date.now(),this.paint(w[this.renderIndex++]),w.length===this.renderIndex?S():E+20>Date.now()?this.asyncRenderer(w,S,E):setTimeout(Ut(function(){this.asyncRenderer(w,S)},this),0)},kt.prototype.createPseudoHideStyles=function(w){this.createStyles(w,"."+te.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+':before { content: "" !important; display: none !important; }.'+te.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER+':after { content: "" !important; display: none !important; }')},kt.prototype.disableAnimations=function(w){this.createStyles(w,"* { -webkit-animation: none !important; -moz-animation: none !important; -o-animation: none !important; animation: none !important; -webkit-transition: none !important; -moz-transition: none !important; -o-transition: none !important; transition: none !important;}")},kt.prototype.createStyles=function(w,S){var E=w.createElement("style");E.innerHTML=S,w.body.appendChild(E)},kt.prototype.getPseudoElements=function(w){var S=[[w]];if(w.node.nodeType===Node.ELEMENT_NODE){var E=this.getPseudoElement(w,":before");w=this.getPseudoElement(w,":after"),E&&S.push(E),w&&S.push(w)}return[].concat.apply([],S)},kt.prototype.getPseudoElement=function(w,S){var E=w.computedStyle(S);if(!E||!E.content||E.content==="none"||E.content==="-moz-alt-content"||E.display==="none")return null;var F,Z=E.content,it=Z.substr(0,1);F=it===Z.substr(Z.length-1)&&it.match(/'|"/)?Z.substr(1,Z.length-2):Z;for(var mt=F.substr(0,3)==="url",Z=t.createElement(mt?"img":"html2canvaspseudoelement"),it=new te(Z,w,S),Et=E.length-1;0<=Et;Et--){var Ht=Ft(E.item(Et));Z.style[Ht]=E[Ht]}return Z.className=te.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+" "+te.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER,mt?(Z.src=X(F)[0].args[0],[it]):(E=t.createTextNode(F),Z.appendChild(E),[it,new yo(E,it)])},kt.prototype.getChildren=function(w){return[].concat.apply([],[].filter.call(w.node.childNodes,nt).map(function(S){var E=[S.nodeType===Node.TEXT_NODE?new yo(S,w):new bt(S,w)].filter(hn);return S.nodeType===Node.ELEMENT_NODE&&E.length&&S.tagName!=="TEXTAREA"?E[0].isElementVisible()?E.concat(this.getChildren(E[0])):[]:E},this))},kt.prototype.newStackingContext=function(w,S){var E=new Wn(S,w.getOpacity(),w.node,w.parent);w.cloneTo(E),(S?E.getParentStack(this):E.parent.stack).contexts.push(E),w.stack=E},kt.prototype.createStackingContexts=function(){this.nodes.forEach(function(w){var S;(S=xt(w))&&((S=this.isRootElement(w)||1>w.getOpacity())||(S=w.css("position"),S=(["absolute","relative","fixed"].indexOf(S)!==-1?w.css("zIndex"):"auto")!=="auto"),S=S||this.isBodyWithTransparentRoot(w)||w.hasTransform()),S?this.newStackingContext(w,!0):xt(w)&&(It(w)&&yt(w)||["inline-block","inline-table"].indexOf(w.css("display"))!==-1||St(w))?this.newStackingContext(w,!1):w.assignStack(w.parent.stack)},this)},kt.prototype.isBodyWithTransparentRoot=function(w){return w.node.nodeName==="BODY"&&w.parent.color("backgroundColor").isTransparent()},kt.prototype.isRootElement=function(w){return w.parent===null},kt.prototype.sortStackingContexts=function(w){w.contexts.sort(Ot(w.contexts.slice(0))),w.contexts.forEach(this.sortStackingContexts,this)},kt.prototype.parseTextBounds=function(w){return function(S,E,F){if(w.parent.css("textDecoration").substr(0,4)!=="none"||S.trim().length!==0){if(this.support.rangeBounds&&!w.parent.hasTransform())return E=F.slice(0,E).join("").length,this.getRangeBounds(w.node,E,S.length);if(w.node&&typeof w.node.data=="string")return S=w.node.splitText(S.length),E=this.getWrapperBounds(w.node,w.parent.hasTransform()),w.node=S,E}else(!this.support.rangeBounds||w.parent.hasTransform())&&(w.node=w.node.splitText(S.length));return{}}},kt.prototype.getWrapperBounds=function(w,S){var E=w.ownerDocument.createElement("html2canvaswrapper"),F=w.parentNode,Z=w.cloneNode(!0);E.appendChild(w.cloneNode(!0)),F.replaceChild(E,w);var it=S?Gt(E):at(E);return F.replaceChild(Z,E),it},kt.prototype.getRangeBounds=function(w,S,E){var F=this.range||(this.range=w.ownerDocument.createRange());return F.setStart(w,S),F.setEnd(w,S+E),F.getBoundingClientRect()},kt.prototype.parse=function(w){var S=w.contexts.filter(yn),F=w.children.filter(xt),it=F.filter(ot(St)),E=it.filter(ot(It)).filter(ot(gt)),F=F.filter(ot(It)).filter(St),Z=it.filter(ot(It)).filter(gt),it=w.contexts.concat(it.filter(It)).filter(yt),mt=w.children.filter(Lt).filter($);w=w.contexts.filter(T),S.concat(E).concat(F).concat(Z).concat(it).concat(mt).concat(w).forEach(function(Et){this.renderQueue.push(Et),Et instanceof Wn&&(this.parse(Et),this.renderQueue.push(new ni))},this)},kt.prototype.paint=function(w){try{w instanceof ni?this.renderer.ctx.restore():Lt(w)?(w.parent.isPseudoElement===!0&&w.parent.appendToDOM(),this.paintText(w),w.parent.isPseudoElement===!0&&w.parent.cleanDOM()):this.paintNode(w)}catch(S){if(R(S),this.options.strict)throw S}},kt.prototype.paintNode=function(w){w instanceof Wn&&(this.renderer.setOpacity(w.opacity),this.renderer.ctx.save(),w.hasTransform()&&this.renderer.setTransform(w.parseTransform())),w.node.nodeName==="INPUT"&&w.node.type==="checkbox"?this.paintCheckbox(w):w.node.nodeName==="INPUT"&&w.node.type==="radio"?this.paintRadio(w):this.paintElement(w)},kt.prototype.paintElement=function(w){var S=w.parseBounds();this.renderer.clip(w.backgroundClip,function(){this.renderer.renderBackground(w,S,w.borders.borders.map(we))},this),this.renderer.clip(w.clip,function(){this.renderer.renderBorders(w.borders.borders)},this),this.renderer.clip(w.backgroundClip,function(){switch(w.node.nodeName){case"svg":case"IFRAME":var E=this.images.get(w.node);E?this.renderer.renderImage(w,S,w.borders,E):R("Error loading <"+w.node.nodeName+">",w.node);break;case"IMG":(E=this.images.get(w.node.src))?this.renderer.renderImage(w,S,w.borders,E):R("Error loading <img>",w.node.src);break;case"CANVAS":this.renderer.renderImage(w,S,w.borders,{image:w.node});break;case"SELECT":case"INPUT":case"TEXTAREA":this.paintFormValue(w)}},this)},kt.prototype.paintCheckbox=function(w){var F=w.parseBounds(),S=Math.min(F.width,F.height),E={width:S-1,height:S-1,top:F.top,left:F.left},F=[3,3],Z=[F,F,F,F],it=[1,1,1,1].map(function(Et){return{color:new j("#A5A5A5"),width:Et}}),mt=Se(E,Z,it);this.renderer.clip(w.backgroundClip,function(){this.renderer.rectangle(E.left+1,E.top+1,E.width-2,E.height-2,new j("#DEDEDE")),this.renderer.renderBorders(ji(it,E,mt,Z)),w.node.checked&&(this.renderer.font(new j("#424242"),"normal","normal","bold",S-3+"px","arial"),this.renderer.text("✔",E.left+S/6,E.top+S-1))},this)},kt.prototype.paintRadio=function(w){var S=w.parseBounds(),E=Math.min(S.width,S.height)-2;this.renderer.clip(w.backgroundClip,function(){this.renderer.circleStroke(S.left+1,S.top+1,E,new j("#DEDEDE"),1,new j("#A5A5A5")),w.node.checked&&this.renderer.circle(Math.ceil(S.left+E/4)+1,Math.ceil(S.top+E/4)+1,Math.floor(E/2),new j("#424242"))},this)},kt.prototype.paintFormValue=function(w){var S=w.getValue();if(0<S.length){var E=w.node.ownerDocument,F=E.createElement("html2canvaswrapper");"lineHeight textAlign fontFamily fontWeight fontSize color paddingLeft paddingTop paddingRight paddingBottom width height borderLeftStyle borderTopStyle borderLeftWidth borderTopWidth boxSizing whiteSpace wordWrap".split(" ").forEach(function(it){try{F.style[it]=w.css(it)}catch(mt){R("html2canvas: Parse: Exception caught in renderFormValue: "+mt.message)}});var Z=w.parseBounds();F.style.position="fixed",F.style.left=Z.left+"px",F.style.top=Z.top+"px",F.textContent=S,E.body.appendChild(F),this.paintText(new yo(F.firstChild,w)),E.body.removeChild(F)}},kt.prototype.paintText=function(w){w.applyTextTransform();var E=s.html2canvas.punycode.ucs2.decode(w.node.data),S=this.options.letterRendering&&!/^(normal|none|0px)$/.test(w.parent.css("letterSpacing"))||/[^\u0000-\u00ff]/.test(w.node.data)?E.map(function(mt){return s.html2canvas.punycode.ucs2.encode([mt])}):Rn(E),E=w.parent.fontWeight(),F=w.parent.css("fontSize"),Z=w.parent.css("fontFamily"),it=w.parent.parseTextShadows();this.renderer.font(w.parent.color("color"),w.parent.css("fontStyle"),w.parent.css("fontVariant"),E,F,Z),it.length?this.renderer.fontShadow(it[0].color,it[0].offsetX,it[0].offsetY,it[0].blur):this.renderer.clearShadow(),this.renderer.clip(w.parent.clip,function(){S.map(this.parseTextBounds(w),this).forEach(function(mt,Et){mt&&(this.renderer.text(S[Et],mt.left,mt.bottom),this.renderTextDecoration(w.parent,mt,this.fontMetrics.getMetrics(Z,F)))},this)},this)},kt.prototype.renderTextDecoration=function(w,S,E){switch(w.css("textDecoration").split(" ")[0]){case"underline":this.renderer.rectangle(S.left,Math.round(S.top+E.baseline+E.lineWidth),S.width,1,w.color("color"));break;case"overline":this.renderer.rectangle(S.left,Math.round(S.top),S.width,1,w.color("color"));break;case"line-through":this.renderer.rectangle(S.left,Math.ceil(S.top+E.middle+E.lineWidth),S.width,1,w.color("color"))}};var Mh={inset:[["darken",.6],["darken",.1],["darken",.1],["darken",.6]]};kt.prototype.parseBorders=function(w){var S=w.parseBounds(),E=W(w),F=["Top","Right","Bottom","Left"].map(function(it,mt){var Et=w.css("border"+it+"Style"),Ht=w.color("border"+it+"Color");return Et==="inset"&&Ht.isBlack()&&(Ht=new j([255,255,255,Ht.a])),Et=Mh[Et]?Mh[Et][mt]:null,{width:w.cssInt("border"+it+"Width"),color:Et?Ht[Et[0]](Et[1]):Ht,args:null}}),Z=Se(S,E,F);return{clip:this.parseBackgroundClip(w,Z,F,E,S),borders:ji(F,S,Z,E)}},kt.prototype.parseBackgroundClip=function(w,S,E,F,Z){var it=[];switch(w.css("backgroundClip")){case"content-box":case"padding-box":Le(it,F[0],F[1],S.topLeftInner,S.topRightInner,Z.left+E[3].width,Z.top+E[0].width),Le(it,F[1],F[2],S.topRightInner,S.bottomRightInner,Z.left+Z.width-E[1].width,Z.top+E[0].width),Le(it,F[2],F[3],S.bottomRightInner,S.bottomLeftInner,Z.left+Z.width-E[1].width,Z.top+Z.height-E[2].width),Le(it,F[3],F[0],S.bottomLeftInner,S.topLeftInner,Z.left+E[3].width,Z.top+Z.height-E[2].width);break;default:Le(it,F[0],F[1],S.topLeftOuter,S.topRightOuter,Z.left,Z.top),Le(it,F[1],F[2],S.topRightOuter,S.bottomRightOuter,Z.left+Z.width,Z.top),Le(it,F[2],F[3],S.bottomRightOuter,S.bottomLeftOuter,Z.left+Z.width,Z.top+Z.height),Le(it,F[3],F[0],S.bottomLeftOuter,S.topLeftOuter,Z.left,Z.top+Z.height)}return it};var Fg=0,Hl="withCredentials"in new XMLHttpRequest,Eh="crossOrigin"in new Image;te.prototype.cloneTo=function(w){te.prototype.cloneTo.call(this,w),w.isPseudoElement=!0,w.before=this.before},te.prototype=Object.create(bt.prototype),te.prototype.appendToDOM=function(){this.before?this.parent.node.insertBefore(this.node,this.parent.node.firstChild):this.parent.node.appendChild(this.node),this.parent.node.className+=" "+this.getHideClass()},te.prototype.cleanDOM=function(){this.node.parentNode.removeChild(this.node),this.parent.node.className=this.parent.node.className.replace(this.getHideClass(),"")},te.prototype.getHideClass=function(){return this["PSEUDO_HIDE_ELEMENT_CLASS_"+(this.before?"BEFORE":"AFTER")]},te.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE="___html2canvas___pseudoelement_before",te.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER="___html2canvas___pseudoelement_after",jn.prototype.renderImage=function(w,S,E,F){var Z=w.cssInt("paddingLeft"),it=w.cssInt("paddingTop"),mt=w.cssInt("paddingRight");w=w.cssInt("paddingBottom"),E=E.borders,mt=S.width-(E[1].width+E[3].width+Z+mt),w=S.height-(E[0].width+E[2].width+it+w),this.drawImage(F,0,0,F.image.width||mt,F.image.height||w,S.left+Z+E[3].width,S.top+it+E[0].width,mt,w)},jn.prototype.renderBackground=function(w,S,E){0<S.height&&0<S.width&&(this.renderBackgroundColor(w,S),this.renderBackgroundImage(w,S,E))},jn.prototype.renderBackgroundColor=function(w,S){var E=w.color("backgroundColor");E.isTransparent()||this.rectangle(S.left,S.top,S.width,S.height,E)},jn.prototype.renderBorders=function(w){w.forEach(this.renderBorder,this)},jn.prototype.renderBorder=function(w){w.color.isTransparent()||w.args===null||this.drawShape(w.args,w.color)},jn.prototype.renderBackgroundImage=function(w,S,E){w.parseBackgroundImages().reverse().forEach(function(F,Z,it){switch(F.method){case"url":var mt=this.images.get(F.args[0]);mt?this.renderBackgroundRepeating(w,S,mt,it.length-(Z+1),E):R("Error loading background-image",F.args[0]);break;case"linear-gradient":case"gradient":(Z=this.images.get(F.value))?this.renderBackgroundGradient(Z,S,E):R("Error loading background-image",F.args[0]);break;case"none":break;default:R("Unknown background-image type",F.args[0])}},this)},jn.prototype.renderBackgroundRepeating=function(w,S,E,F,Z){var it=w.parseBackgroundSize(S,E.image,F),mt=w.parseBackgroundPosition(S,E.image,F,it);switch(w.parseBackgroundRepeat(F)){case"repeat-x":case"repeat no-repeat":this.backgroundRepeatShape(E,mt,it,S,S.left+Z[3],S.top+mt.top+Z[0],99999,it.height,Z);break;case"repeat-y":case"no-repeat repeat":this.backgroundRepeatShape(E,mt,it,S,S.left+mt.left+Z[3],S.top+Z[0],it.width,99999,Z);break;case"no-repeat":this.backgroundRepeatShape(E,mt,it,S,S.left+mt.left+Z[3],S.top+mt.top+Z[0],it.width,it.height,Z);break;default:this.renderBackgroundRepeat(E,mt,it,{top:S.top,left:S.left},Z[3],Z[0])}},Wn.prototype=Object.create(bt.prototype),Wn.prototype.getParentStack=function(w){var S=this.parent?this.parent.stack:null;return S?S.ownStacking?S:S.getParentStack(w):w.stack},vs.prototype.testRangeBounds=function(w){var S,E,F=!1;return w.createRange&&(S=w.createRange(),S.getBoundingClientRect&&(E=w.createElement("boundtest"),E.style.height="123px",E.style.display="block",w.body.appendChild(E),S.selectNode(E),S=S.getBoundingClientRect(),S=S.height,S===123&&(F=!0),w.body.removeChild(E))),F},vs.prototype.testCORS=function(){return typeof new Image().crossOrigin<"u"},vs.prototype.testSVG=function(){var w=new Image,S=t.createElement("canvas"),E=S.getContext("2d");w.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{E.drawImage(w,0,0),S.toDataURL()}catch{return!1}return!0},tn.prototype.hasFabric=function(){return html2canvas.fabric?Promise.resolve():Promise.reject(Error("html2canvas.svg.js is not loaded, cannot render svg"))},tn.prototype.inlineFormatting=function(w){return/^data:image\/svg\+xml;base64,/.test(w)?this.decode64(this.removeContentType(w)):this.removeContentType(w)},tn.prototype.removeContentType=function(w){return w.replace(/^data:image\/svg\+xml(;base64)?,/,"")},tn.prototype.isInline=function(w){return/^data:image\/svg\+xml/i.test(w)},tn.prototype.createCanvas=function(w){var S=this;return function(E,F){var Z=new html2canvas.fabric.StaticCanvas("c");S.image=Z.lowerCanvasEl,Z.setWidth(F.width).setHeight(F.height).add(html2canvas.fabric.util.groupSVGElements(E,F)).renderAll(),w(Z.lowerCanvasEl)}},tn.prototype.decode64=function(w){return typeof s.atob=="function"?s.atob(w):Oi(w)},es.prototype=Object.create(tn.prototype),yo.prototype=Object.create(bt.prototype),yo.prototype.applyTextTransform=function(){this.node.data=this.transform(this.parent.css("textTransform"))},yo.prototype.transform=function(w){var S=this.node.data;switch(w){case"lowercase":return S.toLowerCase();case"capitalize":return S.replace(/(^|\s|:|-|\(|\))([a-z])/g,Bt);case"uppercase":return S.toUpperCase();default:return S}},zl.prototype=Object.create(ft.prototype),pi.prototype=Object.create(jn.prototype),pi.prototype.setFillStyle=function(w){return this.ctx.fillStyle=typeof w=="object"&&w.isColor?w.toString():w,this.ctx},pi.prototype.rectangle=function(w,S,E,F,Z){this.setFillStyle(Z).fillRect(w,S,E,F)},pi.prototype.circle=function(w,S,E,F){this.setFillStyle(F),this.ctx.beginPath(),this.ctx.arc(w+E/2,S+E/2,E/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill()},pi.prototype.circleStroke=function(w,S,E,F,Z,it){this.circle(w,S,E,F),this.ctx.strokeStyle=it.toString(),this.ctx.stroke()},pi.prototype.drawShape=function(w,S){this.shape(w),this.setFillStyle(S).fill()},pi.prototype.taints=function(w){if(w.tainted===null){this.taintCtx.drawImage(w.image,0,0);try{this.taintCtx.getImageData(0,0,1,1),w.tainted=!1}catch{this.taintCtx=t.createElement("canvas").getContext("2d"),w.tainted=!0}}return w.tainted},pi.prototype.drawImage=function(w,S,E,F,Z,it,mt,Et,Ht){this.taints(w)&&!this.options.allowTaint||this.ctx.drawImage(w.image,S,E,F,Z,it,mt,Et,Ht)},pi.prototype.clip=function(w,S,E){this.ctx.save(),w.filter(kh).forEach(function(F){this.shape(F).clip()},this),S.call(E),this.ctx.restore()},pi.prototype.shape=function(w){return this.ctx.beginPath(),w.forEach(function(S,E){S[0]==="rect"?this.ctx.rect.apply(this.ctx,S.slice(1)):this.ctx[E===0?"moveTo":S[0]+"To"].apply(this.ctx,S.slice(1))},this),this.ctx.closePath(),this.ctx},pi.prototype.font=function(w,S,E,F,Z,it){this.setFillStyle(w).font=[S,E,F,Z,it].join(" ").split(",")[0]},pi.prototype.fontShadow=function(w,S,E,F){this.setVariable("shadowColor",w.toString()).setVariable("shadowOffsetY",S).setVariable("shadowOffsetX",E).setVariable("shadowBlur",F)},pi.prototype.clearShadow=function(){this.setVariable("shadowColor","rgba(0,0,0,0)")},pi.prototype.setOpacity=function(w){this.ctx.globalAlpha=w},pi.prototype.setTransform=function(w){this.ctx.translate(w.origin[0],w.origin[1]),this.ctx.transform.apply(this.ctx,w.matrix),this.ctx.translate(-w.origin[0],-w.origin[1])},pi.prototype.setVariable=function(w,S){return this.variables[w]!==S&&(this.variables[w]=this.ctx[w]=S),this},pi.prototype.text=function(w,S,E){this.ctx.fillText(w,S,E)},pi.prototype.backgroundRepeatShape=function(w,S,E,F,Z,it,mt,Et,Ht){this.clip([[["line",Math.round(Z),Math.round(it)],["line",Math.round(Z+mt),Math.round(it)],["line",Math.round(Z+mt),Math.round(Et+it)],["line",Math.round(Z),Math.round(Et+it)]]],function(){this.renderBackgroundRepeat(w,S,E,F,Ht[3],Ht[0])},this)},pi.prototype.renderBackgroundRepeat=function(w,S,E,F,Z,it){Z=Math.round(F.left+S.left+Z),S=Math.round(F.top+S.top+it),this.setFillStyle(this.ctx.createPattern(this.resizeImage(w,E),"repeat")),this.ctx.translate(Z,S),this.ctx.fill(),this.ctx.translate(-Z,-S)},pi.prototype.renderBackgroundGradient=function(w,S){if(w instanceof A){var E=this.ctx.createLinearGradient(S.left+S.width*w.x0,S.top+S.height*w.y0,S.left+S.width*w.x1,S.top+S.height*w.y1);w.colorStops.forEach(function(F){E.addColorStop(F.stop,F.color.toString())}),this.rectangle(S.left,S.top,S.width,S.height,E)}},pi.prototype.resizeImage=function(w,S){var E=w.image;if(E.width===S.width&&E.height===S.height)return E;var F=t.createElement("canvas");return F.width=S.width,F.height=S.height,F.getContext("2d").drawImage(E,0,0,E.width,E.height,0,0,S.width,S.height),F}}}).call({},typeof window<"u"?window:void 0,typeof document<"u"?document:void 0);function Ng(s){const t=document.createElement("canvas");return t.width=s.width,t.height=s.height,t.getContext("2d").drawImage(s,0,0),t}function rw(s){if(s instanceof HTMLCanvasElement){const t=s;if(t.clientWidth>0&&t.clientHeight>0)return s}for(let t=0;t<s.childNodes.length;t++){const e=s.childNodes.item(t),i=rw(e);if(i)return i}return null}function iC(s){const e=new DOMParser().parseFromString(s,"text/xml"),i=e.getElementsByTagName("defs"),n=[];for(let u=0;u<i.length;u++){const g=i.item(u).getElementsByTagName("marker");for(let y=0;y<g.length;y++){const m=g.item(y);n.push(m)}}const r=[],o=e.getElementsByTagName("line");for(let u=0;u<o.length;u++){const d=o.item(u);if(d.style.marker!==null&&d.style.marker.length>0){const g=d.style.marker.indexOf("#")+1,y=d.style.marker.indexOf('"',g+1),m=d.style.marker.substring(g,y);let I=null,b=null;for(let C=0;C<n.length;C++)if(n[C].id===m){I=n[C],b=n[C+1];break}const x={line:d,start:I,end:b};r.push(x)}}const l="marker: url";let h=s.indexOf(l);for(;h>=0;){const u=s.indexOf(")",h)+1,d=s.substring(h,u),g=d.indexOf("#")+1,y=d.indexOf('"',g),m=d.indexOf("&quot",g+l.length+1);let I=y;(y<0||m<y)&&(I=m);const b=d.substring(g,I);for(const x of r){const C=x.start,P=x.end;if(C!==null&&P!==null&&C.id===b){let k=`marker-start: url('#${C.id}');`;k+=`marker-end: url('#${P.id}')`,s=s.slice(0,h)+k+s.slice(u);break}}h=s.indexOf(l,u+1)}return s}function nC(s,t){const e=s.getContext("2d");if(e===null)throw new ae("failed to create 2D canvas context");for(const r of t)e.drawImage(r,0,0);const i=mi(),n=new Image;return n.src=s.toDataURL(),n.onload=()=>{i.resolve(n)},i}class sC{constructor(t,e){this._domElements=t,this._config=e}_initSVGCanvasSize(t){const e=t.parentElement;e&&(e.clientWidth&&(t.width=e.clientWidth),e.clientHeight&&(t.height=e.clientHeight))}async _extractMarkupSvgAsCanvas(){const t=this._domElements.getMarkupSvgElement();let e=new XMLSerializer().serializeToString(t);e=iC(e);const i=document.createElement("canvas");document.body.appendChild(i),this._initSVGCanvasSize(i);const n=i.getContext("2d");if(!n)return i;await(await Ma.from(n,e)).render();const o=Ng(i);return document.body.removeChild(i),o}async _extractRedlineSvgAsCanvas(t,e){const i=this._domElements.getRedlineSvgElement();i.setAttribute("width",`${t}`),i.setAttribute("height",`${e}`);let n=new XMLSerializer().serializeToString(i);n=n.replace("width: 100%;",`width: ${t};`),n=n.replace("height: 100%;",`height: ${e};`);const r=document.createElement("canvas");document.body.appendChild(r);const o=r.getContext("2d");if(!o)return r;await(await Ma.from(o,n)).render();const h=Ng(r);return document.body.removeChild(r),h}async _extractRedlineAsCanvas(){const t=this._domElements.getRedlineElement();return html2canvas(t,{background:void 0,letterRendering:!0})}async capture(t){const e=rw(t);if(e===null)throw new ae("failed to find canvas");const i=document.createElement("canvas");i.width=this._config.width||t.clientWidth,i.height=this._config.height||t.clientHeight,i.style.width="100%",i.style.height="100%";const n=[];return this._config.layers&gl.Model&&n.push(Ng(e)),this._config.layers&gl.Svg&&(n.push(await this._extractMarkupSvgAsCanvas()),n.push(await this._extractRedlineSvgAsCanvas(i.width,i.height))),this._config.layers&gl.Html&&n.push(await this._extractRedlineAsCanvas()),nC(i,n)}}class rC{constructor(t){this._timeoutDurationMinutes=15,this._timeoutWarningMinutes=14,this._timer=new Mo,this._enabled=!0,this._callbackManager=t,this.resetTimeout()}setTimeoutDurations(t,e){return this._timeoutDurationMinutes=t,this._timeoutWarningMinutes=e,this.resetTimeout(),!0}shutdown(){this._enabled=!1,this._timer.clear()}resetTimeout(){if(!this._enabled)return;const t=Math.round(this._timeoutWarningMinutes*60*1e3);this._timer.set(t,()=>{this._warn()})}_warn(){console.assert(this._timer.isIdle(Tn.BeforeAction));const t=this._timeoutDurationMinutes-this._timeoutWarningMinutes,e=Math.round(t*60*1e3);this._callbackManager.trigger("timeoutWarning",t),this._timer.set(e,()=>{this._timeout()})}_timeout(){this._callbackManager.trigger("timeout"),this._callbackManager.trigger("_timeout")}}const oC=`${Hp(Cf)} Build 4d06aad`;class Fl{constructor(t,e,i,n,r){this._container=t,this._canvasContainerElement=e,this._markupSvgElement=i,this._redlineSvgElement=n,this._redlineElement=r}getCanvasContainerElement(){return this._canvasContainerElement}getMarkupSvgElement(){return this._markupSvgElement}getRedlineSvgElement(){return this._redlineSvgElement}getRedlineElement(){return this._redlineElement}shutdown(){this._container.removeChild(this._markupSvgElement),this._container.removeChild(this._redlineSvgElement),this._container.removeChild(this._redlineElement),this._container.removeChild(this._canvasContainerElement)}static create(t){return t instanceof HTMLElement?this.createFromElement(t):this.createFromId(t)}static createFromElement(t){let e=t.id;e.length===0&&(e=hs());const i=`${e}-canvas-container`,n=`${e}-svg`,r=`${e}-redline-svg`,o=`${e}-redline`,l=document.createElement("div");l.id=i,l.style.width="100%",l.style.height="100%",l.style.position="absolute",l.tabIndex=-1,l.classList.add("webviewer-canvas"),l.oncontextmenu=()=>!1,t.appendChild(l);const h=Fl._createSvgElement(n);t.appendChild(h);const u=Fl._createSvgElement(r);t.appendChild(u);const d=document.createElement("div");return d.id=o,d.style.position="absolute",d.style.width="100%",d.style.height="100%",d.style.pointerEvents="none",t.appendChild(d),new Fl(t,l,h,u,d)}static createFromId(t){const e=document.getElementById(t);return e===null?null:this.createFromElement(e)}static _createSvgElement(t){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");return e.id=t,e.style.width="100%",e.style.height="100%",e.style.position="absolute",e.style.pointerEvents="none",e.style.overflow="hidden",e.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),e}}class aC{constructor(t){this._callbackManager=new gv,this._interpolationManager=new DI,this._streamingMode=lo.Interactive,this._rendererType=ll.Client,this._alreadyShutDown=!1,this._shutdownTimer=new Mo,this._sceneReadyPromise=gu(),this._modelReady=!1,this._modelLoadFailure=!1,this._seenPriorityMetaDataSent=!1,this._views=[],this.config={...t},this._contextMenuActiveFlag=!1;const e=t.container??t.containerId;if(e===void 0)throw new ys("must supply 'container' or 'containerId'");this._timeoutMonitor=new rC(this._callbackManager),this._setInitialOptions(this.config),this._engine=new EI(this._callbackManager,this.config),this.model=new al(this._engine,this._callbackManager),this.measureManager=new uy(this,this._callbackManager),this.lineManager=new cy(this,this._callbackManager);const i=Xa(this.config.disableAutomaticBackgroundSheets,!1);this.sheetManager=new fy(this,this._engine,this._callbackManager,i),this.noteTextManager=new sd(this),this.cuttingManager=new ry(this,this.model,this._callbackManager,this._engine),this.explodeManager=new oy(this.model,this._engine,this._callbackManager),this.markupManager=new hy(this.measureManager,this.lineManager,this._callbackManager,this.sheetManager,this.noteTextManager,this);const n=Fl.create(e);if(n===null)throw new ys("Failed to create DOM container");this._views=[new pg(this,this._engine,this._callbackManager,this._timeoutMonitor,this._interpolationManager,{id:ke.Default,domElements:n})],this.model._setDefaultView(this._views[0]);const r={disableAutomaticFitWorld:Xa(this.config.disableAutomaticFitWorld,!1),markImplicitNodesOutOfHierarchy:Xa(this.config._markImplicitNodesOutOfHierarchy,!0),streamingMode:Xa(this.config.streamingMode,lo.Default)};this._modelStructure=new xI(r,this._engine,this._callbackManager,this.cuttingManager,this.model),this._modelStructure.init(this.view,this.config._maxConcurrentAttachments||null),this.model._setModelStructure(this._modelStructure),this.BCFManager=new NI(this),this.selectionManager=new Qu(this,this._callbackManager,this._engine,this.model,this._modelStructure),this.animationManager=new Gm(this);const o=()=>{this.model.setPmiColor(vt.black())},l=y=>{this.model.isDrawing()&&(y=this.sheetManager.get3DNodes());const m=jt.PmiBody|jt.ViewFrame;this.model._setInstanceModifier($i.OverrideSceneVisibility,y,!0,m);for(const I of y)this.model.setPmiColorOverride(!0,I)},h=async y=>{y?await Promise.all([this.view.setPointSize(.003,Tu.ProportionOfBoundingDiagonal),this.view.setEyeDomeLightingEnabled(!0),this.view.setPointShape(Nu.Disk)]):await Promise.all([this.view.setPointSize(1,Tu.ScreenPixels),this.view.setEyeDomeLightingEnabled(!1),this.view.setPointShape(Nu.Square)])},u=async y=>{for(const m of y){const I=this.model.getModelFileTypeFromNode(m);if(I!==null&&I!==fl.Unknown){await h(!1);break}}},d=async y=>{const m=[];if(this.model.getModelFileTypeFromNode(y[0])===fl.Ifc)for(const I of y){const b=this.model.registerIfcNodes(I);m.push(b)}await Promise.all(m)},g=y=>{const m=this.selectionManager.getSelectionFilter(),I=this.model.getModelFileTypeFromNode(y[0])===fl.Ifc;if(!m&&I){this.selectionManager.setSelectionFilter(qf);return}m===qf&&!I&&this.selectionManager.setSelectionFilter(null)};this.setCallbacks({_resetAssemblyTreeBegin:async()=>{o()},_sessionStarted:()=>h(!0),_firstModelLoaded:async(y,m,I,b)=>{if(o(),g(y),l([this.model.getAbsoluteRootNode()]),await Promise.all([d(y),u(y)]),!b.attachInvisibly){const x=this.model.getDefaultCadView()!==null;this.model.getDefaultCadConfiguration()!==null&&await this._modelStructure.cadConfigurationsEnabled()&&await this.model.activateDefaultCadConfiguration(!x,this.view),x&&await this.model.activateDefaultCadView(void 0,void 0,this.view)}},_modelSwitched:async(y,m)=>{g(m),l(m),await Promise.all([d(m),u(m)])},_subtreeLoaded:async y=>{l(y),await d(y)},modelLoadFailure:()=>{this._modelLoadFailure=!0}})}static get defaultEnginePath(){return eo.defaultEnginePath}static set defaultEnginePath(t){eo.defaultEnginePath=t}static get defaultEngineBinary(){return eo.defaultBinary}static set defaultEngineBinary(t){eo.defaultBinary=t}get overlayManager(){return this.view.overlayManager}get floorplanManager(){return this.view.floorplanManager}async addView(t){const e=Fl.create(t.container);if(e===null)throw new ys("container is undefined");const i=e.getCanvasContainerElement(),n=await this._engine.addView(i),r=new pg(this,this._engine,this._callbackManager,this._timeoutMonitor,this._interpolationManager,{id:n,domElements:e});return r.inputMonitor.bindEvents(e.getCanvasContainerElement()),this._views.push(r),this._callbackManager.trigger("_drawContextCreated",n),r}removeView(t){if(t.id===ke.Default)throw new ae("WebViewer.removeView: Cannot remove default view");const e=this._views.findIndex(i=>i.id===t.id);if(e===void 0)throw new ae(`WebViewer.removeView: Cannot remove view with id '${t.id}' (not found)`);this.markupManager._viewDeleted(t),this._engine.removeView(t.id),this._views.splice(e,1),this._callbackManager.trigger("_drawContextDestroyed",t.id)}getView(t){return this._views.find(e=>e.id===t)}get view(){return this._views[ke.Default]}get views(){return this._views}get operatorManager(){return this.view.operatorManager}setContextMenuStatus(t){this._contextMenuActiveFlag=t}getContextMenuStatus(){return this._contextMenuActiveFlag}_setInitialOptions(t){t.streamingMode!==void 0?this._streamingMode=t.streamingMode:t.streamingMode=this._streamingMode,t.rendererType!==void 0?this._rendererType=t.rendererType:t.rendererType=this._rendererType}getViewerVersionString(){return oC}getFormatVersionString(){return this._engine.getVersionString()}start(){const t=this.view.domElements.getCanvasContainerElement();return this._engine.start(t,{enginePath:this.config.enginePath,engineReady:async e=>{await e,await this._modelStructure.waitForReady(),await this._scEngineReady()},sceneReady:()=>{this._sceneReady()},renderComplete:()=>{this._renderComplete()},streamingActivated:()=>{this._streamingActivated()},streamingDeactivated:()=>{this._streamingDeactivated()},priorityMetaDataSent:(e,i)=>{this._priorityMetaDataSent(e,i)}})}registerCustomOperator(t){return this.operatorManager.registerCustomOperator(t)}unregisterCustomOperator(t){this.operatorManager.unregisterCustomOperator(t)}focusInput(t){this.view.inputMonitor.focusInput(t)}setCallbacks(t){this._callbackManager.bind(t)}unsetCallbacks(t){this._callbackManager.unbind(t)}resizeCanvas(){this._alreadyShutDown||(this._engine.resize(),this.view.inputMonitor.elementResize())}moveToWindow(t){this.view.inputMonitor.setDocument(t.document)}redraw(t){if(t){const e=i=>{this._callbackManager.unbind({_drawComplete:e}),t()};this._callbackManager.bind({_drawComplete:e})}for(const e of this.views)this._engine.redraw(e.id)}selectPart(t,e=fn.Set){return this.selectionManager.selectNode(t,e)}trigger(t,...e){this._callbackManager.unsafeTrigger(t,e)}_getCallbackManager(){return this._callbackManager}_setStreamIdleMarker(){return this._engine.setStreamIdleMarker()}getStatistics(t=!1){return this._engine.getStatistics(t)}setMinimumFramerate(t){return this._setMinimumFramerate(t),Promise.resolve()}_setMinimumFramerate(t){for(const e of this.views)this._engine.setMinimumFramerate(e.id,t)}getMinimumFramerate(){return this._engine.getMinimumFramerate(ke.Default)}setServerRenderQuality(t,e,i,n){return this._engine.setServerRenderQuality(t,e,i,n)}getStreamingMode(){return this._streamingMode}getRendererType(){return this._engine.getRendererType()}getViewElement(){return this.view.domElements.getCanvasContainerElement()}shutdown(){if(!this._alreadyShutDown){if(this._shutdownTimer.clear(),!this._modelStructure.isReady()&&!this._modelLoadFailure){this._shutdownTimer.set(500,()=>{this.shutdown()});return}this._callbackManager.trigger("_shutdownBegin"),this.operatorManager._shutdown(),this.markupManager._shutdown(),this._timeoutMonitor.shutdown(),this._modelStructure.shutdown();for(const t of this._views)t.domElements.shutdown(),t.inputMonitor.shutdown();this._engine.shutdown(),this.animationManager._shutdown(),this._alreadyShutDown=!0}}setClientTimeout(t,e){return this._timeoutMonitor.setTimeoutDurations(t,e)}resetClientTimeout(){this._timeoutMonitor.resetTimeout()}pauseRendering(t){return this._pauseRendering(t),Promise.resolve()}_pauseRendering(t){this._engine.pauseAllRendering(t)}resumeRendering(){return this._resumeRendering(),Promise.resolve()}_resumeRendering(){this._engine.resumeAllRendering()}delayCapping(){this.cuttingManager.delayCapping()}async reset(t=Yn){await this.model.reset();const e=this.model.getDefaultCadView()!==null;this.model.getDefaultCadConfiguration()!==null&&await this._modelStructure.cadConfigurationsEnabled()?await this.model.activateDefaultCadConfiguration(!e,this.view):!this.sheetManager.isDrawingSheetActive()&&!e&&await this.view.resetCamera(t),e&&await this.model.activateDefaultCadView(t,!0,this.view)}closeConnection(){this.view.setCamera(this.view.getCamera()),this._engine.disconnectNetwork(),this._timeoutMonitor.shutdown()}setAllowHighDpi(t){this._engine.setAllowHighDpi(t)}getAllowHighDpi(){return this._engine.getAllowHighDpi()}takeSnapshot(t=new gy){const e=mi(),i=new sC(this.view.domElements,t),n=this.view.domElements.getCanvasContainerElement(),r=this.view.domElements.getRedlineElement(),o=t.width>0&&t.height>0;if(o){const h=`${100*(t.width/n.clientWidth)}%`,u=`${100*(t.height/n.clientHeight)}%`;n.style.width=h,n.style.height=u,r.style.width=h,r.style.height=u}const l=this.getAllowHighDpi();return this._engine.setAllowHighDpi(!1),this._engine.resize(),this.redraw(async()=>{const h=await i.capture(n);o&&(n.style.width="100%",n.style.height="100%",r.style.width="100%",r.style.height="100%"),this._engine.setAllowHighDpi(l),this._engine.resize(),e.resolve(h)}),e}fitWorld(t=Yn){return this.view.fitWorld(t)}async setViewOrientation(t,e=Yn){await this.view.setViewOrientation(t,e),this.view.injectViewOrientationChangeEvent()}_applyMetallicRoughnessDefaults(){let t=1,e=1,i=!1;this.config.defaultMetallicFactor!=null&&(t=this.config.defaultMetallicFactor,i=!0),this.config.defaultRoughnessFactor!=null&&(e=this.config.defaultRoughnessFactor,i=!0),i&&this._engine.setMetallicRoughnessMaterialOverride(t,e)}async _scEngineReady(){console.assert(this._modelStructure.isReady());const t=this.model.getAbsoluteRootNode(),e=this._engine.getSessionType();try{this.cuttingManager._init(),await this._sceneReadyPromise,await this._callbackManager.promiseTrigger("_assemblyTreeReady","assemblyTreeReady"),this._modelReady=!0;let i="";try{const n=new Ro;n._allowSubtreeLoadedCallback=!1;let r=0;if(this._applyMetallicRoughnessDefaults(),e===Xi.Network)i=this._engine.getNetworkModelName(),i===Oo||await this.model.loadSubtreeFromModel(t,i,n);else if(e===Xi.Scs){this._timeoutMonitor.shutdown();const o=this._engine.getScsInfo();typeof o=="string"?await this.model.loadSubtreeFromScsFile(t,o,n):o!==null&&await this.model.loadSubtreeFromScsBuffer(t,o,n),this.config.streamCutoffScale!==void 0&&(r=this.config.streamCutoffScale)}else throw new ei;this._modelStructure.setPrefetchScsCutoffScale(r)}catch(n){throw this._callbackManager.trigger("modelLoadFailure",i,`${n}`,n),n}}finally{console.assert(this._modelStructure.isReady())}return this._callbackManager.promiseTrigger("_modelStructureReady","modelStructureReady")}_sceneReady(){this.view.inputMonitor.bindEvents(this.view.domElements.getCanvasContainerElement()),this.selectionManager._init(),this._callbackManager.bind({_timeout:()=>{this.shutdown()}}),this._callbackManager.trigger("sceneReady"),this._sceneReadyPromise&&this._sceneReadyPromise.resolve()}getSceneReady(){return this._sceneReadyPromise.state===Nr.Resolved}getModelReady(){return this._modelReady}_priorityMetaDataSent(t,e){if(this._callbackManager.trigger("_priorityMetaDataSent",t,e),!this._seenPriorityMetaDataSent){if(t!==ta.OfInitialEmptyModel||e!==0)throw new ei;this._seenPriorityMetaDataSent=!0,this._callbackManager.trigger("_attached",ta.OfInitialEmptyModel)}}_renderComplete(){this.markupManager._update()}_streamingActivated(){this._callbackManager.trigger("streamingActivated")}_streamingDeactivated(){this._callbackManager.trigger("streamingDeactivated")}setStreamCutoffScale(t){return this._setStreamCutoffScale(t),Promise.resolve()}_setStreamCutoffScale(t){this._engine.setStreamCutoffScale(t),this._modelStructure.setPrefetchScsCutoffScale(t)}getStreamCutoffScale(){return this._engine.getStreamCutoffScale()}_loseWebGlContext(){return this._engine.loseWebGlContext()}_getScEngine(){return this._engine}_debug_log(t){return this._engine.debug_log(t)}_debug_stateFailure(t){return this._engine.debug_stateFailure(t)}_debug_sync(){return this._engine.debug_sync()}async exportToSvg(t=new dg){let e;this.cuttingManager._setStandinGeometryVisible(!1);try{await this.waitForIdle({redraw:!1}),e=await this._engine.exportToSvg(t)}finally{this.cuttingManager._setStandinGeometryVisible(!0)}return e}async beginExportToSvg(t=new dg){this.cuttingManager._setStandinGeometryVisible(!1);try{await this.waitForIdle({redraw:!1}),await this._engine.beginExportToSvg(t)}catch{await this.endExportToSvg()}}async endExportToSvg(){return this.cuttingManager._setStandinGeometryVisible(!0)}async advanceExportToSvg(){return this._engine.advanceExportToSvg()}async waitForIdle(t={}){if(this._alreadyShutDown)return;await this._setStreamIdleMarker();const e=[];if(this.cuttingManager.hasActiveCuttingSection()&&(await this.cuttingManager.enableCappingIdleCallback(!0)||e.push(this.cuttingManager.waitForCappingIdle())),e.push(this._engine.waitForImageDecoding()),await Promise.all(e),t.redraw!==!1){const i=mi();this.redraw(()=>{i.resolve()}),await i}}applyFilter(t){this._modelStructure.applyFilters([t])}}return rt.Animation=ub,rt.AntiAliasingMode=Au,rt.AssemblyDataParseError=Lo,rt.AttributeType=gr,rt.Axis=Xe,rt.AxisTriad=od,rt.BasicUnit=li,rt.Bcf=_b,rt.Bim=yb,rt.BimMask=ln,rt.BlurIntervalUnit=Ls,rt.BoundingPreviewMode=co,rt.Box=on,rt.BranchVisibility=he,rt.BuiltinOverlayIndex=ye,rt.Button=Me,rt.Buttons=ls,rt.Camera=dn,rt.Color=vt,rt.CommunicatorError=ae,rt.CullingVectorSpace=Rm,rt.CuttingManager=ry,rt.CuttingPlane=hg,rt.CuttingSection=sy,rt.DefaultTransitionDuration=Yn,rt.DepthRange=rd,rt.DirectionalLight=ay,rt.DrawMode=Js,rt.DrawStrategy=Ff,rt.ElementType=Yt,rt.EmptyModelName=Oo,rt.Event=xb,rt.EventType=le,rt.ExplodeManager=oy,rt.FaceFaceDistanceItem=Lm,rt.FaceMeshData=Xp,rt.FaceWinding=Rs,rt.FileType=fl,rt.FilterId=Em,rt.FilteredNodes=Rf,rt.Floorplan=vb,rt.FloorplanOrientation=ga,rt.HandleEventType=ao,rt.HandleType=dr,rt.ImageFormat=cs,rt.IncrementalPickConfig=Yc,rt.InfoType=Nm,rt.InstanceModifier=$i,rt.InternalLogicError=ei,rt.InvalidIndexError=Ru,rt.InvalidNodeId=ku,rt.InvalidNodeIdError=_s,rt.InvalidNodeTypeError=Zn,rt.KeyCode=Je,rt.KeyInputType=Eu,rt.KeyModifiers=_i,rt.LayerId=Am,rt.Light=ug,rt.LineManager=cy,rt.LinePatternLengthUnit=Fm,rt.LoadCancelledError=Wc,rt.LoadError=pr,rt.LoadSubtreeConfig=Ro,rt.Markup=Ab,rt.MarkupManager=hy,rt.MarkupTypeManager=ah,rt.Matrix=_t,rt.MeasureManager=uy,rt.MeshData=rs,rt.MeshInstanceCreationFlags=ie,rt.MeshInstanceData=Ns,rt.MissingModelError=Gc,rt.Model=al,rt.MouseInputType=Xs,rt.NavCube=ad,rt.NodeSource=Dr,rt.NodeType=Ne,rt.Ohm=fp,rt.OperatorId=_e,rt.OperatorManager=dy,rt.Operators=jb,rt.OrbitFallbackMode=cl,rt.Overlay=wb,rt.OverlayAnchor=je,rt.OverlayUnit=De,rt.ParseError=ys,rt.PickConfig=yi,rt.PickOutsideCanvasError=ho,rt.Plane=Ki,rt.PmiSubType=Df,rt.PmiTopoRef=ul,rt.PmiType=Nf,rt.Point2=K,rt.Point3=_,rt.Point4=rr,rt.PointLight=ly,rt.PointMeshData=Yp,rt.PointShape=Nu,rt.PointSizeUnit=Tu,rt.PolylineMeshData=Jp,rt.Projection=ti,rt.Quaternion=Bn,rt.Ray=Ws,rt.RefOnTopoItem=Om,rt.RelationshipType=Lf,rt.RendererType=ll,rt.Sc=nv,rt.ScreenConfiguration=Tm,rt.Selection=bb,rt.SelectionHighlightMode=fr,rt.SelectionInvalidatedError=Or,rt.SelectionMask=xe,rt.SelectionMode=fn,rt.SelectionType=Pn,rt.SheetManager=fy,rt.SimpleReflectionAttenuationUnit=Du,rt.SnapshotConfig=gy,rt.SnapshotLayer=gl,rt.StreamingMode=lo,rt.SubentityAttributes=tl,rt.Subscript1=dp,rt.Subscript2=qd,rt.Subscript3=Kd,rt.SubscriptNeg=Kh,rt.SvgConfig=dg,rt.TextureModifier=Hm,rt.TextureParameterization=zm,rt.TextureTiling=Ou,rt.TouchInputType=jc,rt.TransparencyMode=Dm,rt.TreeWalkMode=Vm,rt.Util=Mv,rt.VerticalGradient=fg,rt.View=pg,rt.ViewAxes=Of,rt.ViewKey=ke,rt.ViewOrientation=Ct,rt.VisibilityState=Bm,rt.WalkDirection=Te,rt.WalkMode=hl,rt.WebViewer=aC,rt.XRayGroup=dl,rt.XmlParseError=ii,rt.closestPointFromPointToSegment=_p,rt.closestPointScalarFromPointToSegment=tf,rt.computeAngleBetweenVector=js,rt.computeOffaxisRotation=ja,rt.computePointToLineDistance=kr,rt.createUuid=hs,rt.degreesToRadians=Zr,rt.distanceLineLine=mp,rt.formatWithUnit=Ua,rt.generateArcPoints=Jh,rt.generatePointsOnCircle=pp,rt.getLongUnitString=wp,rt.intersect3d2Planes=gp,rt.intersectionPlaneLine=Qr,rt.intersectionPlaneLine2=Zd,rt.isIColor=vp,rt.isIPoint2=Xd,rt.isIPoint3=Jd,rt.isIPoint4=Xw,rt.isPointInRect2d=ef,rt.isPointOnLineSegment=yp,rt.isPointOnLineSegment2d=Wa,rt.lineLineIntersect=Qd,rt.oneVectorCross=Yd,rt.radiansToDegrees=Xh,Object.defineProperty(rt,Symbol.toStringTag,{value:"Module"}),rt}({});
